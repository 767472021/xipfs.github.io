<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="深入理解 Kubernetes 之 Kubectl, TYPEOF">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>深入理解 Kubernetes 之 Kubectl | TYPEOF</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="TYPEOF" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">TYPEOF</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">TYPEOF</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/18.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">深入理解 Kubernetes 之 Kubectl</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Kubernetes/">
                                <span class="chip bg-color">Kubernetes</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Kubernetes/" class="post-category">
                                Kubernetes
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-05-21
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2020-06-02
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    11.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    63 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="深入理解-Kubectl"><a href="#深入理解-Kubectl" class="headerlink" title="深入理解 Kubectl"></a>深入理解 Kubectl</h1><p>kubectl 是 Kubernetes 集群的命令行工具，通过 kubectl 能够对集群本身进行管理，并能够在集群上进行容器化应用的安装部署。运行 kubectl 命令的语法如下所示：</p>
<pre class=" language-bash"><code class="language-bash">kubectl <span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span> <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span></code></pre>
<p><strong>comand</strong>：指定要对资源执行的操作，例如 create、get、describe 和 delete。</p>
<p><strong>TYPE</strong>：指定资源类型，资源类型是大小学敏感的，开发者能够以单数、复数和缩略的形式。</p>
<p><strong>NAME</strong>：指定资源的名称，名称也大小写敏感的。如果省略名称，则会显示所有的资源。</p>
<p><strong>flags</strong>：指定可选的参数。</p>
<p>例如：</p>
<pre class=" language-bash"><code class="language-bash">kubectl create -f nginx-deployment.yaml</code></pre>
<h2 id="Kubectl-流程"><a href="#Kubectl-流程" class="headerlink" title="Kubectl 流程"></a>Kubectl 流程</h2><p><img src="/images/2020/kubectl.png" alt=""></p>
<p>Kubectl 的执行流程：</p>
<ol>
<li><p>用户发起请求</p>
</li>
<li><p>根据用户执行动作分发给处理对应动作的 Cmd （Builder 设计模式）</p>
</li>
<li><p>解析用户命令 （Visitor 设计模式）</p>
</li>
<li><p>向Apiserver获取数据</p>
</li>
<li><p>解析返回为通用的数据集合</p>
</li>
</ol>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>执行以下代码：</p>
<pre class=" language-bash"><code class="language-bash">kubectl create -f nginx-deployment.yaml</code></pre>
<h3 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h3><p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/9e991415386e4cf155a24b1da15becaa390438d8/cmd/kubectl/kubectl.go#L35" target="_blank" rel="noopener"><code>kubernetes/cmd/kubectl/kubectl.go</code></a></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
    <span class="token comment" spellcheck="true">// 准备command</span>
    command <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">NewDefaultKubectlCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 执行命令</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> command<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="命令匹配"><a href="#命令匹配" class="headerlink" title="命令匹配"></a>命令匹配</h3><p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/9e991415386e4cf155a24b1da15becaa390438d8/pkg/kubectl/cmd/cmd.go#L482" target="_blank" rel="noopener">kubernetes/pkg/kubectl/cmd/cmd.go</a></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 对用户输入的命令进行匹配</span>
groups <span class="token operator">:=</span> templates<span class="token punctuation">.</span>CommandGroups<span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            Message<span class="token punctuation">:</span> <span class="token string">"Basic Commands (Beginner):"</span><span class="token punctuation">,</span>
            Commands<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
                create<span class="token punctuation">.</span><span class="token function">NewCmdCreate</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">,</span>
                expose<span class="token punctuation">.</span><span class="token function">NewCmdExposeService</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">,</span>
                run<span class="token punctuation">.</span><span class="token function">NewCmdRun</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">,</span>
                set<span class="token punctuation">.</span><span class="token function">NewCmdSet</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="处理用户命令"><a href="#处理用户命令" class="headerlink" title="处理用户命令"></a>处理用户命令</h3><p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/9e991415386e4cf155a24b1da15becaa390438d8/staging/src/k8s.io/kubectl/pkg/cmd/create/create.go#L116" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/kubectl/pkg/cmd/create/create.go</a></p>
<p>匹配上 <code>create</code> 命令调用 <code>o.RunCreate(f,cmd)</code> 函数执行</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewCmdCreate</span><span class="token punctuation">(</span>f cmdutil<span class="token punctuation">.</span>Factory<span class="token punctuation">,</span> ioStreams genericclioptions<span class="token punctuation">.</span>IOStreams<span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>
    o <span class="token operator">:=</span> <span class="token function">NewCreateOptions</span><span class="token punctuation">(</span>ioStreams<span class="token punctuation">)</span>
    cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
        Use<span class="token punctuation">:</span>                   <span class="token string">"create -f FILENAME"</span><span class="token punctuation">,</span>
        DisableFlagsInUseLine<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        Short<span class="token punctuation">:</span>                 i18n<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token string">"Create a resource from a file or from stdin."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Long<span class="token punctuation">:</span>                  createLong<span class="token punctuation">,</span>
        Example<span class="token punctuation">:</span>               createExample<span class="token punctuation">,</span>
        Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 合法性检查</span>
            cmdutil<span class="token punctuation">.</span><span class="token function">CheckErr</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>
            cmdutil<span class="token punctuation">.</span><span class="token function">CheckErr</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">ValidateArgs</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 执行命令</span>
            cmdutil<span class="token punctuation">.</span><span class="token function">CheckErr</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">RunCreate</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 创建子命令</span>
    cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateNamespace</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
    <span class="token keyword">return</span> cmd
<span class="token punctuation">}</span></code></pre>
<p>在 RunCreate 中时对该命令的具体处理，通过链式反应</p>
<p><code>f.NewBuilder().Unstructured().Schema(schema).ContinueOnError().NamespaceParam(cmdNamespace).DefaultNamespace().FilenameParam().LabelSelectorParam().Flatten().Do()</code></p>
<p>为执行命令做好数据准备。这段代码所做的事情是将命令行接收到的参数转化为一个资源的列。它也负责创建一个可以用来迭代访问所有资源的 Visitor 结构。这个命令比较复杂，因为它使用了Builder模式的变种，使用独立的函数做各自的数据初始化工作。</p>
<p>一旦所有的初始化都完成，resource.NewBuilder 函数会调用 Do 函数。<code>Do()</code> 函数是注册具体向 Apiserver 请求数据，和将返回数据转化为通用结构的函数。它会返回一个Result对象，并且将执行对资源的创建。Do 函数还会创建一个Visitor对象，可以用来遍历所有关联到 resource.NewBuilder 执行过程的资源。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>CreateOptions<span class="token punctuation">)</span> <span class="token function">RunCreate</span><span class="token punctuation">(</span>f cmdutil<span class="token punctuation">.</span>Factory<span class="token punctuation">,</span> cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
    r <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">NewBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  <span class="token comment" spellcheck="true">// Builder 设计模式</span>
        <span class="token function">Unstructured</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>   <span class="token comment" spellcheck="true">// 支持非结构化数据</span>
        <span class="token function">Schema</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">ContinueOnError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">NamespaceParam</span><span class="token punctuation">(</span>cmdNamespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DefaultNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">FilenameParam</span><span class="token punctuation">(</span>enforceNamespace<span class="token punctuation">,</span> <span class="token operator">&amp;</span>o<span class="token punctuation">.</span>FilenameOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">LabelSelectorParam</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment" spellcheck="true">// 设置用户的标签选择</span>
        <span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  <span class="token comment" spellcheck="true">// 决定以何种方式从 Kubernetes 的返回数据中提取数据</span>
        <span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 执行命令获取数据</span>

    <span class="token comment" spellcheck="true">// 创建 Visitor 对象，可以用来遍历所有关联到 Builder 执行过程的资源</span>
    err <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>resource<span class="token punctuation">.</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
        <span class="token keyword">return</span> o<span class="token punctuation">.</span><span class="token function">PrintObj</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 打印对象</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="发送请求并获取数据"><a href="#发送请求并获取数据" class="headerlink" title="发送请求并获取数据"></a>发送请求并获取数据</h3><p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/cli-runtime/pkg/resource/builder.go#L1098" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/builder.go </a></p>
<p>重要函数：</p>
<ul>
<li><code>RetrieveLazy</code> 中注册了从 Apiserver 获取数据的操作。</li>
<li><code>NewDecoratedVisitor</code> 中注册了从获取到的数据结构中转化出通用数据的方法。</li>
</ul>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{</span>
    r <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">visitorResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span>mapper <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">Mapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> r<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> r
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>flatten <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span>visitor <span class="token operator">=</span> <span class="token function">NewFlattenListVisitor</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>visitor<span class="token punctuation">,</span> b<span class="token punctuation">.</span>objectTyper<span class="token punctuation">,</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 注册获取数据前的动作</span>
    helpers <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>VisitorFunc<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>defaultNamespace <span class="token punctuation">{</span>
        helpers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>helpers<span class="token punctuation">,</span> <span class="token function">SetNamespace</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>requireNamespace <span class="token punctuation">{</span>
        helpers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>helpers<span class="token punctuation">,</span> <span class="token function">RequireNamespace</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    helpers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>helpers<span class="token punctuation">,</span> FilterNamespace<span class="token punctuation">)</span>
     <span class="token comment" spellcheck="true">// 注册从 Apiserver 获取数据的方法</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>requireObject <span class="token punctuation">{</span>
        helpers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>helpers<span class="token punctuation">,</span> RetrieveLazy<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 注册从返回数据中提取信息的方法</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>continueOnError <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span>visitor <span class="token operator">=</span> <span class="token function">NewDecoratedVisitor</span><span class="token punctuation">(</span>ContinueOnErrorVisitor<span class="token punctuation">{</span>r<span class="token punctuation">.</span>visitor<span class="token punctuation">}</span><span class="token punctuation">,</span> helpers<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span>visitor <span class="token operator">=</span> <span class="token function">NewDecoratedVisitor</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>visitor<span class="token punctuation">,</span> helpers<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> r
<span class="token punctuation">}</span></code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// RetrieveLazy updates the object if it has not been loaded yet.</span>
<span class="token keyword">func</span> <span class="token function">RetrieveLazy</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> info<span class="token punctuation">.</span>Object <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> info<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 从 API server 获取数据</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>而 NewDecoratedVisitor 函数注册了数据处理的关键函数 Visit， 这个函数可以使用户可以将来自 API server 的数据转化为通用数据集合。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Visit implements Visitor</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v DecoratedVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> v<span class="token punctuation">.</span>visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> v<span class="token punctuation">.</span>decorators <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span>decorators<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="打印返回数据"><a href="#打印返回数据" class="headerlink" title="打印返回数据"></a>打印返回数据</h3><pre class=" language-go"><code class="language-go">err <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>resource<span class="token punctuation">.</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> o<span class="token punctuation">.</span>DryRunStrategy <span class="token operator">!=</span> cmdutil<span class="token punctuation">.</span>DryRunClient <span class="token punctuation">{</span>
            obj<span class="token punctuation">,</span> err <span class="token operator">:=</span> resource<span class="token punctuation">.</span>
                <span class="token function">NewHelper</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Client<span class="token punctuation">,</span> info<span class="token punctuation">.</span>Mapping<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">DryRun</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>DryRunStrategy <span class="token operator">==</span> cmdutil<span class="token punctuation">.</span>DryRunServer<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Create</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
            info<span class="token punctuation">.</span><span class="token function">Refresh</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token operator">...</span>
        <span class="token comment" spellcheck="true">// 打印数据 </span>
        <span class="token keyword">return</span> o<span class="token punctuation">.</span><span class="token function">PrintObj</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>到此 Kubectl 的流程分析完毕。</p>
<h2 id="重要数据结构及函数"><a href="#重要数据结构及函数" class="headerlink" title="重要数据结构及函数"></a>重要数据结构及函数</h2><h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><p>在 Kubernetes 上，通常需要 Client 来访问 Kubernetes 中的对象，目前最常用的是RESTClient, DynamicClient和ClientSet 这三种Client。</p>
<h4 id="RESTClient"><a href="#RESTClient" class="headerlink" title="RESTClient"></a>RESTClient</h4><p>RESTClient 是 Kubernetes最基础的 Client，直接负责与 Request(RESTClient中的概念)打交道。下面的 Demo 就描述如何生成一个RESTClient，并用该RESTClient获取某具体 Pod 的详细信息。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"flag"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"k8s.io/client-go/pkg/runtime"</span>
    <span class="token string">"k8s.io/client-go/pkg/runtime/serializer"</span>
    <span class="token string">"k8s.io/client-go/pkg/api"</span>
    v1 <span class="token string">"k8s.io/client-go/pkg/api/v1"</span>
    <span class="token string">"k8s.io/client-go/pkg/api/unversioned"</span>
    <span class="token string">"k8s.io/client-go/rest"</span>
    <span class="token string">"k8s.io/client-go/tools/clientcmd"</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    kubeconfig <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"kubeconfig"</span><span class="token punctuation">,</span> <span class="token string">"/root/.kube/config"</span><span class="token punctuation">,</span> <span class="token string">"Path to a kube config. Only required if out-of-cluster."</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    config<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientcmd<span class="token punctuation">.</span><span class="token function">BuildConfigFromFlags</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token operator">*</span>kubeconfig<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"BuildConfigFromFlags error"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    groupversion <span class="token operator">:=</span> <span class="token operator">&amp;</span>unversioned<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"v1"</span><span class="token punctuation">}</span>
    config<span class="token punctuation">.</span>GroupVersion <span class="token operator">=</span> groupversion
    config<span class="token punctuation">.</span>APIPath <span class="token operator">=</span> <span class="token string">"/api"</span>
    config<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> runtime<span class="token punctuation">.</span>ContentTypeJSON
    config<span class="token punctuation">.</span>NegotiatedSerializer <span class="token operator">=</span> serializer<span class="token punctuation">.</span>DirectCodecFactory<span class="token punctuation">{</span>CodecFactory<span class="token punctuation">:</span> api<span class="token punctuation">.</span>Codecs<span class="token punctuation">}</span>
    restClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> rest<span class="token punctuation">.</span><span class="token function">RESTClientFor</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"RESTClientFor error"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    pod <span class="token operator">:=</span> v1<span class="token punctuation">.</span>Pod<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">=</span> restClient<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"pods"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Namespace</span><span class="token punctuation">(</span><span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token string">"nginx-1487191267-b4w5j"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Into</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pod<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="DynamicClient"><a href="#DynamicClient" class="headerlink" title="DynamicClient"></a>DynamicClient</h4><p>RESTClient需要自己设置请求各属性，用起来很不方便。DynamicClient是对RESTClient的封装，支持动态设置访问类型。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"flag"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"encoding/json"</span>
    <span class="token string">"k8s.io/client-go/pkg/api/v1"</span>
    <span class="token string">"k8s.io/client-go/pkg/api/unversioned"</span>
    <span class="token string">"k8s.io/client-go/dynamic"</span>
    <span class="token string">"k8s.io/client-go/tools/clientcmd"</span>
    <span class="token string">"k8s.io/client-go/rest"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    kubeconfig <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"kubeconfig"</span><span class="token punctuation">,</span> <span class="token string">"/root/.kube/config"</span><span class="token punctuation">,</span> <span class="token string">"Path to a kube config. Only required if out-of-cluster."</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>kubeconfig<span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    config<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientcmd<span class="token punctuation">.</span><span class="token function">BuildConfigFromFlags</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token operator">*</span>kubeconfig<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error1"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 生成dynamicClient</span>
    gv <span class="token operator">:=</span> <span class="token operator">&amp;</span>unversioned<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"v1"</span><span class="token punctuation">}</span>
    resource <span class="token operator">:=</span> <span class="token operator">&amp;</span>unversioned<span class="token punctuation">.</span>APIResource<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"pods"</span><span class="token punctuation">,</span> Namespaced<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
    config<span class="token punctuation">.</span>ContentConfig <span class="token operator">=</span> rest<span class="token punctuation">.</span>ContentConfig<span class="token punctuation">{</span>GroupVersion<span class="token punctuation">:</span> gv<span class="token punctuation">}</span>
    config<span class="token punctuation">.</span>APIPath <span class="token operator">=</span> <span class="token string">"/api"</span>

    dynamicClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> dynamic<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"dynamic NewCLient error"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 获取所有namespace的pod列表</span>
    obj<span class="token punctuation">,</span> err <span class="token operator">:=</span> dynamicClient<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"dynamicClient Resource error"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    js<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    podlist <span class="token operator">:=</span> v1<span class="token punctuation">.</span>PodList<span class="token punctuation">{</span><span class="token punctuation">}</span>
    json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>js<span class="token punctuation">,</span> <span class="token operator">&amp;</span>podlist<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>podlist<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"------------------------"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 获取具体具体pod</span>
    obj<span class="token punctuation">,</span> err <span class="token operator">=</span> dynamicClient<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"nginx-1487191267-b4w5j"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"dynamicClient Resource error"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        js<span class="token punctuation">,</span> err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        pod <span class="token operator">:=</span> v1<span class="token punctuation">.</span>Pod<span class="token punctuation">{</span><span class="token punctuation">}</span>
        json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>js<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pod<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="ClientSet"><a href="#ClientSet" class="headerlink" title="ClientSet"></a>ClientSet</h4><p>ClientSet也是对RESTClient的一种封装，与DynamicClient不同的是，ClientSet支持衍生出具体资源的Client，如PodClient等。ClientSet是Kubernetes用的最多的Client类型 。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"flag"</span>
    <span class="token string">"fmt"</span>
    apiv1 <span class="token string">"k8s.io/client-go/pkg/api/v1"</span>
    <span class="token string">"k8s.io/client-go/kubernetes"</span>
    <span class="token string">"k8s.io/client-go/tools/clientcmd"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    kubeconfig <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"kubeconfig"</span><span class="token punctuation">,</span> <span class="token string">"/root/.kube/config"</span><span class="token punctuation">,</span> <span class="token string">"Path to a kube config. Only required if out-of-cluster."</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>kubeconfig<span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    config<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientcmd<span class="token punctuation">.</span><span class="token function">BuildConfigFromFlags</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token operator">*</span>kubeconfig<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 生成clientset</span>
    clientset<span class="token punctuation">,</span> err <span class="token operator">:=</span> kubernetes<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 生成podCLient</span>
    podClient <span class="token operator">:=</span> clientset<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
    pods<span class="token punctuation">,</span> err <span class="token operator">:=</span> podClient<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>apiv1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pod <span class="token operator">:=</span> <span class="token keyword">range</span> pods<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="Builder"><a href="#Builder" class="headerlink" title="Builder"></a>Builder</h3><p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/cli-runtime/pkg/resource/builder.go#L49" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/builder.go</a></p>
<p>Builder 的作用是将命令行输入的参数转换为资源列表，然后通过 visitor 接口迭代资源。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> Builder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    categoryExpanderFn CategoryExpanderFunc
    mapper <span class="token operator">*</span>mapper
    clientConfigFn ClientConfigFunc
    restMapperFn RESTMapperFunc
    objectTyper runtime<span class="token punctuation">.</span>ObjectTyper
    negotiatedSerializer runtime<span class="token punctuation">.</span>NegotiatedSerializer
    local <span class="token builtin">bool</span>
    errs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span>
    paths  <span class="token punctuation">[</span><span class="token punctuation">]</span>Visitor
    stream <span class="token builtin">bool</span>
    dir    <span class="token builtin">bool</span>
    labelSelector     <span class="token operator">*</span><span class="token builtin">string</span>
    fieldSelector     <span class="token operator">*</span><span class="token builtin">string</span>
    selectAll         <span class="token builtin">bool</span>
    limitChunks       <span class="token builtin">int64</span>
    requestTransforms <span class="token punctuation">[</span><span class="token punctuation">]</span>RequestTransform
    resources <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    namespace    <span class="token builtin">string</span>
    allNamespace <span class="token builtin">bool</span>
    names        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    resourceTuples <span class="token punctuation">[</span><span class="token punctuation">]</span>resourceTuple
    defaultNamespace <span class="token builtin">bool</span>
    requireNamespace <span class="token builtin">bool</span>
    flatten <span class="token builtin">bool</span>
    latest  <span class="token builtin">bool</span>
    requireObject <span class="token builtin">bool</span>
    singleResourceType <span class="token builtin">bool</span>
    continueOnError    <span class="token builtin">bool</span>
    singleItemImplied <span class="token builtin">bool</span>
    export <span class="token builtin">bool</span>
    schema ContentValidator
<span class="token punctuation">}</span>

## Method

## path
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Path</span><span class="token punctuation">(</span>paths <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>

## selector
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">SelectorParam</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Selector</span><span class="token punctuation">(</span>selector labels<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">SelectAllParam</span><span class="token punctuation">(</span>selectAll <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder<span class="token punctuation">{</span><span class="token punctuation">}</span>

## namespace
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">NamespaceParam</span><span class="token punctuation">(</span>namespace <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">DefaultNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">AllNamespaces</span><span class="token punctuation">(</span>allNamespace <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>

## resource
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ResourceNames</span><span class="token punctuation">(</span>resource <span class="token builtin">string</span><span class="token punctuation">,</span> names <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ResourceTypes</span><span class="token punctuation">(</span>types <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ResourceTypeOrNameArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder<span class="token punctuation">{</span><span class="token punctuation">}</span>

## url
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">URL</span><span class="token punctuation">(</span>urls <span class="token operator">...</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>

## stream
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Stream</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>

## stdin
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Stdin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p>Builder是 Kubectl 命令行信息的内部载体，可以通过 Builder 生成Result对象。Builder大多方法支持链式调用：</p>
<pre class=" language-go"><code class="language-go">resource<span class="token punctuation">.</span><span class="token function">NewBuilder</span><span class="token punctuation">(</span>mapper<span class="token punctuation">,</span> typer<span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">ClientMapperFunc</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>UnstructuredClientForMapping<span class="token punctuation">)</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span>UnstructuredJSONScheme<span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">NamespaceParam</span><span class="token punctuation">(</span>cmdNamespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DefaultNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AllNamespaces</span><span class="token punctuation">(</span>allNamespaces<span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">FilenameParam</span><span class="token punctuation">(</span>enforceNamespace<span class="token punctuation">,</span> <span class="token operator">&amp;</span>options<span class="token punctuation">.</span>FilenameOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">SelectorParam</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">ExportParam</span><span class="token punctuation">(</span>export<span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">ResourceTypeOrNameArgs</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">ContinueOnError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Latest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h4 id="NewBuilder"><a href="#NewBuilder" class="headerlink" title="NewBuilder()"></a>NewBuilder()</h4><p>NewBuilder() 生成一个Builder，新的 Builder只设置了 mapper，及标记 requireObject 为true。</p>
<pre><code>func NewBuilder(mapper meta.RESTMapper, typer runtime.ObjectTyper, clientMapper ClientMapper, decoder runtime.Decoder) *Builder {
    return &amp;Builder{
        // 把RESTMapper, ObjectTyper, ClientMapper, Decoder封装成kubectl的Mapper
        mapper:        &amp;Mapper{typer, mapper, clientMapper, decoder},
        requireObject: true,
    }
}</code></pre><h4 id="Do"><a href="#Do" class="headerlink" title="Do()"></a>Do()</h4><p>Do() 先调用 visitorResult() 生成 Result 对象，然后设置 Result 对象中的 Visitor。</p>
<pre><code>// 返回一个 *Result，Result可以使Infos()或Object()来获取执行结果
// 关于 visitor 层层封装，可以理解为每个 visitor 实现一定的功能，然后按一定的顺序来执行这些功能
func (b *Builder) Do() *Result {
    r := b.visitorResult()
    if r.err != nil {
        return r
    }
    // 层层封装visitor
    if b.flatten {
        r.visitor = NewFlattenListVisitor(r.visitor, b.mapper)
    }
    helpers := []VisitorFunc{}
    if b.defaultNamespace {
        helpers = append(helpers, SetNamespace(b.namespace))
    }
    if b.requireNamespace {
        helpers = append(helpers, RequireNamespace(b.namespace))
    }
    helpers = append(helpers, FilterNamespace)
    if b.requireObject {
        helpers = append(helpers, RetrieveLazy)
    }
    r.visitor = NewDecoratedVisitor(r.visitor, helpers...)
    if b.continueOnError {
        r.visitor = ContinueOnErrorVisitor{r.visitor}
    }
    return r
}</code></pre><h4 id="visitResult"><a href="#visitResult" class="headerlink" title="visitResult()"></a>visitResult()</h4><p>visitResult() 会根据 Builder 中字段的设置情况来生成不同的 Result。一般来说 b.paths, b.selectors, b.resourceTuples, b.names 只需设置一个即可。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 返回一个result对象</span>
<span class="token comment" spellcheck="true">// visitByPaths()等会生成info对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">visitorResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span><span class="token comment" spellcheck="true">/***设置selector为labels.Everything()***/</span><span class="token operator">/</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>selectAll <span class="token punctuation">{</span>
        b<span class="token punctuation">.</span>selector <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token function">Everything</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// visit items specified by paths</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">visitByPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// visit selectors</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>selector <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">visitBySelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// visit items specified by resource and name</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">visitByResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// visit items specified by name</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>names<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">visitByName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"resource(s) were provided, but no name, label selector, or --all flag specified"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> missingResourceError<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="visitBySelector"><a href="#visitBySelector" class="headerlink" title="visitBySelector()"></a>visitBySelector()</h4><p>visitBySelector()生成一个Selector visitor，然后把该visitor封装成Result并返回。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// selector visitor 的 visitFunc 会生成 Info</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">visitBySelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>names<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"name cannot be provided when a selector is specified"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"selectors and the all flag cannot be used when passing resource/name arguments"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"at least one resource must be specified to use a selector"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    mappings<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">resourceMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    visitors <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Visitor<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> mapping <span class="token operator">:=</span> <span class="token keyword">range</span> mappings <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 生成 client</span>
        client<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">ClientForMapping</span><span class="token punctuation">(</span>mapping<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        selectorNamespace <span class="token operator">:=</span> b<span class="token punctuation">.</span>namespace
        <span class="token keyword">if</span> mapping<span class="token punctuation">.</span>Scope<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> meta<span class="token punctuation">.</span>RESTScopeNameNamespace <span class="token punctuation">{</span>
            selectorNamespace <span class="token operator">=</span> <span class="token string">""</span>
        <span class="token punctuation">}</span>
        visitors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>visitors<span class="token punctuation">,</span> <span class="token function">NewSelector</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> mapping<span class="token punctuation">,</span> selectorNamespace<span class="token punctuation">,</span> b<span class="token punctuation">.</span>selector<span class="token punctuation">,</span> b<span class="token punctuation">.</span>export<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>continueOnError <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>visitor<span class="token punctuation">:</span> <span class="token function">EagerVisitorList</span><span class="token punctuation">(</span>visitors<span class="token punctuation">)</span><span class="token punctuation">,</span> sources<span class="token punctuation">:</span> visitors<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>visitor<span class="token punctuation">:</span> <span class="token function">VisitorList</span><span class="token punctuation">(</span>visitors<span class="token punctuation">)</span><span class="token punctuation">,</span> sources<span class="token punctuation">:</span> visitors<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="visitByResource"><a href="#visitByResource" class="headerlink" title="visitByResource()"></a>visitByResource()</h4><p>visitByResource()使用 resourceTuples 生成 Info ，Info 本身也是个 visitor，所以把 Info 打包成Result 并返回。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">//通过 resource 生成 info</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">visitByResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{</span>
    isSingular <span class="token operator">:=</span> b<span class="token punctuation">.</span>singular
    <span class="token keyword">if</span> <span class="token operator">!</span>isSingular <span class="token punctuation">{</span>
        isSingular <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"you may not specify individual resources and bulk resources in the same call"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// retrieve one client for each resource</span>
    mappings<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">resourceTupleMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    clients <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>RESTClient<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> mapping <span class="token operator">:=</span> <span class="token keyword">range</span> mappings <span class="token punctuation">{</span>
        s <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> mapping<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">.</span><span class="token function">GroupVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> clients<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        client<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">ClientForMapping</span><span class="token punctuation">(</span>mapping<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        clients<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">=</span> client
    <span class="token punctuation">}</span>
    items <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Visitor<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tuple <span class="token operator">:=</span> <span class="token keyword">range</span> b<span class="token punctuation">.</span>resourceTuples <span class="token punctuation">{</span>
        mapping<span class="token punctuation">,</span> ok <span class="token operator">:=</span> mappings<span class="token punctuation">[</span>tuple<span class="token punctuation">.</span>Resource<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"resource %q is not recognized: %v"</span><span class="token punctuation">,</span> tuple<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> mappings<span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        s <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> mapping<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">.</span><span class="token function">GroupVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span>
        client<span class="token punctuation">,</span> ok <span class="token operator">:=</span> clients<span class="token punctuation">[</span>s<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"could not find a client for resource %q"</span><span class="token punctuation">,</span> tuple<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        selectorNamespace <span class="token operator">:=</span> b<span class="token punctuation">.</span>namespace
        <span class="token keyword">if</span> mapping<span class="token punctuation">.</span>Scope<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> meta<span class="token punctuation">.</span>RESTScopeNameNamespace <span class="token punctuation">{</span>
            selectorNamespace <span class="token operator">=</span> <span class="token string">""</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                errMsg <span class="token operator">:=</span> <span class="token string">"namespace may not be empty when retrieving a resource by name"</span>
                <span class="token keyword">if</span> b<span class="token punctuation">.</span>allNamespace <span class="token punctuation">{</span>
                    errMsg <span class="token operator">=</span> <span class="token string">"a resource cannot be retrieved by name across all namespaces"</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//生成 Info</span>
        info <span class="token operator">:=</span> <span class="token function">NewInfo</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> mapping<span class="token punctuation">,</span> selectorNamespace<span class="token punctuation">,</span> tuple<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> b<span class="token punctuation">.</span>export<span class="token punctuation">)</span>
        items <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> visitors Visitor
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>continueOnError <span class="token punctuation">{</span>
        visitors <span class="token operator">=</span> <span class="token function">EagerVisitorList</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        visitors <span class="token operator">=</span> <span class="token function">VisitorList</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> visitor<span class="token punctuation">:</span> visitors<span class="token punctuation">,</span> sources<span class="token punctuation">:</span> items<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="visitByName"><a href="#visitByName" class="headerlink" title="visitByName()"></a>visitByName()</h4><p>visitByName()先通过b.names来生成info，然后封装成Result返回。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">//通过 resource name 生成 Info</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">visitByName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{</span>
    isSingular <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>names<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"when paths, URLs, or stdin is provided as input, you may not specify a resource by arguments as well"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"you must provide a resource and a resource name together"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"you must specify only one resource"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    mappings<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">resourceMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    mapping <span class="token operator">:=</span> mappings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    client<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">ClientForMapping</span><span class="token punctuation">(</span>mapping<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    selectorNamespace <span class="token operator">:=</span> b<span class="token punctuation">.</span>namespace
    <span class="token keyword">if</span> mapping<span class="token punctuation">.</span>Scope<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> meta<span class="token punctuation">.</span>RESTScopeNameNamespace <span class="token punctuation">{</span>
        selectorNamespace <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            errMsg <span class="token operator">:=</span> <span class="token string">"namespace may not be empty when retrieving a resource by name"</span>
            <span class="token keyword">if</span> b<span class="token punctuation">.</span>allNamespace <span class="token punctuation">{</span>
                errMsg <span class="token operator">=</span> <span class="token string">"a resource cannot be retrieved by name across all namespaces"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    visitors <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Visitor<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> name <span class="token operator">:=</span> <span class="token keyword">range</span> b<span class="token punctuation">.</span>names <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 生成 Info</span>
        info <span class="token operator">:=</span> <span class="token function">NewInfo</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> mapping<span class="token punctuation">,</span> selectorNamespace<span class="token punctuation">,</span> name<span class="token punctuation">,</span> b<span class="token punctuation">.</span>export<span class="token punctuation">)</span>
        visitors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>visitors<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> visitor<span class="token punctuation">:</span> <span class="token function">VisitorList</span><span class="token punctuation">(</span>visitors<span class="token punctuation">)</span><span class="token punctuation">,</span> sources<span class="token punctuation">:</span> visitors<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="visitByPaths"><a href="#visitByPaths" class="headerlink" title="visitByPaths()"></a>visitByPaths()</h4><p>visitByPaths() 根据 b.Paths 生成 Results。因为 b.Paths 本身就是个 Visitor 数组。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">//Paths 中的 Visitor 会生成 Info</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">visitByPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{</span>
    singular <span class="token operator">:=</span> <span class="token operator">!</span>b<span class="token punctuation">.</span>dir <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>b<span class="token punctuation">.</span>stream <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> singular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"when paths, URLs, or stdin is provided as input, you may not specify resource arguments as well"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>names<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"name cannot be provided when a path is specified"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"resource/name arguments cannot be provided when a path is specified"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> visitors Visitor
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>continueOnError <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//此处 path 也是 Visitor</span>
        <span class="token comment" spellcheck="true">//FileVisitor, StreamVisitor 会生成 Info</span>
        visitors <span class="token operator">=</span> <span class="token function">EagerVisitorList</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        visitors <span class="token operator">=</span> <span class="token function">VisitorList</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// only items from disk can be refetched</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>latest <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// must flatten lists prior to fetching</span>
        <span class="token keyword">if</span> b<span class="token punctuation">.</span>flatten <span class="token punctuation">{</span>
            visitors <span class="token operator">=</span> <span class="token function">NewFlattenListVisitor</span><span class="token punctuation">(</span>visitors<span class="token punctuation">,</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// must set namespace prior to fetching</span>
        <span class="token keyword">if</span> b<span class="token punctuation">.</span>defaultNamespace <span class="token punctuation">{</span>
            visitors <span class="token operator">=</span> <span class="token function">NewDecoratedVisitor</span><span class="token punctuation">(</span>visitors<span class="token punctuation">,</span> <span class="token function">SetNamespace</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        visitors <span class="token operator">=</span> <span class="token function">NewDecoratedVisitor</span><span class="token punctuation">(</span>visitors<span class="token punctuation">,</span> RetrieveLatest<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>selector <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        visitors <span class="token operator">=</span> <span class="token function">NewFilteredVisitor</span><span class="token punctuation">(</span>visitors<span class="token punctuation">,</span> <span class="token function">FilterBySelector</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> singular<span class="token punctuation">,</span> visitor<span class="token punctuation">:</span> visitors<span class="token punctuation">,</span> sources<span class="token punctuation">:</span> b<span class="token punctuation">.</span>paths<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>接下来是Builder 的字段设置函数</strong></p>
<h4 id="Schema"><a href="#Schema" class="headerlink" title="Schema()"></a>Schema()</h4><p>Schema() 设置Builder的 schema 字段。schema 可以对资源名称进行规范检查。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Schema</span><span class="token punctuation">(</span>schema validation<span class="token punctuation">.</span>Schema<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>schema <span class="token operator">=</span> schema
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="FilenameParam"><a href="#FilenameParam" class="headerlink" title="FilenameParam()"></a>FilenameParam()</h4><p>FilenameParam()可以处理不同的输入方式，并设置 Paths 字段。如<code>kubectl create -f abc.yaml</code>，则filenameOptions为&amp;{[/home/abc.yaml] false}。<br>FilenameParam()目前支持标准输入，URL方式，文件方式，对应的支持函数为Stdin(), URL(), Path()。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">FilenameParam</span><span class="token punctuation">(</span>enforceNamespace <span class="token builtin">bool</span><span class="token punctuation">,</span> filenameOptions <span class="token operator">*</span>FilenameOptions<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    recursive <span class="token operator">:=</span> filenameOptions<span class="token punctuation">.</span>Recursive
    paths <span class="token operator">:=</span> filenameOptions<span class="token punctuation">.</span>Filenames
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> s <span class="token operator">:=</span> <span class="token keyword">range</span> paths <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 标准输入</span>
        <span class="token keyword">case</span> s <span class="token operator">==</span> <span class="token string">"-"</span><span class="token punctuation">:</span>
            b<span class="token punctuation">.</span><span class="token function">Stdin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// URL</span>
        <span class="token keyword">case</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"http://"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"https://"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            url<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"the URL passed to filename %q is not valid: %v"</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            b<span class="token punctuation">.</span><span class="token function">URL</span><span class="token punctuation">(</span>defaultHttpGetAttempts<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>recursive <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span>singular <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 文件或目录输入</span>
            b<span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span>recursive<span class="token punctuation">,</span> s<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 如果enforceNamespace为true，则调用RequireNamespace()</span>
    <span class="token keyword">if</span> enforceNamespace <span class="token punctuation">{</span>
        b<span class="token punctuation">.</span><span class="token function">RequireNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="Stdin"><a href="#Stdin" class="headerlink" title="Stdin()"></a>Stdin()</h4><p><code>Stdin()</code>会调用 <code>FileVIsitorForSTDIN()</code> 生成一个 Visitor，然后把该 Visitor 加入到 paths 中。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 在 Builder 的 paths 中加入 stdin Visitor</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Stdin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>stream <span class="token operator">=</span> <span class="token boolean">true</span>
    b<span class="token punctuation">.</span>paths <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">,</span> <span class="token function">FileVisitorForSTDIN</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>mapper<span class="token punctuation">,</span> b<span class="token punctuation">.</span>schema<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="URL"><a href="#URL" class="headerlink" title="URL()"></a>URL()</h4><p>URL() 先生成一个 url Visitor，然后把该 visitor 加入到 paths 中。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 在 Builder 的 paths 中加入 URL Visitor</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">URL</span><span class="token punctuation">(</span>httpAttemptCount <span class="token builtin">int</span><span class="token punctuation">,</span> urls <span class="token operator">...</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> u <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
        b<span class="token punctuation">.</span>paths <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">,</span> <span class="token operator">&amp;</span>URLVisitor<span class="token punctuation">{</span>
            URL<span class="token punctuation">:</span>              u<span class="token punctuation">,</span>
            StreamVisitor<span class="token punctuation">:</span>    <span class="token function">NewStreamVisitor</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">,</span> u<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>schema<span class="token punctuation">)</span><span class="token punctuation">,</span>
            HttpAttemptCount<span class="token punctuation">:</span> httpAttemptCount<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="Stream"><a href="#Stream" class="headerlink" title="Stream()"></a>Stream()</h4><p>Stream() 先生成一个 stream Visitor，然后把该 Visitor 加入到 paths 中。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 在 Builder 的 paths 中加入 stream Visitor </span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Stream</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>stream <span class="token operator">=</span> <span class="token boolean">true</span>
    b<span class="token punctuation">.</span>paths <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">,</span> <span class="token function">NewStreamVisitor</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">,</span> name<span class="token punctuation">,</span> b<span class="token punctuation">.</span>schema<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="Path"><a href="#Path" class="headerlink" title="Path()"></a>Path()</h4><p>Path()把路径转换成 file visitor,然后加入到 paths 中。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 把path转换成file Visitor，然后加入到paths中</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Path</span><span class="token punctuation">(</span>recursive <span class="token builtin">bool</span><span class="token punctuation">,</span> paths <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> paths <span class="token punctuation">{</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"the path %q does not exist"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"the path %q cannot be accessed: %v"</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 把paths转换成file Visitors</span>
        visitors<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">ExpandPathsToFileVisitors</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>mapper<span class="token punctuation">,</span> p<span class="token punctuation">,</span> recursive<span class="token punctuation">,</span> FileExtensions<span class="token punctuation">,</span> b<span class="token punctuation">.</span>schema<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"error reading %q: %v"</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>visitors<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>dir <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 加入到paths中</span>
        b<span class="token punctuation">.</span>paths <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">,</span> visitors<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="ResourceTypes"><a href="#ResourceTypes" class="headerlink" title="ResourceTypes()"></a>ResourceTypes()</h4><p>ResourceTypes()设置Builder的resources字段，如kubectl get pods abc，则resources为pods</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 设置resources/</span>
<span class="token comment" spellcheck="true">// builder resources中存储的是需要处理的类型</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ResourceTypes</span><span class="token punctuation">(</span>types <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>resources <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">,</span> types<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="ResourceNames"><a href="#ResourceNames" class="headerlink" title="ResourceNames()"></a>ResourceNames()</h4><p>ResourceNames()设置resourceTuples字段，表示需要访问的对象。如果kubectl logs nginx，那么ResourceNames()会把”nginx”和Builder中的resource(logs命令中设置为pods)，组成(pods, nginx)加入到resourceTuples中。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ResourceNames</span><span class="token punctuation">(</span>resource <span class="token builtin">string</span><span class="token punctuation">,</span> names <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> name <span class="token operator">:=</span> <span class="token keyword">range</span> names <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// See if this input string is of type/name format</span>
        tuple<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">splitResourceTypeName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">return</span> b
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>resourceTuples <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">,</span> tuple<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"the argument %q must be RESOURCE/NAME"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Use the given default type to create a resource tuple</span>
        b<span class="token punctuation">.</span>resourceTuples <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">,</span> resourceTuple<span class="token punctuation">{</span>Resource<span class="token punctuation">:</span> resource<span class="token punctuation">,</span> Name<span class="token punctuation">:</span> name<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="SelectorParam"><a href="#SelectorParam" class="headerlink" title="SelectorParam()"></a>SelectorParam()</h4><p>SelectorParam()的参数为string,设置Builder的selector字段。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 设置selector</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">SelectorParam</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    selector<span class="token punctuation">,</span> err <span class="token operator">:=</span> labels<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"the provided selector %q is not valid: %v"</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> b
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> selector<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> b
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> b<span class="token punctuation">.</span>selectAll <span class="token punctuation">{</span>
        b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"found non empty selector %q with previously set 'all' parameter. "</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> b
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">Selector</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="Selector"><a href="#Selector" class="headerlink" title="Selector()"></a>Selector()</h4><p>Selector()的参数为selector，直接设置Builder的selector字段。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Selector</span><span class="token punctuation">(</span>selector labels<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>selector <span class="token operator">=</span> selector
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="ExportParam"><a href="#ExportParam" class="headerlink" title="ExportParam()"></a>ExportParam()</h4><p>资源是否可导出</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ExportParam</span><span class="token punctuation">(</span>export <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>export <span class="token operator">=</span> export
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="NamespaceParam"><a href="#NamespaceParam" class="headerlink" title="NamespaceParam()"></a>NamespaceParam()</h4><p>NamespaceParam()可以设置Builder的namespace字段。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">NamespaceParam</span><span class="token punctuation">(</span>namespace <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>namespace <span class="token operator">=</span> namespace
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="DefaultNamespace"><a href="#DefaultNamespace" class="headerlink" title="DefaultNamespace()"></a>DefaultNamespace()</h4><p>DefaultNamespace()可以设置Builder的defaultNamespace字段，表示如果namespace未指定，是否使用default namespace。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 设置DefaultNamespace</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">DefaultNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>defaultNamespace <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="AllNamespaces"><a href="#AllNamespaces" class="headerlink" title="AllNamespaces()"></a>AllNamespaces()</h4><p>AllNamespaces()可以设置Builder的allNamespace和namespace字段，表示访问NamespaceAll。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 把namespace设置为NamespaceAll</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">AllNamespaces</span><span class="token punctuation">(</span>allNamespace <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    <span class="token keyword">if</span> allNamespace <span class="token punctuation">{</span>
        b<span class="token punctuation">.</span>namespace <span class="token operator">=</span> api<span class="token punctuation">.</span>NamespaceAll
    <span class="token punctuation">}</span>
    b<span class="token punctuation">.</span>allNamespace <span class="token operator">=</span> allNamespace
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="RequireNamespace"><a href="#RequireNamespace" class="headerlink" title="RequireNamespace()"></a>RequireNamespace()</h4><p>RequireNamespace()可以设置Builder的requireNamespace字段。</p>
<pre><code>func (b *Builder) RequireNamespace() *Builder {
    b.requireNamespace = true
    return b
}</code></pre><h4 id="SelectAllParam"><a href="#SelectAllParam" class="headerlink" title="SelectAllParam()"></a>SelectAllParam()</h4><p>SelectAllParam()可以设置Builder的selectAll字段。与selector字段互斥。</p>
<pre><code>func (b *Builder) SelectAllParam(selectAll bool) *Builder {
    if selectAll &amp;&amp; b.selector != nil {
        b.errs = append(b.errs, fmt.Errorf("setting 'all' parameter but found a non empty selector. "))
        return b
    }
    b.selectAll = selectAll
    return b
}</code></pre><h4 id="ResourceTypeOrNameArgs"><a href="#ResourceTypeOrNameArgs" class="headerlink" title="ResourceTypeOrNameArgs()"></a>ResourceTypeOrNameArgs()</h4><p>ResourceTypeOrNameArgs()可以设置Builder的names和resource字段。如执行<code>kubectl get pods/nginx-1487191267-b4w5j rc/abc</code>，则args为<code>[pods/nginx-1487191267-b4w5j rc/abc]</code>。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ResourceTypeOrNameArgs</span><span class="token punctuation">(</span>allowEmptySelector <span class="token builtin">bool</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    args <span class="token operator">=</span> <span class="token function">normalizeMultipleResourcesArgs</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">hasCombinedTypeArgs</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">return</span> b
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> s <span class="token operator">:=</span> <span class="token keyword">range</span> args <span class="token punctuation">{</span>
            tuple<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">splitResourceTypeName</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                <span class="token keyword">return</span> b
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span>resourceTuples <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">,</span> tuple<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> b
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Try replacing aliases only in types</span>
        args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">ReplaceAliases</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 此处调用ResourceTypes()</span>
    <span class="token keyword">switch</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">:</span>
        b<span class="token punctuation">.</span>names <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>names<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
        b<span class="token punctuation">.</span><span class="token function">ResourceTypes</span><span class="token punctuation">(</span><span class="token function">SplitResourceArgument</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        b<span class="token punctuation">.</span>names <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>names<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        b<span class="token punctuation">.</span><span class="token function">ResourceTypes</span><span class="token punctuation">(</span><span class="token function">SplitResourceArgument</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        b<span class="token punctuation">.</span><span class="token function">ResourceTypes</span><span class="token punctuation">(</span><span class="token function">SplitResourceArgument</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> b<span class="token punctuation">.</span>selector <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> allowEmptySelector <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>selector <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token function">Everything</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"arguments must consist of a resource or a resource and name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="Flatten"><a href="#Flatten" class="headerlink" title="Flatten()"></a>Flatten()</h4><p>Flatten()可以设置Builder的flatten字段。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>flatten <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="Latest"><a href="#Latest" class="headerlink" title="Latest()"></a>Latest()</h4><p>Latest()可以设置Builder的latest字段，用来标识获取URL或Path中最新的内容。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Latest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>latest <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="RequireObject"><a href="#RequireObject" class="headerlink" title="RequireObject()"></a>RequireObject()</h4><p>RequireObject()可以设置Builder的requireObject字段。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">RequireObject</span><span class="token punctuation">(</span>require <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>requireObject <span class="token operator">=</span> require
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="ContinueOnError"><a href="#ContinueOnError" class="headerlink" title="ContinueOnError()"></a>ContinueOnError()</h4><p>ContinueOnError()可以设置Builder的continueOnError字段为true，在封装visitor时会用到该字段。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ContinueOnError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>continueOnError <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre>
<h4 id="mappingFor"><a href="#mappingFor" class="headerlink" title="mappingFor()"></a>mappingFor()</h4><p>mappingFor()使用参数resource，然后依据mapper字段，构建RESTMapping并返回。RESTMapping表示resource和GVK的对应关系。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 返回 RESTMapping</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">mappingFor</span><span class="token punctuation">(</span>resourceArg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 把resource构造成GVR</span>
    fullySpecifiedGVR<span class="token punctuation">,</span> groupResource <span class="token operator">:=</span> unversioned<span class="token punctuation">.</span><span class="token function">ParseResourceArg</span><span class="token punctuation">(</span>resourceArg<span class="token punctuation">)</span>
    gvk <span class="token operator">:=</span> unversioned<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> fullySpecifiedGVR <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        gvk<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">KindFor</span><span class="token punctuation">(</span><span class="token operator">*</span>fullySpecifiedGVR<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> gvk<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> err <span class="token builtin">error</span>
        gvk<span class="token punctuation">,</span> err <span class="token operator">=</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">KindFor</span><span class="token punctuation">(</span>groupResource<span class="token punctuation">.</span><span class="token function">WithVersion</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// RESTMapping()定义在/pkg/api/meta/restmapper.go中</span>
    <span class="token keyword">return</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">RESTMapping</span><span class="token punctuation">(</span>gvk<span class="token punctuation">.</span><span class="token function">GroupKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gvk<span class="token punctuation">.</span>Version<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="resourceMappings"><a href="#resourceMappings" class="headerlink" title="resourceMappings()"></a>resourceMappings()</h4><p>resourceMappings()把Builder中的resource传递给上面的mappingFor()生成RESTMapping。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 把builder中resources转换成mapping</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">resourceMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>singleResourceType <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"you may only specify a single resource type"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    mappings <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> b<span class="token punctuation">.</span>resources <span class="token punctuation">{</span>
        mapping<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">mappingFor</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>

        mappings <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>mappings<span class="token punctuation">,</span> mapping<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mappings<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="resourceTupleMappings"><a href="#resourceTupleMappings" class="headerlink" title="resourceTupleMappings()"></a>resourceTupleMappings()</h4><p>resourceTupleMappings()把Builder中的resourceTuple转换成RESTMapping。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">resourceTupleMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mappings <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping<span class="token punctuation">)</span>
    canonical <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> b<span class="token punctuation">.</span>resourceTuples <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> mappings<span class="token punctuation">[</span>r<span class="token punctuation">.</span>Resource<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        mapping<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">mappingFor</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>

        mappings<span class="token punctuation">[</span>mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">]</span> <span class="token operator">=</span> mapping
        mappings<span class="token punctuation">[</span>r<span class="token punctuation">.</span>Resource<span class="token punctuation">]</span> <span class="token operator">=</span> mapping
        canonical<span class="token punctuation">[</span>mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>canonical<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>singleResourceType <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"you may only specify a single resource type"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mappings<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="Visitor"><a href="#Visitor" class="headerlink" title="Visitor"></a>Visitor</h3><p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/cli-runtime/pkg/resource/interfaces.go#L94" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/interfaces.go</a></p>
<p>Builder 最后调用 <code>DO()</code> 函数的作用就是构建 Visitors ,根据不同的资源构建不同的 Visitor，然后通过 <code>Visit</code> 函数访问不同的资源。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 通过访问者模式，访问资源列表</span>
<span class="token keyword">type</span> Visitor <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Visit</span><span class="token punctuation">(</span>VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 访问者回调函数</span>
<span class="token keyword">type</span> VisitorFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>Info<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span></code></pre>
<p>可以看出，只要实现了 <code>Visit(VisitorFunc) error</code> 方法的结构体都可以称为 Visitor。</p>
<p>其中 VisitorFunc 的参数为 *Info 及 error，所以可以推断，VisitorFunc() 可以对 Info 及 Error 进行处理。</p>
<p>Visitor 最大的特性就是每个 Visitor 实现了一个特性，然后可以嵌套使用。Visitor 可以分为两类，第一类是生成Info，第二类是处理 Info。我们现在先记着 Info 是用来存储REST请求的返回结果的。</p>
<p>产生 Info 的 Visitor 有：FileVisitor, StreamVisitor, URLVisitor, Selector。</p>
<p>处理 Info 的 Visitor 有：VisitorList, EagerVisitorList, DecoratedVisitor, ContinueOnErrorVisitor, FlattenListVisitor, FlattenListVisitor 等。此处需要说明下，有些 Visitor 只处理了 Error，但我们仍把它归为处理 Info 的 Visitor。</p>
<p>一般来说，如果 Info 已经生成，那么 Visitor 嵌套中的 Visitor 只要 Info 处理 Visitor 即可；如果没有 Info ，则最里面的 Visitor 要在<code>fn()</code>调用之前生成 Info ，以供其他 Visitor 处理。</p>
<p>我们接下来详细看下对应的Visitor 。</p>
<p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/cli-runtime/pkg/resource/visitor.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/visitor.go</a></p>
<h4 id="VisitorList"><a href="#VisitorList" class="headerlink" title="VisitorList"></a>VisitorList</h4><p>VisitorList 也属于 Visitor 类型。</p>
<pre><code>type VisitorList []Visitor

// 遍历 Visitor，执行 Visit 函数
func (l VisitorList) Visit(fn VisitorFunc) error {
    for i := range l {
        if err := l[i].Visit(fn); err != nil {
            return err
        }
    }
    return nil
}</code></pre><h4 id="EagerVisitorList"><a href="#EagerVisitorList" class="headerlink" title="EagerVisitorList"></a>EagerVisitorList</h4><p>EagerVisitorList 在迭代包含的 Visitor 时，遇到错误会断续迭代，最后一起返回所有错误。</p>
<p>所有匿名函数中的 err 都会被收集到 EagerVisitorList 的 Visit() 方法中的 errs 中。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> EagerVisitorList <span class="token punctuation">[</span><span class="token punctuation">]</span>Visitor

<span class="token keyword">func</span> <span class="token punctuation">(</span>l EagerVisitorList<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    errs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> l <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> l<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h4><p>其他 Visitor 最终会转换为 Info ，Info 负责向 API server 发起 http 请求，或者返回 http 请求响应的结果。</p>
<pre class=" language-GO"><code class="language-GO">type Info struct {
    Client RESTClient
    Mapping *meta.RESTMapping
    Namespace string
    Name      string
    Source string
    Object runtime.Object
    ResourceVersion string
    Export bool
}
func (i *Info) Visit(fn VisitorFunc) error {
    return fn(i, nil)
}

// Get()调用 Helper 依据Info中的信息获取 obj，并更新到 Info 的Object字段。
func (i *Info) Get() (err error) {
    obj, err := NewHelper(i.Client, i.Mapping).Get(i.Namespace, i.Name, i.Export)
    if err != nil {
        ...
            err2 := i.Client.Get().AbsPath("api", "v1", "namespaces", i.Namespace).Do(context.TODO()).Error()
        ...
        return err
    }
    // 更新i.Object和i.ResourceVersion
    i.Object = obj
    i.ResourceVersion, _ = metadataAccessor.ResourceVersion(obj)
    return nil
}

// 把一个 object 更新到 Info 中
func (i *Info) Refresh(obj runtime.Object, ignoreError bool) error {
    name, err := i.Mapping.MetadataAccessor.Name(obj)
    if err != nil {
        if !ignoreError {
            return err
        }
    } else {
        i.Name = name
    }
    namespace, err := i.Mapping.MetadataAccessor.Namespace(obj)
    if err != nil {
        if !ignoreError {
            return err
        }
    } else {
        i.Namespace = namespace
    }
    version, err := i.Mapping.MetadataAccessor.ResourceVersion(obj)
    if err != nil {
        if !ignoreError {
            return err
        }
    } else {
        i.ResourceVersion = version
    }
    i.Object = obj
    return nil
}</code></pre>
<h4 id="InfoListVisitor"><a href="#InfoListVisitor" class="headerlink" title="InfoListVisitor"></a>InfoListVisitor</h4><p>InfoListVisitor  也属于 Visitor 类型。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> InfoListVisitor <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Info

<span class="token keyword">func</span> <span class="token punctuation">(</span>infos InfoListVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> infos <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre>
<h4 id="URLVisitor"><a href="#URLVisitor" class="headerlink" title="URLVisitor"></a>URLVisitor</h4><p>URLVisitor 通过 URL 发起 http 请求下载资源，然后构建为 Info。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> URLVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    URL <span class="token operator">*</span>url<span class="token punctuation">.</span>URL
    <span class="token operator">*</span>StreamVisitor
    HttpAttemptCount <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>URLVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    body<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">readHttpWithRetries</span><span class="token punctuation">(</span>httpgetImpl<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> v<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>HttpAttemptCount<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    v<span class="token punctuation">.</span>StreamVisitor<span class="token punctuation">.</span>Reader <span class="token operator">=</span> body
    <span class="token keyword">return</span> v<span class="token punctuation">.</span>StreamVisitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="DecoratedVisitor"><a href="#DecoratedVisitor" class="headerlink" title="DecoratedVisitor"></a>DecoratedVisitor</h4><p>DecoratedVisitor 在调用 Visitor 的 Visit 函数之前先调用装饰器。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> DecoratedVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    visitor    Visitor
    decorators <span class="token punctuation">[</span><span class="token punctuation">]</span>VisitorFunc
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v DecoratedVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> v<span class="token punctuation">.</span>visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> v<span class="token punctuation">.</span>decorators <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 调用装饰器</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span>decorators<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="StreamVisitor"><a href="#StreamVisitor" class="headerlink" title="StreamVisitor"></a>StreamVisitor</h4><p>StreamVisitor 从 <code>io.Reader</code> 流中读取数据转换为 JSON 格式，然后通过 <code>runtime.Codec</code> 解码，进行schema检查，构建为 Info 对象。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> StreamVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    io<span class="token punctuation">.</span>Reader
    <span class="token operator">*</span>mapper

    Source <span class="token builtin">string</span>
    Schema ContentValidator
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>StreamVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    d <span class="token operator">:=</span> yaml<span class="token punctuation">.</span><span class="token function">NewYAMLOrJSONDecoder</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        ext <span class="token operator">:=</span> runtime<span class="token punctuation">.</span>RawExtension<span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 解码</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ext<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>
        <span class="token punctuation">}</span>
            <span class="token operator">...</span>
        <span class="token comment" spellcheck="true">// 构建为 Info</span>
        info<span class="token punctuation">,</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">infoForData</span><span class="token punctuation">(</span>ext<span class="token punctuation">.</span>Raw<span class="token punctuation">,</span> v<span class="token punctuation">.</span>Source<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> fnErr <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span> fnErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> fnErr
            <span class="token punctuation">}</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="FileVisitor"><a href="#FileVisitor" class="headerlink" title="FileVisitor"></a>FileVisitor</h4><p>FileVisitor 是对 StreamVisitor 的封装。 </p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> FileVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Path <span class="token builtin">string</span>
    <span class="token operator">*</span>StreamVisitor
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>FileVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> f <span class="token operator">*</span>os<span class="token punctuation">.</span>File
    <span class="token keyword">if</span> v<span class="token punctuation">.</span>Path <span class="token operator">==</span> constSTDINstr <span class="token punctuation">{</span>
        f <span class="token operator">=</span> os<span class="token punctuation">.</span>Stdin
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> err <span class="token builtin">error</span>
        f<span class="token punctuation">,</span> err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    utf16bom <span class="token operator">:=</span> unicode<span class="token punctuation">.</span><span class="token function">BOMOverride</span><span class="token punctuation">(</span>unicode<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    v<span class="token punctuation">.</span>StreamVisitor<span class="token punctuation">.</span>Reader <span class="token operator">=</span> transform<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> utf16bom<span class="token punctuation">)</span>
    <span class="token keyword">return</span> v<span class="token punctuation">.</span>StreamVisitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="FlattenListVisitor"><a href="#FlattenListVisitor" class="headerlink" title="FlattenListVisitor"></a>FlattenListVisitor</h4><p>FlattenListVisitor 可以对列表中的每个元素进行处理。如果有错误发生，则返回。</p>
<pre class=" language-go"><code class="language-go">
<span class="token keyword">type</span> FlattenListVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    visitor Visitor
    typer   runtime<span class="token punctuation">.</span>ObjectTyper
    mapper  <span class="token operator">*</span>mapper
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token punctuation">(</span>v FlattenListVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> v<span class="token punctuation">.</span>visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> info<span class="token punctuation">.</span>Object <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>meta<span class="token punctuation">.</span><span class="token function">IsListType</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        items <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token punctuation">}</span>
        itemsToProcess <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">{</span>info<span class="token punctuation">.</span>Object<span class="token punctuation">}</span>

        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>itemsToProcess<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            currObj <span class="token operator">:=</span> itemsToProcess<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>meta<span class="token punctuation">.</span><span class="token function">IsListType</span><span class="token punctuation">(</span>currObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                items <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> currObj<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 提取列表</span>
            currItems<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">ExtractList</span><span class="token punctuation">(</span>currObj<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> errs <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">DecodeList</span><span class="token punctuation">(</span>currItems<span class="token punctuation">,</span> v<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>decoder<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            itemsToProcess <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>itemsToProcess<span class="token punctuation">,</span> currItems<span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">var</span> preferredGVKs <span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionKind
        <span class="token keyword">if</span> info<span class="token punctuation">.</span>Mapping <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>info<span class="token punctuation">.</span>Mapping<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            preferredGVKs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>preferredGVKs<span class="token punctuation">,</span> info<span class="token punctuation">.</span>Mapping<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        errs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 对列表中每一个元素进行下一步处理</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> items <span class="token punctuation">{</span>
            item<span class="token punctuation">,</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">infoForObject</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>typer<span class="token punctuation">,</span> preferredGVKs<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>ResourceVersion<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                item<span class="token punctuation">.</span>ResourceVersion <span class="token operator">=</span> info<span class="token punctuation">.</span>ResourceVersion
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="FilteredVisitor"><a href="#FilteredVisitor" class="headerlink" title="FilteredVisitor"></a>FilteredVisitor</h4><p>FilteredVisitor 可以检查 Info 是否满足某些条件。如果满足条件，则往下执行，否则返回 err。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> FilteredVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    visitor Visitor
    filters <span class="token punctuation">[</span><span class="token punctuation">]</span>FilterFunc
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">NewFilteredVisitor</span><span class="token punctuation">(</span>v Visitor<span class="token punctuation">,</span> fn <span class="token operator">...</span>FilterFunc<span class="token punctuation">)</span> Visitor <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> v
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> FilteredVisitor<span class="token punctuation">{</span>v<span class="token punctuation">,</span> fn<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v FilteredVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> v<span class="token punctuation">.</span>visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> filter <span class="token operator">:=</span> <span class="token keyword">range</span> v<span class="token punctuation">.</span>filters <span class="token punctuation">{</span>
            ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">filter</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="ContinueOnErrorVisitor"><a href="#ContinueOnErrorVisitor" class="headerlink" title="ContinueOnErrorVisitor"></a>ContinueOnErrorVisitor</h4><p>ContinueOnErrorVisitor会收集子 Visitor 产生的错误，并返回。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> ContinueOnErrorVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Visitor
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v ContinueOnErrorVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    errs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">:=</span> v<span class="token punctuation">.</span>Visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 此处传入fn的错误是nil</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="Selector-1"><a href="#Selector-1" class="headerlink" title="Selector"></a>Selector</h4><p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/cli-runtime/pkg/resource/selector.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/selector.go</a></p>
<p>Selector 也属于 Visitor 类型，用于 label 选择。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Selector is a Visitor for resources that match a label selector.</span>
<span class="token keyword">type</span> Selector <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Client        RESTClient
    Mapping       <span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping
    Namespace     <span class="token builtin">string</span>
    LabelSelector <span class="token builtin">string</span>
    FieldSelector <span class="token builtin">string</span>
    Export        <span class="token builtin">bool</span>
    LimitChunks   <span class="token builtin">int64</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">// Visit implements Visitor and uses request chunking by default.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Selector<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> continueToken <span class="token builtin">string</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewHelper</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Client<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Mapping<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>
            r<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span>
            r<span class="token punctuation">.</span><span class="token function">ResourceMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">.</span><span class="token function">GroupVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            r<span class="token punctuation">.</span>Export<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>
                LabelSelector<span class="token punctuation">:</span> r<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">,</span>
                FieldSelector<span class="token punctuation">:</span> r<span class="token punctuation">.</span>FieldSelector<span class="token punctuation">,</span>
                Limit<span class="token punctuation">:</span>         r<span class="token punctuation">.</span>LimitChunks<span class="token punctuation">,</span>
                Continue<span class="token punctuation">:</span>      continueToken<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">IsResourceExpired</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">IsBadRequest</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">||</span> errors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> se<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>errors<span class="token punctuation">.</span>StatusError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// modify the message without hiding this is an API error</span>
                    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>FieldSelector<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                        se<span class="token punctuation">.</span>ErrStatus<span class="token punctuation">.</span>Message <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Unable to list %q: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> se<span class="token punctuation">.</span>ErrStatus<span class="token punctuation">.</span>Message<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        se<span class="token punctuation">.</span>ErrStatus<span class="token punctuation">.</span>Message <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Unable to find %q that match label selector %q, field selector %q: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> r<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">,</span> r<span class="token punctuation">.</span>FieldSelector<span class="token punctuation">,</span> se<span class="token punctuation">.</span>ErrStatus<span class="token punctuation">.</span>Message<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> se
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>FieldSelector<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Unable to list %q: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Unable to find %q that match label selector %q, field selector %q: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> r<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">,</span> r<span class="token punctuation">.</span>FieldSelector<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        resourceVersion<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> metadataAccessor<span class="token punctuation">.</span><span class="token function">ResourceVersion</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
        nextContinueToken<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> metadataAccessor<span class="token punctuation">.</span><span class="token function">Continue</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
        info <span class="token operator">:=</span> <span class="token operator">&amp;</span>Info<span class="token punctuation">{</span>
            Client<span class="token punctuation">:</span>  r<span class="token punctuation">.</span>Client<span class="token punctuation">,</span>
            Mapping<span class="token punctuation">:</span> r<span class="token punctuation">.</span>Mapping<span class="token punctuation">,</span>

            Namespace<span class="token punctuation">:</span>       r<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span>
            ResourceVersion<span class="token punctuation">:</span> resourceVersion<span class="token punctuation">,</span>

            Object<span class="token punctuation">:</span> list<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>nextContinueToken<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        continueToken <span class="token operator">=</span> nextContinueToken
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h3><p>Builder 的 <code>Do()</code> 可以返回 Result。现在让我们来看看Result的定义。</p>
<p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/cli-runtime/pkg/resource/result.go#L37" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/result.go </a></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Result contains helper methods for dealing with the outcome of a Builder.</span>
<span class="token keyword">type</span> Result <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    err     <span class="token builtin">error</span>
    visitor Visitor

    sources            <span class="token punctuation">[</span><span class="token punctuation">]</span>Visitor
    singleItemImplied  <span class="token builtin">bool</span>
    targetsSingleItems <span class="token builtin">bool</span>

    mapper       <span class="token operator">*</span>mapper
    ignoreErrors <span class="token punctuation">[</span><span class="token punctuation">]</span>utilerrors<span class="token punctuation">.</span>Matcher

    <span class="token comment" spellcheck="true">// populated by a call to Infos</span>
    info <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Info
<span class="token punctuation">}</span>
</code></pre>
<p>可以看到，Result 也包含一个 Visitor，及一个 info 表示[]*Info，所以 Result 提供了 Infos() 方法来获取Visitor的结果 Info 数组及 Object() 方法来获取Visitor的结果Obj(可能为List)。</p>
<h4 id="Infos"><a href="#Infos" class="headerlink" title="Infos()"></a>Infos()</h4><p>Info() 调用层层封装的 Visitor，然后收集所有 Info 并返回。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Infos returns an array of all of the resource infos retrieved via traversal.</span>
<span class="token comment" spellcheck="true">// Will attempt to traverse the entire set of visitors only once, and will return</span>
<span class="token comment" spellcheck="true">// a cached list on subsequent calls.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Result<span class="token punctuation">)</span> <span class="token function">Infos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Info<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> r<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> r<span class="token punctuation">.</span>info <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> r<span class="token punctuation">.</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    infos <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Info<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">:=</span> r<span class="token punctuation">.</span>visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        infos <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>infos<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    err <span class="token operator">=</span> utilerrors<span class="token punctuation">.</span><span class="token function">FilterOut</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ignoreErrors<span class="token operator">...</span><span class="token punctuation">)</span>

    r<span class="token punctuation">.</span>info<span class="token punctuation">,</span> r<span class="token punctuation">.</span>err <span class="token operator">=</span> infos<span class="token punctuation">,</span> err
    <span class="token keyword">return</span> infos<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre>
<h4 id="Object"><a href="#Object" class="headerlink" title="Object()"></a>Object()</h4><p>Object()先调用 Infos() 来获取 infos，然后从每个info中提取出Object组成ObjectList返回。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Result<span class="token punctuation">)</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    infos<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Infos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    versions <span class="token operator">:=</span> sets<span class="token punctuation">.</span>String<span class="token punctuation">{</span><span class="token punctuation">}</span>
    objects <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> info <span class="token operator">:=</span> <span class="token keyword">range</span> infos <span class="token punctuation">{</span>
        <span class="token keyword">if</span> info<span class="token punctuation">.</span>Object <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            objects <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>objects<span class="token punctuation">,</span> info<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
            versions<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>ResourceVersion<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>objects<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> r<span class="token punctuation">.</span>singular <span class="token punctuation">{</span>
            <span class="token keyword">return</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// if the item is a list already, don't create another list</span>
        <span class="token keyword">if</span> meta<span class="token punctuation">.</span><span class="token function">IsListType</span><span class="token punctuation">(</span>objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    version <span class="token operator">:=</span> <span class="token string">""</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>versions<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        version <span class="token operator">=</span> versions<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>List<span class="token punctuation">{</span>
        ListMeta<span class="token punctuation">:</span> unversioned<span class="token punctuation">.</span>ListMeta<span class="token punctuation">{</span>
            ResourceVersion<span class="token punctuation">:</span> version<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        Items<span class="token punctuation">:</span> objects<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span></code></pre>
<h3 id="Helper"><a href="#Helper" class="headerlink" title="Helper"></a>Helper</h3><p>在 Kubernetes中，Helper 一般都提供类似驱动的功能。Kubectl 的 helper 就是用来访问Client的驱动。一般来说，某个visitFunc 函数中会调用Helper的相关成员函数来完成具体请求。</p>
<p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/cli-runtime/pkg/resource/helper.go#L35" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/helper.go </a></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Helper provides methods for retrieving or mutating a RESTful</span>
<span class="token comment" spellcheck="true">// resource.</span>
<span class="token keyword">type</span> Helper <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// The name of this resource as the server would recognize it</span>
    Resource <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// A RESTClient capable of mutating this resource.</span>
    RESTClient RESTClient
    <span class="token comment" spellcheck="true">// An interface for reading or writing the resource version of this</span>
    <span class="token comment" spellcheck="true">// type.</span>
    Versioner runtime<span class="token punctuation">.</span>ResourceVersioner
    <span class="token comment" spellcheck="true">// True if the resource type is scoped to namespaces</span>
    NamespaceScoped <span class="token builtin">bool</span>
<span class="token punctuation">}</span></code></pre>
<p>Helper 实现了Get(), List(), Watch(), WatchSingle(), Delete(), Create(), Patch(), Replace()等方法，这些方法是对RESTClient的封装。</p>
<h3 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h3><p>这里的Mapper是指kubectl中的Mapper，是对ObjectTyper, RESTMapper, ClientMapper和Decoder的封装。</p>
<p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/cli-runtime/pkg/resource/mapper.go#L29" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/mapper.go </a></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> Mapper <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    runtime<span class="token punctuation">.</span>ObjectTyper
    meta<span class="token punctuation">.</span>RESTMapper
    <span class="token comment" spellcheck="true">// 定义在/pkg/kubectl/resource/interfaces.go中</span>
    <span class="token comment" spellcheck="true">// ClientMapper可以根据config和mapping通过调用ClientForMapping()生成RESTClient</span>
    ClientMapper
    runtime<span class="token punctuation">.</span>Decoder
<span class="token punctuation">}</span></code></pre>
<h4 id="Build-Mapper"><a href="#Build-Mapper" class="headerlink" title="Build Mapper"></a>Build Mapper</h4><p>从<code>/pkg/kubectl/cmd/util/factory.go的NewBuilder()</code>函数说起</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>factory<span class="token punctuation">)</span> <span class="token function">NewBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>resource<span class="token punctuation">.</span>Builder <span class="token punctuation">{</span>
    mapper<span class="token punctuation">,</span> typer <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 此处有kubectl mapper的各项参数的定义</span>
    <span class="token operator">/</span>  其中Decoder为f<span class="token punctuation">.</span><span class="token function">Decoder</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> resource<span class="token punctuation">.</span><span class="token function">NewBuilder</span><span class="token punctuation">(</span>mapper<span class="token punctuation">,</span> typer<span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">ClientMapperFunc</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>ClientForMapping<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">Decoder</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>再来看<code>/pkg/kubectl/ressourcce/builder.go</code>中的<code>NewBuilder()</code>:</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// NewBuilder creates a builder that operates on generic objects.</span>
<span class="token keyword">func</span> <span class="token function">NewBuilder</span><span class="token punctuation">(</span>mapper meta<span class="token punctuation">.</span>RESTMapper<span class="token punctuation">,</span> typer runtime<span class="token punctuation">.</span>ObjectTyper<span class="token punctuation">,</span> clientMapper ClientMapper<span class="token punctuation">,</span> decoder runtime<span class="token punctuation">.</span>Decoder<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Builder<span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 把RESTMapper, ObjectTyper, ClientMapper, Decoder封装成kubectl的 Mapper</span>
        mapper<span class="token punctuation">:</span>        <span class="token operator">&amp;</span>Mapper<span class="token punctuation">{</span>typer<span class="token punctuation">,</span> mapper<span class="token punctuation">,</span> clientMapper<span class="token punctuation">,</span> decoder<span class="token punctuation">}</span><span class="token punctuation">,</span>
        requireObject<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>可以看出，Mapper的创建在 builder.go 中，但真正准备创建Mapper的其他结构体的地方还是在 factory.go 中。</p>
<ul>
<li>runtime.ObjectTyper: 由f.Object()生成；</li>
<li>meta.RESTMapper: 由f.Object()生成；</li>
<li>ClientMapper: resource.ClientMapperFunc(f.ClientForMapping)</li>
<li>runtime.Decoder: f.Decoder(true)</li>
</ul>
<h4 id="f-Object"><a href="#f-Object" class="headerlink" title="f.Object()"></a>f.Object()</h4><p>Object() 返回一个RESTMapper及 api.Scheme。这里api.Scheme将传递给Typer。关于RESTMapper，现在只需知道存储了GVK和GVR的关系，可以通过RESTMapping()返回一个mapping表示GVK和Resource的关系。可以用mapping生成一个config，再生成Client。</p>
<pre><code>func (f *factory) Object() (meta.RESTMapper, runtime.ObjectTyper) {
    // registered.RESTMapper()定义在/pkg/apimachinery/registerd/registered.go中
    mapper := registered.RESTMapper()
    // 生成discoveryClient
    discoveryClient, err := f.DiscoveryClient()
    if err == nil {
        // discoveryClient生成成功的情况下，mapper为一个FistHitRESTMapper
        mapper = meta.FirstHitRESTMapper{
            MultiRESTMapper: meta.MultiRESTMapper{
                discovery.NewDeferredDiscoveryRESTMapper(discoveryClient, registered.InterfacesFor),
                registered.RESTMapper(), // hardcoded fall back
            },
        }
    }

    // wrap with shortcuts
    mapper = NewShortcutExpander(mapper, discoveryClient)

    // wrap with output preferences
    cfg, err := f.clients.ClientConfigForVersion(nil)
    checkErrWithPrefix("failed to get client config: ", err)
    cmdApiVersion := unversioned.GroupVersion{}
    if cfg.GroupVersion != nil {
        cmdApiVersion = *cfg.GroupVersion
    }
    mapper = kubectl.OutputVersionMapper{RESTMapper: mapper, OutputVersions: []unversioned.GroupVersion{cmdApiVersion}}
    return mapper, api.Scheme
}</code></pre><h4 id="f-ClientForMapping"><a href="#f-ClientForMapping" class="headerlink" title="f.ClientForMapping()"></a>f.ClientForMapping()</h4><p>CLientForMapping()可以依据mapping中的信息生成一个config，然后再生成RESTClient。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 依据mapping生成RESTClient</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>factory<span class="token punctuation">)</span> <span class="token function">ClientForMapping</span><span class="token punctuation">(</span>mapping <span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping<span class="token punctuation">)</span> <span class="token punctuation">(</span>resource<span class="token punctuation">.</span>RESTClient<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cfg<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span>clientConfig<span class="token punctuation">.</span><span class="token function">ClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">SetKubernetesDefaults</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    gvk <span class="token operator">:=</span> mapping<span class="token punctuation">.</span>GroupVersionKind
    <span class="token keyword">switch</span> gvk<span class="token punctuation">.</span>Group <span class="token punctuation">{</span>
    <span class="token keyword">case</span> federation<span class="token punctuation">.</span>GroupName<span class="token punctuation">:</span>
        mappingVersion <span class="token operator">:=</span> mapping<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">.</span><span class="token function">GroupVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> f<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">FederationClientForVersion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mappingVersion<span class="token punctuation">)</span>
    <span class="token keyword">case</span> api<span class="token punctuation">.</span>GroupName<span class="token punctuation">:</span>
        cfg<span class="token punctuation">.</span>APIPath <span class="token operator">=</span> <span class="token string">"/api"</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        cfg<span class="token punctuation">.</span>APIPath <span class="token operator">=</span> <span class="token string">"/apis"</span>
    <span class="token punctuation">}</span>
    gv <span class="token operator">:=</span> gvk<span class="token punctuation">.</span><span class="token function">GroupVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    cfg<span class="token punctuation">.</span>GroupVersion <span class="token operator">=</span> <span class="token operator">&amp;</span>gv
    <span class="token keyword">if</span> registered<span class="token punctuation">.</span><span class="token function">IsThirdPartyAPIGroupVersion</span><span class="token punctuation">(</span>gvk<span class="token punctuation">.</span><span class="token function">GroupVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cfg<span class="token punctuation">.</span>NegotiatedSerializer <span class="token operator">=</span> thirdpartyresourcedata<span class="token punctuation">.</span><span class="token function">NewNegotiatedSerializer</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span>Codecs<span class="token punctuation">,</span> gvk<span class="token punctuation">.</span>Kind<span class="token punctuation">,</span> gv<span class="token punctuation">,</span> gv<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 定义在/pkg/client/restclient/config.go</span>
    <span class="token keyword">return</span> restclient<span class="token punctuation">.</span><span class="token function">RESTClientFor</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>而 resource.ClientMapperFunc 定义在<code>/pkg/kubectl/resource/interfaces.go</code>中：</p>
<pre><code>type ClientMapperFunc func(mapping *meta.RESTMapping) (RESTClient, error)

// ClientForMapping implements ClientMapper
func (f ClientMapperFunc) ClientForMapping(mapping *meta.RESTMapping) (RESTClient, error) {
    return f(mapping)
}</code></pre><p>所以，调用ClientMapper的ClientForMapping()方法就相关于调用factory的ClientForMapping()方法。</p>
<h4 id="f-Decoder"><a href="#f-Decoder" class="headerlink" title="f.Decoder()"></a>f.Decoder()</h4><p>Decoder()定义在<code>/pkg/kubectl/cmd/util/factory.go</code>中：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>factory<span class="token punctuation">)</span> <span class="token function">Decoder</span><span class="token punctuation">(</span>toInternal <span class="token builtin">bool</span><span class="token punctuation">)</span> runtime<span class="token punctuation">.</span>Decoder <span class="token punctuation">{</span>
    <span class="token keyword">var</span> decoder runtime<span class="token punctuation">.</span>Decoder
    <span class="token keyword">if</span> toInternal <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// api.Codecs定义在pkg/api/register.go中/</span>
        decoder <span class="token operator">=</span> api<span class="token punctuation">.</span>Codecs<span class="token punctuation">.</span><span class="token function">UniversalDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        decoder <span class="token operator">=</span> api<span class="token punctuation">.</span>Codecs<span class="token punctuation">.</span><span class="token function">UniversalDeserializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> thirdpartyresourcedata<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>decoder<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>因为传入的toInternal为true，所以Decoder为api.Codecs.UniversalDecoder()。这里不再向下分析，只需知道该Decoder可以把相关版本的对象转换成内部版本的对象。</p>
<h4 id="RESTMapping"><a href="#RESTMapping" class="headerlink" title="RESTMapping()"></a>RESTMapping()</h4><p>调用的RESTMapper的RESTMapping()</p>
<h4 id="ClientForMapping"><a href="#ClientForMapping" class="headerlink" title="ClientForMapping()"></a>ClientForMapping()</h4><p>调用的就是f.ClientForMapping()</p>
<h3 id="Printer"><a href="#Printer" class="headerlink" title="Printer"></a>Printer</h3><p>Printer可以对Kubernetes中的资源按一定格式进行打印输出，Printer主要供Kubectl get命令使用。目前Kubectl主要实现了JsonPrinter, YAMLPrinter, NamePrinter, TemplatePrinter, JSONPathPrinter, CustomColumnsPrinter, VersionedPrinter, HumanReadablePrinter。</p>
<p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/cli-runtime/pkg/printers/interface.go#L35" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/printers/interface.go </a></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ResourcePrinterFunc is a function that can print objects</span>
<span class="token keyword">type</span> ResourcePrinterFunc <span class="token keyword">func</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span>

<span class="token comment" spellcheck="true">// PrintObj implements ResourcePrinter</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>fn ResourcePrinterFunc<span class="token punctuation">)</span> <span class="token function">PrintObj</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> w<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ResourcePrinter is an interface that knows how to print runtime objects.</span>
<span class="token keyword">type</span> ResourcePrinter <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Print receives a runtime object, formats it and prints it to a writer.</span>
    <span class="token function">PrintObj</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// PrintOptions struct defines a struct for various print options</span>
<span class="token keyword">type</span> PrintOptions <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    NoHeaders     <span class="token builtin">bool</span>
    WithNamespace <span class="token builtin">bool</span>
    WithKind      <span class="token builtin">bool</span>
    Wide          <span class="token builtin">bool</span>
    ShowLabels    <span class="token builtin">bool</span>
    Kind          schema<span class="token punctuation">.</span>GroupKind
    ColumnLabels  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>

    SortBy <span class="token builtin">string</span>

    <span class="token comment" spellcheck="true">// indicates if it is OK to ignore missing keys for rendering an output template.</span>
    AllowMissingKeys <span class="token builtin">bool</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="JSONPrinter"><a href="#JSONPrinter" class="headerlink" title="JSONPrinter"></a>JSONPrinter</h4><p>JSONPrinter 可以以JSON的格式打印Object。JSONPrinter调用了json.MarshalIndent()来对Obj进行JSON格式化打印。json.MarshalIndent()函数的功能和Marshal一致，只是把Object格式化成人性化阅读的JSON，有点类似”| python -mjson.tool”的功能。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// JSONPrinter is an implementation of ResourcePrinter which outputs an object as JSON.</span>
<span class="token keyword">type</span> JSONPrinter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>JSONPrinter<span class="token punctuation">)</span> <span class="token function">AfterPrint</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> res <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// PrintObj is an implementation of ResourcePrinter.PrintObj which simply writes the object to the Writer.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>JSONPrinter<span class="token punctuation">)</span> <span class="token function">PrintObj</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> obj <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Unknown<span class="token punctuation">:</span>
        <span class="token keyword">var</span> buf bytes<span class="token punctuation">.</span>Buffer
        err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Indent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> obj<span class="token punctuation">.</span>Raw<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"    "</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        buf<span class="token punctuation">.</span><span class="token function">WriteRune</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">WriteTo</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">MarshalIndent</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"    "</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    data <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// TODO: implement HandledResources()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>JSONPrinter<span class="token punctuation">)</span> <span class="token function">HandledResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>调用例子：</p>
<pre><code>kubectl get pods -o json</code></pre><h4 id="YAMLPrinter"><a href="#YAMLPrinter" class="headerlink" title="YAMLPrinter"></a>YAMLPrinter</h4><p>YAMLPrinter可以以YAML的格式打印Object。YAMLPrinter通过调用yaml.Marshal()把Object转换成YAML格式并进行打印。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// YAMLPrinter is an implementation of ResourcePrinter which outputs an object as YAML.</span>
<span class="token comment" spellcheck="true">// The input object is assumed to be in the internal version of an API and is converted</span>
<span class="token comment" spellcheck="true">// to the given version first.</span>
<span class="token keyword">type</span> YAMLPrinter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    version   <span class="token builtin">string</span>
    converter runtime<span class="token punctuation">.</span>ObjectConvertor
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>YAMLPrinter<span class="token punctuation">)</span> <span class="token function">AfterPrint</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> res <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// PrintObj prints the data as YAML.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>YAMLPrinter<span class="token punctuation">)</span> <span class="token function">PrintObj</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> obj <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Unknown<span class="token punctuation">:</span>
        data<span class="token punctuation">,</span> err <span class="token operator">:=</span> yaml<span class="token punctuation">.</span><span class="token function">JSONToYAML</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>Raw<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 把obj转成yaml格式</span>
    output<span class="token punctuation">,</span> err <span class="token operator">:=</span> yaml<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprint</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span></code></pre>
<p>调用例子：</p>
<pre><code>kubectl get pods -o yaml</code></pre><h4 id="NamePrinter"><a href="#NamePrinter" class="headerlink" title="NamePrinter"></a>NamePrinter</h4><p>NamePrinter可以打印资源类型和名称：如pod/ubuntu-ssh-589933015-2lhgb。NamePrinter先获判断Object是否为列表，如果是列表，则递归调用PrintObj；否则先获取Object的name，然后获取Object的Kind，并转换成单数形式的GVR，然后返回。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// NamePrinter is an implementation of ResourcePrinter which outputs "resource/name" pair of an object.</span>
<span class="token keyword">type</span> NamePrinter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Decoder runtime<span class="token punctuation">.</span>Decoder
    Typer   runtime<span class="token punctuation">.</span>ObjectTyper
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>NamePrinter<span class="token punctuation">)</span> <span class="token function">AfterPrint</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> res <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// PrintObj is an implementation of ResourcePrinter.PrintObj which decodes the object</span>
<span class="token comment" spellcheck="true">// and print "resource/name" pair. If the object is a List, print all items in it.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>NamePrinter<span class="token punctuation">)</span> <span class="token function">PrintObj</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> meta<span class="token punctuation">.</span><span class="token function">IsListType</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        items<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">ExtractList</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> errs <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">DecodeList</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> p<span class="token punctuation">.</span>Decoder<span class="token punctuation">,</span> runtime<span class="token punctuation">.</span>UnstructuredJSONScheme<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> obj <span class="token operator">:=</span> <span class="token keyword">range</span> items <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">PrintObj</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    name <span class="token operator">:=</span> <span class="token string">"&lt;unknown>"</span>
    <span class="token comment" spellcheck="true">// 获取name</span>
    <span class="token keyword">if</span> acc<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">Accessor</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> n <span class="token operator">:=</span> acc<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            name <span class="token operator">=</span> n
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> kind <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token function">GetObjectKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupVersionKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>kind<span class="token punctuation">.</span>Kind<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// this is the old code.  It's unnecessary on decoded external objects, but on internal objects</span>
        <span class="token comment" spellcheck="true">// you may have to do it.  Tests are definitely calling it with internals and I'm not sure who else</span>
        <span class="token comment" spellcheck="true">// is</span>
        <span class="token keyword">if</span> gvks<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span>Typer<span class="token punctuation">.</span><span class="token function">ObjectKinds</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// TODO: this is wrong, it assumes that meta knows about all Kinds - should take a RESTMapper</span>
            <span class="token boolean">_</span><span class="token punctuation">,</span> resource <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">KindToResource</span><span class="token punctuation">(</span>gvks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"%s/%s\n"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"&lt;unknown>/%s\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// TODO: this is wrong, it assumes that meta knows about all Kinds - should take a RESTMapper</span>
        <span class="token comment" spellcheck="true">// 直接调用KindToResource()把GVK转换成GVR，并选用单数形式</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> resource <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">KindToResource</span><span class="token punctuation">(</span>kind<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"%s/%s\n"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span></code></pre>
<p>调用例子：</p>
<pre><code># kubectl get pods -o name
pod/nginx-1487191267-0t8x3
pod/ubuntu-ssh-589933015-2lhgb</code></pre><h4 id="TemplatePrinter"><a href="#TemplatePrinter" class="headerlink" title="TemplatePrinter"></a>TemplatePrinter</h4><p>TemplatePrinter基于txt/template包实现。txt/template一般的用法为：<br>定义模板：</p>
<pre class=" language-go"><code class="language-go">tmpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"hello, {{.}}"</span><span class="token punctuation">)</span></code></pre>
<p>执行：</p>
<pre><code>err = tmpl.Execute(os.Stdout, name)</code></pre><p>TemplatePrinter定义如下：</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// TemplatePrinter is an implementation of ResourcePrinter which formats data with a Go Template.</span>
<span class="token comment" spellcheck="true">// 调用text/template包</span>
<span class="token keyword">type</span> TemplatePrinter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    rawTemplate <span class="token builtin">string</span>
    template    <span class="token operator">*</span>template<span class="token punctuation">.</span>Template
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewTemplatePrinter</span><span class="token punctuation">(</span>tmpl <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>TemplatePrinter<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    t<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"output"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Funcs</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span>FuncMap<span class="token punctuation">{</span><span class="token string">"exists"</span><span class="token punctuation">:</span> exists<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">Parse</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>TemplatePrinter<span class="token punctuation">{</span>
        rawTemplate<span class="token punctuation">:</span> <span class="token function">string</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">)</span><span class="token punctuation">,</span>
        template<span class="token punctuation">:</span>    t<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TemplatePrinter<span class="token punctuation">)</span> <span class="token function">AfterPrint</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> res <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// PrintObj formats the obj with the Go Template.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TemplatePrinter<span class="token punctuation">)</span> <span class="token function">PrintObj</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    <span class="token keyword">if</span> unstructured<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>runtime<span class="token punctuation">.</span>Unstructured<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        data<span class="token punctuation">,</span> err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>unstructured<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">,</span> err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    out <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">safeExecute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// It is way easier to debug this stuff when it shows up in</span>
        <span class="token comment" spellcheck="true">// stdout instead of just stdin. So in addition to returning</span>
        <span class="token comment" spellcheck="true">// a nice error, also print useful stuff with the writer.</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Error executing template: %v. Printing more information for debugging the template:\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"\ttemplate was:\n\t\t%v\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>rawTemplate<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"\traw data was:\n\t\t%v\n"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"\tobject given to template engine was:\n\t\t%+v\n\n"</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"error executing template %q: %v"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>rawTemplate<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// TODO: implement HandledResources()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TemplatePrinter<span class="token punctuation">)</span> <span class="token function">HandledResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>调用例子：</p>
<pre><code># kubectl get pods nginx-1487191267-0t8x3 -o go-template="The name is {{.metadata.name}}"
The name is nginx-1487191267-0t8x3</code></pre><p>或者</p>
<pre><code># kubectl get pods nginx-1487191267-0t8x3 -o go-template-file=template 
The name is nginx-1487191267-0t8x3</code></pre><p>其中<code>go-template-file=template</code>的template为文件，内容为:</p>
<pre><code>The name is {{.metadata.name}}</code></pre><h4 id="JSONPathPrinter"><a href="#JSONPathPrinter" class="headerlink" title="JSONPathPrinter"></a>JSONPathPrinter</h4><p>JSONPathPrinter实现了一套匹配规则，详见<a href="https://kubernetes.io/docs/user-guide/jsonpath/。" target="_blank" rel="noopener">https://kubernetes.io/docs/user-guide/jsonpath/。</a><br>jsonpath具体在<code>/pkg/util/jsonpath/jsonpath.go</code>中实现，具体分析此处略。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// JSONPathPrinter is an implementation of ResourcePrinter which formats data with jsonpath expression.</span>
<span class="token keyword">type</span> JSONPathPrinter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    rawTemplate <span class="token builtin">string</span>
    <span class="token operator">*</span>jsonpath<span class="token punctuation">.</span>JSONPath
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewJSONPathPrinter</span><span class="token punctuation">(</span>tmpl <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>JSONPathPrinter<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    j <span class="token operator">:=</span> jsonpath<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"out"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> j<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>JSONPathPrinter<span class="token punctuation">{</span>tmpl<span class="token punctuation">,</span> j<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>j <span class="token operator">*</span>JSONPathPrinter<span class="token punctuation">)</span> <span class="token function">AfterPrint</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> res <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// PrintObj formats the obj with the JSONPath Template.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>j <span class="token operator">*</span>JSONPathPrinter<span class="token punctuation">)</span> <span class="token function">PrintObj</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> queryObj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">=</span> obj
    <span class="token keyword">if</span> meta<span class="token punctuation">.</span><span class="token function">IsListType</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        queryObj <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>queryObj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> unknown<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>runtime<span class="token punctuation">.</span>Unknown<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>unknown<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        queryObj <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>queryObj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> unstructured<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>runtime<span class="token punctuation">.</span>Unstructured<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        queryObj <span class="token operator">=</span> unstructured<span class="token punctuation">.</span>Object
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> j<span class="token punctuation">.</span>JSONPath<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> queryObj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Error executing template: %v. Printing more information for debugging the template:\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"\ttemplate was:\n\t\t%v\n"</span><span class="token punctuation">,</span> j<span class="token punctuation">.</span>rawTemplate<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"\tobject given to jsonpath engine was:\n\t\t%#v\n\n"</span><span class="token punctuation">,</span> queryObj<span class="token punctuation">)</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"error executing jsonpath %q: %v\n"</span><span class="token punctuation">,</span> j<span class="token punctuation">.</span>rawTemplate<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// TODO: implement HandledResources()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>JSONPathPrinter<span class="token punctuation">)</span> <span class="token function">HandledResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>调用例子：</p>
<pre><code># kubectl get pods -o jsonpath={.items[*].metadata.name}
nginx-1487191267-0t8x3 ubuntu-ssh-589933015-2lhgb</code></pre><p>或者</p>
<pre><code># kubectl get pods -o jsonpath-file=template
nginx-1487191267-0t8x3 ubuntu-ssh-589933015-2lhgb</code></pre><p>其中<code>jsonpath-file=template</code>的template为文件，内容为:</p>
<pre><code>{.items[*].metadata.name}</code></pre><h4 id="CustomColumnsPrinter"><a href="#CustomColumnsPrinter" class="headerlink" title="CustomColumnsPrinter"></a>CustomColumnsPrinter</h4><p>CustomColumnsPrinter允许用户定义列名，是JSONPath的加强版。支持从命令行直接输入模板和从文件读取模板两种方式。</p>
<p>读取命令行模板的CustomColumnsPrinter生成函数如下：</p>
<pre class=" language-go"><code class="language-go"><span class="token operator">/</span><span class="token comment" spellcheck="true">/***kubectl get pods -o custom-columns=Type:{.kind},Name:{.metadata.name}***/</span><span class="token operator">/</span>
<span class="token keyword">func</span> <span class="token function">NewCustomColumnsPrinterFromSpec</span><span class="token punctuation">(</span>spec <span class="token builtin">string</span><span class="token punctuation">,</span> decoder runtime<span class="token punctuation">.</span>Decoder<span class="token punctuation">,</span> noHeaders <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>CustomColumnsPrinter<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"custom-columns format specified but no custom columns given"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// parts: [Type:{.kind} Name:{.metadata.name}]</span>
    parts <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>spec<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span>
    columns <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Column<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> ix <span class="token operator">:=</span> <span class="token keyword">range</span> parts <span class="token punctuation">{</span>
        colSpec <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>colSpec<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unexpected custom-columns spec: %s, expected &lt;header>:&lt;json-path-expr>"</span><span class="token punctuation">,</span> parts<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        spec<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">massageJSONPath</span><span class="token punctuation">(</span>colSpec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        columns<span class="token punctuation">[</span>ix<span class="token punctuation">]</span> <span class="token operator">=</span> Column<span class="token punctuation">{</span>Header<span class="token punctuation">:</span> colSpec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> FieldSpec<span class="token punctuation">:</span> spec<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>CustomColumnsPrinter<span class="token punctuation">{</span>Columns<span class="token punctuation">:</span> columns<span class="token punctuation">,</span> Decoder<span class="token punctuation">:</span> decoder<span class="token punctuation">,</span> NoHeaders<span class="token punctuation">:</span> noHeaders<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span></code></pre>
<p>读取文件模板的CustomColumnsPrinter生成函数如下：</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// kubectl get pods -o custom-columns-file=/home/fankang/template</span>
<span class="token keyword">func</span> <span class="token function">NewCustomColumnsPrinterFromTemplate</span><span class="token punctuation">(</span>templateReader io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> decoder runtime<span class="token punctuation">.</span>Decoder<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>CustomColumnsPrinter<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scanner <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewScanner</span><span class="token punctuation">(</span>templateReader<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid template, missing header line. Expected format is one line of space separated headers, one line of space separated column specs."</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// headers: [Type Name]</span>
    headers <span class="token operator">:=</span> <span class="token function">splitOnWhitespace</span><span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token operator">!</span>scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid template, missing spec line. Expected format is one line of space separated headers, one line of space separated column specs."</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// specs: [{.kind} {.metadata.name}]</span>
    specs <span class="token operator">:=</span> <span class="token function">splitOnWhitespace</span><span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 如果headers和specs长度不一致，则直接返回</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>specs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"number of headers (%d) and field specifications (%d) don't match"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>specs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    columns <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Column<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> ix <span class="token operator">:=</span> <span class="token keyword">range</span> headers <span class="token punctuation">{</span>
        spec<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">massageJSONPath</span><span class="token punctuation">(</span>specs<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 组装成Column</span>
        columns<span class="token punctuation">[</span>ix<span class="token punctuation">]</span> <span class="token operator">=</span> Column<span class="token punctuation">{</span>
            Header<span class="token punctuation">:</span>    headers<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">,</span>
            FieldSpec<span class="token punctuation">:</span> spec<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 返回CustomColumnsPrinter</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>CustomColumnsPrinter<span class="token punctuation">{</span>Columns<span class="token punctuation">:</span> columns<span class="token punctuation">,</span> Decoder<span class="token punctuation">:</span> decoder<span class="token punctuation">,</span> NoHeaders<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span></code></pre>
<p>CustomColumnsPrinter的PrintObj()方法如下，可以看出，调用了jsonpath.New()来解析模板。</p>
<pre><code>func (s *CustomColumnsPrinter) PrintObj(obj runtime.Object, out io.Writer) error {
    w := tabwriter.NewWriter(out, columnwidth, tabwidth, padding, padding_character, flags)

    if !s.NoHeaders {
        headers := make([]string, len(s.Columns))
        for ix := range s.Columns {
            headers[ix] = s.Columns[ix].Header
        }
        fmt.Fprintln(w, strings.Join(headers, "\t"))
    }
    parsers := make([]*jsonpath.JSONPath, len(s.Columns))
    for ix := range s.Columns {
        parsers[ix] = jsonpath.New(fmt.Sprintf("column%d", ix))
        if err := parsers[ix].Parse(s.Columns[ix].FieldSpec); err != nil {
            return err
        }
    }

    if meta.IsListType(obj) {
        objs, err := meta.ExtractList(obj)
        if err != nil {
            return err
        }
        for ix := range objs {
            if err := s.printOneObject(objs[ix], parsers, w); err != nil {
                return err
            }
        }
    } else {
        if err := s.printOneObject(obj, parsers, w); err != nil {
            return err
        }
    }
    return w.Flush()
}</code></pre><p>调用例子：</p>
<pre><code># kubectl get pods -o custom-columns=Type:{.kind},Name:{.metadata.name}
Type      Name
Pod       nginx-1487191267-0t8x3
Pod       ubuntu-ssh-589933015-2lhgb</code></pre><p>或者</p>
<pre><code># kubectl get pods -o custom-columns-file=template
Type      Name
Pod       nginx-1487191267-0t8x3
Pod       ubuntu-ssh-589933015-2lhgb</code></pre><p>其中<code>custom-columns-file=template</code>的template为文件，内容为:</p>
<pre><code>Type              Name
{.kind}           {.metadata.name}</code></pre><h4 id="VersionedPrinter"><a href="#VersionedPrinter" class="headerlink" title="VersionedPrinter"></a>VersionedPrinter</h4><p>VersionedPrinter是对其他Printer的封装，先把Object转换成对应版本的Object，然后再封装的Printer进行打印。</p>
<pre><code>// VersionedPrinter takes runtime objects and ensures they are converted to a given API version
// prior to being passed to a nested printer.
type VersionedPrinter struct {
    printer   ResourcePrinter
    converter runtime.ObjectConvertor
    versions  []unversioned.GroupVersion
}

// NewVersionedPrinter wraps a printer to convert objects to a known API version prior to printing.
func NewVersionedPrinter(printer ResourcePrinter, converter runtime.ObjectConvertor, versions ...unversioned.GroupVersion) ResourcePrinter {
    return &amp;VersionedPrinter{
        printer:   printer,
        converter: converter,
        versions:  versions,
    }
}

func (p *VersionedPrinter) AfterPrint(w io.Writer, res string) error {
    return nil
}

// PrintObj implements ResourcePrinter
func (p *VersionedPrinter) PrintObj(obj runtime.Object, w io.Writer) error {
    if len(p.versions) == 0 {
        return fmt.Errorf("no version specified, object cannot be converted")
    }
    converted, err := p.converter.ConvertToVersion(obj, unversioned.GroupVersions(p.versions))
    if err != nil {
        return err
    }
    return p.printer.PrintObj(converted, w)
}</code></pre><p>version由<code>kubectl get pods --output-version='v1' -o yaml -w</code>的–output-version指定，但没什么作用，而且kubectl get代码中只有Watch会使用VersionedPrinter，所以还待更深入的研究。</p>
<h4 id="HumanReadablePrinter"><a href="#HumanReadablePrinter" class="headerlink" title="HumanReadablePrinter"></a>HumanReadablePrinter</h4><p>HumanReadablePrinter可以”人性化”地输出内容。HumanReadablePrinter中有handlerMap，handlerMap记录了待打印的对象到处理函数的映射关系。系统中每种资源都有对应的打印函数。</p>
<p>其中<code>kubectl -o wide</code>调用的也是HumanReadablePrinter。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> HumanReadablePrinter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    handlerMap   <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span><span class="token operator">*</span>handlerEntry
    options      PrintOptions
    lastType     reflect<span class="token punctuation">.</span>Type
    hiddenObjNum <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// NewHumanReadablePrinter creates a HumanReadablePrinter.</span>
<span class="token comment" spellcheck="true">// 创建HumanReadablePrinter</span>
<span class="token keyword">func</span> <span class="token function">NewHumanReadablePrinter</span><span class="token punctuation">(</span>options PrintOptions<span class="token punctuation">)</span> <span class="token operator">*</span>HumanReadablePrinter <span class="token punctuation">{</span>
    printer <span class="token operator">:=</span> <span class="token operator">&amp;</span>HumanReadablePrinter<span class="token punctuation">{</span>
        handlerMap<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span><span class="token operator">*</span>handlerEntry<span class="token punctuation">)</span><span class="token punctuation">,</span>
        options<span class="token punctuation">:</span>    options<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    printer<span class="token punctuation">.</span><span class="token function">addDefaultHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> printer
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 打印第一行标题</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HumanReadablePrinter<span class="token punctuation">)</span> <span class="token function">printHeader</span><span class="token punctuation">(</span>columnNames <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>columnNames<span class="token punctuation">,</span> <span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 打印Pod</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HumanReadablePrinter<span class="token punctuation">)</span> <span class="token function">printPod</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>api<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> options PrintOptions<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">printPodBase</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> w<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">printPodBase</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>api<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> options PrintOptions<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    name <span class="token operator">:=</span> <span class="token function">formatResourceName</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>Kind<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> options<span class="token punctuation">.</span>WithKind<span class="token punctuation">)</span>
    namespace <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Namespace

    restarts <span class="token operator">:=</span> <span class="token number">0</span>
    totalContainers <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Containers<span class="token punctuation">)</span>
    readyContainers <span class="token operator">:=</span> <span class="token number">0</span>

    reason <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Phase<span class="token punctuation">)</span>
    <span class="token keyword">if</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Reason <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        reason <span class="token operator">=</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Reason
    <span class="token punctuation">}</span>

    initializing <span class="token operator">:=</span> <span class="token boolean">false</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>InitContainerStatuses <span class="token punctuation">{</span>
        container <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>InitContainerStatuses<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        restarts <span class="token operator">+=</span> <span class="token function">int</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>RestartCount<span class="token punctuation">)</span>
        <span class="token keyword">switch</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>ExitCode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">case</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true">// initialization is failed</span>
            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Reason<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Signal <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                    reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Init:Signal:%d"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Init:ExitCode:%d"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>ExitCode<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                reason <span class="token operator">=</span> <span class="token string">"Init:"</span> <span class="token operator">+</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Reason
            <span class="token punctuation">}</span>
            initializing <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">case</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting<span class="token punctuation">.</span>Reason<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting<span class="token punctuation">.</span>Reason <span class="token operator">!=</span> <span class="token string">"PodInitializing"</span><span class="token punctuation">:</span>
            reason <span class="token operator">=</span> <span class="token string">"Init:"</span> <span class="token operator">+</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting<span class="token punctuation">.</span>Reason
            initializing <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Init:%d/%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>InitContainers<span class="token punctuation">)</span><span class="token punctuation">)</span>
            initializing <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>initializing <span class="token punctuation">{</span>
        restarts <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>ContainerStatuses<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
            container <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>ContainerStatuses<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

            restarts <span class="token operator">+=</span> <span class="token function">int</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>RestartCount<span class="token punctuation">)</span>
            <span class="token keyword">if</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting<span class="token punctuation">.</span>Reason <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
                reason <span class="token operator">=</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting<span class="token punctuation">.</span>Reason
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Reason <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
                reason <span class="token operator">=</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Reason
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Reason <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Signal <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                    reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Signal:%d"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"ExitCode:%d"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>ExitCode<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> container<span class="token punctuation">.</span>Ready <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Running <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                readyContainers<span class="token operator">++</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> pod<span class="token punctuation">.</span>DeletionTimestamp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Reason <span class="token operator">==</span> node<span class="token punctuation">.</span>NodeUnreachablePodReason <span class="token punctuation">{</span>
        reason <span class="token operator">=</span> <span class="token string">"Unknown"</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> pod<span class="token punctuation">.</span>DeletionTimestamp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        reason <span class="token operator">=</span> <span class="token string">"Terminating"</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> options<span class="token punctuation">.</span>WithNamespace <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"%s\t"</span><span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"%s\t%d/%d\t%s\t%d\t%s"</span><span class="token punctuation">,</span>
        name<span class="token punctuation">,</span>
        readyContainers<span class="token punctuation">,</span>
        totalContainers<span class="token punctuation">,</span>
        reason<span class="token punctuation">,</span>
        restarts<span class="token punctuation">,</span>
        <span class="token function">translateTimestamp</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>CreationTimestamp<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// -o wide则写入IP和NODE</span>
    <span class="token keyword">if</span> options<span class="token punctuation">.</span>Wide <span class="token punctuation">{</span>
        nodeName <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeName
        podIP <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>PodIP
        <span class="token keyword">if</span> podIP <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            podIP <span class="token operator">=</span> <span class="token string">"&lt;none>"</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"\t%s\t%s"</span><span class="token punctuation">,</span>
            podIP<span class="token punctuation">,</span>
            nodeName<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprint</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token function">AppendLabels</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Labels<span class="token punctuation">,</span> options<span class="token punctuation">.</span>ColumnLabels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprint</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token function">AppendAllLabels</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>ShowLabels<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span></code></pre>
<p>调用例子：</p>
<pre><code># kubectl get pods
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-7c96855774-c5xbp   1/1     Running   0          28s
nginx-deployment-7c96855774-lqzr4   1/1     Running   0          28s
nginx-deployment-7c96855774-txw7c   1/1     Running   0          28s
nginx-deployment-7c96855774-vjm6p   1/1     Running   0          28s</code></pre><p>或者</p>
<pre><code>
# kubectl get pods -o wide
NAME                                READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
nginx-deployment-7c96855774-c5xbp   1/1     Running   0          5s    10.100.166.154   node1   &lt;none&gt;           &lt;none&gt;
nginx-deployment-7c96855774-lqzr4   1/1     Running   0          5s    10.100.166.153   node1   &lt;none&gt;           &lt;none&gt;
nginx-deployment-7c96855774-txw7c   1/1     Running   0          5s    10.100.104.33    node2   &lt;none&gt;           &lt;none&gt;
nginx-deployment-7c96855774-vjm6p   1/1     Running   0          5s    10.100.104.34    node2   &lt;none&gt;           &lt;none&gt;
[root@master work]#
</code></pre><h3 id="Describer"><a href="#Describer" class="headerlink" title="Describer"></a>Describer</h3><p>Describer 是 Kubectl 上用来描述对象具体信息的，和<code>kubectl describe</code>配合使用。</p>
<p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/kubectl/pkg/describe/interface.go#L43" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/kubectl/pkg/describe/interface.go</a></p>
<p>Describer( )函数，可以依据 mapping 生成合适的 Describer。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> ResourceDescriber <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Describe</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> describerSettings DescriberSettings<span class="token punctuation">)</span> <span class="token punctuation">(</span>output <span class="token builtin">string</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以看到，只要实现了Describe()的结构体都可以称为Describer。</p>
<p>所以，在<code>/pkg/kubectl/describer.go</code>中，实现了 PodDescriber, ReplicationControllerDescriber, SecretDescriber, ServiceDescriber, ServiceAccountDescriber, NodeDescriber, LimitRangeDescriber, ResourceQuotaDescriber, PersistentVolumeDescriber, PersistentVolumeClaimDescriber, NamespaceDescriber, EndpointsDescriber, ConfigMapDescriber, ReplicaSetDescriber, HorizontalPodAutoscalerDescriber, NetworkPolicyDescriber, HorizontalPodAutoscalerDescriber, DaemonSetDescriber, DeploymentDescriber, JobDescriber, IngressDescriber, JobDescriber, CronJobDescriber, StatefulSetDescriber, CertificateSigningRequestDescriber, StorageClassDescriber, PodDisruptionBudgetDescriber。</p>
<p>在实现Describer的结构体中，通常会嵌入一个clientset，用来在Describe()中获取具体的Object。比如说下面的ReplicationControllerDescriber。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>ReplicationControllerDescriber<span class="token punctuation">)</span> <span class="token function">Describe</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> describerSettings DescriberSettings<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rc <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReplicationControllers</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span>
    pc <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span>

    controller<span class="token punctuation">,</span> err <span class="token operator">:=</span> rc<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>GetOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    running<span class="token punctuation">,</span> waiting<span class="token punctuation">,</span> succeeded<span class="token punctuation">,</span> failed<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getPodStatusForController</span><span class="token punctuation">(</span>pc<span class="token punctuation">,</span> labels<span class="token punctuation">.</span><span class="token function">SelectorFromSet</span><span class="token punctuation">(</span>controller<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>UID<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> events <span class="token operator">*</span>corev1<span class="token punctuation">.</span>EventList
    <span class="token keyword">if</span> describerSettings<span class="token punctuation">.</span>ShowEvents <span class="token punctuation">{</span>
        events<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Events</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span>scheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> controller<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">describeReplicationController</span><span class="token punctuation">(</span>controller<span class="token punctuation">,</span> events<span class="token punctuation">,</span> running<span class="token punctuation">,</span> waiting<span class="token punctuation">,</span> succeeded<span class="token punctuation">,</span> failed<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="DescriberMap"><a href="#DescriberMap" class="headerlink" title="DescriberMap"></a>DescriberMap</h4><p>DescriberMap中记录了GK和Describer的关系。这里使用GK作为Key，因为GK足以标记一个类型。目前还不支持同名Kind出现在不同的Group(internal除外)中(否则resource无法找到合适的GVK)，所以感觉完全可以仅使用Kind作为Key。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">describerMap</span><span class="token punctuation">(</span>clientConfig <span class="token operator">*</span>rest<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupKind<span class="token punctuation">]</span>ResourceDescriber<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientset<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    m <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupKind<span class="token punctuation">]</span>ResourceDescriber<span class="token punctuation">{</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Pod"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                                    <span class="token operator">&amp;</span>PodDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ReplicationController"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                  <span class="token operator">&amp;</span>ReplicationControllerDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Secret"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                                 <span class="token operator">&amp;</span>SecretDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Service"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                                <span class="token operator">&amp;</span>ServiceDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ServiceAccount"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                         <span class="token operator">&amp;</span>ServiceAccountDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Node"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                                   <span class="token operator">&amp;</span>NodeDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"LimitRange"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                             <span class="token operator">&amp;</span>LimitRangeDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ResourceQuota"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                          <span class="token operator">&amp;</span>ResourceQuotaDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"PersistentVolume"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                       <span class="token operator">&amp;</span>PersistentVolumeDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"PersistentVolumeClaim"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                  <span class="token operator">&amp;</span>PersistentVolumeClaimDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Namespace"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                              <span class="token operator">&amp;</span>NamespaceDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Endpoints"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                              <span class="token operator">&amp;</span>EndpointsDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ConfigMap"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                              <span class="token operator">&amp;</span>ConfigMapDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"PriorityClass"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                          <span class="token operator">&amp;</span>PriorityClassDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> discoveryv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"EndpointSlice"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                <span class="token operator">&amp;</span>EndpointSliceDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> extensionsv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ReplicaSet"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                  <span class="token operator">&amp;</span>ReplicaSetDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> extensionsv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"NetworkPolicy"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>               <span class="token operator">&amp;</span>NetworkPolicyDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> extensionsv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"PodSecurityPolicy"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>           <span class="token operator">&amp;</span>PodSecurityPolicyDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> autoscalingv2beta2<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"HorizontalPodAutoscaler"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>    <span class="token operator">&amp;</span>HorizontalPodAutoscalerDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> extensionsv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"DaemonSet"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                   <span class="token operator">&amp;</span>DaemonSetDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> extensionsv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Deployment"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                  <span class="token operator">&amp;</span>DeploymentDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> extensionsv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Ingress"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                     <span class="token operator">&amp;</span>IngressDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> networkingv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Ingress"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                     <span class="token operator">&amp;</span>IngressDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> networkingv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"IngressClass"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                <span class="token operator">&amp;</span>IngressClassDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> batchv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Job"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                                   <span class="token operator">&amp;</span>JobDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> batchv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"CronJob"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                               <span class="token operator">&amp;</span>CronJobDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> appsv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"StatefulSet"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                            <span class="token operator">&amp;</span>StatefulSetDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> appsv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Deployment"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                             <span class="token operator">&amp;</span>DeploymentDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> appsv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"DaemonSet"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                              <span class="token operator">&amp;</span>DaemonSetDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> appsv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ReplicaSet"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                             <span class="token operator">&amp;</span>ReplicaSetDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> certificatesv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"CertificateSigningRequest"</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>CertificateSigningRequestDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> storagev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"StorageClass"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                        <span class="token operator">&amp;</span>StorageClassDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> storagev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"CSINode"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                             <span class="token operator">&amp;</span>CSINodeDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> policyv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"PodDisruptionBudget"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>             <span class="token operator">&amp;</span>PodDisruptionBudgetDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> rbacv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Role"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                                   <span class="token operator">&amp;</span>RoleDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> rbacv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ClusterRole"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                            <span class="token operator">&amp;</span>ClusterRoleDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> rbacv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"RoleBinding"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                            <span class="token operator">&amp;</span>RoleBindingDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> rbacv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ClusterRoleBinding"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                     <span class="token operator">&amp;</span>ClusterRoleBindingDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> networkingv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"NetworkPolicy"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                    <span class="token operator">&amp;</span>NetworkPolicyDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> schedulingv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"PriorityClass"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                    <span class="token operator">&amp;</span>PriorityClassDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> m<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>所以来看来<code>/pkg/kubectl/describe.go</code>中的DescriberFor()函数：</p>
<pre><code>// 返回合适的describer
func DescriberFor(kind schema.GroupKind, clientConfig *rest.Config) (ResourceDescriber, bool) {
    describers, err := describerMap(clientConfig)
    if err != nil {
        klog.V(1).Info(err)
        return nil, false
    }

    f, ok := describers[kind]
    return f, ok
}</code></pre><p>函数的实现很简单，先调用describerMap()生成DescriberMap，然后找到对应kind的Describer。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Rootkit</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://xipfs.github.io/2020/05/21/k8s02/">http://xipfs.github.io/2020/05/21/k8s02/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Rootkit</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Kubernetes/">
                                    <span class="chip bg-color">Kubernetes</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/05/27/k8s03/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="深入理解 Kubernetes 之 API server">
                        
                        <span class="card-title">深入理解 Kubernetes 之 API server</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            API server简介Kubernetes API server 为 api 对象验证并配置数据，包括 pods、 services、 replicationcontrollers 和其它 api 对象。API Server 提供 RES
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-05-27
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Kubernetes/" class="post-category">
                                    Kubernetes
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Kubernetes/">
                        <span class="chip bg-color">Kubernetes</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/05/21/k8s01/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="深入理解 Kubernetes 概述">
                        
                        <span class="card-title">深入理解 Kubernetes 概述</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Kubernetes 架构设计
Kubernetes 流程
Kubernetes 核心组件Kubectlkubectl 是用户与 Kubernetes 交互的命令行工具。用户使用 kubectl 工具调用 Apiserver 的接口来与 K
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-05-21
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Kubernetes/" class="post-category">
                                    Kubernetes
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Kubernetes/">
                        <span class="chip bg-color">Kubernetes</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="868680226"
                   fixed='true'
                   autoplay='true'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="/about" target="_blank">rootkit</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">78k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/xipfs" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:flexie@foxmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=514591940" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 514591940" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
