<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="深入理解 Kubernetes 之 API server, TYPEOF">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>深入理解 Kubernetes 之 API server | TYPEOF</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="TYPEOF" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">TYPEOF</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">TYPEOF</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/7.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">深入理解 Kubernetes 之 API server</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Kubernetes/">
                                <span class="chip bg-color">Kubernetes</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Kubernetes/" class="post-category">
                                Kubernetes
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-05-27
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2020-05-27
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    15.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    81 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="API-server"><a href="#API-server" class="headerlink" title="API server"></a>API server</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Kubernetes API server 为 api 对象验证并配置数据，包括 pods、 services、 replicationcontrollers 和其它 api 对象。API Server 提供 REST 操作和到集群共享状态的前端，所有其他组件通过它进行交互，是整个系统的数据总线和数据中心。</p>
<p><img src="/images/2020/communication_paths.png" alt=""></p>
<p>Kubernetes 中的其它组件都不会和 etcd 进行交互，只有 API Server 可以和 etcd 进行交互,api-server 具有如下功能：</p>
<ul>
<li>整个集群管理的API接口：所有对集群进行的查询和管理都是通过API 进行</li>
<li>集群内部各个模块之间通信的枢纽：所有模块之间并不会互相调用，而是通过和 API Serve r打交道完成这部分的工作</li>
<li>集群的安全控制:API Server 提供的验证和授权保证了整个集群的安全</li>
</ul>
<h2 id="API-server-工作原理"><a href="#API-server-工作原理" class="headerlink" title="API server 工作原理"></a>API server 工作原理</h2><p><img src="/images/2020/API_server.jpg" alt=""></p>
<h3 id="声明式-API-设计"><a href="#声明式-API-设计" class="headerlink" title="声明式 API 设计"></a>声明式 API 设计</h3><p><strong>描述资源版本信息</strong></p>
<pre><code>/api/{version}/{resource}/{action}</code></pre><p>上面是一个基础的 web url 通常我们都会为每个版本注册一个对应的 URL, 其中会包含很关键的两个信息即 version与 resource ,通过这两个信息,通常我们就可以知道这可能是某个资源的那个版本, 如果我们把后面的 action 也包裹进来,我们通常就可以知道对应的资源的那个具体操作</p>
<p><strong>Group组信息</strong></p>
<p><img src="/images/2020/gvk.png" alt=""></p>
<p>我们通过 url 里面获取到资源的 GroupVersionKind 信息，如何将其映射为一个具体的类型呢？结合反射和map来做就可以了，我们通过url获取到对应想的GVK信息，然后在通过我们的映射表，就知道对应的模型是哪个，接下来就只需要进行转换就行了</p>
<p><img src="/images/2020/parse_gvk.png" alt=""></p>
<h4 id="RESTMapper"><a href="#RESTMapper" class="headerlink" title="RESTMapper"></a>RESTMapper</h4><p>RESTMapper是一个interface，定义在<a href="https://github.com/kubernetes/kubernetes/blob/9e991415386e4cf155a24b1da15becaa390438d8/staging/src/k8s.io/apimachinery/pkg/api/meta/interfaces.go#L113" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apimachinery/pkg/api/meta/interfaces.go </a>中:</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> RESTMapper <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">KindFor</span><span class="token punctuation">(</span>resource schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">)</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">KindsFor</span><span class="token punctuation">(</span>resource schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">ResourceFor</span><span class="token punctuation">(</span>input schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">)</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">ResourcesFor</span><span class="token punctuation">(</span>input schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">RESTMapping</span><span class="token punctuation">(</span>gk schema<span class="token punctuation">.</span>GroupKind<span class="token punctuation">,</span> versions <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>RESTMapping<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">RESTMappings</span><span class="token punctuation">(</span>gk schema<span class="token punctuation">.</span>GroupKind<span class="token punctuation">,</span> versions <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>RESTMapping<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">ResourceSingularizer</span><span class="token punctuation">(</span>resource <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>singular <span class="token builtin">string</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>RESTMapper 映射是指 GVR(GroupVersionResource) 和 GVK(GroupVersionKind) 的关系，可以通过 GVR 找到合适的 GVK，并可以通过GVK 生成一个 RESTMapping。</p>
<h4 id="RESTMapping"><a href="#RESTMapping" class="headerlink" title="RESTMapping"></a>RESTMapping</h4><p>与 RESTMapper 定义在同一个文件中</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> RESTMapping <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Resource schema<span class="token punctuation">.</span>GroupVersionResource
    GroupVersionKind schema<span class="token punctuation">.</span>GroupVersionKind
    Scope RESTScope
<span class="token punctuation">}</span></code></pre>
<p>RESTMapping 包含 Resource 名称，及其对应的 GVK，还有一个Scope(标明资源是否为root或者namespaced)，</p>
<h4 id="RESTScope"><a href="#RESTScope" class="headerlink" title="RESTScope"></a>RESTScope</h4><p>与 RESTMapper 定义在同一个文件中</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> RESTScope <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> RESTScopeName
<span class="token punctuation">}</span></code></pre>
<p>表明作用域可以是基于 namespace 的，也可以是基于集群的。 如果是基于 namespace 的。则API格式为：<code>/apis/{group}/v1/namespaces/{namespace}/{spec.names.plural}/…</code> 如果是基于 cluster 的。则API格式为：<code>/apis/{group}/v1/{spec.names.plural}/…</code> 上文创建的 CRD 的 API 则为：<code>/apis/xxx.com/v1/namespaces/{namespace}/tasks</code></p>
<h4 id="DefaultRESTMapper"><a href="#DefaultRESTMapper" class="headerlink" title="DefaultRESTMapper"></a>DefaultRESTMapper</h4><p>代码路径：<a href="https://github.com/kubernetes/kubernetes/blob/9e991415386e4cf155a24b1da15becaa390438d8/staging/src/k8s.io/apimachinery/pkg/api/meta/restmapper.go#L57" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apimachinery/pkg/api/meta/restmapper.go </a></p>
<p>DefaultRESTMapper 实现了 RESTMapper interface。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// DefaultRESTMapper 中的 resource 是指 GVR，kind 是指 GVK</span>
<span class="token comment" spellcheck="true">// singular和 Plural 都是 GVR</span>
<span class="token keyword">type</span> DefaultRESTMapper <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    defaultGroupVersions <span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersion

    resourceToKind       <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionKind
    kindToPluralResource <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionResource
    kindToScope          <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">]</span>RESTScope
    singularToPlural     <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionResource
    pluralToSingular     <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionResource
<span class="token punctuation">}</span>
</code></pre>
<p>现在来详细分析DefaultRESTMapper的字段的涵义。</p>
<ul>
<li>defaultGroupVersions: 默认的GroupVersion，如v1，apps/v1beta1等，一般一个 DefaultRESTMapper只设一个默认的GroupVersion；</li>
<li>resourceToKind：GVR(单数,复数)到GVK的map；</li>
<li>kindToPluralResource：GVK到GVR(复数)的map；</li>
<li>kindToScope：GVK到Scope的map；</li>
<li>singularToPlural：GVR(单数)到GVR(复数)的map；</li>
<li>pluralToSingular:  GVR(单数)到GVR(复数)的map；</li>
</ul>
<p>RESTMapper 可以从 GVR 获取 GVK，并生成一个 RESTMapping 来处理该 GVR。RESTMapping 中有Resource名称，GVK，Scope等和GVR有关的信息</p>
<h4 id="Scheme"><a href="#Scheme" class="headerlink" title="Scheme"></a>Scheme</h4><p><img src="/images/2020/scheme.png" alt=""></p>
<p>如果说 RESTMapper 管理的是 GVR 和 GVK 的关系，那么 Scheme 管理的就是 GVK 和 Type 的关系。系统中所有的Type都要注册到Scheme中，当然目前系统只有一个Scheme，即api.Scheme，定义在<a href="https://github.com/kubernetes/kubernetes/blob/565566f4b2dae269bec108624fe28d3462d6ae2a/staging/src/k8s.io/client-go/kubernetes/scheme/register.go#L69" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/client-go/kubernetes/scheme/register.go </a>中：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">var</span> Scheme <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>Scheme 定义在<a href="https://github.com/kubernetes/kubernetes/blob/565566f4b2dae269bec108624fe28d3462d6ae2a/staging/src/k8s.io/apimachinery/pkg/runtime/scheme.go#L47" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apimachinery/pkg/runtime/scheme.go </a></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> Scheme <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// versionMap allows one to figure out the go type of an object with</span>
    <span class="token comment" spellcheck="true">// the given version and name.</span>
    gvkToType <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type

    <span class="token comment" spellcheck="true">// typeToGroupVersion allows one to find metadata for a given go object.</span>
    <span class="token comment" spellcheck="true">// The reflect.Type we index by should *not* be a pointer.</span>
    typeToGVK <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionKind

    <span class="token comment" spellcheck="true">// unversionedTypes are transformed without conversion in ConvertToVersion.</span>
    unversionedTypes <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionKind

    <span class="token comment" spellcheck="true">// unversionedKinds are the names of kinds that can be created in the context of any group</span>
    <span class="token comment" spellcheck="true">// or version</span>
    <span class="token comment" spellcheck="true">// TODO: resolve the status of unversioned types.</span>
    unversionedKinds <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type

    <span class="token comment" spellcheck="true">// Map from version and resource to the corresponding func to convert</span>
    <span class="token comment" spellcheck="true">// resource field labels in that version to internal version.</span>
    fieldLabelConversionFuncs <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">]</span>FieldLabelConversionFunc

    <span class="token comment" spellcheck="true">// defaulterFuncs is an array of interfaces to be called with an object to provide defaulting</span>
    <span class="token comment" spellcheck="true">// the provided object must be a pointer.</span>
    defaulterFuncs <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// converter stores all registered conversion functions. It also has</span>
    <span class="token comment" spellcheck="true">// default converting behavior.</span>
    converter <span class="token operator">*</span>conversion<span class="token punctuation">.</span>Converter

    <span class="token comment" spellcheck="true">// versionPriority is a map of groups to ordered lists of versions for those groups indicating the</span>
    <span class="token comment" spellcheck="true">// default priorities of these versions as registered in the scheme</span>
    versionPriority <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>

    <span class="token comment" spellcheck="true">// observedVersions keeps track of the order we've seen versions during type registration</span>
    observedVersions <span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersion

    <span class="token comment" spellcheck="true">// schemeName is the name of this scheme.  If you don't specify a name, the stack of the NewScheme caller will be used.</span>
    <span class="token comment" spellcheck="true">// This is useful for error reporting to indicate the origin of the scheme.</span>
    schemeName <span class="token builtin">string</span>
<span class="token punctuation">}</span></code></pre>
<p>可以看出，Scheme除了管理 GVK 和 Type 的关系，还管理有默认设置函数，并聚合了converter及cloner。我们来详细看下每个字段的含义：</p>
<ul>
<li>gvkToType: 存储 gvk 和 Type 的关系，一个 gvk 只能对应一个 Type；</li>
<li>typeToGVK：存储 Type 和 gvk 的关系，一个 type 可能对应多个 GVK；</li>
<li>unversionedTypes：记录 unversioned 的 Type 和 GVK 的关系，unversioned 无需版本转换；</li>
<li>unversionedKinds：记录 unversioned 的 GVK 和 Type 的关系；</li>
<li>fieldLabelConversionFuncs：管理 field selector 的转换，如旧版本v1的 spec.host 需要转换成spec.nodeName (详见在<a href="https://github.com/kubernetes/kubernetes/blob/f221dbb91bde0d447226a7f15b7c4301ddd161c6/pkg/apis/core/v1/conversion.go#L33" target="_blank" rel="noopener">kubernetes/pkg/apis/core/v1/conversion.go</a>中的addConversionFuncs()函数)；</li>
</ul>
<pre class=" language-go"><code class="language-go">    <span class="token keyword">func</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> label <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"metadata.name"</span><span class="token punctuation">,</span>
                <span class="token string">"metadata.namespace"</span><span class="token punctuation">,</span>
                <span class="token string">"spec.nodeName"</span><span class="token punctuation">,</span>
                <span class="token string">"spec.restartPolicy"</span><span class="token punctuation">,</span>
                <span class="token string">"spec.schedulerName"</span><span class="token punctuation">,</span>
                <span class="token string">"spec.serviceAccountName"</span><span class="token punctuation">,</span>
                <span class="token string">"status.phase"</span><span class="token punctuation">,</span>
                <span class="token string">"status.podIP"</span><span class="token punctuation">,</span>
                <span class="token string">"status.podIPs"</span><span class="token punctuation">,</span>
                <span class="token string">"status.nominatedNodeName"</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> label<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">nil</span>
            <span class="token keyword">case</span> <span class="token string">"spec.host"</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">"spec.nodeName"</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">nil</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"field label not supported: %s"</span><span class="token punctuation">,</span> label<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>
<ul>
<li><p>defaulterFuncs：存储 Type及其对应的默认值设置函数；</p>
</li>
<li><p>converter：用来转换不同版本的结构体值；</p>
</li>
</ul>
<p>Kubernetes内部组件的流通的结构体值使用的是内部版本，所有的外部版本都要向内部版本进行转换；内部版本必须转换成外部版本才能进行输出。外部版本之间不能直接转换。从 Scheme 的定义可以看出，Scheme 也是 converter。</p>
<h4 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h4><p>Converter可以完成不同结构体之间的转换。在Kubernetes中，Converter用来把一个版本的object转换成其他版本的object，转换函数需要通过注册的方式添加到Converter中。</p>
<p><img src="/images/2020/covert.png" alt=""></p>
<p>先来看下Converter的定义，Converter定义在<a href="https://github.com/kubernetes/kubernetes/blob/775feed217bf48035cb66bb7214a6c66385c73f7/staging/src/k8s.io/apimachinery/pkg/conversion/converter.go#L50" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apimachinery/pkg/conversion/converter.go</a>中：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> Converter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Map from the conversion pair to a function which can</span>
    <span class="token comment" spellcheck="true">// do the conversion.</span>
    conversionFuncs          ConversionFuncs
    generatedConversionFuncs ConversionFuncs

    <span class="token comment" spellcheck="true">// Set of conversions that should be treated as a no-op</span>
    ignoredConversions        <span class="token keyword">map</span><span class="token punctuation">[</span>typePair<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    ignoredUntypedConversions <span class="token keyword">map</span><span class="token punctuation">[</span>typePair<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// This is a map from a source field type and name, to a list of destination</span>
    <span class="token comment" spellcheck="true">// field type and name.</span>
    structFieldDests <span class="token keyword">map</span><span class="token punctuation">[</span>typeNamePair<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>typeNamePair

    <span class="token comment" spellcheck="true">// Allows for the opposite lookup of structFieldDests. So that SourceFromDest</span>
    <span class="token comment" spellcheck="true">// copy flag also works. So this is a map of destination field name, to potential</span>
    <span class="token comment" spellcheck="true">// source field name and type to look for.</span>
    structFieldSources <span class="token keyword">map</span><span class="token punctuation">[</span>typeNamePair<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>typeNamePair

    <span class="token comment" spellcheck="true">// Map from an input type to a function which can apply a key name mapping</span>
    inputFieldMappingFuncs <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span>FieldMappingFunc

    <span class="token comment" spellcheck="true">// Map from an input type to a set of default conversion flags.</span>
    inputDefaultFlags <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span>FieldMatchingFlags

    <span class="token comment" spellcheck="true">// If non-nil, will be called to print helpful debugging info. Quite verbose.</span>
    Debug DebugLogger

    <span class="token comment" spellcheck="true">// nameFunc is called to retrieve the name of a type; this name is used for the</span>
    <span class="token comment" spellcheck="true">// purpose of deciding whether two types match or not (i.e., will we attempt to</span>
    <span class="token comment" spellcheck="true">// do a conversion). The default returns the go type name.</span>
    nameFunc <span class="token keyword">func</span><span class="token punctuation">(</span>t reflect<span class="token punctuation">.</span>Type<span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Converter结构体的字段涵义如下：</p>
<ul>
<li>conversionFuncs: 普通转换函数，通过 RegisterConversionFunc() 方法进行注册；</li>
<li>generatedConversionFuncs: 自动生成的转换函数，通过 RegisterGeneratedConversionFunc() 方法进行注册；</li>
<li>genericConversions：通用转换函数，优化级最高的转换函数，可以理解为转换的快速通道，通过AddGenericConversionFunc()方法进行注册；</li>
<li>ignoredConversions：需要忽略的转换，如果两个结构体之间不允许转换，则通过RegisterIgnoredConversion()方法进行注册；</li>
<li>structFieldDests：源结构体中字段到目标结构体中的字段的映射关系，通过SetStructFieldCopy()方法进行注册；</li>
<li>structFieldSources：与 structFieldDests 相反，是目的结构体中字段到源结构体中的字段的映射关系，通过SetStructFieldCopy() 方法进行注册；</li>
<li>defaultingFuncs：设置结构体值的默认值，通过RegisterDefaultingFunc()方法进行注册；</li>
<li>inputFieldMappingFuncs：</li>
<li>inputDefaultFlags：</li>
<li>nameFunc：获取结构体名称的函数。</li>
</ul>
<p>Converter的生成方法如下，只要传入NameFunc 即可：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewConverter</span><span class="token punctuation">(</span>nameFn NameFunc<span class="token punctuation">)</span> <span class="token operator">*</span>Converter <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token operator">&amp;</span>Converter<span class="token punctuation">{</span>
        conversionFuncs<span class="token punctuation">:</span>           <span class="token function">NewConversionFuncs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        generatedConversionFuncs<span class="token punctuation">:</span>  <span class="token function">NewConversionFuncs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ignoredConversions<span class="token punctuation">:</span>        <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>typePair<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ignoredUntypedConversions<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>typePair<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        nameFunc<span class="token punctuation">:</span>                  nameFn<span class="token punctuation">,</span>
        structFieldDests<span class="token punctuation">:</span>          <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>typeNamePair<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>typeNamePair<span class="token punctuation">)</span><span class="token punctuation">,</span>
        structFieldSources<span class="token punctuation">:</span>        <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>typeNamePair<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>typeNamePair<span class="token punctuation">)</span><span class="token punctuation">,</span>

        inputFieldMappingFuncs<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span>FieldMappingFunc<span class="token punctuation">)</span><span class="token punctuation">,</span>
        inputDefaultFlags<span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span>FieldMatchingFlags<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span><span class="token function">RegisterUntypedConversionFunc</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> s Scope<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Convert_Slice_byte_To_Slice_byte</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> c
<span class="token punctuation">}</span></code></pre>
<p>关于NameFunc，只要实现返回一个结构体的“名字”就行，如：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">var</span> DefaultNameFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t reflect<span class="token punctuation">.</span>Type<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span></code></pre>
<h5 id="ConversionFuncs"><a href="#ConversionFuncs" class="headerlink" title="ConversionFuncs"></a>ConversionFuncs</h5><p>在Converter的字段中，不管是 conversionFuncs，还是 generatedConversionFuncs，都是结构体ConversionFuncs。结构体 ConversionFuncs 用来管理转换函数</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> typePair <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    source reflect<span class="token punctuation">.</span>Type
    dest   reflect<span class="token punctuation">.</span>Type
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConversionFuncs <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    fns <span class="token keyword">map</span><span class="token punctuation">[</span>typePair<span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Value
<span class="token punctuation">}</span></code></pre>
<p>在ConversionFuncs结构体中，只有一个字段<code>fns map[typePair]reflect.Value</code>，即{source, dest}到转换函数的映射表。</p>
<h5 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h5><p>Scope是一个interface，所以我们来分析其实现者scope。</p>
<p>scope包含了递归转换中需要的一些内容。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> Scope <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Call Convert to convert sub-objects. Note that if you call it with your own exact</span>
    <span class="token comment" spellcheck="true">// parameters, you'll run out of stack space before anything useful happens.</span>
    <span class="token function">Convert</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dest <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> flags FieldMatchingFlags<span class="token punctuation">)</span> <span class="token builtin">error</span>

    <span class="token comment" spellcheck="true">// SrcTags and DestTags contain the struct tags that src and dest had, respectively.</span>
    <span class="token comment" spellcheck="true">// If the enclosing object was not a struct, then these will contain no tags, of course.</span>
    <span class="token function">SrcTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> reflect<span class="token punctuation">.</span>StructTag
    <span class="token function">DestTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> reflect<span class="token punctuation">.</span>StructTag

    <span class="token comment" spellcheck="true">// Flags returns the flags with which the conversion was started.</span>
    <span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> FieldMatchingFlags

    <span class="token comment" spellcheck="true">// Meta returns any information originally passed to Convert.</span>
    <span class="token function">Meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Meta
<span class="token punctuation">}</span></code></pre>
<p>来看scope的字段：</p>
<ul>
<li>converter：scope包含一个converter，以方便递归转换；</li>
<li>meta：元数据</li>
<li>flags：转换时字段的策略，定义如下，可以使用IsSet()方法判断对应的flag是否被设置。<br>其中：<br>DestFromSource表示循环目标结构体字段，寻找合适的源结构体字段；<br>SourceToDest表示循环源结构体字段，寻找合适的目标结构体字段；<br>IgnoreMissingFields表示如果未找到合适的目标不报错；<br>AllowDifferentFieldTypeNames表示允许源结构体和目标结构体不同的类型相匹配。</li>
</ul>
<ul>
<li>SrcTag, DestTag：字段信息</li>
</ul>
<p>convert() 的流程如下：</p>
<ol>
<li>获取源和目标的类型；</li>
<li>设置源的默认值；</li>
<li>判断是否在ignoredConversions中；</li>
<li>尝试从conversionFuncs中获取转换函数进行转换；</li>
<li>尝试从generatedConversionFuncs中获取转换函数进行转换；</li>
</ol>
<p>Converter先使用genericConversionFunc进行转换，如果不成功，再使用conversionFunc进行转换，如果不成功，再按 generatedConversionFunc 进行转换，如果不成功，最后交由DefaultConvert()转换。</p>
<p>DefaultConvert()中如果转换类型是简单类型，则直接转换；如果是结构体，则先看是否有字段关系定义，如果有，则按map定义的来，否则按同名转换原则进行转换；其他的类型也有相应的方法进行转换。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src="/images/2020/api.png" alt=""></p>
<h2 id="API-server-工作流程"><a href="#API-server-工作流程" class="headerlink" title="API server 工作流程"></a>API server 工作流程</h2><p><img src="/images/2020/api-server-arch.png" alt=""></p>
<h3 id="API-server-服务"><a href="#API-server-服务" class="headerlink" title="API server 服务"></a>API server 服务</h3><p><img src="/images/2020/api-server-serve.png" alt=""></p>
<p>整个程序的基本过程为：</p>
<ul>
<li>命令行参数解析，参数存储在ServerRunOptions</li>
<li>基于ServerRunOptions构建genericapiserver.Config</li>
<li>构建master.Config</li>
<li>构建apiextensionserver.Config，并创建API Extension Server</li>
<li>构建Master（API Server），把API Extension Server作为代理服务，这样它会融合API Extension Server的服务</li>
<li>构建Aggregator，把Master作为代理服务</li>
<li>启动http非安全服务</li>
<li>执行Aggregator的Run，启动Https安全服务</li>
</ul>
<h4 id="APIExtensionsServer"><a href="#APIExtensionsServer" class="headerlink" title="APIExtensionsServer"></a>APIExtensionsServer</h4><p><code>APIExtensionsServer</code>最先初始化，在调用链的末尾, 处理CR、CRD相关资源.</p>
<p>其中包含的 controller 以及功能如下所示：</p>
<ol>
<li>openapiController：将 crd 资源的变化同步至提供的 OpenAPI 文档，可通过访问 /openapi/v2 进行查看；</li>
<li>crdController：负责将 crd 信息注册到 apiVersions 和 apiResources 中，两者的信息可通过 <code>kubectl api-versions</code> 和  <code>kubectl api-resources</code> 查看；</li>
<li>namingController：检查 crd obj 中是否有命名冲突，可在 crd .status.conditions 中查看；</li>
<li>establishingController：检查 crd 是否处于正常状态，可在 crd .status.conditions 中查看；</li>
<li>nonStructuralSchemaController：检查 crd obj 结构是否正常，可在 crd .status.conditions 中查看；</li>
<li>apiApprovalController：检查 crd 是否遵循 kubernetes API 声明策略，可在 crd .status.conditions 中查看；</li>
<li>finalizingController：类似于 finalizes 的功能，与 CRs 的删除有关；</li>
</ol>
<h4 id="KubeAPIServer"><a href="#KubeAPIServer" class="headerlink" title="KubeAPIServer"></a>KubeAPIServer</h4><p>KubeAPIServer 主要是提供对 API Resource 的操作请求，为 kubernetes 中众多 API 注册路由信息，暴露 RESTful API 并且对外提供 kubernetes service，使集群中以及集群外的服务都可以通过 RESTful API 操作 kubernetes 中的资源。</p>
<p>与<code>APIExtensionsServer</code>，<code>KubeAPIServer</code>初始化流程如下</p>
<ol>
<li><code>CreateKubeAPIServer</code>调用<code>kubeAPIServerConfig.Complete().New</code>来初始化</li>
<li><code>New</code>函数创建默认的<code>apigroup</code>(pod,deployment等内部资源), 调用<code>InstallAPIs</code>注册</li>
<li>启动相关controller, 加入到<code>poststarthook</code></li>
</ol>
<h4 id="AggregatorServer"><a href="#AggregatorServer" class="headerlink" title="AggregatorServer"></a>AggregatorServer</h4><p><code>Aggregator</code>通过<code>APIServices</code>对象关联到某个<code>Service</code>来进行请求的转发，其关联的<code>Service</code>类型进一步决定了请求转发形式。<code>Aggregator</code>包括一个<code>GenericAPIServer</code>和维护自身状态的<code>Controller</code>。其中 <code>GenericAPIServer</code>主要处理<code>apiregistration.k8s.io</code>组下的<code>APIService</code>资源请求。</p>
<p><code>Aggregator</code>除了处理资源请求外还包含几个controller：</p>
<ol>
<li>apiserviceRegistrationController：负责<code>APIServices</code>中资源的注册与删除；</li>
<li>availableConditionController：维护<code>APIServices</code>的可用状态，包括其引用<code>Service</code>是否可用等；</li>
<li>autoRegistrationController：用于保持API中存在的一组特定的<code>APIServices</code>；</li>
<li>crdRegistrationController：负责将<code>CRD GroupVersions</code>自动注册到<code>APIServices</code>中；</li>
<li>openAPIAggregationController：将<code>APIServices</code>资源的变化同步至提供的<code>OpenAPI</code>文档；<br>kubernetes中的一些附加组件，比如metrics-server就是通过Aggregator的方式进行扩展的，实际环境中可以通过使用apiserver-builder工具轻松以Aggregator的扩展方式创建自定义资源。</li>
</ol>
<p>初始化AggregatorServer的主要逻辑为：</p>
<ol>
<li>调用<code>aggregatorConfig.Complete().NewWithDelegate</code>创建<code>aggregatorServer</code></li>
<li>初始化<code>crdRegistrationController</code>和<code>autoRegistrationController</code>，<code>crdRegistrationController</code>负责注册CRD，<code>autoRegistrationController</code>负责将 CRD 对应的 APIServices自动注册到apiserver中，CRD 创建后可通过<code>kubectl get apiservices</code>查看是否注册到 apiservices中</li>
<li>将<code>autoRegistrationController</code>和<code>crdRegistrationController</code>加入到PostStartHook中</li>
</ol>
<p>API Server 的调用链，大体如下 <code>DefaultHandlerChain-&gt;{handler/crdhandler/proxy}-&gt;admission-&gt;validation-&gt;etcd</code></p>
<ol>
<li>请求进入时，会经过<code>defaultchain</code>做一些认证鉴权工作</li>
<li>然后通过<code>route</code>执行对应的handler，如果为aggration api, 将直接转发请求到对应service</li>
<li>handler处理完，经过admission与validation，做一些修改和检查，用户在这部分可以自定义webhook</li>
<li>最后存入etcd</li>
</ol>
<h4 id="API-server-启动过程"><a href="#API-server-启动过程" class="headerlink" title="API server 启动过程"></a>API server 启动过程</h4><p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/cmd/kube-apiserver/apiserver.go" target="_blank" rel="noopener">kubernetes/cmd/kube-apiserver/apiserver.go</a></p>
<p>调用链：</p>
<pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run()-&gt;</code></pre><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewAPIServerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>
    s <span class="token operator">:=</span> options<span class="token punctuation">.</span><span class="token function">NewServerRunOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
        Use<span class="token punctuation">:</span> <span class="token string">"kube-apiserver"</span><span class="token punctuation">,</span>
        Long<span class="token punctuation">:</span> <span class="token string">`The Kubernetes API server validates and configures data
for the api objects which include pods, services, replicationcontrollers, and
others. The API Server services REST operations and provides the frontend to the
cluster's shared state through which all other components interact.`</span><span class="token punctuation">,</span>
        Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            verflag<span class="token punctuation">.</span><span class="token function">PrintAndExitIfRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            stopCh <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">Run</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    s<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> cmd
<span class="token punctuation">}</span></code></pre>
<p>APIServer的启动参数存储在ServerRunOptions中，启动参数基于命令行参数进行解析。<br> cobra框架会自动分析命令行参数，命令行参数的解析是由s.AddFlag(cmd.Flags())中预先定义好的。在AddFlags方法中。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// AddFlags adds flags for a specific APIServer to the specified FlagSet</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>ServerRunOptions<span class="token punctuation">)</span> <span class="token function">AddFlags</span><span class="token punctuation">(</span>fs <span class="token operator">*</span>pflag<span class="token punctuation">.</span>FlagSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Add the generic flags.</span>
    s<span class="token punctuation">.</span>GenericServerRunOptions<span class="token punctuation">.</span><span class="token function">AddUniversalFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>SecureServing<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>InsecureServing<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>InsecureServing<span class="token punctuation">.</span><span class="token function">AddDeprecatedFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>Audit<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>Features<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>CloudProvider<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>StorageSerialization<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>APIEnablement<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>Admission<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>

       <span class="token operator">...</span><span class="token operator">...</span>   
    fs<span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">.</span>EnableAggregatorRouting<span class="token punctuation">,</span> <span class="token string">"enable-aggregator-routing"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>EnableAggregatorRouting<span class="token punctuation">,</span>
        <span class="token string">"Turns on aggregator routing requests to endoints IP rather than cluster IP."</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span></code></pre>
<p>最终，我们会执行Command.Execute方法启动程序，它会首先解析参数，然后执行Run方法。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Run runs the specified APIServer.  This should never exit.</span>
<span class="token keyword">func</span> <span class="token function">Run</span><span class="token punctuation">(</span>completeOptions completedServerRunOptions<span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// To help debugging, immediately log version</span>
    klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Version: %+v"</span><span class="token punctuation">,</span> version<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    server<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CreateServerChain</span><span class="token punctuation">(</span>completeOptions<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    prepared<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">PrepareRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> prepared<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>构建服务器调用链</strong></p>
<p>在上面的Run方法中，CreateServerChain 负责构建服务器链，最终返回 aggregatorServer ，：API Server主要工作都在CreateServerChain中完成的。</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// CreateServerChain creates the apiservers connected via delegation.</span>
<span class="token keyword">func</span> <span class="token function">CreateServerChain</span><span class="token punctuation">(</span>completedOptions completedServerRunOptions<span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>aggregatorapiserver<span class="token punctuation">.</span>APIAggregator<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 如果指定了SSHUser参数，CreateNodeDialer用于创建连接本机节点的相关传输方法和网络建立方法</span>
    <span class="token comment" spellcheck="true">// 所以与本机是通过SSH隧道交互的。通常情况下，我们是没有设置SSHUser参数的。</span>
    nodeTunneler<span class="token punctuation">,</span> proxyTransport<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CreateNodeDialer</span><span class="token punctuation">(</span>completedOptions<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    kubeAPIServerConfig<span class="token punctuation">,</span> insecureServingInfo<span class="token punctuation">,</span> serviceResolver<span class="token punctuation">,</span> pluginInitializer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CreateKubeAPIServerConfig</span><span class="token punctuation">(</span>completedOptions<span class="token punctuation">,</span> nodeTunneler<span class="token punctuation">,</span> proxyTransport<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// If additional API servers are added, they should be gated.</span>
    apiExtensionsConfig<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createAPIExtensionsConfig</span><span class="token punctuation">(</span><span class="token operator">*</span>kubeAPIServerConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">,</span> kubeAPIServerConfig<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>VersionedInformers<span class="token punctuation">,</span> pluginInitializer<span class="token punctuation">,</span> completedOptions<span class="token punctuation">.</span>ServerRunOptions<span class="token punctuation">,</span> completedOptions<span class="token punctuation">.</span>MasterCount<span class="token punctuation">,</span>
        serviceResolver<span class="token punctuation">,</span> webhook<span class="token punctuation">.</span><span class="token function">NewDefaultAuthenticationInfoResolverWrapper</span><span class="token punctuation">(</span>proxyTransport<span class="token punctuation">,</span> kubeAPIServerConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> kubeAPIServerConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    apiExtensionsServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createAPIExtensionsServer</span><span class="token punctuation">(</span>apiExtensionsConfig<span class="token punctuation">,</span> genericapiserver<span class="token punctuation">.</span><span class="token function">NewEmptyDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    kubeAPIServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CreateKubeAPIServer</span><span class="token punctuation">(</span>kubeAPIServerConfig<span class="token punctuation">,</span> apiExtensionsServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// aggregator comes last in the chain</span>
    aggregatorConfig<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createAggregatorConfig</span><span class="token punctuation">(</span><span class="token operator">*</span>kubeAPIServerConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">,</span> completedOptions<span class="token punctuation">.</span>ServerRunOptions<span class="token punctuation">,</span> kubeAPIServerConfig<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>VersionedInformers<span class="token punctuation">,</span> serviceResolver<span class="token punctuation">,</span> proxyTransport<span class="token punctuation">,</span> pluginInitializer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    aggregatorServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createAggregatorServer</span><span class="token punctuation">(</span>aggregatorConfig<span class="token punctuation">,</span> kubeAPIServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">,</span> apiExtensionsServer<span class="token punctuation">.</span>Informers<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// we don't need special handling for innerStopCh because the aggregator server doesn't create any go routines</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> insecureServingInfo <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        insecureHandlerChain <span class="token operator">:=</span> kubeserver<span class="token punctuation">.</span><span class="token function">BuildInsecureHandlerChain</span><span class="token punctuation">(</span>aggregatorServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">UnprotectedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kubeAPIServerConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> insecureServingInfo<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>insecureHandlerChain<span class="token punctuation">,</span> kubeAPIServerConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RequestTimeout<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> aggregatorServer<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span></code></pre>
<p>CreateServerChain完成了主要的流程，里面有几个步骤比较特殊，这里分别讲解</p>
<h4 id="GenericAPIServer"><a href="#GenericAPIServer" class="headerlink" title="GenericAPIServer"></a>GenericAPIServer</h4><p>调用链：</p>
<pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run()-&gt;
server.PrepareRun()-&gt; s.GenericAPIServer.PrepareRun()</code></pre><p>GenericAPIServer可以理解为Kubernetes中提供API服务的结构体。</p>
<p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/9d3406c27b581c0961ac5871f6893f838d59b10c/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go </a></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> GenericAPIServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// discoveryAddresses is used to build cluster IPs for discovery.</span>
    discoveryAddresses discovery<span class="token punctuation">.</span>Addresses
<span class="token operator">...</span>
    <span class="token comment" spellcheck="true">// healthz checks</span>
    healthzLock            sync<span class="token punctuation">.</span>Mutex
    healthzChecks          <span class="token punctuation">[</span><span class="token punctuation">]</span>healthz<span class="token punctuation">.</span>HealthChecker
    healthzChecksInstalled <span class="token builtin">bool</span>
<span class="token operator">...</span>
    maxRequestBodyBytes <span class="token builtin">int64</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如何生成 GenericAPIServer </p>
<p>调用路径：</p>
<pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run()-&gt;
CreateServerChain()-&gt;CreateKubeAPIServer()-&gt;
kubeAPIServerConfig.Complete().New(delegateAPIServer)-&gt;
c.GenericConfig.New("kube-apiserver", delegationTarget)</code></pre><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c completedConfig<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> delegationTarget DelegationTarget<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>GenericAPIServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
    handlerChainBuilder <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
        <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">BuildHandlerChainFunc</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Config<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    apiServerHandler <span class="token operator">:=</span> <span class="token function">NewAPIServerHandler</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> handlerChainBuilder<span class="token punctuation">,</span> delegationTarget<span class="token punctuation">.</span><span class="token function">UnprotectedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    s <span class="token operator">:=</span> <span class="token operator">&amp;</span>GenericAPIServer<span class="token punctuation">{</span>
        discoveryAddresses<span class="token punctuation">:</span>         c<span class="token punctuation">.</span>DiscoveryAddresses<span class="token punctuation">,</span>
        <span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token operator">...</span>

    <span class="token comment" spellcheck="true">// 安装特殊功能的路径</span>
    <span class="token function">installAPI</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Config<span class="token punctuation">)</span>
<span class="token operator">...</span>
    <span class="token keyword">return</span> s<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h4><p>Master的本质就是一个GenericAPIServer，定义在<a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/master/master.go" target="_blank" rel="noopener">kubernetes/pkg/master/master.go</a>中：</p>
<pre class=" language-go"><code class="language-go">s<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"kube-apiserver"</span><span class="token punctuation">,</span> delegationTarget<span class="token punctuation">)</span>
<span class="token operator">...</span>
m <span class="token operator">:=</span> <span class="token operator">&amp;</span>Master<span class="token punctuation">{</span>
    GenericAPIServer<span class="token punctuation">:</span>          s<span class="token punctuation">,</span>
    ClusterAuthenticationInfo<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Master contains state for a Kubernetes cluster master/api server.</span>
<span class="token keyword">type</span> Master <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    GenericAPIServer <span class="token operator">*</span>genericapiserver<span class="token punctuation">.</span>GenericAPIServer

    ClusterAuthenticationInfo clusterauthenticationtrust<span class="token punctuation">.</span>ClusterAuthenticationInfo
<span class="token punctuation">}</span></code></pre>
<p>所以Master是对GenericAPIServer的封装。<br>Master也是从Config中来，这个 Config 定义：</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Config defines configuration for the master</span>
<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    GenericConfig <span class="token operator">*</span>genericapiserver<span class="token punctuation">.</span>Config
    ExtraConfig   ExtraConfig
<span class="token punctuation">}</span></code></pre>
<p>可以看出，Master的Config包含GenericConfig、ExtraConfig。<br>Master 的 Config 通过 Complete()。在生成Master的同时，系统会调用InstallLegacyAPI()及InstallAPIs()来安装各种API</p>
<p>kube-apiserver是如何启动Master的：</p>
<pre class=" language-go"><code class="language-go">prepared <span class="token operator">:=</span> s<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">PrepareRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
preparedAPIAggregator<span class="token punctuation">{</span>APIAggregator<span class="token punctuation">:</span> s<span class="token punctuation">,</span> runnable<span class="token punctuation">:</span> prepared<span class="token punctuation">}</span>
prepared<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s preparedAPIAggregator<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> s<span class="token punctuation">.</span>runnable<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
<h4 id="Install-API"><a href="#Install-API" class="headerlink" title="Install API"></a>Install API</h4><p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/master/master.go" target="_blank" rel="noopener">kubernetes/pkg/master/master.go</a></p>
<pre class=" language-go"><code class="language-go">    m <span class="token operator">:=</span> <span class="token operator">&amp;</span>Master<span class="token punctuation">{</span>
        GenericAPIServer<span class="token punctuation">:</span>          s<span class="token punctuation">,</span>
        ClusterAuthenticationInfo<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// install legacy rest storage</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">.</span><span class="token function">VersionEnabled</span><span class="token punctuation">(</span>apiv1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InstallLegacyAPI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> legacyRESTStorageProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token operator">...</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InstallAPIs</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> restStorageProviders<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
</code></pre>
<p>创建 Master 之后调用了InstallLegacyAPI()和InstallAPIs()安装API。</p>
<h4 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h4><p>Authentication 负责对 Kubernetes 中的请求进行认证，只有通过认证的请求才会被执行。在 Kubernetes 中，有BasicAuth, Keystone, X509, Token, ServiceAccount, OIDCIssuer, WebhookToken, AnyToken等认证器。我们来看下 Kubernetes 是如何管理认证器的，及如何对请求进行认证。</p>
<p>调用链：</p>
<pre class=" language-go"><code class="language-go"><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> app<span class="token punctuation">.</span><span class="token function">NewAPIServerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">CreateServerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">CreateKubeAPIServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">buildGenericConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">BuildAuthenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> authenticatorConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/1871f75b32f5d96c62ce6aa8c2d393124b7002aa/cmd/kube-apiserver/app/server.go#L501" target="_blank" rel="noopener">kubernetes/cmd/kube-apiserver/app/server.go</a></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// BuildAuthenticator constructs the authenticator</span>
<span class="token keyword">func</span> <span class="token function">BuildAuthenticator</span><span class="token punctuation">(</span>s <span class="token operator">*</span>options<span class="token punctuation">.</span>ServerRunOptions<span class="token punctuation">,</span> extclient clientgoclientset<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> versionedInformer clientgoinformers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">)</span> <span class="token punctuation">(</span>authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> <span class="token operator">*</span>spec<span class="token punctuation">.</span>SecurityDefinitions<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    authenticatorConfig <span class="token operator">:=</span> s<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span><span class="token function">ToAuthenticationConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>ServiceAccounts<span class="token punctuation">.</span>Lookup <span class="token operator">||</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>TokenRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        authenticatorConfig<span class="token punctuation">.</span>ServiceAccountTokenGetter <span class="token operator">=</span> serviceaccountcontroller<span class="token punctuation">.</span><span class="token function">NewGetterFromClient</span><span class="token punctuation">(</span>
            extclient<span class="token punctuation">,</span>
            versionedInformer<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            versionedInformer<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ServiceAccounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            versionedInformer<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    authenticatorConfig<span class="token punctuation">.</span>BootstrapTokenAuthenticator <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">NewTokenAuthenticator</span><span class="token punctuation">(</span>
        versionedInformer<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>NamespaceSystem<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">return</span> authenticatorConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>所以，接下来看authenticator.New()，定义在<code>kubernetes/pkg/kubeapiserver/authenticator/config.go</code>中：</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// New returns an authenticator.Request or an error that supports the standard</span>
<span class="token comment" spellcheck="true">// Kubernetes authentication mechanisms.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>config Config<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> <span class="token operator">*</span>spec<span class="token punctuation">.</span>SecurityDefinitions<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> authenticators <span class="token punctuation">[</span><span class="token punctuation">]</span>authenticator<span class="token punctuation">.</span>Request
    <span class="token keyword">var</span> tokenAuthenticators <span class="token punctuation">[</span><span class="token punctuation">]</span>authenticator<span class="token punctuation">.</span>Token
    securityDefinitions <span class="token operator">:=</span> spec<span class="token punctuation">.</span>SecurityDefinitions<span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// front-proxy, BasicAuth methods, local first, then remote</span>
    <span class="token comment" spellcheck="true">// Add the front proxy authenticator if requested</span>
    <span class="token keyword">if</span> config<span class="token punctuation">.</span>RequestHeaderConfig <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        requestHeaderAuthenticator <span class="token operator">:=</span> headerrequest<span class="token punctuation">.</span><span class="token function">NewDynamicVerifyOptionsSecure</span><span class="token punctuation">(</span>
            config<span class="token punctuation">.</span>RequestHeaderConfig<span class="token punctuation">.</span>CAContentProvider<span class="token punctuation">.</span>VerifyOptions<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>RequestHeaderConfig<span class="token punctuation">.</span>AllowedClientNames<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>RequestHeaderConfig<span class="token punctuation">.</span>UsernameHeaders<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>RequestHeaderConfig<span class="token punctuation">.</span>GroupHeaders<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>RequestHeaderConfig<span class="token punctuation">.</span>ExtraHeaderPrefixes<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        authenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authenticators<span class="token punctuation">,</span> authenticator<span class="token punctuation">.</span><span class="token function">WrapAudienceAgnosticRequest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> requestHeaderAuthenticator<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// basic auth</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BasicAuthFile<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        basicAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newAuthenticatorFromBasicAuthFile</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BasicAuthFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        authenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authenticators<span class="token punctuation">,</span> authenticator<span class="token punctuation">.</span><span class="token function">WrapAudienceAgnosticRequest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> basicAuth<span class="token punctuation">)</span><span class="token punctuation">)</span>

        securityDefinitions<span class="token punctuation">[</span><span class="token string">"HTTPBasic"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>spec<span class="token punctuation">.</span>SecurityScheme<span class="token punctuation">{</span>
            SecuritySchemeProps<span class="token punctuation">:</span> spec<span class="token punctuation">.</span>SecuritySchemeProps<span class="token punctuation">{</span>
                Type<span class="token punctuation">:</span>        <span class="token string">"basic"</span><span class="token punctuation">,</span>
                Description<span class="token punctuation">:</span> <span class="token string">"HTTP Basic authentication"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// X509 methods</span>
    <span class="token keyword">if</span> config<span class="token punctuation">.</span>ClientCAContentProvider <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        certAuth <span class="token operator">:=</span> x509<span class="token punctuation">.</span><span class="token function">NewDynamic</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ClientCAContentProvider<span class="token punctuation">.</span>VerifyOptions<span class="token punctuation">,</span> x509<span class="token punctuation">.</span>CommonNameUserConversion<span class="token punctuation">)</span>
        authenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authenticators<span class="token punctuation">,</span> certAuth<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Bearer token methods, local first, then remote</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>TokenAuthFile<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        tokenAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newAuthenticatorFromTokenFile</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>TokenAuthFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        tokenAuthenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">,</span> authenticator<span class="token punctuation">.</span><span class="token function">WrapAudienceAgnosticToken</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> tokenAuth<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ServiceAccountKeyFiles<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        serviceAccountAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newLegacyServiceAccountAuthenticator</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ServiceAccountKeyFiles<span class="token punctuation">,</span> config<span class="token punctuation">.</span>ServiceAccountLookup<span class="token punctuation">,</span> config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> config<span class="token punctuation">.</span>ServiceAccountTokenGetter<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        tokenAuthenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">,</span> serviceAccountAuth<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>TokenRequest<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>ServiceAccountIssuer <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        serviceAccountAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newServiceAccountAuthenticator</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ServiceAccountIssuer<span class="token punctuation">,</span> config<span class="token punctuation">.</span>ServiceAccountKeyFiles<span class="token punctuation">,</span> config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> config<span class="token punctuation">.</span>ServiceAccountTokenGetter<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        tokenAuthenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">,</span> serviceAccountAuth<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> config<span class="token punctuation">.</span>BootstrapToken <span class="token punctuation">{</span>
        <span class="token keyword">if</span> config<span class="token punctuation">.</span>BootstrapTokenAuthenticator <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// TODO: This can sometimes be nil because of</span>
            tokenAuthenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">,</span> authenticator<span class="token punctuation">.</span><span class="token function">WrapAudienceAgnosticToken</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> config<span class="token punctuation">.</span>BootstrapTokenAuthenticator<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// NOTE(ericchiang): Keep the OpenID Connect after Service Accounts.</span>
    <span class="token comment" spellcheck="true">//</span>
    <span class="token comment" spellcheck="true">// Because both plugins verify JWTs whichever comes first in the union experiences</span>
    <span class="token comment" spellcheck="true">// cache misses for all requests using the other. While the service account plugin</span>
    <span class="token comment" spellcheck="true">// simply returns an error, the OpenID Connect plugin may query the provider to</span>
    <span class="token comment" spellcheck="true">// update the keys, causing performance hits.</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>OIDCIssuerURL<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>OIDCClientID<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        oidcAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newAuthenticatorFromOIDCIssuerURL</span><span class="token punctuation">(</span>oidc<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
            IssuerURL<span class="token punctuation">:</span>            config<span class="token punctuation">.</span>OIDCIssuerURL<span class="token punctuation">,</span>
            ClientID<span class="token punctuation">:</span>             config<span class="token punctuation">.</span>OIDCClientID<span class="token punctuation">,</span>
            CAFile<span class="token punctuation">:</span>               config<span class="token punctuation">.</span>OIDCCAFile<span class="token punctuation">,</span>
            UsernameClaim<span class="token punctuation">:</span>        config<span class="token punctuation">.</span>OIDCUsernameClaim<span class="token punctuation">,</span>
            UsernamePrefix<span class="token punctuation">:</span>       config<span class="token punctuation">.</span>OIDCUsernamePrefix<span class="token punctuation">,</span>
            GroupsClaim<span class="token punctuation">:</span>          config<span class="token punctuation">.</span>OIDCGroupsClaim<span class="token punctuation">,</span>
            GroupsPrefix<span class="token punctuation">:</span>         config<span class="token punctuation">.</span>OIDCGroupsPrefix<span class="token punctuation">,</span>
            SupportedSigningAlgs<span class="token punctuation">:</span> config<span class="token punctuation">.</span>OIDCSigningAlgs<span class="token punctuation">,</span>
            RequiredClaims<span class="token punctuation">:</span>       config<span class="token punctuation">.</span>OIDCRequiredClaims<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        tokenAuthenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">,</span> authenticator<span class="token punctuation">.</span><span class="token function">WrapAudienceAgnosticToken</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> oidcAuth<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>WebhookTokenAuthnConfigFile<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        webhookTokenAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newWebhookTokenAuthenticator</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>

        tokenAuthenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">,</span> webhookTokenAuth<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Union the token authenticators</span>
        tokenAuth <span class="token operator">:=</span> tokenunion<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// Optionally cache authentication results</span>
        <span class="token keyword">if</span> config<span class="token punctuation">.</span>TokenSuccessCacheTTL <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> config<span class="token punctuation">.</span>TokenFailureCacheTTL <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            tokenAuth <span class="token operator">=</span> tokencache<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>tokenAuth<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>TokenSuccessCacheTTL<span class="token punctuation">,</span> config<span class="token punctuation">.</span>TokenFailureCacheTTL<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        authenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authenticators<span class="token punctuation">,</span> bearertoken<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>tokenAuth<span class="token punctuation">)</span><span class="token punctuation">,</span> websocket<span class="token punctuation">.</span><span class="token function">NewProtocolAuthenticator</span><span class="token punctuation">(</span>tokenAuth<span class="token punctuation">)</span><span class="token punctuation">)</span>
        securityDefinitions<span class="token punctuation">[</span><span class="token string">"BearerToken"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>spec<span class="token punctuation">.</span>SecurityScheme<span class="token punctuation">{</span>
            SecuritySchemeProps<span class="token punctuation">:</span> spec<span class="token punctuation">.</span>SecuritySchemeProps<span class="token punctuation">{</span>
                Type<span class="token punctuation">:</span>        <span class="token string">"apiKey"</span><span class="token punctuation">,</span>
                Name<span class="token punctuation">:</span>        <span class="token string">"authorization"</span><span class="token punctuation">,</span>
                In<span class="token punctuation">:</span>          <span class="token string">"header"</span><span class="token punctuation">,</span>
                Description<span class="token punctuation">:</span> <span class="token string">"Bearer Token authentication"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>authenticators<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> config<span class="token punctuation">.</span>Anonymous <span class="token punctuation">{</span>
            <span class="token keyword">return</span> anonymous<span class="token punctuation">.</span><span class="token function">NewAuthenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>securityDefinitions<span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>securityDefinitions<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    authenticator <span class="token operator">:=</span> union<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>authenticators<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// GroupAdder定义在 /pkg/authentication/group/group_adder.go</span>
    <span class="token comment" spellcheck="true">// antenticator调用的是 GroupAdder的 AuthenticateRequest()</span>
    authenticator <span class="token operator">=</span> group<span class="token punctuation">.</span><span class="token function">NewAuthenticatedGroupAdder</span><span class="token punctuation">(</span>authenticator<span class="token punctuation">)</span>

    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Anonymous <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// If the authenticator chain returns an error, return an error (don't consider a bad bearer token</span>
        <span class="token comment" spellcheck="true">// or invalid username/password combination anonymous).</span>
        authenticator <span class="token operator">=</span> union<span class="token punctuation">.</span><span class="token function">NewFailOnError</span><span class="token punctuation">(</span>authenticator<span class="token punctuation">,</span> anonymous<span class="token punctuation">.</span><span class="token function">NewAuthenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> authenticator<span class="token punctuation">,</span> <span class="token operator">&amp;</span>securityDefinitions<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>New()</code>会根据 kube-apiserver 的参数来生成各个认证器，并把认证器放在 <code>authenticators</code> 变量中。比如，如果指定了<code>–experimental-keystone-url</code>，则就会生成<code>keystoneAuthenticator</code>。这里要强调的是<code>unionAuthenticator</code>可以封装多个认证器。</p>
<p>这里还要涉及到一个概念，<code>GroupAdder</code>，封装了<code>authenticator</code>，定义在<a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/authentication/group/authenticated_group_adder.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apiserver/pkg/authentication/group/authenticated_group_adder.go</a>中：</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// AuthenticatedGroupAdder adds system:authenticated group when appropriate</span>
<span class="token keyword">type</span> AuthenticatedGroupAdder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Authenticator is delegated to make the authentication decision</span>
    Authenticator authenticator<span class="token punctuation">.</span>Request
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// NewAuthenticatedGroupAdder wraps a request authenticator, and adds the system:authenticated group when appropriate.</span>
<span class="token comment" spellcheck="true">// Authentication must succeed, the user must not be system:anonymous, the groups system:authenticated or system:unauthenticated must</span>
<span class="token comment" spellcheck="true">// not be present</span>
<span class="token keyword">func</span> <span class="token function">NewAuthenticatedGroupAdder</span><span class="token punctuation">(</span>auth authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> authenticator<span class="token punctuation">.</span>Request <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>AuthenticatedGroupAdder<span class="token punctuation">{</span>auth<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>所以，kube-apiserver的认证器是 AuthenticatedGroupAdder，AuthenticatedGroupAdder定义有认证的入口：</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 实现AuthenticateRequest()</span>
<span class="token comment" spellcheck="true">// 返回user.DefaultInfo</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>AuthenticatedGroupAdder<span class="token punctuation">)</span> <span class="token function">AuthenticateRequest</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>authenticator<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    r<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span>Authenticator<span class="token punctuation">.</span><span class="token function">AuthenticateRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> r<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> user<span class="token punctuation">.</span>Anonymous <span class="token punctuation">{</span>
        <span class="token keyword">return</span> r<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> group <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> group <span class="token operator">==</span> user<span class="token punctuation">.</span>AllAuthenticated <span class="token operator">||</span> group <span class="token operator">==</span> user<span class="token punctuation">.</span>AllUnauthenticated <span class="token punctuation">{</span>
            <span class="token keyword">return</span> r<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    r<span class="token punctuation">.</span>User <span class="token operator">=</span> <span class="token operator">&amp;</span>user<span class="token punctuation">.</span>DefaultInfo<span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span>   r<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        UID<span class="token punctuation">:</span>    r<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Groups<span class="token punctuation">:</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>AllAuthenticated<span class="token punctuation">)</span><span class="token punctuation">,</span>
        Extra<span class="token punctuation">:</span>  r<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetExtra</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> r<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>AuthenticatedGroupAdder 的 <code>AuthenticateRequest()</code> 会调用 unionAuthenticator 的<code>AuthenticateRequest()</code>对请求进行认证，得到 user 信息之后返回。</p>
<p>关于 Group，定义在<code>kubernetes/staging/src/k8s.io/apiserver/pkg/authentication/user/user.go</code>中，<code>authenticator.New()</code>传入的是AllAuthenticated。</p>
<p>我们分析一个基本认证</p>
<pre class=" language-go"><code class="language-go">    <span class="token comment" spellcheck="true">// basic auth</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BasicAuthFile<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        basicAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newAuthenticatorFromBasicAuthFile</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BasicAuthFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        authenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authenticators<span class="token punctuation">,</span> authenticator<span class="token punctuation">.</span><span class="token function">WrapAudienceAgnosticRequest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> basicAuth<span class="token punctuation">)</span><span class="token punctuation">)</span>

        securityDefinitions<span class="token punctuation">[</span><span class="token string">"HTTPBasic"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>spec<span class="token punctuation">.</span>SecurityScheme<span class="token punctuation">{</span>
            SecuritySchemeProps<span class="token punctuation">:</span> spec<span class="token punctuation">.</span>SecuritySchemeProps<span class="token punctuation">{</span>
                Type<span class="token punctuation">:</span>        <span class="token string">"basic"</span><span class="token punctuation">,</span>
                Description<span class="token punctuation">:</span> <span class="token string">"HTTP Basic authentication"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true">// newAuthenticatorFromBasicAuthFile returns an authenticator.Request or an error</span>
<span class="token keyword">func</span> <span class="token function">newAuthenticatorFromBasicAuthFile</span><span class="token punctuation">(</span>basicAuthFile <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    basicAuthenticator<span class="token punctuation">,</span> err <span class="token operator">:=</span> passwordfile<span class="token punctuation">.</span><span class="token function">NewCSV</span><span class="token punctuation">(</span>basicAuthFile<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> basicauth<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>basicAuthenticator<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token operator">...</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Authenticator<span class="token punctuation">)</span> <span class="token function">AuthenticateRequest</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>authenticator<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> found <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">BasicAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">AuthenticatePassword</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// If the password authenticator didn't error, provide a default error</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">&amp;&amp;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> errInvalidAuth
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre>
<p>该方法会从请求中获取用户名和密码，然后调用所封装的认证器的AuthenticatePassword()方法进行认证。</p>
<p><strong>unionAuthenticator</strong></p>
<p>unionAuthenticator定义在<a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/authentication/request/union/union.go" target="_blank" rel="noopener">/kubernetes/staging/src/k8s.io/apiserver/pkg/authentication/request/union/union.go</a>:</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// unionAuthRequestHandler authenticates requests using a chain of authenticator.Requests</span>
<span class="token keyword">type</span> unionAuthRequestHandler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Handlers is a chain of request authenticators to delegate to</span>
    Handlers <span class="token punctuation">[</span><span class="token punctuation">]</span>authenticator<span class="token punctuation">.</span>Request
    <span class="token comment" spellcheck="true">// FailOnError determines whether an error returns short-circuits the chain</span>
    FailOnError <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// New returns a request authenticator that validates credentials using a chain of authenticator.Request objects.</span>
<span class="token comment" spellcheck="true">// The entire chain is tried until one succeeds. If all fail, an aggregate error is returned.</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>authRequestHandlers <span class="token operator">...</span>authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> authenticator<span class="token punctuation">.</span>Request <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>authRequestHandlers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authRequestHandlers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>unionAuthRequestHandler<span class="token punctuation">{</span>Handlers<span class="token punctuation">:</span> authRequestHandlers<span class="token punctuation">,</span> FailOnError<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>unionAuthenticator 的 <code>AuthenticateRequest()</code> 方法定义如下：</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// 逐个调用 authRequestHandler，如果有一个成功，则返回</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>authHandler <span class="token operator">*</span>unionAuthRequestHandler<span class="token punctuation">)</span> <span class="token function">AuthenticateRequest</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>authenticator<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> errlist <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> currAuthRequestHandler <span class="token operator">:=</span> <span class="token keyword">range</span> authHandler<span class="token punctuation">.</span>Handlers <span class="token punctuation">{</span>
        resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> currAuthRequestHandler<span class="token punctuation">.</span><span class="token function">AuthenticateRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> authHandler<span class="token punctuation">.</span>FailOnError <span class="token punctuation">{</span>
                <span class="token keyword">return</span> resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            errlist <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errlist<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errlist<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>AuthenticateRequest()</code>会轮询每一个 authenticator，如果有一个 authenticator 认证成功，则直接返回认证成功。</p>
<p><strong>对请求进行认证</strong></p>
<p>调用链：</p>
<pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run() -&gt; CreateServerChain() -&gt; CreateKubeAPIServerConfig() -&gt; buildGenericConfig() -&gt; genericapiserver.NewConfig(legacyscheme.Codecs)-&gt; DefaultBuildHandlerChain()</code></pre><p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/323f34858de18b862d43c40b2cced65ad8e24052/staging/src/k8s.io/apiserver/pkg/server/config.go" target="_blank" rel="noopener">staging/src/k8s.io/apiserver/pkg/server/config.go</a></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">DefaultBuildHandlerChain</span><span class="token punctuation">(</span>apiHandler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> c <span class="token operator">*</span>Config<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
    handler <span class="token operator">:=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAuthorization</span><span class="token punctuation">(</span>apiHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>FlowControl <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithPriorityAndFairness</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>FlowControl<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithMaxInFlightLimit</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>MaxRequestsInFlight<span class="token punctuation">,</span> c<span class="token punctuation">.</span>MaxMutatingRequestsInFlight<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithImpersonation</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span>
    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAudit</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditBackend<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditPolicyChecker<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">)</span>
    failedHandler <span class="token operator">:=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">Unauthorized</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>SupportsBasicAuth<span class="token punctuation">)</span>
    failedHandler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithFailedAuthenticationAudit</span><span class="token punctuation">(</span>failedHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditBackend<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditPolicyChecker<span class="token punctuation">)</span>
    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAuthentication</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>Authenticator<span class="token punctuation">,</span> failedHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">)</span>
    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithCORS</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>CorsAllowedOriginList<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>
    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithTimeoutForNonLongRunningRequests</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RequestTimeout<span class="token punctuation">)</span>
    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithWaitGroup</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>HandlerChainWaitGroup<span class="token punctuation">)</span>
    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithRequestInfo</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RequestInfoResolver<span class="token punctuation">)</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>SecureServing <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>SecureServing<span class="token punctuation">.</span>DisableHTTP2 <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>GoawayChance <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithProbabilisticGoaway</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GoawayChance<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithPanicRecovery</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
    <span class="token keyword">return</span> handler
<span class="token punctuation">}</span></code></pre>
<p>我们注意到 <code>handler = genericapifilters.WithAuthentication(handler, c.Authentication.Authenticator, failedHandler, c.Authentication.APIAudiences)</code></p>
<p>代码路径：<a href="https://github.com/kubernetes/kubernetes/blob/323f34858de18b862d43c40b2cced65ad8e24052/staging/src/k8s.io/apiserver/pkg/endpoints/filters/authentication.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apiserver/pkg/endpoints/filters/authentication.go</a></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">WithAuthentication</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> auth authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> failed http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> apiAuds authenticator<span class="token punctuation">.</span>Audiences<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
    <span class="token keyword">if</span> auth <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"Authentication is disabled"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> handler
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        authenticationStart <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>apiAuds<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            req <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>authenticator<span class="token punctuation">.</span><span class="token function">WithAudiences</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> apiAuds<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//  handler中的认证</span>
        resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> auth<span class="token punctuation">.</span><span class="token function">AuthenticateRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
        <span class="token keyword">defer</span> <span class="token function">recordAuthMetrics</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err<span class="token punctuation">,</span> apiAuds<span class="token punctuation">,</span> authenticationStart<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Unable to authenticate the request due to an error: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            failed<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">audiencesAreAcceptable</span><span class="token punctuation">(</span>apiAuds<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Audiences<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unable to match the audience: %v , accepted: %v"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Audiences<span class="token punctuation">,</span> apiAuds<span class="token punctuation">)</span>
            klog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            failed<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// authorization header is not required anymore in case of a successful authentication.</span>
        req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span>

        req <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>genericapirequest<span class="token punctuation">.</span><span class="token function">WithUser</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
        handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>其中，http.HandlerFunc 本身就是一个handler。所以<code>WithAuthentication()</code>先调用<code>auth.AuthenticateRequest()</code>对请求进行验证，然后调用前handler的<code>ServeHTTP()</code>对请求接着作处理，以达到在处理前进行认证的目的。</p>
<h4 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h4><p>Authorization 负责 Kubernetes 中对请求进行授权，只有通过授权的请求才会被执行。在Kubernetes中，主要有ABAC(Attributes Based Access Control)，RBAC(Role Based Access Contro)，AlwaysAllow，AlwaysDeny和Webhook(调用网络接口进行授权)这几种授权器。我们来看下 Kubernetes 是如何管理授权器的，及如何对请求进行授权。</p>
<p>调用链：</p>
<pre class=" language-go"><code class="language-go"><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> app<span class="token punctuation">.</span><span class="token function">NewAPIServerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">CreateServerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">CreateKubeAPIServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">buildGenericConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">BuildAuthorizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> authorizationConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/323f34858de18b862d43c40b2cced65ad8e24052/pkg/kubeapiserver/authorizer/config.go" target="_blank" rel="noopener">kubernetes/pkg/kubeapiserver/authorizer/config.go </a></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// New returns the right sort of union of multiple authorizer.Authorizer objects</span>
<span class="token comment" spellcheck="true">// based on the authorizationMode or an error.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>config Config<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>authorizer<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> authorizer<span class="token punctuation">.</span>RuleResolver<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>AuthorizationModes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"at least one authorization mode must be passed"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> <span class="token punctuation">(</span>
        authorizers   <span class="token punctuation">[</span><span class="token punctuation">]</span>authorizer<span class="token punctuation">.</span>Authorizer
        ruleResolvers <span class="token punctuation">[</span><span class="token punctuation">]</span>authorizer<span class="token punctuation">.</span>RuleResolver
    <span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> authorizationMode <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>AuthorizationModes <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Keep cases in sync with constant list in k8s.io/kubernetes/pkg/kubeapiserver/authorizer/modes/modes.go.</span>
        <span class="token keyword">switch</span> authorizationMode <span class="token punctuation">{</span>
        <span class="token keyword">case</span> modes<span class="token punctuation">.</span>ModeNode<span class="token punctuation">:</span>
            graph <span class="token operator">:=</span> node<span class="token punctuation">.</span><span class="token function">NewGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            node<span class="token punctuation">.</span><span class="token function">AddGraphEventHandlers</span><span class="token punctuation">(</span>
                graph<span class="token punctuation">,</span>
                config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PersistentVolumes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">VolumeAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            nodeAuthorizer <span class="token operator">:=</span> node<span class="token punctuation">.</span><span class="token function">NewAuthorizer</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> nodeidentifier<span class="token punctuation">.</span><span class="token function">NewDefaultNodeIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bootstrappolicy<span class="token punctuation">.</span><span class="token function">NodeRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            authorizers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authorizers<span class="token punctuation">,</span> nodeAuthorizer<span class="token punctuation">)</span>

        <span class="token keyword">case</span> modes<span class="token punctuation">.</span>ModeAlwaysAllow<span class="token punctuation">:</span>
            alwaysAllowAuthorizer <span class="token operator">:=</span> authorizerfactory<span class="token punctuation">.</span><span class="token function">NewAlwaysAllowAuthorizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            authorizers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authorizers<span class="token punctuation">,</span> alwaysAllowAuthorizer<span class="token punctuation">)</span>
            ruleResolvers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ruleResolvers<span class="token punctuation">,</span> alwaysAllowAuthorizer<span class="token punctuation">)</span>
        <span class="token keyword">case</span> modes<span class="token punctuation">.</span>ModeAlwaysDeny<span class="token punctuation">:</span>
            alwaysDenyAuthorizer <span class="token operator">:=</span> authorizerfactory<span class="token punctuation">.</span><span class="token function">NewAlwaysDenyAuthorizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            authorizers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authorizers<span class="token punctuation">,</span> alwaysDenyAuthorizer<span class="token punctuation">)</span>
            ruleResolvers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ruleResolvers<span class="token punctuation">,</span> alwaysDenyAuthorizer<span class="token punctuation">)</span>
        <span class="token keyword">case</span> modes<span class="token punctuation">.</span>ModeABAC<span class="token punctuation">:</span>
            abacAuthorizer<span class="token punctuation">,</span> err <span class="token operator">:=</span> abac<span class="token punctuation">.</span><span class="token function">NewFromFile</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>PolicyFile<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            authorizers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authorizers<span class="token punctuation">,</span> abacAuthorizer<span class="token punctuation">)</span>
            ruleResolvers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ruleResolvers<span class="token punctuation">,</span> abacAuthorizer<span class="token punctuation">)</span>
        <span class="token keyword">case</span> modes<span class="token punctuation">.</span>ModeWebhook<span class="token punctuation">:</span>
            webhookAuthorizer<span class="token punctuation">,</span> err <span class="token operator">:=</span> webhook<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>WebhookConfigFile<span class="token punctuation">,</span>
                config<span class="token punctuation">.</span>WebhookVersion<span class="token punctuation">,</span>
                config<span class="token punctuation">.</span>WebhookCacheAuthorizedTTL<span class="token punctuation">,</span>
                config<span class="token punctuation">.</span>WebhookCacheUnauthorizedTTL<span class="token punctuation">,</span>
                config<span class="token punctuation">.</span>CustomDial<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            authorizers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authorizers<span class="token punctuation">,</span> webhookAuthorizer<span class="token punctuation">)</span>
            ruleResolvers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ruleResolvers<span class="token punctuation">,</span> webhookAuthorizer<span class="token punctuation">)</span>
        <span class="token keyword">case</span> modes<span class="token punctuation">.</span>ModeRBAC<span class="token punctuation">:</span>
            rbacAuthorizer <span class="token operator">:=</span> rbac<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
                <span class="token operator">&amp;</span>rbac<span class="token punctuation">.</span>RoleGetter<span class="token punctuation">{</span>Lister<span class="token punctuation">:</span> config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Rbac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Roles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>rbac<span class="token punctuation">.</span>RoleBindingLister<span class="token punctuation">{</span>Lister<span class="token punctuation">:</span> config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Rbac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RoleBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>rbac<span class="token punctuation">.</span>ClusterRoleGetter<span class="token punctuation">{</span>Lister<span class="token punctuation">:</span> config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Rbac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ClusterRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>rbac<span class="token punctuation">.</span>ClusterRoleBindingLister<span class="token punctuation">{</span>Lister<span class="token punctuation">:</span> config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Rbac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ClusterRoleBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            authorizers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authorizers<span class="token punctuation">,</span> rbacAuthorizer<span class="token punctuation">)</span>
            ruleResolvers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ruleResolvers<span class="token punctuation">,</span> rbacAuthorizer<span class="token punctuation">)</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unknown authorization mode %s specified"</span><span class="token punctuation">,</span> authorizationMode<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> union<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>authorizers<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> union<span class="token punctuation">.</span><span class="token function">NewRuleResolvers</span><span class="token punctuation">(</span>ruleResolvers<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在 kube-apiserver 的参数中，有<code>–authorization-mode</code>参数，授权器就是根据<code>–authorization-mode</code>参数中指定的内容来生成的。</p>
<p>New() 会依据 authorizationModes 生成相应的 authorizer，并把多个 authorizers 打包成 unionAuthorizer 返回。最后 server.go 中生成的 apiAuthorizer 会赋值给 genericConfig.Authorizer 以生成 master。</p>
<p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/ca324214be0c3823b309a145b876bbb79ccd742a/cmd/kube-apiserver/app/server.go" target="_blank" rel="noopener">kubernetes/cmd/kube-apiserver/app/server.go</a></p>
<pre class=" language-go"><code class="language-go">genericConfig<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>RuleResolver<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">BuildAuthorizer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span></code></pre>
<p><strong>unionAuthorizer</strong></p>
<p>代码路径：<a href="https://github.com/kubernetes/kubernetes/blob/327f53ba57aeaa4b7e7c20b1ef98c42b26b7ea7f/staging/src/k8s.io/apiserver/pkg/authorization/union/union.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apiserver/pkg/authorization/union/union.go</a></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// unionAuthzHandler authorizer against a chain of authorizer.Authorizer</span>
<span class="token keyword">type</span> unionAuthzHandler <span class="token punctuation">[</span><span class="token punctuation">]</span>authorizer<span class="token punctuation">.</span>Authorizer

<span class="token comment" spellcheck="true">// New returns an authorizer that authorizes against a chain of authorizer.Authorizer objects</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>authorizationHandlers <span class="token operator">...</span>authorizer<span class="token punctuation">.</span>Authorizer<span class="token punctuation">)</span> authorizer<span class="token punctuation">.</span>Authorizer <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">unionAuthzHandler</span><span class="token punctuation">(</span>authorizationHandlers<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Authorizes against a chain of authorizer.Authorizer objects and returns nil if successful and returns error if unsuccessful</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>authzHandler unionAuthzHandler<span class="token punctuation">)</span> <span class="token function">Authorize</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> a authorizer<span class="token punctuation">.</span>Attributes<span class="token punctuation">)</span> <span class="token punctuation">(</span>authorizer<span class="token punctuation">.</span>Decision<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token punctuation">(</span>
        errlist    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span>
        reasonlist <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> currAuthzHandler <span class="token operator">:=</span> <span class="token keyword">range</span> authzHandler <span class="token punctuation">{</span>
        decision<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> err <span class="token operator">:=</span> currAuthzHandler<span class="token punctuation">.</span><span class="token function">Authorize</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> a<span class="token punctuation">)</span>

        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            errlist <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errlist<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            reasonlist <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>reasonlist<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> decision <span class="token punctuation">{</span>
        <span class="token keyword">case</span> authorizer<span class="token punctuation">.</span>DecisionAllow<span class="token punctuation">,</span> authorizer<span class="token punctuation">.</span>DecisionDeny<span class="token punctuation">:</span>
            <span class="token keyword">return</span> decision<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> err
        <span class="token keyword">case</span> authorizer<span class="token punctuation">.</span>DecisionNoOpinion<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true">// continue to the next authorizer</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> authorizer<span class="token punctuation">.</span>DecisionNoOpinion<span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>reasonlist<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errlist<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
<p>unionAuthorizer 本身是一个 Authorizer 列表，其Authorize() 方法会调用列表中每一个 Authorizer 的Authorize() 方法，一旦有一个 Authorizer 授权通过，则 unionAuthorizer 的授权通过。</p>
<h5 id="ABAC授权器"><a href="#ABAC授权器" class="headerlink" title="ABAC授权器"></a><strong>ABAC授权器</strong></h5><p>ABAC是基于属性的访问控制，目前ABAC支持apiVersion, kind, spec, namespace, resource等属性。ABAC规则需要保存在文件中：</p>
<pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"group"</span><span class="token operator">:</span><span class="token string">"system:authenticated"</span><span class="token punctuation">,</span>  <span class="token property">"nonResourcePath"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"group"</span><span class="token operator">:</span><span class="token string">"system:unauthenticated"</span><span class="token punctuation">,</span> <span class="token property">"nonResourcePath"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"admin"</span><span class="token punctuation">,</span>     <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>         <span class="token property">"apiGroup"</span><span class="token operator">:</span> <span class="token string">"*"</span>                   <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"scheduler"</span><span class="token punctuation">,</span> <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"pods"</span><span class="token punctuation">,</span>                       <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"scheduler"</span><span class="token punctuation">,</span> <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"bindings"</span>                                     <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"kubelet"</span><span class="token punctuation">,</span>   <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"pods"</span><span class="token punctuation">,</span>                       <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"kubelet"</span><span class="token punctuation">,</span>   <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"services"</span><span class="token punctuation">,</span>                   <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"kubelet"</span><span class="token punctuation">,</span>   <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"endpoints"</span><span class="token punctuation">,</span>                  <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"kubelet"</span><span class="token punctuation">,</span>   <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"events"</span>                                       <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"alice"</span><span class="token punctuation">,</span>     <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"projectCaribou"</span><span class="token punctuation">,</span> <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>         <span class="token property">"apiGroup"</span><span class="token operator">:</span> <span class="token string">"*"</span>                   <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"bob"</span><span class="token punctuation">,</span>       <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"projectCaribou"</span><span class="token punctuation">,</span> <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>         <span class="token property">"apiGroup"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>
<p>ABAC授权器定义在<code>kubernetes/pkg/auth/authorizer/abac/abac.go</code>中：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> PolicyList <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>abac<span class="token punctuation">.</span>Policy

<span class="token comment" spellcheck="true">// 从policy文件构建plicylist</span>
<span class="token keyword">func</span> <span class="token function">NewFromFile</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>PolicyList<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    scanner <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewScanner</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    pl <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>PolicyList<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    decoder <span class="token operator">:=</span> abac<span class="token punctuation">.</span>Codecs<span class="token punctuation">.</span><span class="token function">UniversalDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    i <span class="token operator">:=</span> <span class="token number">0</span>
    unversionedLines <span class="token operator">:=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span>
        p <span class="token operator">:=</span> <span class="token operator">&amp;</span>abac<span class="token punctuation">.</span>Policy<span class="token punctuation">{</span><span class="token punctuation">}</span>
        b <span class="token operator">:=</span> scanner<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// skip comment lines and blank lines</span>
        trimmed <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>trimmed<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>trimmed<span class="token punctuation">,</span> <span class="token string">"#"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>

        decodedObj<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">IsMissingVersion</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">||</span> runtime<span class="token punctuation">.</span><span class="token function">IsMissingKind</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">||</span> runtime<span class="token punctuation">.</span><span class="token function">IsNotRegisteredError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> policyLoadError<span class="token punctuation">{</span>path<span class="token punctuation">,</span> i<span class="token punctuation">,</span> b<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            unversionedLines<span class="token operator">++</span>
            <span class="token comment" spellcheck="true">// Migrate unversioned policy object</span>
            oldPolicy <span class="token operator">:=</span> <span class="token operator">&amp;</span>v0<span class="token punctuation">.</span>Policy<span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">DecodeInto</span><span class="token punctuation">(</span>decoder<span class="token punctuation">,</span> b<span class="token punctuation">,</span> oldPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> policyLoadError<span class="token punctuation">{</span>path<span class="token punctuation">,</span> i<span class="token punctuation">,</span> b<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> abac<span class="token punctuation">.</span>Scheme<span class="token punctuation">.</span><span class="token function">Convert</span><span class="token punctuation">(</span>oldPolicy<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> policyLoadError<span class="token punctuation">{</span>path<span class="token punctuation">,</span> i<span class="token punctuation">,</span> b<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            pl <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>pl<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>

        decodedPolicy<span class="token punctuation">,</span> ok <span class="token operator">:=</span> decodedObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>abac<span class="token punctuation">.</span>Policy<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> policyLoadError<span class="token punctuation">{</span>path<span class="token punctuation">,</span> i<span class="token punctuation">,</span> b<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unrecognized object: %#v"</span><span class="token punctuation">,</span> decodedObj<span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        pl <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>pl<span class="token punctuation">,</span> decodedPolicy<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> unversionedLines <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"Policy file %s contained unversioned rules. See docs/admin/authorization.md#abac-mode for ABAC file format details."</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> scanner<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> policyLoadError<span class="token punctuation">{</span>path<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pl<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>NewFromFile()</code>读取 ABAC policy 文件，然后构建 policyList，并返回。<br>policyList 类型实现了<code>Authorize()</code>方法:</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Authorize implements authorizer.Authorize</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>pl PolicyList<span class="token punctuation">)</span> <span class="token function">Authorize</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> a authorizer<span class="token punctuation">.</span>Attributes<span class="token punctuation">)</span> <span class="token punctuation">(</span>authorizer<span class="token punctuation">.</span>Decision<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> pl <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> authorizer<span class="token punctuation">.</span>DecisionAllow<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> authorizer<span class="token punctuation">.</span>DecisionNoOpinion<span class="token punctuation">,</span> <span class="token string">"No policy matched."</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token comment" spellcheck="true">// TODO: Benchmark how much time policy matching takes with a medium size</span>
    <span class="token comment" spellcheck="true">// policy file, compared to other steps such as encoding/decoding.</span>
    <span class="token comment" spellcheck="true">// Then, add Caching only if needed.</span>
<span class="token punctuation">}</span></code></pre>
<p><code>Authorize()</code>方法会使用 policyList 中每一条 policy 去匹配请求。如果匹配到，则直接通过；否则不通过。</p>
<p>再来看下匹配函数<code>matches()</code>：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">matches</span><span class="token punctuation">(</span>p abac<span class="token punctuation">.</span>Policy<span class="token punctuation">,</span> a authorizer<span class="token punctuation">.</span>Attributes<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">subjectMatches</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token function">GetUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token function">verbMatches</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Resource and non-resource requests are mutually exclusive, at most one will match a policy</span>
            <span class="token keyword">if</span> <span class="token function">resourceMatches</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token function">nonResourceMatches</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span></code></pre>
<p><code>matches()</code>会执行<code>subjectMatches()</code>，<code>verbMatches()</code>及<code>resourceMatches()</code>或<code>nonResourceMatches()</code>。</p>
<h5 id="RBAC授权器"><a href="#RBAC授权器" class="headerlink" title="RBAC授权器"></a>RBAC授权器</h5><p>RBAC是指基于角色的访问控制。可以把用户和角色相关联，从而获取用户拥有的权限。首先来看下角色，在Kubernetes中，有两种类型的角色，一种是namespaced的角色；另一种是全局的角色。<br>namespaced 的角色Yaml文件如下：</p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>reader
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># "" indicates the core API group</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span></code></pre>
<p>全局的角色Yaml文件如下：</p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true"># "namespace" omitted since ClusterRoles are not namespaced</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>reader
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span></code></pre>
<p>一个角色对应着多条的规则。</p>
<p>当然，还需要一种机制关联角色和用户。这就是RoleBinding和ClusterRoleBinding。例子(表示把User jane绑定到Role pod-reader上)如下：</p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># This role binding allows "jane" to read pods in the "default" namespace.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> read<span class="token punctuation">-</span>pods
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> jane
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>reader
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</code></pre>
<p>具体RBAC的功能可以参照官方文档。</p>
<p>RBAC授权器定义在<a href="https://github.com/kubernetes/kubernetes/blob/323f34858de18b862d43c40b2cced65ad8e24052/plugin/pkg/auth/authorizer/rbac/rbac.go" target="_blank" rel="noopener">kubernetes/plugin/pkg/auth/authorizer/rbac/rbac.go </a>中：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> RBACAuthorizer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    authorizationRuleResolver RequestToRuleMapper
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token operator">*</span>RBACAuthorizer <span class="token punctuation">{</span>
    authorizer <span class="token operator">:=</span> <span class="token operator">&amp;</span>RBACAuthorizer<span class="token punctuation">{</span>
        authorizationRuleResolver<span class="token punctuation">:</span> rbacregistryvalidation<span class="token punctuation">.</span><span class="token function">NewDefaultRuleResolver</span><span class="token punctuation">(</span>
            roles<span class="token punctuation">,</span> roleBindings<span class="token punctuation">,</span> clusterRoles<span class="token punctuation">,</span> clusterRoleBindings<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> authorizer
<span class="token punctuation">}</span></code></pre>
<p>RBAC授权方法如下:</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RBACAuthorizer<span class="token punctuation">)</span> <span class="token function">Authorize</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> requestAttributes authorizer<span class="token punctuation">.</span>Attributes<span class="token punctuation">)</span> <span class="token punctuation">(</span>authorizer<span class="token punctuation">.</span>Decision<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ruleCheckingVisitor <span class="token operator">:=</span> <span class="token operator">&amp;</span>authorizingVisitor<span class="token punctuation">{</span>requestAttributes<span class="token punctuation">:</span> requestAttributes<span class="token punctuation">}</span>

    r<span class="token punctuation">.</span>authorizationRuleResolver<span class="token punctuation">.</span><span class="token function">VisitRulesFor</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ruleCheckingVisitor<span class="token punctuation">.</span>visit<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ruleCheckingVisitor<span class="token punctuation">.</span>allowed <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authorizer<span class="token punctuation">.</span>DecisionAllow<span class="token punctuation">,</span> ruleCheckingVisitor<span class="token punctuation">.</span>reason<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

<span class="token operator">...</span>
    <span class="token keyword">return</span> authorizer<span class="token punctuation">.</span>DecisionNoOpinion<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>authorizingVisitor<span class="token punctuation">)</span> <span class="token function">visit</span><span class="token punctuation">(</span>source fmt<span class="token punctuation">.</span>Stringer<span class="token punctuation">,</span> rule <span class="token operator">*</span>rbacv1<span class="token punctuation">.</span>PolicyRule<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> rule <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">RuleAllows</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>requestAttributes<span class="token punctuation">,</span> rule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        v<span class="token punctuation">.</span>allowed <span class="token operator">=</span> <span class="token boolean">true</span>
        v<span class="token punctuation">.</span>reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RBAC: allowed by %s"</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        v<span class="token punctuation">.</span>errors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></code></pre>
<p>使用VisitRulesFor()获取用户的规则，再调用RulesAllow()来授权。<br>RulesAllow()定义如下：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">RuleAllows</span><span class="token punctuation">(</span>requestAttributes authorizer<span class="token punctuation">.</span>Attributes<span class="token punctuation">,</span> rule <span class="token operator">*</span>rbacv1<span class="token punctuation">.</span>PolicyRule<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> requestAttributes<span class="token punctuation">.</span><span class="token function">IsResourceRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        combinedResource <span class="token operator">:=</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetSubresource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            combinedResource <span class="token operator">=</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetSubresource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> rbacv1helpers<span class="token punctuation">.</span><span class="token function">VerbMatches</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetVerb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            rbacv1helpers<span class="token punctuation">.</span><span class="token function">APIGroupMatches</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetAPIGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            rbacv1helpers<span class="token punctuation">.</span><span class="token function">ResourceMatches</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> combinedResource<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetSubresource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            rbacv1helpers<span class="token punctuation">.</span><span class="token function">ResourceNameMatches</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> rbacv1helpers<span class="token punctuation">.</span><span class="token function">VerbMatches</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetVerb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        rbacv1helpers<span class="token punctuation">.</span><span class="token function">NonResourceURLMatches</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>RuleAllows()通过调用<code>VerbMatches()</code>, <code>APIGroupMatches()</code>, <code>ResourceMatches()</code>, <code>ResourceNameMatches()</code>等函数进行规则匹配</p>
<p><strong>对请求进行认证</strong></p>
<p>调用链：</p>
<pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run() -&gt; CreateServerChain() -&gt; CreateKubeAPIServerConfig() -&gt; buildGenericConfig() -&gt; genericapiserver.NewConfig(legacyscheme.Codecs)-&gt; DefaultBuildHandlerChain()</code></pre><p>代码路径：</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/ca324214be0c3823b309a145b876bbb79ccd742a/staging/src/k8s.io/apiserver/pkg/server/config.go" target="_blank" rel="noopener">staging/src/k8s.io/apiserver/pkg/server/config.go</a></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">DefaultBuildHandlerChain</span><span class="token punctuation">(</span>apiHandler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> c <span class="token operator">*</span>Config<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
    handler <span class="token operator">:=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAuthorization</span><span class="token punctuation">(</span>apiHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>FlowControl <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithPriorityAndFairness</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>FlowControl<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithMaxInFlightLimit</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>MaxRequestsInFlight<span class="token punctuation">,</span> c<span class="token punctuation">.</span>MaxMutatingRequestsInFlight<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithImpersonation</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span>
    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAudit</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditBackend<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditPolicyChecker<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">)</span>
    failedHandler <span class="token operator">:=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">Unauthorized</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>SupportsBasicAuth<span class="token punctuation">)</span>
    failedHandler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithFailedAuthenticationAudit</span><span class="token punctuation">(</span>failedHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditBackend<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditPolicyChecker<span class="token punctuation">)</span>
    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAuthentication</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>Authenticator<span class="token punctuation">,</span> failedHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">)</span>
    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithCORS</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>CorsAllowedOriginList<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>
    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithTimeoutForNonLongRunningRequests</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RequestTimeout<span class="token punctuation">)</span>
    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithWaitGroup</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>HandlerChainWaitGroup<span class="token punctuation">)</span>
    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithRequestInfo</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RequestInfoResolver<span class="token punctuation">)</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>SecureServing <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>SecureServing<span class="token punctuation">.</span>DisableHTTP2 <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>GoawayChance <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithProbabilisticGoaway</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GoawayChance<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithPanicRecovery</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
    <span class="token keyword">return</span> handler
<span class="token punctuation">}</span></code></pre>
<p>注意到： <code>handler := genericapifilters.WithAuthorization(apiHandler, c.Authorization.Authorizer, c.Serializer)</code></p>
<p>代码路径：<a href="https://github.com/kubernetes/kubernetes/blob/ca324214be0c3823b309a145b876bbb79ccd742a/staging/src/k8s.io/apiserver/pkg/endpoints/filters/authorization.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apiserver/pkg/endpoints/filters/authorization.go </a></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">WithAuthorization</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> a authorizer<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> s runtime<span class="token punctuation">.</span>NegotiatedSerializer<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
    <span class="token keyword">if</span> a <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"Authorization is disabled"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> handler
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        ae <span class="token operator">:=</span> request<span class="token punctuation">.</span><span class="token function">AuditEventFrom</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

        attributes<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">GetAuthorizerAttributes</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            responsewriters<span class="token punctuation">.</span><span class="token function">InternalError</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        authorized<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token function">Authorize</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// an authorizer like RBAC could encounter evaluation errors and still allow the request, so authorizer decision is checked before error here.</span>
        <span class="token keyword">if</span> authorized <span class="token operator">==</span> authorizer<span class="token punctuation">.</span>DecisionAllow <span class="token punctuation">{</span>
            audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> decisionAnnotationKey<span class="token punctuation">,</span> decisionAllow<span class="token punctuation">)</span>
            audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> reasonAnnotationKey<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>
            handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> reasonAnnotationKey<span class="token punctuation">,</span> reasonError<span class="token punctuation">)</span>
            responsewriters<span class="token punctuation">.</span><span class="token function">InternalError</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Forbidden: %#v, Reason: %q"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>RequestURI<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>
        audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> decisionAnnotationKey<span class="token punctuation">,</span> decisionForbid<span class="token punctuation">)</span>
        audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> reasonAnnotationKey<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>
        responsewriters<span class="token punctuation">.</span><span class="token function">Forbidden</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> s<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接下来的过程和认证器一样</p>
<h4 id="Admission"><a href="#Admission" class="headerlink" title="Admission"></a>Admission</h4><p>在进行用户认证和权限授予后，apiserver就会查询/修改etcd存储，以完成请求。</p>
<p> Admission Controller（准入控制）是 Kubernetes API Server 用于拦截请求的一种手段。Admission可以做到对请求的资源对象进行校验，修改。</p>
<p>![](../Kubernetes 网络入门/img/2019070310251413.png)</p>
<ul>
<li>MutatingAdmissionWebhook：在对象持久化之前进行修改</li>
<li>ValidatingAdmissionWebhook：在对象持久化之前进行</li>
</ul>
<p><strong>Admission Controller 工作流程</strong></p>
<ul>
<li>API Server 接收到客户端请求后首先进行认证鉴权，认证鉴权后才会进行 endpoint handler 处理</li>
<li>当API Server 接收到对象后根据 http 的路径可以得到版本号，然后将 body 反序列化成 versioned object</li>
<li>versioned object 转化为 internal object，即没有版本的内部类型，这种资源类型是所有 versioned 类型的超集。只有转化为 internal 后才能适配所有的客户端 versioned object 的校验、</li>
<li>Admission Controller 具体的 admit 操作，可以通过这里修改资源对象，例如为 Pod 挂载一个默认的 Service Account 等</li>
<li>API Server internal object validation，校验某个资源对象数据和格式是否合法，例如：Service Name 的字符个数不能超过63等</li>
<li>Admission Controller validate，可以自定义任何的对象校验规则</li>
<li>internal object 转化为 versioned object，并且持久化存储到 etcd</li>
</ul>
<p>Kubernetes 1.10之前的版本，<code>--admission-control</code> 打开 Admission Controller。同时<code>--admission-control</code>的顺序决定 Admission 运行的先后</p>
<p>Kubernetes 1.10之后的版本，<code>--admission-control</code> 已经废弃，建议使用 <code>--enable-admission-plugins --disable-admission-plugins</code> 指定需要打开或者关闭的 Admission Controller。 同时用户指定的顺序并不影响实际 Admission Controllers 的执行顺序</p>
<pre><code> --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,Priority,ResourceQuota,PodSecurityPolicy   </code></pre><p>Webhook Admission 属于同步调用，需要部署自己的 webhook server，创建自定义的配置资源对象： ValidatingWebhookConfiguration 或 MutatingWebhookConfiguration</p>
<pre><code>[root@master ~]# kubectl api-resources | grep webhook
mutatingwebhookconfigurations                  admissionregistration.k8s.io   false        MutatingWebhookConfiguration
validatingwebhookconfigurations                admissionregistration.k8s.io   false        ValidatingWebhookConfiguration


[root@master ~]# kubectl api-versions | grep admissionregistration.k8s.io/v1beta1
admissionregistration.k8s.io/v1beta1</code></pre><p> <strong>部署</strong> </p>
<p> 定义 ValidatingWebhookConfiguration 或者 MutatingWebhookConfiguration</p>
<pre><code>apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: &lt;name&gt;
  labels:
    app: &lt;label&gt;
webhooks:
  - name: &lt;webhook name, e.g., pod-policy.example.io&gt;  逗号分割，限制必须三段
    clientConfig:
      service:
        namespace: &lt;namespace of the front-end service&gt;
        name: &lt;name of the front-end service&gt;
      caBundle: &lt;pem encoded ca cert that signs the server cert used by the webhook&gt;
    rules:
      - operations: [ "CREATE" ]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["pods"]
    namespaceSelector:
      matchLabels:
        &lt;key&gt;: &lt;value&gt;
</code></pre><p><strong>创建自己的 webhook 程序流程</strong></p>
<ul>
<li>创建TLS Certificate，即证书</li>
<li>编写服务端代码，服务端代码需要使用证书</li>
<li>根据证书创建k8s sercret</li>
<li>创建k8s Deployment和Service</li>
<li>创建k8s WebhookConfiguration，其中需要使用之前创建的证书</li>
</ul>
<p><strong>准入控制器列表</strong></p>
<p>准入控制器是写入apiserver源码的，无法动态添加。可以通过<code>kube-apiserver -h | grep enable-admission-plugins</code>查看支持的准入控制器，也可以在github上查看准入控制器列表以及实现细节：<a href="https://github.com/kubernetes/kubernetes/tree/master/plugin/pkg/admission。" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/tree/master/plugin/pkg/admission。</a></p>
<p>以下是目前支持的准入控制器：</p>
<ul>
<li>AlwaysAdmit：全部允许，相当于没有准入控制器。</li>
<li>AlwaysPull/images/2020：强制修改每一个新Pod强制拉取镜像。</li>
<li>AlwaysDeny：拒绝所有请求。</li>
<li>DefaultStorageClass：如果PersistentVolumeClaim没有指定StorageClass，则为其添加一个默认的StorageClass。</li>
<li>DefaultTolerationSeconds：如果Pod没有设置toleration，则默认设置对<code>notready:NoExecute</code>和<code>unreachable:NoExecute</code>的toleration为5分钟。</li>
<li>DenyExecOnPrivileged：拦截所有特权级容器运行的命令。该准入控制器已合并至<code>DenyEscalatingExec</code>，并将在1.18版本移除。</li>
<li>DenyEscalatingExec：阻止容器运行提权类命令，包括特权级容器，或者说有着host的IPC命名空间或PID命名空间。</li>
<li>EventRateLimit：控制apiserver接收事件请求的速率，以缓解负载过大的问题。</li>
<li>ExtendedResourceToleration：用于有扩展类资源的专用节点，比如说GPU，FPGA。如果请求需要扩展资源，则自动为其添加toleration以帮助选择节点。</li>
<li>ImagePolicyWebhook：允许后端的webhook判断镜像拉取策略，例如配置镜像仓库的密钥。</li>
<li>LimitPodHardAntiAffinityTopology：拒绝所有在<code>requiredDuringSchedulingRequiredDuringExecution</code>中定义除<code>kubernetes.io/hostname</code>之外的拓扑关键字的Pod。</li>
<li>LimitRanger：确保所有资源请求不会超过 namespace 的 LimitRange。</li>
<li>MutatingAdmissionWebhook：调用与请求匹配的任何变更 webhook。</li>
<li>NamespaceAutoProvision：检查请求引用的命名空间，如果不存在则自动创建命名空间。</li>
<li>NamespaceExists：检查请求引用的命名空间，如果不存在则拒绝。</li>
<li>NamespaceLifecycle：保证正在终止的命名空间无法创建对象；拒绝引用了不存在的命名空间的请求；保证无法删除默认的三个命名空间：<code>default</code>，<code>kube-system</code>，<code>kube-public</code>。</li>
<li>NodeRestriction：限制了kubelet可以修改的Node和Pod对象，往往与权限授予的Node模式配合使用。</li>
<li>OwnerReferencesPermissionEnforcement：保护对<code>metadata.ownerReferences</code>对象的访问，以便只有对该对象具有“删除”权限的用户才能对其进行更改。</li>
<li>PersistentVolumeLabel：如果是云服务商定义的PV，则自动为其添加上region和zone的标签。已弃用，使用<code>cloud-controller-manager</code>代替。</li>
<li>PodNodeSelector：通过读取命名空间注释和全局配置来限制可在命名空间内使用的节点选择器。</li>
<li>PersistentVolumeClaimResize：验证更改PVC大小的请求。</li>
<li>PodPreset：允许在Pod启动时注入一些信息，比如环境变量，secret，volume等等，需要和podpreset资源对象配合使用。</li>
<li>PodSecurityPolicy：在创建和修改Pod时，根据请求的安全上下文和可用的Pod安全策略确定是否应该允许它。</li>
<li>PodTolerationRestriction：验证容器的容忍度与其命名空间的容忍度之间是否存在冲突，并在存在冲突时拒绝该容器请求。</li>
<li>Priority：使用priorityClassName字段并填充优先级的整数值。如果未找到优先级，则拒绝Pod。</li>
<li>ResourceQuota：确保请求不违反namespace中的resourcequota对象。</li>
<li>SecurityContextDeny：拒绝任何试图设置某些升级的SecurityContext字段的pod。</li>
<li>ServiceAccount：自动化ServiceAccount设置，包括为Pod填充serviceaccount字段，以及挂载secret。</li>
<li>StorageObjectInUseProtection：为新创建的PVC添加<code>kubernetes.io/pvc-protection</code>和<code>kubernetes.io/pv-protection</code>字段，防止用户在使用PV或PVC时删除它们。</li>
<li>ValidatingAdmissionWebhook：调用与请求匹配的任何验证webhook。如果任何一个webhook拒绝请求，则请求失败。</li>
</ul>
<p>以上是目前apiserver可以使用的准入控制器，更详细的内容请参考官网：<a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-do。" target="_blank" rel="noopener">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-do。</a></p>
<p>如果以上准入控制器无法满足需要，可以自己实现准入控制器，然后编译进kube-apiserver程序中。</p>
<p><strong>小结</strong></p>
<ul>
<li>准入控制器是请求持久化至etcd之前的拦截器，可以修改/拦截请求。</li>
<li>可以在apiserver启动时传入允许/拒绝的准入控制器。</li>
<li>apiserver提供了一系列内置的准入控制器，如无法满足需求也可自己实现。</li>
</ul>
<h5 id="注册插件"><a href="#注册插件" class="headerlink" title="注册插件"></a>注册插件</h5><p><strong>调用链</strong></p>
<pre><code>app.NewAPIServerCommand() -&gt; options.NewServerRunOptions() -&gt; kubeoptions.NewAdmissionOptions() -&gt; genericoptions.NewAdmissionOptions() -&gt;
RegisterAllAdmissionPlugins(options.Plugins)</code></pre><p>注册</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">RegisterAllAdmissionPlugins</span><span class="token punctuation">(</span>plugins <span class="token operator">*</span>admission<span class="token punctuation">.</span>Plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    admit<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// DEPRECATED as no real meaning</span>
    alwayspull<span class="token operator">/</span>images<span class="token operator">/</span><span class="token number">2020</span><span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    antiaffinity<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    defaulttolerationseconds<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    defaultingressclass<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    deny<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// DEPRECATED as no real meaning</span>
    eventratelimit<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    exec<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    extendedresourcetoleration<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    gc<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    imagepolicy<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    limitranger<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    autoprovision<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    exists<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    noderestriction<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    nodetaint<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    label<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// DEPRECATED, future PVs should not rely on labels for zone topology</span>
    podnodeselector<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    podpreset<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    podtolerationrestriction<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    runtimeclass<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    resourcequota<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    podsecuritypolicy<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    podpriority<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    scdeny<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    serviceaccount<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    setdefault<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    resize<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    storageobjectinuseprotection<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    certapproval<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    certsigning<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
    certsubjectrestriction<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h5 id="初始化插件"><a href="#初始化插件" class="headerlink" title="初始化插件"></a>初始化插件</h5><p>调用链：</p>
<pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run() -&gt; CreateServerChain() -&gt; CreateKubeAPIServerConfig() -&gt; buildGenericConfig() -&gt; s.Admission.ApplyTo() -&gt;
a.GenericAdmission.ApplyTo() -&gt; a.Plugins.NewFromPlugins()-&gt;ps.InitPlugin()</code></pre><p><strong>buildGenericConfig</strong></p>
<p>Config 结构主要用来初始化 admission 插件，路径实现 <code>pkg/kubeapiserver/admission/config.go</code></p>
<pre class=" language-go"><code class="language-go">admissionConfig <span class="token operator">:=</span> <span class="token operator">&amp;</span>kubeapiserveradmission<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
    ExternalInformers<span class="token punctuation">:</span>    versionedInformers<span class="token punctuation">,</span>
    LoopbackClientConfig<span class="token punctuation">:</span> genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">,</span>
    CloudConfigFile<span class="token punctuation">:</span>      s<span class="token punctuation">.</span>CloudProvider<span class="token punctuation">.</span>CloudConfigFile<span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre>
<p> admissionConfig.New 函数主要用来为 admission 建立插件以及 start hook</p>
<pre class=" language-go"><code class="language-go">pluginInitializers<span class="token punctuation">,</span> admissionPostStartHook<span class="token punctuation">,</span> err <span class="token operator">=</span> admissionConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>proxyTransport<span class="token punctuation">,</span> serviceResolver<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    lastErr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create admission plugin initializer: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>New</strong></p>
<p> NewPluginInitializer 实例化 PluginInitializer，这个结构用来初始化 admission plugin</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// New sets up the plugins and admission start hooks needed for admission</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Config<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span>proxyTransport <span class="token operator">*</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">,</span> serviceResolver webhook<span class="token punctuation">.</span>ServiceResolver<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">,</span> server<span class="token punctuation">.</span>PostStartHookFunc<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    webhookAuthResolverWrapper <span class="token operator">:=</span> webhook<span class="token punctuation">.</span><span class="token function">NewDefaultAuthenticationInfoResolverWrapper</span><span class="token punctuation">(</span>proxyTransport<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span>
    webhookPluginInitializer <span class="token operator">:=</span> webhookinit<span class="token punctuation">.</span><span class="token function">NewPluginInitializer</span><span class="token punctuation">(</span>webhookAuthResolverWrapper<span class="token punctuation">,</span> serviceResolver<span class="token punctuation">)</span>

    <span class="token keyword">var</span> cloudConfig <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>CloudConfigFile <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> err <span class="token builtin">error</span>
        cloudConfig<span class="token punctuation">,</span> err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>CloudConfigFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Error reading from cloud configuration file %s: %#v"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>CloudConfigFile<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    internalClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> internalclientset<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span></code></pre>
<p><strong>NewPluginInitializer 实例化 PluginInitializer</strong></p>
<p>具体实现路径为 <code>pkg/kubeapiserver/admission/initializer.go</code></p>
<pre class=" language-go"><code class="language-go">discoveryClient <span class="token operator">:=</span> cacheddiscovery<span class="token punctuation">.</span><span class="token function">NewMemCacheClient</span><span class="token punctuation">(</span>internalClient<span class="token punctuation">.</span><span class="token function">Discovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
discoveryRESTMapper <span class="token operator">:=</span> restmapper<span class="token punctuation">.</span><span class="token function">NewDeferredDiscoveryRESTMapper</span><span class="token punctuation">(</span>discoveryClient<span class="token punctuation">)</span>
kubePluginInitializer <span class="token operator">:=</span> <span class="token function">NewPluginInitializer</span><span class="token punctuation">(</span>
    cloudConfig<span class="token punctuation">,</span>
    discoveryRESTMapper<span class="token punctuation">,</span>
    quotainstall<span class="token punctuation">.</span><span class="token function">NewQuotaConfigurationForAdmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre>
<p><strong>admissionPostStartHook 函数是重置 cache 操作</strong></p>
<pre class=" language-go"><code class="language-go">admissionPostStartHook <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context genericapiserver<span class="token punctuation">.</span>PostStartHookContext<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    discoveryRESTMapper<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> utilwait<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>discoveryRESTMapper<span class="token punctuation">.</span>Reset<span class="token punctuation">,</span> <span class="token number">30</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> context<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">{</span>webhookPluginInitializer<span class="token punctuation">,</span> kubePluginInitializer<span class="token punctuation">}</span><span class="token punctuation">,</span> admissionPostStartHook<span class="token punctuation">,</span> <span class="token boolean">nil</span></code></pre>
<p><strong>ApplyTo</strong></p>
<p> 路径 <code>k8s.io/apiserver/pkg/server/options/admission.go</code></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ApplyTo adds the admission chain to the server configuration.</span>
<span class="token comment" spellcheck="true">// In case admission plugin names were not provided by a custer-admin they will be prepared from the recommended/default values.</span>
<span class="token comment" spellcheck="true">// In addition the method lazily initializes a generic plugin that is appended to the list of pluginInitializers</span>
<span class="token comment" spellcheck="true">// note this method uses:</span>
<span class="token comment" spellcheck="true">//  genericconfig.Authorizer</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>AdmissionOptions<span class="token punctuation">)</span> <span class="token function">ApplyTo</span><span class="token punctuation">(</span>
    c <span class="token operator">*</span>server<span class="token punctuation">.</span>Config<span class="token punctuation">,</span>
    informers informers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">,</span>
    kubeAPIServerClientConfig <span class="token operator">*</span>rest<span class="token punctuation">.</span>Config<span class="token punctuation">,</span>
    pluginInitializers <span class="token operator">...</span>admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> a <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span></code></pre>
<p><strong>NewFromPlugins</strong></p>
<p>InitPlugin 主要对插件进行初始化工作，分别调用 Initialize 初始化，在调用 ValidateInitialization 验证是否实现了接口方法 ValidateInitialization</p>
<p>最后包裹 handlers，chainAdmissionHandler 包含了插件的 handler，实现了 Admit 和 Validate 方法，就是对所有插件 handler 调用 Admit 和 Validate 方法</p>
<pre><code>func (admissionHandler chainAdmissionHandler) Admit(a Attributes, o ObjectInterfaces) error
func (admissionHandler chainAdmissionHandler) Validate(a Attributes, o ObjectInterfaces) error</code></pre><pre><code>// NewFromPlugins returns an admission.Interface that will enforce admission control decisions of all
// the given plugins.
func (ps *Plugins) NewFromPlugins(pluginNames []string, configProvider ConfigProvider, pluginInitializer PluginInitializer, decorator Decorator) (Interface, error) {
    handlers := []Interface{}
    mutationPlugins := []string{}
    validationPlugins := []string{}
    for _, pluginName := range pluginNames {
        pluginConfig, err := configProvider.ConfigFor(pluginName)
        if err != nil {
            return nil, err
        }

        plugin, err := ps.InitPlugin(pluginName, pluginConfig, pluginInitializer)
        if err != nil {
            return nil, err
        }

    return chainAdmissionHandler(handlers), nil
}</code></pre><p><strong>赋值 AdmissionControl</strong></p>
<p>具体操作就是又包裹了一下 pluginHandlerWithMetrics</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// WithStepMetrics is a decorator for a whole admission phase, i.e. admit or validation.admission step.</span>
<span class="token keyword">func</span> <span class="token function">WithStepMetrics</span><span class="token punctuation">(</span>i admission<span class="token punctuation">.</span>Interface<span class="token punctuation">)</span> admission<span class="token punctuation">.</span>Interface <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">WithMetrics</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> Metrics<span class="token punctuation">.</span>ObserveAdmissionStep<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// WithMetrics is a decorator for admission handlers with a generic observer func.</span>
<span class="token keyword">func</span> <span class="token function">WithMetrics</span><span class="token punctuation">(</span>i admission<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> observer ObserverFunc<span class="token punctuation">,</span> extraLabels <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> admission<span class="token punctuation">.</span>Interface <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>pluginHandlerWithMetrics<span class="token punctuation">{</span>
        Interface<span class="token punctuation">:</span>   i<span class="token punctuation">,</span>
        observer<span class="token punctuation">:</span>    observer<span class="token punctuation">,</span>
        extraLabels<span class="token punctuation">:</span> extraLabels<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h5 id="使用插件"><a href="#使用插件" class="headerlink" title="使用插件"></a>使用插件</h5><p>调用链：</p>
<pre><code>main() -&gt; 
app.NewAPIServerCommand() -&gt; 
Run() -&gt; 
CreateServerChain() -&gt; 
createAggregatorServer()-&gt;
NewWithDelegate()-&gt;
InstallAPIGroups()-&gt;
installAPIResources()-&gt;
InstallREST()-&gt;
Install()-&gt;
registerResourceHandlers()-&gt;
metrics.InstrumentRouteFunc()-&gt;
        --&gt;  restfulUpdateResource               PUT
        --&gt;  restfulPatchResource                PATCH
        --&gt;  restfulCreateNamedResource          POST
        --&gt;  restfulCreateResource               POST
        --&gt;  restfulDeleteResource               DELETE
        --&gt;  restfulDeleteCollection             DELETECOLLECTION
        --&gt;  restfulConnectResource              CONNECT </code></pre><p><strong>registerResourceHandlers</strong></p>
<p> 可以得到 PUT PATCH POST DELETE DELETECOLLECTION CONNECT 这些 method 用到了 admission </p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">switch</span> action<span class="token punctuation">.</span>Verb <span class="token punctuation">{</span>
<span class="token keyword">case</span> <span class="token string">"PUT"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Update a resource.</span>
    doc <span class="token operator">:=</span> <span class="token string">"replace the specified "</span> <span class="token operator">+</span> kind
    <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
        doc <span class="token operator">=</span> <span class="token string">"replace "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of the specified "</span> <span class="token operator">+</span> kind
    <span class="token punctuation">}</span>
    handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulUpdateResource</span><span class="token punctuation">(</span>updater<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">case</span> <span class="token string">"PATCH"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Partially update a resource</span>
    handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulPatchResource</span><span class="token punctuation">(</span>patcher<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">,</span> supportedTypes<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">case</span> <span class="token string">"POST"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Create a resource.</span>
    <span class="token keyword">var</span> handler restful<span class="token punctuation">.</span>RouteFunction
    <span class="token keyword">if</span> isNamedCreater <span class="token punctuation">{</span>
        handler <span class="token operator">=</span> <span class="token function">restfulCreateNamedResource</span><span class="token punctuation">(</span>namedCreater<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        handler <span class="token operator">=</span> <span class="token function">restfulCreateResource</span><span class="token punctuation">(</span>creater<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    handler <span class="token operator">=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">case</span> <span class="token string">"DELETE"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Delete a resource.</span>
    handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulDeleteResource</span><span class="token punctuation">(</span>gracefulDeleter<span class="token punctuation">,</span> isGracefulDeleter<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">case</span> <span class="token string">"DELETECOLLECTION"</span><span class="token punctuation">:</span>
    handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulDeleteCollection</span><span class="token punctuation">(</span>collectionDeleter<span class="token punctuation">,</span> isCollectionDeleter<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">case</span> <span class="token string">"CONNECT"</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> method <span class="token operator">:=</span> <span class="token keyword">range</span> connecter<span class="token punctuation">.</span><span class="token function">ConnectMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulConnectResource</span><span class="token punctuation">(</span>connecter<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">,</span> path<span class="token punctuation">,</span> isSubresource<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span></code></pre>
<h3 id="API-server-路由"><a href="#API-server-路由" class="headerlink" title="API server 路由"></a>API server 路由</h3><h4 id="emicklei-go-restful"><a href="#emicklei-go-restful" class="headerlink" title="emicklei/go-restful"></a>emicklei/go-restful</h4><p>Kubernetes使用emicklei/go-restful包提供RESTful API服务。所以有必要先来了解下emicklei/go-restful是如何使用的。</p>
<ol>
<li>创建container</li>
<li>创建ws</li>
<li>生成route，即ws.GET(“/hello”).To(hello)</li>
<li>ws.Route(route)</li>
<li>container.Add(ws)</li>
<li>http.Server{}</li>
</ol>
<p>即如下代码形式：</p>
<pre class=" language-go"><code class="language-go">container <span class="token operator">:=</span> restful<span class="token punctuation">.</span><span class="token function">NewContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ws <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>restful<span class="token punctuation">.</span>WebService<span class="token punctuation">)</span>
ws<span class="token punctuation">.</span><span class="token function">Route</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>hello<span class="token punctuation">)</span><span class="token punctuation">)</span>
container<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span>
server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">":8081"</span><span class="token punctuation">,</span> Handler<span class="token punctuation">:</span> container<span class="token punctuation">}</span>
log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">hello</span><span class="token punctuation">(</span>req <span class="token operator">*</span>restful<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> resp <span class="token operator">*</span>restful<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> <span class="token string">"default world"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="container的生成"><a href="#container的生成" class="headerlink" title="container的生成"></a>container的生成</h4><p>所以，我们第一件事就是寻找在哪生成的container。container的生成函数定义:</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewAPIServerHandler</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> s runtime<span class="token punctuation">.</span>NegotiatedSerializer<span class="token punctuation">,</span> handlerChainBuilder HandlerChainBuilderFn<span class="token punctuation">,</span> notFoundHandler http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> <span class="token operator">*</span>APIServerHandler <span class="token punctuation">{</span>
    nonGoRestfulMux <span class="token operator">:=</span> mux<span class="token punctuation">.</span><span class="token function">NewPathRecorderMux</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> notFoundHandler <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        nonGoRestfulMux<span class="token punctuation">.</span><span class="token function">NotFoundHandler</span><span class="token punctuation">(</span>notFoundHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    gorestfulContainer <span class="token operator">:=</span> restful<span class="token punctuation">.</span><span class="token function">NewContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    gorestfulContainer<span class="token punctuation">.</span>ServeMux <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    gorestfulContainer<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span>restful<span class="token punctuation">.</span>CurlyRouter<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// e.g. for proxy/{kind}/{name}/{*}</span>
    gorestfulContainer<span class="token punctuation">.</span><span class="token function">RecoverHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>panicReason <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> httpWriter http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logStackOnRecover</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> panicReason<span class="token punctuation">,</span> httpWriter<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    gorestfulContainer<span class="token punctuation">.</span><span class="token function">ServiceErrorHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>serviceErr restful<span class="token punctuation">.</span>ServiceError<span class="token punctuation">,</span> request <span class="token operator">*</span>restful<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> response <span class="token operator">*</span>restful<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">serviceErrorHandler</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> serviceErr<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    director <span class="token operator">:=</span> director<span class="token punctuation">{</span>
        name<span class="token punctuation">:</span>               name<span class="token punctuation">,</span>
        goRestfulContainer<span class="token punctuation">:</span> gorestfulContainer<span class="token punctuation">,</span>
        nonGoRestfulMux<span class="token punctuation">:</span>    nonGoRestfulMux<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>APIServerHandler<span class="token punctuation">{</span>
        FullHandlerChain<span class="token punctuation">:</span>   <span class="token function">handlerChainBuilder</span><span class="token punctuation">(</span>director<span class="token punctuation">)</span><span class="token punctuation">,</span>
        GoRestfulContainer<span class="token punctuation">:</span> gorestfulContainer<span class="token punctuation">,</span>
        NonGoRestfulMux<span class="token punctuation">:</span>    nonGoRestfulMux<span class="token punctuation">,</span>
        Director<span class="token punctuation">:</span>           director<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// NewContainer creates a new Container using a new ServeMux and default router (CurlyRouter)</span>
<span class="token keyword">func</span> <span class="token function">NewContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Container <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Container<span class="token punctuation">{</span>
        webServices<span class="token punctuation">:</span>            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>WebService<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        ServeMux<span class="token punctuation">:</span>               http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        isRegisteredOnRoot<span class="token punctuation">:</span>     <span class="token boolean">false</span><span class="token punctuation">,</span>
        containerFilters<span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token punctuation">]</span>FilterFunction<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        doNotRecover<span class="token punctuation">:</span>           <span class="token boolean">true</span><span class="token punctuation">,</span>
        recoverHandleFunc<span class="token punctuation">:</span>      logStackOnRecover<span class="token punctuation">,</span>
        serviceErrorHandleFunc<span class="token punctuation">:</span> writeServiceError<span class="token punctuation">,</span>
        router<span class="token punctuation">:</span>                 CurlyRouter<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        contentEncodingEnabled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="API安装入口"><a href="#API安装入口" class="headerlink" title="API安装入口"></a>API安装入口</h4><pre class=" language-java"><code class="language-java">    m <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">&amp;</span>Master<span class="token punctuation">{</span>
        GenericAPIServer<span class="token operator">:</span>          s<span class="token punctuation">,</span>
        ClusterAuthenticationInfo<span class="token operator">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// install legacy rest storage</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">.</span><span class="token function">VersionEnabled</span><span class="token punctuation">(</span>apiv1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> err <span class="token operator">:</span><span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">InstallLegacyAPI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> legacyRESTStorageProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{</span>
            <span class="token keyword">return</span> nil<span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> err <span class="token operator">:</span><span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">InstallAPIs</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> restStorageProviders<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{</span>
        <span class="token keyword">return</span> nil<span class="token punctuation">,</span> err
    <span class="token punctuation">}</span></code></pre>
<p>前面已经分析过了。 </p>
<h4 id="Container的启动"><a href="#Container的启动" class="headerlink" title="Container的启动"></a>Container的启动</h4><p>Container即GenericAPIServer中的Handler。GenericAPIServer的Run()方法中会启动监听。</p>
<h4 id="resthandler"><a href="#resthandler" class="headerlink" title="resthandler"></a>resthandler</h4><p>之前已经分析到，Kubernetes是如何注册API的。Kubernetes会把对应路径上的请求交给对应的resthandler处理。所以，resthandler是对请求进行处理并响应的函数。在Kubernetes中，给每一种动作设置了对应的resthandler，如下表格所示(只列出了主要部分)：</p>
<table>
<thead>
<tr>
<th>动作</th>
<th>函数</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td>GetResource</td>
</tr>
<tr>
<td>LIST</td>
<td>ListResource</td>
</tr>
<tr>
<td>PUT</td>
<td>UpdateResource</td>
</tr>
<tr>
<td>PATCH</td>
<td>PatchResource</td>
</tr>
<tr>
<td>POST</td>
<td>CreateResource</td>
</tr>
<tr>
<td>DELETE</td>
<td>DeleteResource</td>
</tr>
<tr>
<td>WATCH</td>
<td>ListResource</td>
</tr>
</tbody></table>
<p>调用路径：</p>
<pre><code>master.go
InstallLegacyAPI()-&gt; InstallLegacyAPIGroup()-&gt; installAPIResources()-&gt; 
InstallREST()-&gt; Install()-&gt; registerResourceHandlers()</code></pre><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>APIInstaller<span class="token punctuation">)</span> <span class="token function">registerResourceHandlers</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> storage rest<span class="token punctuation">.</span>Storage<span class="token punctuation">,</span> ws <span class="token operator">*</span>restful<span class="token punctuation">.</span>WebService<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>metav1<span class="token punctuation">.</span>APIResource<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    admit <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Admit

    optionsExternalVersion <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion
    <span class="token keyword">if</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>OptionsExternalVersion <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        optionsExternalVersion <span class="token operator">=</span> <span class="token operator">*</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>OptionsExternalVersion
    <span class="token punctuation">}</span>

    resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">splitSubresource</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    group<span class="token punctuation">,</span> version <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span>Group<span class="token punctuation">,</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span>Version

    fqKindToRegister<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">GetResourceKind</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">,</span> storage<span class="token punctuation">,</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    versionedPtr<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fqKindToRegister<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    defaultVersionedObject <span class="token operator">:=</span> <span class="token function">indirectArbitraryPointer</span><span class="token punctuation">(</span>versionedPtr<span class="token punctuation">)</span>
    kind <span class="token operator">:=</span> fqKindToRegister<span class="token punctuation">.</span>Kind
    isSubresource <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span>

    <span class="token comment" spellcheck="true">// If there is a subresource, namespace scoping is defined by the parent resource</span>
    namespaceScoped <span class="token operator">:=</span> <span class="token boolean">true</span>
    <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
        parentStorage<span class="token punctuation">,</span> ok <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Storage<span class="token punctuation">[</span>resource<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"missing parent storage: %q"</span><span class="token punctuation">,</span> resource<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        scoper<span class="token punctuation">,</span> ok <span class="token operator">:=</span> parentStorage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Scoper<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%q must implement scoper"</span><span class="token punctuation">,</span> resource<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        namespaceScoped <span class="token operator">=</span> scoper<span class="token punctuation">.</span><span class="token function">NamespaceScoped</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        scoper<span class="token punctuation">,</span> ok <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Scoper<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%q must implement scoper"</span><span class="token punctuation">,</span> resource<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        namespaceScoped <span class="token operator">=</span> scoper<span class="token punctuation">.</span><span class="token function">NamespaceScoped</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// what verbs are supported by the storage, used to know what verbs we support per path</span>
    creater<span class="token punctuation">,</span> isCreater <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Creater<span class="token punctuation">)</span>
    namedCreater<span class="token punctuation">,</span> isNamedCreater <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>NamedCreater<span class="token punctuation">)</span>
    lister<span class="token punctuation">,</span> isLister <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Lister<span class="token punctuation">)</span>
    getter<span class="token punctuation">,</span> isGetter <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Getter<span class="token punctuation">)</span>
    getterWithOptions<span class="token punctuation">,</span> isGetterWithOptions <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>GetterWithOptions<span class="token punctuation">)</span>
    gracefulDeleter<span class="token punctuation">,</span> isGracefulDeleter <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>GracefulDeleter<span class="token punctuation">)</span>
    collectionDeleter<span class="token punctuation">,</span> isCollectionDeleter <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>CollectionDeleter<span class="token punctuation">)</span>
    updater<span class="token punctuation">,</span> isUpdater <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Updater<span class="token punctuation">)</span>
    patcher<span class="token punctuation">,</span> isPatcher <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Patcher<span class="token punctuation">)</span>
    watcher<span class="token punctuation">,</span> isWatcher <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Watcher<span class="token punctuation">)</span>
    connecter<span class="token punctuation">,</span> isConnecter <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Connecter<span class="token punctuation">)</span>
    storageMeta<span class="token punctuation">,</span> isMetadata <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>StorageMetadata<span class="token punctuation">)</span>
    storageVersionProvider<span class="token punctuation">,</span> isStorageVersionProvider <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>StorageVersionProvider<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>isMetadata <span class="token punctuation">{</span>
        storageMeta <span class="token operator">=</span> defaultStorageMetadata<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    exporter<span class="token punctuation">,</span> isExporter <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Exporter<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>isExporter <span class="token punctuation">{</span>
        exporter <span class="token operator">=</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    versionedExportOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"ExportOptions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> isNamedCreater <span class="token punctuation">{</span>
        isCreater <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> versionedList <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> isLister <span class="token punctuation">{</span>
        list <span class="token operator">:=</span> lister<span class="token punctuation">.</span><span class="token function">NewList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        listGVKs<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">.</span><span class="token function">ObjectKinds</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        versionedListPtr<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>listGVKs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Kind<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        versionedList <span class="token operator">=</span> <span class="token function">indirectArbitraryPointer</span><span class="token punctuation">(</span>versionedListPtr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    versionedListOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"ListOptions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    versionedCreateOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"CreateOptions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    versionedPatchOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"PatchOptions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    versionedUpdateOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"UpdateOptions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> versionedDeleteOptions runtime<span class="token punctuation">.</span>Object
    <span class="token keyword">var</span> versionedDeleterObject <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    deleteReturnsDeletedObject <span class="token operator">:=</span> <span class="token boolean">false</span>
    <span class="token keyword">if</span> isGracefulDeleter <span class="token punctuation">{</span>
        versionedDeleteOptions<span class="token punctuation">,</span> err <span class="token operator">=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"DeleteOptions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        versionedDeleterObject <span class="token operator">=</span> <span class="token function">indirectArbitraryPointer</span><span class="token punctuation">(</span>versionedDeleteOptions<span class="token punctuation">)</span>

        <span class="token keyword">if</span> mayReturnFullObjectDeleter<span class="token punctuation">,</span> ok <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>MayReturnFullObjectDeleter<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            deleteReturnsDeletedObject <span class="token operator">=</span> mayReturnFullObjectDeleter<span class="token punctuation">.</span><span class="token function">DeleteReturnsDeletedObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    versionedStatusPtr<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"Status"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    versionedStatus <span class="token operator">:=</span> <span class="token function">indirectArbitraryPointer</span><span class="token punctuation">(</span>versionedStatusPtr<span class="token punctuation">)</span>
    <span class="token keyword">var</span> <span class="token punctuation">(</span>
        getOptions             runtime<span class="token punctuation">.</span>Object
        versionedGetOptions    runtime<span class="token punctuation">.</span>Object
        getOptionsInternalKind schema<span class="token punctuation">.</span>GroupVersionKind
        getSubpath             <span class="token builtin">bool</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> isGetterWithOptions <span class="token punctuation">{</span>
        getOptions<span class="token punctuation">,</span> getSubpath<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> getterWithOptions<span class="token punctuation">.</span><span class="token function">NewGetOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        getOptionsInternalKinds<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">.</span><span class="token function">ObjectKinds</span><span class="token punctuation">(</span>getOptions<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        getOptionsInternalKind <span class="token operator">=</span> getOptionsInternalKinds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        versionedGetOptions<span class="token punctuation">,</span> err <span class="token operator">=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>getOptionsInternalKind<span class="token punctuation">.</span>Kind<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            versionedGetOptions<span class="token punctuation">,</span> err <span class="token operator">=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>getOptionsInternalKind<span class="token punctuation">.</span>Kind<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        isGetter <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> versionedWatchEvent <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> isWatcher <span class="token punctuation">{</span>
        versionedWatchEventPtr<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"WatchEvent"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        versionedWatchEvent <span class="token operator">=</span> <span class="token function">indirectArbitraryPointer</span><span class="token punctuation">(</span>versionedWatchEventPtr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> <span class="token punctuation">(</span>
        connectOptions             runtime<span class="token punctuation">.</span>Object
        versionedConnectOptions    runtime<span class="token punctuation">.</span>Object
        connectOptionsInternalKind schema<span class="token punctuation">.</span>GroupVersionKind
        connectSubpath             <span class="token builtin">bool</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> isConnecter <span class="token punctuation">{</span>
        connectOptions<span class="token punctuation">,</span> connectSubpath<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> connecter<span class="token punctuation">.</span><span class="token function">NewConnectOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> connectOptions <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            connectOptionsInternalKinds<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">.</span><span class="token function">ObjectKinds</span><span class="token punctuation">(</span>connectOptions<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>

            connectOptionsInternalKind <span class="token operator">=</span> connectOptionsInternalKinds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            versionedConnectOptions<span class="token punctuation">,</span> err <span class="token operator">=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>connectOptionsInternalKind<span class="token punctuation">.</span>Kind<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                versionedConnectOptions<span class="token punctuation">,</span> err <span class="token operator">=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>connectOptionsInternalKind<span class="token punctuation">.</span>Kind<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    allowWatchList <span class="token operator">:=</span> isWatcher <span class="token operator">&amp;&amp;</span> isLister <span class="token comment" spellcheck="true">// watching on lists is allowed only for kinds that support both watch and list.</span>
    nameParam <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">PathParameter</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"name of the "</span><span class="token operator">+</span>kind<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DataType</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">)</span>
    pathParam <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">PathParameter</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">,</span> <span class="token string">"path to the resource"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DataType</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">)</span>

    params <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>restful<span class="token punctuation">.</span>Parameter<span class="token punctuation">{</span><span class="token punctuation">}</span>
    actions <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>action<span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">var</span> resourceKind <span class="token builtin">string</span>
    kindProvider<span class="token punctuation">,</span> ok <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>KindProvider<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
        resourceKind <span class="token operator">=</span> kindProvider<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        resourceKind <span class="token operator">=</span> kind
    <span class="token punctuation">}</span>

    tableProvider<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>TableConvertor<span class="token punctuation">)</span>

    <span class="token keyword">var</span> apiResource metav1<span class="token punctuation">.</span>APIResource
    <span class="token keyword">if</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>StorageVersionHash<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        isStorageVersionProvider <span class="token operator">&amp;&amp;</span>
        storageVersionProvider<span class="token punctuation">.</span><span class="token function">StorageVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        versioner <span class="token operator">:=</span> storageVersionProvider<span class="token punctuation">.</span><span class="token function">StorageVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        gvk<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getStorageVersionKind</span><span class="token punctuation">(</span>versioner<span class="token punctuation">,</span> storage<span class="token punctuation">,</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        apiResource<span class="token punctuation">.</span>StorageVersionHash <span class="token operator">=</span> discovery<span class="token punctuation">.</span><span class="token function">StorageVersionHash</span><span class="token punctuation">(</span>gvk<span class="token punctuation">.</span>Group<span class="token punctuation">,</span> gvk<span class="token punctuation">.</span>Version<span class="token punctuation">,</span> gvk<span class="token punctuation">.</span>Kind<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Get the list of actions for the given scope.</span>
    <span class="token keyword">switch</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">!</span>namespaceScoped<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">// Handle non-namespace scoped resources like nodes.</span>
        resourcePath <span class="token operator">:=</span> resource
        resourceParams <span class="token operator">:=</span> params
        itemPath <span class="token operator">:=</span> resourcePath <span class="token operator">+</span> <span class="token string">"/{name}"</span>
        nameParams <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> nameParam<span class="token punctuation">)</span>
        proxyParams <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>nameParams<span class="token punctuation">,</span> pathParam<span class="token punctuation">)</span>
        suffix <span class="token operator">:=</span> <span class="token string">""</span>
        <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
            suffix <span class="token operator">=</span> <span class="token string">"/"</span> <span class="token operator">+</span> subresource
            itemPath <span class="token operator">=</span> itemPath <span class="token operator">+</span> suffix
            resourcePath <span class="token operator">=</span> itemPath
            resourceParams <span class="token operator">=</span> nameParams
        <span class="token punctuation">}</span>
        apiResource<span class="token punctuation">.</span>Name <span class="token operator">=</span> path
        apiResource<span class="token punctuation">.</span>Namespaced <span class="token operator">=</span> <span class="token boolean">false</span>
        apiResource<span class="token punctuation">.</span>Kind <span class="token operator">=</span> resourceKind
        namer <span class="token operator">:=</span> handlers<span class="token punctuation">.</span>ContextBasedNaming<span class="token punctuation">{</span>
            SelfLinker<span class="token punctuation">:</span>         a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Linker<span class="token punctuation">,</span>
            ClusterScoped<span class="token punctuation">:</span>      <span class="token boolean">true</span><span class="token punctuation">,</span>
            SelfLinkPathPrefix<span class="token punctuation">:</span> gpath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>prefix<span class="token punctuation">,</span> resource<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
            SelfLinkPathSuffix<span class="token punctuation">:</span> suffix<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Handler for standard REST verbs (GET, PUT, POST and DELETE).</span>
        <span class="token comment" spellcheck="true">// Add actions at the resource path: /api/apiVersion/resource</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"LIST"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isLister<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"POST"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isCreater<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"DELETECOLLECTION"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isCollectionDeleter<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// DEPRECATED in 1.11</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"WATCHLIST"</span><span class="token punctuation">,</span> <span class="token string">"watch/"</span> <span class="token operator">+</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> allowWatchList<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// Add actions at the item path: /api/apiVersion/resource/{name}</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"GET"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isGetter<span class="token punctuation">)</span>
        <span class="token keyword">if</span> getSubpath <span class="token punctuation">{</span>
            actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"GET"</span><span class="token punctuation">,</span> itemPath <span class="token operator">+</span> <span class="token string">"/{path:*}"</span><span class="token punctuation">,</span> proxyParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isGetter<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"PUT"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isUpdater<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"PATCH"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isPatcher<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"DELETE"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isGracefulDeleter<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// DEPRECATED in 1.11</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"WATCH"</span><span class="token punctuation">,</span> <span class="token string">"watch/"</span> <span class="token operator">+</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isWatcher<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"CONNECT"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isConnecter<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"CONNECT"</span><span class="token punctuation">,</span> itemPath <span class="token operator">+</span> <span class="token string">"/{path:*}"</span><span class="token punctuation">,</span> proxyParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isConnecter <span class="token operator">&amp;&amp;</span> connectSubpath<span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        namespaceParamName <span class="token operator">:=</span> <span class="token string">"namespaces"</span>
        <span class="token comment" spellcheck="true">// Handler for standard REST verbs (GET, PUT, POST and DELETE).</span>
        namespaceParam <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">PathParameter</span><span class="token punctuation">(</span><span class="token string">"namespace"</span><span class="token punctuation">,</span> <span class="token string">"object name and auth scope, such as for teams and projects"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DataType</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">)</span>
        namespacedPath <span class="token operator">:=</span> namespaceParamName <span class="token operator">+</span> <span class="token string">"/{namespace}/"</span> <span class="token operator">+</span> resource
        namespaceParams <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>restful<span class="token punctuation">.</span>Parameter<span class="token punctuation">{</span>namespaceParam<span class="token punctuation">}</span>

        resourcePath <span class="token operator">:=</span> namespacedPath
        resourceParams <span class="token operator">:=</span> namespaceParams
        itemPath <span class="token operator">:=</span> namespacedPath <span class="token operator">+</span> <span class="token string">"/{name}"</span>
        nameParams <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>namespaceParams<span class="token punctuation">,</span> nameParam<span class="token punctuation">)</span>
        proxyParams <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>nameParams<span class="token punctuation">,</span> pathParam<span class="token punctuation">)</span>
        itemPathSuffix <span class="token operator">:=</span> <span class="token string">""</span>
        <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
            itemPathSuffix <span class="token operator">=</span> <span class="token string">"/"</span> <span class="token operator">+</span> subresource
            itemPath <span class="token operator">=</span> itemPath <span class="token operator">+</span> itemPathSuffix
            resourcePath <span class="token operator">=</span> itemPath
            resourceParams <span class="token operator">=</span> nameParams
        <span class="token punctuation">}</span>
        apiResource<span class="token punctuation">.</span>Name <span class="token operator">=</span> path
        apiResource<span class="token punctuation">.</span>Namespaced <span class="token operator">=</span> <span class="token boolean">true</span>
        apiResource<span class="token punctuation">.</span>Kind <span class="token operator">=</span> resourceKind
        namer <span class="token operator">:=</span> handlers<span class="token punctuation">.</span>ContextBasedNaming<span class="token punctuation">{</span>
            SelfLinker<span class="token punctuation">:</span>         a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Linker<span class="token punctuation">,</span>
            ClusterScoped<span class="token punctuation">:</span>      <span class="token boolean">false</span><span class="token punctuation">,</span>
            SelfLinkPathPrefix<span class="token punctuation">:</span> gpath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>prefix<span class="token punctuation">,</span> namespaceParamName<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
            SelfLinkPathSuffix<span class="token punctuation">:</span> itemPathSuffix<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"LIST"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isLister<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"POST"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isCreater<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"DELETECOLLECTION"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isCollectionDeleter<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// DEPRECATED in 1.11</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"WATCHLIST"</span><span class="token punctuation">,</span> <span class="token string">"watch/"</span> <span class="token operator">+</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> allowWatchList<span class="token punctuation">)</span>

        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"GET"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isGetter<span class="token punctuation">)</span>
        <span class="token keyword">if</span> getSubpath <span class="token punctuation">{</span>
            actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"GET"</span><span class="token punctuation">,</span> itemPath <span class="token operator">+</span> <span class="token string">"/{path:*}"</span><span class="token punctuation">,</span> proxyParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isGetter<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"PUT"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isUpdater<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"PATCH"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isPatcher<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"DELETE"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isGracefulDeleter<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// DEPRECATED in 1.11</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"WATCH"</span><span class="token punctuation">,</span> <span class="token string">"watch/"</span> <span class="token operator">+</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isWatcher<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"CONNECT"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isConnecter<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"CONNECT"</span><span class="token punctuation">,</span> itemPath <span class="token operator">+</span> <span class="token string">"/{path:*}"</span><span class="token punctuation">,</span> proxyParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isConnecter <span class="token operator">&amp;&amp;</span> connectSubpath<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// list or post across namespace.</span>
        <span class="token comment" spellcheck="true">// For ex: LIST all pods in all namespaces by sending a LIST request at /api/apiVersion/pods.</span>
        <span class="token comment" spellcheck="true">// TODO: more strongly type whether a resource allows these actions on "all namespaces" (bulk delete)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>isSubresource <span class="token punctuation">{</span>
            actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"LIST"</span><span class="token punctuation">,</span> resource<span class="token punctuation">,</span> params<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isLister<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// DEPRECATED in 1.11</span>
            actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"WATCHLIST"</span><span class="token punctuation">,</span> <span class="token string">"watch/"</span> <span class="token operator">+</span> resource<span class="token punctuation">,</span> params<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> allowWatchList<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// Create Routes for the actions.</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> s <span class="token operator">:=</span> <span class="token keyword">range</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Serializer<span class="token punctuation">.</span><span class="token function">SupportedMediaTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>MediaTypeSubType<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>MediaTypeType<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"all serializers in the group Serializer must have MediaTypeType and MediaTypeSubType set: %s"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>MediaType<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    mediaTypes<span class="token punctuation">,</span> streamMediaTypes <span class="token operator">:=</span> negotiation<span class="token punctuation">.</span><span class="token function">MediaTypesForSerializer</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span>
    allMediaTypes <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>mediaTypes<span class="token punctuation">,</span> streamMediaTypes<span class="token operator">...</span><span class="token punctuation">)</span>
    ws<span class="token punctuation">.</span><span class="token function">Produces</span><span class="token punctuation">(</span>allMediaTypes<span class="token operator">...</span><span class="token punctuation">)</span>

    kubeVerbs <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    reqScope <span class="token operator">:=</span> handlers<span class="token punctuation">.</span>RequestScope<span class="token punctuation">{</span>
        Serializer<span class="token punctuation">:</span>      a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span>
        ParameterCodec<span class="token punctuation">:</span>  a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>ParameterCodec<span class="token punctuation">,</span>
        Creater<span class="token punctuation">:</span>         a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">,</span>
        Convertor<span class="token punctuation">:</span>       a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Convertor<span class="token punctuation">,</span>
        Defaulter<span class="token punctuation">:</span>       a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Defaulter<span class="token punctuation">,</span>
        Typer<span class="token punctuation">:</span>           a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">,</span>
        UnsafeConvertor<span class="token punctuation">:</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>UnsafeConvertor<span class="token punctuation">,</span>
        Authorizer<span class="token punctuation">:</span>      a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span>

        EquivalentResourceMapper<span class="token punctuation">:</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>EquivalentResourceRegistry<span class="token punctuation">,</span>

        <span class="token comment" spellcheck="true">// TODO: Check for the interface on storage</span>
        TableConvertor<span class="token punctuation">:</span> tableProvider<span class="token punctuation">,</span>

        <span class="token comment" spellcheck="true">// TODO: This seems wrong for cross-group subresources. It makes an assumption that a subresource and its parent are in the same group version. Revisit this.</span>
        Resource<span class="token punctuation">:</span>    a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span><span class="token function">WithResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">,</span>
        Subresource<span class="token punctuation">:</span> subresource<span class="token punctuation">,</span>
        Kind<span class="token punctuation">:</span>        fqKindToRegister<span class="token punctuation">,</span>

        HubGroupVersion<span class="token punctuation">:</span> schema<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span>Group<span class="token punctuation">:</span> fqKindToRegister<span class="token punctuation">.</span>Group<span class="token punctuation">,</span> Version<span class="token punctuation">:</span> runtime<span class="token punctuation">.</span>APIVersionInternal<span class="token punctuation">}</span><span class="token punctuation">,</span>

        MetaGroupVersion<span class="token punctuation">:</span> metav1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">,</span>

        MaxRequestBodyBytes<span class="token punctuation">:</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>MaxRequestBodyBytes<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>MetaGroupVersion <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        reqScope<span class="token punctuation">.</span>MetaGroupVersion <span class="token operator">=</span> <span class="token operator">*</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>MetaGroupVersion
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>OpenAPIModels <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>ServerSideApply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        reqScope<span class="token punctuation">.</span>FieldManager<span class="token punctuation">,</span> err <span class="token operator">=</span> fieldmanager<span class="token punctuation">.</span><span class="token function">NewDefaultFieldManager</span><span class="token punctuation">(</span>
            a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>OpenAPIModels<span class="token punctuation">,</span>
            a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>UnsafeConvertor<span class="token punctuation">,</span>
            a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Defaulter<span class="token punctuation">,</span>
            a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">,</span>
            fqKindToRegister<span class="token punctuation">,</span>
            reqScope<span class="token punctuation">.</span>HubGroupVersion<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create field manager: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> action <span class="token operator">:=</span> <span class="token keyword">range</span> actions <span class="token punctuation">{</span>
        producedObject <span class="token operator">:=</span> storageMeta<span class="token punctuation">.</span><span class="token function">ProducesObject</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span>
        <span class="token keyword">if</span> producedObject <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            producedObject <span class="token operator">=</span> defaultVersionedObject
        <span class="token punctuation">}</span>
        reqScope<span class="token punctuation">.</span>Namer <span class="token operator">=</span> action<span class="token punctuation">.</span>Namer

        requestScope <span class="token operator">:=</span> <span class="token string">"cluster"</span>
        <span class="token keyword">var</span> namespaced <span class="token builtin">string</span>
        <span class="token keyword">var</span> operationSuffix <span class="token builtin">string</span>
        <span class="token keyword">if</span> apiResource<span class="token punctuation">.</span>Namespaced <span class="token punctuation">{</span>
            requestScope <span class="token operator">=</span> <span class="token string">"namespace"</span>
            namespaced <span class="token operator">=</span> <span class="token string">"Namespaced"</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token string">"/{path:*}"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            requestScope <span class="token operator">=</span> <span class="token string">"resource"</span>
            operationSuffix <span class="token operator">=</span> operationSuffix <span class="token operator">+</span> <span class="token string">"WithPath"</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> action<span class="token punctuation">.</span>AllNamespaces <span class="token punctuation">{</span>
            requestScope <span class="token operator">=</span> <span class="token string">"cluster"</span>
            operationSuffix <span class="token operator">=</span> operationSuffix <span class="token operator">+</span> <span class="token string">"ForAllNamespaces"</span>
            namespaced <span class="token operator">=</span> <span class="token string">""</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> kubeVerb<span class="token punctuation">,</span> found <span class="token operator">:=</span> toDiscoveryKubeVerb<span class="token punctuation">[</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">]</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>kubeVerb<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                kubeVerbs<span class="token punctuation">[</span>kubeVerb<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unknown action verb for discovery: %s"</span><span class="token punctuation">,</span> action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        routes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>restful<span class="token punctuation">.</span>RouteBuilder<span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// If there is a subresource, kind should be the parent's kind.</span>
        <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
            parentStorage<span class="token punctuation">,</span> ok <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Storage<span class="token punctuation">[</span>resource<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"missing parent storage: %q"</span><span class="token punctuation">,</span> resource<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            fqParentKind<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">GetResourceKind</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">,</span> parentStorage<span class="token punctuation">,</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            kind <span class="token operator">=</span> fqParentKind<span class="token punctuation">.</span>Kind
        <span class="token punctuation">}</span>

        verbOverrider<span class="token punctuation">,</span> needOverride <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>StorageMetricsOverride<span class="token punctuation">)</span>

        <span class="token keyword">switch</span> action<span class="token punctuation">.</span>Verb <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">"GET"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Get a resource.</span>
            <span class="token keyword">var</span> handler restful<span class="token punctuation">.</span>RouteFunction
            <span class="token keyword">if</span> isGetterWithOptions <span class="token punctuation">{</span>
                handler <span class="token operator">=</span> <span class="token function">restfulGetResourceWithOptions</span><span class="token punctuation">(</span>getterWithOptions<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> isSubresource<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                handler <span class="token operator">=</span> <span class="token function">restfulGetResource</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> exporter<span class="token punctuation">,</span> reqScope<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> needOverride <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// need change the reported verb</span>
                handler <span class="token operator">=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>verbOverrider<span class="token punctuation">.</span><span class="token function">OverrideMetricsVerb</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                handler <span class="token operator">=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            doc <span class="token operator">:=</span> <span class="token string">"read the specified "</span> <span class="token operator">+</span> kind
            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
                doc <span class="token operator">=</span> <span class="token string">"read "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of the specified "</span> <span class="token operator">+</span> kind
            <span class="token punctuation">}</span>
            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Writes</span><span class="token punctuation">(</span>producedObject<span class="token punctuation">)</span>
            <span class="token keyword">if</span> isGetterWithOptions <span class="token punctuation">{</span>
                <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedGetOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> isExporter <span class="token punctuation">{</span>
                <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedExportOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>
            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token string">"LIST"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// List all resources of a kind.</span>
            doc <span class="token operator">:=</span> <span class="token string">"list objects of kind "</span> <span class="token operator">+</span> kind
            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
                doc <span class="token operator">=</span> <span class="token string">"list "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of objects of kind "</span> <span class="token operator">+</span> kind
            <span class="token punctuation">}</span>
            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulListResource</span><span class="token punctuation">(</span>lister<span class="token punctuation">,</span> watcher<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>minRequestTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span>
            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"list"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> allMediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> versionedList<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Writes</span><span class="token punctuation">(</span>versionedList<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedListOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            <span class="token keyword">switch</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> isLister <span class="token operator">&amp;&amp;</span> isWatcher<span class="token punctuation">:</span>
                doc <span class="token operator">:=</span> <span class="token string">"list or watch objects of kind "</span> <span class="token operator">+</span> kind
                <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
                    doc <span class="token operator">=</span> <span class="token string">"list or watch "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of objects of kind "</span> <span class="token operator">+</span> kind
                <span class="token punctuation">}</span>
                route<span class="token punctuation">.</span><span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
            <span class="token keyword">case</span> isWatcher<span class="token punctuation">:</span>
                doc <span class="token operator">:=</span> <span class="token string">"watch objects of kind "</span> <span class="token operator">+</span> kind
                <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
                    doc <span class="token operator">=</span> <span class="token string">"watch "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">"of objects of kind "</span> <span class="token operator">+</span> kind
                <span class="token punctuation">}</span>
                route<span class="token punctuation">.</span><span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>
            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token string">"PUT"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Update a resource.</span>
            doc <span class="token operator">:=</span> <span class="token string">"replace the specified "</span> <span class="token operator">+</span> kind
            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
                doc <span class="token operator">=</span> <span class="token string">"replace "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of the specified "</span> <span class="token operator">+</span> kind
            <span class="token punctuation">}</span>
            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulUpdateResource</span><span class="token punctuation">(</span>updater<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span><span class="token punctuation">)</span>
            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">PUT</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"replace"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token comment" spellcheck="true">// TODO: in some cases, the API may return a v1.Status instead of the versioned object</span>
                <span class="token comment" spellcheck="true">// but currently go-restful can't handle multiple different objects being returned.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusCreated<span class="token punctuation">,</span> <span class="token string">"Created"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Reads</span><span class="token punctuation">(</span>defaultVersionedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Writes</span><span class="token punctuation">(</span>producedObject<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedUpdateOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>
            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token string">"PATCH"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Partially update a resource</span>
            doc <span class="token operator">:=</span> <span class="token string">"partially update the specified "</span> <span class="token operator">+</span> kind
            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
                doc <span class="token operator">=</span> <span class="token string">"partially update "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of the specified "</span> <span class="token operator">+</span> kind
            <span class="token punctuation">}</span>
            supportedTypes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
                <span class="token function">string</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>JSONPatchType<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">string</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>MergePatchType<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">string</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>StrategicMergePatchType<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>ServerSideApply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                supportedTypes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>supportedTypes<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ApplyPatchType<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulPatchResource</span><span class="token punctuation">(</span>patcher<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">,</span> supportedTypes<span class="token punctuation">)</span><span class="token punctuation">)</span>
            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">PATCH</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Consumes</span><span class="token punctuation">(</span>supportedTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"patch"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Reads</span><span class="token punctuation">(</span>metav1<span class="token punctuation">.</span>Patch<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Writes</span><span class="token punctuation">(</span>producedObject<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedPatchOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>
            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token string">"POST"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Create a resource.</span>
            <span class="token keyword">var</span> handler restful<span class="token punctuation">.</span>RouteFunction
            <span class="token keyword">if</span> isNamedCreater <span class="token punctuation">{</span>
                handler <span class="token operator">=</span> <span class="token function">restfulCreateNamedResource</span><span class="token punctuation">(</span>namedCreater<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                handler <span class="token operator">=</span> <span class="token function">restfulCreateResource</span><span class="token punctuation">(</span>creater<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            handler <span class="token operator">=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
            article <span class="token operator">:=</span> <span class="token function">GetArticleForNoun</span><span class="token punctuation">(</span>kind<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>
            doc <span class="token operator">:=</span> <span class="token string">"create"</span> <span class="token operator">+</span> article <span class="token operator">+</span> kind
            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
                doc <span class="token operator">=</span> <span class="token string">"create "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of"</span> <span class="token operator">+</span> article <span class="token operator">+</span> kind
            <span class="token punctuation">}</span>
            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"create"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token comment" spellcheck="true">// TODO: in some cases, the API may return a v1.Status instead of the versioned object</span>
                <span class="token comment" spellcheck="true">// but currently go-restful can't handle multiple different objects being returned.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusCreated<span class="token punctuation">,</span> <span class="token string">"Created"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusAccepted<span class="token punctuation">,</span> <span class="token string">"Accepted"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Reads</span><span class="token punctuation">(</span>defaultVersionedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Writes</span><span class="token punctuation">(</span>producedObject<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedCreateOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>
            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token string">"DELETE"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Delete a resource.</span>
            article <span class="token operator">:=</span> <span class="token function">GetArticleForNoun</span><span class="token punctuation">(</span>kind<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>
            doc <span class="token operator">:=</span> <span class="token string">"delete"</span> <span class="token operator">+</span> article <span class="token operator">+</span> kind
            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
                doc <span class="token operator">=</span> <span class="token string">"delete "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of"</span> <span class="token operator">+</span> article <span class="token operator">+</span> kind
            <span class="token punctuation">}</span>
            deleteReturnType <span class="token operator">:=</span> versionedStatus
            <span class="token keyword">if</span> deleteReturnsDeletedObject <span class="token punctuation">{</span>
                deleteReturnType <span class="token operator">=</span> producedObject
            <span class="token punctuation">}</span>
            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulDeleteResource</span><span class="token punctuation">(</span>gracefulDeleter<span class="token punctuation">,</span> isGracefulDeleter<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span><span class="token punctuation">)</span>
            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"delete"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Writes</span><span class="token punctuation">(</span>deleteReturnType<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> deleteReturnType<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusAccepted<span class="token punctuation">,</span> <span class="token string">"Accepted"</span><span class="token punctuation">,</span> deleteReturnType<span class="token punctuation">)</span>
            <span class="token keyword">if</span> isGracefulDeleter <span class="token punctuation">{</span>
                route<span class="token punctuation">.</span><span class="token function">Reads</span><span class="token punctuation">(</span>versionedDeleterObject<span class="token punctuation">)</span>
                route<span class="token punctuation">.</span><span class="token function">ParameterNamed</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Required</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedDeleteOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>
            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token string">"DELETECOLLECTION"</span><span class="token punctuation">:</span>
            doc <span class="token operator">:=</span> <span class="token string">"delete collection of "</span> <span class="token operator">+</span> kind
            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
                doc <span class="token operator">=</span> <span class="token string">"delete collection of "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of a "</span> <span class="token operator">+</span> kind
            <span class="token punctuation">}</span>
            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulDeleteCollection</span><span class="token punctuation">(</span>collectionDeleter<span class="token punctuation">,</span> isCollectionDeleter<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span><span class="token punctuation">)</span>
            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"deletecollection"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Writes</span><span class="token punctuation">(</span>versionedStatus<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> versionedStatus<span class="token punctuation">)</span>
            <span class="token keyword">if</span> isCollectionDeleter <span class="token punctuation">{</span>
                route<span class="token punctuation">.</span><span class="token function">Reads</span><span class="token punctuation">(</span>versionedDeleterObject<span class="token punctuation">)</span>
                route<span class="token punctuation">.</span><span class="token function">ParameterNamed</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Required</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedDeleteOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedListOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>
            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// deprecated in 1.11</span>
        <span class="token keyword">case</span> <span class="token string">"WATCH"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Watch a resource.</span>
            doc <span class="token operator">:=</span> <span class="token string">"watch changes to an object of kind "</span> <span class="token operator">+</span> kind
            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
                doc <span class="token operator">=</span> <span class="token string">"watch changes to "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of an object of kind "</span> <span class="token operator">+</span> kind
            <span class="token punctuation">}</span>
            doc <span class="token operator">+=</span> <span class="token string">". deprecated: use the 'watch' parameter with a list operation instead, filtered to a single item with the 'fieldSelector' parameter."</span>
            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulListResource</span><span class="token punctuation">(</span>lister<span class="token punctuation">,</span> watcher<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>minRequestTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span>
            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"watch"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Produces</span><span class="token punctuation">(</span>allMediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> versionedWatchEvent<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Writes</span><span class="token punctuation">(</span>versionedWatchEvent<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedListOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>
            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// deprecated in 1.11</span>
        <span class="token keyword">case</span> <span class="token string">"WATCHLIST"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Watch all resources of a kind.</span>
            doc <span class="token operator">:=</span> <span class="token string">"watch individual changes to a list of "</span> <span class="token operator">+</span> kind
            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
                doc <span class="token operator">=</span> <span class="token string">"watch individual changes to a list of "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of "</span> <span class="token operator">+</span> kind
            <span class="token punctuation">}</span>
            doc <span class="token operator">+=</span> <span class="token string">". deprecated: use the 'watch' parameter with a list operation instead."</span>
            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulListResource</span><span class="token punctuation">(</span>lister<span class="token punctuation">,</span> watcher<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>minRequestTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span>
            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"watch"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"List"</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Produces</span><span class="token punctuation">(</span>allMediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> versionedWatchEvent<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Writes</span><span class="token punctuation">(</span>versionedWatchEvent<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedListOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>
            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token string">"CONNECT"</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> method <span class="token operator">:=</span> <span class="token keyword">range</span> connecter<span class="token punctuation">.</span><span class="token function">ConnectMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                connectProducedObject <span class="token operator">:=</span> storageMeta<span class="token punctuation">.</span><span class="token function">ProducesObject</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span>
                <span class="token keyword">if</span> connectProducedObject <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    connectProducedObject <span class="token operator">=</span> <span class="token string">"string"</span>
                <span class="token punctuation">}</span>
                doc <span class="token operator">:=</span> <span class="token string">"connect "</span> <span class="token operator">+</span> method <span class="token operator">+</span> <span class="token string">" requests to "</span> <span class="token operator">+</span> kind
                <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>
                    doc <span class="token operator">=</span> <span class="token string">"connect "</span> <span class="token operator">+</span> method <span class="token operator">+</span> <span class="token string">" requests to "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of "</span> <span class="token operator">+</span> kind
                <span class="token punctuation">}</span>
                handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulConnectResource</span><span class="token punctuation">(</span>connecter<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">,</span> path<span class="token punctuation">,</span> isSubresource<span class="token punctuation">)</span><span class="token punctuation">)</span>
                route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span>
                    <span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>
                    <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>
                    <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"connect"</span> <span class="token operator">+</span> strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> namespaced <span class="token operator">+</span> kind <span class="token operator">+</span> strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span> <span class="token operator">+</span> operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>
                    <span class="token function">Produces</span><span class="token punctuation">(</span>"<span class="token operator">*</span><span class="token comment" spellcheck="true">/*").
                    Consumes("*/</span><span class="token operator">*</span>"<span class="token punctuation">)</span><span class="token punctuation">.</span>
                    <span class="token function">Writes</span><span class="token punctuation">(</span>connectProducedObject<span class="token punctuation">)</span>
                <span class="token keyword">if</span> versionedConnectOptions <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedConnectOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>
                routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>

                <span class="token comment" spellcheck="true">// transform ConnectMethods to kube verbs</span>
                <span class="token keyword">if</span> kubeVerb<span class="token punctuation">,</span> found <span class="token operator">:=</span> toDiscoveryKubeVerb<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>kubeVerb<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                        kubeVerbs<span class="token punctuation">[</span>kubeVerb<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unrecognized action verb: %s"</span><span class="token punctuation">,</span> action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> route <span class="token operator">:=</span> <span class="token keyword">range</span> routes <span class="token punctuation">{</span>
            route<span class="token punctuation">.</span><span class="token function">Metadata</span><span class="token punctuation">(</span>ROUTE_META_GVK<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">{</span>
                Group<span class="token punctuation">:</span>   reqScope<span class="token punctuation">.</span>Kind<span class="token punctuation">.</span>Group<span class="token punctuation">,</span>
                Version<span class="token punctuation">:</span> reqScope<span class="token punctuation">.</span>Kind<span class="token punctuation">.</span>Version<span class="token punctuation">,</span>
                Kind<span class="token punctuation">:</span>    reqScope<span class="token punctuation">.</span>Kind<span class="token punctuation">.</span>Kind<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            route<span class="token punctuation">.</span><span class="token function">Metadata</span><span class="token punctuation">(</span>ROUTE_META_ACTION<span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">)</span>
            ws<span class="token punctuation">.</span><span class="token function">Route</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Note: update GetAuthorizerAttributes() when adding a custom handler.</span>
    <span class="token punctuation">}</span>

    apiResource<span class="token punctuation">.</span>Verbs <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>kubeVerbs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> kubeVerb <span class="token operator">:=</span> <span class="token keyword">range</span> kubeVerbs <span class="token punctuation">{</span>
        apiResource<span class="token punctuation">.</span>Verbs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>apiResource<span class="token punctuation">.</span>Verbs<span class="token punctuation">,</span> kubeVerb<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    sort<span class="token punctuation">.</span><span class="token function">Strings</span><span class="token punctuation">(</span>apiResource<span class="token punctuation">.</span>Verbs<span class="token punctuation">)</span>

    <span class="token keyword">if</span> shortNamesProvider<span class="token punctuation">,</span> ok <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>ShortNamesProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        apiResource<span class="token punctuation">.</span>ShortNames <span class="token operator">=</span> shortNamesProvider<span class="token punctuation">.</span><span class="token function">ShortNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> categoriesProvider<span class="token punctuation">,</span> ok <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>CategoriesProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        apiResource<span class="token punctuation">.</span>Categories <span class="token operator">=</span> categoriesProvider<span class="token punctuation">.</span><span class="token function">Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> gvkProvider<span class="token punctuation">,</span> ok <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>GroupVersionKindProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        gvk <span class="token operator">:=</span> gvkProvider<span class="token punctuation">.</span><span class="token function">GroupVersionKind</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">)</span>
        apiResource<span class="token punctuation">.</span>Group <span class="token operator">=</span> gvk<span class="token punctuation">.</span>Group
        apiResource<span class="token punctuation">.</span>Version <span class="token operator">=</span> gvk<span class="token punctuation">.</span>Version
        apiResource<span class="token punctuation">.</span>Kind <span class="token operator">=</span> gvk<span class="token punctuation">.</span>Kind
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Record the existence of the GVR and the corresponding GVK</span>
    a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>EquivalentResourceRegistry<span class="token punctuation">.</span><span class="token function">RegisterKindFor</span><span class="token punctuation">(</span>reqScope<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> reqScope<span class="token punctuation">.</span>Subresource<span class="token punctuation">,</span> fqKindToRegister<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>apiResource<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="API-server-存储"><a href="#API-server-存储" class="headerlink" title="API server 存储"></a>API server 存储</h3><h4 id="registry"><a href="#registry" class="headerlink" title="registry"></a>registry</h4><p>在 Kubernetes中，registry 可以对 ETCD中 的 Kubernetes 各类型进行增删查改操作，并对外提供了生成apiGroupInfo 的方法。这里的 registry 包含了两层含义，Storage 和 Registry，如 NodeStorage 和NodeRegistry。Storage 提供了通用的增删查改方法，Regsitry 是对Storage的封装，提供了具体类型的增删查改方法。registry定义在<code>/pkg/registry</code>目录下，主要包含：</p>
<ul>
<li>admissionregistration:  定义 admission 相关的 registry 信息</li>
</ul>
<ul>
<li>apps: 定义statefulsets相关的registry信息；</li>
<li>authentication: 定义tokenreview相关的registry信息；</li>
<li>authorization: 定义localsubjectaccessreview, selfsubjectaccessreview, subjectaccessreview相关的registry信息；</li>
<li>autoscaling: 定义horizontalpodautoscaler相关的registry信息；</li>
<li>batch: 定义scheduledjobs相关的registry信息；</li>
<li>certificates: 定义certificatesigningrequests相关的registry信息；</li>
<li>core: 定义componentstatus, configmap, controller, endpoint, event, limitrange, namespace, node, persistentvolume, persistentvolumeclaim, pod, podtemplate, rangeallocation, resourcequota, secret, service, serviceaccount的registry信息；</li>
<li>extensions: 定义replicationcontrollers, daemonset, deployment, ingress, networkpolicy, podsecuritypolicy, replicaset等相关的registry信息；</li>
<li>generic: 公共模块，对storage模块进行封装；</li>
<li>policy: 定义poddisruptionbudgets相关的registry信息；</li>
<li>rbac: 定义cluserrole, role等相关的registry信息；</li>
<li>storage: 定义storageclass相关的registry信息。</li>
</ul>
<p>每个子目录都对应一个APIGroup，如core对应的是v1，每个子目录下都有个rest的目录，其中core目录实现了NewLegacyRESTStorage()方法生成对应的apiGroupInfo，其他目录实现了NewRESTStorage()方法生成对应的apiGroupInfo。apiGroupInfo是联系registry和apiserver的通道。</p>
<p>在NewLegacyRESTStorage()方法中，会调用NewStorage()生成storage，如nodeStorage等，进一步地生成restStorageMap，然后生成apiGroupInfo。</p>
<p>其他APIGroup使用NewRESTStorage()，会调用NewREST()生成storage，如rolesStorage。</p>
<p>我们以core包下的node为例来看下NewStorage()的实现，以rbac包下的role为例来看下NewREST()的实现。</p>
<h5 id="nodeStorage"><a href="#nodeStorage" class="headerlink" title="nodeStorage"></a>nodeStorage</h5><p>node定义在<code>/pkg/registry/core/node</code>目录下。我们先来看下<code>/pkg/registry/core/rest/storage_core.go</code>中的NewLegacyRESTStorage()是如何生成 nodeStorage 的，代码如下：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c LegacyRESTStorageProvider<span class="token punctuation">)</span> <span class="token function">NewLegacyRESTStorage</span><span class="token punctuation">(</span>restOptionsGetter generic<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">)</span> <span class="token punctuation">(</span>LegacyRESTStorage<span class="token punctuation">,</span> genericapiserver<span class="token punctuation">.</span>APIGroupInfo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    apiGroupInfo <span class="token operator">:=</span> genericapiserver<span class="token punctuation">.</span>APIGroupInfo<span class="token punctuation">{</span>
        PrioritizedVersions<span class="token punctuation">:</span>          legacyscheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">.</span><span class="token function">PrioritizedVersionsForGroup</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        VersionedResourcesStorageMap<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>rest<span class="token punctuation">.</span>Storage<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        Scheme<span class="token punctuation">:</span>                       legacyscheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span>
        ParameterCodec<span class="token punctuation">:</span>               legacyscheme<span class="token punctuation">.</span>ParameterCodec<span class="token punctuation">,</span>
        NegotiatedSerializer<span class="token punctuation">:</span>         legacyscheme<span class="token punctuation">.</span>Codecs<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token operator">...</span>
    restStorage <span class="token operator">:=</span> LegacyRESTStorage<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token operator">...</span><span class="token punctuation">.</span>
    nodeStorage<span class="token punctuation">,</span> err <span class="token operator">:=</span> nodestore<span class="token punctuation">.</span><span class="token function">NewStorage</span><span class="token punctuation">(</span>restOptionsGetter<span class="token punctuation">,</span> c<span class="token punctuation">.</span>KubeletClientConfig<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ProxyTransport<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> LegacyRESTStorage<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> genericapiserver<span class="token punctuation">.</span>APIGroupInfo<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">///</span>
    apiGroupInfo<span class="token punctuation">.</span>VersionedResourcesStorageMap<span class="token punctuation">[</span><span class="token string">"v1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> restStorageMap

    <span class="token keyword">return</span> restStorage<span class="token punctuation">,</span> apiGroupInfo<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span></code></pre>
<h5 id="NewStorage"><a href="#NewStorage" class="headerlink" title="NewStorage"></a>NewStorage</h5><p>node的NewStorage()定义在<code>/pkg/registry/core/node/storage/storage.go</code>中，主要流程如下：</p>
<ol>
<li>生成store，store为genericStore</li>
<li>生成nodeREST;</li>
<li>生成NodeStorage。</li>
</ol>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewStorage</span><span class="token punctuation">(</span>optsGetter generic<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> kubeletClientConfig client<span class="token punctuation">.</span>KubeletClientConfig<span class="token punctuation">,</span> proxyTransport http<span class="token punctuation">.</span>RoundTripper<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>NodeStorage<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    store <span class="token operator">:=</span> <span class="token operator">&amp;</span>genericregistry<span class="token punctuation">.</span>Store<span class="token punctuation">{</span>
        NewFunc<span class="token punctuation">:</span>                  <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> runtime<span class="token punctuation">.</span>Object <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>Node<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        NewListFunc<span class="token punctuation">:</span>              <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> runtime<span class="token punctuation">.</span>Object <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>NodeList<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        PredicateFunc<span class="token punctuation">:</span>            node<span class="token punctuation">.</span>MatchNode<span class="token punctuation">,</span>
        DefaultQualifiedResource<span class="token punctuation">:</span> api<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"nodes"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        CreateStrategy<span class="token punctuation">:</span> node<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>
        UpdateStrategy<span class="token punctuation">:</span> node<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>
        DeleteStrategy<span class="token punctuation">:</span> node<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>
        ExportStrategy<span class="token punctuation">:</span> node<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>

        TableConvertor<span class="token punctuation">:</span> printerstorage<span class="token punctuation">.</span>TableConvertor<span class="token punctuation">{</span>TableGenerator<span class="token punctuation">:</span> printers<span class="token punctuation">.</span><span class="token function">NewTableGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>printersinternal<span class="token punctuation">.</span>AddHandlers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    options <span class="token operator">:=</span> <span class="token operator">&amp;</span>generic<span class="token punctuation">.</span>StoreOptions<span class="token punctuation">{</span>
        RESTOptions<span class="token punctuation">:</span> optsGetter<span class="token punctuation">,</span>
        AttrFunc<span class="token punctuation">:</span>    node<span class="token punctuation">.</span>GetAttrs<span class="token punctuation">,</span>
        TriggerFunc<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>storage<span class="token punctuation">.</span>IndexerFunc<span class="token punctuation">{</span><span class="token string">"metadata.name"</span><span class="token punctuation">:</span> node<span class="token punctuation">.</span>NameTriggerFunc<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">CompleteWithOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    statusStore <span class="token operator">:=</span> <span class="token operator">*</span>store
    statusStore<span class="token punctuation">.</span>UpdateStrategy <span class="token operator">=</span> node<span class="token punctuation">.</span>StatusStrategy

    <span class="token comment" spellcheck="true">// Set up REST handlers</span>
    nodeREST <span class="token operator">:=</span> <span class="token operator">&amp;</span>REST<span class="token punctuation">{</span>Store<span class="token punctuation">:</span> store<span class="token punctuation">,</span> proxyTransport<span class="token punctuation">:</span> proxyTransport<span class="token punctuation">}</span>
    statusREST <span class="token operator">:=</span> <span class="token operator">&amp;</span>StatusREST<span class="token punctuation">{</span>store<span class="token punctuation">:</span> <span class="token operator">&amp;</span>statusStore<span class="token punctuation">}</span>
    proxyREST <span class="token operator">:=</span> <span class="token operator">&amp;</span>noderest<span class="token punctuation">.</span>ProxyREST<span class="token punctuation">{</span>Store<span class="token punctuation">:</span> store<span class="token punctuation">,</span> ProxyTransport<span class="token punctuation">:</span> proxyTransport<span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Build a NodeGetter that looks up nodes using the REST handler</span>
    nodeGetter <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">NodeGetterFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">,</span> options metav1<span class="token punctuation">.</span>GetOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        obj<span class="token punctuation">,</span> err <span class="token operator">:=</span> nodeREST<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> nodeName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>options<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        node<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>Node<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unexpected type %T"</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// TODO: Remove the conversion. Consider only return the NodeAddresses</span>
        externalNode <span class="token operator">:=</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">{</span><span class="token punctuation">}</span>
        err <span class="token operator">=</span> k8s_api_v1<span class="token punctuation">.</span><span class="token function">Convert_core_Node_To_v1_Node</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> externalNode<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to convert to v1.Node: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> externalNode<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    connectionInfoGetter<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">NewNodeConnectionInfoGetter</span><span class="token punctuation">(</span>nodeGetter<span class="token punctuation">,</span> kubeletClientConfig<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    nodeREST<span class="token punctuation">.</span>connection <span class="token operator">=</span> connectionInfoGetter
    proxyREST<span class="token punctuation">.</span>Connection <span class="token operator">=</span> connectionInfoGetter

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>NodeStorage<span class="token punctuation">{</span>
        Node<span class="token punctuation">:</span>                  nodeREST<span class="token punctuation">,</span>
        Status<span class="token punctuation">:</span>                statusREST<span class="token punctuation">,</span>
        Proxy<span class="token punctuation">:</span>                 proxyREST<span class="token punctuation">,</span>
        KubeletConnectionInfo<span class="token punctuation">:</span> connectionInfoGetter<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span></code></pre>
<p>可以看出，NodeStorage 本质是一个genericStore，Store中定义有Create(), Delete(), Get(), List(), Watch()等方法。</p>
<pre class=" language-go"><code class="language-go">
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> runtime<span class="token punctuation">.</span>Object <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> options <span class="token operator">*</span>metainternalversion<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> createValidation rest<span class="token punctuation">.</span>ValidateObjectFunc<span class="token punctuation">,</span> options <span class="token operator">*</span>metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> objInfo rest<span class="token punctuation">.</span>UpdatedObjectInfo<span class="token punctuation">,</span> createValidation rest<span class="token punctuation">.</span>ValidateObjectFunc<span class="token punctuation">,</span> updateValidation rest<span class="token punctuation">.</span>ValidateObjectUpdateFunc<span class="token punctuation">,</span> forceAllowCreate <span class="token builtin">bool</span><span class="token punctuation">,</span> options <span class="token operator">*</span>metav1<span class="token punctuation">.</span>UpdateOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> options <span class="token operator">*</span>metav1<span class="token punctuation">.</span>GetOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> deleteValidation rest<span class="token punctuation">.</span>ValidateObjectFunc<span class="token punctuation">,</span> options <span class="token operator">*</span>metav1<span class="token punctuation">.</span>DeleteOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

</code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">xie hui</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://xipfs.github.io/2020/05/27/k8s03/">http://xipfs.github.io/2020/05/27/k8s03/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">xie hui</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Kubernetes/">
                                    <span class="chip bg-color">Kubernetes</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2020/05/27/k8s03/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="深入理解 Kubernetes 之 API server">
                        
                        <span class="card-title">深入理解 Kubernetes 之 API server</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            API server简介Kubernetes API server 为 api 对象验证并配置数据，包括 pods、 services、 replicationcontrollers 和其它 api 对象。API Server 提供 RES
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-05-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Kubernetes/" class="post-category">
                                    Kubernetes
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Kubernetes/">
                        <span class="chip bg-color">Kubernetes</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/05/21/k8s02/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="深入理解 Kubernetes 之 Kubectl">
                        
                        <span class="card-title">深入理解 Kubernetes 之 Kubectl</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            深入理解 Kubectlkubectl 是 Kubernetes 集群的命令行工具，通过 kubectl 能够对集群本身进行管理，并能够在集群上进行容器化应用的安装部署。运行 kubectl 命令的语法如下所示：
kubectl [comm
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-05-21
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Kubernetes/" class="post-category">
                                    Kubernetes
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Kubernetes/">
                        <span class="chip bg-color">Kubernetes</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="868680226"
                   fixed='true'
                   autoplay='true'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="/about" target="_blank">Xie hui</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">66.4k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/xipfs" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:flexie@foxmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=514591940" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 514591940" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
