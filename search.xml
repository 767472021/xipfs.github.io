<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Clion è°ƒè¯• Rust</title>
      <link href="/2020/07/17/rust/"/>
      <url>/2020/07/17/rust/</url>
      
        <content type="html"><![CDATA[<h2 id="å®‰è£…-mingw"><a href="#å®‰è£…-mingw" class="headerlink" title="å®‰è£… mingw"></a>å®‰è£… mingw</h2><p>å®‰è£… msys2 (åŒ…å« mingw-64 )</p><p>ä¸‹è½½åœ°å€  <a href="https://www.msys2.org/" target="_blank" rel="noopener">https://www.msys2.org/</a> </p><p>å¼€ä¸€ä¸ª mingw çš„ç»ˆç«¯ï¼Œå®‰è£…ç¼–è¯‘å·¥å…·ï¼š</p><pre><code> pacman -Syu pacman -S mingw-w64-x86_64-toolchain</code></pre><p>å‡è®¾å®‰è£…åœ¨ <code>c:\msys64</code> ç›®å½•ä¸‹ï¼Œåˆ™åœ¨ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ä¸­ï¼Œå¢åŠ ä¸€ä¸ªï¼š</p><pre><code> MSYS2_HOME  C:\msys64 PATH        &lt;åŸæ¥çš„è·¯&gt;;%MSYS2_HOME%\bin;%MSYS2_HOME%\mingw64\bin</code></pre><h2 id="å®‰è£…-rust-gnu-å·¥å…·é“¾"><a href="#å®‰è£…-rust-gnu-å·¥å…·é“¾" class="headerlink" title="å®‰è£… rust gnu å·¥å…·é“¾"></a>å®‰è£… rust gnu å·¥å…·é“¾</h2><p>åœ¨ windows ä¸Šä½¿ç”¨ rustup å®‰è£…çš„ rust ç¼–è¯‘ç¯å¢ƒé»˜è®¤ä½¿ç”¨äº† msvc ç¼–è¯‘é“¾ï¼Œéœ€è¦å®‰è£… gnu ç¼–è¯‘é“¾</p><pre><code> rustup install stable-gnu rustup default stable-gnu</code></pre><h2 id="è®¾ç½®-clion-ç¼–è¯‘å·¥å…·é“¾"><a href="#è®¾ç½®-clion-ç¼–è¯‘å·¥å…·é“¾" class="headerlink" title="è®¾ç½® clion ç¼–è¯‘å·¥å…·é“¾"></a>è®¾ç½® clion ç¼–è¯‘å·¥å…·é“¾</h2><p>åœ¨ clion çš„ <code>File -&gt; Settings -&gt; Build, Execution, Deployment -&gt; Toolchains</code> ï¼ŒåŠ ä¸Šä¸€ä¸ª mingw çš„å·¥å…·é“¾ï¼Œè®¾ç½®ç›®å½•ä¸º msys2 ä¸­çš„ mingw64 ç›®å½•ã€‚å¦‚ msys2 å®‰è£…åœ¨ <code>c:\msys64</code> ï¼Œåˆ™ç›®å½•ä¸º <code>c:\msys64\mingw64</code> ï¼Œç›®å½•æ­£ç¡®çš„æƒ…å†µä¸‹ï¼Œmake ã€ c-compiler ã€ c++ compiler ã€ debugger ç­‰è‡ªåŠ¨æ‰¾åˆ°ã€‚</p><p>å®Œæˆè¿™äº›è®¾ç½®åï¼Œå°±å¯ä»¥ä½¿ç”¨ clion è°ƒè¯• rust äº†</p><img src="/images/2020/rust01.jpg"><img src="/images/2020/rust02.png"><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> Rust </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Rust </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®åº“å­¦ä¹ æŒ‡å—</title>
      <link href="/2020/07/17/database/"/>
      <url>/2020/07/17/database/</url>
      
        <content type="html"><![CDATA[<h1 id="Databases"><a href="#Databases" class="headerlink" title="Databases"></a>Databases</h1><h2 id="General"><a href="#General" class="headerlink" title="General"></a>General</h2><ul><li><input checked="" disabled="" type="checkbox"> ğŸ¥ <a href="https://www.youtube.com/playlist?list=PLSE8ODhjZXjbohkNBWQs_otTrBTrjyohi" target="_blank" rel="noopener"><strong>CMU 15-445 Intro to Database Systems</strong></a> (A Pavlo 2019)</li><li><input checked="" disabled="" type="checkbox"> ğŸ¥ <a href="https://www.youtube.com/playlist?list=PLSE8ODhjZXjasmrEd2_Yi1deeE360zv5O" target="_blank" rel="noopener"><strong>CMU 15-721 Advanced Database Systems</strong></a> (A Pavlo 2020)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“– <a href="https://www.databass.dev" target="_blank" rel="noopener"><strong>Database Internals</strong></a> (A Petrov 2019)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“– <a href="https://dataintensive.net/" target="_blank" rel="noopener"><strong>Designing Data-Intensive Applications</strong></a> (M Kleppmann 2017)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://www.redbook.io" target="_blank" rel="noopener"><strong>Readings in Database Systems</strong></a> (P Bailis, JM Hellerstein, M Stonebraker) <em>â€œThe Red Bookâ€</em></li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://db.cs.berkeley.edu/papers/fntdb07-architecture.pdf" target="_blank" rel="noopener">Architecture of a Database System</a> (JM Hellerstein, M Stonebraker, J Hamilton 2007)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“– <a href="https://www.amazon.com/Data-Reality-Perspective-Perceiving-Information/dp/1935504215" target="_blank" rel="noopener">Data and Reality</a> (W Kent, S Hoberman 2012)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“– <a href="https://www.db-book.com/db7/index.html" target="_blank" rel="noopener">Database System Concepts</a> (A Silberschatz, HF Korth, S Sudarshan 2019)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“– <a href="https://www.amazon.com/Fundamentals-Database-Systems-Ramez-Elmasri/dp/0133970779" target="_blank" rel="noopener">Fundamentals of Database Systems</a> (R Elmasri, SB Navathe 2015)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“– <a href="https://dl.acm.org/doi/book/10.1145/3226595" target="_blank" rel="noopener">Making Databases Work: the Pragmatic Wisdom of Michael Stonebraker</a> (ML Brodie 2018)</li><li><input checked="" disabled="" type="checkbox"> ğŸ¥ <a href="https://archive.org/details/UCBerkeley_Course_Computer_Science_186#" target="_blank" rel="noopener">UC Berkeley CS186 Introduction to Database Systems</a> (J Hellerstein 2012)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://db.cs.cmu.edu/papers/2016/pavlo-newsql-sigmodrec2016.pdf" target="_blank" rel="noopener">Whatâ€™s Really New with NewSQL?</a> (A Pavlo, M Aslett 2016)</li></ul><h2 id="Transactions"><a href="#Transactions" class="headerlink" title="Transactions"></a>Transactions</h2><ul><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/tr-95-51.pdf" target="_blank" rel="noopener"><strong>A Critique of ANSI SQL Isolation Levels</strong></a> (H Berenson et al 1995)</li><li><input checked="" disabled="" type="checkbox"> ğŸ”— <a href="https://jepsen.io/consistency" target="_blank" rel="noopener"><strong>Consistency Models</strong></a> (Jepsen 2016)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://pmg.csail.mit.edu/papers/icde00.pdf" target="_blank" rel="noopener"><strong>Generalized Isolation Level Definitions</strong></a> (A Adya, B Liskov, P ONeil 2000)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“– <a href="https://www.amazon.com/Transaction-Processing-Concepts-Techniques-Management/dp/1558601902#customerReviews" target="_blank" rel="noopener"><strong>Transaction Processing: Concepts and Techniques</strong></a> (J Gray, A Reuter 1992)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://www.bailis.org/papers/acidrain-sigmod2017.pdf" target="_blank" rel="noopener">ACIDRain: Concurrency-Related Attacks on Database-Backed Web Applications</a> (P Bailis, T Warszawski 2017)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://yingjunwu.github.io/papers/vldb2017.pdf" target="_blank" rel="noopener">An Empirical Evaluation of In-Memory Multi-Version Concurrency Control</a> (Y Wu et al 2017)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://delivery.acm.org/10.1145/2820000/2815404/p263-zhang.pdf" target="_blank" rel="noopener">Building Consistent Transactions with Inconsistent Replication</a> (I Zhang et al 2015)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://cs.yale.edu/homes/thomson/publications/calvin-sigmod12.pdf" target="_blank" rel="noopener">Calvin: Fast Distributed Transactions for Partitioned Database Systems</a> (DJ Abadi et al 2012) <em>â€œThe Calvin paperâ€</em></li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://arxiv.org/pdf/1512.00168.pdf" target="_blank" rel="noopener">Consistency in Non-Transactional Distributed Storage Systems</a> (P Viotti, M VukoliÄ‡ 2016)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://www.vldb.org/pvldb/vol7/p181-bailis.pdf" target="_blank" rel="noopener">Highly Available Transactions: Virtues and Limitations</a> (P Bailis, JM Hellerstein et al 2013)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://dspace.mit.edu/bitstream/handle/1721.1/16279/05331643-MIT.pdf" target="_blank" rel="noopener">Naming and Synchronization in a Decentralized Computer System</a> (DP Reed 1978) <em>â€œThe MVCC paperâ€</em></li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://www.jmfaleiro.com/pubs/multiversion-vldb2015.pdf" target="_blank" rel="noopener">Rethinking Serializable Multiversion Concurrency Control</a> (JM Faleiro, DJ Abadi 2015)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://www.bailis.org/papers/ramp-sigmod2014.pdf" target="_blank" rel="noopener">Scalable Atomic Visibility with RAMP Transactions</a> (P Bailis et al 2014)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://courses.cs.washington.edu/courses/cse444/08au/544M/READING-LIST/fekete-sigmod2008.pdf" target="_blank" rel="noopener">Serializable Isolation for Snapshot Databases</a> (MJ Cahill, U RÃ¶hm, AD Fekete 2008)</li><li><input checked="" disabled="" type="checkbox"> ğŸ’¬ <a href="http://justinjaffray.com/what-does-write-skew-look-like/" target="_blank" rel="noopener">What Does Write Skew Look Like</a> (J Jaffray 2018)</li></ul><h2 id="Queries"><a href="#Queries" class="headerlink" title="Queries"></a>Queries</h2><ul><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://www2.cs.duke.edu/courses/compsci516/cps216/spring03/papers/selinger-etal-1979.pdf" target="_blank" rel="noopener">Access Path Selection in a Relational Database Management System</a> (PG Selinger et al 1979)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://web.stanford.edu/class/cs345d-01/rl/chaudhuri98.pdf" target="_blank" rel="noopener">An Overview of Query Optimization in Relational Systems</a> (S Chaudhuri 1998)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“– <a href="http://pi3.informatik.uni-mannheim.de/~moer/querycompiler.pdf" target="_blank" rel="noopener">Building Query Compilers</a> (G Moerkotte 2014)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://www.cs.purdue.edu/homes/rompf/papers/tahboub-sigmod18.pdf" target="_blank" rel="noopener">How to Architect a Query Compiler, Revisited</a> (RY Tahboub, GM Essertel, T Rompf 2018)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://www.vldb.org/conf/1996/P087.PDF" target="_blank" rel="noopener">Optimization of Queries with User-Defined Predicates</a> (S Chaudhur, K Shim 1999)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://www.cse.iitb.ac.in/infolab/Data/Courses/CS632/Papers/Cascades-graefe.pdf" target="_blank" rel="noopener">The Cascades Framework for Query Optimization</a> (G Graefe 1995)</li></ul><h2 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h2><ul><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://db.in.tum.de/~leis/papers/ART.pdf" target="_blank" rel="noopener">The Adaptive Radix Tree: ARTful Indexing for Main-Memory Databases</a> (V Leis, A Kemper, T Neumann 2013)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://cs.stanford.edu/people/chrismre/cs345/rl/aries.pdf" target="_blank" rel="noopener">Aries: A Transaction Recovery Method Supporting Fine-Granularity Locking and Partial Rollbacks Using Write-Ahead Logging</a> (C Mohan et al 1992)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://www.eecs.harvard.edu/~margo/cs165/papers/gp-lsm.pdf" target="_blank" rel="noopener">bLSM: A General Purpose Log Structured Merge Tree</a> (R Sears, R Ramakrishnan 2012)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://www.cs.cmu.edu/~huanche1/publications/open_bwtree.pdf" target="_blank" rel="noopener">Building a Bw-Tree Takes More Than Just Buzz Words</a> (Z Wang et al 2018)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://greensky00.github.io/pdf/jungle_hotstorage19.pdf" target="_blank" rel="noopener">Jungle: Towards Dynamically Adjustable Key-Value Store by Combining LSM-Tree and Copy-On-Write B+-Tree</a> (JS Ahn et al 2019)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/bw-tree-icde2013-final.pdf" target="_blank" rel="noopener">The Bw-Tree: A B-tree for New Hardware Platforms</a> (JJ Levandoski, DB Lomet, S Sengupta 2013)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://www.cs.umb.edu/~poneil/lsmtree.pdf" target="_blank" rel="noopener">The Log-Structured Merge Tree</a> (P Oâ€™Neil, E Cheng, D Gawklik, E Oâ€™Neil 1996)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://cgi.di.uoa.gr/~ad/M149/ubiquitous_btree.pdf" target="_blank" rel="noopener">The Ubiquitous B-Tree</a> (D Comer 1979)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://www.usenix.org/system/files/conference/fast16/fast16-papers-lu.pdf" target="_blank" rel="noopener">WiscKey: Separating Keys from Values in SSD-Conscious Storage</a> (L Lu, TS Pillai, AC Arpaci-Dusseau, RH Arpaci-Dusseau 2016)</li></ul><h2 id="Verification"><a href="#Verification" class="headerlink" title="Verification"></a>Verification</h2><ul><li><input checked="" disabled="" type="checkbox"> ğŸ¥ <a href="https://www.youtube.com/watch?v=Np46NQ6lqP8" target="_blank" rel="noopener">SQLancer: Finding Logic Bugs in Database Management Systems</a> (M Rigger 2020)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://www.usenix.org/system/files/conference/osdi14/osdi14-paper-zheng_mai.pdf" target="_blank" rel="noopener">Torturing Databases for Fun and Profit</a> (M Zheng et al 2014)</li></ul><h2 id="Vendors"><a href="#Vendors" class="headerlink" title="Vendors"></a>Vendors</h2><h3 id="CockroachDB"><a href="#CockroachDB" class="headerlink" title="CockroachDB"></a>CockroachDB</h3><ul><li><input checked="" disabled="" type="checkbox"> ğŸ”— <a href="https://www.cockroachlabs.com/docs/stable/architecture/overview.html" target="_blank" rel="noopener"><strong>Architecture Overview</strong></a></li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://dl.acm.org/doi/pdf/10.1145/3318464.3386134" target="_blank" rel="noopener"><strong>CockroachDB: The Resilient Geo-Distributed SQL Database</strong></a> (R Taft et al 2020)</li><li><input checked="" disabled="" type="checkbox"> ğŸ’¬ <a href="https://www.cockroachlabs.com/blog/serializable-lockless-distributed-isolation-cockroachdb/" target="_blank" rel="noopener"><strong>Serializable, Lockless, Distributed: Isolation in CockroachDB</strong></a> (M Tracy 2016)</li><li><input checked="" disabled="" type="checkbox"> ğŸ’¬ <a href="https://www.cockroachlabs.com/blog/building-cost-based-sql-optimizer/" target="_blank" rel="noopener">How We Built a Cost-Based SQL Optimizer</a> (A Kimball 2018)</li><li><input checked="" disabled="" type="checkbox"> ğŸ’¬ <a href="https://www.cockroachlabs.com/blog/living-without-atomic-clocks/" target="_blank" rel="noopener">Living Without Atomic Clocks</a> (S Kimball 2016)</li></ul><h3 id="FaunaDB"><a href="#FaunaDB" class="headerlink" title="FaunaDB"></a>FaunaDB</h3><ul><li><input disabled="" type="checkbox"> ğŸ’¬ <a href="https://fauna.com/blog/distributed-consistency-at-scale-spanner-vs-calvin" target="_blank" rel="noopener">Spanner vs. Calvin: Distributed Consistency at Scale</a> (DJ Abadi 2017)</li><li><input checked="" disabled="" type="checkbox"> ğŸ’¬ <a href="https://fauna.com/blog/time-traveling-databases" target="_blank" rel="noopener">Time-Traveling Databases: Exploring Temporality in FaunaDB</a> (M Freels 2016)</li><li><input checked="" disabled="" type="checkbox"> ğŸ’¬ <a href="https://fauna.com/blog/unifying-relational-document-graph-and-temporal-data-models" target="_blank" rel="noopener">Unifying Relational, Document, Graph, and Temporal Data Models</a> (C Anderson 2018)</li></ul><h3 id="Google-Bigtable"><a href="#Google-Bigtable" class="headerlink" title="Google Bigtable"></a>Google Bigtable</h3><ul><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://static.googleusercontent.com/media/research.google.com/en//archive/bigtable-osdi06.pdf" target="_blank" rel="noopener"><strong>Bigtable: A Distributed Storage System for Structured Data</strong></a> (F Chang et al 2006) <em>â€œThe Bigtable paperâ€</em></li></ul><h3 id="Google-F1"><a href="#Google-F1" class="headerlink" title="Google F1"></a>Google F1</h3><ul><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/41344.pdf" target="_blank" rel="noopener"><strong>F1: A Distributed SQL Database That Scales</strong></a> <em>â€œThe F1 paperâ€</em></li></ul><h3 id="Google-Spanner"><a href="#Google-Spanner" class="headerlink" title="Google Spanner"></a>Google Spanner</h3><ul><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/39966.pdf" target="_blank" rel="noopener"><strong>Spanner: Googleâ€™s Globally-Distributed Database</strong></a> (J Corbett et al 2012) <em>â€œThe Spanner paperâ€</em></li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://dl.acm.org/doi/pdf/10.1145/3035918.3056103" target="_blank" rel="noopener">Spanner: Becoming a SQL System</a> (DF Bacon et al 2017)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/45855.pdf" target="_blank" rel="noopener">Spanner, TrueTime &amp; The CAP Theorem</a> (E Brewer 2017)</li></ul><h3 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h3><ul><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://arxiv.org/pdf/1901.01973.pdf" target="_blank" rel="noopener"><strong>Looking Back at Postgres</strong></a> (JM Hellerstein 2019)</li><li><input checked="" disabled="" type="checkbox"> ğŸ’¬ <a href="https://brandur.org/postgres-atomicity" target="_blank" rel="noopener">How Postgres Makes Transactions Atomic</a> (B Leach 2017)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“„ <a href="https://drkp.net/papers/ssi-vldb12.pdf" target="_blank" rel="noopener">Serializable Snapshot Isolation in PostgreSQL</a> (DRK Ports, K Grittner 2012)</li><li><input checked="" disabled="" type="checkbox"> ğŸ“– <a href="http://www.interdb.jp/pg/" target="_blank" rel="noopener">The Internals of PostgreSQL</a> (H Suzuki 2015)</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> Database </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Database </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£ Kubernetes ä¹‹ Kube-scheduler</title>
      <link href="/2020/06/02/k8s04/"/>
      <url>/2020/06/02/k8s04/</url>
      
        <content type="html"><![CDATA[<h1 id="æ·±å…¥ç†è§£-Kubernetes-ä¹‹-Kube-scheduler"><a href="#æ·±å…¥ç†è§£-Kubernetes-ä¹‹-Kube-scheduler" class="headerlink" title="æ·±å…¥ç†è§£ Kubernetes ä¹‹ Kube-scheduler"></a>æ·±å…¥ç†è§£ Kubernetes ä¹‹ Kube-scheduler</h1><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>Kube-scheduler æ˜¯ kubernetes çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯æ‰€æœ‰æ ¸å¿ƒç»„ä»¶ä¹‹é—´åŠŸèƒ½æ¯”è¾ƒå•ä¸€çš„ï¼Œå…¶ä»£ç ä¹Ÿç›¸å¯¹å®¹æ˜“ç†è§£ã€‚kube-scheduler çš„ç›®çš„å°±æ˜¯ä¸ºæ¯ä¸€ä¸ª pod é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ nodeï¼Œæ•´ä½“æµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‰æ­¥ï¼Œè·å–æœªè°ƒåº¦çš„ podListï¼Œé€šè¿‡æ‰§è¡Œä¸€ç³»åˆ—è°ƒåº¦ç®—æ³•ä¸º pod é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ nodeï¼Œæäº¤æ•°æ®åˆ° apiserverï¼Œå…¶æ ¸å¿ƒåˆ™æ˜¯ä¸€ç³»åˆ—è°ƒåº¦ç®—æ³•çš„è®¾è®¡ä¸æ‰§è¡Œã€‚</p><h2 id="è°ƒåº¦ç®—æ³•"><a href="#è°ƒåº¦ç®—æ³•" class="headerlink" title="è°ƒåº¦ç®—æ³•"></a>è°ƒåº¦ç®—æ³•</h2><p>å®˜æ–¹å¯¹ kube-scheduler çš„è°ƒåº¦æµç¨‹æè¿° <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-scheduling/scheduler.md" target="_blank" rel="noopener">The Kubernetes Scheduler</a>ï¼š</p><pre><code>å¯¹äºä¸€ä¸ªç»™å®šçš„pod+---------------------------------------------+|             å¯ç”¨äºè°ƒåº¦çš„nodeså¦‚ä¸‹ï¼š           ||  +--------+     +--------+     +--------+   ||  | node 1 |     | node 2 |     | node 3 |   ||  +--------+     +--------+     +--------+   |+----------------------+----------------------+                       |                       v+----------------------+----------------------+|             åˆæ­¥è¿‡æ»¤: node 3 èµ„æºä¸è¶³          |+----------------------+----------------------+                       |                       v+----------------------+----------------------+|                 å‰©ä¸‹çš„nodes:                 ||     +--------+               +--------+     ||     | node 1 |               | node 2 |     ||     +--------+               +--------+     |+----------------------+----------------------+                       |                       v+----------------------+----------------------+|ä¼˜å…ˆçº§ç®—æ³•è®¡ç®—ç»“æœ:    node 1: åˆ†æ•°=2            ||                    node 2: åˆ†æ•°=5            |+----------------------+----------------------+                       |                       v            é€‰æ‹©åˆ†å€¼æœ€é«˜çš„èŠ‚ç‚¹ = node 2</code></pre><p>Scheduler ä¸ºæ¯ä¸ª pod å¯»æ‰¾ä¸€ä¸ªé€‚åˆå…¶è¿è¡Œçš„ nodeï¼Œå¤§ä½“åˆ†æˆä¸‰æ­¥ï¼š</p><ol><li>é€šè¿‡ä¸€ç³»åˆ—çš„ <code>predicates</code> è¿‡æ»¤æ‰ä¸èƒ½è¿è¡Œ pod çš„ nodeï¼Œæ¯”å¦‚ä¸€ä¸ª pod éœ€è¦ 500M çš„å†…å­˜ï¼Œæœ‰äº›èŠ‚ç‚¹å‰©ä½™å†…å­˜åªæœ‰ 100M äº†ï¼Œå°±ä¼šè¢«å‰”é™¤ï¼›</li><li>é€šè¿‡ä¸€ç³»åˆ—çš„ <code>priority functions</code> ç»™å‰©ä¸‹çš„ node æ’ä¸€ä¸ªç­‰çº§ï¼Œå¯»æ‰¾èƒ½å¤Ÿè¿è¡Œ pod çš„è‹¥å¹² node ä¸­æœ€åˆé€‚çš„ä¸€ä¸ª nodeï¼›</li><li>å¾—åˆ†æœ€é«˜çš„ä¸€ä¸ª nodeï¼Œä¹Ÿå°±æ˜¯è¢« <code>priority functions</code> é€‰ä¸­çš„ node èƒœå‡ºäº†ï¼Œè·å¾—äº†è·‘å¯¹åº” pod çš„èµ„æ ¼ã€‚</li></ol><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="ä¸»æµç¨‹ï¼š"><a href="#ä¸»æµç¨‹ï¼š" class="headerlink" title="ä¸»æµç¨‹ï¼š"></a>ä¸»æµç¨‹ï¼š</h3><p><img src="/images/2020/scheduler.png" alt=""></p><p>schedulerçš„æºç å¯ä»¥åˆ†ä¸º3å±‚ï¼š</p><ul><li><code>cmd/kube-scheduler/scheduler.go</code>: main() å‡½æ•°å…¥å£ä½ç½®ï¼Œåœ¨schedulerè¿‡ç¨‹å¼€å§‹è¢«è°ƒç”¨å‰çš„ä¸€ç³»åˆ—åˆå§‹åŒ–å·¥ä½œã€‚</li><li><code>pkg/scheduler/scheduler.go</code>: è°ƒåº¦æ¡†æ¶çš„æ•´ä½“é€»è¾‘ï¼Œåœ¨å…·ä½“çš„è°ƒåº¦ç®—æ³•ä¹‹ä¸Šçš„æ¡†æ¶æ€§çš„ä»£ç ã€‚</li><li><code>pkg/scheduler/core/generic_scheduler.go</code>: å…·ä½“çš„è®¡ç®—å“ªäº›nodeé€‚åˆè·‘å“ªäº›podçš„ç®—æ³•ã€‚</li></ul><h4 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h4><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/cmd/kube-scheduler/scheduler.go" target="_blank" rel="noopener">/kubernetes/cmd/kube-scheduler/scheduler.go</a></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    command <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">NewSchedulerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">SetNormalizeFunc</span><span class="token punctuation">(</span>cliflag<span class="token punctuation">.</span>WordSepNormalizeFunc<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// utilflag.InitFlags()</span>    logs<span class="token punctuation">.</span><span class="token function">InitLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> logs<span class="token punctuation">.</span><span class="token function">FlushLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> command<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/cmd/kube-scheduler/app/server.go" target="_blank" rel="noopener">/kubernetes//cmd/kube-scheduler/app/server.go</a></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// NewSchedulerCommand creates a *cobra.Command object with default parameters</span><span class="token keyword">func</span> <span class="token function">NewSchedulerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>    cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>        Use<span class="token punctuation">:</span> <span class="token string">"kube-scheduler"</span><span class="token punctuation">,</span>        Long<span class="token punctuation">:</span> <span class="token string">`...`</span><span class="token punctuation">,</span>        Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// ...</span>            stopCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">Run</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> cmd<span class="token punctuation">}</span></code></pre><h4 id="Run"><a href="#Run" class="headerlink" title="Run()"></a>Run()</h4><p>kube-scheduler ä¸»å‡½æ•°åœ¨ <code>Run</code> å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°ä¸»è¦çš„å·¥ä½œåŒ…æ‹¬ï¼š</p><ol><li>åˆå§‹åŒ– scheduler å¯¹è±¡</li><li>å¯åŠ¨ kube-scheduler serverï¼Œkube-scheduler ç›‘å¬ 10251 å’Œ 10259 ç«¯å£ï¼Œ10251 ç«¯å£ä¸éœ€è¦è®¤è¯ï¼Œå¯ä»¥è·å– healthz metrics ç­‰ä¿¡æ¯ï¼Œ10259 ä¸ºå®‰å…¨ç«¯å£ï¼Œéœ€è¦è®¤è¯</li><li>å¯åŠ¨æ‰€æœ‰çš„ informer</li><li>æ‰§è¡Œ <code>sched.Run()</code> æ–¹æ³•ï¼Œæ‰§è¡Œä¸»è°ƒåº¦é€»è¾‘</li></ol><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Run executes the scheduler based on the given configuration. It only returns on error or when context is done.</span><span class="token keyword">func</span> <span class="token function">Run</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> cc schedulerserverconfig<span class="token punctuation">.</span>CompletedConfig<span class="token punctuation">,</span> outOfTreeRegistryOptions <span class="token operator">...</span>Option<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><span class="token operator">...</span>    <span class="token comment" spellcheck="true">// åˆå§‹åŒ– scheduler.</span>    sched<span class="token punctuation">,</span> err <span class="token operator">:=</span> scheduler<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>Client<span class="token punctuation">,</span>        cc<span class="token punctuation">.</span>InformerFactory<span class="token punctuation">,</span>        cc<span class="token punctuation">.</span>PodInformer<span class="token punctuation">,</span>        recorderFactory<span class="token punctuation">,</span>        ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        scheduler<span class="token punctuation">.</span><span class="token function">WithProfiles</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>ComponentConfig<span class="token punctuation">.</span>Profiles<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        scheduler<span class="token punctuation">.</span><span class="token function">WithAlgorithmSource</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>ComponentConfig<span class="token punctuation">.</span>AlgorithmSource<span class="token punctuation">)</span><span class="token punctuation">,</span>        scheduler<span class="token punctuation">.</span><span class="token function">WithPreemptionDisabled</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>ComponentConfig<span class="token punctuation">.</span>DisablePreemption<span class="token punctuation">)</span><span class="token punctuation">,</span>        scheduler<span class="token punctuation">.</span><span class="token function">WithPercentageOfNodesToScore</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>ComponentConfig<span class="token punctuation">.</span>PercentageOfNodesToScore<span class="token punctuation">)</span><span class="token punctuation">,</span>        scheduler<span class="token punctuation">.</span><span class="token function">WithBindTimeoutSeconds</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>ComponentConfig<span class="token punctuation">.</span>BindTimeoutSeconds<span class="token punctuation">)</span><span class="token punctuation">,</span>        scheduler<span class="token punctuation">.</span><span class="token function">WithFrameworkOutOfTreeRegistry</span><span class="token punctuation">(</span>outOfTreeRegistry<span class="token punctuation">)</span><span class="token punctuation">,</span>        scheduler<span class="token punctuation">.</span><span class="token function">WithPodMaxBackoffSeconds</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>ComponentConfig<span class="token punctuation">.</span>PodMaxBackoffSeconds<span class="token punctuation">)</span><span class="token punctuation">,</span>        scheduler<span class="token punctuation">.</span><span class="token function">WithPodInitialBackoffSeconds</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>ComponentConfig<span class="token punctuation">.</span>PodInitialBackoffSeconds<span class="token punctuation">)</span><span class="token punctuation">,</span>        scheduler<span class="token punctuation">.</span><span class="token function">WithExtenders</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>ComponentConfig<span class="token punctuation">.</span>Extenders<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// å¯åŠ¨å¹¿æ’­äº‹ä»¶</span>    <span class="token keyword">if</span> cc<span class="token punctuation">.</span>Broadcaster <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> cc<span class="token punctuation">.</span>EventClient <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        cc<span class="token punctuation">.</span>Broadcaster<span class="token punctuation">.</span><span class="token function">StartRecordingToSink</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> cc<span class="token punctuation">.</span>CoreBroadcaster <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> cc<span class="token punctuation">.</span>CoreEventClient <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        cc<span class="token punctuation">.</span>CoreBroadcaster<span class="token punctuation">.</span><span class="token function">StartRecordingToSink</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>corev1<span class="token punctuation">.</span>EventSinkImpl<span class="token punctuation">{</span>Interface<span class="token punctuation">:</span> cc<span class="token punctuation">.</span>CoreEventClient<span class="token punctuation">.</span><span class="token function">Events</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token operator">...</span>     <span class="token comment" spellcheck="true">// å¯åŠ¨ http server.</span>    <span class="token keyword">if</span> cc<span class="token punctuation">.</span>InsecureServing <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        separateMetrics <span class="token operator">:=</span> cc<span class="token punctuation">.</span>InsecureMetricsServing <span class="token operator">!=</span> <span class="token boolean">nil</span>        handler <span class="token operator">:=</span> <span class="token function">buildHandlerChain</span><span class="token punctuation">(</span><span class="token function">newHealthzHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cc<span class="token punctuation">.</span>ComponentConfig<span class="token punctuation">,</span> separateMetrics<span class="token punctuation">,</span> checks<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> cc<span class="token punctuation">.</span>InsecureServing<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to start healthz server: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> cc<span class="token punctuation">.</span>InsecureMetricsServing <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        handler <span class="token operator">:=</span> <span class="token function">buildHandlerChain</span><span class="token punctuation">(</span><span class="token function">newMetricsHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cc<span class="token punctuation">.</span>ComponentConfig<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> cc<span class="token punctuation">.</span>InsecureMetricsServing<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to start metrics server: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> cc<span class="token punctuation">.</span>SecureServing <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        handler <span class="token operator">:=</span> <span class="token function">buildHandlerChain</span><span class="token punctuation">(</span><span class="token function">newHealthzHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cc<span class="token punctuation">.</span>ComponentConfig<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> checks<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cc<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>Authenticator<span class="token punctuation">,</span> cc<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// TODO: handle stoppedCh returned by c.SecureServing.Serve</span>        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> cc<span class="token punctuation">.</span>SecureServing<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// fail early for secure handlers, removing the old error loop from above</span>            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to start secure server: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å¯åŠ¨æ‰€æœ‰ informer</span>    <span class="token keyword">go</span> cc<span class="token punctuation">.</span>PodInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    cc<span class="token punctuation">.</span>InformerFactory<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// Wait for all caches to sync before scheduling.</span>    cc<span class="token punctuation">.</span>InformerFactory<span class="token punctuation">.</span><span class="token function">WaitForCacheSync</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// é€‰ä¸¾ leader</span>    <span class="token keyword">if</span> cc<span class="token punctuation">.</span>LeaderElection <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        cc<span class="token punctuation">.</span>LeaderElection<span class="token punctuation">.</span>Callbacks <span class="token operator">=</span> leaderelection<span class="token punctuation">.</span>LeaderCallbacks<span class="token punctuation">{</span>            OnStartedLeading<span class="token punctuation">:</span> sched<span class="token punctuation">.</span>Run<span class="token punctuation">,</span>            OnStoppedLeading<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"leaderelection lost"</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span>        leaderElector<span class="token punctuation">,</span> err <span class="token operator">:=</span> leaderelection<span class="token punctuation">.</span><span class="token function">NewLeaderElector</span><span class="token punctuation">(</span><span class="token operator">*</span>cc<span class="token punctuation">.</span>LeaderElection<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"couldn't create leader elector: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        leaderElector<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"lost lease"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ‰§è¡Œ sched.Run() æ–¹æ³•</span>    sched<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"finished without leader elect"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="New"><a href="#New" class="headerlink" title="New()"></a>New()</h4><p>Scheduler æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„</p><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/pkg/scheduler/scheduler.go#L223" target="_blank" rel="noopener">kubernetes/pkg/scheduler/scheduler.go#L223</a></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// New returns a Scheduler</span><span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>client clientset<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>    informerFactory informers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">,</span>    podInformer coreinformers<span class="token punctuation">.</span>PodInformer<span class="token punctuation">,</span>    recorderFactory profile<span class="token punctuation">.</span>RecorderFactory<span class="token punctuation">,</span>    stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    opts <span class="token operator">...</span>Option<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Scheduler<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span>    <span class="token comment" spellcheck="true">// åˆ›å»º scheduler çš„é…ç½®æ–‡ä»¶</span>    configurator <span class="token operator">:=</span> <span class="token operator">&amp;</span>Configurator<span class="token punctuation">{</span>        client<span class="token punctuation">:</span>                   client<span class="token punctuation">,</span>        recorderFactory<span class="token punctuation">:</span>          recorderFactory<span class="token punctuation">,</span>        informerFactory<span class="token punctuation">:</span>          informerFactory<span class="token punctuation">,</span>        podInformer<span class="token punctuation">:</span>              podInformer<span class="token punctuation">,</span>        volumeBinder<span class="token punctuation">:</span>             volumeBinder<span class="token punctuation">,</span>        schedulerCache<span class="token punctuation">:</span>           schedulerCache<span class="token punctuation">,</span>        StopEverything<span class="token punctuation">:</span>           stopEverything<span class="token punctuation">,</span>        disablePreemption<span class="token punctuation">:</span>        options<span class="token punctuation">.</span>disablePreemption<span class="token punctuation">,</span>        percentageOfNodesToScore<span class="token punctuation">:</span> options<span class="token punctuation">.</span>percentageOfNodesToScore<span class="token punctuation">,</span>        bindTimeoutSeconds<span class="token punctuation">:</span>       options<span class="token punctuation">.</span>bindTimeoutSeconds<span class="token punctuation">,</span>        podInitialBackoffSeconds<span class="token punctuation">:</span> options<span class="token punctuation">.</span>podInitialBackoffSeconds<span class="token punctuation">,</span>        podMaxBackoffSeconds<span class="token punctuation">:</span>     options<span class="token punctuation">.</span>podMaxBackoffSeconds<span class="token punctuation">,</span>        enableNonPreempting<span class="token punctuation">:</span>      utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>kubefeatures<span class="token punctuation">.</span>NonPreemptingPriority<span class="token punctuation">)</span><span class="token punctuation">,</span>        profiles<span class="token punctuation">:</span>                 <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>schedulerapi<span class="token punctuation">.</span><span class="token function">KubeSchedulerProfile</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>profiles<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        registry<span class="token punctuation">:</span>                 registry<span class="token punctuation">,</span>        nodeInfoSnapshot<span class="token punctuation">:</span>         snapshot<span class="token punctuation">,</span>        extenders<span class="token punctuation">:</span>                options<span class="token punctuation">.</span>extenders<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    metrics<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// åŠ è½½é»˜è®¤çš„è°ƒåº¦ç®—æ³•</span>    <span class="token keyword">var</span> sched <span class="token operator">*</span>Scheduler    source <span class="token operator">:=</span> options<span class="token punctuation">.</span>schedulerAlgorithmSource    <span class="token comment" spellcheck="true">// åˆ›å»ºè°ƒåº¦ç®—æ³•æœ‰ä¸¤ç§æ–¹å¼  Provider å’Œ ç”¨æˆ·æŒ‡å®šçš„ Ploicy æ–‡ä»¶ï¼ˆæ–‡ä»¶æˆ–Configmap)</span>    <span class="token keyword">switch</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> source<span class="token punctuation">.</span>Provider <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true">// Create the config from a named algorithm provider.</span>        sc<span class="token punctuation">,</span> err <span class="token operator">:=</span> configurator<span class="token punctuation">.</span><span class="token function">createFromProvider</span><span class="token punctuation">(</span><span class="token operator">*</span>source<span class="token punctuation">.</span>Provider<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"couldn't create scheduler using provider %q: %v"</span><span class="token punctuation">,</span> <span class="token operator">*</span>source<span class="token punctuation">.</span>Provider<span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        sched <span class="token operator">=</span> sc    <span class="token keyword">case</span> source<span class="token punctuation">.</span>Policy <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true">// Create the config from a user specified policy source.</span>        policy <span class="token operator">:=</span> <span class="token operator">&amp;</span>schedulerapi<span class="token punctuation">.</span>Policy<span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token keyword">switch</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> source<span class="token punctuation">.</span>Policy<span class="token punctuation">.</span>File <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">initPolicyFromFile</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span>Policy<span class="token punctuation">.</span>File<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> policy<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>        <span class="token keyword">case</span> source<span class="token punctuation">.</span>Policy<span class="token punctuation">.</span>ConfigMap <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">initPolicyFromConfigMap</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> source<span class="token punctuation">.</span>Policy<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">,</span> policy<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Set extenders on the configurator now that we've decoded the policy</span>        <span class="token comment" spellcheck="true">// In this case, c.extenders should be nil since we're using a policy (and therefore not componentconfig,</span>        <span class="token comment" spellcheck="true">// which would have set extenders in the above instantiation of Configurator from CC options)</span>        configurator<span class="token punctuation">.</span>extenders <span class="token operator">=</span> policy<span class="token punctuation">.</span>Extenders        sc<span class="token punctuation">,</span> err <span class="token operator">:=</span> configurator<span class="token punctuation">.</span><span class="token function">createFromConfig</span><span class="token punctuation">(</span><span class="token operator">*</span>policy<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"couldn't create scheduler from policy: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        sched <span class="token operator">=</span> sc    <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unsupported algorithm source: %v"</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Additional tweaks to the config produced by the configurator.</span>    sched<span class="token punctuation">.</span>DisablePreemption <span class="token operator">=</span> options<span class="token punctuation">.</span>disablePreemption    sched<span class="token punctuation">.</span>StopEverything <span class="token operator">=</span> stopEverything    sched<span class="token punctuation">.</span>podConditionUpdater <span class="token operator">=</span> <span class="token operator">&amp;</span>podConditionUpdaterImpl<span class="token punctuation">{</span>client<span class="token punctuation">}</span>    sched<span class="token punctuation">.</span>podPreemptor <span class="token operator">=</span> <span class="token operator">&amp;</span>podPreemptorImpl<span class="token punctuation">{</span>client<span class="token punctuation">}</span>    sched<span class="token punctuation">.</span>scheduledPodsHasSynced <span class="token operator">=</span> podInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HasSynced    <span class="token function">addAllEventHandlers</span><span class="token punctuation">(</span>sched<span class="token punctuation">,</span> informerFactory<span class="token punctuation">,</span> podInformer<span class="token punctuation">)</span>    <span class="token keyword">return</span> sched<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><h4 id="NewPodInformer"><a href="#NewPodInformer" class="headerlink" title="NewPodInformer()"></a>NewPodInformer()</h4><p>pod informer çš„å¯åŠ¨åªç›‘å¬ status.phase ä¸ä¸º succeeded ä»¥åŠ failed çŠ¶æ€çš„ podï¼Œå³é terminating çš„ podã€‚</p><p>ä»£ç è·¯å¾„ï¼š <code>pkg/scheduler/factory.go:444</code></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewPodInformer</span><span class="token punctuation">(</span>client clientset<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> resyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> coreinformers<span class="token punctuation">.</span>PodInformer <span class="token punctuation">{</span>    selector <span class="token operator">:=</span> fields<span class="token punctuation">.</span><span class="token function">ParseSelectorOrDie</span><span class="token punctuation">(</span>        <span class="token string">"status.phase!="</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>PodSucceeded<span class="token punctuation">)</span> <span class="token operator">+</span>            <span class="token string">",status.phase!="</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>PodFailed<span class="token punctuation">)</span><span class="token punctuation">)</span>    lw <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">NewListWatchFromClient</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RESTClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>ResourcePods<span class="token punctuation">)</span><span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>NamespaceAll<span class="token punctuation">,</span> selector<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>podInformer<span class="token punctuation">{</span>        informer<span class="token punctuation">:</span> cache<span class="token punctuation">.</span><span class="token function">NewSharedIndexInformer</span><span class="token punctuation">(</span>lw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resyncPeriod<span class="token punctuation">,</span> cache<span class="token punctuation">.</span>Indexers<span class="token punctuation">{</span>cache<span class="token punctuation">.</span>NamespaceIndex<span class="token punctuation">:</span> cache<span class="token punctuation">.</span>MetaNamespaceIndexFunc<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="Scheduler-Run"><a href="#Scheduler-Run" class="headerlink" title="Scheduler.Run()"></a>Scheduler.Run()</h4><p><code>sched.Run()</code> è°ƒåº¦å¾ªç¯é€»è¾‘ï¼Œè‹¥ informer ä¸­çš„ cache åŒæ­¥å®Œæˆåä¼šå¯åŠ¨ä¸€ä¸ªå¾ªç¯é€»è¾‘æ‰§è¡Œ <code>sched.scheduleOne</code> æ–¹æ³•ã€‚</p><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/scheduler.go:363</code></p><pre><code>// Run begins watching and scheduling. It waits for cache to be synced, then starts scheduling and blocked until the context is done.func (sched *Scheduler) Run(ctx context.Context) {    if !cache.WaitForCacheSync(ctx.Done(), sched.scheduledPodsHasSynced) {        return    }    sched.SchedulingQueue.Run()    wait.UntilWithContext(ctx, sched.scheduleOne, 0)    sched.SchedulingQueue.Close()}</code></pre><p><code>scheduleOne()</code> æ¯æ¬¡å¯¹ä¸€ä¸ª pod è¿›è¡Œè°ƒåº¦ï¼Œä¸»è¦æœ‰ä»¥ä¸‹æ­¥éª¤ï¼š</p><ul><li>ä» scheduler è°ƒåº¦é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ª podï¼Œå¦‚æœè¯¥é˜Ÿåˆ—å…³é—­åˆ™è·³è¿‡</li><li>æ‰§è¡Œè°ƒåº¦é€»è¾‘ <code>sched.schedule()</code> è¿”å›é€šè¿‡é¢„ç®—åŠä¼˜é€‰ç®—æ³•è¿‡æ»¤åé€‰å‡ºçš„æœ€ä½³ node</li><li>å¦‚æœè¿‡æ»¤ç®—æ³•æ²¡æœ‰é€‰å‡ºåˆé€‚çš„ nodeï¼Œåˆ™è¿”å› core.FitError</li><li>è‹¥æ²¡æœ‰åˆé€‚çš„ node ä¼šåˆ¤æ–­æ˜¯å¦å¯ç”¨äº†æŠ¢å ç­–ç•¥ï¼Œè‹¥å¯ç”¨äº†åˆ™æ‰§è¡ŒæŠ¢å æœºåˆ¶</li><li>åˆ¤æ–­æ˜¯å¦éœ€è¦ VolumeScheduling ç‰¹æ€§</li><li>æ‰§è¡Œ reserve plugin</li><li>pod å¯¹åº”çš„ spec.NodeName å†™ä¸Š scheduler æœ€ç»ˆé€‰æ‹©çš„ nodeï¼Œæ›´æ–° scheduler cache</li><li>è¯·æ±‚ apiserver å¼‚æ­¥å¤„ç†æœ€ç»ˆçš„ç»‘å®šæ“ä½œï¼Œå†™å…¥åˆ° etcd</li><li>æ‰§è¡Œ permit plugin</li><li>æ‰§è¡Œ prebind plugin</li><li>æ‰§è¡Œ postbind plugin</li></ul><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/scheduler.go:548</code></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>sched <span class="token operator">*</span>Scheduler<span class="token punctuation">)</span> <span class="token function">scheduleOne</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å–å‡º pod</span>    podInfo <span class="token operator">:=</span> sched<span class="token punctuation">.</span><span class="token function">NextPod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// pod could be nil when schedulerQueue is closed</span>    <span class="token keyword">if</span> podInfo <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> podInfo<span class="token punctuation">.</span>Pod <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    pod <span class="token operator">:=</span> podInfo<span class="token punctuation">.</span>Pod    prof<span class="token punctuation">,</span> err <span class="token operator">:=</span> sched<span class="token punctuation">.</span><span class="token function">profileForPod</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>    <span class="token keyword">if</span> sched<span class="token punctuation">.</span><span class="token function">skipPodSchedule</span><span class="token punctuation">(</span>prof<span class="token punctuation">,</span> pod<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Attempting to schedule pod: %v/%v"</span><span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// Synchronously attempt to find a fit for the pod.</span>    start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    state <span class="token operator">:=</span> framework<span class="token punctuation">.</span><span class="token function">NewCycleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    state<span class="token punctuation">.</span><span class="token function">SetRecordPluginMetrics</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> pluginMetricsSamplePercent<span class="token punctuation">)</span>    schedulingCycleCtx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// æ‰§è¡Œè°ƒåº¦ç­–ç•¥é€‰æ‹© node</span>    scheduleResult<span class="token punctuation">,</span> err <span class="token operator">:=</span> sched<span class="token punctuation">.</span>Algorithm<span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span>schedulingCycleCtx<span class="token punctuation">,</span> prof<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Schedule() may have failed because the pod would not fit on any host, so we try to</span>        <span class="token comment" spellcheck="true">// preempt, with the expectation that the next time the pod is tried for scheduling it</span>        <span class="token comment" spellcheck="true">// will fit due to the preemption. It is also possible that a different pod will schedule</span>        <span class="token comment" spellcheck="true">// into the resources that were preempted, but this is harmless.</span>        <span class="token keyword">if</span> fitError<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>core<span class="token punctuation">.</span>FitError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// è‹¥å¯ç”¨æŠ¢å æœºåˆ¶åˆ™æ‰§è¡Œ</span>            <span class="token keyword">if</span> sched<span class="token punctuation">.</span>DisablePreemption <span class="token punctuation">{</span>                klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Pod priority feature is not enabled or preemption is disabled by scheduler configuration."</span> <span class="token operator">+</span>                    <span class="token string">" No preemption is performed."</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                preemptionStartTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                sched<span class="token punctuation">.</span><span class="token function">preempt</span><span class="token punctuation">(</span>schedulingCycleCtx<span class="token punctuation">,</span> prof<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> fitError<span class="token punctuation">)</span>                metrics<span class="token punctuation">.</span>PreemptionAttempts<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                metrics<span class="token punctuation">.</span>SchedulingAlgorithmPreemptionEvaluationDuration<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>preemptionStartTime<span class="token punctuation">)</span><span class="token punctuation">)</span>                metrics<span class="token punctuation">.</span>DeprecatedSchedulingDuration<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>PreemptionEvaluation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>preemptionStartTime<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"error selecting node for pod: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>            metrics<span class="token punctuation">.</span>PodScheduleErrors<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        sched<span class="token punctuation">.</span><span class="token function">recordSchedulingFailure</span><span class="token punctuation">(</span>prof<span class="token punctuation">,</span> podInfo<span class="token punctuation">.</span><span class="token function">DeepCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>PodReasonUnschedulable<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦éœ€è¦ VolumeScheduling ç‰¹æ€§</span>    allBound<span class="token punctuation">,</span> err <span class="token operator">:=</span> sched<span class="token punctuation">.</span>VolumeBinder<span class="token punctuation">.</span><span class="token function">AssumePodVolumes</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// æ‰§è¡Œ "reserve" plugins</span>    <span class="token keyword">if</span> sts <span class="token operator">:=</span> prof<span class="token punctuation">.</span><span class="token function">RunReservePlugins</span><span class="token punctuation">(</span>schedulingCycleCtx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>sts<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        sched<span class="token punctuation">.</span><span class="token function">recordSchedulingFailure</span><span class="token punctuation">(</span>prof<span class="token punctuation">,</span> assumedPodInfo<span class="token punctuation">,</span> sts<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SchedulerError<span class="token punctuation">,</span> sts<span class="token punctuation">.</span><span class="token function">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        metrics<span class="token punctuation">.</span>PodScheduleErrors<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// assume modifies `assumedPod` by setting NodeName=scheduleResult.SuggestedHost</span>    <span class="token comment" spellcheck="true">// ä¸º pod è®¾ç½® NodeName å­—æ®µï¼Œæ›´æ–° scheduler ç¼“å­˜</span>    err <span class="token operator">=</span> sched<span class="token punctuation">.</span><span class="token function">assume</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// æ‰§è¡Œ permit æ’ä»¶</span>    runPermitStatus <span class="token operator">:=</span> prof<span class="token punctuation">.</span><span class="token function">RunPermitPlugins</span><span class="token punctuation">(</span>schedulingCycleCtx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// è¯·æ±‚apiserverï¼Œå¼‚æ­¥å¤„ç†æœ€ç»ˆçš„ç»‘å®šï¼Œå†™å…¥åˆ° etcd</span>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Bind volumes first before Pod</span>        <span class="token keyword">if</span> <span class="token operator">!</span>allBound <span class="token punctuation">{</span>            err <span class="token operator">:=</span> sched<span class="token punctuation">.</span><span class="token function">bindVolumes</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ‰§è¡Œ "prebind" plugins</span>        err <span class="token operator">:=</span> sched<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>bindingCycleCtx<span class="token punctuation">,</span> prof<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">,</span> state<span class="token punctuation">)</span>        metrics<span class="token punctuation">.</span>E2eSchedulingLatency<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æ‰§è¡Œ "postbind" plugins</span>            prof<span class="token punctuation">.</span><span class="token function">RunPostBindPlugins</span><span class="token punctuation">(</span>bindingCycleCtx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p><code>scheduleOne()</code> ä¸­é€šè¿‡è°ƒç”¨ <code>sched.schedule()</code> æ¥æ‰§è¡Œé¢„é€‰ä¸ä¼˜é€‰ç®—æ³•å¤„ç†ï¼š</p><p><code>ScheduleAlgorithm</code> æ˜¯ä¸€ä¸ª interfaceï¼Œä¸»è¦åŒ…å«ä¸‰ä¸ªæ–¹æ³•ï¼ŒGenericScheduler æ˜¯å…¶å…·ä½“çš„å®ç°ï¼š</p><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/core/generic_scheduler.go:104</code></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ScheduleAlgorithm is an interface implemented by things that know how to schedule pods</span><span class="token comment" spellcheck="true">// onto machines.</span><span class="token comment" spellcheck="true">// TODO: Rename this type.</span><span class="token keyword">type</span> ScheduleAlgorithm <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token function">Schedule</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">*</span>profile<span class="token punctuation">.</span>Profile<span class="token punctuation">,</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token punctuation">(</span>scheduleResult ScheduleResult<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// Preempt receives scheduling errors for a pod and tries to create room for</span>    <span class="token comment" spellcheck="true">// the pod by preempting lower priority pods if possible.</span>    <span class="token comment" spellcheck="true">// It returns the node where preemption happened, a list of preempted pods, a</span>    <span class="token comment" spellcheck="true">// list of pods whose nominated node name should be removed, and error if any.</span>    <span class="token function">Preempt</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">*</span>profile<span class="token punctuation">.</span>Profile<span class="token punctuation">,</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>selectedNode <span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> preemptedPods <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> cleanupNominatedPods <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// Prioritizers returns a slice of priority config. This is exposed for</span>    <span class="token comment" spellcheck="true">// testing.</span>    <span class="token function">Extenders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>SchedulerExtender<span class="token punctuation">}</span></code></pre><ul><li><code>Schedule()</code>ï¼šæ­£å¸¸è°ƒåº¦é€»è¾‘ï¼ŒåŒ…å«é¢„ç®—ä¸ä¼˜é€‰ç®—æ³•çš„æ‰§è¡Œ</li><li><code>Preempt()</code>ï¼šæŠ¢å ç­–ç•¥ï¼Œåœ¨ pod è°ƒåº¦å‘ç”Ÿå¤±è´¥çš„æ—¶å€™å°è¯•æŠ¢å ä½ä¼˜å…ˆçº§çš„ podï¼Œå‡½æ•°è¿”å›å‘ç”ŸæŠ¢å çš„ nodeï¼Œè¢« æŠ¢å çš„ pods åˆ—è¡¨ï¼Œnominated node name éœ€è¦è¢«ç§»é™¤çš„ pods åˆ—è¡¨ä»¥åŠ error</li><li><code>Extenders()</code> å¤–éƒ¨æµç¨‹</li></ul><h4 id="genericScheduler-Schedule"><a href="#genericScheduler-Schedule" class="headerlink" title="genericScheduler.Schedule()"></a>genericScheduler.Schedule()</h4><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/core/generic_scheduler.go:150</code></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Schedule tries to schedule the given pod to one of the nodes in the node list.</span><span class="token comment" spellcheck="true">// If it succeeds, it will return the name of the node.</span><span class="token comment" spellcheck="true">// If it fails, it will return a FitError error with reasons.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>genericScheduler<span class="token punctuation">)</span> <span class="token function">Schedule</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> prof <span class="token operator">*</span>profile<span class="token punctuation">.</span>Profile<span class="token punctuation">,</span> state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token punctuation">(</span>result ScheduleResult<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    trace <span class="token operator">:=</span> utiltrace<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Scheduling"</span><span class="token punctuation">,</span> utiltrace<span class="token punctuation">.</span>Field<span class="token punctuation">{</span>Key<span class="token punctuation">:</span> <span class="token string">"namespace"</span><span class="token punctuation">,</span> Value<span class="token punctuation">:</span> pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">}</span><span class="token punctuation">,</span> utiltrace<span class="token punctuation">.</span>Field<span class="token punctuation">{</span>Key<span class="token punctuation">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span> Value<span class="token punctuation">:</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> trace<span class="token punctuation">.</span><span class="token function">LogIfLong</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// æ£€æŸ¥ pod pvc </span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">podPassesBasicChecks</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> g<span class="token punctuation">.</span>pvcLister<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> result<span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    trace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">"Basic checks done"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span><span class="token function">snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> result<span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    trace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">"Snapshotting scheduler cache and node infos done"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> g<span class="token punctuation">.</span>nodeInfoSnapshot<span class="token punctuation">.</span><span class="token function">NumNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> result<span class="token punctuation">,</span> ErrNoNodesAvailable    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//æ‰§è¡Œ "prefilter" plugins</span>    preFilterStatus <span class="token operator">:=</span> prof<span class="token punctuation">.</span><span class="token function">RunPreFilterPlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">!</span>preFilterStatus<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> result<span class="token punctuation">,</span> preFilterStatus<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    trace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">"Running prefilter plugins done"</span><span class="token punctuation">)</span>    startPredicateEvalTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// æ‰§è¡Œé¢„é€‰ç®—æ³•</span>    filteredNodes<span class="token punctuation">,</span> filteredNodesStatuses<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span><span class="token function">findNodesThatFitPod</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> prof<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> result<span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    trace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">"Computing predicates done"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>filteredNodes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> result<span class="token punctuation">,</span> <span class="token operator">&amp;</span>FitError<span class="token punctuation">{</span>            Pod<span class="token punctuation">:</span>                   pod<span class="token punctuation">,</span>            NumAllNodes<span class="token punctuation">:</span>           g<span class="token punctuation">.</span>nodeInfoSnapshot<span class="token punctuation">.</span><span class="token function">NumNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            FilteredNodesStatuses<span class="token punctuation">:</span> filteredNodesStatuses<span class="token punctuation">,</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ‰§è¡Œ "prescore" æ’ä»¶.</span>    prescoreStatus <span class="token operator">:=</span> prof<span class="token punctuation">.</span><span class="token function">RunPreScorePlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> filteredNodes<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">!</span>prescoreStatus<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> result<span class="token punctuation">,</span> prescoreStatus<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    trace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">"Running prescore plugins done"</span><span class="token punctuation">)</span>    metrics<span class="token punctuation">.</span>DeprecatedSchedulingAlgorithmPredicateEvaluationSecondsDuration<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>startPredicateEvalTime<span class="token punctuation">)</span><span class="token punctuation">)</span>    metrics<span class="token punctuation">.</span>DeprecatedSchedulingDuration<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>PredicateEvaluation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>startPredicateEvalTime<span class="token punctuation">)</span><span class="token punctuation">)</span>    startPriorityEvalTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// When only one node after predicate, just use it.</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>filteredNodes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>        metrics<span class="token punctuation">.</span>DeprecatedSchedulingAlgorithmPriorityEvaluationSecondsDuration<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>startPriorityEvalTime<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> ScheduleResult<span class="token punctuation">{</span>            SuggestedHost<span class="token punctuation">:</span>  filteredNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span>            EvaluatedNodes<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>filteredNodesStatuses<span class="token punctuation">)</span><span class="token punctuation">,</span>            FeasibleNodes<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ‰§è¡Œä¼˜é€‰ç®—æ³•</span>    priorityList<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span><span class="token function">prioritizeNodes</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> prof<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> filteredNodes<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> result<span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    metrics<span class="token punctuation">.</span>DeprecatedSchedulingAlgorithmPriorityEvaluationSecondsDuration<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>startPriorityEvalTime<span class="token punctuation">)</span><span class="token punctuation">)</span>    metrics<span class="token punctuation">.</span>DeprecatedSchedulingDuration<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>PriorityEvaluation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>startPriorityEvalTime<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// æ®æ‰“åˆ†é€‰æ‹©æœ€ä½³çš„ node</span>    host<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span><span class="token function">selectHost</span><span class="token punctuation">(</span>priorityList<span class="token punctuation">)</span>    trace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">"Prioritizing done"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> ScheduleResult<span class="token punctuation">{</span>        SuggestedHost<span class="token punctuation">:</span>  host<span class="token punctuation">,</span>        EvaluatedNodes<span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>filteredNodes<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>filteredNodesStatuses<span class="token punctuation">)</span><span class="token punctuation">,</span>        FeasibleNodes<span class="token punctuation">:</span>  <span class="token function">len</span><span class="token punctuation">(</span>filteredNodes<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span></code></pre><h3 id="è°ƒåº¦ç®—æ³•-1"><a href="#è°ƒåº¦ç®—æ³•-1" class="headerlink" title="è°ƒåº¦ç®—æ³•"></a>è°ƒåº¦ç®—æ³•</h3><h4 id="é¢„é€‰è°ƒåº¦ç®—æ³•"><a href="#é¢„é€‰è°ƒåº¦ç®—æ³•" class="headerlink" title="é¢„é€‰è°ƒåº¦ç®—æ³•"></a>é¢„é€‰è°ƒåº¦ç®—æ³•</h4><p>predicates ç®—æ³•ä¸»è¦æ˜¯å¯¹é›†ç¾¤ä¸­çš„ node è¿›è¡Œè¿‡æ»¤ï¼Œé€‰å‡ºç¬¦åˆå½“å‰ pod è¿è¡Œçš„ nodesã€‚</p><p>é»˜è®¤çš„è°ƒåº¦ç®—æ³•åœ¨<code>pkg/scheduler/framework/plugins/legacy_registry.go:193</code>ä¸­å®šä¹‰äº†ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Used as the default set of predicates if Policy was specified, but predicates was nil.</span>        DefaultPredicates<span class="token punctuation">:</span> sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span>            NoVolumeZoneConflictPred<span class="token punctuation">,</span>            MaxEBSVolumeCountPred<span class="token punctuation">,</span>            MaxGCEPDVolumeCountPred<span class="token punctuation">,</span>            MaxAzureDiskVolumeCountPred<span class="token punctuation">,</span>            MaxCSIVolumeCountPred<span class="token punctuation">,</span>            MatchInterPodAffinityPred<span class="token punctuation">,</span>            NoDiskConflictPred<span class="token punctuation">,</span>            GeneralPred<span class="token punctuation">,</span>            PodToleratesNodeTaintsPred<span class="token punctuation">,</span>            CheckVolumeBindingPred<span class="token punctuation">,</span>            CheckNodeUnschedulablePred<span class="token punctuation">,</span>        <span class="token punctuation">)</span></code></pre><p>ä¸‹é¢æ˜¯å¯¹é»˜è®¤è°ƒåº¦ç®—æ³•çš„ä¸€äº›è¯´æ˜ï¼š</p><table><thead><tr><th align="left">predicates ç®—æ³•</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">GeneralPred</td><td align="left">GeneralPred åŒ…å« PodFitsResourcesã€PodFitsHost,ã€PodFitsHostPortsã€PodMatchNodeSelector å››ç§ç®—æ³•</td></tr><tr><td align="left">NoDiskConflictPred</td><td align="left">æ£€æŸ¥å¤šä¸ª Pod å£°æ˜æŒ‚è½½çš„æŒä¹…åŒ– Volume æ˜¯å¦æœ‰å†²çª</td></tr><tr><td align="left">MaxGCEPDVolumeCountPred</td><td align="left">æ£€æŸ¥ GCE æŒä¹…åŒ– Volume æ˜¯å¦è¶…è¿‡äº†ä¸€å®šæ•°ç›®</td></tr><tr><td align="left">MaxAzureDiskVolumeCountPred</td><td align="left">æ£€æŸ¥ Azure æŒä¹…åŒ– Volume æ˜¯å¦è¶…è¿‡äº†ä¸€å®šæ•°ç›®</td></tr><tr><td align="left">MaxCSIVolumeCountPred</td><td align="left">æ£€æŸ¥ CSI æŒä¹…åŒ– Volume æ˜¯å¦è¶…è¿‡äº†ä¸€å®šæ•°ç›®ï¼ˆå·²åºŸå¼ƒï¼‰</td></tr><tr><td align="left">MaxEBSVolumeCountPred</td><td align="left">æ£€æŸ¥ EBS æŒä¹…åŒ– Volume æ˜¯å¦è¶…è¿‡äº†ä¸€å®šæ•°ç›®</td></tr><tr><td align="left">NoVolumeZoneConflictPred</td><td align="left">æ£€æŸ¥æŒä¹…åŒ– Volume çš„ Zoneï¼ˆé«˜å¯ç”¨åŸŸï¼‰æ ‡ç­¾æ˜¯å¦ä¸èŠ‚ç‚¹çš„ Zone æ ‡ç­¾ç›¸åŒ¹é…</td></tr><tr><td align="left">CheckVolumeBindingPred</td><td align="left">æ£€æŸ¥è¯¥ Pod å¯¹åº” PV çš„ nodeAffinity å­—æ®µæ˜¯å¦è·ŸæŸä¸ªèŠ‚ç‚¹çš„æ ‡ç­¾ç›¸åŒ¹é…ï¼ŒLocal Persistent Volume(æœ¬åœ°æŒä¹…åŒ–å·)å¿…é¡»ä½¿ç”¨ nodeAffinity æ¥è·ŸæŸä¸ªå…·ä½“çš„èŠ‚ç‚¹ç»‘å®š</td></tr><tr><td align="left">PodToleratesNodeTaintsPred</td><td align="left">æ£€æŸ¥ Node çš„ Taint æœºåˆ¶ï¼Œåªæœ‰å½“ Pod çš„ Toleration å­—æ®µä¸ Node çš„ Taint å­—æ®µèƒ½å¤ŸåŒ¹é…æ—¶ï¼Œè¿™ä¸ª Pod æ‰èƒ½è¢«è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Š</td></tr><tr><td align="left">MatchInterPodAffinityPred</td><td align="left">æ£€æŸ¥å¾…è°ƒåº¦ Pod ä¸ Node ä¸Šçš„å·²æœ‰ Pod ä¹‹é—´çš„äº²å¯†ï¼ˆaffinityï¼‰å’Œåäº²å¯†ï¼ˆanti-affinityï¼‰å…³ç³»</td></tr><tr><td align="left">CheckNodeConditionPred</td><td align="left">æ£€æŸ¥ NodeCondition</td></tr><tr><td align="left">CheckNodePIDPressurePred</td><td align="left">æ£€æŸ¥ NodePIDPressure</td></tr><tr><td align="left">CheckNodeDiskPressurePred</td><td align="left">æ£€æŸ¥ NodeDiskPressure</td></tr><tr><td align="left">CheckNodeMemoryPressurePred</td><td align="left">æ£€æŸ¥ NodeMemoryPressure</td></tr></tbody></table><p>é»˜è®¤çš„ predicates è°ƒåº¦ç®—æ³•ä¸»è¦åˆ†ä¸ºäº”ç§ç±»å‹ï¼š</p><p>ç¬¬ä¸€ç§ç±»å‹å«ä½œ GeneralPredicatesï¼ŒåŒ…å« PodFitsResourcesã€PodFitsHostã€PodFitsHostPortsã€PodMatchNodeSelector å››ç§ç­–ç•¥ï¼Œå…¶å…·ä½“å«ä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>PodFitsHostï¼šæ£€æŸ¥å®¿ä¸»æœºçš„åå­—æ˜¯å¦è·Ÿ Pod çš„ spec.nodeName ä¸€è‡´</li><li>PodFitsHostPortsï¼šæ£€æŸ¥ Pod ç”³è¯·çš„å®¿ä¸»æœºç«¯å£ï¼ˆspec.nodePortï¼‰æ˜¯ä¸æ˜¯è·Ÿå·²ç»è¢«ä½¿ç”¨çš„ç«¯å£æœ‰å†²çª</li><li>PodMatchNodeSelectorï¼šæ£€æŸ¥ Pod çš„ nodeSelector æˆ–è€… nodeAffinity æŒ‡å®šçš„èŠ‚ç‚¹æ˜¯å¦ä¸èŠ‚ç‚¹åŒ¹é…ç­‰</li><li>PodFitsResourcesï¼šæ£€æŸ¥ä¸»æœºçš„èµ„æºæ˜¯å¦æ»¡è¶³ Pod çš„éœ€æ±‚ï¼Œæ ¹æ®å®é™…å·²ç»åˆ†é…ï¼ˆRequestï¼‰çš„èµ„æºé‡åšè°ƒåº¦</li></ul><p>kubelet åœ¨å¯åŠ¨ Pod å‰ï¼Œä¼šæ‰§è¡Œä¸€ä¸ª Admit æ“ä½œæ¥è¿›è¡ŒäºŒæ¬¡ç¡®è®¤ï¼Œè¿™é‡ŒäºŒæ¬¡ç¡®è®¤çš„è§„åˆ™å°±æ˜¯æ‰§è¡Œä¸€é GeneralPredicatesã€‚</p><p>ç¬¬äºŒç§ç±»å‹æ˜¯ä¸ Volume ç›¸å…³çš„è¿‡æ»¤è§„åˆ™ï¼Œä¸»è¦æœ‰NoDiskConflictPredã€MaxGCEPDVolumeCountPredã€MaxAzureDiskVolumeCountPredã€MaxCSIVolumeCountPredã€MaxEBSVolumeCountPredã€NoVolumeZoneConflictPredã€CheckVolumeBindingPredã€‚</p><p>ç¬¬ä¸‰ç§ç±»å‹æ˜¯å®¿ä¸»æœºç›¸å…³çš„è¿‡æ»¤è§„åˆ™ï¼Œä¸»è¦æ˜¯ PodToleratesNodeTaintsPredã€‚</p><p>ç¬¬å››ç§ç±»å‹æ˜¯ Pod ç›¸å…³çš„è¿‡æ»¤è§„åˆ™ï¼Œä¸»è¦æ˜¯ MatchInterPodAffinityPredã€‚</p><p>ç¬¬äº”ç§ç±»å‹æ˜¯æ–°å¢çš„è¿‡æ»¤è§„åˆ™ï¼Œä¸å®¿ä¸»æœºçš„è¿è¡ŒçŠ¶å†µæœ‰å…³ï¼Œä¸»è¦æœ‰ CheckNodeConditionã€ CheckNodeMemoryPressureã€CheckNodePIDPressureã€CheckNodeDiskPressure å››ç§ã€‚è‹¥å¯ç”¨äº† <code>TaintNodesByCondition FeatureGates</code> åˆ™åœ¨ predicates ç®—æ³•ä¸­ä¼šå°†è¯¥å››ç§ç®—æ³•ç§»é™¤ï¼Œ<code>TaintNodesByCondition</code> åŸºäº <a href="https://kubernetes.io/docs/concepts/architecture/nodes/#condition" target="_blank" rel="noopener">node conditions</a> å½“ node å‡ºç° pressure æ—¶è‡ªåŠ¨ä¸º node æ‰“ä¸Š taints æ ‡ç­¾ï¼Œè¯¥åŠŸèƒ½åœ¨ v1.8 å¼•å…¥ï¼Œv1.12 æˆä¸º beta ç‰ˆæœ¬ï¼Œç›®å‰ v1.16 ä¸­ä¹Ÿæ˜¯ beta ç‰ˆæœ¬ï¼Œä½†åœ¨ v1.13 ä¸­è¯¥åŠŸèƒ½å·²é»˜è®¤å¯ç”¨ã€‚</p><p>predicates è°ƒåº¦ç®—æ³•ä¹Ÿæœ‰ä¸€ä¸ªé¡ºåºï¼Œè¦ä¸ç„¶åœ¨ä¸€å°èµ„æºå·²ç»ä¸¥é‡ä¸è¶³çš„å®¿ä¸»æœºä¸Šï¼Œä¸Šæ¥å°±å¼€å§‹è®¡ç®— PodAffinityPredicate æ˜¯æ²¡æœ‰å®é™…æ„ä¹‰çš„ï¼Œå…¶é»˜è®¤é¡ºåºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/framework/plugins/legacy_registry.go:137</code></p><pre><code>// PredicateOrdering returns the ordering of predicate execution.func PredicateOrdering() []string {    return []string{CheckNodeUnschedulablePred,        GeneralPred, HostNamePred, PodFitsHostPortsPred,        MatchNodeSelectorPred, PodFitsResourcesPred, NoDiskConflictPred,        PodToleratesNodeTaintsPred, CheckNodeLabelPresencePred,        CheckServiceAffinityPred, MaxEBSVolumeCountPred, MaxGCEPDVolumeCountPred, MaxCSIVolumeCountPred,        MaxAzureDiskVolumeCountPred, MaxCinderVolumeCountPred, CheckVolumeBindingPred, NoVolumeZoneConflictPred,        EvenPodsSpreadPred, MatchInterPodAffinityPred}}</code></pre><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Filters the nodes to find the ones that fit the pod based on the framework</span><span class="token comment" spellcheck="true">// filter plugins and filter extenders.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>genericScheduler<span class="token punctuation">)</span> <span class="token function">findNodesThatFitPod</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> prof <span class="token operator">*</span>profile<span class="token punctuation">.</span>Profile<span class="token punctuation">,</span> state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> framework<span class="token punctuation">.</span>NodeToStatusMap<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    filteredNodesStatuses <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>framework<span class="token punctuation">.</span>NodeToStatusMap<span class="token punctuation">)</span>    filtered<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span><span class="token function">findNodesThatPassFilters</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> prof<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> filteredNodesStatuses<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    filtered<span class="token punctuation">,</span> err <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">findNodesThatPassExtenders</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> filtered<span class="token punctuation">,</span> filteredNodesStatuses<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">return</span> filtered<span class="token punctuation">,</span> filteredNodesStatuses<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>genericScheduler<span class="token punctuation">)</span> <span class="token function">findNodesThatPassFilters</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> prof <span class="token operator">*</span>profile<span class="token punctuation">.</span>Profile<span class="token punctuation">,</span> state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> statuses framework<span class="token punctuation">.</span>NodeToStatusMap<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ä»å¿«ç…§ä¸­è·å–æ‰€æœ‰èŠ‚ç‚¹</span>    allNodes<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span>nodeInfoSnapshot<span class="token punctuation">.</span><span class="token function">NodeInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// è®¾å®šæœ€å¤šéœ€è¦æ£€æŸ¥çš„èŠ‚ç‚¹æ•°</span>    numNodesToFind <span class="token operator">:=</span> g<span class="token punctuation">.</span><span class="token function">numFeasibleNodesToFind</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>allNodes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    filtered <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> numNodesToFind<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">!</span>prof<span class="token punctuation">.</span><span class="token function">HasFilterPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> filtered <span class="token punctuation">{</span>            filtered<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> allNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        g<span class="token punctuation">.</span>nextStartNodeIndex <span class="token operator">=</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span>nextStartNodeIndex <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>filtered<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">len</span><span class="token punctuation">(</span>allNodes<span class="token punctuation">)</span>        <span class="token keyword">return</span> filtered<span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    errCh <span class="token operator">:=</span> util<span class="token punctuation">.</span><span class="token function">NewErrorChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> statusesLock sync<span class="token punctuation">.</span>Mutex    <span class="token keyword">var</span> filteredLen <span class="token builtin">int32</span>    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// checkNode ä¸ºæ‰§è¡Œé¢„é€‰ç®—æ³•çš„å‡½æ•°</span>    checkNode <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// We check the nodes starting from where we left off in the previous scheduling cycle,</span>        <span class="token comment" spellcheck="true">// this is to make sure all nodes have the same chance of being examined across pods.</span>        nodeInfo <span class="token operator">:=</span> allNodes<span class="token punctuation">[</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>nextStartNodeIndex<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">%</span><span class="token function">len</span><span class="token punctuation">(</span>allNodes<span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token comment" spellcheck="true">// podFitsOnNode æœ€ç»ˆæ‰§è¡Œé¢„é€‰ç®—æ³•çš„å‡½æ•° </span>        fits<span class="token punctuation">,</span> status<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span><span class="token function">podPassesFiltersOnNode</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> prof<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            errCh<span class="token punctuation">.</span><span class="token function">SendErrorWithCancel</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> cancel<span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> fits <span class="token punctuation">{</span>            length <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>filteredLen<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> length <span class="token operator">></span> numNodesToFind <span class="token punctuation">{</span>                <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>filteredLen<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                filtered<span class="token punctuation">[</span>length<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token operator">=</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            statusesLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                statuses<span class="token punctuation">[</span>nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> status            <span class="token punctuation">}</span>            statusesLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    beginCheckNode <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    statusCode <span class="token operator">:=</span> framework<span class="token punctuation">.</span>Success    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        metrics<span class="token punctuation">.</span>FrameworkExtensionPointDuration<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>framework<span class="token punctuation">.</span>Filter<span class="token punctuation">,</span> statusCode<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>beginCheckNode<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// å¯åŠ¨ 16 ä¸ª goroutine å¹¶å‘æ‰§è¡Œ checkNode å‡½æ•°</span>    workqueue<span class="token punctuation">.</span><span class="token function">ParallelizeUntil</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>allNodes<span class="token punctuation">)</span><span class="token punctuation">,</span> checkNode<span class="token punctuation">)</span>    processedNodes <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>filteredLen<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>statuses<span class="token punctuation">)</span>    g<span class="token punctuation">.</span>nextStartNodeIndex <span class="token operator">=</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span>nextStartNodeIndex <span class="token operator">+</span> processedNodes<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">len</span><span class="token punctuation">(</span>allNodes<span class="token punctuation">)</span>    filtered <span class="token operator">=</span> filtered<span class="token punctuation">[</span><span class="token punctuation">:</span>filteredLen<span class="token punctuation">]</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> errCh<span class="token punctuation">.</span><span class="token function">ReceiveError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        statusCode <span class="token operator">=</span> framework<span class="token punctuation">.</span>Error        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">return</span> filtered<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>è‹¥é…ç½®äº† extender åˆ™å†æ¬¡è¿›è¡Œè¿‡æ»¤:</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>genericScheduler<span class="token punctuation">)</span> <span class="token function">findNodesThatPassExtenders</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> filtered <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> statuses framework<span class="token punctuation">.</span>NodeToStatusMap<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> extender <span class="token operator">:=</span> <span class="token keyword">range</span> g<span class="token punctuation">.</span>extenders <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>filtered<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token keyword">break</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token operator">!</span>extender<span class="token punctuation">.</span><span class="token function">IsInterested</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        filteredList<span class="token punctuation">,</span> failedMap<span class="token punctuation">,</span> err <span class="token operator">:=</span> extender<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> filtered<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> extender<span class="token punctuation">.</span><span class="token function">IsIgnorable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"Skipping extender %v as it returned error %v and has ignorable flag set"</span><span class="token punctuation">,</span>                    extender<span class="token punctuation">,</span> err<span class="token punctuation">)</span>                <span class="token keyword">continue</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        <span class="token keyword">for</span> failedNodeName<span class="token punctuation">,</span> failedMsg <span class="token operator">:=</span> <span class="token keyword">range</span> failedMap <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> found <span class="token operator">:=</span> statuses<span class="token punctuation">[</span>failedNodeName<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>                statuses<span class="token punctuation">[</span>failedNodeName<span class="token punctuation">]</span> <span class="token operator">=</span> framework<span class="token punctuation">.</span><span class="token function">NewStatus</span><span class="token punctuation">(</span>framework<span class="token punctuation">.</span>Unschedulable<span class="token punctuation">,</span> failedMsg<span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                statuses<span class="token punctuation">[</span>failedNodeName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">AppendReason</span><span class="token punctuation">(</span>failedMsg<span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        filtered <span class="token operator">=</span> filteredList    <span class="token punctuation">}</span>    <span class="token keyword">return</span> filtered<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p><code>findNodesThatFit()</code> æ˜¯ predicates ç­–ç•¥çš„å®é™…è°ƒç”¨æ–¹æ³•ï¼Œå…¶åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è®¾å®šæœ€å¤šéœ€è¦æ£€æŸ¥çš„èŠ‚ç‚¹æ•°ï¼Œä½œä¸ºé¢„é€‰èŠ‚ç‚¹æ•°ç»„çš„å®¹é‡ï¼Œé¿å…æ€»èŠ‚ç‚¹è¿‡å¤šå½±å“è°ƒåº¦æ•ˆç‡</li><li>é€šè¿‡<code>NodeTree()</code>ä¸æ–­è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ¥åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³ pod çš„è°ƒåº¦æ¡ä»¶</li><li>é€šè¿‡ä¹‹å‰æ³¨å†Œçš„å„ç§ predicates å‡½æ•°æ¥åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ç¬¦åˆ pod çš„è°ƒåº¦æ¡ä»¶</li><li>æœ€åè¿”å›æ»¡è¶³è°ƒåº¦æ¡ä»¶çš„ node åˆ—è¡¨ï¼Œä¾›ä¸‹ä¸€æ­¥çš„ä¼˜é€‰æ“ä½œ</li></ul><p><code>checkNode()</code>æ˜¯ä¸€ä¸ªæ ¡éªŒ node æ˜¯å¦ç¬¦åˆè¦æ±‚çš„å‡½æ•°ï¼Œå…¶å®é™…è°ƒç”¨åˆ°çš„æ ¸å¿ƒå‡½æ•°æ˜¯<code>podFitsOnNode()</code>ï¼Œå†é€šè¿‡<code>workqueue()</code> å¹¶å‘æ‰§è¡Œ<code>checkNode()</code> å‡½æ•°ï¼Œ<code>workqueue()</code> ä¼šå¯åŠ¨ 16 ä¸ª goroutine æ¥å¹¶è¡Œè®¡ç®—éœ€è¦ç­›é€‰çš„ node åˆ—è¡¨ï¼Œå…¶ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>é€šè¿‡ cache ä¸­çš„ <code>NodeTree()</code> ä¸æ–­è·å–ä¸‹ä¸€ä¸ª node</li><li>å°†å½“å‰ node å’Œ pod ä¼ å…¥<code>podFitsOnNode()</code> æ–¹æ³•ä¸­æ¥åˆ¤æ–­å½“å‰ node æ˜¯å¦ç¬¦åˆè¦æ±‚</li><li>å¦‚æœå½“å‰ node ç¬¦åˆè¦æ±‚å°±å°†å½“å‰ node åŠ å…¥é¢„é€‰èŠ‚ç‚¹çš„æ•°ç»„ä¸­<code>filtered</code></li><li>å¦‚æœå½“å‰ node ä¸æ»¡è¶³è¦æ±‚ï¼Œåˆ™åŠ å…¥åˆ°å¤±è´¥çš„æ•°ç»„ä¸­ï¼Œå¹¶è®°å½•åŸå› </li><li>é€šè¿‡<code>workqueue.ParallelizeUntil()</code>å¹¶å‘æ‰§è¡Œ<code>checkNode()</code>å‡½æ•°ï¼Œä¸€æ—¦æ‰¾åˆ°è¶³å¤Ÿçš„å¯è¡ŒèŠ‚ç‚¹æ•°åå°±åœæ­¢ç­›é€‰æ›´å¤šèŠ‚ç‚¹</li><li>è‹¥é…ç½®äº† extender åˆ™å†æ¬¡è¿›è¡Œè¿‡æ»¤å·²ç­›é€‰å‡ºçš„ node</li></ul><p>ç„¶åç»§ç»­çœ‹å¦‚ä½•è®¾å®šæœ€å¤šéœ€è¦æ£€æŸ¥çš„èŠ‚ç‚¹æ•°ï¼Œæ­¤è¿‡ç¨‹ç”±<code>numFeasibleNodesToFind()</code>è¿›è¡Œå¤„ç†ï¼ŒåŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å¦‚æœæ€»çš„ node èŠ‚ç‚¹å°äº<code>minFeasibleNodesToFind</code>(é»˜è®¤ä¸º100)åˆ™ç›´æ¥è¿”å›æ€»èŠ‚ç‚¹æ•°</li><li>å¦‚æœèŠ‚ç‚¹æ•°è¶…è¿‡ 100ï¼Œåˆ™å–æŒ‡å®šç™¾åˆ†æ¯” <code>percentageOfNodesToScore</code>(é»˜è®¤å€¼ä¸º 50)çš„èŠ‚ç‚¹æ•° ï¼Œå½“è¯¥ç™¾åˆ†æ¯”åçš„æ•°ç›®ä»å°äº<code>minFeasibleNodesToFind</code>ï¼Œåˆ™è¿”å›<code>minFeasibleNodesToFind</code></li><li>å¦‚æœç™¾åˆ†æ¯”åçš„æ•°ç›®å¤§äº<code>minFeasibleNodesToFind</code>ï¼Œåˆ™è¿”å›è¯¥ç™¾åˆ†æ¯”çš„èŠ‚ç‚¹æ•°</li></ul><p>æ‰€ä»¥å½“èŠ‚ç‚¹æ•°å°äº 100 æ—¶ç›´æ¥è¿”å›ï¼Œå¤§äº 100 æ—¶åªè¿”å›å…¶æ€»æ•°çš„ 50%ã€‚<code>percentageOfNodesToScore</code> å‚æ•°åœ¨ v1.12 å¼•å…¥ï¼Œé»˜è®¤å€¼ä¸º 50ï¼Œkube-scheduler åœ¨å¯åŠ¨æ—¶å¯ä»¥è®¾å®šè¯¥å‚æ•°çš„å€¼ã€‚</p><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/core/generic_scheduler.go:390</code></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// numFeasibleNodesToFind returns the number of feasible nodes that once found, the scheduler stops</span><span class="token comment" spellcheck="true">// its search for more feasible nodes.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>genericScheduler<span class="token punctuation">)</span> <span class="token function">numFeasibleNodesToFind</span><span class="token punctuation">(</span>numAllNodes <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>numNodes <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> numAllNodes <span class="token operator">&lt;</span> minFeasibleNodesToFind <span class="token operator">||</span> g<span class="token punctuation">.</span>percentageOfNodesToScore <span class="token operator">>=</span> <span class="token number">100</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> numAllNodes    <span class="token punctuation">}</span>    adaptivePercentage <span class="token operator">:=</span> g<span class="token punctuation">.</span>percentageOfNodesToScore    <span class="token keyword">if</span> adaptivePercentage <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        basePercentageOfNodesToScore <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>        adaptivePercentage <span class="token operator">=</span> basePercentageOfNodesToScore <span class="token operator">-</span> numAllNodes<span class="token operator">/</span><span class="token number">125</span>        <span class="token keyword">if</span> adaptivePercentage <span class="token operator">&lt;</span> minFeasibleNodesPercentageToFind <span class="token punctuation">{</span>            adaptivePercentage <span class="token operator">=</span> minFeasibleNodesPercentageToFind        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    numNodes <span class="token operator">=</span> numAllNodes <span class="token operator">*</span> adaptivePercentage <span class="token operator">/</span> <span class="token number">100</span>    <span class="token keyword">if</span> numNodes <span class="token operator">&lt;</span> minFeasibleNodesToFind <span class="token punctuation">{</span>        <span class="token keyword">return</span> minFeasibleNodesToFind    <span class="token punctuation">}</span>    <span class="token keyword">return</span> numNodes<span class="token punctuation">}</span></code></pre><p>pridicates è°ƒåº¦ç®—æ³•çš„æ ¸å¿ƒæ˜¯ <code>podPassesFiltersOnNode()</code> ï¼Œscheduler çš„æŠ¢å æœºåˆ¶ä¹Ÿä¼šæ‰§è¡Œè¯¥å‡½æ•°ï¼Œ<code>podPassesFiltersOnNode()</code>åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>éå†å·²ç»æ³¨å†Œå¥½çš„é¢„é€‰ç­–ç•¥<code>predicates.Ordering()</code>ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œå¯¹åº”çš„ç­–ç•¥å‡½æ•°</li><li>éå†æ‰§è¡Œæ¯ä¸ªç­–ç•¥å‡½æ•°ï¼Œå¹¶è¿”å›æ˜¯å¦åˆé€‚ï¼Œé¢„é€‰å¤±è´¥çš„åŸå› å’Œé”™è¯¯</li><li>å¦‚æœé¢„é€‰å‡½æ•°æ‰§è¡Œå¤±è´¥ï¼Œåˆ™åŠ å…¥é¢„é€‰å¤±è´¥çš„æ•°ç»„ä¸­ï¼Œç›´æ¥è¿”å›ï¼Œåé¢çš„é¢„é€‰å‡½æ•°ä¸ä¼šå†æ‰§è¡Œ</li><li>å¦‚æœè¯¥ node ä¸Šå­˜åœ¨ nominated pod åˆ™æ‰§è¡Œä¸¤æ¬¡é¢„é€‰å‡½æ•°</li></ul><p>å› ä¸ºå¼•å…¥äº†æŠ¢å æœºåˆ¶ï¼Œæ­¤å¤„ä¸»è¦è¯´æ˜ä¸€ä¸‹æ‰§è¡Œä¸¤æ¬¡é¢„é€‰å‡½æ•°çš„åŸå› ï¼š</p><p>ç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œè‹¥è¯¥ pod ä¸ºæŠ¢å è€…(<code>nominatedPods</code>)ï¼Œè°ƒåº¦å™¨ä¼šå‡è®¾è¯¥ pod å·²ç»è¿è¡Œåœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼Œç„¶åæ›´æ–°<code>meta</code>å’Œ<code>nodeInfo</code>ï¼Œ<code>nominatedPods</code>æ˜¯æŒ‡æ‰§è¡Œäº†æŠ¢å æœºåˆ¶ä¸”å·²ç»åˆ†é…åˆ°äº† node(<code>pod.Status.NominatedNodeName</code> å·²è¢«è®¾å®š) ä½†æ˜¯è¿˜æ²¡æœ‰çœŸæ­£è¿è¡Œèµ·æ¥çš„ podï¼Œç„¶åå†æ‰§è¡Œæ‰€æœ‰çš„é¢„é€‰å‡½æ•°ã€‚</p><p>ç¬¬äºŒæ¬¡å¾ªç¯ï¼Œä¸å°†<code>nominatedPods</code>åŠ å…¥åˆ° node å†…ã€‚</p><p>è€Œåªæœ‰è¿™ä¸¤é predicates ç®—æ³•éƒ½èƒ½é€šè¿‡æ—¶ï¼Œè¿™ä¸ª pod å’Œ node æ‰ä¼šè¢«è®¤ä¸ºæ˜¯å¯ä»¥ç»‘å®š(bind)çš„ã€‚è¿™æ ·åšæ˜¯å› ä¸ºè€ƒè™‘åˆ° pod affinity ç­‰ç­–ç•¥çš„æ‰§è¡Œï¼Œå¦‚æœå½“å‰çš„ pod ä¸<code>nominatedPods</code>æœ‰ä¾èµ–å…³ç³»å°±ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸º<code>nominatedPods</code>ä¸èƒ½ä¿è¯ä¸€å®šå¯ä»¥è°ƒåº¦ä¸”åœ¨å·²æŒ‡å®šçš„ node è¿è¡ŒæˆåŠŸï¼Œä¹Ÿå¯èƒ½å‡ºç°è¢«å…¶ä»–é«˜ä¼˜å…ˆçº§çš„ pod æŠ¢å ç­‰é—®é¢˜ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// podPassesFiltersOnNode checks whether a node given by NodeInfo satisfies the</span><span class="token comment" spellcheck="true">// filter plugins.</span><span class="token comment" spellcheck="true">// This function is called from two different places: Schedule and Preempt.</span><span class="token comment" spellcheck="true">// When it is called from Schedule, we want to test whether the pod is</span><span class="token comment" spellcheck="true">// schedulable on the node with all the existing pods on the node plus higher</span><span class="token comment" spellcheck="true">// and equal priority pods nominated to run on the node.</span><span class="token comment" spellcheck="true">// When it is called from Preempt, we should remove the victims of preemption</span><span class="token comment" spellcheck="true">// and add the nominated pods. Removal of the victims is done by</span><span class="token comment" spellcheck="true">// SelectVictimsOnNode(). Preempt removes victims from PreFilter state and</span><span class="token comment" spellcheck="true">// NodeInfo before calling this function.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>genericScheduler<span class="token punctuation">)</span> <span class="token function">podPassesFiltersOnNode</span><span class="token punctuation">(</span>    ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>    prof <span class="token operator">*</span>profile<span class="token punctuation">.</span>Profile<span class="token punctuation">,</span>    state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span>    pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span>    info <span class="token operator">*</span>schedulernodeinfo<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> status <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status    podsAdded <span class="token operator">:=</span> <span class="token boolean">false</span>    <span class="token comment" spellcheck="true">// We run filters twice in some cases. If the node has greater or equal priority</span>    <span class="token comment" spellcheck="true">// nominated pods, we run them when those pods are added to PreFilter state and nodeInfo.</span>    <span class="token comment" spellcheck="true">// If all filters succeed in this pass, we run them again when these</span>    <span class="token comment" spellcheck="true">// nominated pods are not added. This second pass is necessary because some</span>    <span class="token comment" spellcheck="true">// filters such as inter-pod affinity may not pass without the nominated pods.</span>    <span class="token comment" spellcheck="true">// If there are no nominated pods for the node or if the first run of the</span>    <span class="token comment" spellcheck="true">// filters fail, we don't run the second pass.</span>    <span class="token comment" spellcheck="true">// We consider only equal or higher priority pods in the first pass, because</span>    <span class="token comment" spellcheck="true">// those are the current "pod" must yield to them and not take a space opened</span>    <span class="token comment" spellcheck="true">// for running them. It is ok if the current "pod" take resources freed for</span>    <span class="token comment" spellcheck="true">// lower priority pods.</span>    <span class="token comment" spellcheck="true">// Requiring that the new pod is schedulable in both circumstances ensures that</span>    <span class="token comment" spellcheck="true">// we are making a conservative decision: filters like resources and inter-pod</span>    <span class="token comment" spellcheck="true">// anti-affinity are more likely to fail when the nominated pods are treated</span>    <span class="token comment" spellcheck="true">// as running, while filters like pod affinity are more likely to fail when</span>    <span class="token comment" spellcheck="true">// the nominated pods are treated as not running. We can't just assume the</span>    <span class="token comment" spellcheck="true">// nominated pods are running because they are not running right now and in fact,</span>    <span class="token comment" spellcheck="true">// they may end up getting scheduled to a different node.</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        stateToUse <span class="token operator">:=</span> state        nodeInfoToUse <span class="token operator">:=</span> info        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡å¾ªç¯åŠ å…¥ NominatedPodsï¼Œè®¡ç®— nodeInfo</span>            <span class="token keyword">var</span> err <span class="token builtin">error</span>            podsAdded<span class="token punctuation">,</span> stateToUse<span class="token punctuation">,</span> nodeInfoToUse<span class="token punctuation">,</span> err <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">addNominatedPods</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> prof<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> state<span class="token punctuation">,</span> info<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token operator">!</span>podsAdded <span class="token operator">||</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">break</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ‰§è¡Œè¿‡æ»¤æ’ä»¶</span>        statusMap <span class="token operator">:=</span> prof<span class="token punctuation">.</span><span class="token function">RunFilterPlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> stateToUse<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeInfoToUse<span class="token punctuation">)</span>        status <span class="token operator">=</span> statusMap<span class="token punctuation">.</span><span class="token function">Merge</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">IsUnschedulable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> status<span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> status<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>framework<span class="token punctuation">)</span> <span class="token function">RunFilterPlugins</span><span class="token punctuation">(</span>    ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>    state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span>    pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span>    nodeInfo <span class="token operator">*</span>schedulernodeinfo<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span><span class="token punctuation">)</span> PluginToStatus <span class="token punctuation">{</span>    <span class="token keyword">var</span> firstFailedStatus <span class="token operator">*</span>Status    statuses <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>PluginToStatus<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// éå†é¢„é€‰ç®—æ³•æ’ä»¶</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pl <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>filterPlugins <span class="token punctuation">{</span>        pluginStatus <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">runFilterPlugin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pl<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">)</span><span class="token operator">...</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> statuses<span class="token punctuation">}</span></code></pre><h4 id="ä¼˜é€‰è°ƒåº¦ç®—æ³•"><a href="#ä¼˜é€‰è°ƒåº¦ç®—æ³•" class="headerlink" title="ä¼˜é€‰è°ƒåº¦ç®—æ³•"></a>ä¼˜é€‰è°ƒåº¦ç®—æ³•</h4><p>priorities è°ƒåº¦ç®—æ³•æ˜¯åœ¨ pridicates ç®—æ³•åæ‰§è¡Œçš„ï¼Œä¸»è¦åŠŸèƒ½æ˜¯å¯¹å·²ç»è¿‡æ»¤å‡ºçš„ nodes è¿›è¡Œæ‰“åˆ†å¹¶é€‰å‡ºæœ€ä½³çš„ä¸€ä¸ª nodeã€‚</p><p>é»˜è®¤çš„è°ƒåº¦ç®—æ³•åœ¨: <code>pkg/scheduler/framework/plugins/legacy_registry.go:208</code></p><pre class=" language-go"><code class="language-go">        <span class="token comment" spellcheck="true">// Used as the default set of predicates if Policy was specified, but priorities was nil.</span>        DefaultPriorities<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{</span>            SelectorSpreadPriority<span class="token punctuation">:</span>      <span class="token number">1</span><span class="token punctuation">,</span>            InterPodAffinityPriority<span class="token punctuation">:</span>    <span class="token number">1</span><span class="token punctuation">,</span>            LeastRequestedPriority<span class="token punctuation">:</span>      <span class="token number">1</span><span class="token punctuation">,</span>            BalancedResourceAllocation<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>            NodePreferAvoidPodsPriority<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>            NodeAffinityPriority<span class="token punctuation">:</span>        <span class="token number">1</span><span class="token punctuation">,</span>            TaintTolerationPriority<span class="token punctuation">:</span>     <span class="token number">1</span><span class="token punctuation">,</span>            ImageLocalityPriority<span class="token punctuation">:</span>       <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre><p>é»˜è®¤è°ƒåº¦ç®—æ³•çš„ä¸€äº›è¯´æ˜ï¼š</p><table><thead><tr><th align="left">priorities ç®—æ³•</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">SelectorSpreadPriority</td><td align="left">æŒ‰ serviceï¼Œrsï¼Œstatefulset å½’å±è®¡ç®— Node ä¸Šåˆ†å¸ƒæœ€å°‘çš„åŒç±» Podæ•°é‡ï¼Œæ•°é‡è¶Šå°‘å¾—åˆ†è¶Šé«˜ï¼Œé»˜è®¤æƒé‡ä¸º1</td></tr><tr><td align="left">InterPodAffinityPriority</td><td align="left">pod äº²å’Œæ€§é€‰æ‹©ç­–ç•¥ï¼Œé»˜è®¤æƒé‡ä¸º1</td></tr><tr><td align="left">LeastRequestedPriority</td><td align="left">é€‰æ‹©ç©ºé—²èµ„æºï¼ˆCPU å’Œ Memoryï¼‰æœ€å¤šçš„èŠ‚ç‚¹ï¼Œé»˜è®¤æƒé‡ä¸º1ï¼Œå…¶è®¡ç®—æ–¹å¼ä¸ºï¼šscore = (cpu((capacity-sum(requested))10/capacity) + memory((capacity-sum(requested))10/capacity))/2</td></tr><tr><td align="left">BalancedResourceAllocation</td><td align="left">CPUã€Memory ä»¥åŠ Volume èµ„æºåˆ†é…æœ€å‡è¡¡çš„èŠ‚ç‚¹ï¼Œé»˜è®¤æƒé‡ä¸º1ï¼Œå…¶è®¡ç®—æ–¹å¼ä¸ºï¼šscore = 10 - variance(cpuFraction,memoryFraction,volumeFraction)*10</td></tr><tr><td align="left">NodePreferAvoidPodsPriority</td><td align="left">åˆ¤æ–­ node annotation æ˜¯å¦æœ‰scheduler.alpha.kubernetes.io/preferAvoidPods æ ‡ç­¾ï¼Œç±»ä¼¼äº taints æœºåˆ¶ï¼Œè¿‡æ»¤æ ‡ç­¾ä¸­å®šä¹‰ç±»å‹çš„ podï¼Œé»˜è®¤æƒé‡ä¸º10000</td></tr><tr><td align="left">NodeAffinityPriority</td><td align="left">èŠ‚ç‚¹äº²å’Œæ€§é€‰æ‹©ç­–ç•¥ï¼Œé»˜è®¤æƒé‡ä¸º1</td></tr><tr><td align="left">TaintTolerationPriority</td><td align="left">Pod æ˜¯å¦å®¹å¿èŠ‚ç‚¹ä¸Šçš„ Taintï¼Œä¼˜å…ˆè°ƒåº¦åˆ°æ ‡è®°äº† Taint çš„èŠ‚ç‚¹ï¼Œé»˜è®¤æƒé‡ä¸º1</td></tr><tr><td align="left">ImageLocalityPriority</td><td align="left">å¾…è°ƒåº¦ Pod éœ€è¦ä½¿ç”¨çš„é•œåƒæ˜¯å¦å­˜åœ¨äºè¯¥èŠ‚ç‚¹ï¼Œé»˜è®¤æƒé‡ä¸º1</td></tr></tbody></table><p>æ‰§è¡Œ priorities è°ƒåº¦ç®—æ³•çš„é€»è¾‘æ˜¯åœ¨ <code>PrioritizeNodes()</code>å‡½æ•°ä¸­ï¼Œå…¶ç›®çš„æ˜¯æ‰§è¡Œæ¯ä¸ª priority å‡½æ•°ä¸º node æ‰“åˆ†ï¼Œåˆ†æ•°ä¸º 0-10ï¼Œå…¶åŠŸèƒ½ä¸»è¦æœ‰ï¼š</p><ul><li><code>PrioritizeNodes()</code> é€šè¿‡å¹¶è¡Œè¿è¡Œå„ä¸ªä¼˜å…ˆçº§å‡½æ•°æ¥å¯¹èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†</li><li>æ¯ä¸ªä¼˜å…ˆçº§å‡½æ•°ä¼šç»™èŠ‚ç‚¹æ‰“åˆ†ï¼Œæ‰“åˆ†èŒƒå›´ä¸º 0-10 åˆ†ï¼Œ0 è¡¨ç¤ºä¼˜å…ˆçº§æœ€ä½çš„èŠ‚ç‚¹ï¼Œ10è¡¨ç¤ºä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹</li><li>æ¯ä¸ªä¼˜å…ˆçº§å‡½æ•°æœ‰å„è‡ªçš„æƒé‡</li><li>ä¼˜å…ˆçº§å‡½æ•°è¿”å›çš„èŠ‚ç‚¹åˆ†æ•°ä¹˜ä»¥æƒé‡ä»¥è·å¾—åŠ æƒåˆ†æ•°</li><li>æœ€åè®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„æ€»åŠ æƒåˆ†æ•°</li></ul><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/core/generic_scheduler.go:626</code></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// prioritizeNodes prioritizes the nodes by running the score plugins,</span><span class="token comment" spellcheck="true">// which return a score for each node from the call to RunScorePlugins().</span><span class="token comment" spellcheck="true">// The scores from each plugin are added together to make the score for that node, then</span><span class="token comment" spellcheck="true">// any extenders are run as well.</span><span class="token comment" spellcheck="true">// All scores are finally combined (added) to get the total weighted scores of all nodes</span><span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>genericScheduler<span class="token punctuation">)</span> <span class="token function">prioritizeNodes</span><span class="token punctuation">(</span>    ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>    prof <span class="token operator">*</span>profile<span class="token punctuation">.</span>Profile<span class="token punctuation">,</span>    state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span>    pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span>    nodes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>framework<span class="token punctuation">.</span>NodeScoreList<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// If no priority configs are provided, then all nodes will have a score of one.</span>    <span class="token comment" spellcheck="true">// This is required to generate the priority list in the required format</span>    <span class="token comment" spellcheck="true">// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†æ•°æ’ä»¶</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>extenders<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>prof<span class="token punctuation">.</span><span class="token function">HasScorePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>framework<span class="token punctuation">.</span>NodeScoreList<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> nodes <span class="token punctuation">{</span>            result <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> framework<span class="token punctuation">.</span>NodeScore<span class="token punctuation">{</span>                Name<span class="token punctuation">:</span>  nodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span>                Score<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> result<span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Run the Score plugins.</span>    <span class="token comment" spellcheck="true">// è¿è¡Œåˆ†æ•°æ’ä»¶</span>    scoresMap<span class="token punctuation">,</span> scoreStatus <span class="token operator">:=</span> prof<span class="token punctuation">.</span><span class="token function">RunScorePlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">!</span>scoreStatus<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> framework<span class="token punctuation">.</span>NodeScoreList<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> scoreStatus<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Summarize all scores.</span>    <span class="token comment" spellcheck="true">// æ”¶é›†æ‰€æœ‰åˆ†æ•°</span>    result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>framework<span class="token punctuation">.</span>NodeScoreList<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> nodes <span class="token punctuation">{</span>        result <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> framework<span class="token punctuation">.</span>NodeScore<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> nodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span> Score<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token keyword">range</span> scoresMap <span class="token punctuation">{</span>            result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score <span class="token operator">+=</span> scoresMap<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ‰§è¡Œ extender </span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>extenders<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nodes <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>Mutex        <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup        combinedScores <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> g<span class="token punctuation">.</span>extenders <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token operator">!</span>g<span class="token punctuation">.</span>extenders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">IsInterested</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">continue</span>            <span class="token punctuation">}</span>            wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>extIndex <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                metrics<span class="token punctuation">.</span>SchedulerGoroutines<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span><span class="token string">"prioritizing_extender"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    metrics<span class="token punctuation">.</span>SchedulerGoroutines<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span><span class="token string">"prioritizing_extender"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Dec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                prioritizedList<span class="token punctuation">,</span> weight<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span>extenders<span class="token punctuation">[</span>extIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Prioritize</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// Prioritization errors from extender can be ignored, let k8s/other extenders determine the priorities</span>                    <span class="token keyword">return</span>                <span class="token punctuation">}</span>                mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token operator">*</span>prioritizedList <span class="token punctuation">{</span>                    host<span class="token punctuation">,</span> score <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>prioritizedList<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Host<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>prioritizedList<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score                    <span class="token keyword">if</span> klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"%v -> %v: %v, Score: (%d)"</span><span class="token punctuation">,</span> util<span class="token punctuation">.</span><span class="token function">GetPodFullName</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> host<span class="token punctuation">,</span> g<span class="token punctuation">.</span>extenders<span class="token punctuation">[</span>extIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> score<span class="token punctuation">)</span>                    <span class="token punctuation">}</span>                    combinedScores<span class="token punctuation">[</span>host<span class="token punctuation">]</span> <span class="token operator">+=</span> score <span class="token operator">*</span> weight                <span class="token punctuation">}</span>                mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// wait for all go routines to finish</span>        wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> result <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// MaxExtenderPriority may diverge from the max priority used in the scheduler and defined by MaxNodeScore,</span>            <span class="token comment" spellcheck="true">// therefore we need to scale the score returned by extenders to the score range used by the scheduler.</span>            result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score <span class="token operator">+=</span> combinedScores<span class="token punctuation">[</span>result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span>framework<span class="token punctuation">.</span>MaxNodeScore <span class="token operator">/</span> extenderv1<span class="token punctuation">.</span>MaxExtenderPriority<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> result <span class="token punctuation">{</span>            klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Host %s => Score %d"</span><span class="token punctuation">,</span> result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span> result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> result<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><h4 id="æŠ¢å ç®—æ³•"><a href="#æŠ¢å ç®—æ³•" class="headerlink" title="æŠ¢å ç®—æ³•"></a>æŠ¢å ç®—æ³•</h4><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ª pod è°ƒåº¦å¤±è´¥åï¼Œå°±ä¼šè¢«æš‚æ—¶ â€œæç½®â€ å¤„äº <code>pending</code> çŠ¶æ€ï¼Œç›´åˆ° pod è¢«æ›´æ–°æˆ–è€…é›†ç¾¤çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œè°ƒåº¦å™¨æ‰ä¼šå¯¹è¿™ä¸ª pod è¿›è¡Œé‡æ–°è°ƒåº¦ã€‚ä½†åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ä¼šå­˜åœ¨åœ¨çº¿ä¸ç¦»çº¿ä¸šåŠ¡ä¹‹åˆ†ï¼Œè‹¥åœ¨çº¿ä¸šåŠ¡çš„ pod å› èµ„æºä¸è¶³è€Œè°ƒåº¦å¤±è´¥æ—¶ï¼Œæ­¤æ—¶å°±éœ€è¦ç¦»çº¿ä¸šåŠ¡ä¸‹æ‰ä¸€éƒ¨åˆ†ä¸ºåœ¨çº¿ä¸šåŠ¡æä¾›èµ„æºï¼Œå³åœ¨çº¿ä¸šåŠ¡è¦æŠ¢å ç¦»çº¿ä¸šåŠ¡çš„èµ„æºï¼Œæ­¤æ—¶å°±éœ€è¦ scheduler çš„ä¼˜å…ˆçº§å’ŒæŠ¢å æœºåˆ¶äº†ï¼Œè¯¥æœºåˆ¶è§£å†³çš„æ˜¯ pod è°ƒåº¦å¤±è´¥æ—¶è¯¥æ€ä¹ˆåŠçš„é—®é¢˜ï¼Œè‹¥è¯¥ pod çš„ä¼˜å…ˆçº§æ¯”è¾ƒé«˜æ­¤æ—¶å¹¶ä¸ä¼šè¢«â€æç½®â€ï¼Œè€Œæ˜¯ä¼šâ€æŒ¤èµ°â€æŸä¸ª node ä¸Šçš„ä¸€äº›ä½ä¼˜å…ˆçº§çš„ podï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯é«˜ä¼˜å…ˆçº§çš„ pod è°ƒåº¦æˆåŠŸã€‚</p><p>æŠ¢å å‘ç”Ÿçš„åŸå› ï¼Œä¸€å®šæ˜¯ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„ pod è°ƒåº¦å¤±è´¥ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ª pod ä¸ºâ€œæŠ¢å è€…â€ï¼Œç§°è¢«æŠ¢å çš„ pod ä¸ºâ€œç‰ºç‰²è€…â€(victims)ã€‚è€Œ kubernetes è°ƒåº¦å™¨å®ç°æŠ¢å ç®—æ³•çš„ä¸€ä¸ªæœ€é‡è¦çš„è®¾è®¡ï¼Œå°±æ˜¯åœ¨è°ƒåº¦é˜Ÿåˆ—çš„å®ç°é‡Œï¼Œä½¿ç”¨äº†ä¸¤ä¸ªä¸åŒçš„é˜Ÿåˆ—ã€‚</p><p>ç¬¬ä¸€ä¸ªé˜Ÿåˆ—å«ä½œ activeQï¼Œå‡¡æ˜¯åœ¨ activeQ é‡Œçš„ podï¼Œéƒ½æ˜¯ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸéœ€è¦è°ƒåº¦çš„å¯¹è±¡ã€‚æ‰€ä»¥ï¼Œå½“ä½ åœ¨ kubernetes é›†ç¾¤é‡Œæ–°åˆ›å»ºä¸€ä¸ª pod çš„æ—¶å€™ï¼Œè°ƒåº¦å™¨ä¼šå°†è¿™ä¸ª pod å…¥é˜Ÿåˆ° activeQ é‡Œé¢ï¼Œè°ƒåº¦å™¨ä¸æ–­ä»é˜Ÿåˆ—é‡Œå‡ºé˜Ÿ(pop)ä¸€ä¸ª pod è¿›è¡Œè°ƒåº¦ï¼Œå®é™…ä¸Šéƒ½æ˜¯ä» activeQ é‡Œå‡ºé˜Ÿçš„ã€‚</p><p>ç¬¬äºŒä¸ªé˜Ÿåˆ—å«ä½œ unschedulableQï¼Œä¸“é—¨ç”¨æ¥å­˜æ”¾è°ƒåº¦å¤±è´¥çš„ podï¼Œå½“ä¸€ä¸ª unschedulableQ é‡Œçš„ pod è¢«æ›´æ–°ä¹‹åï¼Œè°ƒåº¦å™¨ä¼šè‡ªåŠ¨æŠŠè¿™ä¸ª pod ç§»åŠ¨åˆ° activeQ é‡Œï¼Œä»è€Œç»™è¿™äº›è°ƒåº¦å¤±è´¥çš„ pod â€œé‡æ–°åšäººâ€çš„æœºä¼šã€‚</p><p>å½“ pod æ‹¥æœ‰äº†ä¼˜å…ˆçº§ä¹‹åï¼Œé«˜ä¼˜å…ˆçº§çš„ pod å°±å¯èƒ½ä¼šæ¯”ä½ä¼˜å…ˆçº§çš„ pod æå‰å‡ºé˜Ÿï¼Œä»è€Œå°½æ—©å®Œæˆè°ƒåº¦è¿‡ç¨‹ã€‚</p><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/internal/queue/scheduling_queue.go:202</code></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// NewPriorityQueue creates a PriorityQueue object.</span><span class="token keyword">func</span> <span class="token function">NewPriorityQueue</span><span class="token punctuation">(</span>    lessFn framework<span class="token punctuation">.</span>LessFunc<span class="token punctuation">,</span>    opts <span class="token operator">...</span>Option<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">*</span>PriorityQueue <span class="token punctuation">{</span>    options <span class="token operator">:=</span> defaultPriorityQueueOptions    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>        <span class="token function">opt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>options<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    comp <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>podInfo1<span class="token punctuation">,</span> podInfo2 <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>        pInfo1 <span class="token operator">:=</span> podInfo1<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>framework<span class="token punctuation">.</span>PodInfo<span class="token punctuation">)</span>        pInfo2 <span class="token operator">:=</span> podInfo2<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>framework<span class="token punctuation">.</span>PodInfo<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">lessFn</span><span class="token punctuation">(</span>pInfo1<span class="token punctuation">,</span> pInfo2<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    pq <span class="token operator">:=</span> <span class="token operator">&amp;</span>PriorityQueue<span class="token punctuation">{</span>        clock<span class="token punctuation">:</span>                     options<span class="token punctuation">.</span>clock<span class="token punctuation">,</span>        stop<span class="token punctuation">:</span>                      <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        podInitialBackoffDuration<span class="token punctuation">:</span> options<span class="token punctuation">.</span>podInitialBackoffDuration<span class="token punctuation">,</span>        podMaxBackoffDuration<span class="token punctuation">:</span>     options<span class="token punctuation">.</span>podMaxBackoffDuration<span class="token punctuation">,</span>        activeQ<span class="token punctuation">:</span>                   heap<span class="token punctuation">.</span><span class="token function">NewWithRecorder</span><span class="token punctuation">(</span>podInfoKeyFunc<span class="token punctuation">,</span> comp<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span><span class="token function">NewActivePodsRecorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        unschedulableQ<span class="token punctuation">:</span>            <span class="token function">newUnschedulablePodsMap</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">NewUnschedulablePodsRecorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        nominatedPods<span class="token punctuation">:</span>             <span class="token function">newNominatedPodMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        moveRequestCycle<span class="token punctuation">:</span>          <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    pq<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>L <span class="token operator">=</span> <span class="token operator">&amp;</span>pq<span class="token punctuation">.</span>lock    pq<span class="token punctuation">.</span>podBackoffQ <span class="token operator">=</span> heap<span class="token punctuation">.</span><span class="token function">NewWithRecorder</span><span class="token punctuation">(</span>podInfoKeyFunc<span class="token punctuation">,</span> pq<span class="token punctuation">.</span>podsCompareBackoffCompleted<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span><span class="token function">NewBackoffPodsRecorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> pq<span class="token punctuation">}</span></code></pre><p>å‰é¢æˆ‘ä»¬çŸ¥é“<code>scheduleOne()</code> æ˜¯æ‰§è¡Œè°ƒåº¦ç®—æ³•çš„ä¸»é€»è¾‘ï¼Œå…¶ä¸»è¦åŠŸèƒ½æœ‰ï¼š</p><ul><li>è°ƒç”¨ <code>sched.schedule()</code>ï¼Œå³æ‰§è¡Œ predicates ç®—æ³•å’Œ priorities ç®—æ³•</li><li>è‹¥æ‰§è¡Œå¤±è´¥ï¼Œä¼šè¿”å› <code>core.FitError</code></li><li>è‹¥å¼€å¯äº†æŠ¢å æœºåˆ¶ï¼Œåˆ™æ‰§è¡ŒæŠ¢å æœºåˆ¶</li><li>â€¦â€¦</li></ul><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/scheduler.go:548</code></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>sched <span class="token operator">*</span>Scheduler<span class="token punctuation">)</span> <span class="token function">scheduleOne</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>    podInfo <span class="token operator">:=</span> sched<span class="token punctuation">.</span><span class="token function">NextPod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token operator">...</span>    scheduleResult<span class="token punctuation">,</span> err <span class="token operator">:=</span> sched<span class="token punctuation">.</span>Algorithm<span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span>schedulingCycleCtx<span class="token punctuation">,</span> prof<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// predicates ç®—æ³•å’Œ priorities ç®—æ³•æ‰§è¡Œå¤±è´¥</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> fitError<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>core<span class="token punctuation">.</span>FitError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok             <span class="token comment" spellcheck="true">// æ˜¯å¦å¼€å¯æŠ¢å æœºåˆ¶</span>            <span class="token keyword">if</span> sched<span class="token punctuation">.</span>DisablePreemption <span class="token punctuation">{</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// æ‰§è¡ŒæŠ¢å æœºåˆ¶</span>                preemptionStartTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                sched<span class="token punctuation">.</span><span class="token function">preempt</span><span class="token punctuation">(</span>schedulingCycleCtx<span class="token punctuation">,</span> prof<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> fitError<span class="token punctuation">)</span>                metrics<span class="token punctuation">.</span>PreemptionAttempts<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token operator">...</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token punctuation">}</span>        sched<span class="token punctuation">.</span><span class="token function">recordSchedulingFailure</span><span class="token punctuation">(</span>prof<span class="token punctuation">,</span> podInfo<span class="token punctuation">.</span><span class="token function">DeepCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>PodReasonUnschedulable<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬ä¸»è¦æ¥çœ‹å…¶ä¸­çš„æŠ¢å æœºåˆ¶ï¼Œ<code>sched.preempt()</code> æ˜¯æ‰§è¡ŒæŠ¢å æœºåˆ¶çš„ä¸»é€»è¾‘ï¼Œä¸»è¦åŠŸèƒ½æœ‰ï¼š</p><ul><li>ä» apiserver è·å– pod info</li><li>è°ƒç”¨ <code>sched.Algorithm.Preempt()</code>æ‰§è¡ŒæŠ¢å é€»è¾‘ï¼Œè¯¥å‡½æ•°ä¼šè¿”å›æŠ¢å æˆåŠŸçš„ nodeã€è¢«æŠ¢å çš„ pods(victims) ä»¥åŠéœ€è¦è¢«ç§»é™¤å·²æåçš„ pods</li><li>æ›´æ–° scheduler ç¼“å­˜ï¼Œä¸ºæŠ¢å è€…ç»‘å®š nodeNameï¼Œå³è®¾å®š pod.Status.NominatedNodeName</li><li>å°† pod info æäº¤åˆ° apiserver</li><li>åˆ é™¤è¢«æŠ¢å çš„ pods</li><li>åˆ é™¤è¢«æŠ¢å  pods çš„ NominatedNodeName å­—æ®µ</li></ul><p>å¯ä»¥çœ‹åˆ°å½“ä¸Šè¿°æŠ¢å è¿‡ç¨‹å‘ç”Ÿæ—¶ï¼ŒæŠ¢å è€…å¹¶ä¸ä¼šç«‹åˆ»è¢«è°ƒåº¦åˆ°è¢«æŠ¢å çš„ node ä¸Šï¼Œè°ƒåº¦å™¨åªä¼šå°†æŠ¢å è€…çš„ status.nominatedNodeName å­—æ®µè®¾ç½®ä¸ºè¢«æŠ¢å çš„ node çš„åå­—ã€‚ç„¶åï¼ŒæŠ¢å è€…ä¼šé‡æ–°è¿›å…¥ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸï¼Œåœ¨æ–°çš„è°ƒåº¦å‘¨æœŸé‡Œæ¥å†³å®šæ˜¯ä¸æ˜¯è¦è¿è¡Œåœ¨è¢«æŠ¢å çš„èŠ‚ç‚¹ä¸Šï¼Œå½“ç„¶ï¼Œå³ä½¿åœ¨ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸï¼Œè°ƒåº¦å™¨ä¹Ÿä¸ä¼šä¿è¯æŠ¢å è€…ä¸€å®šä¼šè¿è¡Œåœ¨è¢«æŠ¢å çš„èŠ‚ç‚¹ä¸Šã€‚</p><p>è¿™æ ·è®¾è®¡çš„ä¸€ä¸ªé‡è¦åŸå› æ˜¯è°ƒåº¦å™¨åªä¼šé€šè¿‡æ ‡å‡†çš„ DELETE API æ¥åˆ é™¤è¢«æŠ¢å çš„ podï¼Œæ‰€ä»¥ï¼Œè¿™äº› pod å¿…ç„¶æ˜¯æœ‰ä¸€å®šçš„â€œä¼˜é›…é€€å‡ºâ€æ—¶é—´ï¼ˆé»˜è®¤æ˜¯ 30sï¼‰çš„ã€‚è€Œåœ¨è¿™æ®µæ—¶é—´é‡Œï¼Œå…¶ä»–çš„èŠ‚ç‚¹ä¹Ÿæ˜¯æœ‰å¯èƒ½å˜æˆå¯è°ƒåº¦çš„ï¼Œæˆ–è€…ç›´æ¥æœ‰æ–°çš„èŠ‚ç‚¹è¢«æ·»åŠ åˆ°è¿™ä¸ªé›†ç¾¤ä¸­æ¥ã€‚æ‰€ä»¥ï¼Œé‰´äºä¼˜é›…é€€å‡ºæœŸé—´é›†ç¾¤çš„å¯è°ƒåº¦æ€§å¯èƒ½ä¼šå‘ç”Ÿçš„å˜åŒ–ï¼ŒæŠŠæŠ¢å è€…äº¤ç»™ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸå†å¤„ç†ï¼Œæ˜¯ä¸€ä¸ªéå¸¸åˆç†çš„é€‰æ‹©ã€‚è€Œåœ¨æŠ¢å è€…ç­‰å¾…è¢«è°ƒåº¦çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰å…¶ä»–æ›´é«˜ä¼˜å…ˆçº§çš„ pod ä¹Ÿè¦æŠ¢å åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆè°ƒåº¦å™¨å°±ä¼šæ¸…ç©ºåŸæŠ¢å è€…çš„ status.nominatedNodeName å­—æ®µï¼Œä»è€Œå…è®¸æ›´é«˜ä¼˜å…ˆçº§çš„æŠ¢å è€…æ‰§è¡ŒæŠ¢å ï¼Œå¹¶ä¸”ï¼Œè¿™ä¹Ÿä½¿å¾—åŸæŠ¢å è€…æœ¬èº«ä¹Ÿæœ‰æœºä¼šå»é‡æ–°æŠ¢å å…¶ä»–èŠ‚ç‚¹ã€‚ä»¥ä¸Šè¿™äº›éƒ½æ˜¯è®¾ç½® <code>nominatedNodeName</code> å­—æ®µçš„ä¸»è¦ç›®çš„ã€‚</p><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/scheduler.go:392</code></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>sched <span class="token operator">*</span>Scheduler<span class="token punctuation">)</span> <span class="token function">preempt</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> prof <span class="token operator">*</span>profile<span class="token punctuation">.</span>Profile<span class="token punctuation">,</span> state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> preemptor <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> scheduleErr <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// è·å– pod info</span>    preemptor<span class="token punctuation">,</span> err <span class="token operator">:=</span> sched<span class="token punctuation">.</span>podPreemptor<span class="token punctuation">.</span><span class="token function">getUpdatedPod</span><span class="token punctuation">(</span>preemptor<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// æ‰§è¡ŒæŠ¢å ç®—æ³•</span>    node<span class="token punctuation">,</span> victims<span class="token punctuation">,</span> nominatedPodsToClear<span class="token punctuation">,</span> err <span class="token operator">:=</span> sched<span class="token punctuation">.</span>Algorithm<span class="token punctuation">.</span><span class="token function">Preempt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> prof<span class="token punctuation">,</span> state<span class="token punctuation">,</span> preemptor<span class="token punctuation">,</span> scheduleErr<span class="token punctuation">)</span>    <span class="token keyword">var</span> nodeName <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">if</span> node <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        nodeName <span class="token operator">=</span> node<span class="token punctuation">.</span>Name        <span class="token comment" spellcheck="true">// Update the scheduling queue with the nominated pod information. Without</span>        <span class="token comment" spellcheck="true">// this, there would be a race condition between the next scheduling cycle</span>        <span class="token comment" spellcheck="true">// and the time the scheduler receives a Pod Update for the nominated pod.</span>        <span class="token comment" spellcheck="true">// æ›´æ–° scheduler ç¼“å­˜ï¼Œä¸ºæŠ¢å è€…ç»‘å®š nodenameï¼Œå³è®¾å®š pod.Status.NominatedNodeName</span>        sched<span class="token punctuation">.</span>SchedulingQueue<span class="token punctuation">.</span><span class="token function">UpdateNominatedPodForNode</span><span class="token punctuation">(</span>preemptor<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// Make a call to update nominated node name of the pod on the API server.</span>        <span class="token comment" spellcheck="true">// å°† pod info æäº¤åˆ° apiserver</span>        err <span class="token operator">=</span> sched<span class="token punctuation">.</span>podPreemptor<span class="token punctuation">.</span><span class="token function">setNominatedNodeName</span><span class="token punctuation">(</span>preemptor<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Error in preemption process. Cannot set 'NominatedPod' on pod %v/%v: %v"</span><span class="token punctuation">,</span> preemptor<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> preemptor<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            sched<span class="token punctuation">.</span>SchedulingQueue<span class="token punctuation">.</span><span class="token function">DeleteNominatedPodIfExists</span><span class="token punctuation">(</span>preemptor<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åˆ é™¤è¢«æŠ¢å çš„ pods</span>        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> victim <span class="token operator">:=</span> <span class="token keyword">range</span> victims <span class="token punctuation">{</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> sched<span class="token punctuation">.</span>podPreemptor<span class="token punctuation">.</span><span class="token function">deletePod</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Error preempting pod %v/%v: %v"</span><span class="token punctuation">,</span> victim<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> victim<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// If the victim is a WaitingPod, send a reject message to the PermitPlugin</span>            <span class="token keyword">if</span> waitingPod <span class="token operator">:=</span> prof<span class="token punctuation">.</span><span class="token function">GetWaitingPod</span><span class="token punctuation">(</span>victim<span class="token punctuation">.</span>UID<span class="token punctuation">)</span><span class="token punctuation">;</span> waitingPod <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                waitingPod<span class="token punctuation">.</span><span class="token function">Reject</span><span class="token punctuation">(</span><span class="token string">"preempted"</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>            prof<span class="token punctuation">.</span>Recorder<span class="token punctuation">.</span><span class="token function">Eventf</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> preemptor<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>EventTypeNormal<span class="token punctuation">,</span> <span class="token string">"Preempted"</span><span class="token punctuation">,</span> <span class="token string">"Preempting"</span><span class="token punctuation">,</span> <span class="token string">"Preempted by %v/%v on node %v"</span><span class="token punctuation">,</span> preemptor<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> preemptor<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        metrics<span class="token punctuation">.</span>PreemptionVictims<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>victims<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Clearing nominated pods should happen outside of "if node != nil". Node could</span>    <span class="token comment" spellcheck="true">// be nil when a pod with nominated node name is eligible to preempt again,</span>    <span class="token comment" spellcheck="true">// but preemption logic does not find any node for it. In that case Preempt()</span>    <span class="token comment" spellcheck="true">// function of generic_scheduler.go returns the pod itself for removal of</span>    <span class="token comment" spellcheck="true">// the 'NominatedPod' field.</span>     <span class="token comment" spellcheck="true">// åˆ é™¤è¢«æŠ¢å  pods çš„ NominatedNodeName å­—æ®µ</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> nominatedPodsToClear <span class="token punctuation">{</span>        rErr <span class="token operator">:=</span> sched<span class="token punctuation">.</span>podPreemptor<span class="token punctuation">.</span><span class="token function">removeNominatedNodeName</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>        <span class="token keyword">if</span> rErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Cannot remove 'NominatedPod' field of pod: %v"</span><span class="token punctuation">,</span> rErr<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// We do not return as this error is not critical.</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> nodeName<span class="token punctuation">,</span> err<span class="token punctuation">}</span></code></pre><p><code>preempt()</code>ä¸­ä¼šè°ƒç”¨ <code>sched.Algorithm.Preempt()</code>æ¥æ‰§è¡Œå®é™…æŠ¢å çš„ç®—æ³•ï¼Œå…¶ä¸»è¦åŠŸèƒ½æœ‰ï¼š</p><ul><li>åˆ¤æ–­ err æ˜¯å¦ä¸º <code>FitError</code></li><li>è°ƒç”¨<code>podEligibleToPreemptOthers()</code>ç¡®è®¤ pod æ˜¯å¦æœ‰æŠ¢å å…¶ä»– pod çš„èµ„æ ¼ï¼Œè‹¥ pod å·²ç»æŠ¢å äº†ä½ä¼˜å…ˆçº§çš„ podï¼Œè¢«æŠ¢å çš„ pod å¤„äº terminating çŠ¶æ€ä¸­ï¼Œåˆ™ä¸ä¼šç»§ç»­è¿›è¡ŒæŠ¢å </li><li>å¦‚æœç¡®å®šæŠ¢å å¯ä»¥å‘ç”Ÿï¼Œè°ƒåº¦å™¨ä¼šæŠŠè‡ªå·±ç¼“å­˜çš„æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯å¤åˆ¶ä¸€ä»½ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªå‰¯æœ¬æ¥æ¨¡æ‹ŸæŠ¢å è¿‡ç¨‹</li><li>è¿‡æ»¤é¢„é€‰å¤±è´¥çš„ node åˆ—è¡¨ï¼Œæ­¤å¤„ä¼šæ£€æŸ¥ predicates å¤±è´¥çš„åŸå› ï¼Œè‹¥å­˜åœ¨ NodeSelectorNotMatchã€PodNotMatchHostName è¿™äº› error åˆ™ä¸èƒ½æˆä¸ºæŠ¢å è€…ï¼Œå¦‚æœè¿‡æ»¤å‡ºçš„å€™é€‰ node ä¸ºç©ºåˆ™è¿”å›æŠ¢å è€…ä½œä¸º nominatedPodsToClear</li><li>è·å– <code>PodDisruptionBudget</code> å¯¹è±¡</li><li>ä»é¢„é€‰å¤±è´¥çš„ node åˆ—è¡¨ä¸­å¹¶å‘è®¡ç®—å¯ä»¥è¢«æŠ¢å çš„ nodesï¼Œå¾—åˆ° <code>nodeToVictims</code></li><li>è‹¥å£°æ˜äº† extenders åˆ™è°ƒç”¨ extenders å†æ¬¡è¿‡æ»¤ <code>nodeToVictims</code></li><li>è°ƒç”¨ <code>pickOneNodeForPreemption()</code> ä» <code>nodeToVictims</code> ä¸­é€‰å‡ºä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºæœ€ä½³å€™é€‰äºº</li><li>ç§»é™¤ä½ä¼˜å…ˆçº§ pod çš„ <code>Nominated</code>ï¼Œæ›´æ–°è¿™äº› podï¼Œç§»åŠ¨åˆ° activeQ é˜Ÿåˆ—ä¸­ï¼Œè®©è°ƒåº¦å™¨ä¸ºè¿™äº› pod é‡æ–° bind node</li></ul><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/core/generic_scheduler.go:270</code></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>genericScheduler<span class="token punctuation">)</span> <span class="token function">Preempt</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> prof <span class="token operator">*</span>profile<span class="token punctuation">.</span>Profile<span class="token punctuation">,</span> state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> scheduleErr <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Scheduler may return various types of errors. Consider preemption only if</span>    <span class="token comment" spellcheck="true">// the error is of type FitError.</span>    fitError<span class="token punctuation">,</span> ok <span class="token operator">:=</span> scheduleErr<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>FitError<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> fitError <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­ pod æ˜¯å¦æ”¯æŒæŠ¢å ï¼Œè‹¥ pod å·²ç»æŠ¢å äº†ä½ä¼˜å…ˆçº§çš„ podï¼Œè¢«æŠ¢å çš„ pod å¤„äº terminating çŠ¶æ€ä¸­ï¼Œåˆ™ä¸ä¼šç»§ç»­è¿›è¡ŒæŠ¢å </span>    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">podEligibleToPreemptOthers</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> g<span class="token punctuation">.</span>nodeInfoSnapshot<span class="token punctuation">.</span><span class="token function">NodeInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>enableNonPreempting<span class="token punctuation">)</span> <span class="token punctuation">{</span>        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Pod %v/%v is not eligible for more preemption."</span><span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ä»é•œåƒä¸­è·å– node list</span>    allNodes<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span>nodeInfoSnapshot<span class="token punctuation">.</span><span class="token function">NodeInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>allNodes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrNoNodesAvailable    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è¿‡æ»¤ predicates ç®—æ³•æ‰§è¡Œå¤±è´¥çš„ node ä½œä¸ºæŠ¢å çš„å€™é€‰ node</span>    potentialNodes <span class="token operator">:=</span> <span class="token function">nodesWherePreemptionMightHelp</span><span class="token punctuation">(</span>allNodes<span class="token punctuation">,</span> fitError<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// å¦‚æœè¿‡æ»¤å‡ºçš„å€™é€‰ node ä¸ºç©ºåˆ™è¿”å›æŠ¢å è€…ä½œä¸º nominatedPodsToClear</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>potentialNodes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Preemption will not help schedule pod %v/%v on any node."</span><span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// In this case, we should clean-up any existing nominated node name of the pod.</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">{</span>pod<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> pdbs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>policy<span class="token punctuation">.</span>PodDisruptionBudget    <span class="token keyword">if</span> g<span class="token punctuation">.</span>pdbLister <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        pdbs<span class="token punctuation">,</span> err <span class="token operator">=</span> g<span class="token punctuation">.</span>pdbLister<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>labels<span class="token punctuation">.</span><span class="token function">Everything</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è¿‡æ»¤å‡ºå¯ä»¥æŠ¢å çš„ node åˆ—è¡¨</span>    nodeToVictims<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span><span class="token function">selectNodesForPreemption</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> prof<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> potentialNodes<span class="token punctuation">,</span> pdbs<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// We will only check nodeToVictims with extenders that support preemption.</span>    <span class="token comment" spellcheck="true">// Extenders which do not support preemption may later prevent preemptor from being scheduled on the nominated</span>    <span class="token comment" spellcheck="true">// node. In that case, scheduler will find a different host for the preemptor in subsequent scheduling cycles.</span>    <span class="token comment" spellcheck="true">// è‹¥æœ‰ extender åˆ™æ‰§è¡Œ</span>    nodeToVictims<span class="token punctuation">,</span> err <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">processPreemptionWithExtenders</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> nodeToVictims<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// é€‰å‡ºæœ€ä½³çš„ node</span>    candidateNode <span class="token operator">:=</span> <span class="token function">pickOneNodeForPreemption</span><span class="token punctuation">(</span>nodeToVictims<span class="token punctuation">)</span>    <span class="token keyword">if</span> candidateNode <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Lower priority pods nominated to run on this node, may no longer fit on</span>    <span class="token comment" spellcheck="true">// this node. So, we should remove their nomination. Removing their</span>    <span class="token comment" spellcheck="true">// nomination updates these pods and moves them to the active queue. It</span>    <span class="token comment" spellcheck="true">// lets scheduler find another place for them.</span>    <span class="token comment" spellcheck="true">// ç§»é™¤ä½ä¼˜å…ˆçº§ pod çš„ Nominatedï¼Œæ›´æ–°è¿™äº› podï¼Œç§»åŠ¨åˆ° activeQ é˜Ÿåˆ—ä¸­ï¼Œè®©è°ƒåº¦å™¨</span>    <span class="token comment" spellcheck="true">// ä¸ºè¿™äº› pod é‡æ–° bind node</span>    nominatedPods <span class="token operator">:=</span> g<span class="token punctuation">.</span><span class="token function">getLowerPriorityNominatedPods</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> candidateNode<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>    <span class="token keyword">return</span> candidateNode<span class="token punctuation">,</span> nodeToVictims<span class="token punctuation">[</span>candidateNode<span class="token punctuation">]</span><span class="token punctuation">.</span>Pods<span class="token punctuation">,</span> nominatedPods<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>è¯¥å‡½æ•°ä¸­è°ƒç”¨äº†å¤šä¸ªå‡½æ•°ï¼š</p><ul><li><code>nodesWherePreemptionMightHelp()</code>ï¼šè¿‡æ»¤ predicates ç®—æ³•æ‰§è¡Œå¤±è´¥çš„ node</li><li><code>selectNodesForPreemption()</code>ï¼šè¿‡æ»¤å‡ºå¯ä»¥æŠ¢å çš„ node åˆ—è¡¨</li><li><code>pickOneNodeForPreemption()</code>ï¼šé€‰å‡ºæœ€ä½³çš„ node</li><li><code>getLowerPriorityNominatedPods()</code>ï¼šç§»é™¤ä½ä¼˜å…ˆçº§ pod çš„ Nominated</li></ul><p><code>selectNodesForPreemption()</code> ä» prediacates ç®—æ³•æ‰§è¡Œå¤±è´¥çš„ node åˆ—è¡¨ä¸­æ¥å¯»æ‰¾å¯ä»¥è¢«æŠ¢å çš„ nodeï¼Œé€šè¿‡<code>workqueue.ParallelizeUntil()</code>å¹¶å‘æ‰§è¡Œ<code>checkNode()</code>å‡½æ•°æ£€æŸ¥ nodeã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// selectNodesForPreemption finds all the nodes with possible victims for</span><span class="token comment" spellcheck="true">// preemption in parallel.</span><span class="token keyword">func</span> <span class="token function">selectNodesForPreemption</span><span class="token punctuation">(</span>    ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>    pr framework<span class="token punctuation">.</span>PluginsRunner<span class="token punctuation">,</span>    nominator framework<span class="token punctuation">.</span>PodNominator<span class="token punctuation">,</span>    state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span>    pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span>    potentialNodes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>framework<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span>    pdbs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>policy<span class="token punctuation">.</span>PodDisruptionBudget<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>extenderv1<span class="token punctuation">.</span>Victims<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    nodeNameToVictims <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>extenderv1<span class="token punctuation">.</span>Victims<span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">var</span> resultLock sync<span class="token punctuation">.</span>Mutex     <span class="token comment" spellcheck="true">// checkNode å‡½æ•°</span>    checkNode <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        nodeInfoCopy <span class="token operator">:=</span> potentialNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        stateCopy <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ selectVictimsOnNode å‡½æ•°è¿›è¡Œæ£€æŸ¥</span>        pods<span class="token punctuation">,</span> numPDBViolations<span class="token punctuation">,</span> fits <span class="token operator">:=</span> <span class="token function">selectVictimsOnNode</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pr<span class="token punctuation">,</span> nominator<span class="token punctuation">,</span> stateCopy<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeInfoCopy<span class="token punctuation">,</span> pdbs<span class="token punctuation">)</span>        <span class="token keyword">if</span> fits <span class="token punctuation">{</span>            resultLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            victims <span class="token operator">:=</span> extenderv1<span class="token punctuation">.</span>Victims<span class="token punctuation">{</span>                Pods<span class="token punctuation">:</span>             pods<span class="token punctuation">,</span>                NumPDBViolations<span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span>numPDBViolations<span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token punctuation">}</span>            nodeNameToVictims<span class="token punctuation">[</span>potentialNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>victims            resultLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å¯åŠ¨é»˜è®¤ 16 ä¸ª goroutine å¹¶å‘æ‰§è¡Œ</span>    parallelize<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>potentialNodes<span class="token punctuation">)</span><span class="token punctuation">,</span> checkNode<span class="token punctuation">)</span>    <span class="token keyword">return</span> nodeNameToVictims<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>å…¶ä¸­è°ƒç”¨çš„<code>selectVictimsOnNode()</code>æ˜¯æ¥è·å–æ¯ä¸ª node ä¸Š victims pod çš„ï¼Œé¦–å…ˆç§»é™¤æ‰€æœ‰ä½ä¼˜å…ˆçº§çš„ pod å°è¯•æŠ¢å è€…æ˜¯å¦å¯ä»¥è°ƒåº¦æˆåŠŸï¼Œå¦‚æœèƒ½å¤Ÿè°ƒåº¦æˆåŠŸï¼Œç„¶ååŸºäº pod æ˜¯å¦æœ‰ PDB è¢«åˆ†ä¸ºä¸¤ç»„ <code>violatingVictims</code> å’Œ <code>nonViolatingVictims</code>ï¼Œå†å¯¹æ¯ä¸€ç»„çš„ pod æŒ‰ä¼˜å…ˆçº§è¿›è¡Œæ’åºã€‚PDB(pod ä¸­æ–­é¢„ç®—)æ˜¯ kubernetes ä¿è¯å‰¯æœ¬é«˜å¯ç”¨çš„ä¸€ä¸ªå¯¹è±¡ã€‚</p><p>ç„¶åå¼€å§‹é€ä¸€â€åˆ é™¤â€œ pod å³è¦åˆ æ‰æœ€å°‘çš„ pod æ•°æ¥å®Œæˆè¿™æ¬¡æŠ¢å å³å¯ï¼Œå…ˆä» <code>violatingVictims</code>(æœ‰PDB)çš„ä¸€ç»„ä¸­è¿›è¡Œâ€åˆ é™¤â€œ podï¼Œå¹¶ä¸”è®°å½•åˆ é™¤æœ‰ PDB pod çš„æ•°é‡ï¼Œç„¶åå†â€œåˆ é™¤â€ <code>nonViolatingVictims</code> ç»„ä¸­çš„ podï¼Œæ¯æ¬¡â€åˆ é™¤â€œä¸€ä¸ª pod éƒ½è¦æ£€æŸ¥ä¸€ä¸‹æŠ¢å è€…æ˜¯å¦èƒ½å¤Ÿè¿è¡Œåœ¨è¯¥ node ä¸Šå³æ‰§è¡Œä¸€æ¬¡é¢„é€‰ç­–ç•¥ï¼Œè‹¥æ‰§è¡Œé¢„é€‰ç­–ç•¥å¤±è´¥åˆ™è¯¥ node å½“å‰ä¸æ»¡è¶³æŠ¢å éœ€è¦ç»§ç»­â€åˆ é™¤â€œ pod å¹¶å°†è¯¥ pod åŠ å…¥åˆ° victims ä¸­ï¼Œç›´åˆ°â€åˆ é™¤â€œè¶³å¤Ÿå¤šçš„ pod å¯ä»¥æ»¡è¶³æŠ¢å ï¼Œæœ€åè¿”å› victims ä»¥åŠåˆ é™¤æœ‰ PDB pod çš„æ•°é‡ã€‚</p><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/core/generic_scheduler.go:942</code></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">selectVictimsOnNode</span><span class="token punctuation">(</span>    ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>    pr framework<span class="token punctuation">.</span>PluginsRunner<span class="token punctuation">,</span>    nominator framework<span class="token punctuation">.</span>PodNominator<span class="token punctuation">,</span>    state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span>    pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span>    nodeInfo <span class="token operator">*</span>framework<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span>    pdbs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>policy<span class="token punctuation">.</span>PodDisruptionBudget<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> potentialVictims <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod    removePod <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>rp <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> nodeInfo<span class="token punctuation">.</span><span class="token function">RemovePod</span><span class="token punctuation">(</span>rp<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        status <span class="token operator">:=</span> pr<span class="token punctuation">.</span><span class="token function">RunPreFilterExtensionRemovePod</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> rp<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    addPod <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ap <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>        nodeInfo<span class="token punctuation">.</span><span class="token function">AddPod</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span>        status <span class="token operator">:=</span> pr<span class="token punctuation">.</span><span class="token function">RunPreFilterExtensionAddPod</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> ap<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// As the first step, remove all the lower priority pods from the node and</span>    <span class="token comment" spellcheck="true">// check if the given pod can be scheduled.</span>     <span class="token comment" spellcheck="true">// å…ˆåˆ é™¤æ‰€æœ‰çš„ä½ä¼˜å…ˆçº§ pod æ£€æŸ¥æ˜¯å¦èƒ½æ»¡è¶³æŠ¢å  pod çš„è°ƒåº¦éœ€æ±‚</span>    podPriority <span class="token operator">:=</span> podutil<span class="token punctuation">.</span><span class="token function">GetPodPriority</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> nodeInfo<span class="token punctuation">.</span>Pods <span class="token punctuation">{</span>        <span class="token keyword">if</span> podutil<span class="token punctuation">.</span><span class="token function">GetPodPriority</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token operator">&lt;</span> podPriority <span class="token punctuation">{</span>            potentialVictims <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>potentialVictims<span class="token punctuation">,</span> p<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">removePod</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å¦‚æœåˆ é™¤æ‰€æœ‰ä½ä¼˜å…ˆçº§çš„ pod ä¸ç¬¦åˆè¦æ±‚åˆ™ç›´æ¥è¿‡æ»¤æ‰è¯¥ node</span>    <span class="token comment" spellcheck="true">// podPassesFiltersOnNode æ˜¯ç”¨æ¥æ‰§è¡Œé¢„é€‰å‡½æ•°çš„</span>    <span class="token keyword">if</span> fits<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">podPassesFiltersOnNode</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pr<span class="token punctuation">,</span> nominator<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>fits <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"Encountered error while selecting victims on node %v: %v"</span><span class="token punctuation">,</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> victims <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod    numViolatingVictim <span class="token operator">:=</span> <span class="token number">0</span>    sort<span class="token punctuation">.</span><span class="token function">Slice</span><span class="token punctuation">(</span>potentialVictims<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> util<span class="token punctuation">.</span><span class="token function">MoreImportantPod</span><span class="token punctuation">(</span>potentialVictims<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> potentialVictims<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// å°è¯•å°½é‡å¤šåœ°â€œåˆ é™¤â€è¿™äº› podsï¼Œå…ˆä» PDB violating victims ä¸­â€œåˆ é™¤â€ï¼Œå†ä» PDB non-violating victims ä¸­â€œåˆ é™¤â€</span>    violatingVictims<span class="token punctuation">,</span> nonViolatingVictims <span class="token operator">:=</span> <span class="token function">filterPodsWithPDBViolation</span><span class="token punctuation">(</span>potentialVictims<span class="token punctuation">,</span> pdbs<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// reprievePod æ˜¯â€œåˆ é™¤â€ pods çš„å‡½æ•°</span>    reprievePod <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">addPod</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>         <span class="token comment" spellcheck="true">// åŒæ ·ä¹Ÿä¼šè°ƒç”¨ podPassesFiltersOnNode å†æ¬¡æ‰§è¡Œ predicates ç®—æ³•</span>        fits<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">podPassesFiltersOnNode</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pr<span class="token punctuation">,</span> nominator<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">!</span>fits <span class="token punctuation">{</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">removePod</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// åŠ å…¥åˆ° victims ä¸­</span>            victims <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>victims<span class="token punctuation">,</span> p<span class="token punctuation">)</span>            klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Pod %v/%v is a potential preemption victim on node %v."</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> p<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> fits<span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// åˆ é™¤ violatingVictims ä¸­çš„ podï¼ŒåŒæ—¶ä¹Ÿè®°å½•åˆ é™¤äº†å¤šå°‘ä¸ª</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> violatingVictims <span class="token punctuation">{</span>        <span class="token keyword">if</span> fits<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">reprievePod</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"Failed to reprieve pod %q: %v"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token operator">!</span>fits <span class="token punctuation">{</span>            numViolatingVictim<span class="token operator">++</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Now we try to reprieve non-violating victims.</span>    <span class="token comment" spellcheck="true">// åˆ é™¤ nonViolatingVictims ä¸­çš„ pod</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> nonViolatingVictims <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">reprievePod</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"Failed to reprieve pod %q: %v"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> victims<span class="token punctuation">,</span> numViolatingVictim<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span></code></pre><p><code>pickOneNodeForPreemption()</code> ç”¨æ¥é€‰å‡ºæœ€ä½³çš„ node ä½œä¸ºæŠ¢å è€…çš„ nodeï¼Œè¯¥å‡½æ•°ä¸»è¦åŸºäº 6 ä¸ªåŸåˆ™ï¼š</p><ul><li>PDB violations å€¼æœ€å°çš„ node</li><li>æŒ‘é€‰å…·æœ‰é«˜ä¼˜å…ˆçº§è¾ƒå°‘çš„ node</li><li>å¯¹æ¯ä¸ª node ä¸Šæ‰€æœ‰ victims çš„ä¼˜å…ˆçº§è¿›é¡¹ç´¯åŠ ï¼Œé€‰å–æœ€å°çš„</li><li>å¦‚æœå¤šä¸ª node ä¼˜å…ˆçº§æ€»å’Œç›¸ç­‰ï¼Œé€‰æ‹©å…·æœ‰æœ€å° victims æ•°é‡çš„ node</li><li>å¦‚æœå¤šä¸ª node ä¼˜å…ˆçº§æ€»å’Œç›¸ç­‰ï¼Œé€‰æ‹©å…·æœ‰é«˜ä¼˜å…ˆçº§ä¸” pod è¿è¡Œæ—¶é—´æœ€çŸ­çš„</li><li>å¦‚æœä¾æ®ä»¥ä¸Šç­–ç•¥ä»ç„¶é€‰å‡ºäº†å¤šä¸ª node åˆ™ç›´æ¥è¿”å›ç¬¬ä¸€ä¸ª node</li></ul><p>ä»£ç è·¯å¾„ï¼š<code>pkg/scheduler/core/generic_scheduler.go:722</code></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">pickOneNodeForPreemption</span><span class="token punctuation">(</span>nodesToVictims <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>extenderv1<span class="token punctuation">.</span>Victims<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>nodesToVictims<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">""</span>    <span class="token punctuation">}</span>    minNumPDBViolatingPods <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>MaxInt32<span class="token punctuation">)</span>    <span class="token keyword">var</span> minNodes1 <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>    lenNodes1 <span class="token operator">:=</span> <span class="token number">0</span>    <span class="token keyword">for</span> node<span class="token punctuation">,</span> victims <span class="token operator">:=</span> <span class="token keyword">range</span> nodesToVictims <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è‹¥è¯¥ node æ²¡æœ‰ victims åˆ™è¿”å›</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>victims<span class="token punctuation">.</span>Pods<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// We found a node that doesn't need any preemption. Return it!</span>            <span class="token comment" spellcheck="true">// This should happen rarely when one or more pods are terminated between</span>            <span class="token comment" spellcheck="true">// the time that scheduler tries to schedule the pod and the time that</span>            <span class="token comment" spellcheck="true">// preemption logic tries to find nodes for preemption.</span>            <span class="token keyword">return</span> node        <span class="token punctuation">}</span>        numPDBViolatingPods <span class="token operator">:=</span> victims<span class="token punctuation">.</span>NumPDBViolations        <span class="token keyword">if</span> numPDBViolatingPods <span class="token operator">&lt;</span> minNumPDBViolatingPods <span class="token punctuation">{</span>            minNumPDBViolatingPods <span class="token operator">=</span> numPDBViolatingPods            minNodes1 <span class="token operator">=</span> <span class="token boolean">nil</span>            lenNodes1 <span class="token operator">=</span> <span class="token number">0</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> numPDBViolatingPods <span class="token operator">==</span> minNumPDBViolatingPods <span class="token punctuation">{</span>            minNodes1 <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>minNodes1<span class="token punctuation">,</span> node<span class="token punctuation">)</span>            lenNodes1<span class="token operator">++</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> lenNodes1 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> minNodes1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// There are more than one node with minimum number PDB violating pods. Find</span>    <span class="token comment" spellcheck="true">// the one with minimum highest priority victim.</span>    <span class="token comment" spellcheck="true">// é€‰å‡º PDB violating pods æ•°é‡æœ€å°‘çš„æˆ–è€…é«˜ä¼˜å…ˆçº§ victim æ•°é‡å°‘çš„</span>    minHighestPriority <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>MaxInt32<span class="token punctuation">)</span>    <span class="token keyword">var</span> minNodes2 <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> lenNodes1<span class="token punctuation">)</span>    lenNodes2 <span class="token operator">:=</span> <span class="token number">0</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lenNodes1<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        node <span class="token operator">:=</span> minNodes1<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        victims <span class="token operator">:=</span> nodesToVictims<span class="token punctuation">[</span>node<span class="token punctuation">]</span>        <span class="token comment" spellcheck="true">// highestPodPriority is the highest priority among the victims on this node.</span>        highestPodPriority <span class="token operator">:=</span> podutil<span class="token punctuation">.</span><span class="token function">GetPodPriority</span><span class="token punctuation">(</span>victims<span class="token punctuation">.</span>Pods<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> highestPodPriority <span class="token operator">&lt;</span> minHighestPriority <span class="token punctuation">{</span>            minHighestPriority <span class="token operator">=</span> highestPodPriority            lenNodes2 <span class="token operator">=</span> <span class="token number">0</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> highestPodPriority <span class="token operator">==</span> minHighestPriority <span class="token punctuation">{</span>            minNodes2<span class="token punctuation">[</span>lenNodes2<span class="token punctuation">]</span> <span class="token operator">=</span> node            lenNodes2<span class="token operator">++</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> lenNodes2 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> minNodes2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// There are a few nodes with minimum highest priority victim. Find the</span>    <span class="token comment" spellcheck="true">// smallest sum of priorities.</span>    <span class="token comment" spellcheck="true">// è‹¥å¤šä¸ª node é«˜ä¼˜å…ˆçº§çš„ pod åŒæ ·å°‘ï¼Œåˆ™é€‰å‡ºåŠ æƒå¾—åˆ†æœ€å°çš„</span>    minSumPriorities <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>MaxInt64<span class="token punctuation">)</span>    lenNodes1 <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lenNodes2<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> sumPriorities <span class="token builtin">int64</span>        node <span class="token operator">:=</span> minNodes2<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pod <span class="token operator">:=</span> <span class="token keyword">range</span> nodesToVictims<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">.</span>Pods <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// We add MaxInt32+1 to all priorities to make all of them >= 0. This is</span>            <span class="token comment" spellcheck="true">// needed so that a node with a few pods with negative priority is not</span>            <span class="token comment" spellcheck="true">// picked over a node with a smaller number of pods with the same negative</span>            <span class="token comment" spellcheck="true">// priority (and similar scenarios).</span>            sumPriorities <span class="token operator">+=</span> <span class="token function">int64</span><span class="token punctuation">(</span>podutil<span class="token punctuation">.</span><span class="token function">GetPodPriority</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">int64</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>MaxInt32<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> sumPriorities <span class="token operator">&lt;</span> minSumPriorities <span class="token punctuation">{</span>            minSumPriorities <span class="token operator">=</span> sumPriorities            lenNodes1 <span class="token operator">=</span> <span class="token number">0</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> sumPriorities <span class="token operator">==</span> minSumPriorities <span class="token punctuation">{</span>            minNodes1<span class="token punctuation">[</span>lenNodes1<span class="token punctuation">]</span> <span class="token operator">=</span> node            lenNodes1<span class="token operator">++</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> lenNodes1 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> minNodes1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// There are a few nodes with minimum highest priority victim and sum of priorities.</span>    <span class="token comment" spellcheck="true">// Find one with the minimum number of pods.</span>    <span class="token comment" spellcheck="true">// è‹¥å¤šä¸ª node é«˜ä¼˜å…ˆçº§çš„ pod æ•°é‡åŒç­‰ä¸”åŠ æƒåˆ†æ•°ç›¸ç­‰ï¼Œåˆ™é€‰å‡º pod æ•°é‡æœ€å°‘çš„</span>    minNumPods <span class="token operator">:=</span> math<span class="token punctuation">.</span>MaxInt32    lenNodes2 <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lenNodes1<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        node <span class="token operator">:=</span> minNodes1<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        numPods <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>nodesToVictims<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">.</span>Pods<span class="token punctuation">)</span>        <span class="token keyword">if</span> numPods <span class="token operator">&lt;</span> minNumPods <span class="token punctuation">{</span>            minNumPods <span class="token operator">=</span> numPods            lenNodes2 <span class="token operator">=</span> <span class="token number">0</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> numPods <span class="token operator">==</span> minNumPods <span class="token punctuation">{</span>            minNodes2<span class="token punctuation">[</span>lenNodes2<span class="token punctuation">]</span> <span class="token operator">=</span> node            lenNodes2<span class="token operator">++</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> lenNodes2 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> minNodes2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// There are a few nodes with same number of pods.</span>    <span class="token comment" spellcheck="true">// Find the node that satisfies latest(earliestStartTime(all highest-priority pods on node))</span>    <span class="token comment" spellcheck="true">// è‹¥å¤šä¸ª node çš„ pod æ•°é‡ç›¸ç­‰ï¼Œåˆ™é€‰å‡ºé«˜ä¼˜å…ˆçº§ pod å¯åŠ¨æ—¶é—´æœ€çŸ­çš„</span>    latestStartTime <span class="token operator">:=</span> util<span class="token punctuation">.</span><span class="token function">GetEarliestPodStartTime</span><span class="token punctuation">(</span>nodesToVictims<span class="token punctuation">[</span>minNodes2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> latestStartTime <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// If the earliest start time of all pods on the 1st node is nil, just return it,</span>        <span class="token comment" spellcheck="true">// which is not expected to happen.</span>        klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"earliestStartTime is nil for node %s. Should not reach here."</span><span class="token punctuation">,</span> minNodes2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> minNodes2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    nodeToReturn <span class="token operator">:=</span> minNodes2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lenNodes2<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        node <span class="token operator">:=</span> minNodes2<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token comment" spellcheck="true">// Get earliest start time of all pods on the current node.</span>        earliestStartTimeOnNode <span class="token operator">:=</span> util<span class="token punctuation">.</span><span class="token function">GetEarliestPodStartTime</span><span class="token punctuation">(</span>nodesToVictims<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> earliestStartTimeOnNode <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"earliestStartTime is nil for node %s. Should not reach here."</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> earliestStartTimeOnNode<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>latestStartTime<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">{</span>            latestStartTime <span class="token operator">=</span> earliestStartTimeOnNode            nodeToReturn <span class="token operator">=</span> node        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> nodeToReturn<span class="token punctuation">}</span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£ Kubernetes ä¹‹ API server</title>
      <link href="/2020/05/27/k8s03/"/>
      <url>/2020/05/27/k8s03/</url>
      
        <content type="html"><![CDATA[<h1 id="API-server"><a href="#API-server" class="headerlink" title="API server"></a>API server</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Kubernetes API server ä¸º api å¯¹è±¡éªŒè¯å¹¶é…ç½®æ•°æ®ï¼ŒåŒ…æ‹¬ podsã€ servicesã€ replicationcontrollers å’Œå…¶å®ƒ api å¯¹è±¡ã€‚API Server æä¾› REST æ“ä½œå’Œåˆ°é›†ç¾¤å…±äº«çŠ¶æ€çš„å‰ç«¯ï¼Œæ‰€æœ‰å…¶ä»–ç»„ä»¶é€šè¿‡å®ƒè¿›è¡Œäº¤äº’ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ•°æ®æ€»çº¿å’Œæ•°æ®ä¸­å¿ƒã€‚</p><p><img src="/images/2020/communication_paths.png" alt=""></p><p>Kubernetes ä¸­çš„å…¶å®ƒç»„ä»¶éƒ½ä¸ä¼šå’Œ etcd è¿›è¡Œäº¤äº’ï¼Œåªæœ‰ API Server å¯ä»¥å’Œ etcd è¿›è¡Œäº¤äº’,api-server å…·æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li>æ•´ä¸ªé›†ç¾¤ç®¡ç†çš„APIæ¥å£ï¼šæ‰€æœ‰å¯¹é›†ç¾¤è¿›è¡Œçš„æŸ¥è¯¢å’Œç®¡ç†éƒ½æ˜¯é€šè¿‡API è¿›è¡Œ</li><li>é›†ç¾¤å†…éƒ¨å„ä¸ªæ¨¡å—ä¹‹é—´é€šä¿¡çš„æ¢çº½ï¼šæ‰€æœ‰æ¨¡å—ä¹‹é—´å¹¶ä¸ä¼šäº’ç›¸è°ƒç”¨ï¼Œè€Œæ˜¯é€šè¿‡å’Œ API Serve ræ‰“äº¤é“å®Œæˆè¿™éƒ¨åˆ†çš„å·¥ä½œ</li><li>é›†ç¾¤çš„å®‰å…¨æ§åˆ¶:API Server æä¾›çš„éªŒè¯å’Œæˆæƒä¿è¯äº†æ•´ä¸ªé›†ç¾¤çš„å®‰å…¨</li></ul><h2 id="API-server-å·¥ä½œåŸç†"><a href="#API-server-å·¥ä½œåŸç†" class="headerlink" title="API server å·¥ä½œåŸç†"></a>API server å·¥ä½œåŸç†</h2><p><img src="/images/2020/API_server.jpg" alt=""></p><h3 id="å£°æ˜å¼-API-è®¾è®¡"><a href="#å£°æ˜å¼-API-è®¾è®¡" class="headerlink" title="å£°æ˜å¼ API è®¾è®¡"></a>å£°æ˜å¼ API è®¾è®¡</h3><p><strong>æè¿°èµ„æºç‰ˆæœ¬ä¿¡æ¯</strong></p><pre><code>/api/{version}/{resource}/{action}</code></pre><p>ä¸Šé¢æ˜¯ä¸€ä¸ªåŸºç¡€çš„ web url é€šå¸¸æˆ‘ä»¬éƒ½ä¼šä¸ºæ¯ä¸ªç‰ˆæœ¬æ³¨å†Œä¸€ä¸ªå¯¹åº”çš„ URL, å…¶ä¸­ä¼šåŒ…å«å¾ˆå…³é”®çš„ä¸¤ä¸ªä¿¡æ¯å³ versionä¸ resource ,é€šè¿‡è¿™ä¸¤ä¸ªä¿¡æ¯,é€šå¸¸æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“è¿™å¯èƒ½æ˜¯æŸä¸ªèµ„æºçš„é‚£ä¸ªç‰ˆæœ¬, å¦‚æœæˆ‘ä»¬æŠŠåé¢çš„ action ä¹ŸåŒ…è£¹è¿›æ¥,æˆ‘ä»¬é€šå¸¸å°±å¯ä»¥çŸ¥é“å¯¹åº”çš„èµ„æºçš„é‚£ä¸ªå…·ä½“æ“ä½œ</p><p><strong>Groupç»„ä¿¡æ¯</strong></p><p><img src="/images/2020/gvk.png" alt=""></p><p>æˆ‘ä»¬é€šè¿‡ url é‡Œé¢è·å–åˆ°èµ„æºçš„ GroupVersionKind ä¿¡æ¯ï¼Œå¦‚ä½•å°†å…¶æ˜ å°„ä¸ºä¸€ä¸ªå…·ä½“çš„ç±»å‹å‘¢ï¼Ÿç»“åˆåå°„å’Œmapæ¥åšå°±å¯ä»¥äº†ï¼Œæˆ‘ä»¬é€šè¿‡urlè·å–åˆ°å¯¹åº”æƒ³çš„GVKä¿¡æ¯ï¼Œç„¶ååœ¨é€šè¿‡æˆ‘ä»¬çš„æ˜ å°„è¡¨ï¼Œå°±çŸ¥é“å¯¹åº”çš„æ¨¡å‹æ˜¯å“ªä¸ªï¼Œæ¥ä¸‹æ¥å°±åªéœ€è¦è¿›è¡Œè½¬æ¢å°±è¡Œäº†</p><p><img src="/images/2020/parse_gvk.png" alt=""></p><h4 id="RESTMapper"><a href="#RESTMapper" class="headerlink" title="RESTMapper"></a>RESTMapper</h4><p>RESTMapperæ˜¯ä¸€ä¸ªinterfaceï¼Œå®šä¹‰åœ¨<a href="https://github.com/kubernetes/kubernetes/blob/9e991415386e4cf155a24b1da15becaa390438d8/staging/src/k8s.io/apimachinery/pkg/api/meta/interfaces.go#L113" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apimachinery/pkg/api/meta/interfaces.go </a>ä¸­:</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> RESTMapper <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token function">KindFor</span><span class="token punctuation">(</span>resource schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">)</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>    <span class="token function">KindsFor</span><span class="token punctuation">(</span>resource schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>    <span class="token function">ResourceFor</span><span class="token punctuation">(</span>input schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">)</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>    <span class="token function">ResourcesFor</span><span class="token punctuation">(</span>input schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>    <span class="token function">RESTMapping</span><span class="token punctuation">(</span>gk schema<span class="token punctuation">.</span>GroupKind<span class="token punctuation">,</span> versions <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>RESTMapping<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>    <span class="token function">RESTMappings</span><span class="token punctuation">(</span>gk schema<span class="token punctuation">.</span>GroupKind<span class="token punctuation">,</span> versions <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>RESTMapping<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>    <span class="token function">ResourceSingularizer</span><span class="token punctuation">(</span>resource <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>singular <span class="token builtin">string</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>RESTMapper æ˜ å°„æ˜¯æŒ‡ GVR(GroupVersionResource) å’Œ GVK(GroupVersionKind) çš„å…³ç³»ï¼Œå¯ä»¥é€šè¿‡ GVR æ‰¾åˆ°åˆé€‚çš„ GVKï¼Œå¹¶å¯ä»¥é€šè¿‡GVK ç”Ÿæˆä¸€ä¸ª RESTMappingã€‚</p><h4 id="RESTMapping"><a href="#RESTMapping" class="headerlink" title="RESTMapping"></a>RESTMapping</h4><p>ä¸ RESTMapper å®šä¹‰åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> RESTMapping <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Resource schema<span class="token punctuation">.</span>GroupVersionResource    GroupVersionKind schema<span class="token punctuation">.</span>GroupVersionKind    Scope RESTScope<span class="token punctuation">}</span></code></pre><p>RESTMapping åŒ…å« Resource åç§°ï¼ŒåŠå…¶å¯¹åº”çš„ GVKï¼Œè¿˜æœ‰ä¸€ä¸ªScope(æ ‡æ˜èµ„æºæ˜¯å¦ä¸ºrootæˆ–è€…namespaced)ï¼Œ</p><h4 id="RESTScope"><a href="#RESTScope" class="headerlink" title="RESTScope"></a>RESTScope</h4><p>ä¸ RESTMapper å®šä¹‰åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> RESTScope <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> RESTScopeName<span class="token punctuation">}</span></code></pre><p>è¡¨æ˜ä½œç”¨åŸŸå¯ä»¥æ˜¯åŸºäº namespace çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯åŸºäºé›†ç¾¤çš„ã€‚ å¦‚æœæ˜¯åŸºäº namespace çš„ã€‚åˆ™APIæ ¼å¼ä¸ºï¼š<code>/apis/{group}/v1/namespaces/{namespace}/{spec.names.plural}/â€¦</code> å¦‚æœæ˜¯åŸºäº cluster çš„ã€‚åˆ™APIæ ¼å¼ä¸ºï¼š<code>/apis/{group}/v1/{spec.names.plural}/â€¦</code> ä¸Šæ–‡åˆ›å»ºçš„ CRD çš„ API åˆ™ä¸ºï¼š<code>/apis/xxx.com/v1/namespaces/{namespace}/tasks</code></p><h4 id="DefaultRESTMapper"><a href="#DefaultRESTMapper" class="headerlink" title="DefaultRESTMapper"></a>DefaultRESTMapper</h4><p>ä»£ç è·¯å¾„ï¼š<a href="https://github.com/kubernetes/kubernetes/blob/9e991415386e4cf155a24b1da15becaa390438d8/staging/src/k8s.io/apimachinery/pkg/api/meta/restmapper.go#L57" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apimachinery/pkg/api/meta/restmapper.go </a></p><p>DefaultRESTMapper å®ç°äº† RESTMapper interfaceã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// DefaultRESTMapper ä¸­çš„ resource æ˜¯æŒ‡ GVRï¼Œkind æ˜¯æŒ‡ GVK</span><span class="token comment" spellcheck="true">// singularå’Œ Plural éƒ½æ˜¯ GVR</span><span class="token keyword">type</span> DefaultRESTMapper <span class="token keyword">struct</span> <span class="token punctuation">{</span>    defaultGroupVersions <span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersion    resourceToKind       <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionKind    kindToPluralResource <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionResource    kindToScope          <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">]</span>RESTScope    singularToPlural     <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionResource    pluralToSingular     <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">}</span></code></pre><p>ç°åœ¨æ¥è¯¦ç»†åˆ†æDefaultRESTMapperçš„å­—æ®µçš„æ¶µä¹‰ã€‚</p><ul><li>defaultGroupVersions: é»˜è®¤çš„GroupVersionï¼Œå¦‚v1ï¼Œapps/v1beta1ç­‰ï¼Œä¸€èˆ¬ä¸€ä¸ª DefaultRESTMapperåªè®¾ä¸€ä¸ªé»˜è®¤çš„GroupVersionï¼›</li><li>resourceToKindï¼šGVR(å•æ•°,å¤æ•°)åˆ°GVKçš„mapï¼›</li><li>kindToPluralResourceï¼šGVKåˆ°GVR(å¤æ•°)çš„mapï¼›</li><li>kindToScopeï¼šGVKåˆ°Scopeçš„mapï¼›</li><li>singularToPluralï¼šGVR(å•æ•°)åˆ°GVR(å¤æ•°)çš„mapï¼›</li><li>pluralToSingular:  GVR(å•æ•°)åˆ°GVR(å¤æ•°)çš„mapï¼›</li></ul><p>RESTMapper å¯ä»¥ä» GVR è·å– GVKï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª RESTMapping æ¥å¤„ç†è¯¥ GVRã€‚RESTMapping ä¸­æœ‰Resourceåç§°ï¼ŒGVKï¼ŒScopeç­‰å’ŒGVRæœ‰å…³çš„ä¿¡æ¯</p><h4 id="Scheme"><a href="#Scheme" class="headerlink" title="Scheme"></a>Scheme</h4><p><img src="/images/2020/scheme.png" alt=""></p><p>å¦‚æœè¯´ RESTMapper ç®¡ç†çš„æ˜¯ GVR å’Œ GVK çš„å…³ç³»ï¼Œé‚£ä¹ˆ Scheme ç®¡ç†çš„å°±æ˜¯ GVK å’Œ Type çš„å…³ç³»ã€‚ç³»ç»Ÿä¸­æ‰€æœ‰çš„Typeéƒ½è¦æ³¨å†Œåˆ°Schemeä¸­ï¼Œå½“ç„¶ç›®å‰ç³»ç»Ÿåªæœ‰ä¸€ä¸ªSchemeï¼Œå³api.Schemeï¼Œå®šä¹‰åœ¨<a href="https://github.com/kubernetes/kubernetes/blob/565566f4b2dae269bec108624fe28d3462d6ae2a/staging/src/k8s.io/client-go/kubernetes/scheme/register.go#L69" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/client-go/kubernetes/scheme/register.go </a>ä¸­ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token keyword">var</span> Scheme <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>Scheme å®šä¹‰åœ¨<a href="https://github.com/kubernetes/kubernetes/blob/565566f4b2dae269bec108624fe28d3462d6ae2a/staging/src/k8s.io/apimachinery/pkg/runtime/scheme.go#L47" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apimachinery/pkg/runtime/scheme.go </a></p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> Scheme <span class="token keyword">struct</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// versionMap allows one to figure out the go type of an object with</span>    <span class="token comment" spellcheck="true">// the given version and name.</span>    gvkToType <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type    <span class="token comment" spellcheck="true">// typeToGroupVersion allows one to find metadata for a given go object.</span>    <span class="token comment" spellcheck="true">// The reflect.Type we index by should *not* be a pointer.</span>    typeToGVK <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionKind    <span class="token comment" spellcheck="true">// unversionedTypes are transformed without conversion in ConvertToVersion.</span>    unversionedTypes <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionKind    <span class="token comment" spellcheck="true">// unversionedKinds are the names of kinds that can be created in the context of any group</span>    <span class="token comment" spellcheck="true">// or version</span>    <span class="token comment" spellcheck="true">// TODO: resolve the status of unversioned types.</span>    unversionedKinds <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type    <span class="token comment" spellcheck="true">// Map from version and resource to the corresponding func to convert</span>    <span class="token comment" spellcheck="true">// resource field labels in that version to internal version.</span>    fieldLabelConversionFuncs <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">]</span>FieldLabelConversionFunc    <span class="token comment" spellcheck="true">// defaulterFuncs is an array of interfaces to be called with an object to provide defaulting</span>    <span class="token comment" spellcheck="true">// the provided object must be a pointer.</span>    defaulterFuncs <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// converter stores all registered conversion functions. It also has</span>    <span class="token comment" spellcheck="true">// default converting behavior.</span>    converter <span class="token operator">*</span>conversion<span class="token punctuation">.</span>Converter    <span class="token comment" spellcheck="true">// versionPriority is a map of groups to ordered lists of versions for those groups indicating the</span>    <span class="token comment" spellcheck="true">// default priorities of these versions as registered in the scheme</span>    versionPriority <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>    <span class="token comment" spellcheck="true">// observedVersions keeps track of the order we've seen versions during type registration</span>    observedVersions <span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersion    <span class="token comment" spellcheck="true">// schemeName is the name of this scheme.  If you don't specify a name, the stack of the NewScheme caller will be used.</span>    <span class="token comment" spellcheck="true">// This is useful for error reporting to indicate the origin of the scheme.</span>    schemeName <span class="token builtin">string</span><span class="token punctuation">}</span></code></pre><p>å¯ä»¥çœ‹å‡ºï¼ŒSchemeé™¤äº†ç®¡ç† GVK å’Œ Type çš„å…³ç³»ï¼Œè¿˜ç®¡ç†æœ‰é»˜è®¤è®¾ç½®å‡½æ•°ï¼Œå¹¶èšåˆäº†converteråŠclonerã€‚æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸‹æ¯ä¸ªå­—æ®µçš„å«ä¹‰ï¼š</p><ul><li>gvkToType: å­˜å‚¨ gvk å’Œ Type çš„å…³ç³»ï¼Œä¸€ä¸ª gvk åªèƒ½å¯¹åº”ä¸€ä¸ª Typeï¼›</li><li>typeToGVKï¼šå­˜å‚¨ Type å’Œ gvk çš„å…³ç³»ï¼Œä¸€ä¸ª type å¯èƒ½å¯¹åº”å¤šä¸ª GVKï¼›</li><li>unversionedTypesï¼šè®°å½• unversioned çš„ Type å’Œ GVK çš„å…³ç³»ï¼Œunversioned æ— éœ€ç‰ˆæœ¬è½¬æ¢ï¼›</li><li>unversionedKindsï¼šè®°å½• unversioned çš„ GVK å’Œ Type çš„å…³ç³»ï¼›</li><li>fieldLabelConversionFuncsï¼šç®¡ç† field selector çš„è½¬æ¢ï¼Œå¦‚æ—§ç‰ˆæœ¬v1çš„ spec.host éœ€è¦è½¬æ¢æˆspec.nodeName (è¯¦è§åœ¨<a href="https://github.com/kubernetes/kubernetes/blob/f221dbb91bde0d447226a7f15b7c4301ddd161c6/pkg/apis/core/v1/conversion.go#L33" target="_blank" rel="noopener">kubernetes/pkg/apis/core/v1/conversion.go</a>ä¸­çš„addConversionFuncs()å‡½æ•°)ï¼›</li></ul><pre class=" language-go"><code class="language-go">    <span class="token keyword">func</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span> label <span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token string">"metadata.name"</span><span class="token punctuation">,</span>                <span class="token string">"metadata.namespace"</span><span class="token punctuation">,</span>                <span class="token string">"spec.nodeName"</span><span class="token punctuation">,</span>                <span class="token string">"spec.restartPolicy"</span><span class="token punctuation">,</span>                <span class="token string">"spec.schedulerName"</span><span class="token punctuation">,</span>                <span class="token string">"spec.serviceAccountName"</span><span class="token punctuation">,</span>                <span class="token string">"status.phase"</span><span class="token punctuation">,</span>                <span class="token string">"status.podIP"</span><span class="token punctuation">,</span>                <span class="token string">"status.podIPs"</span><span class="token punctuation">,</span>                <span class="token string">"status.nominatedNodeName"</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> label<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">nil</span>            <span class="token keyword">case</span> <span class="token string">"spec.host"</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token string">"spec.nodeName"</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">nil</span>            <span class="token keyword">default</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"field label not supported: %s"</span><span class="token punctuation">,</span> label<span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre><ul><li><p>defaulterFuncsï¼šå­˜å‚¨ TypeåŠå…¶å¯¹åº”çš„é»˜è®¤å€¼è®¾ç½®å‡½æ•°ï¼›</p></li><li><p>converterï¼šç”¨æ¥è½¬æ¢ä¸åŒç‰ˆæœ¬çš„ç»“æ„ä½“å€¼ï¼›</p></li></ul><p>Kuberneteså†…éƒ¨ç»„ä»¶çš„æµé€šçš„ç»“æ„ä½“å€¼ä½¿ç”¨çš„æ˜¯å†…éƒ¨ç‰ˆæœ¬ï¼Œæ‰€æœ‰çš„å¤–éƒ¨ç‰ˆæœ¬éƒ½è¦å‘å†…éƒ¨ç‰ˆæœ¬è¿›è¡Œè½¬æ¢ï¼›å†…éƒ¨ç‰ˆæœ¬å¿…é¡»è½¬æ¢æˆå¤–éƒ¨ç‰ˆæœ¬æ‰èƒ½è¿›è¡Œè¾“å‡ºã€‚å¤–éƒ¨ç‰ˆæœ¬ä¹‹é—´ä¸èƒ½ç›´æ¥è½¬æ¢ã€‚ä» Scheme çš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼ŒScheme ä¹Ÿæ˜¯ converterã€‚</p><h4 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h4><p>Converterå¯ä»¥å®Œæˆä¸åŒç»“æ„ä½“ä¹‹é—´çš„è½¬æ¢ã€‚åœ¨Kubernetesä¸­ï¼ŒConverterç”¨æ¥æŠŠä¸€ä¸ªç‰ˆæœ¬çš„objectè½¬æ¢æˆå…¶ä»–ç‰ˆæœ¬çš„objectï¼Œè½¬æ¢å‡½æ•°éœ€è¦é€šè¿‡æ³¨å†Œçš„æ–¹å¼æ·»åŠ åˆ°Converterä¸­ã€‚</p><p><img src="/images/2020/covert.png" alt=""></p><p>å…ˆæ¥çœ‹ä¸‹Converterçš„å®šä¹‰ï¼ŒConverterå®šä¹‰åœ¨<a href="https://github.com/kubernetes/kubernetes/blob/775feed217bf48035cb66bb7214a6c66385c73f7/staging/src/k8s.io/apimachinery/pkg/conversion/converter.go#L50" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apimachinery/pkg/conversion/converter.go</a>ä¸­ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> Converter <span class="token keyword">struct</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Map from the conversion pair to a function which can</span>    <span class="token comment" spellcheck="true">// do the conversion.</span>    conversionFuncs          ConversionFuncs    generatedConversionFuncs ConversionFuncs    <span class="token comment" spellcheck="true">// Set of conversions that should be treated as a no-op</span>    ignoredConversions        <span class="token keyword">map</span><span class="token punctuation">[</span>typePair<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    ignoredUntypedConversions <span class="token keyword">map</span><span class="token punctuation">[</span>typePair<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// This is a map from a source field type and name, to a list of destination</span>    <span class="token comment" spellcheck="true">// field type and name.</span>    structFieldDests <span class="token keyword">map</span><span class="token punctuation">[</span>typeNamePair<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>typeNamePair    <span class="token comment" spellcheck="true">// Allows for the opposite lookup of structFieldDests. So that SourceFromDest</span>    <span class="token comment" spellcheck="true">// copy flag also works. So this is a map of destination field name, to potential</span>    <span class="token comment" spellcheck="true">// source field name and type to look for.</span>    structFieldSources <span class="token keyword">map</span><span class="token punctuation">[</span>typeNamePair<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>typeNamePair    <span class="token comment" spellcheck="true">// Map from an input type to a function which can apply a key name mapping</span>    inputFieldMappingFuncs <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span>FieldMappingFunc    <span class="token comment" spellcheck="true">// Map from an input type to a set of default conversion flags.</span>    inputDefaultFlags <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span>FieldMatchingFlags    <span class="token comment" spellcheck="true">// If non-nil, will be called to print helpful debugging info. Quite verbose.</span>    Debug DebugLogger    <span class="token comment" spellcheck="true">// nameFunc is called to retrieve the name of a type; this name is used for the</span>    <span class="token comment" spellcheck="true">// purpose of deciding whether two types match or not (i.e., will we attempt to</span>    <span class="token comment" spellcheck="true">// do a conversion). The default returns the go type name.</span>    nameFunc <span class="token keyword">func</span><span class="token punctuation">(</span>t reflect<span class="token punctuation">.</span>Type<span class="token punctuation">)</span> <span class="token builtin">string</span><span class="token punctuation">}</span></code></pre><p>Converterç»“æ„ä½“çš„å­—æ®µæ¶µä¹‰å¦‚ä¸‹ï¼š</p><ul><li>conversionFuncs: æ™®é€šè½¬æ¢å‡½æ•°ï¼Œé€šè¿‡ RegisterConversionFunc() æ–¹æ³•è¿›è¡Œæ³¨å†Œï¼›</li><li>generatedConversionFuncs: è‡ªåŠ¨ç”Ÿæˆçš„è½¬æ¢å‡½æ•°ï¼Œé€šè¿‡ RegisterGeneratedConversionFunc() æ–¹æ³•è¿›è¡Œæ³¨å†Œï¼›</li><li>genericConversionsï¼šé€šç”¨è½¬æ¢å‡½æ•°ï¼Œä¼˜åŒ–çº§æœ€é«˜çš„è½¬æ¢å‡½æ•°ï¼Œå¯ä»¥ç†è§£ä¸ºè½¬æ¢çš„å¿«é€Ÿé€šé“ï¼Œé€šè¿‡AddGenericConversionFunc()æ–¹æ³•è¿›è¡Œæ³¨å†Œï¼›</li><li>ignoredConversionsï¼šéœ€è¦å¿½ç•¥çš„è½¬æ¢ï¼Œå¦‚æœä¸¤ä¸ªç»“æ„ä½“ä¹‹é—´ä¸å…è®¸è½¬æ¢ï¼Œåˆ™é€šè¿‡RegisterIgnoredConversion()æ–¹æ³•è¿›è¡Œæ³¨å†Œï¼›</li><li>structFieldDestsï¼šæºç»“æ„ä½“ä¸­å­—æ®µåˆ°ç›®æ ‡ç»“æ„ä½“ä¸­çš„å­—æ®µçš„æ˜ å°„å…³ç³»ï¼Œé€šè¿‡SetStructFieldCopy()æ–¹æ³•è¿›è¡Œæ³¨å†Œï¼›</li><li>structFieldSourcesï¼šä¸ structFieldDests ç›¸åï¼Œæ˜¯ç›®çš„ç»“æ„ä½“ä¸­å­—æ®µåˆ°æºç»“æ„ä½“ä¸­çš„å­—æ®µçš„æ˜ å°„å…³ç³»ï¼Œé€šè¿‡SetStructFieldCopy() æ–¹æ³•è¿›è¡Œæ³¨å†Œï¼›</li><li>defaultingFuncsï¼šè®¾ç½®ç»“æ„ä½“å€¼çš„é»˜è®¤å€¼ï¼Œé€šè¿‡RegisterDefaultingFunc()æ–¹æ³•è¿›è¡Œæ³¨å†Œï¼›</li><li>inputFieldMappingFuncsï¼š</li><li>inputDefaultFlagsï¼š</li><li>nameFuncï¼šè·å–ç»“æ„ä½“åç§°çš„å‡½æ•°ã€‚</li></ul><p>Converterçš„ç”Ÿæˆæ–¹æ³•å¦‚ä¸‹ï¼Œåªè¦ä¼ å…¥NameFunc å³å¯ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewConverter</span><span class="token punctuation">(</span>nameFn NameFunc<span class="token punctuation">)</span> <span class="token operator">*</span>Converter <span class="token punctuation">{</span>    c <span class="token operator">:=</span> <span class="token operator">&amp;</span>Converter<span class="token punctuation">{</span>        conversionFuncs<span class="token punctuation">:</span>           <span class="token function">NewConversionFuncs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        generatedConversionFuncs<span class="token punctuation">:</span>  <span class="token function">NewConversionFuncs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        ignoredConversions<span class="token punctuation">:</span>        <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>typePair<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        ignoredUntypedConversions<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>typePair<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        nameFunc<span class="token punctuation">:</span>                  nameFn<span class="token punctuation">,</span>        structFieldDests<span class="token punctuation">:</span>          <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>typeNamePair<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>typeNamePair<span class="token punctuation">)</span><span class="token punctuation">,</span>        structFieldSources<span class="token punctuation">:</span>        <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>typeNamePair<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>typeNamePair<span class="token punctuation">)</span><span class="token punctuation">,</span>        inputFieldMappingFuncs<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span>FieldMappingFunc<span class="token punctuation">)</span><span class="token punctuation">,</span>        inputDefaultFlags<span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span>FieldMatchingFlags<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    c<span class="token punctuation">.</span><span class="token function">RegisterUntypedConversionFunc</span><span class="token punctuation">(</span>        <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> s Scope<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">Convert_Slice_byte_To_Slice_byte</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    <span class="token keyword">return</span> c<span class="token punctuation">}</span></code></pre><p>å…³äºNameFuncï¼Œåªè¦å®ç°è¿”å›ä¸€ä¸ªç»“æ„ä½“çš„â€œåå­—â€å°±è¡Œï¼Œå¦‚ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token keyword">var</span> DefaultNameFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t reflect<span class="token punctuation">.</span>Type<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span></code></pre><h5 id="ConversionFuncs"><a href="#ConversionFuncs" class="headerlink" title="ConversionFuncs"></a>ConversionFuncs</h5><p>åœ¨Converterçš„å­—æ®µä¸­ï¼Œä¸ç®¡æ˜¯ conversionFuncsï¼Œè¿˜æ˜¯ generatedConversionFuncsï¼Œéƒ½æ˜¯ç»“æ„ä½“ConversionFuncsã€‚ç»“æ„ä½“ ConversionFuncs ç”¨æ¥ç®¡ç†è½¬æ¢å‡½æ•°</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> typePair <span class="token keyword">struct</span> <span class="token punctuation">{</span>    source reflect<span class="token punctuation">.</span>Type    dest   reflect<span class="token punctuation">.</span>Type<span class="token punctuation">}</span><span class="token keyword">type</span> ConversionFuncs <span class="token keyword">struct</span> <span class="token punctuation">{</span>    fns <span class="token keyword">map</span><span class="token punctuation">[</span>typePair<span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Value<span class="token punctuation">}</span></code></pre><p>åœ¨ConversionFuncsç»“æ„ä½“ä¸­ï¼Œåªæœ‰ä¸€ä¸ªå­—æ®µ<code>fns map[typePair]reflect.Value</code>ï¼Œå³{source, dest}åˆ°è½¬æ¢å‡½æ•°çš„æ˜ å°„è¡¨ã€‚</p><h5 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h5><p>Scopeæ˜¯ä¸€ä¸ªinterfaceï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥åˆ†æå…¶å®ç°è€…scopeã€‚</p><p>scopeåŒ…å«äº†é€’å½’è½¬æ¢ä¸­éœ€è¦çš„ä¸€äº›å†…å®¹ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> Scope <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Call Convert to convert sub-objects. Note that if you call it with your own exact</span>    <span class="token comment" spellcheck="true">// parameters, you'll run out of stack space before anything useful happens.</span>    <span class="token function">Convert</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dest <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> flags FieldMatchingFlags<span class="token punctuation">)</span> <span class="token builtin">error</span>    <span class="token comment" spellcheck="true">// SrcTags and DestTags contain the struct tags that src and dest had, respectively.</span>    <span class="token comment" spellcheck="true">// If the enclosing object was not a struct, then these will contain no tags, of course.</span>    <span class="token function">SrcTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> reflect<span class="token punctuation">.</span>StructTag    <span class="token function">DestTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> reflect<span class="token punctuation">.</span>StructTag    <span class="token comment" spellcheck="true">// Flags returns the flags with which the conversion was started.</span>    <span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> FieldMatchingFlags    <span class="token comment" spellcheck="true">// Meta returns any information originally passed to Convert.</span>    <span class="token function">Meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Meta<span class="token punctuation">}</span></code></pre><p>æ¥çœ‹scopeçš„å­—æ®µï¼š</p><ul><li>converterï¼šscopeåŒ…å«ä¸€ä¸ªconverterï¼Œä»¥æ–¹ä¾¿é€’å½’è½¬æ¢ï¼›</li><li>metaï¼šå…ƒæ•°æ®</li><li>flagsï¼šè½¬æ¢æ—¶å­—æ®µçš„ç­–ç•¥ï¼Œå®šä¹‰å¦‚ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨IsSet()æ–¹æ³•åˆ¤æ–­å¯¹åº”çš„flagæ˜¯å¦è¢«è®¾ç½®ã€‚<br>å…¶ä¸­ï¼š<br>DestFromSourceè¡¨ç¤ºå¾ªç¯ç›®æ ‡ç»“æ„ä½“å­—æ®µï¼Œå¯»æ‰¾åˆé€‚çš„æºç»“æ„ä½“å­—æ®µï¼›<br>SourceToDestè¡¨ç¤ºå¾ªç¯æºç»“æ„ä½“å­—æ®µï¼Œå¯»æ‰¾åˆé€‚çš„ç›®æ ‡ç»“æ„ä½“å­—æ®µï¼›<br>IgnoreMissingFieldsè¡¨ç¤ºå¦‚æœæœªæ‰¾åˆ°åˆé€‚çš„ç›®æ ‡ä¸æŠ¥é”™ï¼›<br>AllowDifferentFieldTypeNamesè¡¨ç¤ºå…è®¸æºç»“æ„ä½“å’Œç›®æ ‡ç»“æ„ä½“ä¸åŒçš„ç±»å‹ç›¸åŒ¹é…ã€‚</li></ul><ul><li>SrcTag, DestTagï¼šå­—æ®µä¿¡æ¯</li></ul><p>convert() çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>è·å–æºå’Œç›®æ ‡çš„ç±»å‹ï¼›</li><li>è®¾ç½®æºçš„é»˜è®¤å€¼ï¼›</li><li>åˆ¤æ–­æ˜¯å¦åœ¨ignoredConversionsä¸­ï¼›</li><li>å°è¯•ä»conversionFuncsä¸­è·å–è½¬æ¢å‡½æ•°è¿›è¡Œè½¬æ¢ï¼›</li><li>å°è¯•ä»generatedConversionFuncsä¸­è·å–è½¬æ¢å‡½æ•°è¿›è¡Œè½¬æ¢ï¼›</li></ol><p>Converterå…ˆä½¿ç”¨genericConversionFuncè¿›è¡Œè½¬æ¢ï¼Œå¦‚æœä¸æˆåŠŸï¼Œå†ä½¿ç”¨conversionFuncè¿›è¡Œè½¬æ¢ï¼Œå¦‚æœä¸æˆåŠŸï¼Œå†æŒ‰ generatedConversionFunc è¿›è¡Œè½¬æ¢ï¼Œå¦‚æœä¸æˆåŠŸï¼Œæœ€åäº¤ç”±DefaultConvert()è½¬æ¢ã€‚</p><p>DefaultConvert()ä¸­å¦‚æœè½¬æ¢ç±»å‹æ˜¯ç®€å•ç±»å‹ï¼Œåˆ™ç›´æ¥è½¬æ¢ï¼›å¦‚æœæ˜¯ç»“æ„ä½“ï¼Œåˆ™å…ˆçœ‹æ˜¯å¦æœ‰å­—æ®µå…³ç³»å®šä¹‰ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æŒ‰mapå®šä¹‰çš„æ¥ï¼Œå¦åˆ™æŒ‰åŒåè½¬æ¢åŸåˆ™è¿›è¡Œè½¬æ¢ï¼›å…¶ä»–çš„ç±»å‹ä¹Ÿæœ‰ç›¸åº”çš„æ–¹æ³•è¿›è¡Œè½¬æ¢ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><img src="/images/2020/api.png" alt=""></p><h2 id="API-server-å·¥ä½œæµç¨‹"><a href="#API-server-å·¥ä½œæµç¨‹" class="headerlink" title="API server å·¥ä½œæµç¨‹"></a>API server å·¥ä½œæµç¨‹</h2><p><img src="/images/2020/api-server-arch.png" alt=""></p><h3 id="API-server-æœåŠ¡"><a href="#API-server-æœåŠ¡" class="headerlink" title="API server æœåŠ¡"></a>API server æœåŠ¡</h3><p><img src="/images/2020/api-server-serve.png" alt=""></p><p>æ•´ä¸ªç¨‹åºçš„åŸºæœ¬è¿‡ç¨‹ä¸ºï¼š</p><ul><li>å‘½ä»¤è¡Œå‚æ•°è§£æï¼Œå‚æ•°å­˜å‚¨åœ¨ServerRunOptions</li><li>åŸºäºServerRunOptionsæ„å»ºgenericapiserver.Config</li><li>æ„å»ºmaster.Config</li><li>æ„å»ºapiextensionserver.Configï¼Œå¹¶åˆ›å»ºAPI Extension Server</li><li>æ„å»ºMasterï¼ˆAPI Serverï¼‰ï¼ŒæŠŠAPI Extension Serverä½œä¸ºä»£ç†æœåŠ¡ï¼Œè¿™æ ·å®ƒä¼šèåˆAPI Extension Serverçš„æœåŠ¡</li><li>æ„å»ºAggregatorï¼ŒæŠŠMasterä½œä¸ºä»£ç†æœåŠ¡</li><li>å¯åŠ¨httpéå®‰å…¨æœåŠ¡</li><li>æ‰§è¡ŒAggregatorçš„Runï¼Œå¯åŠ¨Httpså®‰å…¨æœåŠ¡</li></ul><h4 id="APIExtensionsServer"><a href="#APIExtensionsServer" class="headerlink" title="APIExtensionsServer"></a>APIExtensionsServer</h4><p><code>APIExtensionsServer</code>æœ€å…ˆåˆå§‹åŒ–ï¼Œåœ¨è°ƒç”¨é“¾çš„æœ«å°¾, å¤„ç†CRã€CRDç›¸å…³èµ„æº.</p><p>å…¶ä¸­åŒ…å«çš„ controller ä»¥åŠåŠŸèƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ol><li>openapiControllerï¼šå°† crd èµ„æºçš„å˜åŒ–åŒæ­¥è‡³æä¾›çš„ OpenAPI æ–‡æ¡£ï¼Œå¯é€šè¿‡è®¿é—® /openapi/v2 è¿›è¡ŒæŸ¥çœ‹ï¼›</li><li>crdControllerï¼šè´Ÿè´£å°† crd ä¿¡æ¯æ³¨å†Œåˆ° apiVersions å’Œ apiResources ä¸­ï¼Œä¸¤è€…çš„ä¿¡æ¯å¯é€šè¿‡ <code>kubectl api-versions</code> å’Œ  <code>kubectl api-resources</code> æŸ¥çœ‹ï¼›</li><li>namingControllerï¼šæ£€æŸ¥ crd obj ä¸­æ˜¯å¦æœ‰å‘½åå†²çªï¼Œå¯åœ¨ crd .status.conditions ä¸­æŸ¥çœ‹ï¼›</li><li>establishingControllerï¼šæ£€æŸ¥ crd æ˜¯å¦å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œå¯åœ¨ crd .status.conditions ä¸­æŸ¥çœ‹ï¼›</li><li>nonStructuralSchemaControllerï¼šæ£€æŸ¥ crd obj ç»“æ„æ˜¯å¦æ­£å¸¸ï¼Œå¯åœ¨ crd .status.conditions ä¸­æŸ¥çœ‹ï¼›</li><li>apiApprovalControllerï¼šæ£€æŸ¥ crd æ˜¯å¦éµå¾ª kubernetes API å£°æ˜ç­–ç•¥ï¼Œå¯åœ¨ crd .status.conditions ä¸­æŸ¥çœ‹ï¼›</li><li>finalizingControllerï¼šç±»ä¼¼äº finalizes çš„åŠŸèƒ½ï¼Œä¸ CRs çš„åˆ é™¤æœ‰å…³ï¼›</li></ol><h4 id="KubeAPIServer"><a href="#KubeAPIServer" class="headerlink" title="KubeAPIServer"></a>KubeAPIServer</h4><p>KubeAPIServer ä¸»è¦æ˜¯æä¾›å¯¹ API Resource çš„æ“ä½œè¯·æ±‚ï¼Œä¸º kubernetes ä¸­ä¼—å¤š API æ³¨å†Œè·¯ç”±ä¿¡æ¯ï¼Œæš´éœ² RESTful API å¹¶ä¸”å¯¹å¤–æä¾› kubernetes serviceï¼Œä½¿é›†ç¾¤ä¸­ä»¥åŠé›†ç¾¤å¤–çš„æœåŠ¡éƒ½å¯ä»¥é€šè¿‡ RESTful API æ“ä½œ kubernetes ä¸­çš„èµ„æºã€‚</p><p>ä¸<code>APIExtensionsServer</code>ï¼Œ<code>KubeAPIServer</code>åˆå§‹åŒ–æµç¨‹å¦‚ä¸‹</p><ol><li><code>CreateKubeAPIServer</code>è°ƒç”¨<code>kubeAPIServerConfig.Complete().New</code>æ¥åˆå§‹åŒ–</li><li><code>New</code>å‡½æ•°åˆ›å»ºé»˜è®¤çš„<code>apigroup</code>(pod,deploymentç­‰å†…éƒ¨èµ„æº), è°ƒç”¨<code>InstallAPIs</code>æ³¨å†Œ</li><li>å¯åŠ¨ç›¸å…³controller, åŠ å…¥åˆ°<code>poststarthook</code></li></ol><h4 id="AggregatorServer"><a href="#AggregatorServer" class="headerlink" title="AggregatorServer"></a>AggregatorServer</h4><p><code>Aggregator</code>é€šè¿‡<code>APIServices</code>å¯¹è±¡å…³è”åˆ°æŸä¸ª<code>Service</code>æ¥è¿›è¡Œè¯·æ±‚çš„è½¬å‘ï¼Œå…¶å…³è”çš„<code>Service</code>ç±»å‹è¿›ä¸€æ­¥å†³å®šäº†è¯·æ±‚è½¬å‘å½¢å¼ã€‚<code>Aggregator</code>åŒ…æ‹¬ä¸€ä¸ª<code>GenericAPIServer</code>å’Œç»´æŠ¤è‡ªèº«çŠ¶æ€çš„<code>Controller</code>ã€‚å…¶ä¸­ <code>GenericAPIServer</code>ä¸»è¦å¤„ç†<code>apiregistration.k8s.io</code>ç»„ä¸‹çš„<code>APIService</code>èµ„æºè¯·æ±‚ã€‚</p><p><code>Aggregator</code>é™¤äº†å¤„ç†èµ„æºè¯·æ±‚å¤–è¿˜åŒ…å«å‡ ä¸ªcontrollerï¼š</p><ol><li>apiserviceRegistrationControllerï¼šè´Ÿè´£<code>APIServices</code>ä¸­èµ„æºçš„æ³¨å†Œä¸åˆ é™¤ï¼›</li><li>availableConditionControllerï¼šç»´æŠ¤<code>APIServices</code>çš„å¯ç”¨çŠ¶æ€ï¼ŒåŒ…æ‹¬å…¶å¼•ç”¨<code>Service</code>æ˜¯å¦å¯ç”¨ç­‰ï¼›</li><li>autoRegistrationControllerï¼šç”¨äºä¿æŒAPIä¸­å­˜åœ¨çš„ä¸€ç»„ç‰¹å®šçš„<code>APIServices</code>ï¼›</li><li>crdRegistrationControllerï¼šè´Ÿè´£å°†<code>CRD GroupVersions</code>è‡ªåŠ¨æ³¨å†Œåˆ°<code>APIServices</code>ä¸­ï¼›</li><li>openAPIAggregationControllerï¼šå°†<code>APIServices</code>èµ„æºçš„å˜åŒ–åŒæ­¥è‡³æä¾›çš„<code>OpenAPI</code>æ–‡æ¡£ï¼›<br>kubernetesä¸­çš„ä¸€äº›é™„åŠ ç»„ä»¶ï¼Œæ¯”å¦‚metrics-serverå°±æ˜¯é€šè¿‡Aggregatorçš„æ–¹å¼è¿›è¡Œæ‰©å±•çš„ï¼Œå®é™…ç¯å¢ƒä¸­å¯ä»¥é€šè¿‡ä½¿ç”¨apiserver-builderå·¥å…·è½»æ¾ä»¥Aggregatorçš„æ‰©å±•æ–¹å¼åˆ›å»ºè‡ªå®šä¹‰èµ„æºã€‚</li></ol><p>åˆå§‹åŒ–AggregatorServerçš„ä¸»è¦é€»è¾‘ä¸ºï¼š</p><ol><li>è°ƒç”¨<code>aggregatorConfig.Complete().NewWithDelegate</code>åˆ›å»º<code>aggregatorServer</code></li><li>åˆå§‹åŒ–<code>crdRegistrationController</code>å’Œ<code>autoRegistrationController</code>ï¼Œ<code>crdRegistrationController</code>è´Ÿè´£æ³¨å†ŒCRDï¼Œ<code>autoRegistrationController</code>è´Ÿè´£å°† CRD å¯¹åº”çš„ APIServicesè‡ªåŠ¨æ³¨å†Œåˆ°apiserverä¸­ï¼ŒCRD åˆ›å»ºåå¯é€šè¿‡<code>kubectl get apiservices</code>æŸ¥çœ‹æ˜¯å¦æ³¨å†Œåˆ° apiservicesä¸­</li><li>å°†<code>autoRegistrationController</code>å’Œ<code>crdRegistrationController</code>åŠ å…¥åˆ°PostStartHookä¸­</li></ol><p>API Server çš„è°ƒç”¨é“¾ï¼Œå¤§ä½“å¦‚ä¸‹ <code>DefaultHandlerChain-&gt;{handler/crdhandler/proxy}-&gt;admission-&gt;validation-&gt;etcd</code></p><ol><li>è¯·æ±‚è¿›å…¥æ—¶ï¼Œä¼šç»è¿‡<code>defaultchain</code>åšä¸€äº›è®¤è¯é‰´æƒå·¥ä½œ</li><li>ç„¶åé€šè¿‡<code>route</code>æ‰§è¡Œå¯¹åº”çš„handlerï¼Œå¦‚æœä¸ºaggration api, å°†ç›´æ¥è½¬å‘è¯·æ±‚åˆ°å¯¹åº”service</li><li>handlerå¤„ç†å®Œï¼Œç»è¿‡admissionä¸validationï¼Œåšä¸€äº›ä¿®æ”¹å’Œæ£€æŸ¥ï¼Œç”¨æˆ·åœ¨è¿™éƒ¨åˆ†å¯ä»¥è‡ªå®šä¹‰webhook</li><li>æœ€åå­˜å…¥etcd</li></ol><h4 id="API-server-å¯åŠ¨è¿‡ç¨‹"><a href="#API-server-å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="API server å¯åŠ¨è¿‡ç¨‹"></a>API server å¯åŠ¨è¿‡ç¨‹</h4><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/cmd/kube-apiserver/apiserver.go" target="_blank" rel="noopener">kubernetes/cmd/kube-apiserver/apiserver.go</a></p><p>è°ƒç”¨é“¾ï¼š</p><pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run()-&gt;</code></pre><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewAPIServerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>    s <span class="token operator">:=</span> options<span class="token punctuation">.</span><span class="token function">NewServerRunOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>        Use<span class="token punctuation">:</span> <span class="token string">"kube-apiserver"</span><span class="token punctuation">,</span>        Long<span class="token punctuation">:</span> <span class="token string">`The Kubernetes API server validates and configures datafor the api objects which include pods, services, replicationcontrollers, andothers. The API Server services REST operations and provides the frontend to thecluster's shared state through which all other components interact.`</span><span class="token punctuation">,</span>        Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            verflag<span class="token punctuation">.</span><span class="token function">PrintAndExitIfRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            stopCh <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">Run</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>                os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    s<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> cmd<span class="token punctuation">}</span></code></pre><p>APIServerçš„å¯åŠ¨å‚æ•°å­˜å‚¨åœ¨ServerRunOptionsä¸­ï¼Œå¯åŠ¨å‚æ•°åŸºäºå‘½ä»¤è¡Œå‚æ•°è¿›è¡Œè§£æã€‚<br> cobraæ¡†æ¶ä¼šè‡ªåŠ¨åˆ†æå‘½ä»¤è¡Œå‚æ•°ï¼Œå‘½ä»¤è¡Œå‚æ•°çš„è§£ææ˜¯ç”±s.AddFlag(cmd.Flags())ä¸­é¢„å…ˆå®šä¹‰å¥½çš„ã€‚åœ¨AddFlagsæ–¹æ³•ä¸­ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// AddFlags adds flags for a specific APIServer to the specified FlagSet</span><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>ServerRunOptions<span class="token punctuation">)</span> <span class="token function">AddFlags</span><span class="token punctuation">(</span>fs <span class="token operator">*</span>pflag<span class="token punctuation">.</span>FlagSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Add the generic flags.</span>    s<span class="token punctuation">.</span>GenericServerRunOptions<span class="token punctuation">.</span><span class="token function">AddUniversalFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>SecureServing<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>InsecureServing<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>InsecureServing<span class="token punctuation">.</span><span class="token function">AddDeprecatedFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>Audit<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>Features<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>CloudProvider<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>StorageSerialization<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>APIEnablement<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>Admission<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>       <span class="token operator">...</span><span class="token operator">...</span>       fs<span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">.</span>EnableAggregatorRouting<span class="token punctuation">,</span> <span class="token string">"enable-aggregator-routing"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>EnableAggregatorRouting<span class="token punctuation">,</span>        <span class="token string">"Turns on aggregator routing requests to endoints IP rather than cluster IP."</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>æœ€ç»ˆï¼Œæˆ‘ä»¬ä¼šæ‰§è¡ŒCommand.Executeæ–¹æ³•å¯åŠ¨ç¨‹åºï¼Œå®ƒä¼šé¦–å…ˆè§£æå‚æ•°ï¼Œç„¶åæ‰§è¡ŒRunæ–¹æ³•ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Run runs the specified APIServer.  This should never exit.</span><span class="token keyword">func</span> <span class="token function">Run</span><span class="token punctuation">(</span>completeOptions completedServerRunOptions<span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// To help debugging, immediately log version</span>    klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Version: %+v"</span><span class="token punctuation">,</span> version<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    server<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CreateServerChain</span><span class="token punctuation">(</span>completeOptions<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    prepared<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">PrepareRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token keyword">return</span> prepared<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p><strong>æ„å»ºæœåŠ¡å™¨è°ƒç”¨é“¾</strong></p><p>åœ¨ä¸Šé¢çš„Runæ–¹æ³•ä¸­ï¼ŒCreateServerChain è´Ÿè´£æ„å»ºæœåŠ¡å™¨é“¾ï¼Œæœ€ç»ˆè¿”å› aggregatorServer ï¼Œï¼šAPI Serverä¸»è¦å·¥ä½œéƒ½åœ¨CreateServerChainä¸­å®Œæˆçš„ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// CreateServerChain creates the apiservers connected via delegation.</span><span class="token keyword">func</span> <span class="token function">CreateServerChain</span><span class="token punctuation">(</span>completedOptions completedServerRunOptions<span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>aggregatorapiserver<span class="token punctuation">.</span>APIAggregator<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å¦‚æœæŒ‡å®šäº†SSHUserå‚æ•°ï¼ŒCreateNodeDialerç”¨äºåˆ›å»ºè¿æ¥æœ¬æœºèŠ‚ç‚¹çš„ç›¸å…³ä¼ è¾“æ–¹æ³•å’Œç½‘ç»œå»ºç«‹æ–¹æ³•</span>    <span class="token comment" spellcheck="true">// æ‰€ä»¥ä¸æœ¬æœºæ˜¯é€šè¿‡SSHéš§é“äº¤äº’çš„ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯æ²¡æœ‰è®¾ç½®SSHUserå‚æ•°çš„ã€‚</span>    nodeTunneler<span class="token punctuation">,</span> proxyTransport<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CreateNodeDialer</span><span class="token punctuation">(</span>completedOptions<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    kubeAPIServerConfig<span class="token punctuation">,</span> insecureServingInfo<span class="token punctuation">,</span> serviceResolver<span class="token punctuation">,</span> pluginInitializer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CreateKubeAPIServerConfig</span><span class="token punctuation">(</span>completedOptions<span class="token punctuation">,</span> nodeTunneler<span class="token punctuation">,</span> proxyTransport<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// If additional API servers are added, they should be gated.</span>    apiExtensionsConfig<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createAPIExtensionsConfig</span><span class="token punctuation">(</span><span class="token operator">*</span>kubeAPIServerConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">,</span> kubeAPIServerConfig<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>VersionedInformers<span class="token punctuation">,</span> pluginInitializer<span class="token punctuation">,</span> completedOptions<span class="token punctuation">.</span>ServerRunOptions<span class="token punctuation">,</span> completedOptions<span class="token punctuation">.</span>MasterCount<span class="token punctuation">,</span>        serviceResolver<span class="token punctuation">,</span> webhook<span class="token punctuation">.</span><span class="token function">NewDefaultAuthenticationInfoResolverWrapper</span><span class="token punctuation">(</span>proxyTransport<span class="token punctuation">,</span> kubeAPIServerConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> kubeAPIServerConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    apiExtensionsServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createAPIExtensionsServer</span><span class="token punctuation">(</span>apiExtensionsConfig<span class="token punctuation">,</span> genericapiserver<span class="token punctuation">.</span><span class="token function">NewEmptyDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    kubeAPIServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CreateKubeAPIServer</span><span class="token punctuation">(</span>kubeAPIServerConfig<span class="token punctuation">,</span> apiExtensionsServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// aggregator comes last in the chain</span>    aggregatorConfig<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createAggregatorConfig</span><span class="token punctuation">(</span><span class="token operator">*</span>kubeAPIServerConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">,</span> completedOptions<span class="token punctuation">.</span>ServerRunOptions<span class="token punctuation">,</span> kubeAPIServerConfig<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>VersionedInformers<span class="token punctuation">,</span> serviceResolver<span class="token punctuation">,</span> proxyTransport<span class="token punctuation">,</span> pluginInitializer<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    aggregatorServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createAggregatorServer</span><span class="token punctuation">(</span>aggregatorConfig<span class="token punctuation">,</span> kubeAPIServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">,</span> apiExtensionsServer<span class="token punctuation">.</span>Informers<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// we don't need special handling for innerStopCh because the aggregator server doesn't create any go routines</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> insecureServingInfo <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        insecureHandlerChain <span class="token operator">:=</span> kubeserver<span class="token punctuation">.</span><span class="token function">BuildInsecureHandlerChain</span><span class="token punctuation">(</span>aggregatorServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">UnprotectedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kubeAPIServerConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> insecureServingInfo<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>insecureHandlerChain<span class="token punctuation">,</span> kubeAPIServerConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RequestTimeout<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> aggregatorServer<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>CreateServerChainå®Œæˆäº†ä¸»è¦çš„æµç¨‹ï¼Œé‡Œé¢æœ‰å‡ ä¸ªæ­¥éª¤æ¯”è¾ƒç‰¹æ®Šï¼Œè¿™é‡Œåˆ†åˆ«è®²è§£</p><h4 id="GenericAPIServer"><a href="#GenericAPIServer" class="headerlink" title="GenericAPIServer"></a>GenericAPIServer</h4><p>è°ƒç”¨é“¾ï¼š</p><pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run()-&gt;server.PrepareRun()-&gt; s.GenericAPIServer.PrepareRun()</code></pre><p>GenericAPIServerå¯ä»¥ç†è§£ä¸ºKubernetesä¸­æä¾›APIæœåŠ¡çš„ç»“æ„ä½“ã€‚</p><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/9d3406c27b581c0961ac5871f6893f838d59b10c/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go </a></p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> GenericAPIServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// discoveryAddresses is used to build cluster IPs for discovery.</span>    discoveryAddresses discovery<span class="token punctuation">.</span>Addresses<span class="token operator">...</span>    <span class="token comment" spellcheck="true">// healthz checks</span>    healthzLock            sync<span class="token punctuation">.</span>Mutex    healthzChecks          <span class="token punctuation">[</span><span class="token punctuation">]</span>healthz<span class="token punctuation">.</span>HealthChecker    healthzChecksInstalled <span class="token builtin">bool</span><span class="token operator">...</span>    maxRequestBodyBytes <span class="token builtin">int64</span><span class="token punctuation">}</span></code></pre><p>å¦‚ä½•ç”Ÿæˆ GenericAPIServer </p><p>è°ƒç”¨è·¯å¾„ï¼š</p><pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run()-&gt;CreateServerChain()-&gt;CreateKubeAPIServer()-&gt;kubeAPIServerConfig.Complete().New(delegateAPIServer)-&gt;c.GenericConfig.New("kube-apiserver", delegationTarget)</code></pre><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c completedConfig<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> delegationTarget DelegationTarget<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>GenericAPIServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span>    handlerChainBuilder <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>        <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">BuildHandlerChainFunc</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Config<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    apiServerHandler <span class="token operator">:=</span> <span class="token function">NewAPIServerHandler</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> handlerChainBuilder<span class="token punctuation">,</span> delegationTarget<span class="token punctuation">.</span><span class="token function">UnprotectedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    s <span class="token operator">:=</span> <span class="token operator">&amp;</span>GenericAPIServer<span class="token punctuation">{</span>        discoveryAddresses<span class="token punctuation">:</span>         c<span class="token punctuation">.</span>DiscoveryAddresses<span class="token punctuation">,</span>        <span class="token operator">...</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span><span class="token operator">...</span>    <span class="token comment" spellcheck="true">// å®‰è£…ç‰¹æ®ŠåŠŸèƒ½çš„è·¯å¾„</span>    <span class="token function">installAPI</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Config<span class="token punctuation">)</span><span class="token operator">...</span>    <span class="token keyword">return</span> s<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><h4 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h4><p>Masterçš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªGenericAPIServerï¼Œå®šä¹‰åœ¨<a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/master/master.go" target="_blank" rel="noopener">kubernetes/pkg/master/master.go</a>ä¸­ï¼š</p><pre class=" language-go"><code class="language-go">s<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"kube-apiserver"</span><span class="token punctuation">,</span> delegationTarget<span class="token punctuation">)</span><span class="token operator">...</span>m <span class="token operator">:=</span> <span class="token operator">&amp;</span>Master<span class="token punctuation">{</span>    GenericAPIServer<span class="token punctuation">:</span>          s<span class="token punctuation">,</span>    ClusterAuthenticationInfo<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Master contains state for a Kubernetes cluster master/api server.</span><span class="token keyword">type</span> Master <span class="token keyword">struct</span> <span class="token punctuation">{</span>    GenericAPIServer <span class="token operator">*</span>genericapiserver<span class="token punctuation">.</span>GenericAPIServer    ClusterAuthenticationInfo clusterauthenticationtrust<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">}</span></code></pre><p>æ‰€ä»¥Masteræ˜¯å¯¹GenericAPIServerçš„å°è£…ã€‚<br>Masterä¹Ÿæ˜¯ä»Configä¸­æ¥ï¼Œè¿™ä¸ª Config å®šä¹‰ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Config defines configuration for the master</span><span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span>    GenericConfig <span class="token operator">*</span>genericapiserver<span class="token punctuation">.</span>Config    ExtraConfig   ExtraConfig<span class="token punctuation">}</span></code></pre><p>å¯ä»¥çœ‹å‡ºï¼ŒMasterçš„ConfigåŒ…å«GenericConfigã€ExtraConfigã€‚<br>Master çš„ Config é€šè¿‡ Complete()ã€‚åœ¨ç”ŸæˆMasterçš„åŒæ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨InstallLegacyAPI()åŠInstallAPIs()æ¥å®‰è£…å„ç§API</p><p>kube-apiserveræ˜¯å¦‚ä½•å¯åŠ¨Masterçš„ï¼š</p><pre class=" language-go"><code class="language-go">prepared <span class="token operator">:=</span> s<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">PrepareRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>preparedAPIAggregator<span class="token punctuation">{</span>APIAggregator<span class="token punctuation">:</span> s<span class="token punctuation">,</span> runnable<span class="token punctuation">:</span> prepared<span class="token punctuation">}</span>prepared<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token punctuation">(</span>s preparedAPIAggregator<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> s<span class="token punctuation">.</span>runnable<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="Install-API"><a href="#Install-API" class="headerlink" title="Install API"></a>Install API</h4><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/master/master.go" target="_blank" rel="noopener">kubernetes/pkg/master/master.go</a></p><pre class=" language-go"><code class="language-go">    m <span class="token operator">:=</span> <span class="token operator">&amp;</span>Master<span class="token punctuation">{</span>        GenericAPIServer<span class="token punctuation">:</span>          s<span class="token punctuation">,</span>        ClusterAuthenticationInfo<span class="token punctuation">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// install legacy rest storage</span>    <span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">.</span><span class="token function">VersionEnabled</span><span class="token punctuation">(</span>apiv1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InstallLegacyAPI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> legacyRESTStorageProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token operator">...</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InstallAPIs</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> restStorageProviders<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span></code></pre><p>åˆ›å»º Master ä¹‹åè°ƒç”¨äº†InstallLegacyAPI()å’ŒInstallAPIs()å®‰è£…APIã€‚</p><h4 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h4><p>Authentication è´Ÿè´£å¯¹ Kubernetes ä¸­çš„è¯·æ±‚è¿›è¡Œè®¤è¯ï¼Œåªæœ‰é€šè¿‡è®¤è¯çš„è¯·æ±‚æ‰ä¼šè¢«æ‰§è¡Œã€‚åœ¨ Kubernetes ä¸­ï¼Œæœ‰BasicAuth, Keystone, X509, Token, ServiceAccount, OIDCIssuer, WebhookToken, AnyTokenç­‰è®¤è¯å™¨ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹ Kubernetes æ˜¯å¦‚ä½•ç®¡ç†è®¤è¯å™¨çš„ï¼ŒåŠå¦‚ä½•å¯¹è¯·æ±‚è¿›è¡Œè®¤è¯ã€‚</p><p>è°ƒç”¨é“¾ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> app<span class="token punctuation">.</span><span class="token function">NewAPIServerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">CreateServerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">CreateKubeAPIServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">buildGenericConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">BuildAuthenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> authenticatorConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/1871f75b32f5d96c62ce6aa8c2d393124b7002aa/cmd/kube-apiserver/app/server.go#L501" target="_blank" rel="noopener">kubernetes/cmd/kube-apiserver/app/server.go</a></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// BuildAuthenticator constructs the authenticator</span><span class="token keyword">func</span> <span class="token function">BuildAuthenticator</span><span class="token punctuation">(</span>s <span class="token operator">*</span>options<span class="token punctuation">.</span>ServerRunOptions<span class="token punctuation">,</span> extclient clientgoclientset<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> versionedInformer clientgoinformers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">)</span> <span class="token punctuation">(</span>authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> <span class="token operator">*</span>spec<span class="token punctuation">.</span>SecurityDefinitions<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    authenticatorConfig <span class="token operator">:=</span> s<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span><span class="token function">ToAuthenticationConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> s<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>ServiceAccounts<span class="token punctuation">.</span>Lookup <span class="token operator">||</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>TokenRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>        authenticatorConfig<span class="token punctuation">.</span>ServiceAccountTokenGetter <span class="token operator">=</span> serviceaccountcontroller<span class="token punctuation">.</span><span class="token function">NewGetterFromClient</span><span class="token punctuation">(</span>            extclient<span class="token punctuation">,</span>            versionedInformer<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            versionedInformer<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ServiceAccounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            versionedInformer<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    authenticatorConfig<span class="token punctuation">.</span>BootstrapTokenAuthenticator <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">NewTokenAuthenticator</span><span class="token punctuation">(</span>        versionedInformer<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>NamespaceSystem<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    <span class="token keyword">return</span> authenticatorConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥çœ‹authenticator.New()ï¼Œå®šä¹‰åœ¨<code>kubernetes/pkg/kubeapiserver/authenticator/config.go</code>ä¸­ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// New returns an authenticator.Request or an error that supports the standard</span><span class="token comment" spellcheck="true">// Kubernetes authentication mechanisms.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>config Config<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> <span class="token operator">*</span>spec<span class="token punctuation">.</span>SecurityDefinitions<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> authenticators <span class="token punctuation">[</span><span class="token punctuation">]</span>authenticator<span class="token punctuation">.</span>Request    <span class="token keyword">var</span> tokenAuthenticators <span class="token punctuation">[</span><span class="token punctuation">]</span>authenticator<span class="token punctuation">.</span>Token    securityDefinitions <span class="token operator">:=</span> spec<span class="token punctuation">.</span>SecurityDefinitions<span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// front-proxy, BasicAuth methods, local first, then remote</span>    <span class="token comment" spellcheck="true">// Add the front proxy authenticator if requested</span>    <span class="token keyword">if</span> config<span class="token punctuation">.</span>RequestHeaderConfig <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        requestHeaderAuthenticator <span class="token operator">:=</span> headerrequest<span class="token punctuation">.</span><span class="token function">NewDynamicVerifyOptionsSecure</span><span class="token punctuation">(</span>            config<span class="token punctuation">.</span>RequestHeaderConfig<span class="token punctuation">.</span>CAContentProvider<span class="token punctuation">.</span>VerifyOptions<span class="token punctuation">,</span>            config<span class="token punctuation">.</span>RequestHeaderConfig<span class="token punctuation">.</span>AllowedClientNames<span class="token punctuation">,</span>            config<span class="token punctuation">.</span>RequestHeaderConfig<span class="token punctuation">.</span>UsernameHeaders<span class="token punctuation">,</span>            config<span class="token punctuation">.</span>RequestHeaderConfig<span class="token punctuation">.</span>GroupHeaders<span class="token punctuation">,</span>            config<span class="token punctuation">.</span>RequestHeaderConfig<span class="token punctuation">.</span>ExtraHeaderPrefixes<span class="token punctuation">,</span>        <span class="token punctuation">)</span>        authenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authenticators<span class="token punctuation">,</span> authenticator<span class="token punctuation">.</span><span class="token function">WrapAudienceAgnosticRequest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> requestHeaderAuthenticator<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// basic auth</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BasicAuthFile<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        basicAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newAuthenticatorFromBasicAuthFile</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BasicAuthFile<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        authenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authenticators<span class="token punctuation">,</span> authenticator<span class="token punctuation">.</span><span class="token function">WrapAudienceAgnosticRequest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> basicAuth<span class="token punctuation">)</span><span class="token punctuation">)</span>        securityDefinitions<span class="token punctuation">[</span><span class="token string">"HTTPBasic"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>spec<span class="token punctuation">.</span>SecurityScheme<span class="token punctuation">{</span>            SecuritySchemeProps<span class="token punctuation">:</span> spec<span class="token punctuation">.</span>SecuritySchemeProps<span class="token punctuation">{</span>                Type<span class="token punctuation">:</span>        <span class="token string">"basic"</span><span class="token punctuation">,</span>                Description<span class="token punctuation">:</span> <span class="token string">"HTTP Basic authentication"</span><span class="token punctuation">,</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// X509 methods</span>    <span class="token keyword">if</span> config<span class="token punctuation">.</span>ClientCAContentProvider <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        certAuth <span class="token operator">:=</span> x509<span class="token punctuation">.</span><span class="token function">NewDynamic</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ClientCAContentProvider<span class="token punctuation">.</span>VerifyOptions<span class="token punctuation">,</span> x509<span class="token punctuation">.</span>CommonNameUserConversion<span class="token punctuation">)</span>        authenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authenticators<span class="token punctuation">,</span> certAuth<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Bearer token methods, local first, then remote</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>TokenAuthFile<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        tokenAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newAuthenticatorFromTokenFile</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>TokenAuthFile<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        tokenAuthenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">,</span> authenticator<span class="token punctuation">.</span><span class="token function">WrapAudienceAgnosticToken</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> tokenAuth<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ServiceAccountKeyFiles<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        serviceAccountAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newLegacyServiceAccountAuthenticator</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ServiceAccountKeyFiles<span class="token punctuation">,</span> config<span class="token punctuation">.</span>ServiceAccountLookup<span class="token punctuation">,</span> config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> config<span class="token punctuation">.</span>ServiceAccountTokenGetter<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        tokenAuthenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">,</span> serviceAccountAuth<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>TokenRequest<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>ServiceAccountIssuer <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>        serviceAccountAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newServiceAccountAuthenticator</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ServiceAccountIssuer<span class="token punctuation">,</span> config<span class="token punctuation">.</span>ServiceAccountKeyFiles<span class="token punctuation">,</span> config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> config<span class="token punctuation">.</span>ServiceAccountTokenGetter<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        tokenAuthenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">,</span> serviceAccountAuth<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> config<span class="token punctuation">.</span>BootstrapToken <span class="token punctuation">{</span>        <span class="token keyword">if</span> config<span class="token punctuation">.</span>BootstrapTokenAuthenticator <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// TODO: This can sometimes be nil because of</span>            tokenAuthenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">,</span> authenticator<span class="token punctuation">.</span><span class="token function">WrapAudienceAgnosticToken</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> config<span class="token punctuation">.</span>BootstrapTokenAuthenticator<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// NOTE(ericchiang): Keep the OpenID Connect after Service Accounts.</span>    <span class="token comment" spellcheck="true">//</span>    <span class="token comment" spellcheck="true">// Because both plugins verify JWTs whichever comes first in the union experiences</span>    <span class="token comment" spellcheck="true">// cache misses for all requests using the other. While the service account plugin</span>    <span class="token comment" spellcheck="true">// simply returns an error, the OpenID Connect plugin may query the provider to</span>    <span class="token comment" spellcheck="true">// update the keys, causing performance hits.</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>OIDCIssuerURL<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>OIDCClientID<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        oidcAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newAuthenticatorFromOIDCIssuerURL</span><span class="token punctuation">(</span>oidc<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>            IssuerURL<span class="token punctuation">:</span>            config<span class="token punctuation">.</span>OIDCIssuerURL<span class="token punctuation">,</span>            ClientID<span class="token punctuation">:</span>             config<span class="token punctuation">.</span>OIDCClientID<span class="token punctuation">,</span>            CAFile<span class="token punctuation">:</span>               config<span class="token punctuation">.</span>OIDCCAFile<span class="token punctuation">,</span>            UsernameClaim<span class="token punctuation">:</span>        config<span class="token punctuation">.</span>OIDCUsernameClaim<span class="token punctuation">,</span>            UsernamePrefix<span class="token punctuation">:</span>       config<span class="token punctuation">.</span>OIDCUsernamePrefix<span class="token punctuation">,</span>            GroupsClaim<span class="token punctuation">:</span>          config<span class="token punctuation">.</span>OIDCGroupsClaim<span class="token punctuation">,</span>            GroupsPrefix<span class="token punctuation">:</span>         config<span class="token punctuation">.</span>OIDCGroupsPrefix<span class="token punctuation">,</span>            SupportedSigningAlgs<span class="token punctuation">:</span> config<span class="token punctuation">.</span>OIDCSigningAlgs<span class="token punctuation">,</span>            RequiredClaims<span class="token punctuation">:</span>       config<span class="token punctuation">.</span>OIDCRequiredClaims<span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        tokenAuthenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">,</span> authenticator<span class="token punctuation">.</span><span class="token function">WrapAudienceAgnosticToken</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> oidcAuth<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>WebhookTokenAuthnConfigFile<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        webhookTokenAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newWebhookTokenAuthenticator</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        tokenAuthenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">,</span> webhookTokenAuth<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Union the token authenticators</span>        tokenAuth <span class="token operator">:=</span> tokenunion<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>tokenAuthenticators<span class="token operator">...</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// Optionally cache authentication results</span>        <span class="token keyword">if</span> config<span class="token punctuation">.</span>TokenSuccessCacheTTL <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> config<span class="token punctuation">.</span>TokenFailureCacheTTL <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>            tokenAuth <span class="token operator">=</span> tokencache<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>tokenAuth<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>TokenSuccessCacheTTL<span class="token punctuation">,</span> config<span class="token punctuation">.</span>TokenFailureCacheTTL<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        authenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authenticators<span class="token punctuation">,</span> bearertoken<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>tokenAuth<span class="token punctuation">)</span><span class="token punctuation">,</span> websocket<span class="token punctuation">.</span><span class="token function">NewProtocolAuthenticator</span><span class="token punctuation">(</span>tokenAuth<span class="token punctuation">)</span><span class="token punctuation">)</span>        securityDefinitions<span class="token punctuation">[</span><span class="token string">"BearerToken"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>spec<span class="token punctuation">.</span>SecurityScheme<span class="token punctuation">{</span>            SecuritySchemeProps<span class="token punctuation">:</span> spec<span class="token punctuation">.</span>SecuritySchemeProps<span class="token punctuation">{</span>                Type<span class="token punctuation">:</span>        <span class="token string">"apiKey"</span><span class="token punctuation">,</span>                Name<span class="token punctuation">:</span>        <span class="token string">"authorization"</span><span class="token punctuation">,</span>                In<span class="token punctuation">:</span>          <span class="token string">"header"</span><span class="token punctuation">,</span>                Description<span class="token punctuation">:</span> <span class="token string">"Bearer Token authentication"</span><span class="token punctuation">,</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>authenticators<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> config<span class="token punctuation">.</span>Anonymous <span class="token punctuation">{</span>            <span class="token keyword">return</span> anonymous<span class="token punctuation">.</span><span class="token function">NewAuthenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>securityDefinitions<span class="token punctuation">,</span> <span class="token boolean">nil</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>securityDefinitions<span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    authenticator <span class="token operator">:=</span> union<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>authenticators<span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// GroupAdderå®šä¹‰åœ¨ /pkg/authentication/group/group_adder.go</span>    <span class="token comment" spellcheck="true">// antenticatorè°ƒç”¨çš„æ˜¯ GroupAdderçš„ AuthenticateRequest()</span>    authenticator <span class="token operator">=</span> group<span class="token punctuation">.</span><span class="token function">NewAuthenticatedGroupAdder</span><span class="token punctuation">(</span>authenticator<span class="token punctuation">)</span>    <span class="token keyword">if</span> config<span class="token punctuation">.</span>Anonymous <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// If the authenticator chain returns an error, return an error (don't consider a bad bearer token</span>        <span class="token comment" spellcheck="true">// or invalid username/password combination anonymous).</span>        authenticator <span class="token operator">=</span> union<span class="token punctuation">.</span><span class="token function">NewFailOnError</span><span class="token punctuation">(</span>authenticator<span class="token punctuation">,</span> anonymous<span class="token punctuation">.</span><span class="token function">NewAuthenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> authenticator<span class="token punctuation">,</span> <span class="token operator">&amp;</span>securityDefinitions<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p><code>New()</code>ä¼šæ ¹æ® kube-apiserver çš„å‚æ•°æ¥ç”Ÿæˆå„ä¸ªè®¤è¯å™¨ï¼Œå¹¶æŠŠè®¤è¯å™¨æ”¾åœ¨ <code>authenticators</code> å˜é‡ä¸­ã€‚æ¯”å¦‚ï¼Œå¦‚æœæŒ‡å®šäº†<code>â€“experimental-keystone-url</code>ï¼Œåˆ™å°±ä¼šç”Ÿæˆ<code>keystoneAuthenticator</code>ã€‚è¿™é‡Œè¦å¼ºè°ƒçš„æ˜¯<code>unionAuthenticator</code>å¯ä»¥å°è£…å¤šä¸ªè®¤è¯å™¨ã€‚</p><p>è¿™é‡Œè¿˜è¦æ¶‰åŠåˆ°ä¸€ä¸ªæ¦‚å¿µï¼Œ<code>GroupAdder</code>ï¼Œå°è£…äº†<code>authenticator</code>ï¼Œå®šä¹‰åœ¨<a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/authentication/group/authenticated_group_adder.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apiserver/pkg/authentication/group/authenticated_group_adder.go</a>ä¸­ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// AuthenticatedGroupAdder adds system:authenticated group when appropriate</span><span class="token keyword">type</span> AuthenticatedGroupAdder <span class="token keyword">struct</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Authenticator is delegated to make the authentication decision</span>    Authenticator authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">}</span><span class="token comment" spellcheck="true">// NewAuthenticatedGroupAdder wraps a request authenticator, and adds the system:authenticated group when appropriate.</span><span class="token comment" spellcheck="true">// Authentication must succeed, the user must not be system:anonymous, the groups system:authenticated or system:unauthenticated must</span><span class="token comment" spellcheck="true">// not be present</span><span class="token keyword">func</span> <span class="token function">NewAuthenticatedGroupAdder</span><span class="token punctuation">(</span>auth authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> authenticator<span class="token punctuation">.</span>Request <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>AuthenticatedGroupAdder<span class="token punctuation">{</span>auth<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æ‰€ä»¥ï¼Œkube-apiserverçš„è®¤è¯å™¨æ˜¯ AuthenticatedGroupAdderï¼ŒAuthenticatedGroupAdderå®šä¹‰æœ‰è®¤è¯çš„å…¥å£ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// å®ç°AuthenticateRequest()</span><span class="token comment" spellcheck="true">// è¿”å›user.DefaultInfo</span><span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>AuthenticatedGroupAdder<span class="token punctuation">)</span> <span class="token function">AuthenticateRequest</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>authenticator<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    r<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span>Authenticator<span class="token punctuation">.</span><span class="token function">AuthenticateRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> r<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> user<span class="token punctuation">.</span>Anonymous <span class="token punctuation">{</span>        <span class="token keyword">return</span> r<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> group <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> group <span class="token operator">==</span> user<span class="token punctuation">.</span>AllAuthenticated <span class="token operator">||</span> group <span class="token operator">==</span> user<span class="token punctuation">.</span>AllUnauthenticated <span class="token punctuation">{</span>            <span class="token keyword">return</span> r<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    r<span class="token punctuation">.</span>User <span class="token operator">=</span> <span class="token operator">&amp;</span>user<span class="token punctuation">.</span>DefaultInfo<span class="token punctuation">{</span>        Name<span class="token punctuation">:</span>   r<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        UID<span class="token punctuation">:</span>    r<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        Groups<span class="token punctuation">:</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>AllAuthenticated<span class="token punctuation">)</span><span class="token punctuation">,</span>        Extra<span class="token punctuation">:</span>  r<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetExtra</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> r<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>AuthenticatedGroupAdder çš„ <code>AuthenticateRequest()</code> ä¼šè°ƒç”¨ unionAuthenticator çš„<code>AuthenticateRequest()</code>å¯¹è¯·æ±‚è¿›è¡Œè®¤è¯ï¼Œå¾—åˆ° user ä¿¡æ¯ä¹‹åè¿”å›ã€‚</p><p>å…³äº Groupï¼Œå®šä¹‰åœ¨<code>kubernetes/staging/src/k8s.io/apiserver/pkg/authentication/user/user.go</code>ä¸­ï¼Œ<code>authenticator.New()</code>ä¼ å…¥çš„æ˜¯AllAuthenticatedã€‚</p><p>æˆ‘ä»¬åˆ†æä¸€ä¸ªåŸºæœ¬è®¤è¯</p><pre class=" language-go"><code class="language-go">    <span class="token comment" spellcheck="true">// basic auth</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BasicAuthFile<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        basicAuth<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newAuthenticatorFromBasicAuthFile</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BasicAuthFile<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        authenticators <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authenticators<span class="token punctuation">,</span> authenticator<span class="token punctuation">.</span><span class="token function">WrapAudienceAgnosticRequest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">,</span> basicAuth<span class="token punctuation">)</span><span class="token punctuation">)</span>        securityDefinitions<span class="token punctuation">[</span><span class="token string">"HTTPBasic"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>spec<span class="token punctuation">.</span>SecurityScheme<span class="token punctuation">{</span>            SecuritySchemeProps<span class="token punctuation">:</span> spec<span class="token punctuation">.</span>SecuritySchemeProps<span class="token punctuation">{</span>                Type<span class="token punctuation">:</span>        <span class="token string">"basic"</span><span class="token punctuation">,</span>                Description<span class="token punctuation">:</span> <span class="token string">"HTTP Basic authentication"</span><span class="token punctuation">,</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment" spellcheck="true">// newAuthenticatorFromBasicAuthFile returns an authenticator.Request or an error</span><span class="token keyword">func</span> <span class="token function">newAuthenticatorFromBasicAuthFile</span><span class="token punctuation">(</span>basicAuthFile <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    basicAuthenticator<span class="token punctuation">,</span> err <span class="token operator">:=</span> passwordfile<span class="token punctuation">.</span><span class="token function">NewCSV</span><span class="token punctuation">(</span>basicAuthFile<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">return</span> basicauth<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>basicAuthenticator<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token operator">...</span><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Authenticator<span class="token punctuation">)</span> <span class="token function">AuthenticateRequest</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>authenticator<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> found <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">BasicAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">AuthenticatePassword</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// If the password authenticator didn't error, provide a default error</span>    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">&amp;&amp;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        err <span class="token operator">=</span> errInvalidAuth    <span class="token punctuation">}</span>    <span class="token keyword">return</span> resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err<span class="token punctuation">}</span></code></pre><p>è¯¥æ–¹æ³•ä¼šä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œç„¶åè°ƒç”¨æ‰€å°è£…çš„è®¤è¯å™¨çš„AuthenticatePassword()æ–¹æ³•è¿›è¡Œè®¤è¯ã€‚</p><p><strong>unionAuthenticator</strong></p><p>unionAuthenticatorå®šä¹‰åœ¨<a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/authentication/request/union/union.go" target="_blank" rel="noopener">/kubernetes/staging/src/k8s.io/apiserver/pkg/authentication/request/union/union.go</a>:</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// unionAuthRequestHandler authenticates requests using a chain of authenticator.Requests</span><span class="token keyword">type</span> unionAuthRequestHandler <span class="token keyword">struct</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Handlers is a chain of request authenticators to delegate to</span>    Handlers <span class="token punctuation">[</span><span class="token punctuation">]</span>authenticator<span class="token punctuation">.</span>Request    <span class="token comment" spellcheck="true">// FailOnError determines whether an error returns short-circuits the chain</span>    FailOnError <span class="token builtin">bool</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// New returns a request authenticator that validates credentials using a chain of authenticator.Request objects.</span><span class="token comment" spellcheck="true">// The entire chain is tried until one succeeds. If all fail, an aggregate error is returned.</span><span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>authRequestHandlers <span class="token operator">...</span>authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> authenticator<span class="token punctuation">.</span>Request <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>authRequestHandlers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> authRequestHandlers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>unionAuthRequestHandler<span class="token punctuation">{</span>Handlers<span class="token punctuation">:</span> authRequestHandlers<span class="token punctuation">,</span> FailOnError<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>unionAuthenticator çš„ <code>AuthenticateRequest()</code> æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// é€ä¸ªè°ƒç”¨ authRequestHandlerï¼Œå¦‚æœæœ‰ä¸€ä¸ªæˆåŠŸï¼Œåˆ™è¿”å›</span><span class="token keyword">func</span> <span class="token punctuation">(</span>authHandler <span class="token operator">*</span>unionAuthRequestHandler<span class="token punctuation">)</span> <span class="token function">AuthenticateRequest</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>authenticator<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> errlist <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> currAuthRequestHandler <span class="token operator">:=</span> <span class="token keyword">range</span> authHandler<span class="token punctuation">.</span>Handlers <span class="token punctuation">{</span>        resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> currAuthRequestHandler<span class="token punctuation">.</span><span class="token function">AuthenticateRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> authHandler<span class="token punctuation">.</span>FailOnError <span class="token punctuation">{</span>                <span class="token keyword">return</span> resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            errlist <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errlist<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>            <span class="token keyword">return</span> resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errlist<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p><code>AuthenticateRequest()</code>ä¼šè½®è¯¢æ¯ä¸€ä¸ª authenticatorï¼Œå¦‚æœæœ‰ä¸€ä¸ª authenticator è®¤è¯æˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›è®¤è¯æˆåŠŸã€‚</p><p><strong>å¯¹è¯·æ±‚è¿›è¡Œè®¤è¯</strong></p><p>è°ƒç”¨é“¾ï¼š</p><pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run() -&gt; CreateServerChain() -&gt; CreateKubeAPIServerConfig() -&gt; buildGenericConfig() -&gt; genericapiserver.NewConfig(legacyscheme.Codecs)-&gt; DefaultBuildHandlerChain()</code></pre><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/323f34858de18b862d43c40b2cced65ad8e24052/staging/src/k8s.io/apiserver/pkg/server/config.go" target="_blank" rel="noopener">staging/src/k8s.io/apiserver/pkg/server/config.go</a></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">DefaultBuildHandlerChain</span><span class="token punctuation">(</span>apiHandler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> c <span class="token operator">*</span>Config<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>    handler <span class="token operator">:=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAuthorization</span><span class="token punctuation">(</span>apiHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span>    <span class="token keyword">if</span> c<span class="token punctuation">.</span>FlowControl <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithPriorityAndFairness</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>FlowControl<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithMaxInFlightLimit</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>MaxRequestsInFlight<span class="token punctuation">,</span> c<span class="token punctuation">.</span>MaxMutatingRequestsInFlight<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithImpersonation</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAudit</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditBackend<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditPolicyChecker<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">)</span>    failedHandler <span class="token operator">:=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">Unauthorized</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>SupportsBasicAuth<span class="token punctuation">)</span>    failedHandler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithFailedAuthenticationAudit</span><span class="token punctuation">(</span>failedHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditBackend<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditPolicyChecker<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAuthentication</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>Authenticator<span class="token punctuation">,</span> failedHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithCORS</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>CorsAllowedOriginList<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithTimeoutForNonLongRunningRequests</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RequestTimeout<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithWaitGroup</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>HandlerChainWaitGroup<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithRequestInfo</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RequestInfoResolver<span class="token punctuation">)</span>    <span class="token keyword">if</span> c<span class="token punctuation">.</span>SecureServing <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>SecureServing<span class="token punctuation">.</span>DisableHTTP2 <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>GoawayChance <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithProbabilisticGoaway</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GoawayChance<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithPanicRecovery</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>    <span class="token keyword">return</span> handler<span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬æ³¨æ„åˆ° <code>handler = genericapifilters.WithAuthentication(handler, c.Authentication.Authenticator, failedHandler, c.Authentication.APIAudiences)</code></p><p>ä»£ç è·¯å¾„ï¼š<a href="https://github.com/kubernetes/kubernetes/blob/323f34858de18b862d43c40b2cced65ad8e24052/staging/src/k8s.io/apiserver/pkg/endpoints/filters/authentication.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apiserver/pkg/endpoints/filters/authentication.go</a></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">WithAuthentication</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> auth authenticator<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> failed http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> apiAuds authenticator<span class="token punctuation">.</span>Audiences<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>    <span class="token keyword">if</span> auth <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"Authentication is disabled"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> handler    <span class="token punctuation">}</span>    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>        authenticationStart <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>apiAuds<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>            req <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>authenticator<span class="token punctuation">.</span><span class="token function">WithAudiences</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> apiAuds<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//  handlerä¸­çš„è®¤è¯</span>        resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> auth<span class="token punctuation">.</span><span class="token function">AuthenticateRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>        <span class="token keyword">defer</span> <span class="token function">recordAuthMetrics</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err<span class="token punctuation">,</span> apiAuds<span class="token punctuation">,</span> authenticationStart<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Unable to authenticate the request due to an error: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            failed<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">audiencesAreAcceptable</span><span class="token punctuation">(</span>apiAuds<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Audiences<span class="token punctuation">)</span> <span class="token punctuation">{</span>            err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unable to match the audience: %v , accepted: %v"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Audiences<span class="token punctuation">,</span> apiAuds<span class="token punctuation">)</span>            klog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>            failed<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// authorization header is not required anymore in case of a successful authentication.</span>        req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span>        req <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>genericapirequest<span class="token punctuation">.</span><span class="token function">WithUser</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>        handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>å…¶ä¸­ï¼Œhttp.HandlerFunc æœ¬èº«å°±æ˜¯ä¸€ä¸ªhandlerã€‚æ‰€ä»¥<code>WithAuthentication()</code>å…ˆè°ƒç”¨<code>auth.AuthenticateRequest()</code>å¯¹è¯·æ±‚è¿›è¡ŒéªŒè¯ï¼Œç„¶åè°ƒç”¨å‰handlerçš„<code>ServeHTTP()</code>å¯¹è¯·æ±‚æ¥ç€ä½œå¤„ç†ï¼Œä»¥è¾¾åˆ°åœ¨å¤„ç†å‰è¿›è¡Œè®¤è¯çš„ç›®çš„ã€‚</p><h4 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h4><p>Authorization è´Ÿè´£ Kubernetes ä¸­å¯¹è¯·æ±‚è¿›è¡Œæˆæƒï¼Œåªæœ‰é€šè¿‡æˆæƒçš„è¯·æ±‚æ‰ä¼šè¢«æ‰§è¡Œã€‚åœ¨Kubernetesä¸­ï¼Œä¸»è¦æœ‰ABAC(Attributes Based Access Control)ï¼ŒRBAC(Role Based Access Contro)ï¼ŒAlwaysAllowï¼ŒAlwaysDenyå’ŒWebhook(è°ƒç”¨ç½‘ç»œæ¥å£è¿›è¡Œæˆæƒ)è¿™å‡ ç§æˆæƒå™¨ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹ Kubernetes æ˜¯å¦‚ä½•ç®¡ç†æˆæƒå™¨çš„ï¼ŒåŠå¦‚ä½•å¯¹è¯·æ±‚è¿›è¡Œæˆæƒã€‚</p><p>è°ƒç”¨é“¾ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> app<span class="token punctuation">.</span><span class="token function">NewAPIServerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">CreateServerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">CreateKubeAPIServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">buildGenericConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">BuildAuthorizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> authorizationConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/323f34858de18b862d43c40b2cced65ad8e24052/pkg/kubeapiserver/authorizer/config.go" target="_blank" rel="noopener">kubernetes/pkg/kubeapiserver/authorizer/config.go </a></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// New returns the right sort of union of multiple authorizer.Authorizer objects</span><span class="token comment" spellcheck="true">// based on the authorizationMode or an error.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>config Config<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>authorizer<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> authorizer<span class="token punctuation">.</span>RuleResolver<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>AuthorizationModes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"at least one authorization mode must be passed"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> <span class="token punctuation">(</span>        authorizers   <span class="token punctuation">[</span><span class="token punctuation">]</span>authorizer<span class="token punctuation">.</span>Authorizer        ruleResolvers <span class="token punctuation">[</span><span class="token punctuation">]</span>authorizer<span class="token punctuation">.</span>RuleResolver    <span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> authorizationMode <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>AuthorizationModes <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Keep cases in sync with constant list in k8s.io/kubernetes/pkg/kubeapiserver/authorizer/modes/modes.go.</span>        <span class="token keyword">switch</span> authorizationMode <span class="token punctuation">{</span>        <span class="token keyword">case</span> modes<span class="token punctuation">.</span>ModeNode<span class="token punctuation">:</span>            graph <span class="token operator">:=</span> node<span class="token punctuation">.</span><span class="token function">NewGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            node<span class="token punctuation">.</span><span class="token function">AddGraphEventHandlers</span><span class="token punctuation">(</span>                graph<span class="token punctuation">,</span>                config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PersistentVolumes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">VolumeAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token punctuation">)</span>            nodeAuthorizer <span class="token operator">:=</span> node<span class="token punctuation">.</span><span class="token function">NewAuthorizer</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> nodeidentifier<span class="token punctuation">.</span><span class="token function">NewDefaultNodeIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bootstrappolicy<span class="token punctuation">.</span><span class="token function">NodeRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            authorizers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authorizers<span class="token punctuation">,</span> nodeAuthorizer<span class="token punctuation">)</span>        <span class="token keyword">case</span> modes<span class="token punctuation">.</span>ModeAlwaysAllow<span class="token punctuation">:</span>            alwaysAllowAuthorizer <span class="token operator">:=</span> authorizerfactory<span class="token punctuation">.</span><span class="token function">NewAlwaysAllowAuthorizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            authorizers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authorizers<span class="token punctuation">,</span> alwaysAllowAuthorizer<span class="token punctuation">)</span>            ruleResolvers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ruleResolvers<span class="token punctuation">,</span> alwaysAllowAuthorizer<span class="token punctuation">)</span>        <span class="token keyword">case</span> modes<span class="token punctuation">.</span>ModeAlwaysDeny<span class="token punctuation">:</span>            alwaysDenyAuthorizer <span class="token operator">:=</span> authorizerfactory<span class="token punctuation">.</span><span class="token function">NewAlwaysDenyAuthorizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            authorizers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authorizers<span class="token punctuation">,</span> alwaysDenyAuthorizer<span class="token punctuation">)</span>            ruleResolvers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ruleResolvers<span class="token punctuation">,</span> alwaysDenyAuthorizer<span class="token punctuation">)</span>        <span class="token keyword">case</span> modes<span class="token punctuation">.</span>ModeABAC<span class="token punctuation">:</span>            abacAuthorizer<span class="token punctuation">,</span> err <span class="token operator">:=</span> abac<span class="token punctuation">.</span><span class="token function">NewFromFile</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>PolicyFile<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            authorizers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authorizers<span class="token punctuation">,</span> abacAuthorizer<span class="token punctuation">)</span>            ruleResolvers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ruleResolvers<span class="token punctuation">,</span> abacAuthorizer<span class="token punctuation">)</span>        <span class="token keyword">case</span> modes<span class="token punctuation">.</span>ModeWebhook<span class="token punctuation">:</span>            webhookAuthorizer<span class="token punctuation">,</span> err <span class="token operator">:=</span> webhook<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>WebhookConfigFile<span class="token punctuation">,</span>                config<span class="token punctuation">.</span>WebhookVersion<span class="token punctuation">,</span>                config<span class="token punctuation">.</span>WebhookCacheAuthorizedTTL<span class="token punctuation">,</span>                config<span class="token punctuation">.</span>WebhookCacheUnauthorizedTTL<span class="token punctuation">,</span>                config<span class="token punctuation">.</span>CustomDial<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            authorizers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authorizers<span class="token punctuation">,</span> webhookAuthorizer<span class="token punctuation">)</span>            ruleResolvers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ruleResolvers<span class="token punctuation">,</span> webhookAuthorizer<span class="token punctuation">)</span>        <span class="token keyword">case</span> modes<span class="token punctuation">.</span>ModeRBAC<span class="token punctuation">:</span>            rbacAuthorizer <span class="token operator">:=</span> rbac<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>                <span class="token operator">&amp;</span>rbac<span class="token punctuation">.</span>RoleGetter<span class="token punctuation">{</span>Lister<span class="token punctuation">:</span> config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Rbac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Roles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token operator">&amp;</span>rbac<span class="token punctuation">.</span>RoleBindingLister<span class="token punctuation">{</span>Lister<span class="token punctuation">:</span> config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Rbac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RoleBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token operator">&amp;</span>rbac<span class="token punctuation">.</span>ClusterRoleGetter<span class="token punctuation">{</span>Lister<span class="token punctuation">:</span> config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Rbac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ClusterRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token operator">&amp;</span>rbac<span class="token punctuation">.</span>ClusterRoleBindingLister<span class="token punctuation">{</span>Lister<span class="token punctuation">:</span> config<span class="token punctuation">.</span>VersionedInformerFactory<span class="token punctuation">.</span><span class="token function">Rbac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ClusterRoleBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">)</span>            authorizers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>authorizers<span class="token punctuation">,</span> rbacAuthorizer<span class="token punctuation">)</span>            ruleResolvers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ruleResolvers<span class="token punctuation">,</span> rbacAuthorizer<span class="token punctuation">)</span>        <span class="token keyword">default</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unknown authorization mode %s specified"</span><span class="token punctuation">,</span> authorizationMode<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> union<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>authorizers<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> union<span class="token punctuation">.</span><span class="token function">NewRuleResolvers</span><span class="token punctuation">(</span>ruleResolvers<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>åœ¨ kube-apiserver çš„å‚æ•°ä¸­ï¼Œæœ‰<code>â€“authorization-mode</code>å‚æ•°ï¼Œæˆæƒå™¨å°±æ˜¯æ ¹æ®<code>â€“authorization-mode</code>å‚æ•°ä¸­æŒ‡å®šçš„å†…å®¹æ¥ç”Ÿæˆçš„ã€‚</p><p>New() ä¼šä¾æ® authorizationModes ç”Ÿæˆç›¸åº”çš„ authorizerï¼Œå¹¶æŠŠå¤šä¸ª authorizers æ‰“åŒ…æˆ unionAuthorizer è¿”å›ã€‚æœ€å server.go ä¸­ç”Ÿæˆçš„ apiAuthorizer ä¼šèµ‹å€¼ç»™ genericConfig.Authorizer ä»¥ç”Ÿæˆ masterã€‚</p><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/ca324214be0c3823b309a145b876bbb79ccd742a/cmd/kube-apiserver/app/server.go" target="_blank" rel="noopener">kubernetes/cmd/kube-apiserver/app/server.go</a></p><pre class=" language-go"><code class="language-go">genericConfig<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>RuleResolver<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">BuildAuthorizer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span></code></pre><p><strong>unionAuthorizer</strong></p><p>ä»£ç è·¯å¾„ï¼š<a href="https://github.com/kubernetes/kubernetes/blob/327f53ba57aeaa4b7e7c20b1ef98c42b26b7ea7f/staging/src/k8s.io/apiserver/pkg/authorization/union/union.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apiserver/pkg/authorization/union/union.go</a></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// unionAuthzHandler authorizer against a chain of authorizer.Authorizer</span><span class="token keyword">type</span> unionAuthzHandler <span class="token punctuation">[</span><span class="token punctuation">]</span>authorizer<span class="token punctuation">.</span>Authorizer<span class="token comment" spellcheck="true">// New returns an authorizer that authorizes against a chain of authorizer.Authorizer objects</span><span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>authorizationHandlers <span class="token operator">...</span>authorizer<span class="token punctuation">.</span>Authorizer<span class="token punctuation">)</span> authorizer<span class="token punctuation">.</span>Authorizer <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">unionAuthzHandler</span><span class="token punctuation">(</span>authorizationHandlers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Authorizes against a chain of authorizer.Authorizer objects and returns nil if successful and returns error if unsuccessful</span><span class="token keyword">func</span> <span class="token punctuation">(</span>authzHandler unionAuthzHandler<span class="token punctuation">)</span> <span class="token function">Authorize</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> a authorizer<span class="token punctuation">.</span>Attributes<span class="token punctuation">)</span> <span class="token punctuation">(</span>authorizer<span class="token punctuation">.</span>Decision<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> <span class="token punctuation">(</span>        errlist    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span>        reasonlist <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>    <span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> currAuthzHandler <span class="token operator">:=</span> <span class="token keyword">range</span> authzHandler <span class="token punctuation">{</span>        decision<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> err <span class="token operator">:=</span> currAuthzHandler<span class="token punctuation">.</span><span class="token function">Authorize</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> a<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            errlist <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errlist<span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>            reasonlist <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>reasonlist<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">switch</span> decision <span class="token punctuation">{</span>        <span class="token keyword">case</span> authorizer<span class="token punctuation">.</span>DecisionAllow<span class="token punctuation">,</span> authorizer<span class="token punctuation">.</span>DecisionDeny<span class="token punctuation">:</span>            <span class="token keyword">return</span> decision<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> err        <span class="token keyword">case</span> authorizer<span class="token punctuation">.</span>DecisionNoOpinion<span class="token punctuation">:</span>            <span class="token comment" spellcheck="true">// continue to the next authorizer</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> authorizer<span class="token punctuation">.</span>DecisionNoOpinion<span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>reasonlist<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errlist<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>unionAuthorizer æœ¬èº«æ˜¯ä¸€ä¸ª Authorizer åˆ—è¡¨ï¼Œå…¶Authorize() æ–¹æ³•ä¼šè°ƒç”¨åˆ—è¡¨ä¸­æ¯ä¸€ä¸ª Authorizer çš„Authorize() æ–¹æ³•ï¼Œä¸€æ—¦æœ‰ä¸€ä¸ª Authorizer æˆæƒé€šè¿‡ï¼Œåˆ™ unionAuthorizer çš„æˆæƒé€šè¿‡ã€‚</p><h5 id="ABACæˆæƒå™¨"><a href="#ABACæˆæƒå™¨" class="headerlink" title="ABACæˆæƒå™¨"></a><strong>ABACæˆæƒå™¨</strong></h5><p>ABACæ˜¯åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼Œç›®å‰ABACæ”¯æŒapiVersion, kind, spec, namespace, resourceç­‰å±æ€§ã€‚ABACè§„åˆ™éœ€è¦ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼š</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"group"</span><span class="token operator">:</span><span class="token string">"system:authenticated"</span><span class="token punctuation">,</span>  <span class="token property">"nonResourcePath"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"group"</span><span class="token operator">:</span><span class="token string">"system:unauthenticated"</span><span class="token punctuation">,</span> <span class="token property">"nonResourcePath"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"admin"</span><span class="token punctuation">,</span>     <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>         <span class="token property">"apiGroup"</span><span class="token operator">:</span> <span class="token string">"*"</span>                   <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"scheduler"</span><span class="token punctuation">,</span> <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"pods"</span><span class="token punctuation">,</span>                       <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"scheduler"</span><span class="token punctuation">,</span> <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"bindings"</span>                                     <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"kubelet"</span><span class="token punctuation">,</span>   <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"pods"</span><span class="token punctuation">,</span>                       <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"kubelet"</span><span class="token punctuation">,</span>   <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"services"</span><span class="token punctuation">,</span>                   <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"kubelet"</span><span class="token punctuation">,</span>   <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"endpoints"</span><span class="token punctuation">,</span>                  <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"kubelet"</span><span class="token punctuation">,</span>   <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>              <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"events"</span>                                       <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"alice"</span><span class="token punctuation">,</span>     <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"projectCaribou"</span><span class="token punctuation">,</span> <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>         <span class="token property">"apiGroup"</span><span class="token operator">:</span> <span class="token string">"*"</span>                   <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"abac.authorization.kubernetes.io/v1beta1"</span><span class="token punctuation">,</span> <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span> <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"bob"</span><span class="token punctuation">,</span>       <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"projectCaribou"</span><span class="token punctuation">,</span> <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>         <span class="token property">"apiGroup"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token property">"readonly"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ABACæˆæƒå™¨å®šä¹‰åœ¨<code>kubernetes/pkg/auth/authorizer/abac/abac.go</code>ä¸­ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> PolicyList <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>abac<span class="token punctuation">.</span>Policy<span class="token comment" spellcheck="true">// ä»policyæ–‡ä»¶æ„å»ºplicylist</span><span class="token keyword">func</span> <span class="token function">NewFromFile</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>PolicyList<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    scanner <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewScanner</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>    pl <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>PolicyList<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>    decoder <span class="token operator">:=</span> abac<span class="token punctuation">.</span>Codecs<span class="token punctuation">.</span><span class="token function">UniversalDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    i <span class="token operator">:=</span> <span class="token number">0</span>    unversionedLines <span class="token operator">:=</span> <span class="token number">0</span>    <span class="token keyword">for</span> scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        i<span class="token operator">++</span>        p <span class="token operator">:=</span> <span class="token operator">&amp;</span>abac<span class="token punctuation">.</span>Policy<span class="token punctuation">{</span><span class="token punctuation">}</span>        b <span class="token operator">:=</span> scanner<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// skip comment lines and blank lines</span>        trimmed <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>trimmed<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>trimmed<span class="token punctuation">,</span> <span class="token string">"#"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        decodedObj<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">IsMissingVersion</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">||</span> runtime<span class="token punctuation">.</span><span class="token function">IsMissingKind</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">||</span> runtime<span class="token punctuation">.</span><span class="token function">IsNotRegisteredError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> policyLoadError<span class="token punctuation">{</span>path<span class="token punctuation">,</span> i<span class="token punctuation">,</span> b<span class="token punctuation">,</span> err<span class="token punctuation">}</span>            <span class="token punctuation">}</span>            unversionedLines<span class="token operator">++</span>            <span class="token comment" spellcheck="true">// Migrate unversioned policy object</span>            oldPolicy <span class="token operator">:=</span> <span class="token operator">&amp;</span>v0<span class="token punctuation">.</span>Policy<span class="token punctuation">{</span><span class="token punctuation">}</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">DecodeInto</span><span class="token punctuation">(</span>decoder<span class="token punctuation">,</span> b<span class="token punctuation">,</span> oldPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> policyLoadError<span class="token punctuation">{</span>path<span class="token punctuation">,</span> i<span class="token punctuation">,</span> b<span class="token punctuation">,</span> err<span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> abac<span class="token punctuation">.</span>Scheme<span class="token punctuation">.</span><span class="token function">Convert</span><span class="token punctuation">(</span>oldPolicy<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> policyLoadError<span class="token punctuation">{</span>path<span class="token punctuation">,</span> i<span class="token punctuation">,</span> b<span class="token punctuation">,</span> err<span class="token punctuation">}</span>            <span class="token punctuation">}</span>            pl <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>pl<span class="token punctuation">,</span> p<span class="token punctuation">)</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        decodedPolicy<span class="token punctuation">,</span> ok <span class="token operator">:=</span> decodedObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>abac<span class="token punctuation">.</span>Policy<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> policyLoadError<span class="token punctuation">{</span>path<span class="token punctuation">,</span> i<span class="token punctuation">,</span> b<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unrecognized object: %#v"</span><span class="token punctuation">,</span> decodedObj<span class="token punctuation">)</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        pl <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>pl<span class="token punctuation">,</span> decodedPolicy<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> unversionedLines <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"Policy file %s contained unversioned rules. See docs/admin/authorization.md#abac-mode for ABAC file format details."</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> scanner<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> policyLoadError<span class="token punctuation">{</span>path<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> pl<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p><code>NewFromFile()</code>è¯»å– ABAC policy æ–‡ä»¶ï¼Œç„¶åæ„å»º policyListï¼Œå¹¶è¿”å›ã€‚<br>policyList ç±»å‹å®ç°äº†<code>Authorize()</code>æ–¹æ³•:</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Authorize implements authorizer.Authorize</span><span class="token keyword">func</span> <span class="token punctuation">(</span>pl PolicyList<span class="token punctuation">)</span> <span class="token function">Authorize</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> a authorizer<span class="token punctuation">.</span>Attributes<span class="token punctuation">)</span> <span class="token punctuation">(</span>authorizer<span class="token punctuation">.</span>Decision<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> pl <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> authorizer<span class="token punctuation">.</span>DecisionAllow<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> authorizer<span class="token punctuation">.</span>DecisionNoOpinion<span class="token punctuation">,</span> <span class="token string">"No policy matched."</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token comment" spellcheck="true">// TODO: Benchmark how much time policy matching takes with a medium size</span>    <span class="token comment" spellcheck="true">// policy file, compared to other steps such as encoding/decoding.</span>    <span class="token comment" spellcheck="true">// Then, add Caching only if needed.</span><span class="token punctuation">}</span></code></pre><p><code>Authorize()</code>æ–¹æ³•ä¼šä½¿ç”¨ policyList ä¸­æ¯ä¸€æ¡ policy å»åŒ¹é…è¯·æ±‚ã€‚å¦‚æœåŒ¹é…åˆ°ï¼Œåˆ™ç›´æ¥é€šè¿‡ï¼›å¦åˆ™ä¸é€šè¿‡ã€‚</p><p>å†æ¥çœ‹ä¸‹åŒ¹é…å‡½æ•°<code>matches()</code>ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">matches</span><span class="token punctuation">(</span>p abac<span class="token punctuation">.</span>Policy<span class="token punctuation">,</span> a authorizer<span class="token punctuation">.</span>Attributes<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token function">subjectMatches</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token function">GetUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token function">verbMatches</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Resource and non-resource requests are mutually exclusive, at most one will match a policy</span>            <span class="token keyword">if</span> <span class="token function">resourceMatches</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">true</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token function">nonResourceMatches</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">true</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">}</span></code></pre><p><code>matches()</code>ä¼šæ‰§è¡Œ<code>subjectMatches()</code>ï¼Œ<code>verbMatches()</code>åŠ<code>resourceMatches()</code>æˆ–<code>nonResourceMatches()</code>ã€‚</p><h5 id="RBACæˆæƒå™¨"><a href="#RBACæˆæƒå™¨" class="headerlink" title="RBACæˆæƒå™¨"></a>RBACæˆæƒå™¨</h5><p>RBACæ˜¯æŒ‡åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚å¯ä»¥æŠŠç”¨æˆ·å’Œè§’è‰²ç›¸å…³è”ï¼Œä»è€Œè·å–ç”¨æˆ·æ‹¥æœ‰çš„æƒé™ã€‚é¦–å…ˆæ¥çœ‹ä¸‹è§’è‰²ï¼Œåœ¨Kubernetesä¸­ï¼Œæœ‰ä¸¤ç§ç±»å‹çš„è§’è‰²ï¼Œä¸€ç§æ˜¯namespacedçš„è§’è‰²ï¼›å¦ä¸€ç§æ˜¯å…¨å±€çš„è§’è‰²ã€‚<br>namespaced çš„è§’è‰²Yamlæ–‡ä»¶å¦‚ä¸‹ï¼š</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>reader<span class="token key atrule">rules</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># "" indicates the core API group</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span></code></pre><p>å…¨å±€çš„è§’è‰²Yamlæ–‡ä»¶å¦‚ä¸‹ï¼š</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># "namespace" omitted since ClusterRoles are not namespaced</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>reader<span class="token key atrule">rules</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">]</span>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span></code></pre><p>ä¸€ä¸ªè§’è‰²å¯¹åº”ç€å¤šæ¡çš„è§„åˆ™ã€‚</p><p>å½“ç„¶ï¼Œè¿˜éœ€è¦ä¸€ç§æœºåˆ¶å…³è”è§’è‰²å’Œç”¨æˆ·ã€‚è¿™å°±æ˜¯RoleBindingå’ŒClusterRoleBindingã€‚ä¾‹å­(è¡¨ç¤ºæŠŠUser janeç»‘å®šåˆ°Role pod-readerä¸Š)å¦‚ä¸‹ï¼š</p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># This role binding allows "jane" to read pods in the "default" namespace.</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> read<span class="token punctuation">-</span>pods  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">subjects</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User  <span class="token key atrule">name</span><span class="token punctuation">:</span> jane  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>reader  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</code></pre><p>å…·ä½“RBACçš„åŠŸèƒ½å¯ä»¥å‚ç…§å®˜æ–¹æ–‡æ¡£ã€‚</p><p>RBACæˆæƒå™¨å®šä¹‰åœ¨<a href="https://github.com/kubernetes/kubernetes/blob/323f34858de18b862d43c40b2cced65ad8e24052/plugin/pkg/auth/authorizer/rbac/rbac.go" target="_blank" rel="noopener">kubernetes/plugin/pkg/auth/authorizer/rbac/rbac.go </a>ä¸­ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> RBACAuthorizer <span class="token keyword">struct</span> <span class="token punctuation">{</span>    authorizationRuleResolver RequestToRuleMapper<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token operator">*</span>RBACAuthorizer <span class="token punctuation">{</span>    authorizer <span class="token operator">:=</span> <span class="token operator">&amp;</span>RBACAuthorizer<span class="token punctuation">{</span>        authorizationRuleResolver<span class="token punctuation">:</span> rbacregistryvalidation<span class="token punctuation">.</span><span class="token function">NewDefaultRuleResolver</span><span class="token punctuation">(</span>            roles<span class="token punctuation">,</span> roleBindings<span class="token punctuation">,</span> clusterRoles<span class="token punctuation">,</span> clusterRoleBindings<span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> authorizer<span class="token punctuation">}</span></code></pre><p>RBACæˆæƒæ–¹æ³•å¦‚ä¸‹:</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RBACAuthorizer<span class="token punctuation">)</span> <span class="token function">Authorize</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> requestAttributes authorizer<span class="token punctuation">.</span>Attributes<span class="token punctuation">)</span> <span class="token punctuation">(</span>authorizer<span class="token punctuation">.</span>Decision<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ruleCheckingVisitor <span class="token operator">:=</span> <span class="token operator">&amp;</span>authorizingVisitor<span class="token punctuation">{</span>requestAttributes<span class="token punctuation">:</span> requestAttributes<span class="token punctuation">}</span>    r<span class="token punctuation">.</span>authorizationRuleResolver<span class="token punctuation">.</span><span class="token function">VisitRulesFor</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ruleCheckingVisitor<span class="token punctuation">.</span>visit<span class="token punctuation">)</span>    <span class="token keyword">if</span> ruleCheckingVisitor<span class="token punctuation">.</span>allowed <span class="token punctuation">{</span>        <span class="token keyword">return</span> authorizer<span class="token punctuation">.</span>DecisionAllow<span class="token punctuation">,</span> ruleCheckingVisitor<span class="token punctuation">.</span>reason<span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span><span class="token operator">...</span>    <span class="token keyword">return</span> authorizer<span class="token punctuation">.</span>DecisionNoOpinion<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>authorizingVisitor<span class="token punctuation">)</span> <span class="token function">visit</span><span class="token punctuation">(</span>source fmt<span class="token punctuation">.</span>Stringer<span class="token punctuation">,</span> rule <span class="token operator">*</span>rbacv1<span class="token punctuation">.</span>PolicyRule<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> rule <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">RuleAllows</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>requestAttributes<span class="token punctuation">,</span> rule<span class="token punctuation">)</span> <span class="token punctuation">{</span>        v<span class="token punctuation">.</span>allowed <span class="token operator">=</span> <span class="token boolean">true</span>        v<span class="token punctuation">.</span>reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RBAC: allowed by %s"</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        v<span class="token punctuation">.</span>errors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span></code></pre><p>ä½¿ç”¨VisitRulesFor()è·å–ç”¨æˆ·çš„è§„åˆ™ï¼Œå†è°ƒç”¨RulesAllow()æ¥æˆæƒã€‚<br>RulesAllow()å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">RuleAllows</span><span class="token punctuation">(</span>requestAttributes authorizer<span class="token punctuation">.</span>Attributes<span class="token punctuation">,</span> rule <span class="token operator">*</span>rbacv1<span class="token punctuation">.</span>PolicyRule<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> requestAttributes<span class="token punctuation">.</span><span class="token function">IsResourceRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        combinedResource <span class="token operator">:=</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetSubresource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>            combinedResource <span class="token operator">=</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetSubresource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> rbacv1helpers<span class="token punctuation">.</span><span class="token function">VerbMatches</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetVerb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>            rbacv1helpers<span class="token punctuation">.</span><span class="token function">APIGroupMatches</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetAPIGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>            rbacv1helpers<span class="token punctuation">.</span><span class="token function">ResourceMatches</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> combinedResource<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetSubresource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>            rbacv1helpers<span class="token punctuation">.</span><span class="token function">ResourceNameMatches</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> rbacv1helpers<span class="token punctuation">.</span><span class="token function">VerbMatches</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetVerb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        rbacv1helpers<span class="token punctuation">.</span><span class="token function">NonResourceURLMatches</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>RuleAllows()é€šè¿‡è°ƒç”¨<code>VerbMatches()</code>, <code>APIGroupMatches()</code>, <code>ResourceMatches()</code>, <code>ResourceNameMatches()</code>ç­‰å‡½æ•°è¿›è¡Œè§„åˆ™åŒ¹é…</p><p><strong>å¯¹è¯·æ±‚è¿›è¡Œè®¤è¯</strong></p><p>è°ƒç”¨é“¾ï¼š</p><pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run() -&gt; CreateServerChain() -&gt; CreateKubeAPIServerConfig() -&gt; buildGenericConfig() -&gt; genericapiserver.NewConfig(legacyscheme.Codecs)-&gt; DefaultBuildHandlerChain()</code></pre><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/ca324214be0c3823b309a145b876bbb79ccd742a/staging/src/k8s.io/apiserver/pkg/server/config.go" target="_blank" rel="noopener">staging/src/k8s.io/apiserver/pkg/server/config.go</a></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">DefaultBuildHandlerChain</span><span class="token punctuation">(</span>apiHandler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> c <span class="token operator">*</span>Config<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>    handler <span class="token operator">:=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAuthorization</span><span class="token punctuation">(</span>apiHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span>    <span class="token keyword">if</span> c<span class="token punctuation">.</span>FlowControl <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithPriorityAndFairness</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>FlowControl<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithMaxInFlightLimit</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>MaxRequestsInFlight<span class="token punctuation">,</span> c<span class="token punctuation">.</span>MaxMutatingRequestsInFlight<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithImpersonation</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAudit</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditBackend<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditPolicyChecker<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">)</span>    failedHandler <span class="token operator">:=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">Unauthorized</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>SupportsBasicAuth<span class="token punctuation">)</span>    failedHandler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithFailedAuthenticationAudit</span><span class="token punctuation">(</span>failedHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditBackend<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditPolicyChecker<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAuthentication</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>Authenticator<span class="token punctuation">,</span> failedHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithCORS</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>CorsAllowedOriginList<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithTimeoutForNonLongRunningRequests</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RequestTimeout<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithWaitGroup</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>HandlerChainWaitGroup<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithRequestInfo</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RequestInfoResolver<span class="token punctuation">)</span>    <span class="token keyword">if</span> c<span class="token punctuation">.</span>SecureServing <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>SecureServing<span class="token punctuation">.</span>DisableHTTP2 <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>GoawayChance <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithProbabilisticGoaway</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GoawayChance<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithPanicRecovery</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>    <span class="token keyword">return</span> handler<span class="token punctuation">}</span></code></pre><p>æ³¨æ„åˆ°ï¼š <code>handler := genericapifilters.WithAuthorization(apiHandler, c.Authorization.Authorizer, c.Serializer)</code></p><p>ä»£ç è·¯å¾„ï¼š<a href="https://github.com/kubernetes/kubernetes/blob/ca324214be0c3823b309a145b876bbb79ccd742a/staging/src/k8s.io/apiserver/pkg/endpoints/filters/authorization.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/apiserver/pkg/endpoints/filters/authorization.go </a></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">WithAuthorization</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> a authorizer<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> s runtime<span class="token punctuation">.</span>NegotiatedSerializer<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>    <span class="token keyword">if</span> a <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"Authorization is disabled"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> handler    <span class="token punctuation">}</span>    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ctx <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        ae <span class="token operator">:=</span> request<span class="token punctuation">.</span><span class="token function">AuditEventFrom</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>        attributes<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">GetAuthorizerAttributes</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            responsewriters<span class="token punctuation">.</span><span class="token function">InternalError</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        authorized<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token function">Authorize</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// an authorizer like RBAC could encounter evaluation errors and still allow the request, so authorizer decision is checked before error here.</span>        <span class="token keyword">if</span> authorized <span class="token operator">==</span> authorizer<span class="token punctuation">.</span>DecisionAllow <span class="token punctuation">{</span>            audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> decisionAnnotationKey<span class="token punctuation">,</span> decisionAllow<span class="token punctuation">)</span>            audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> reasonAnnotationKey<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>            handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> reasonAnnotationKey<span class="token punctuation">,</span> reasonError<span class="token punctuation">)</span>            responsewriters<span class="token punctuation">.</span><span class="token function">InternalError</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Forbidden: %#v, Reason: %q"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>RequestURI<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>        audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> decisionAnnotationKey<span class="token punctuation">,</span> decisionForbid<span class="token punctuation">)</span>        audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> reasonAnnotationKey<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>        responsewriters<span class="token punctuation">.</span><span class="token function">Forbidden</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> s<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>æ¥ä¸‹æ¥çš„è¿‡ç¨‹å’Œè®¤è¯å™¨ä¸€æ ·</p><h4 id="Admission"><a href="#Admission" class="headerlink" title="Admission"></a>Admission</h4><p>åœ¨è¿›è¡Œç”¨æˆ·è®¤è¯å’Œæƒé™æˆäºˆåï¼Œapiserverå°±ä¼šæŸ¥è¯¢/ä¿®æ”¹etcdå­˜å‚¨ï¼Œä»¥å®Œæˆè¯·æ±‚ã€‚</p><p> Admission Controllerï¼ˆå‡†å…¥æ§åˆ¶ï¼‰æ˜¯ Kubernetes API Server ç”¨äºæ‹¦æˆªè¯·æ±‚çš„ä¸€ç§æ‰‹æ®µã€‚Admissionå¯ä»¥åšåˆ°å¯¹è¯·æ±‚çš„èµ„æºå¯¹è±¡è¿›è¡Œæ ¡éªŒï¼Œä¿®æ”¹ã€‚</p><p>![](../Kubernetes ç½‘ç»œå…¥é—¨/img/2019070310251413.png)</p><ul><li>MutatingAdmissionWebhookï¼šåœ¨å¯¹è±¡æŒä¹…åŒ–ä¹‹å‰è¿›è¡Œä¿®æ”¹</li><li>ValidatingAdmissionWebhookï¼šåœ¨å¯¹è±¡æŒä¹…åŒ–ä¹‹å‰è¿›è¡Œ</li></ul><p><strong>Admission Controller å·¥ä½œæµç¨‹</strong></p><ul><li>API Server æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åé¦–å…ˆè¿›è¡Œè®¤è¯é‰´æƒï¼Œè®¤è¯é‰´æƒåæ‰ä¼šè¿›è¡Œ endpoint handler å¤„ç†</li><li>å½“API Server æ¥æ”¶åˆ°å¯¹è±¡åæ ¹æ® http çš„è·¯å¾„å¯ä»¥å¾—åˆ°ç‰ˆæœ¬å·ï¼Œç„¶åå°† body ååºåˆ—åŒ–æˆ versioned object</li><li>versioned object è½¬åŒ–ä¸º internal objectï¼Œå³æ²¡æœ‰ç‰ˆæœ¬çš„å†…éƒ¨ç±»å‹ï¼Œè¿™ç§èµ„æºç±»å‹æ˜¯æ‰€æœ‰ versioned ç±»å‹çš„è¶…é›†ã€‚åªæœ‰è½¬åŒ–ä¸º internal åæ‰èƒ½é€‚é…æ‰€æœ‰çš„å®¢æˆ·ç«¯ versioned object çš„æ ¡éªŒã€</li><li>Admission Controller å…·ä½“çš„ admit æ“ä½œï¼Œå¯ä»¥é€šè¿‡è¿™é‡Œä¿®æ”¹èµ„æºå¯¹è±¡ï¼Œä¾‹å¦‚ä¸º Pod æŒ‚è½½ä¸€ä¸ªé»˜è®¤çš„ Service Account ç­‰</li><li>API Server internal object validationï¼Œæ ¡éªŒæŸä¸ªèµ„æºå¯¹è±¡æ•°æ®å’Œæ ¼å¼æ˜¯å¦åˆæ³•ï¼Œä¾‹å¦‚ï¼šService Name çš„å­—ç¬¦ä¸ªæ•°ä¸èƒ½è¶…è¿‡63ç­‰</li><li>Admission Controller validateï¼Œå¯ä»¥è‡ªå®šä¹‰ä»»ä½•çš„å¯¹è±¡æ ¡éªŒè§„åˆ™</li><li>internal object è½¬åŒ–ä¸º versioned objectï¼Œå¹¶ä¸”æŒä¹…åŒ–å­˜å‚¨åˆ° etcd</li></ul><p>Kubernetes 1.10ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œ<code>--admission-control</code> æ‰“å¼€ Admission Controllerã€‚åŒæ—¶<code>--admission-control</code>çš„é¡ºåºå†³å®š Admission è¿è¡Œçš„å…ˆå</p><p>Kubernetes 1.10ä¹‹åçš„ç‰ˆæœ¬ï¼Œ<code>--admission-control</code> å·²ç»åºŸå¼ƒï¼Œå»ºè®®ä½¿ç”¨ <code>--enable-admission-plugins --disable-admission-plugins</code> æŒ‡å®šéœ€è¦æ‰“å¼€æˆ–è€…å…³é—­çš„ Admission Controllerã€‚ åŒæ—¶ç”¨æˆ·æŒ‡å®šçš„é¡ºåºå¹¶ä¸å½±å“å®é™… Admission Controllers çš„æ‰§è¡Œé¡ºåº</p><pre><code> --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,Priority,ResourceQuota,PodSecurityPolicy   </code></pre><p>Webhook Admission å±äºåŒæ­¥è°ƒç”¨ï¼Œéœ€è¦éƒ¨ç½²è‡ªå·±çš„ webhook serverï¼Œåˆ›å»ºè‡ªå®šä¹‰çš„é…ç½®èµ„æºå¯¹è±¡ï¼š ValidatingWebhookConfiguration æˆ– MutatingWebhookConfiguration</p><pre><code>[root@master ~]# kubectl api-resources | grep webhookmutatingwebhookconfigurations                  admissionregistration.k8s.io   false        MutatingWebhookConfigurationvalidatingwebhookconfigurations                admissionregistration.k8s.io   false        ValidatingWebhookConfiguration[root@master ~]# kubectl api-versions | grep admissionregistration.k8s.io/v1beta1admissionregistration.k8s.io/v1beta1</code></pre><p> <strong>éƒ¨ç½²</strong> </p><p> å®šä¹‰ ValidatingWebhookConfiguration æˆ–è€… MutatingWebhookConfiguration</p><pre><code>apiVersion: admissionregistration.k8s.io/v1beta1kind: MutatingWebhookConfigurationmetadata:  name: &lt;name&gt;  labels:    app: &lt;label&gt;webhooks:  - name: &lt;webhook name, e.g., pod-policy.example.io&gt;  é€—å·åˆ†å‰²ï¼Œé™åˆ¶å¿…é¡»ä¸‰æ®µ    clientConfig:      service:        namespace: &lt;namespace of the front-end service&gt;        name: &lt;name of the front-end service&gt;      caBundle: &lt;pem encoded ca cert that signs the server cert used by the webhook&gt;    rules:      - operations: [ "CREATE" ]        apiGroups: [""]        apiVersions: ["v1"]        resources: ["pods"]    namespaceSelector:      matchLabels:        &lt;key&gt;: &lt;value&gt;</code></pre><p><strong>åˆ›å»ºè‡ªå·±çš„ webhook ç¨‹åºæµç¨‹</strong></p><ul><li>åˆ›å»ºTLS Certificateï¼Œå³è¯ä¹¦</li><li>ç¼–å†™æœåŠ¡ç«¯ä»£ç ï¼ŒæœåŠ¡ç«¯ä»£ç éœ€è¦ä½¿ç”¨è¯ä¹¦</li><li>æ ¹æ®è¯ä¹¦åˆ›å»ºk8s sercret</li><li>åˆ›å»ºk8s Deploymentå’ŒService</li><li>åˆ›å»ºk8s WebhookConfigurationï¼Œå…¶ä¸­éœ€è¦ä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„è¯ä¹¦</li></ul><p><strong>å‡†å…¥æ§åˆ¶å™¨åˆ—è¡¨</strong></p><p>å‡†å…¥æ§åˆ¶å™¨æ˜¯å†™å…¥apiserveræºç çš„ï¼Œæ— æ³•åŠ¨æ€æ·»åŠ ã€‚å¯ä»¥é€šè¿‡<code>kube-apiserver -h | grep enable-admission-plugins</code>æŸ¥çœ‹æ”¯æŒçš„å‡†å…¥æ§åˆ¶å™¨ï¼Œä¹Ÿå¯ä»¥åœ¨githubä¸ŠæŸ¥çœ‹å‡†å…¥æ§åˆ¶å™¨åˆ—è¡¨ä»¥åŠå®ç°ç»†èŠ‚ï¼š<a href="https://github.com/kubernetes/kubernetes/tree/master/plugin/pkg/admissionã€‚" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/tree/master/plugin/pkg/admissionã€‚</a></p><p>ä»¥ä¸‹æ˜¯ç›®å‰æ”¯æŒçš„å‡†å…¥æ§åˆ¶å™¨ï¼š</p><ul><li>AlwaysAdmitï¼šå…¨éƒ¨å…è®¸ï¼Œç›¸å½“äºæ²¡æœ‰å‡†å…¥æ§åˆ¶å™¨ã€‚</li><li>AlwaysPull/images/2020ï¼šå¼ºåˆ¶ä¿®æ”¹æ¯ä¸€ä¸ªæ–°Podå¼ºåˆ¶æ‹‰å–é•œåƒã€‚</li><li>AlwaysDenyï¼šæ‹’ç»æ‰€æœ‰è¯·æ±‚ã€‚</li><li>DefaultStorageClassï¼šå¦‚æœPersistentVolumeClaimæ²¡æœ‰æŒ‡å®šStorageClassï¼Œåˆ™ä¸ºå…¶æ·»åŠ ä¸€ä¸ªé»˜è®¤çš„StorageClassã€‚</li><li>DefaultTolerationSecondsï¼šå¦‚æœPodæ²¡æœ‰è®¾ç½®tolerationï¼Œåˆ™é»˜è®¤è®¾ç½®å¯¹<code>notready:NoExecute</code>å’Œ<code>unreachable:NoExecute</code>çš„tolerationä¸º5åˆ†é’Ÿã€‚</li><li>DenyExecOnPrivilegedï¼šæ‹¦æˆªæ‰€æœ‰ç‰¹æƒçº§å®¹å™¨è¿è¡Œçš„å‘½ä»¤ã€‚è¯¥å‡†å…¥æ§åˆ¶å™¨å·²åˆå¹¶è‡³<code>DenyEscalatingExec</code>ï¼Œå¹¶å°†åœ¨1.18ç‰ˆæœ¬ç§»é™¤ã€‚</li><li>DenyEscalatingExecï¼šé˜»æ­¢å®¹å™¨è¿è¡Œææƒç±»å‘½ä»¤ï¼ŒåŒ…æ‹¬ç‰¹æƒçº§å®¹å™¨ï¼Œæˆ–è€…è¯´æœ‰ç€hostçš„IPCå‘½åç©ºé—´æˆ–PIDå‘½åç©ºé—´ã€‚</li><li>EventRateLimitï¼šæ§åˆ¶apiserveræ¥æ”¶äº‹ä»¶è¯·æ±‚çš„é€Ÿç‡ï¼Œä»¥ç¼“è§£è´Ÿè½½è¿‡å¤§çš„é—®é¢˜ã€‚</li><li>ExtendedResourceTolerationï¼šç”¨äºæœ‰æ‰©å±•ç±»èµ„æºçš„ä¸“ç”¨èŠ‚ç‚¹ï¼Œæ¯”å¦‚è¯´GPUï¼ŒFPGAã€‚å¦‚æœè¯·æ±‚éœ€è¦æ‰©å±•èµ„æºï¼Œåˆ™è‡ªåŠ¨ä¸ºå…¶æ·»åŠ tolerationä»¥å¸®åŠ©é€‰æ‹©èŠ‚ç‚¹ã€‚</li><li>ImagePolicyWebhookï¼šå…è®¸åç«¯çš„webhookåˆ¤æ–­é•œåƒæ‹‰å–ç­–ç•¥ï¼Œä¾‹å¦‚é…ç½®é•œåƒä»“åº“çš„å¯†é’¥ã€‚</li><li>LimitPodHardAntiAffinityTopologyï¼šæ‹’ç»æ‰€æœ‰åœ¨<code>requiredDuringSchedulingRequiredDuringExecution</code>ä¸­å®šä¹‰é™¤<code>kubernetes.io/hostname</code>ä¹‹å¤–çš„æ‹“æ‰‘å…³é”®å­—çš„Podã€‚</li><li>LimitRangerï¼šç¡®ä¿æ‰€æœ‰èµ„æºè¯·æ±‚ä¸ä¼šè¶…è¿‡ namespace çš„ LimitRangeã€‚</li><li>MutatingAdmissionWebhookï¼šè°ƒç”¨ä¸è¯·æ±‚åŒ¹é…çš„ä»»ä½•å˜æ›´ webhookã€‚</li><li>NamespaceAutoProvisionï¼šæ£€æŸ¥è¯·æ±‚å¼•ç”¨çš„å‘½åç©ºé—´ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»ºå‘½åç©ºé—´ã€‚</li><li>NamespaceExistsï¼šæ£€æŸ¥è¯·æ±‚å¼•ç”¨çš„å‘½åç©ºé—´ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ‹’ç»ã€‚</li><li>NamespaceLifecycleï¼šä¿è¯æ­£åœ¨ç»ˆæ­¢çš„å‘½åç©ºé—´æ— æ³•åˆ›å»ºå¯¹è±¡ï¼›æ‹’ç»å¼•ç”¨äº†ä¸å­˜åœ¨çš„å‘½åç©ºé—´çš„è¯·æ±‚ï¼›ä¿è¯æ— æ³•åˆ é™¤é»˜è®¤çš„ä¸‰ä¸ªå‘½åç©ºé—´ï¼š<code>default</code>ï¼Œ<code>kube-system</code>ï¼Œ<code>kube-public</code>ã€‚</li><li>NodeRestrictionï¼šé™åˆ¶äº†kubeletå¯ä»¥ä¿®æ”¹çš„Nodeå’ŒPodå¯¹è±¡ï¼Œå¾€å¾€ä¸æƒé™æˆäºˆçš„Nodeæ¨¡å¼é…åˆä½¿ç”¨ã€‚</li><li>OwnerReferencesPermissionEnforcementï¼šä¿æŠ¤å¯¹<code>metadata.ownerReferences</code>å¯¹è±¡çš„è®¿é—®ï¼Œä»¥ä¾¿åªæœ‰å¯¹è¯¥å¯¹è±¡å…·æœ‰â€œåˆ é™¤â€æƒé™çš„ç”¨æˆ·æ‰èƒ½å¯¹å…¶è¿›è¡Œæ›´æ”¹ã€‚</li><li>PersistentVolumeLabelï¼šå¦‚æœæ˜¯äº‘æœåŠ¡å•†å®šä¹‰çš„PVï¼Œåˆ™è‡ªåŠ¨ä¸ºå…¶æ·»åŠ ä¸Šregionå’Œzoneçš„æ ‡ç­¾ã€‚å·²å¼ƒç”¨ï¼Œä½¿ç”¨<code>cloud-controller-manager</code>ä»£æ›¿ã€‚</li><li>PodNodeSelectorï¼šé€šè¿‡è¯»å–å‘½åç©ºé—´æ³¨é‡Šå’Œå…¨å±€é…ç½®æ¥é™åˆ¶å¯åœ¨å‘½åç©ºé—´å†…ä½¿ç”¨çš„èŠ‚ç‚¹é€‰æ‹©å™¨ã€‚</li><li>PersistentVolumeClaimResizeï¼šéªŒè¯æ›´æ”¹PVCå¤§å°çš„è¯·æ±‚ã€‚</li><li>PodPresetï¼šå…è®¸åœ¨Podå¯åŠ¨æ—¶æ³¨å…¥ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ç¯å¢ƒå˜é‡ï¼Œsecretï¼Œvolumeç­‰ç­‰ï¼Œéœ€è¦å’Œpodpresetèµ„æºå¯¹è±¡é…åˆä½¿ç”¨ã€‚</li><li>PodSecurityPolicyï¼šåœ¨åˆ›å»ºå’Œä¿®æ”¹Podæ—¶ï¼Œæ ¹æ®è¯·æ±‚çš„å®‰å…¨ä¸Šä¸‹æ–‡å’Œå¯ç”¨çš„Podå®‰å…¨ç­–ç•¥ç¡®å®šæ˜¯å¦åº”è¯¥å…è®¸å®ƒã€‚</li><li>PodTolerationRestrictionï¼šéªŒè¯å®¹å™¨çš„å®¹å¿åº¦ä¸å…¶å‘½åç©ºé—´çš„å®¹å¿åº¦ä¹‹é—´æ˜¯å¦å­˜åœ¨å†²çªï¼Œå¹¶åœ¨å­˜åœ¨å†²çªæ—¶æ‹’ç»è¯¥å®¹å™¨è¯·æ±‚ã€‚</li><li>Priorityï¼šä½¿ç”¨priorityClassNameå­—æ®µå¹¶å¡«å……ä¼˜å…ˆçº§çš„æ•´æ•°å€¼ã€‚å¦‚æœæœªæ‰¾åˆ°ä¼˜å…ˆçº§ï¼Œåˆ™æ‹’ç»Podã€‚</li><li>ResourceQuotaï¼šç¡®ä¿è¯·æ±‚ä¸è¿ånamespaceä¸­çš„resourcequotaå¯¹è±¡ã€‚</li><li>SecurityContextDenyï¼šæ‹’ç»ä»»ä½•è¯•å›¾è®¾ç½®æŸäº›å‡çº§çš„SecurityContextå­—æ®µçš„podã€‚</li><li>ServiceAccountï¼šè‡ªåŠ¨åŒ–ServiceAccountè®¾ç½®ï¼ŒåŒ…æ‹¬ä¸ºPodå¡«å……serviceaccountå­—æ®µï¼Œä»¥åŠæŒ‚è½½secretã€‚</li><li>StorageObjectInUseProtectionï¼šä¸ºæ–°åˆ›å»ºçš„PVCæ·»åŠ <code>kubernetes.io/pvc-protection</code>å’Œ<code>kubernetes.io/pv-protection</code>å­—æ®µï¼Œé˜²æ­¢ç”¨æˆ·åœ¨ä½¿ç”¨PVæˆ–PVCæ—¶åˆ é™¤å®ƒä»¬ã€‚</li><li>ValidatingAdmissionWebhookï¼šè°ƒç”¨ä¸è¯·æ±‚åŒ¹é…çš„ä»»ä½•éªŒè¯webhookã€‚å¦‚æœä»»ä½•ä¸€ä¸ªwebhookæ‹’ç»è¯·æ±‚ï¼Œåˆ™è¯·æ±‚å¤±è´¥ã€‚</li></ul><p>ä»¥ä¸Šæ˜¯ç›®å‰apiserverå¯ä»¥ä½¿ç”¨çš„å‡†å…¥æ§åˆ¶å™¨ï¼Œæ›´è¯¦ç»†çš„å†…å®¹è¯·å‚è€ƒå®˜ç½‘ï¼š<a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-doã€‚" target="_blank" rel="noopener">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-doã€‚</a></p><p>å¦‚æœä»¥ä¸Šå‡†å…¥æ§åˆ¶å™¨æ— æ³•æ»¡è¶³éœ€è¦ï¼Œå¯ä»¥è‡ªå·±å®ç°å‡†å…¥æ§åˆ¶å™¨ï¼Œç„¶åç¼–è¯‘è¿›kube-apiserverç¨‹åºä¸­ã€‚</p><p><strong>å°ç»“</strong></p><ul><li>å‡†å…¥æ§åˆ¶å™¨æ˜¯è¯·æ±‚æŒä¹…åŒ–è‡³etcdä¹‹å‰çš„æ‹¦æˆªå™¨ï¼Œå¯ä»¥ä¿®æ”¹/æ‹¦æˆªè¯·æ±‚ã€‚</li><li>å¯ä»¥åœ¨apiserverå¯åŠ¨æ—¶ä¼ å…¥å…è®¸/æ‹’ç»çš„å‡†å…¥æ§åˆ¶å™¨ã€‚</li><li>apiserveræä¾›äº†ä¸€ç³»åˆ—å†…ç½®çš„å‡†å…¥æ§åˆ¶å™¨ï¼Œå¦‚æ— æ³•æ»¡è¶³éœ€æ±‚ä¹Ÿå¯è‡ªå·±å®ç°ã€‚</li></ul><h5 id="æ³¨å†Œæ’ä»¶"><a href="#æ³¨å†Œæ’ä»¶" class="headerlink" title="æ³¨å†Œæ’ä»¶"></a>æ³¨å†Œæ’ä»¶</h5><p><strong>è°ƒç”¨é“¾</strong></p><pre><code>app.NewAPIServerCommand() -&gt; options.NewServerRunOptions() -&gt; kubeoptions.NewAdmissionOptions() -&gt; genericoptions.NewAdmissionOptions() -&gt;RegisterAllAdmissionPlugins(options.Plugins)</code></pre><p>æ³¨å†Œ</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">RegisterAllAdmissionPlugins</span><span class="token punctuation">(</span>plugins <span class="token operator">*</span>admission<span class="token punctuation">.</span>Plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>    admit<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// DEPRECATED as no real meaning</span>    alwayspull<span class="token operator">/</span>images<span class="token operator">/</span><span class="token number">2020</span><span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    antiaffinity<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    defaulttolerationseconds<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    defaultingressclass<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    deny<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// DEPRECATED as no real meaning</span>    eventratelimit<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    exec<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    extendedresourcetoleration<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    gc<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    imagepolicy<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    limitranger<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    autoprovision<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    exists<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    noderestriction<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    nodetaint<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    label<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// DEPRECATED, future PVs should not rely on labels for zone topology</span>    podnodeselector<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    podpreset<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    podtolerationrestriction<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    runtimeclass<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    resourcequota<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    podsecuritypolicy<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    podpriority<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    scdeny<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    serviceaccount<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    setdefault<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    resize<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    storageobjectinuseprotection<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    certapproval<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    certsigning<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>    certsubjectrestriction<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h5 id="åˆå§‹åŒ–æ’ä»¶"><a href="#åˆå§‹åŒ–æ’ä»¶" class="headerlink" title="åˆå§‹åŒ–æ’ä»¶"></a>åˆå§‹åŒ–æ’ä»¶</h5><p>è°ƒç”¨é“¾ï¼š</p><pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run() -&gt; CreateServerChain() -&gt; CreateKubeAPIServerConfig() -&gt; buildGenericConfig() -&gt; s.Admission.ApplyTo() -&gt;a.GenericAdmission.ApplyTo() -&gt; a.Plugins.NewFromPlugins()-&gt;ps.InitPlugin()</code></pre><p><strong>buildGenericConfig</strong></p><p>Config ç»“æ„ä¸»è¦ç”¨æ¥åˆå§‹åŒ– admission æ’ä»¶ï¼Œè·¯å¾„å®ç° <code>pkg/kubeapiserver/admission/config.go</code></p><pre class=" language-go"><code class="language-go">admissionConfig <span class="token operator">:=</span> <span class="token operator">&amp;</span>kubeapiserveradmission<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>    ExternalInformers<span class="token punctuation">:</span>    versionedInformers<span class="token punctuation">,</span>    LoopbackClientConfig<span class="token punctuation">:</span> genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">,</span>    CloudConfigFile<span class="token punctuation">:</span>      s<span class="token punctuation">.</span>CloudProvider<span class="token punctuation">.</span>CloudConfigFile<span class="token punctuation">,</span><span class="token punctuation">}</span></code></pre><p> admissionConfig.New å‡½æ•°ä¸»è¦ç”¨æ¥ä¸º admission å»ºç«‹æ’ä»¶ä»¥åŠ start hook</p><pre class=" language-go"><code class="language-go">pluginInitializers<span class="token punctuation">,</span> admissionPostStartHook<span class="token punctuation">,</span> err <span class="token operator">=</span> admissionConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>proxyTransport<span class="token punctuation">,</span> serviceResolver<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>    lastErr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create admission plugin initializer: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>    <span class="token keyword">return</span><span class="token punctuation">}</span></code></pre><p><strong>New</strong></p><p> NewPluginInitializer å®ä¾‹åŒ– PluginInitializerï¼Œè¿™ä¸ªç»“æ„ç”¨æ¥åˆå§‹åŒ– admission plugin</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// New sets up the plugins and admission start hooks needed for admission</span><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Config<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span>proxyTransport <span class="token operator">*</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">,</span> serviceResolver webhook<span class="token punctuation">.</span>ServiceResolver<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">,</span> server<span class="token punctuation">.</span>PostStartHookFunc<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    webhookAuthResolverWrapper <span class="token operator">:=</span> webhook<span class="token punctuation">.</span><span class="token function">NewDefaultAuthenticationInfoResolverWrapper</span><span class="token punctuation">(</span>proxyTransport<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span>    webhookPluginInitializer <span class="token operator">:=</span> webhookinit<span class="token punctuation">.</span><span class="token function">NewPluginInitializer</span><span class="token punctuation">(</span>webhookAuthResolverWrapper<span class="token punctuation">,</span> serviceResolver<span class="token punctuation">)</span>    <span class="token keyword">var</span> cloudConfig <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>    <span class="token keyword">if</span> c<span class="token punctuation">.</span>CloudConfigFile <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> err <span class="token builtin">error</span>        cloudConfig<span class="token punctuation">,</span> err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>CloudConfigFile<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Error reading from cloud configuration file %s: %#v"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>CloudConfigFile<span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    internalClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> internalclientset<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span></code></pre><p><strong>NewPluginInitializer å®ä¾‹åŒ– PluginInitializer</strong></p><p>å…·ä½“å®ç°è·¯å¾„ä¸º <code>pkg/kubeapiserver/admission/initializer.go</code></p><pre class=" language-go"><code class="language-go">discoveryClient <span class="token operator">:=</span> cacheddiscovery<span class="token punctuation">.</span><span class="token function">NewMemCacheClient</span><span class="token punctuation">(</span>internalClient<span class="token punctuation">.</span><span class="token function">Discovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>discoveryRESTMapper <span class="token operator">:=</span> restmapper<span class="token punctuation">.</span><span class="token function">NewDeferredDiscoveryRESTMapper</span><span class="token punctuation">(</span>discoveryClient<span class="token punctuation">)</span>kubePluginInitializer <span class="token operator">:=</span> <span class="token function">NewPluginInitializer</span><span class="token punctuation">(</span>    cloudConfig<span class="token punctuation">,</span>    discoveryRESTMapper<span class="token punctuation">,</span>    quotainstall<span class="token punctuation">.</span><span class="token function">NewQuotaConfigurationForAdmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span></code></pre><p><strong>admissionPostStartHook å‡½æ•°æ˜¯é‡ç½® cache æ“ä½œ</strong></p><pre class=" language-go"><code class="language-go">admissionPostStartHook <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context genericapiserver<span class="token punctuation">.</span>PostStartHookContext<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    discoveryRESTMapper<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">go</span> utilwait<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>discoveryRESTMapper<span class="token punctuation">.</span>Reset<span class="token punctuation">,</span> <span class="token number">30</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> context<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">{</span>webhookPluginInitializer<span class="token punctuation">,</span> kubePluginInitializer<span class="token punctuation">}</span><span class="token punctuation">,</span> admissionPostStartHook<span class="token punctuation">,</span> <span class="token boolean">nil</span></code></pre><p><strong>ApplyTo</strong></p><p> è·¯å¾„ <code>k8s.io/apiserver/pkg/server/options/admission.go</code></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ApplyTo adds the admission chain to the server configuration.</span><span class="token comment" spellcheck="true">// In case admission plugin names were not provided by a custer-admin they will be prepared from the recommended/default values.</span><span class="token comment" spellcheck="true">// In addition the method lazily initializes a generic plugin that is appended to the list of pluginInitializers</span><span class="token comment" spellcheck="true">// note this method uses:</span><span class="token comment" spellcheck="true">//  genericconfig.Authorizer</span><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>AdmissionOptions<span class="token punctuation">)</span> <span class="token function">ApplyTo</span><span class="token punctuation">(</span>    c <span class="token operator">*</span>server<span class="token punctuation">.</span>Config<span class="token punctuation">,</span>    informers informers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">,</span>    kubeAPIServerClientConfig <span class="token operator">*</span>rest<span class="token punctuation">.</span>Config<span class="token punctuation">,</span>    pluginInitializers <span class="token operator">...</span>admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> a <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span></code></pre><p><strong>NewFromPlugins</strong></p><p>InitPlugin ä¸»è¦å¯¹æ’ä»¶è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œåˆ†åˆ«è°ƒç”¨ Initialize åˆå§‹åŒ–ï¼Œåœ¨è°ƒç”¨ ValidateInitialization éªŒè¯æ˜¯å¦å®ç°äº†æ¥å£æ–¹æ³• ValidateInitialization</p><p>æœ€ååŒ…è£¹ handlersï¼ŒchainAdmissionHandler åŒ…å«äº†æ’ä»¶çš„ handlerï¼Œå®ç°äº† Admit å’Œ Validate æ–¹æ³•ï¼Œå°±æ˜¯å¯¹æ‰€æœ‰æ’ä»¶ handler è°ƒç”¨ Admit å’Œ Validate æ–¹æ³•</p><pre><code>func (admissionHandler chainAdmissionHandler) Admit(a Attributes, o ObjectInterfaces) errorfunc (admissionHandler chainAdmissionHandler) Validate(a Attributes, o ObjectInterfaces) error</code></pre><pre><code>// NewFromPlugins returns an admission.Interface that will enforce admission control decisions of all// the given plugins.func (ps *Plugins) NewFromPlugins(pluginNames []string, configProvider ConfigProvider, pluginInitializer PluginInitializer, decorator Decorator) (Interface, error) {    handlers := []Interface{}    mutationPlugins := []string{}    validationPlugins := []string{}    for _, pluginName := range pluginNames {        pluginConfig, err := configProvider.ConfigFor(pluginName)        if err != nil {            return nil, err        }        plugin, err := ps.InitPlugin(pluginName, pluginConfig, pluginInitializer)        if err != nil {            return nil, err        }    return chainAdmissionHandler(handlers), nil}</code></pre><p><strong>èµ‹å€¼ AdmissionControl</strong></p><p>å…·ä½“æ“ä½œå°±æ˜¯åˆåŒ…è£¹äº†ä¸€ä¸‹ pluginHandlerWithMetrics</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// WithStepMetrics is a decorator for a whole admission phase, i.e. admit or validation.admission step.</span><span class="token keyword">func</span> <span class="token function">WithStepMetrics</span><span class="token punctuation">(</span>i admission<span class="token punctuation">.</span>Interface<span class="token punctuation">)</span> admission<span class="token punctuation">.</span>Interface <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">WithMetrics</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> Metrics<span class="token punctuation">.</span>ObserveAdmissionStep<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// WithMetrics is a decorator for admission handlers with a generic observer func.</span><span class="token keyword">func</span> <span class="token function">WithMetrics</span><span class="token punctuation">(</span>i admission<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> observer ObserverFunc<span class="token punctuation">,</span> extraLabels <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> admission<span class="token punctuation">.</span>Interface <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>pluginHandlerWithMetrics<span class="token punctuation">{</span>        Interface<span class="token punctuation">:</span>   i<span class="token punctuation">,</span>        observer<span class="token punctuation">:</span>    observer<span class="token punctuation">,</span>        extraLabels<span class="token punctuation">:</span> extraLabels<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h5 id="ä½¿ç”¨æ’ä»¶"><a href="#ä½¿ç”¨æ’ä»¶" class="headerlink" title="ä½¿ç”¨æ’ä»¶"></a>ä½¿ç”¨æ’ä»¶</h5><p>è°ƒç”¨é“¾ï¼š</p><pre><code>main() -&gt; app.NewAPIServerCommand() -&gt; Run() -&gt; CreateServerChain() -&gt; createAggregatorServer()-&gt;NewWithDelegate()-&gt;InstallAPIGroups()-&gt;installAPIResources()-&gt;InstallREST()-&gt;Install()-&gt;registerResourceHandlers()-&gt;metrics.InstrumentRouteFunc()-&gt;        --&gt;  restfulUpdateResource               PUT        --&gt;  restfulPatchResource                PATCH        --&gt;  restfulCreateNamedResource          POST        --&gt;  restfulCreateResource               POST        --&gt;  restfulDeleteResource               DELETE        --&gt;  restfulDeleteCollection             DELETECOLLECTION        --&gt;  restfulConnectResource              CONNECT </code></pre><p><strong>registerResourceHandlers</strong></p><p> å¯ä»¥å¾—åˆ° PUT PATCH POST DELETE DELETECOLLECTION CONNECT è¿™äº› method ç”¨åˆ°äº† admission </p><pre class=" language-go"><code class="language-go"><span class="token keyword">switch</span> action<span class="token punctuation">.</span>Verb <span class="token punctuation">{</span><span class="token keyword">case</span> <span class="token string">"PUT"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Update a resource.</span>    doc <span class="token operator">:=</span> <span class="token string">"replace the specified "</span> <span class="token operator">+</span> kind    <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>        doc <span class="token operator">=</span> <span class="token string">"replace "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of the specified "</span> <span class="token operator">+</span> kind    <span class="token punctuation">}</span>    handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulUpdateResource</span><span class="token punctuation">(</span>updater<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">case</span> <span class="token string">"PATCH"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Partially update a resource</span>    handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulPatchResource</span><span class="token punctuation">(</span>patcher<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">,</span> supportedTypes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">case</span> <span class="token string">"POST"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Create a resource.</span>    <span class="token keyword">var</span> handler restful<span class="token punctuation">.</span>RouteFunction    <span class="token keyword">if</span> isNamedCreater <span class="token punctuation">{</span>        handler <span class="token operator">=</span> <span class="token function">restfulCreateNamedResource</span><span class="token punctuation">(</span>namedCreater<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        handler <span class="token operator">=</span> <span class="token function">restfulCreateResource</span><span class="token punctuation">(</span>creater<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    handler <span class="token operator">=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token keyword">case</span> <span class="token string">"DELETE"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Delete a resource.</span>    handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulDeleteResource</span><span class="token punctuation">(</span>gracefulDeleter<span class="token punctuation">,</span> isGracefulDeleter<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">case</span> <span class="token string">"DELETECOLLECTION"</span><span class="token punctuation">:</span>    handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulDeleteCollection</span><span class="token punctuation">(</span>collectionDeleter<span class="token punctuation">,</span> isCollectionDeleter<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">case</span> <span class="token string">"CONNECT"</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> method <span class="token operator">:=</span> <span class="token keyword">range</span> connecter<span class="token punctuation">.</span><span class="token function">ConnectMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulConnectResource</span><span class="token punctuation">(</span>connecter<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">,</span> path<span class="token punctuation">,</span> isSubresource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h3 id="API-server-è·¯ç”±"><a href="#API-server-è·¯ç”±" class="headerlink" title="API server è·¯ç”±"></a>API server è·¯ç”±</h3><h4 id="emicklei-go-restful"><a href="#emicklei-go-restful" class="headerlink" title="emicklei/go-restful"></a>emicklei/go-restful</h4><p>Kubernetesä½¿ç”¨emicklei/go-restfulåŒ…æä¾›RESTful APIæœåŠ¡ã€‚æ‰€ä»¥æœ‰å¿…è¦å…ˆæ¥äº†è§£ä¸‹emicklei/go-restfulæ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚</p><ol><li>åˆ›å»ºcontainer</li><li>åˆ›å»ºws</li><li>ç”Ÿæˆrouteï¼Œå³ws.GET(â€œ/helloâ€).To(hello)</li><li>ws.Route(route)</li><li>container.Add(ws)</li><li>http.Server{}</li></ol><p>å³å¦‚ä¸‹ä»£ç å½¢å¼ï¼š</p><pre class=" language-go"><code class="language-go">container <span class="token operator">:=</span> restful<span class="token punctuation">.</span><span class="token function">NewContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ws <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>restful<span class="token punctuation">.</span>WebService<span class="token punctuation">)</span>ws<span class="token punctuation">.</span><span class="token function">Route</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>hello<span class="token punctuation">)</span><span class="token punctuation">)</span>container<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span>server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">":8081"</span><span class="token punctuation">,</span> Handler<span class="token punctuation">:</span> container<span class="token punctuation">}</span>log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">hello</span><span class="token punctuation">(</span>req <span class="token operator">*</span>restful<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> resp <span class="token operator">*</span>restful<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>    io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> <span class="token string">"default world"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="containerçš„ç”Ÿæˆ"><a href="#containerçš„ç”Ÿæˆ" class="headerlink" title="containerçš„ç”Ÿæˆ"></a>containerçš„ç”Ÿæˆ</h4><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å¯»æ‰¾åœ¨å“ªç”Ÿæˆçš„containerã€‚containerçš„ç”Ÿæˆå‡½æ•°å®šä¹‰:</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewAPIServerHandler</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> s runtime<span class="token punctuation">.</span>NegotiatedSerializer<span class="token punctuation">,</span> handlerChainBuilder HandlerChainBuilderFn<span class="token punctuation">,</span> notFoundHandler http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> <span class="token operator">*</span>APIServerHandler <span class="token punctuation">{</span>    nonGoRestfulMux <span class="token operator">:=</span> mux<span class="token punctuation">.</span><span class="token function">NewPathRecorderMux</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>    <span class="token keyword">if</span> notFoundHandler <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        nonGoRestfulMux<span class="token punctuation">.</span><span class="token function">NotFoundHandler</span><span class="token punctuation">(</span>notFoundHandler<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    gorestfulContainer <span class="token operator">:=</span> restful<span class="token punctuation">.</span><span class="token function">NewContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    gorestfulContainer<span class="token punctuation">.</span>ServeMux <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    gorestfulContainer<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span>restful<span class="token punctuation">.</span>CurlyRouter<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// e.g. for proxy/{kind}/{name}/{*}</span>    gorestfulContainer<span class="token punctuation">.</span><span class="token function">RecoverHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>panicReason <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> httpWriter http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">logStackOnRecover</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> panicReason<span class="token punctuation">,</span> httpWriter<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    gorestfulContainer<span class="token punctuation">.</span><span class="token function">ServiceErrorHandler</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>serviceErr restful<span class="token punctuation">.</span>ServiceError<span class="token punctuation">,</span> request <span class="token operator">*</span>restful<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> response <span class="token operator">*</span>restful<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">serviceErrorHandler</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> serviceErr<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    director <span class="token operator">:=</span> director<span class="token punctuation">{</span>        name<span class="token punctuation">:</span>               name<span class="token punctuation">,</span>        goRestfulContainer<span class="token punctuation">:</span> gorestfulContainer<span class="token punctuation">,</span>        nonGoRestfulMux<span class="token punctuation">:</span>    nonGoRestfulMux<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>APIServerHandler<span class="token punctuation">{</span>        FullHandlerChain<span class="token punctuation">:</span>   <span class="token function">handlerChainBuilder</span><span class="token punctuation">(</span>director<span class="token punctuation">)</span><span class="token punctuation">,</span>        GoRestfulContainer<span class="token punctuation">:</span> gorestfulContainer<span class="token punctuation">,</span>        NonGoRestfulMux<span class="token punctuation">:</span>    nonGoRestfulMux<span class="token punctuation">,</span>        Director<span class="token punctuation">:</span>           director<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// NewContainer creates a new Container using a new ServeMux and default router (CurlyRouter)</span><span class="token keyword">func</span> <span class="token function">NewContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Container <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Container<span class="token punctuation">{</span>        webServices<span class="token punctuation">:</span>            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>WebService<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        ServeMux<span class="token punctuation">:</span>               http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        isRegisteredOnRoot<span class="token punctuation">:</span>     <span class="token boolean">false</span><span class="token punctuation">,</span>        containerFilters<span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token punctuation">]</span>FilterFunction<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        doNotRecover<span class="token punctuation">:</span>           <span class="token boolean">true</span><span class="token punctuation">,</span>        recoverHandleFunc<span class="token punctuation">:</span>      logStackOnRecover<span class="token punctuation">,</span>        serviceErrorHandleFunc<span class="token punctuation">:</span> writeServiceError<span class="token punctuation">,</span>        router<span class="token punctuation">:</span>                 CurlyRouter<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        contentEncodingEnabled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="APIå®‰è£…å…¥å£"><a href="#APIå®‰è£…å…¥å£" class="headerlink" title="APIå®‰è£…å…¥å£"></a>APIå®‰è£…å…¥å£</h4><pre class=" language-java"><code class="language-java">    m <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">&amp;</span>Master<span class="token punctuation">{</span>        GenericAPIServer<span class="token operator">:</span>          s<span class="token punctuation">,</span>        ClusterAuthenticationInfo<span class="token operator">:</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>ClusterAuthenticationInfo<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// install legacy rest storage</span>    <span class="token keyword">if</span> c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">.</span><span class="token function">VersionEnabled</span><span class="token punctuation">(</span>apiv1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">if</span> err <span class="token operator">:</span><span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">InstallLegacyAPI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> legacyRESTStorageProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{</span>            <span class="token keyword">return</span> nil<span class="token punctuation">,</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> err <span class="token operator">:</span><span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">InstallAPIs</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> restStorageProviders<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{</span>        <span class="token keyword">return</span> nil<span class="token punctuation">,</span> err    <span class="token punctuation">}</span></code></pre><p>å‰é¢å·²ç»åˆ†æè¿‡äº†ã€‚ </p><h4 id="Containerçš„å¯åŠ¨"><a href="#Containerçš„å¯åŠ¨" class="headerlink" title="Containerçš„å¯åŠ¨"></a>Containerçš„å¯åŠ¨</h4><p>Containerå³GenericAPIServerä¸­çš„Handlerã€‚GenericAPIServerçš„Run()æ–¹æ³•ä¸­ä¼šå¯åŠ¨ç›‘å¬ã€‚</p><h4 id="resthandler"><a href="#resthandler" class="headerlink" title="resthandler"></a>resthandler</h4><p>ä¹‹å‰å·²ç»åˆ†æåˆ°ï¼ŒKubernetesæ˜¯å¦‚ä½•æ³¨å†ŒAPIçš„ã€‚Kubernetesä¼šæŠŠå¯¹åº”è·¯å¾„ä¸Šçš„è¯·æ±‚äº¤ç»™å¯¹åº”çš„resthandlerå¤„ç†ã€‚æ‰€ä»¥ï¼Œresthandleræ˜¯å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†å¹¶å“åº”çš„å‡½æ•°ã€‚åœ¨Kubernetesä¸­ï¼Œç»™æ¯ä¸€ç§åŠ¨ä½œè®¾ç½®äº†å¯¹åº”çš„resthandlerï¼Œå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤º(åªåˆ—å‡ºäº†ä¸»è¦éƒ¨åˆ†)ï¼š</p><table><thead><tr><th>åŠ¨ä½œ</th><th>å‡½æ•°</th></tr></thead><tbody><tr><td>GET</td><td>GetResource</td></tr><tr><td>LIST</td><td>ListResource</td></tr><tr><td>PUT</td><td>UpdateResource</td></tr><tr><td>PATCH</td><td>PatchResource</td></tr><tr><td>POST</td><td>CreateResource</td></tr><tr><td>DELETE</td><td>DeleteResource</td></tr><tr><td>WATCH</td><td>ListResource</td></tr></tbody></table><p>è°ƒç”¨è·¯å¾„ï¼š</p><pre><code>master.goInstallLegacyAPI()-&gt; InstallLegacyAPIGroup()-&gt; installAPIResources()-&gt; InstallREST()-&gt; Install()-&gt; registerResourceHandlers()</code></pre><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>APIInstaller<span class="token punctuation">)</span> <span class="token function">registerResourceHandlers</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> storage rest<span class="token punctuation">.</span>Storage<span class="token punctuation">,</span> ws <span class="token operator">*</span>restful<span class="token punctuation">.</span>WebService<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>metav1<span class="token punctuation">.</span>APIResource<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    admit <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Admit    optionsExternalVersion <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion    <span class="token keyword">if</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>OptionsExternalVersion <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        optionsExternalVersion <span class="token operator">=</span> <span class="token operator">*</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>OptionsExternalVersion    <span class="token punctuation">}</span>    resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">splitSubresource</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    group<span class="token punctuation">,</span> version <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span>Group<span class="token punctuation">,</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span>Version    fqKindToRegister<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">GetResourceKind</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">,</span> storage<span class="token punctuation">,</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    versionedPtr<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fqKindToRegister<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    defaultVersionedObject <span class="token operator">:=</span> <span class="token function">indirectArbitraryPointer</span><span class="token punctuation">(</span>versionedPtr<span class="token punctuation">)</span>    kind <span class="token operator">:=</span> fqKindToRegister<span class="token punctuation">.</span>Kind    isSubresource <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span>    <span class="token comment" spellcheck="true">// If there is a subresource, namespace scoping is defined by the parent resource</span>    namespaceScoped <span class="token operator">:=</span> <span class="token boolean">true</span>    <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>        parentStorage<span class="token punctuation">,</span> ok <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Storage<span class="token punctuation">[</span>resource<span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"missing parent storage: %q"</span><span class="token punctuation">,</span> resource<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        scoper<span class="token punctuation">,</span> ok <span class="token operator">:=</span> parentStorage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Scoper<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%q must implement scoper"</span><span class="token punctuation">,</span> resource<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        namespaceScoped <span class="token operator">=</span> scoper<span class="token punctuation">.</span><span class="token function">NamespaceScoped</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        scoper<span class="token punctuation">,</span> ok <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Scoper<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%q must implement scoper"</span><span class="token punctuation">,</span> resource<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        namespaceScoped <span class="token operator">=</span> scoper<span class="token punctuation">.</span><span class="token function">NamespaceScoped</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// what verbs are supported by the storage, used to know what verbs we support per path</span>    creater<span class="token punctuation">,</span> isCreater <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Creater<span class="token punctuation">)</span>    namedCreater<span class="token punctuation">,</span> isNamedCreater <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>NamedCreater<span class="token punctuation">)</span>    lister<span class="token punctuation">,</span> isLister <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Lister<span class="token punctuation">)</span>    getter<span class="token punctuation">,</span> isGetter <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Getter<span class="token punctuation">)</span>    getterWithOptions<span class="token punctuation">,</span> isGetterWithOptions <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>GetterWithOptions<span class="token punctuation">)</span>    gracefulDeleter<span class="token punctuation">,</span> isGracefulDeleter <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>GracefulDeleter<span class="token punctuation">)</span>    collectionDeleter<span class="token punctuation">,</span> isCollectionDeleter <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>CollectionDeleter<span class="token punctuation">)</span>    updater<span class="token punctuation">,</span> isUpdater <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Updater<span class="token punctuation">)</span>    patcher<span class="token punctuation">,</span> isPatcher <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Patcher<span class="token punctuation">)</span>    watcher<span class="token punctuation">,</span> isWatcher <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Watcher<span class="token punctuation">)</span>    connecter<span class="token punctuation">,</span> isConnecter <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Connecter<span class="token punctuation">)</span>    storageMeta<span class="token punctuation">,</span> isMetadata <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>StorageMetadata<span class="token punctuation">)</span>    storageVersionProvider<span class="token punctuation">,</span> isStorageVersionProvider <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>StorageVersionProvider<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">!</span>isMetadata <span class="token punctuation">{</span>        storageMeta <span class="token operator">=</span> defaultStorageMetadata<span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    exporter<span class="token punctuation">,</span> isExporter <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>Exporter<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">!</span>isExporter <span class="token punctuation">{</span>        exporter <span class="token operator">=</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    versionedExportOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"ExportOptions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> isNamedCreater <span class="token punctuation">{</span>        isCreater <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> versionedList <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">if</span> isLister <span class="token punctuation">{</span>        list <span class="token operator">:=</span> lister<span class="token punctuation">.</span><span class="token function">NewList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        listGVKs<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">.</span><span class="token function">ObjectKinds</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        versionedListPtr<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>listGVKs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Kind<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        versionedList <span class="token operator">=</span> <span class="token function">indirectArbitraryPointer</span><span class="token punctuation">(</span>versionedListPtr<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    versionedListOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"ListOptions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    versionedCreateOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"CreateOptions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    versionedPatchOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"PatchOptions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    versionedUpdateOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"UpdateOptions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">var</span> versionedDeleteOptions runtime<span class="token punctuation">.</span>Object    <span class="token keyword">var</span> versionedDeleterObject <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    deleteReturnsDeletedObject <span class="token operator">:=</span> <span class="token boolean">false</span>    <span class="token keyword">if</span> isGracefulDeleter <span class="token punctuation">{</span>        versionedDeleteOptions<span class="token punctuation">,</span> err <span class="token operator">=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"DeleteOptions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        versionedDeleterObject <span class="token operator">=</span> <span class="token function">indirectArbitraryPointer</span><span class="token punctuation">(</span>versionedDeleteOptions<span class="token punctuation">)</span>        <span class="token keyword">if</span> mayReturnFullObjectDeleter<span class="token punctuation">,</span> ok <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>MayReturnFullObjectDeleter<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>            deleteReturnsDeletedObject <span class="token operator">=</span> mayReturnFullObjectDeleter<span class="token punctuation">.</span><span class="token function">DeleteReturnsDeletedObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    versionedStatusPtr<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"Status"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    versionedStatus <span class="token operator">:=</span> <span class="token function">indirectArbitraryPointer</span><span class="token punctuation">(</span>versionedStatusPtr<span class="token punctuation">)</span>    <span class="token keyword">var</span> <span class="token punctuation">(</span>        getOptions             runtime<span class="token punctuation">.</span>Object        versionedGetOptions    runtime<span class="token punctuation">.</span>Object        getOptionsInternalKind schema<span class="token punctuation">.</span>GroupVersionKind        getSubpath             <span class="token builtin">bool</span>    <span class="token punctuation">)</span>    <span class="token keyword">if</span> isGetterWithOptions <span class="token punctuation">{</span>        getOptions<span class="token punctuation">,</span> getSubpath<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> getterWithOptions<span class="token punctuation">.</span><span class="token function">NewGetOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        getOptionsInternalKinds<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">.</span><span class="token function">ObjectKinds</span><span class="token punctuation">(</span>getOptions<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        getOptionsInternalKind <span class="token operator">=</span> getOptionsInternalKinds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        versionedGetOptions<span class="token punctuation">,</span> err <span class="token operator">=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>getOptionsInternalKind<span class="token punctuation">.</span>Kind<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            versionedGetOptions<span class="token punctuation">,</span> err <span class="token operator">=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>getOptionsInternalKind<span class="token punctuation">.</span>Kind<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        isGetter <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> versionedWatchEvent <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">if</span> isWatcher <span class="token punctuation">{</span>        versionedWatchEventPtr<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span><span class="token string">"WatchEvent"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        versionedWatchEvent <span class="token operator">=</span> <span class="token function">indirectArbitraryPointer</span><span class="token punctuation">(</span>versionedWatchEventPtr<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> <span class="token punctuation">(</span>        connectOptions             runtime<span class="token punctuation">.</span>Object        versionedConnectOptions    runtime<span class="token punctuation">.</span>Object        connectOptionsInternalKind schema<span class="token punctuation">.</span>GroupVersionKind        connectSubpath             <span class="token builtin">bool</span>    <span class="token punctuation">)</span>    <span class="token keyword">if</span> isConnecter <span class="token punctuation">{</span>        connectOptions<span class="token punctuation">,</span> connectSubpath<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> connecter<span class="token punctuation">.</span><span class="token function">NewConnectOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> connectOptions <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            connectOptionsInternalKinds<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">.</span><span class="token function">ObjectKinds</span><span class="token punctuation">(</span>connectOptions<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            connectOptionsInternalKind <span class="token operator">=</span> connectOptionsInternalKinds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            versionedConnectOptions<span class="token punctuation">,</span> err <span class="token operator">=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>connectOptionsInternalKind<span class="token punctuation">.</span>Kind<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                versionedConnectOptions<span class="token punctuation">,</span> err <span class="token operator">=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>optionsExternalVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>connectOptionsInternalKind<span class="token punctuation">.</span>Kind<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    allowWatchList <span class="token operator">:=</span> isWatcher <span class="token operator">&amp;&amp;</span> isLister <span class="token comment" spellcheck="true">// watching on lists is allowed only for kinds that support both watch and list.</span>    nameParam <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">PathParameter</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"name of the "</span><span class="token operator">+</span>kind<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DataType</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">)</span>    pathParam <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">PathParameter</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">,</span> <span class="token string">"path to the resource"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DataType</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">)</span>    params <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>restful<span class="token punctuation">.</span>Parameter<span class="token punctuation">{</span><span class="token punctuation">}</span>    actions <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>action<span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">var</span> resourceKind <span class="token builtin">string</span>    kindProvider<span class="token punctuation">,</span> ok <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>KindProvider<span class="token punctuation">)</span>    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>        resourceKind <span class="token operator">=</span> kindProvider<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        resourceKind <span class="token operator">=</span> kind    <span class="token punctuation">}</span>    tableProvider<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>TableConvertor<span class="token punctuation">)</span>    <span class="token keyword">var</span> apiResource metav1<span class="token punctuation">.</span>APIResource    <span class="token keyword">if</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>StorageVersionHash<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        isStorageVersionProvider <span class="token operator">&amp;&amp;</span>        storageVersionProvider<span class="token punctuation">.</span><span class="token function">StorageVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        versioner <span class="token operator">:=</span> storageVersionProvider<span class="token punctuation">.</span><span class="token function">StorageVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        gvk<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getStorageVersionKind</span><span class="token punctuation">(</span>versioner<span class="token punctuation">,</span> storage<span class="token punctuation">,</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        apiResource<span class="token punctuation">.</span>StorageVersionHash <span class="token operator">=</span> discovery<span class="token punctuation">.</span><span class="token function">StorageVersionHash</span><span class="token punctuation">(</span>gvk<span class="token punctuation">.</span>Group<span class="token punctuation">,</span> gvk<span class="token punctuation">.</span>Version<span class="token punctuation">,</span> gvk<span class="token punctuation">.</span>Kind<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Get the list of actions for the given scope.</span>    <span class="token keyword">switch</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token operator">!</span>namespaceScoped<span class="token punctuation">:</span>        <span class="token comment" spellcheck="true">// Handle non-namespace scoped resources like nodes.</span>        resourcePath <span class="token operator">:=</span> resource        resourceParams <span class="token operator">:=</span> params        itemPath <span class="token operator">:=</span> resourcePath <span class="token operator">+</span> <span class="token string">"/{name}"</span>        nameParams <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> nameParam<span class="token punctuation">)</span>        proxyParams <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>nameParams<span class="token punctuation">,</span> pathParam<span class="token punctuation">)</span>        suffix <span class="token operator">:=</span> <span class="token string">""</span>        <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>            suffix <span class="token operator">=</span> <span class="token string">"/"</span> <span class="token operator">+</span> subresource            itemPath <span class="token operator">=</span> itemPath <span class="token operator">+</span> suffix            resourcePath <span class="token operator">=</span> itemPath            resourceParams <span class="token operator">=</span> nameParams        <span class="token punctuation">}</span>        apiResource<span class="token punctuation">.</span>Name <span class="token operator">=</span> path        apiResource<span class="token punctuation">.</span>Namespaced <span class="token operator">=</span> <span class="token boolean">false</span>        apiResource<span class="token punctuation">.</span>Kind <span class="token operator">=</span> resourceKind        namer <span class="token operator">:=</span> handlers<span class="token punctuation">.</span>ContextBasedNaming<span class="token punctuation">{</span>            SelfLinker<span class="token punctuation">:</span>         a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Linker<span class="token punctuation">,</span>            ClusterScoped<span class="token punctuation">:</span>      <span class="token boolean">true</span><span class="token punctuation">,</span>            SelfLinkPathPrefix<span class="token punctuation">:</span> gpath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>prefix<span class="token punctuation">,</span> resource<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span><span class="token punctuation">,</span>            SelfLinkPathSuffix<span class="token punctuation">:</span> suffix<span class="token punctuation">,</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Handler for standard REST verbs (GET, PUT, POST and DELETE).</span>        <span class="token comment" spellcheck="true">// Add actions at the resource path: /api/apiVersion/resource</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"LIST"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isLister<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"POST"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isCreater<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"DELETECOLLECTION"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isCollectionDeleter<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// DEPRECATED in 1.11</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"WATCHLIST"</span><span class="token punctuation">,</span> <span class="token string">"watch/"</span> <span class="token operator">+</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> allowWatchList<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// Add actions at the item path: /api/apiVersion/resource/{name}</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"GET"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isGetter<span class="token punctuation">)</span>        <span class="token keyword">if</span> getSubpath <span class="token punctuation">{</span>            actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"GET"</span><span class="token punctuation">,</span> itemPath <span class="token operator">+</span> <span class="token string">"/{path:*}"</span><span class="token punctuation">,</span> proxyParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isGetter<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"PUT"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isUpdater<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"PATCH"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isPatcher<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"DELETE"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isGracefulDeleter<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// DEPRECATED in 1.11</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"WATCH"</span><span class="token punctuation">,</span> <span class="token string">"watch/"</span> <span class="token operator">+</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isWatcher<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"CONNECT"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isConnecter<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"CONNECT"</span><span class="token punctuation">,</span> itemPath <span class="token operator">+</span> <span class="token string">"/{path:*}"</span><span class="token punctuation">,</span> proxyParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isConnecter <span class="token operator">&amp;&amp;</span> connectSubpath<span class="token punctuation">)</span>    <span class="token keyword">default</span><span class="token punctuation">:</span>        namespaceParamName <span class="token operator">:=</span> <span class="token string">"namespaces"</span>        <span class="token comment" spellcheck="true">// Handler for standard REST verbs (GET, PUT, POST and DELETE).</span>        namespaceParam <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">PathParameter</span><span class="token punctuation">(</span><span class="token string">"namespace"</span><span class="token punctuation">,</span> <span class="token string">"object name and auth scope, such as for teams and projects"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DataType</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">)</span>        namespacedPath <span class="token operator">:=</span> namespaceParamName <span class="token operator">+</span> <span class="token string">"/{namespace}/"</span> <span class="token operator">+</span> resource        namespaceParams <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>restful<span class="token punctuation">.</span>Parameter<span class="token punctuation">{</span>namespaceParam<span class="token punctuation">}</span>        resourcePath <span class="token operator">:=</span> namespacedPath        resourceParams <span class="token operator">:=</span> namespaceParams        itemPath <span class="token operator">:=</span> namespacedPath <span class="token operator">+</span> <span class="token string">"/{name}"</span>        nameParams <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>namespaceParams<span class="token punctuation">,</span> nameParam<span class="token punctuation">)</span>        proxyParams <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>nameParams<span class="token punctuation">,</span> pathParam<span class="token punctuation">)</span>        itemPathSuffix <span class="token operator">:=</span> <span class="token string">""</span>        <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>            itemPathSuffix <span class="token operator">=</span> <span class="token string">"/"</span> <span class="token operator">+</span> subresource            itemPath <span class="token operator">=</span> itemPath <span class="token operator">+</span> itemPathSuffix            resourcePath <span class="token operator">=</span> itemPath            resourceParams <span class="token operator">=</span> nameParams        <span class="token punctuation">}</span>        apiResource<span class="token punctuation">.</span>Name <span class="token operator">=</span> path        apiResource<span class="token punctuation">.</span>Namespaced <span class="token operator">=</span> <span class="token boolean">true</span>        apiResource<span class="token punctuation">.</span>Kind <span class="token operator">=</span> resourceKind        namer <span class="token operator">:=</span> handlers<span class="token punctuation">.</span>ContextBasedNaming<span class="token punctuation">{</span>            SelfLinker<span class="token punctuation">:</span>         a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Linker<span class="token punctuation">,</span>            ClusterScoped<span class="token punctuation">:</span>      <span class="token boolean">false</span><span class="token punctuation">,</span>            SelfLinkPathPrefix<span class="token punctuation">:</span> gpath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>prefix<span class="token punctuation">,</span> namespaceParamName<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span><span class="token punctuation">,</span>            SelfLinkPathSuffix<span class="token punctuation">:</span> itemPathSuffix<span class="token punctuation">,</span>        <span class="token punctuation">}</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"LIST"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isLister<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"POST"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isCreater<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"DELETECOLLECTION"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isCollectionDeleter<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// DEPRECATED in 1.11</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"WATCHLIST"</span><span class="token punctuation">,</span> <span class="token string">"watch/"</span> <span class="token operator">+</span> resourcePath<span class="token punctuation">,</span> resourceParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> allowWatchList<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"GET"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isGetter<span class="token punctuation">)</span>        <span class="token keyword">if</span> getSubpath <span class="token punctuation">{</span>            actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"GET"</span><span class="token punctuation">,</span> itemPath <span class="token operator">+</span> <span class="token string">"/{path:*}"</span><span class="token punctuation">,</span> proxyParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isGetter<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"PUT"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isUpdater<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"PATCH"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isPatcher<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"DELETE"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isGracefulDeleter<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// DEPRECATED in 1.11</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"WATCH"</span><span class="token punctuation">,</span> <span class="token string">"watch/"</span> <span class="token operator">+</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isWatcher<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"CONNECT"</span><span class="token punctuation">,</span> itemPath<span class="token punctuation">,</span> nameParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isConnecter<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"CONNECT"</span><span class="token punctuation">,</span> itemPath <span class="token operator">+</span> <span class="token string">"/{path:*}"</span><span class="token punctuation">,</span> proxyParams<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isConnecter <span class="token operator">&amp;&amp;</span> connectSubpath<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// list or post across namespace.</span>        <span class="token comment" spellcheck="true">// For ex: LIST all pods in all namespaces by sending a LIST request at /api/apiVersion/pods.</span>        <span class="token comment" spellcheck="true">// TODO: more strongly type whether a resource allows these actions on "all namespaces" (bulk delete)</span>        <span class="token keyword">if</span> <span class="token operator">!</span>isSubresource <span class="token punctuation">{</span>            actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"LIST"</span><span class="token punctuation">,</span> resource<span class="token punctuation">,</span> params<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> isLister<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// DEPRECATED in 1.11</span>            actions <span class="token operator">=</span> <span class="token function">appendIf</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> action<span class="token punctuation">{</span><span class="token string">"WATCHLIST"</span><span class="token punctuation">,</span> <span class="token string">"watch/"</span> <span class="token operator">+</span> resource<span class="token punctuation">,</span> params<span class="token punctuation">,</span> namer<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> allowWatchList<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Create Routes for the actions.</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> s <span class="token operator">:=</span> <span class="token keyword">range</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Serializer<span class="token punctuation">.</span><span class="token function">SupportedMediaTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>MediaTypeSubType<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>MediaTypeType<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"all serializers in the group Serializer must have MediaTypeType and MediaTypeSubType set: %s"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>MediaType<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    mediaTypes<span class="token punctuation">,</span> streamMediaTypes <span class="token operator">:=</span> negotiation<span class="token punctuation">.</span><span class="token function">MediaTypesForSerializer</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span>    allMediaTypes <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>mediaTypes<span class="token punctuation">,</span> streamMediaTypes<span class="token operator">...</span><span class="token punctuation">)</span>    ws<span class="token punctuation">.</span><span class="token function">Produces</span><span class="token punctuation">(</span>allMediaTypes<span class="token operator">...</span><span class="token punctuation">)</span>    kubeVerbs <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    reqScope <span class="token operator">:=</span> handlers<span class="token punctuation">.</span>RequestScope<span class="token punctuation">{</span>        Serializer<span class="token punctuation">:</span>      a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span>        ParameterCodec<span class="token punctuation">:</span>  a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>ParameterCodec<span class="token punctuation">,</span>        Creater<span class="token punctuation">:</span>         a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">,</span>        Convertor<span class="token punctuation">:</span>       a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Convertor<span class="token punctuation">,</span>        Defaulter<span class="token punctuation">:</span>       a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Defaulter<span class="token punctuation">,</span>        Typer<span class="token punctuation">:</span>           a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">,</span>        UnsafeConvertor<span class="token punctuation">:</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>UnsafeConvertor<span class="token punctuation">,</span>        Authorizer<span class="token punctuation">:</span>      a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span>        EquivalentResourceMapper<span class="token punctuation">:</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>EquivalentResourceRegistry<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// TODO: Check for the interface on storage</span>        TableConvertor<span class="token punctuation">:</span> tableProvider<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// TODO: This seems wrong for cross-group subresources. It makes an assumption that a subresource and its parent are in the same group version. Revisit this.</span>        Resource<span class="token punctuation">:</span>    a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">.</span><span class="token function">WithResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">,</span>        Subresource<span class="token punctuation">:</span> subresource<span class="token punctuation">,</span>        Kind<span class="token punctuation">:</span>        fqKindToRegister<span class="token punctuation">,</span>        HubGroupVersion<span class="token punctuation">:</span> schema<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span>Group<span class="token punctuation">:</span> fqKindToRegister<span class="token punctuation">.</span>Group<span class="token punctuation">,</span> Version<span class="token punctuation">:</span> runtime<span class="token punctuation">.</span>APIVersionInternal<span class="token punctuation">}</span><span class="token punctuation">,</span>        MetaGroupVersion<span class="token punctuation">:</span> metav1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">,</span>        MaxRequestBodyBytes<span class="token punctuation">:</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>MaxRequestBodyBytes<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>MetaGroupVersion <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        reqScope<span class="token punctuation">.</span>MetaGroupVersion <span class="token operator">=</span> <span class="token operator">*</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>MetaGroupVersion    <span class="token punctuation">}</span>    <span class="token keyword">if</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>OpenAPIModels <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>ServerSideApply<span class="token punctuation">)</span> <span class="token punctuation">{</span>        reqScope<span class="token punctuation">.</span>FieldManager<span class="token punctuation">,</span> err <span class="token operator">=</span> fieldmanager<span class="token punctuation">.</span><span class="token function">NewDefaultFieldManager</span><span class="token punctuation">(</span>            a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>OpenAPIModels<span class="token punctuation">,</span>            a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>UnsafeConvertor<span class="token punctuation">,</span>            a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Defaulter<span class="token punctuation">,</span>            a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Creater<span class="token punctuation">,</span>            fqKindToRegister<span class="token punctuation">,</span>            reqScope<span class="token punctuation">.</span>HubGroupVersion<span class="token punctuation">,</span>        <span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create field manager: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> action <span class="token operator">:=</span> <span class="token keyword">range</span> actions <span class="token punctuation">{</span>        producedObject <span class="token operator">:=</span> storageMeta<span class="token punctuation">.</span><span class="token function">ProducesObject</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span>        <span class="token keyword">if</span> producedObject <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            producedObject <span class="token operator">=</span> defaultVersionedObject        <span class="token punctuation">}</span>        reqScope<span class="token punctuation">.</span>Namer <span class="token operator">=</span> action<span class="token punctuation">.</span>Namer        requestScope <span class="token operator">:=</span> <span class="token string">"cluster"</span>        <span class="token keyword">var</span> namespaced <span class="token builtin">string</span>        <span class="token keyword">var</span> operationSuffix <span class="token builtin">string</span>        <span class="token keyword">if</span> apiResource<span class="token punctuation">.</span>Namespaced <span class="token punctuation">{</span>            requestScope <span class="token operator">=</span> <span class="token string">"namespace"</span>            namespaced <span class="token operator">=</span> <span class="token string">"Namespaced"</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token string">"/{path:*}"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            requestScope <span class="token operator">=</span> <span class="token string">"resource"</span>            operationSuffix <span class="token operator">=</span> operationSuffix <span class="token operator">+</span> <span class="token string">"WithPath"</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> action<span class="token punctuation">.</span>AllNamespaces <span class="token punctuation">{</span>            requestScope <span class="token operator">=</span> <span class="token string">"cluster"</span>            operationSuffix <span class="token operator">=</span> operationSuffix <span class="token operator">+</span> <span class="token string">"ForAllNamespaces"</span>            namespaced <span class="token operator">=</span> <span class="token string">""</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> kubeVerb<span class="token punctuation">,</span> found <span class="token operator">:=</span> toDiscoveryKubeVerb<span class="token punctuation">[</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">]</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>kubeVerb<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>                kubeVerbs<span class="token punctuation">[</span>kubeVerb<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unknown action verb for discovery: %s"</span><span class="token punctuation">,</span> action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        routes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>restful<span class="token punctuation">.</span>RouteBuilder<span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// If there is a subresource, kind should be the parent's kind.</span>        <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>            parentStorage<span class="token punctuation">,</span> ok <span class="token operator">:=</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Storage<span class="token punctuation">[</span>resource<span class="token punctuation">]</span>            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"missing parent storage: %q"</span><span class="token punctuation">,</span> resource<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            fqParentKind<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">GetResourceKind</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">,</span> parentStorage<span class="token punctuation">,</span> a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>Typer<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            kind <span class="token operator">=</span> fqParentKind<span class="token punctuation">.</span>Kind        <span class="token punctuation">}</span>        verbOverrider<span class="token punctuation">,</span> needOverride <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>StorageMetricsOverride<span class="token punctuation">)</span>        <span class="token keyword">switch</span> action<span class="token punctuation">.</span>Verb <span class="token punctuation">{</span>        <span class="token keyword">case</span> <span class="token string">"GET"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Get a resource.</span>            <span class="token keyword">var</span> handler restful<span class="token punctuation">.</span>RouteFunction            <span class="token keyword">if</span> isGetterWithOptions <span class="token punctuation">{</span>                handler <span class="token operator">=</span> <span class="token function">restfulGetResourceWithOptions</span><span class="token punctuation">(</span>getterWithOptions<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> isSubresource<span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                handler <span class="token operator">=</span> <span class="token function">restfulGetResource</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> exporter<span class="token punctuation">,</span> reqScope<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> needOverride <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// need change the reported verb</span>                handler <span class="token operator">=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>verbOverrider<span class="token punctuation">.</span><span class="token function">OverrideMetricsVerb</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                handler <span class="token operator">=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            doc <span class="token operator">:=</span> <span class="token string">"read the specified "</span> <span class="token operator">+</span> kind            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>                doc <span class="token operator">=</span> <span class="token string">"read "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of the specified "</span> <span class="token operator">+</span> kind            <span class="token punctuation">}</span>            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Writes</span><span class="token punctuation">(</span>producedObject<span class="token punctuation">)</span>            <span class="token keyword">if</span> isGetterWithOptions <span class="token punctuation">{</span>                <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedGetOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> isExporter <span class="token punctuation">{</span>                <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedExportOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>        <span class="token keyword">case</span> <span class="token string">"LIST"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// List all resources of a kind.</span>            doc <span class="token operator">:=</span> <span class="token string">"list objects of kind "</span> <span class="token operator">+</span> kind            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>                doc <span class="token operator">=</span> <span class="token string">"list "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of objects of kind "</span> <span class="token operator">+</span> kind            <span class="token punctuation">}</span>            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulListResource</span><span class="token punctuation">(</span>lister<span class="token punctuation">,</span> watcher<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>minRequestTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span>            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"list"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> allMediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> versionedList<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Writes</span><span class="token punctuation">(</span>versionedList<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedListOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            <span class="token keyword">switch</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> isLister <span class="token operator">&amp;&amp;</span> isWatcher<span class="token punctuation">:</span>                doc <span class="token operator">:=</span> <span class="token string">"list or watch objects of kind "</span> <span class="token operator">+</span> kind                <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>                    doc <span class="token operator">=</span> <span class="token string">"list or watch "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of objects of kind "</span> <span class="token operator">+</span> kind                <span class="token punctuation">}</span>                route<span class="token punctuation">.</span><span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>            <span class="token keyword">case</span> isWatcher<span class="token punctuation">:</span>                doc <span class="token operator">:=</span> <span class="token string">"watch objects of kind "</span> <span class="token operator">+</span> kind                <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>                    doc <span class="token operator">=</span> <span class="token string">"watch "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">"of objects of kind "</span> <span class="token operator">+</span> kind                <span class="token punctuation">}</span>                route<span class="token punctuation">.</span><span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>        <span class="token keyword">case</span> <span class="token string">"PUT"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Update a resource.</span>            doc <span class="token operator">:=</span> <span class="token string">"replace the specified "</span> <span class="token operator">+</span> kind            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>                doc <span class="token operator">=</span> <span class="token string">"replace "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of the specified "</span> <span class="token operator">+</span> kind            <span class="token punctuation">}</span>            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulUpdateResource</span><span class="token punctuation">(</span>updater<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span><span class="token punctuation">)</span>            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">PUT</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"replace"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token comment" spellcheck="true">// TODO: in some cases, the API may return a v1.Status instead of the versioned object</span>                <span class="token comment" spellcheck="true">// but currently go-restful can't handle multiple different objects being returned.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusCreated<span class="token punctuation">,</span> <span class="token string">"Created"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Reads</span><span class="token punctuation">(</span>defaultVersionedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Writes</span><span class="token punctuation">(</span>producedObject<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedUpdateOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>        <span class="token keyword">case</span> <span class="token string">"PATCH"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Partially update a resource</span>            doc <span class="token operator">:=</span> <span class="token string">"partially update the specified "</span> <span class="token operator">+</span> kind            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>                doc <span class="token operator">=</span> <span class="token string">"partially update "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of the specified "</span> <span class="token operator">+</span> kind            <span class="token punctuation">}</span>            supportedTypes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>                <span class="token function">string</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>JSONPatchType<span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token function">string</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>MergePatchType<span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token function">string</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>StrategicMergePatchType<span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>ServerSideApply<span class="token punctuation">)</span> <span class="token punctuation">{</span>                supportedTypes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>supportedTypes<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ApplyPatchType<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulPatchResource</span><span class="token punctuation">(</span>patcher<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">,</span> supportedTypes<span class="token punctuation">)</span><span class="token punctuation">)</span>            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">PATCH</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Consumes</span><span class="token punctuation">(</span>supportedTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"patch"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Reads</span><span class="token punctuation">(</span>metav1<span class="token punctuation">.</span>Patch<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Writes</span><span class="token punctuation">(</span>producedObject<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedPatchOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>        <span class="token keyword">case</span> <span class="token string">"POST"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Create a resource.</span>            <span class="token keyword">var</span> handler restful<span class="token punctuation">.</span>RouteFunction            <span class="token keyword">if</span> isNamedCreater <span class="token punctuation">{</span>                handler <span class="token operator">=</span> <span class="token function">restfulCreateNamedResource</span><span class="token punctuation">(</span>namedCreater<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                handler <span class="token operator">=</span> <span class="token function">restfulCreateResource</span><span class="token punctuation">(</span>creater<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            handler <span class="token operator">=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>            article <span class="token operator">:=</span> <span class="token function">GetArticleForNoun</span><span class="token punctuation">(</span>kind<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>            doc <span class="token operator">:=</span> <span class="token string">"create"</span> <span class="token operator">+</span> article <span class="token operator">+</span> kind            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>                doc <span class="token operator">=</span> <span class="token string">"create "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of"</span> <span class="token operator">+</span> article <span class="token operator">+</span> kind            <span class="token punctuation">}</span>            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"create"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token comment" spellcheck="true">// TODO: in some cases, the API may return a v1.Status instead of the versioned object</span>                <span class="token comment" spellcheck="true">// but currently go-restful can't handle multiple different objects being returned.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusCreated<span class="token punctuation">,</span> <span class="token string">"Created"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusAccepted<span class="token punctuation">,</span> <span class="token string">"Accepted"</span><span class="token punctuation">,</span> producedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Reads</span><span class="token punctuation">(</span>defaultVersionedObject<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Writes</span><span class="token punctuation">(</span>producedObject<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedCreateOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>        <span class="token keyword">case</span> <span class="token string">"DELETE"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Delete a resource.</span>            article <span class="token operator">:=</span> <span class="token function">GetArticleForNoun</span><span class="token punctuation">(</span>kind<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>            doc <span class="token operator">:=</span> <span class="token string">"delete"</span> <span class="token operator">+</span> article <span class="token operator">+</span> kind            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>                doc <span class="token operator">=</span> <span class="token string">"delete "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of"</span> <span class="token operator">+</span> article <span class="token operator">+</span> kind            <span class="token punctuation">}</span>            deleteReturnType <span class="token operator">:=</span> versionedStatus            <span class="token keyword">if</span> deleteReturnsDeletedObject <span class="token punctuation">{</span>                deleteReturnType <span class="token operator">=</span> producedObject            <span class="token punctuation">}</span>            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulDeleteResource</span><span class="token punctuation">(</span>gracefulDeleter<span class="token punctuation">,</span> isGracefulDeleter<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span><span class="token punctuation">)</span>            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"delete"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Writes</span><span class="token punctuation">(</span>deleteReturnType<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> deleteReturnType<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusAccepted<span class="token punctuation">,</span> <span class="token string">"Accepted"</span><span class="token punctuation">,</span> deleteReturnType<span class="token punctuation">)</span>            <span class="token keyword">if</span> isGracefulDeleter <span class="token punctuation">{</span>                route<span class="token punctuation">.</span><span class="token function">Reads</span><span class="token punctuation">(</span>versionedDeleterObject<span class="token punctuation">)</span>                route<span class="token punctuation">.</span><span class="token function">ParameterNamed</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Required</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedDeleteOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>        <span class="token keyword">case</span> <span class="token string">"DELETECOLLECTION"</span><span class="token punctuation">:</span>            doc <span class="token operator">:=</span> <span class="token string">"delete collection of "</span> <span class="token operator">+</span> kind            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>                doc <span class="token operator">=</span> <span class="token string">"delete collection of "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of a "</span> <span class="token operator">+</span> kind            <span class="token punctuation">}</span>            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulDeleteCollection</span><span class="token punctuation">(</span>collectionDeleter<span class="token punctuation">,</span> isCollectionDeleter<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">)</span><span class="token punctuation">)</span>            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"deletecollection"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Produces</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>storageMeta<span class="token punctuation">.</span><span class="token function">ProducesMIMETypes</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">,</span> mediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Writes</span><span class="token punctuation">(</span>versionedStatus<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> versionedStatus<span class="token punctuation">)</span>            <span class="token keyword">if</span> isCollectionDeleter <span class="token punctuation">{</span>                route<span class="token punctuation">.</span><span class="token function">Reads</span><span class="token punctuation">(</span>versionedDeleterObject<span class="token punctuation">)</span>                route<span class="token punctuation">.</span><span class="token function">ParameterNamed</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Required</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedDeleteOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedListOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// deprecated in 1.11</span>        <span class="token keyword">case</span> <span class="token string">"WATCH"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Watch a resource.</span>            doc <span class="token operator">:=</span> <span class="token string">"watch changes to an object of kind "</span> <span class="token operator">+</span> kind            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>                doc <span class="token operator">=</span> <span class="token string">"watch changes to "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of an object of kind "</span> <span class="token operator">+</span> kind            <span class="token punctuation">}</span>            doc <span class="token operator">+=</span> <span class="token string">". deprecated: use the 'watch' parameter with a list operation instead, filtered to a single item with the 'fieldSelector' parameter."</span>            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulListResource</span><span class="token punctuation">(</span>lister<span class="token punctuation">,</span> watcher<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>minRequestTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span>            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"watch"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Produces</span><span class="token punctuation">(</span>allMediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> versionedWatchEvent<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Writes</span><span class="token punctuation">(</span>versionedWatchEvent<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedListOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// deprecated in 1.11</span>        <span class="token keyword">case</span> <span class="token string">"WATCHLIST"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Watch all resources of a kind.</span>            doc <span class="token operator">:=</span> <span class="token string">"watch individual changes to a list of "</span> <span class="token operator">+</span> kind            <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>                doc <span class="token operator">=</span> <span class="token string">"watch individual changes to a list of "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of "</span> <span class="token operator">+</span> kind            <span class="token punctuation">}</span>            doc <span class="token operator">+=</span> <span class="token string">". deprecated: use the 'watch' parameter with a list operation instead."</span>            handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulListResource</span><span class="token punctuation">(</span>lister<span class="token punctuation">,</span> watcher<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>minRequestTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span>            route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Param</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">QueryParameter</span><span class="token punctuation">(</span><span class="token string">"pretty"</span><span class="token punctuation">,</span> <span class="token string">"If 'true', then the output is pretty printed."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"watch"</span><span class="token operator">+</span>namespaced<span class="token operator">+</span>kind<span class="token operator">+</span>strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"List"</span><span class="token operator">+</span>operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Produces</span><span class="token punctuation">(</span>allMediaTypes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Returns</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> versionedWatchEvent<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Writes</span><span class="token punctuation">(</span>versionedWatchEvent<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedListOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err            <span class="token punctuation">}</span>            <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>            routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>        <span class="token keyword">case</span> <span class="token string">"CONNECT"</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> method <span class="token operator">:=</span> <span class="token keyword">range</span> connecter<span class="token punctuation">.</span><span class="token function">ConnectMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                connectProducedObject <span class="token operator">:=</span> storageMeta<span class="token punctuation">.</span><span class="token function">ProducesObject</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span>                <span class="token keyword">if</span> connectProducedObject <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                    connectProducedObject <span class="token operator">=</span> <span class="token string">"string"</span>                <span class="token punctuation">}</span>                doc <span class="token operator">:=</span> <span class="token string">"connect "</span> <span class="token operator">+</span> method <span class="token operator">+</span> <span class="token string">" requests to "</span> <span class="token operator">+</span> kind                <span class="token keyword">if</span> isSubresource <span class="token punctuation">{</span>                    doc <span class="token operator">=</span> <span class="token string">"connect "</span> <span class="token operator">+</span> method <span class="token operator">+</span> <span class="token string">" requests to "</span> <span class="token operator">+</span> subresource <span class="token operator">+</span> <span class="token string">" of "</span> <span class="token operator">+</span> kind                <span class="token punctuation">}</span>                handler <span class="token operator">:=</span> metrics<span class="token punctuation">.</span><span class="token function">InstrumentRouteFunc</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">,</span> group<span class="token punctuation">,</span> version<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> subresource<span class="token punctuation">,</span> requestScope<span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>APIServerComponent<span class="token punctuation">,</span> <span class="token function">restfulConnectResource</span><span class="token punctuation">(</span>connecter<span class="token punctuation">,</span> reqScope<span class="token punctuation">,</span> admit<span class="token punctuation">,</span> path<span class="token punctuation">,</span> isSubresource<span class="token punctuation">)</span><span class="token punctuation">)</span>                route <span class="token operator">:=</span> ws<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">.</span>                    <span class="token function">To</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span>                    <span class="token function">Doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>                    <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token string">"connect"</span> <span class="token operator">+</span> strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> namespaced <span class="token operator">+</span> kind <span class="token operator">+</span> strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>subresource<span class="token punctuation">)</span> <span class="token operator">+</span> operationSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span>                    <span class="token function">Produces</span><span class="token punctuation">(</span>"<span class="token operator">*</span><span class="token comment" spellcheck="true">/*").                    Consumes("*/</span><span class="token operator">*</span>"<span class="token punctuation">)</span><span class="token punctuation">.</span>                    <span class="token function">Writes</span><span class="token punctuation">(</span>connectProducedObject<span class="token punctuation">)</span>                <span class="token keyword">if</span> versionedConnectOptions <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">AddObjectParams</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> route<span class="token punctuation">,</span> versionedConnectOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token function">addParams</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> action<span class="token punctuation">.</span>Params<span class="token punctuation">)</span>                routes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> route<span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">// transform ConnectMethods to kube verbs</span>                <span class="token keyword">if</span> kubeVerb<span class="token punctuation">,</span> found <span class="token operator">:=</span> toDiscoveryKubeVerb<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>kubeVerb<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>                        kubeVerbs<span class="token punctuation">[</span>kubeVerb<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token keyword">default</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unrecognized action verb: %s"</span><span class="token punctuation">,</span> action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> route <span class="token operator">:=</span> <span class="token keyword">range</span> routes <span class="token punctuation">{</span>            route<span class="token punctuation">.</span><span class="token function">Metadata</span><span class="token punctuation">(</span>ROUTE_META_GVK<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">{</span>                Group<span class="token punctuation">:</span>   reqScope<span class="token punctuation">.</span>Kind<span class="token punctuation">.</span>Group<span class="token punctuation">,</span>                Version<span class="token punctuation">:</span> reqScope<span class="token punctuation">.</span>Kind<span class="token punctuation">.</span>Version<span class="token punctuation">,</span>                Kind<span class="token punctuation">:</span>    reqScope<span class="token punctuation">.</span>Kind<span class="token punctuation">.</span>Kind<span class="token punctuation">,</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>            route<span class="token punctuation">.</span><span class="token function">Metadata</span><span class="token punctuation">(</span>ROUTE_META_ACTION<span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Verb<span class="token punctuation">)</span><span class="token punctuation">)</span>            ws<span class="token punctuation">.</span><span class="token function">Route</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Note: update GetAuthorizerAttributes() when adding a custom handler.</span>    <span class="token punctuation">}</span>    apiResource<span class="token punctuation">.</span>Verbs <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>kubeVerbs<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> kubeVerb <span class="token operator">:=</span> <span class="token keyword">range</span> kubeVerbs <span class="token punctuation">{</span>        apiResource<span class="token punctuation">.</span>Verbs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>apiResource<span class="token punctuation">.</span>Verbs<span class="token punctuation">,</span> kubeVerb<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    sort<span class="token punctuation">.</span><span class="token function">Strings</span><span class="token punctuation">(</span>apiResource<span class="token punctuation">.</span>Verbs<span class="token punctuation">)</span>    <span class="token keyword">if</span> shortNamesProvider<span class="token punctuation">,</span> ok <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>ShortNamesProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>        apiResource<span class="token punctuation">.</span>ShortNames <span class="token operator">=</span> shortNamesProvider<span class="token punctuation">.</span><span class="token function">ShortNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> categoriesProvider<span class="token punctuation">,</span> ok <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>CategoriesProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>        apiResource<span class="token punctuation">.</span>Categories <span class="token operator">=</span> categoriesProvider<span class="token punctuation">.</span><span class="token function">Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> gvkProvider<span class="token punctuation">,</span> ok <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token punctuation">(</span>rest<span class="token punctuation">.</span>GroupVersionKindProvider<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>        gvk <span class="token operator">:=</span> gvkProvider<span class="token punctuation">.</span><span class="token function">GroupVersionKind</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">)</span>        apiResource<span class="token punctuation">.</span>Group <span class="token operator">=</span> gvk<span class="token punctuation">.</span>Group        apiResource<span class="token punctuation">.</span>Version <span class="token operator">=</span> gvk<span class="token punctuation">.</span>Version        apiResource<span class="token punctuation">.</span>Kind <span class="token operator">=</span> gvk<span class="token punctuation">.</span>Kind    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Record the existence of the GVR and the corresponding GVK</span>    a<span class="token punctuation">.</span>group<span class="token punctuation">.</span>EquivalentResourceRegistry<span class="token punctuation">.</span><span class="token function">RegisterKindFor</span><span class="token punctuation">(</span>reqScope<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> reqScope<span class="token punctuation">.</span>Subresource<span class="token punctuation">,</span> fqKindToRegister<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>apiResource<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><h3 id="API-server-å­˜å‚¨"><a href="#API-server-å­˜å‚¨" class="headerlink" title="API server å­˜å‚¨"></a>API server å­˜å‚¨</h3><h4 id="registry"><a href="#registry" class="headerlink" title="registry"></a>registry</h4><p>åœ¨ Kubernetesä¸­ï¼Œregistry å¯ä»¥å¯¹ ETCDä¸­ çš„ Kubernetes å„ç±»å‹è¿›è¡Œå¢åˆ æŸ¥æ”¹æ“ä½œï¼Œå¹¶å¯¹å¤–æä¾›äº†ç”ŸæˆapiGroupInfo çš„æ–¹æ³•ã€‚è¿™é‡Œçš„ registry åŒ…å«äº†ä¸¤å±‚å«ä¹‰ï¼ŒStorage å’Œ Registryï¼Œå¦‚ NodeStorage å’ŒNodeRegistryã€‚Storage æä¾›äº†é€šç”¨çš„å¢åˆ æŸ¥æ”¹æ–¹æ³•ï¼ŒRegsitry æ˜¯å¯¹Storageçš„å°è£…ï¼Œæä¾›äº†å…·ä½“ç±»å‹çš„å¢åˆ æŸ¥æ”¹æ–¹æ³•ã€‚registryå®šä¹‰åœ¨<code>/pkg/registry</code>ç›®å½•ä¸‹ï¼Œä¸»è¦åŒ…å«ï¼š</p><ul><li>admissionregistration:  å®šä¹‰ admission ç›¸å…³çš„ registry ä¿¡æ¯</li></ul><ul><li>apps: å®šä¹‰statefulsetsç›¸å…³çš„registryä¿¡æ¯ï¼›</li><li>authentication: å®šä¹‰tokenreviewç›¸å…³çš„registryä¿¡æ¯ï¼›</li><li>authorization: å®šä¹‰localsubjectaccessreview, selfsubjectaccessreview, subjectaccessreviewç›¸å…³çš„registryä¿¡æ¯ï¼›</li><li>autoscaling: å®šä¹‰horizontalpodautoscalerç›¸å…³çš„registryä¿¡æ¯ï¼›</li><li>batch: å®šä¹‰scheduledjobsç›¸å…³çš„registryä¿¡æ¯ï¼›</li><li>certificates: å®šä¹‰certificatesigningrequestsç›¸å…³çš„registryä¿¡æ¯ï¼›</li><li>core: å®šä¹‰componentstatus, configmap, controller, endpoint, event, limitrange, namespace, node, persistentvolume, persistentvolumeclaim, pod, podtemplate, rangeallocation, resourcequota, secret, service, serviceaccountçš„registryä¿¡æ¯ï¼›</li><li>extensions: å®šä¹‰replicationcontrollers, daemonset, deployment, ingress, networkpolicy, podsecuritypolicy, replicasetç­‰ç›¸å…³çš„registryä¿¡æ¯ï¼›</li><li>generic: å…¬å…±æ¨¡å—ï¼Œå¯¹storageæ¨¡å—è¿›è¡Œå°è£…ï¼›</li><li>policy: å®šä¹‰poddisruptionbudgetsç›¸å…³çš„registryä¿¡æ¯ï¼›</li><li>rbac: å®šä¹‰cluserrole, roleç­‰ç›¸å…³çš„registryä¿¡æ¯ï¼›</li><li>storage: å®šä¹‰storageclassç›¸å…³çš„registryä¿¡æ¯ã€‚</li></ul><p>æ¯ä¸ªå­ç›®å½•éƒ½å¯¹åº”ä¸€ä¸ªAPIGroupï¼Œå¦‚coreå¯¹åº”çš„æ˜¯v1ï¼Œæ¯ä¸ªå­ç›®å½•ä¸‹éƒ½æœ‰ä¸ªrestçš„ç›®å½•ï¼Œå…¶ä¸­coreç›®å½•å®ç°äº†NewLegacyRESTStorage()æ–¹æ³•ç”Ÿæˆå¯¹åº”çš„apiGroupInfoï¼Œå…¶ä»–ç›®å½•å®ç°äº†NewRESTStorage()æ–¹æ³•ç”Ÿæˆå¯¹åº”çš„apiGroupInfoã€‚apiGroupInfoæ˜¯è”ç³»registryå’Œapiserverçš„é€šé“ã€‚</p><p>åœ¨NewLegacyRESTStorage()æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨NewStorage()ç”Ÿæˆstorageï¼Œå¦‚nodeStorageç­‰ï¼Œè¿›ä¸€æ­¥åœ°ç”ŸæˆrestStorageMapï¼Œç„¶åç”ŸæˆapiGroupInfoã€‚</p><p>å…¶ä»–APIGroupä½¿ç”¨NewRESTStorage()ï¼Œä¼šè°ƒç”¨NewREST()ç”Ÿæˆstorageï¼Œå¦‚rolesStorageã€‚</p><p>æˆ‘ä»¬ä»¥coreåŒ…ä¸‹çš„nodeä¸ºä¾‹æ¥çœ‹ä¸‹NewStorage()çš„å®ç°ï¼Œä»¥rbacåŒ…ä¸‹çš„roleä¸ºä¾‹æ¥çœ‹ä¸‹NewREST()çš„å®ç°ã€‚</p><h5 id="nodeStorage"><a href="#nodeStorage" class="headerlink" title="nodeStorage"></a>nodeStorage</h5><p>nodeå®šä¹‰åœ¨<code>/pkg/registry/core/node</code>ç›®å½•ä¸‹ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹<code>/pkg/registry/core/rest/storage_core.go</code>ä¸­çš„NewLegacyRESTStorage()æ˜¯å¦‚ä½•ç”Ÿæˆ nodeStorage çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c LegacyRESTStorageProvider<span class="token punctuation">)</span> <span class="token function">NewLegacyRESTStorage</span><span class="token punctuation">(</span>restOptionsGetter generic<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">)</span> <span class="token punctuation">(</span>LegacyRESTStorage<span class="token punctuation">,</span> genericapiserver<span class="token punctuation">.</span>APIGroupInfo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    apiGroupInfo <span class="token operator">:=</span> genericapiserver<span class="token punctuation">.</span>APIGroupInfo<span class="token punctuation">{</span>        PrioritizedVersions<span class="token punctuation">:</span>          legacyscheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">.</span><span class="token function">PrioritizedVersionsForGroup</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        VersionedResourcesStorageMap<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>rest<span class="token punctuation">.</span>Storage<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        Scheme<span class="token punctuation">:</span>                       legacyscheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span>        ParameterCodec<span class="token punctuation">:</span>               legacyscheme<span class="token punctuation">.</span>ParameterCodec<span class="token punctuation">,</span>        NegotiatedSerializer<span class="token punctuation">:</span>         legacyscheme<span class="token punctuation">.</span>Codecs<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token operator">...</span>    restStorage <span class="token operator">:=</span> LegacyRESTStorage<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">...</span><span class="token punctuation">.</span>    nodeStorage<span class="token punctuation">,</span> err <span class="token operator">:=</span> nodestore<span class="token punctuation">.</span><span class="token function">NewStorage</span><span class="token punctuation">(</span>restOptionsGetter<span class="token punctuation">,</span> c<span class="token punctuation">.</span>KubeletClientConfig<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ProxyTransport<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> LegacyRESTStorage<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> genericapiserver<span class="token punctuation">.</span>APIGroupInfo<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span><span class="token comment" spellcheck="true">///</span>    apiGroupInfo<span class="token punctuation">.</span>VersionedResourcesStorageMap<span class="token punctuation">[</span><span class="token string">"v1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> restStorageMap    <span class="token keyword">return</span> restStorage<span class="token punctuation">,</span> apiGroupInfo<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><h5 id="NewStorage"><a href="#NewStorage" class="headerlink" title="NewStorage"></a>NewStorage</h5><p>nodeçš„NewStorage()å®šä¹‰åœ¨<code>/pkg/registry/core/node/storage/storage.go</code>ä¸­ï¼Œä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>ç”Ÿæˆstoreï¼Œstoreä¸ºgenericStore</li><li>ç”ŸæˆnodeREST;</li><li>ç”ŸæˆNodeStorageã€‚</li></ol><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewStorage</span><span class="token punctuation">(</span>optsGetter generic<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> kubeletClientConfig client<span class="token punctuation">.</span>KubeletClientConfig<span class="token punctuation">,</span> proxyTransport http<span class="token punctuation">.</span>RoundTripper<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>NodeStorage<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    store <span class="token operator">:=</span> <span class="token operator">&amp;</span>genericregistry<span class="token punctuation">.</span>Store<span class="token punctuation">{</span>        NewFunc<span class="token punctuation">:</span>                  <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> runtime<span class="token punctuation">.</span>Object <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>Node<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        NewListFunc<span class="token punctuation">:</span>              <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> runtime<span class="token punctuation">.</span>Object <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>NodeList<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        PredicateFunc<span class="token punctuation">:</span>            node<span class="token punctuation">.</span>MatchNode<span class="token punctuation">,</span>        DefaultQualifiedResource<span class="token punctuation">:</span> api<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"nodes"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        CreateStrategy<span class="token punctuation">:</span> node<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>        UpdateStrategy<span class="token punctuation">:</span> node<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>        DeleteStrategy<span class="token punctuation">:</span> node<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>        ExportStrategy<span class="token punctuation">:</span> node<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>        TableConvertor<span class="token punctuation">:</span> printerstorage<span class="token punctuation">.</span>TableConvertor<span class="token punctuation">{</span>TableGenerator<span class="token punctuation">:</span> printers<span class="token punctuation">.</span><span class="token function">NewTableGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>printersinternal<span class="token punctuation">.</span>AddHandlers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    options <span class="token operator">:=</span> <span class="token operator">&amp;</span>generic<span class="token punctuation">.</span>StoreOptions<span class="token punctuation">{</span>        RESTOptions<span class="token punctuation">:</span> optsGetter<span class="token punctuation">,</span>        AttrFunc<span class="token punctuation">:</span>    node<span class="token punctuation">.</span>GetAttrs<span class="token punctuation">,</span>        TriggerFunc<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>storage<span class="token punctuation">.</span>IndexerFunc<span class="token punctuation">{</span><span class="token string">"metadata.name"</span><span class="token punctuation">:</span> node<span class="token punctuation">.</span>NameTriggerFunc<span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">CompleteWithOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    statusStore <span class="token operator">:=</span> <span class="token operator">*</span>store    statusStore<span class="token punctuation">.</span>UpdateStrategy <span class="token operator">=</span> node<span class="token punctuation">.</span>StatusStrategy    <span class="token comment" spellcheck="true">// Set up REST handlers</span>    nodeREST <span class="token operator">:=</span> <span class="token operator">&amp;</span>REST<span class="token punctuation">{</span>Store<span class="token punctuation">:</span> store<span class="token punctuation">,</span> proxyTransport<span class="token punctuation">:</span> proxyTransport<span class="token punctuation">}</span>    statusREST <span class="token operator">:=</span> <span class="token operator">&amp;</span>StatusREST<span class="token punctuation">{</span>store<span class="token punctuation">:</span> <span class="token operator">&amp;</span>statusStore<span class="token punctuation">}</span>    proxyREST <span class="token operator">:=</span> <span class="token operator">&amp;</span>noderest<span class="token punctuation">.</span>ProxyREST<span class="token punctuation">{</span>Store<span class="token punctuation">:</span> store<span class="token punctuation">,</span> ProxyTransport<span class="token punctuation">:</span> proxyTransport<span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Build a NodeGetter that looks up nodes using the REST handler</span>    nodeGetter <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">NodeGetterFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">,</span> options metav1<span class="token punctuation">.</span>GetOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        obj<span class="token punctuation">,</span> err <span class="token operator">:=</span> nodeREST<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> nodeName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>options<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        node<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>Node<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unexpected type %T"</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// TODO: Remove the conversion. Consider only return the NodeAddresses</span>        externalNode <span class="token operator">:=</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">{</span><span class="token punctuation">}</span>        err <span class="token operator">=</span> k8s_api_v1<span class="token punctuation">.</span><span class="token function">Convert_core_Node_To_v1_Node</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> externalNode<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to convert to v1.Node: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> externalNode<span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    connectionInfoGetter<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">NewNodeConnectionInfoGetter</span><span class="token punctuation">(</span>nodeGetter<span class="token punctuation">,</span> kubeletClientConfig<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    nodeREST<span class="token punctuation">.</span>connection <span class="token operator">=</span> connectionInfoGetter    proxyREST<span class="token punctuation">.</span>Connection <span class="token operator">=</span> connectionInfoGetter    <span class="token keyword">return</span> <span class="token operator">&amp;</span>NodeStorage<span class="token punctuation">{</span>        Node<span class="token punctuation">:</span>                  nodeREST<span class="token punctuation">,</span>        Status<span class="token punctuation">:</span>                statusREST<span class="token punctuation">,</span>        Proxy<span class="token punctuation">:</span>                 proxyREST<span class="token punctuation">,</span>        KubeletConnectionInfo<span class="token punctuation">:</span> connectionInfoGetter<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>å¯ä»¥çœ‹å‡ºï¼ŒNodeStorage æœ¬è´¨æ˜¯ä¸€ä¸ªgenericStoreï¼ŒStoreä¸­å®šä¹‰æœ‰Create(), Delete(), Get(), List(), Watch()ç­‰æ–¹æ³•ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> runtime<span class="token punctuation">.</span>Object <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> options <span class="token operator">*</span>metainternalversion<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> createValidation rest<span class="token punctuation">.</span>ValidateObjectFunc<span class="token punctuation">,</span> options <span class="token operator">*</span>metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> objInfo rest<span class="token punctuation">.</span>UpdatedObjectInfo<span class="token punctuation">,</span> createValidation rest<span class="token punctuation">.</span>ValidateObjectFunc<span class="token punctuation">,</span> updateValidation rest<span class="token punctuation">.</span>ValidateObjectUpdateFunc<span class="token punctuation">,</span> forceAllowCreate <span class="token builtin">bool</span><span class="token punctuation">,</span> options <span class="token operator">*</span>metav1<span class="token punctuation">.</span>UpdateOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> options <span class="token operator">*</span>metav1<span class="token punctuation">.</span>GetOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> deleteValidation rest<span class="token punctuation">.</span>ValidateObjectFunc<span class="token punctuation">,</span> options <span class="token operator">*</span>metav1<span class="token punctuation">.</span>DeleteOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£ Kubernetes ä¹‹ Kubectl</title>
      <link href="/2020/05/21/k8s02/"/>
      <url>/2020/05/21/k8s02/</url>
      
        <content type="html"><![CDATA[<h1 id="æ·±å…¥ç†è§£-Kubectl"><a href="#æ·±å…¥ç†è§£-Kubectl" class="headerlink" title="æ·±å…¥ç†è§£ Kubectl"></a>æ·±å…¥ç†è§£ Kubectl</h1><p>kubectl æ˜¯ Kubernetes é›†ç¾¤çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œé€šè¿‡ kubectl èƒ½å¤Ÿå¯¹é›†ç¾¤æœ¬èº«è¿›è¡Œç®¡ç†ï¼Œå¹¶èƒ½å¤Ÿåœ¨é›†ç¾¤ä¸Šè¿›è¡Œå®¹å™¨åŒ–åº”ç”¨çš„å®‰è£…éƒ¨ç½²ã€‚è¿è¡Œ kubectl å‘½ä»¤çš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class=" language-bash"><code class="language-bash">kubectl <span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span> <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span></code></pre><p><strong>comand</strong>ï¼šæŒ‡å®šè¦å¯¹èµ„æºæ‰§è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚ createã€getã€describe å’Œ deleteã€‚</p><p><strong>TYPE</strong>ï¼šæŒ‡å®šèµ„æºç±»å‹ï¼Œèµ„æºç±»å‹æ˜¯å¤§å°å­¦æ•æ„Ÿçš„ï¼Œå¼€å‘è€…èƒ½å¤Ÿä»¥å•æ•°ã€å¤æ•°å’Œç¼©ç•¥çš„å½¢å¼ã€‚</p><p><strong>NAME</strong>ï¼šæŒ‡å®šèµ„æºçš„åç§°ï¼Œåç§°ä¹Ÿå¤§å°å†™æ•æ„Ÿçš„ã€‚å¦‚æœçœç•¥åç§°ï¼Œåˆ™ä¼šæ˜¾ç¤ºæ‰€æœ‰çš„èµ„æºã€‚</p><p><strong>flags</strong>ï¼šæŒ‡å®šå¯é€‰çš„å‚æ•°ã€‚</p><p>ä¾‹å¦‚ï¼š</p><pre class=" language-bash"><code class="language-bash">kubectl create -f nginx-deployment.yaml</code></pre><h2 id="Kubectl-æµç¨‹"><a href="#Kubectl-æµç¨‹" class="headerlink" title="Kubectl æµç¨‹"></a>Kubectl æµç¨‹</h2><p><img src="/images/2020/kubectl.png" alt=""></p><p>Kubectl çš„æ‰§è¡Œæµç¨‹ï¼š</p><ol><li><p>ç”¨æˆ·å‘èµ·è¯·æ±‚</p></li><li><p>æ ¹æ®ç”¨æˆ·æ‰§è¡ŒåŠ¨ä½œåˆ†å‘ç»™å¤„ç†å¯¹åº”åŠ¨ä½œçš„ Cmd ï¼ˆBuilder è®¾è®¡æ¨¡å¼ï¼‰</p></li><li><p>è§£æç”¨æˆ·å‘½ä»¤ ï¼ˆVisitor è®¾è®¡æ¨¡å¼ï¼‰</p></li><li><p>å‘Apiserverè·å–æ•°æ®</p></li><li><p>è§£æè¿”å›ä¸ºé€šç”¨çš„æ•°æ®é›†åˆ</p></li></ol><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š</p><pre class=" language-bash"><code class="language-bash">kubectl create -f nginx-deployment.yaml</code></pre><h3 id="å…¥å£"><a href="#å…¥å£" class="headerlink" title="å…¥å£"></a>å…¥å£</h3><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/9e991415386e4cf155a24b1da15becaa390438d8/cmd/kubectl/kubectl.go#L35" target="_blank" rel="noopener"><code>kubernetes/cmd/kubectl/kubectl.go</code></a></p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span>    <span class="token comment" spellcheck="true">// å‡†å¤‡command</span>    command <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">NewDefaultKubectlCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// æ‰§è¡Œå‘½ä»¤</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> command<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="å‘½ä»¤åŒ¹é…"><a href="#å‘½ä»¤åŒ¹é…" class="headerlink" title="å‘½ä»¤åŒ¹é…"></a>å‘½ä»¤åŒ¹é…</h3><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/9e991415386e4cf155a24b1da15becaa390438d8/pkg/kubectl/cmd/cmd.go#L482" target="_blank" rel="noopener">kubernetes/pkg/kubectl/cmd/cmd.go</a></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// å¯¹ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤è¿›è¡ŒåŒ¹é…</span>groups <span class="token operator">:=</span> templates<span class="token punctuation">.</span>CommandGroups<span class="token punctuation">{</span>        <span class="token punctuation">{</span>            Message<span class="token punctuation">:</span> <span class="token string">"Basic Commands (Beginner):"</span><span class="token punctuation">,</span>            Commands<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>                create<span class="token punctuation">.</span><span class="token function">NewCmdCreate</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">,</span>                expose<span class="token punctuation">.</span><span class="token function">NewCmdExposeService</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">,</span>                run<span class="token punctuation">.</span><span class="token function">NewCmdRun</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">,</span>                set<span class="token punctuation">.</span><span class="token function">NewCmdSet</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span>        <span class="token operator">...</span><span class="token punctuation">}</span></code></pre><h3 id="å¤„ç†ç”¨æˆ·å‘½ä»¤"><a href="#å¤„ç†ç”¨æˆ·å‘½ä»¤" class="headerlink" title="å¤„ç†ç”¨æˆ·å‘½ä»¤"></a>å¤„ç†ç”¨æˆ·å‘½ä»¤</h3><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/9e991415386e4cf155a24b1da15becaa390438d8/staging/src/k8s.io/kubectl/pkg/cmd/create/create.go#L116" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/kubectl/pkg/cmd/create/create.go</a></p><p>åŒ¹é…ä¸Š <code>create</code> å‘½ä»¤è°ƒç”¨ <code>o.RunCreate(f,cmd)</code> å‡½æ•°æ‰§è¡Œ</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewCmdCreate</span><span class="token punctuation">(</span>f cmdutil<span class="token punctuation">.</span>Factory<span class="token punctuation">,</span> ioStreams genericclioptions<span class="token punctuation">.</span>IOStreams<span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>    o <span class="token operator">:=</span> <span class="token function">NewCreateOptions</span><span class="token punctuation">(</span>ioStreams<span class="token punctuation">)</span>    cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>        Use<span class="token punctuation">:</span>                   <span class="token string">"create -f FILENAME"</span><span class="token punctuation">,</span>        DisableFlagsInUseLine<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        Short<span class="token punctuation">:</span>                 i18n<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token string">"Create a resource from a file or from stdin."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        Long<span class="token punctuation">:</span>                  createLong<span class="token punctuation">,</span>        Example<span class="token punctuation">:</span>               createExample<span class="token punctuation">,</span>        Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// åˆæ³•æ€§æ£€æŸ¥</span>            cmdutil<span class="token punctuation">.</span><span class="token function">CheckErr</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>            cmdutil<span class="token punctuation">.</span><span class="token function">CheckErr</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">ValidateArgs</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// æ‰§è¡Œå‘½ä»¤</span>            cmdutil<span class="token punctuation">.</span><span class="token function">CheckErr</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">RunCreate</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// åˆ›å»ºå­å‘½ä»¤</span>    cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token function">NewCmdCreateNamespace</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ioStreams<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span>    <span class="token keyword">return</span> cmd<span class="token punctuation">}</span></code></pre><p>åœ¨ RunCreate ä¸­æ—¶å¯¹è¯¥å‘½ä»¤çš„å…·ä½“å¤„ç†ï¼Œé€šè¿‡é“¾å¼ååº”</p><p><code>f.NewBuilder().Unstructured().Schema(schema).ContinueOnError().NamespaceParam(cmdNamespace).DefaultNamespace().FilenameParam().LabelSelectorParam().Flatten().Do()</code></p><p>ä¸ºæ‰§è¡Œå‘½ä»¤åšå¥½æ•°æ®å‡†å¤‡ã€‚è¿™æ®µä»£ç æ‰€åšçš„äº‹æƒ…æ˜¯å°†å‘½ä»¤è¡Œæ¥æ”¶åˆ°çš„å‚æ•°è½¬åŒ–ä¸ºä¸€ä¸ªèµ„æºçš„åˆ—ã€‚å®ƒä¹Ÿè´Ÿè´£åˆ›å»ºä¸€ä¸ªå¯ä»¥ç”¨æ¥è¿­ä»£è®¿é—®æ‰€æœ‰èµ„æºçš„ Visitor ç»“æ„ã€‚è¿™ä¸ªå‘½ä»¤æ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†Builderæ¨¡å¼çš„å˜ç§ï¼Œä½¿ç”¨ç‹¬ç«‹çš„å‡½æ•°åšå„è‡ªçš„æ•°æ®åˆå§‹åŒ–å·¥ä½œã€‚</p><p>ä¸€æ—¦æ‰€æœ‰çš„åˆå§‹åŒ–éƒ½å®Œæˆï¼Œresource.NewBuilder å‡½æ•°ä¼šè°ƒç”¨ Do å‡½æ•°ã€‚<code>Do()</code> å‡½æ•°æ˜¯æ³¨å†Œå…·ä½“å‘ Apiserver è¯·æ±‚æ•°æ®ï¼Œå’Œå°†è¿”å›æ•°æ®è½¬åŒ–ä¸ºé€šç”¨ç»“æ„çš„å‡½æ•°ã€‚å®ƒä¼šè¿”å›ä¸€ä¸ªResultå¯¹è±¡ï¼Œå¹¶ä¸”å°†æ‰§è¡Œå¯¹èµ„æºçš„åˆ›å»ºã€‚Do å‡½æ•°è¿˜ä¼šåˆ›å»ºä¸€ä¸ªVisitorå¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥éå†æ‰€æœ‰å…³è”åˆ° resource.NewBuilder æ‰§è¡Œè¿‡ç¨‹çš„èµ„æºã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>CreateOptions<span class="token punctuation">)</span> <span class="token function">RunCreate</span><span class="token punctuation">(</span>f cmdutil<span class="token punctuation">.</span>Factory<span class="token punctuation">,</span> cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><span class="token operator">...</span>    r <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">NewBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  <span class="token comment" spellcheck="true">// Builder è®¾è®¡æ¨¡å¼</span>        <span class="token function">Unstructured</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>   <span class="token comment" spellcheck="true">// æ”¯æŒéç»“æ„åŒ–æ•°æ®</span>        <span class="token function">Schema</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">ContinueOnError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">NamespaceParam</span><span class="token punctuation">(</span>cmdNamespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DefaultNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">FilenameParam</span><span class="token punctuation">(</span>enforceNamespace<span class="token punctuation">,</span> <span class="token operator">&amp;</span>o<span class="token punctuation">.</span>FilenameOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">LabelSelectorParam</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment" spellcheck="true">// è®¾ç½®ç”¨æˆ·çš„æ ‡ç­¾é€‰æ‹©</span>        <span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  <span class="token comment" spellcheck="true">// å†³å®šä»¥ä½•ç§æ–¹å¼ä» Kubernetes çš„è¿”å›æ•°æ®ä¸­æå–æ•°æ®</span>        <span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ‰§è¡Œå‘½ä»¤è·å–æ•°æ®</span>    <span class="token comment" spellcheck="true">// åˆ›å»º Visitor å¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥éå†æ‰€æœ‰å…³è”åˆ° Builder æ‰§è¡Œè¿‡ç¨‹çš„èµ„æº</span>    err <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>resource<span class="token punctuation">.</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><span class="token operator">...</span>        <span class="token keyword">return</span> o<span class="token punctuation">.</span><span class="token function">PrintObj</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ‰“å°å¯¹è±¡</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">}</span></code></pre><h3 id="å‘é€è¯·æ±‚å¹¶è·å–æ•°æ®"><a href="#å‘é€è¯·æ±‚å¹¶è·å–æ•°æ®" class="headerlink" title="å‘é€è¯·æ±‚å¹¶è·å–æ•°æ®"></a>å‘é€è¯·æ±‚å¹¶è·å–æ•°æ®</h3><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/cli-runtime/pkg/resource/builder.go#L1098" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/builder.go </a></p><p>é‡è¦å‡½æ•°ï¼š</p><ul><li><code>RetrieveLazy</code> ä¸­æ³¨å†Œäº†ä» Apiserver è·å–æ•°æ®çš„æ“ä½œã€‚</li><li><code>NewDecoratedVisitor</code> ä¸­æ³¨å†Œäº†ä»è·å–åˆ°çš„æ•°æ®ç»“æ„ä¸­è½¬åŒ–å‡ºé€šç”¨æ•°æ®çš„æ–¹æ³•ã€‚</li></ul><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{</span>    r <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">visitorResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>mapper <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">Mapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> r<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> r    <span class="token punctuation">}</span>    <span class="token keyword">if</span> b<span class="token punctuation">.</span>flatten <span class="token punctuation">{</span>        r<span class="token punctuation">.</span>visitor <span class="token operator">=</span> <span class="token function">NewFlattenListVisitor</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>visitor<span class="token punctuation">,</span> b<span class="token punctuation">.</span>objectTyper<span class="token punctuation">,</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ³¨å†Œè·å–æ•°æ®å‰çš„åŠ¨ä½œ</span>    helpers <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>VisitorFunc<span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">if</span> b<span class="token punctuation">.</span>defaultNamespace <span class="token punctuation">{</span>        helpers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>helpers<span class="token punctuation">,</span> <span class="token function">SetNamespace</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> b<span class="token punctuation">.</span>requireNamespace <span class="token punctuation">{</span>        helpers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>helpers<span class="token punctuation">,</span> <span class="token function">RequireNamespace</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    helpers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>helpers<span class="token punctuation">,</span> FilterNamespace<span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">// æ³¨å†Œä» Apiserver è·å–æ•°æ®çš„æ–¹æ³•</span>    <span class="token keyword">if</span> b<span class="token punctuation">.</span>requireObject <span class="token punctuation">{</span>        helpers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>helpers<span class="token punctuation">,</span> RetrieveLazy<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ³¨å†Œä»è¿”å›æ•°æ®ä¸­æå–ä¿¡æ¯çš„æ–¹æ³•</span>    <span class="token keyword">if</span> b<span class="token punctuation">.</span>continueOnError <span class="token punctuation">{</span>        r<span class="token punctuation">.</span>visitor <span class="token operator">=</span> <span class="token function">NewDecoratedVisitor</span><span class="token punctuation">(</span>ContinueOnErrorVisitor<span class="token punctuation">{</span>r<span class="token punctuation">.</span>visitor<span class="token punctuation">}</span><span class="token punctuation">,</span> helpers<span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        r<span class="token punctuation">.</span>visitor <span class="token operator">=</span> <span class="token function">NewDecoratedVisitor</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>visitor<span class="token punctuation">,</span> helpers<span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> r<span class="token punctuation">}</span></code></pre><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// RetrieveLazy updates the object if it has not been loaded yet.</span><span class="token keyword">func</span> <span class="token function">RetrieveLazy</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> info<span class="token punctuation">.</span>Object <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> info<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ä» API server è·å–æ•°æ®</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>è€Œ NewDecoratedVisitor å‡½æ•°æ³¨å†Œäº†æ•°æ®å¤„ç†çš„å…³é”®å‡½æ•° Visitï¼Œ è¿™ä¸ªå‡½æ•°å¯ä»¥ä½¿ç”¨æˆ·å¯ä»¥å°†æ¥è‡ª API server çš„æ•°æ®è½¬åŒ–ä¸ºé€šç”¨æ•°æ®é›†åˆã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Visit implements Visitor</span><span class="token keyword">func</span> <span class="token punctuation">(</span>v DecoratedVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> v<span class="token punctuation">.</span>visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> v<span class="token punctuation">.</span>decorators <span class="token punctuation">{</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span>decorators<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> err            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h3 id="æ‰“å°è¿”å›æ•°æ®"><a href="#æ‰“å°è¿”å›æ•°æ®" class="headerlink" title="æ‰“å°è¿”å›æ•°æ®"></a>æ‰“å°è¿”å›æ•°æ®</h3><pre class=" language-go"><code class="language-go">err <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>resource<span class="token punctuation">.</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> o<span class="token punctuation">.</span>DryRunStrategy <span class="token operator">!=</span> cmdutil<span class="token punctuation">.</span>DryRunClient <span class="token punctuation">{</span>            obj<span class="token punctuation">,</span> err <span class="token operator">:=</span> resource<span class="token punctuation">.</span>                <span class="token function">NewHelper</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Client<span class="token punctuation">,</span> info<span class="token punctuation">.</span>Mapping<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">DryRun</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>DryRunStrategy <span class="token operator">==</span> cmdutil<span class="token punctuation">.</span>DryRunServer<span class="token punctuation">)</span><span class="token punctuation">.</span>                <span class="token function">Create</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>            info<span class="token punctuation">.</span><span class="token function">Refresh</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token operator">...</span>        <span class="token comment" spellcheck="true">// æ‰“å°æ•°æ® </span>        <span class="token keyword">return</span> o<span class="token punctuation">.</span><span class="token function">PrintObj</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>åˆ°æ­¤ Kubectl çš„æµç¨‹åˆ†æå®Œæ¯•ã€‚</p><h2 id="é‡è¦æ•°æ®ç»“æ„åŠå‡½æ•°"><a href="#é‡è¦æ•°æ®ç»“æ„åŠå‡½æ•°" class="headerlink" title="é‡è¦æ•°æ®ç»“æ„åŠå‡½æ•°"></a>é‡è¦æ•°æ®ç»“æ„åŠå‡½æ•°</h2><h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><p>åœ¨ Kubernetes ä¸Šï¼Œé€šå¸¸éœ€è¦ Client æ¥è®¿é—® Kubernetes ä¸­çš„å¯¹è±¡ï¼Œç›®å‰æœ€å¸¸ç”¨çš„æ˜¯RESTClient, DynamicClientå’ŒClientSet è¿™ä¸‰ç§Clientã€‚</p><h4 id="RESTClient"><a href="#RESTClient" class="headerlink" title="RESTClient"></a>RESTClient</h4><p>RESTClient æ˜¯ Kubernetesæœ€åŸºç¡€çš„ Clientï¼Œç›´æ¥è´Ÿè´£ä¸ Request(RESTClientä¸­çš„æ¦‚å¿µ)æ‰“äº¤é“ã€‚ä¸‹é¢çš„ Demo å°±æè¿°å¦‚ä½•ç”Ÿæˆä¸€ä¸ªRESTClientï¼Œå¹¶ç”¨è¯¥RESTClientè·å–æŸå…·ä½“ Pod çš„è¯¦ç»†ä¿¡æ¯ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"flag"</span>    <span class="token string">"fmt"</span>    <span class="token string">"k8s.io/client-go/pkg/runtime"</span>    <span class="token string">"k8s.io/client-go/pkg/runtime/serializer"</span>    <span class="token string">"k8s.io/client-go/pkg/api"</span>    v1 <span class="token string">"k8s.io/client-go/pkg/api/v1"</span>    <span class="token string">"k8s.io/client-go/pkg/api/unversioned"</span>    <span class="token string">"k8s.io/client-go/rest"</span>    <span class="token string">"k8s.io/client-go/tools/clientcmd"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    kubeconfig <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"kubeconfig"</span><span class="token punctuation">,</span> <span class="token string">"/root/.kube/config"</span><span class="token punctuation">,</span> <span class="token string">"Path to a kube config. Only required if out-of-cluster."</span><span class="token punctuation">)</span>    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    config<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientcmd<span class="token punctuation">.</span><span class="token function">BuildConfigFromFlags</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token operator">*</span>kubeconfig<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"BuildConfigFromFlags error"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    groupversion <span class="token operator">:=</span> <span class="token operator">&amp;</span>unversioned<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"v1"</span><span class="token punctuation">}</span>    config<span class="token punctuation">.</span>GroupVersion <span class="token operator">=</span> groupversion    config<span class="token punctuation">.</span>APIPath <span class="token operator">=</span> <span class="token string">"/api"</span>    config<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> runtime<span class="token punctuation">.</span>ContentTypeJSON    config<span class="token punctuation">.</span>NegotiatedSerializer <span class="token operator">=</span> serializer<span class="token punctuation">.</span>DirectCodecFactory<span class="token punctuation">{</span>CodecFactory<span class="token punctuation">:</span> api<span class="token punctuation">.</span>Codecs<span class="token punctuation">}</span>    restClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> rest<span class="token punctuation">.</span><span class="token function">RESTClientFor</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"RESTClientFor error"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    pod <span class="token operator">:=</span> v1<span class="token punctuation">.</span>Pod<span class="token punctuation">{</span><span class="token punctuation">}</span>    err <span class="token operator">=</span> restClient<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"pods"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Namespace</span><span class="token punctuation">(</span><span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token string">"nginx-1487191267-b4w5j"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Into</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pod<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="DynamicClient"><a href="#DynamicClient" class="headerlink" title="DynamicClient"></a>DynamicClient</h4><p>RESTClientéœ€è¦è‡ªå·±è®¾ç½®è¯·æ±‚å„å±æ€§ï¼Œç”¨èµ·æ¥å¾ˆä¸æ–¹ä¾¿ã€‚DynamicClientæ˜¯å¯¹RESTClientçš„å°è£…ï¼Œæ”¯æŒåŠ¨æ€è®¾ç½®è®¿é—®ç±»å‹ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"flag"</span>    <span class="token string">"fmt"</span>    <span class="token string">"reflect"</span>    <span class="token string">"encoding/json"</span>    <span class="token string">"k8s.io/client-go/pkg/api/v1"</span>    <span class="token string">"k8s.io/client-go/pkg/api/unversioned"</span>    <span class="token string">"k8s.io/client-go/dynamic"</span>    <span class="token string">"k8s.io/client-go/tools/clientcmd"</span>    <span class="token string">"k8s.io/client-go/rest"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    kubeconfig <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"kubeconfig"</span><span class="token punctuation">,</span> <span class="token string">"/root/.kube/config"</span><span class="token punctuation">,</span> <span class="token string">"Path to a kube config. Only required if out-of-cluster."</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>kubeconfig<span class="token punctuation">)</span>    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    config<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientcmd<span class="token punctuation">.</span><span class="token function">BuildConfigFromFlags</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token operator">*</span>kubeconfig<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error1"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ç”ŸæˆdynamicClient</span>    gv <span class="token operator">:=</span> <span class="token operator">&amp;</span>unversioned<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"v1"</span><span class="token punctuation">}</span>    resource <span class="token operator">:=</span> <span class="token operator">&amp;</span>unversioned<span class="token punctuation">.</span>APIResource<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"pods"</span><span class="token punctuation">,</span> Namespaced<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>    config<span class="token punctuation">.</span>ContentConfig <span class="token operator">=</span> rest<span class="token punctuation">.</span>ContentConfig<span class="token punctuation">{</span>GroupVersion<span class="token punctuation">:</span> gv<span class="token punctuation">}</span>    config<span class="token punctuation">.</span>APIPath <span class="token operator">=</span> <span class="token string">"/api"</span>    dynamicClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> dynamic<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"dynamic NewCLient error"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è·å–æ‰€æœ‰namespaceçš„podåˆ—è¡¨</span>    obj<span class="token punctuation">,</span> err <span class="token operator">:=</span> dynamicClient<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"dynamicClient Resource error"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    js<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    podlist <span class="token operator">:=</span> v1<span class="token punctuation">.</span>PodList<span class="token punctuation">{</span><span class="token punctuation">}</span>    json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>js<span class="token punctuation">,</span> <span class="token operator">&amp;</span>podlist<span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>podlist<span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"------------------------"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// è·å–å…·ä½“å…·ä½“pod</span>    obj<span class="token punctuation">,</span> err <span class="token operator">=</span> dynamicClient<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"nginx-1487191267-b4w5j"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"dynamicClient Resource error"</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        js<span class="token punctuation">,</span> err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        pod <span class="token operator">:=</span> v1<span class="token punctuation">.</span>Pod<span class="token punctuation">{</span><span class="token punctuation">}</span>        json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>js<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pod<span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="ClientSet"><a href="#ClientSet" class="headerlink" title="ClientSet"></a>ClientSet</h4><p>ClientSetä¹Ÿæ˜¯å¯¹RESTClientçš„ä¸€ç§å°è£…ï¼Œä¸DynamicClientä¸åŒçš„æ˜¯ï¼ŒClientSetæ”¯æŒè¡ç”Ÿå‡ºå…·ä½“èµ„æºçš„Clientï¼Œå¦‚PodClientç­‰ã€‚ClientSetæ˜¯Kubernetesç”¨çš„æœ€å¤šçš„Clientç±»å‹ ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"flag"</span>    <span class="token string">"fmt"</span>    apiv1 <span class="token string">"k8s.io/client-go/pkg/api/v1"</span>    <span class="token string">"k8s.io/client-go/kubernetes"</span>    <span class="token string">"k8s.io/client-go/tools/clientcmd"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    kubeconfig <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"kubeconfig"</span><span class="token punctuation">,</span> <span class="token string">"/root/.kube/config"</span><span class="token punctuation">,</span> <span class="token string">"Path to a kube config. Only required if out-of-cluster."</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>kubeconfig<span class="token punctuation">)</span>    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    config<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientcmd<span class="token punctuation">.</span><span class="token function">BuildConfigFromFlags</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token operator">*</span>kubeconfig<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ç”Ÿæˆclientset</span>    clientset<span class="token punctuation">,</span> err <span class="token operator">:=</span> kubernetes<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ç”ŸæˆpodCLient</span>    podClient <span class="token operator">:=</span> clientset<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>    pods<span class="token punctuation">,</span> err <span class="token operator">:=</span> podClient<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>apiv1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pod <span class="token operator">:=</span> <span class="token keyword">range</span> pods<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="Builder"><a href="#Builder" class="headerlink" title="Builder"></a>Builder</h3><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/cli-runtime/pkg/resource/builder.go#L49" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/builder.go</a></p><p>Builder çš„ä½œç”¨æ˜¯å°†å‘½ä»¤è¡Œè¾“å…¥çš„å‚æ•°è½¬æ¢ä¸ºèµ„æºåˆ—è¡¨ï¼Œç„¶åé€šè¿‡ visitor æ¥å£è¿­ä»£èµ„æºã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> Builder <span class="token keyword">struct</span> <span class="token punctuation">{</span>    categoryExpanderFn CategoryExpanderFunc    mapper <span class="token operator">*</span>mapper    clientConfigFn ClientConfigFunc    restMapperFn RESTMapperFunc    objectTyper runtime<span class="token punctuation">.</span>ObjectTyper    negotiatedSerializer runtime<span class="token punctuation">.</span>NegotiatedSerializer    local <span class="token builtin">bool</span>    errs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span>    paths  <span class="token punctuation">[</span><span class="token punctuation">]</span>Visitor    stream <span class="token builtin">bool</span>    dir    <span class="token builtin">bool</span>    labelSelector     <span class="token operator">*</span><span class="token builtin">string</span>    fieldSelector     <span class="token operator">*</span><span class="token builtin">string</span>    selectAll         <span class="token builtin">bool</span>    limitChunks       <span class="token builtin">int64</span>    requestTransforms <span class="token punctuation">[</span><span class="token punctuation">]</span>RequestTransform    resources <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>    namespace    <span class="token builtin">string</span>    allNamespace <span class="token builtin">bool</span>    names        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>    resourceTuples <span class="token punctuation">[</span><span class="token punctuation">]</span>resourceTuple    defaultNamespace <span class="token builtin">bool</span>    requireNamespace <span class="token builtin">bool</span>    flatten <span class="token builtin">bool</span>    latest  <span class="token builtin">bool</span>    requireObject <span class="token builtin">bool</span>    singleResourceType <span class="token builtin">bool</span>    continueOnError    <span class="token builtin">bool</span>    singleItemImplied <span class="token builtin">bool</span>    export <span class="token builtin">bool</span>    schema ContentValidator<span class="token punctuation">}</span>## Method## path<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Path</span><span class="token punctuation">(</span>paths <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>## selector<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">SelectorParam</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Selector</span><span class="token punctuation">(</span>selector labels<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">SelectAllParam</span><span class="token punctuation">(</span>selectAll <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder<span class="token punctuation">{</span><span class="token punctuation">}</span>## namespace<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">NamespaceParam</span><span class="token punctuation">(</span>namespace <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">DefaultNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">AllNamespaces</span><span class="token punctuation">(</span>allNamespace <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>## resource<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ResourceNames</span><span class="token punctuation">(</span>resource <span class="token builtin">string</span><span class="token punctuation">,</span> names <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ResourceTypes</span><span class="token punctuation">(</span>types <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ResourceTypeOrNameArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder<span class="token punctuation">{</span><span class="token punctuation">}</span>## url<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">URL</span><span class="token punctuation">(</span>urls <span class="token operator">...</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>## stream<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Stream</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span>## stdin<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Stdin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Builderæ˜¯ Kubectl å‘½ä»¤è¡Œä¿¡æ¯çš„å†…éƒ¨è½½ä½“ï¼Œå¯ä»¥é€šè¿‡ Builder ç”ŸæˆResultå¯¹è±¡ã€‚Builderå¤§å¤šæ–¹æ³•æ”¯æŒé“¾å¼è°ƒç”¨ï¼š</p><pre class=" language-go"><code class="language-go">resource<span class="token punctuation">.</span><span class="token function">NewBuilder</span><span class="token punctuation">(</span>mapper<span class="token punctuation">,</span> typer<span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">ClientMapperFunc</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>UnstructuredClientForMapping<span class="token punctuation">)</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span>UnstructuredJSONScheme<span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">NamespaceParam</span><span class="token punctuation">(</span>cmdNamespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DefaultNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AllNamespaces</span><span class="token punctuation">(</span>allNamespaces<span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">FilenameParam</span><span class="token punctuation">(</span>enforceNamespace<span class="token punctuation">,</span> <span class="token operator">&amp;</span>options<span class="token punctuation">.</span>FilenameOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">SelectorParam</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">ExportParam</span><span class="token punctuation">(</span>export<span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">ResourceTypeOrNameArgs</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">ContinueOnError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">Latest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h4 id="NewBuilder"><a href="#NewBuilder" class="headerlink" title="NewBuilder()"></a>NewBuilder()</h4><p>NewBuilder() ç”Ÿæˆä¸€ä¸ªBuilderï¼Œæ–°çš„ Builderåªè®¾ç½®äº† mapperï¼ŒåŠæ ‡è®° requireObject ä¸ºtrueã€‚</p><pre><code>func NewBuilder(mapper meta.RESTMapper, typer runtime.ObjectTyper, clientMapper ClientMapper, decoder runtime.Decoder) *Builder {    return &amp;Builder{        // æŠŠRESTMapper, ObjectTyper, ClientMapper, Decoderå°è£…æˆkubectlçš„Mapper        mapper:        &amp;Mapper{typer, mapper, clientMapper, decoder},        requireObject: true,    }}</code></pre><h4 id="Do"><a href="#Do" class="headerlink" title="Do()"></a>Do()</h4><p>Do() å…ˆè°ƒç”¨ visitorResult() ç”Ÿæˆ Result å¯¹è±¡ï¼Œç„¶åè®¾ç½® Result å¯¹è±¡ä¸­çš„ Visitorã€‚</p><pre><code>// è¿”å›ä¸€ä¸ª *Resultï¼ŒResultå¯ä»¥ä½¿Infos()æˆ–Object()æ¥è·å–æ‰§è¡Œç»“æœ// å…³äº visitor å±‚å±‚å°è£…ï¼Œå¯ä»¥ç†è§£ä¸ºæ¯ä¸ª visitor å®ç°ä¸€å®šçš„åŠŸèƒ½ï¼Œç„¶åæŒ‰ä¸€å®šçš„é¡ºåºæ¥æ‰§è¡Œè¿™äº›åŠŸèƒ½func (b *Builder) Do() *Result {    r := b.visitorResult()    if r.err != nil {        return r    }    // å±‚å±‚å°è£…visitor    if b.flatten {        r.visitor = NewFlattenListVisitor(r.visitor, b.mapper)    }    helpers := []VisitorFunc{}    if b.defaultNamespace {        helpers = append(helpers, SetNamespace(b.namespace))    }    if b.requireNamespace {        helpers = append(helpers, RequireNamespace(b.namespace))    }    helpers = append(helpers, FilterNamespace)    if b.requireObject {        helpers = append(helpers, RetrieveLazy)    }    r.visitor = NewDecoratedVisitor(r.visitor, helpers...)    if b.continueOnError {        r.visitor = ContinueOnErrorVisitor{r.visitor}    }    return r}</code></pre><h4 id="visitResult"><a href="#visitResult" class="headerlink" title="visitResult()"></a>visitResult()</h4><p>visitResult() ä¼šæ ¹æ® Builder ä¸­å­—æ®µçš„è®¾ç½®æƒ…å†µæ¥ç”Ÿæˆä¸åŒçš„ Resultã€‚ä¸€èˆ¬æ¥è¯´ b.paths, b.selectors, b.resourceTuples, b.names åªéœ€è®¾ç½®ä¸€ä¸ªå³å¯ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// è¿”å›ä¸€ä¸ªresultå¯¹è±¡</span><span class="token comment" spellcheck="true">// visitByPaths()ç­‰ä¼šç”Ÿæˆinfoå¯¹è±¡</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">visitorResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token operator">/</span><span class="token comment" spellcheck="true">/***è®¾ç½®selectorä¸ºlabels.Everything()***/</span><span class="token operator">/</span>    <span class="token keyword">if</span> b<span class="token punctuation">.</span>selectAll <span class="token punctuation">{</span>        b<span class="token punctuation">.</span>selector <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token function">Everything</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// visit items specified by paths</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">visitByPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// visit selectors</span>    <span class="token keyword">if</span> b<span class="token punctuation">.</span>selector <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">visitBySelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// visit items specified by resource and name</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">visitByResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// visit items specified by name</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>names<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">visitByName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"resource(s) were provided, but no name, label selector, or --all flag specified"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> missingResourceError<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="visitBySelector"><a href="#visitBySelector" class="headerlink" title="visitBySelector()"></a>visitBySelector()</h4><p>visitBySelector()ç”Ÿæˆä¸€ä¸ªSelector visitorï¼Œç„¶åæŠŠè¯¥visitorå°è£…æˆResultå¹¶è¿”å›ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// selector visitor çš„ visitFunc ä¼šç”Ÿæˆ Info</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">visitBySelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>names<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"name cannot be provided when a selector is specified"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"selectors and the all flag cannot be used when passing resource/name arguments"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"at least one resource must be specified to use a selector"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    mappings<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">resourceMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>    <span class="token punctuation">}</span>    visitors <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Visitor<span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> mapping <span class="token operator">:=</span> <span class="token keyword">range</span> mappings <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ç”Ÿæˆ client</span>        client<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">ClientForMapping</span><span class="token punctuation">(</span>mapping<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>        <span class="token punctuation">}</span>        selectorNamespace <span class="token operator">:=</span> b<span class="token punctuation">.</span>namespace        <span class="token keyword">if</span> mapping<span class="token punctuation">.</span>Scope<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> meta<span class="token punctuation">.</span>RESTScopeNameNamespace <span class="token punctuation">{</span>            selectorNamespace <span class="token operator">=</span> <span class="token string">""</span>        <span class="token punctuation">}</span>        visitors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>visitors<span class="token punctuation">,</span> <span class="token function">NewSelector</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> mapping<span class="token punctuation">,</span> selectorNamespace<span class="token punctuation">,</span> b<span class="token punctuation">.</span>selector<span class="token punctuation">,</span> b<span class="token punctuation">.</span>export<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> b<span class="token punctuation">.</span>continueOnError <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>visitor<span class="token punctuation">:</span> <span class="token function">EagerVisitorList</span><span class="token punctuation">(</span>visitors<span class="token punctuation">)</span><span class="token punctuation">,</span> sources<span class="token punctuation">:</span> visitors<span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>visitor<span class="token punctuation">:</span> <span class="token function">VisitorList</span><span class="token punctuation">(</span>visitors<span class="token punctuation">)</span><span class="token punctuation">,</span> sources<span class="token punctuation">:</span> visitors<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="visitByResource"><a href="#visitByResource" class="headerlink" title="visitByResource()"></a>visitByResource()</h4><p>visitByResource()ä½¿ç”¨ resourceTuples ç”Ÿæˆ Info ï¼ŒInfo æœ¬èº«ä¹Ÿæ˜¯ä¸ª visitorï¼Œæ‰€ä»¥æŠŠ Info æ‰“åŒ…æˆResult å¹¶è¿”å›ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">//é€šè¿‡ resource ç”Ÿæˆ info</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">visitByResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{</span>    isSingular <span class="token operator">:=</span> b<span class="token punctuation">.</span>singular    <span class="token keyword">if</span> <span class="token operator">!</span>isSingular <span class="token punctuation">{</span>        isSingular <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"you may not specify individual resources and bulk resources in the same call"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// retrieve one client for each resource</span>    mappings<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">resourceTupleMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>    <span class="token punctuation">}</span>    clients <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>RESTClient<span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> mapping <span class="token operator">:=</span> <span class="token keyword">range</span> mappings <span class="token punctuation">{</span>        s <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> mapping<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">.</span><span class="token function">GroupVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> clients<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        client<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">ClientForMapping</span><span class="token punctuation">(</span>mapping<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>        <span class="token punctuation">}</span>        clients<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">=</span> client    <span class="token punctuation">}</span>    items <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Visitor<span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tuple <span class="token operator">:=</span> <span class="token keyword">range</span> b<span class="token punctuation">.</span>resourceTuples <span class="token punctuation">{</span>        mapping<span class="token punctuation">,</span> ok <span class="token operator">:=</span> mappings<span class="token punctuation">[</span>tuple<span class="token punctuation">.</span>Resource<span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"resource %q is not recognized: %v"</span><span class="token punctuation">,</span> tuple<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> mappings<span class="token punctuation">)</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        s <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> mapping<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">.</span><span class="token function">GroupVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span>        client<span class="token punctuation">,</span> ok <span class="token operator">:=</span> clients<span class="token punctuation">[</span>s<span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"could not find a client for resource %q"</span><span class="token punctuation">,</span> tuple<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        selectorNamespace <span class="token operator">:=</span> b<span class="token punctuation">.</span>namespace        <span class="token keyword">if</span> mapping<span class="token punctuation">.</span>Scope<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> meta<span class="token punctuation">.</span>RESTScopeNameNamespace <span class="token punctuation">{</span>            selectorNamespace <span class="token operator">=</span> <span class="token string">""</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>                errMsg <span class="token operator">:=</span> <span class="token string">"namespace may not be empty when retrieving a resource by name"</span>                <span class="token keyword">if</span> b<span class="token punctuation">.</span>allNamespace <span class="token punctuation">{</span>                    errMsg <span class="token operator">=</span> <span class="token string">"a resource cannot be retrieved by name across all namespaces"</span>                <span class="token punctuation">}</span>                <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//ç”Ÿæˆ Info</span>        info <span class="token operator">:=</span> <span class="token function">NewInfo</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> mapping<span class="token punctuation">,</span> selectorNamespace<span class="token punctuation">,</span> tuple<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> b<span class="token punctuation">.</span>export<span class="token punctuation">)</span>        items <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> info<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> visitors Visitor    <span class="token keyword">if</span> b<span class="token punctuation">.</span>continueOnError <span class="token punctuation">{</span>        visitors <span class="token operator">=</span> <span class="token function">EagerVisitorList</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        visitors <span class="token operator">=</span> <span class="token function">VisitorList</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> visitor<span class="token punctuation">:</span> visitors<span class="token punctuation">,</span> sources<span class="token punctuation">:</span> items<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="visitByName"><a href="#visitByName" class="headerlink" title="visitByName()"></a>visitByName()</h4><p>visitByName()å…ˆé€šè¿‡b.namesæ¥ç”Ÿæˆinfoï¼Œç„¶åå°è£…æˆResultè¿”å›ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">//é€šè¿‡ resource name ç”Ÿæˆ Info</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">visitByName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{</span>    isSingular <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>names<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"when paths, URLs, or stdin is provided as input, you may not specify a resource by arguments as well"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"you must provide a resource and a resource name together"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"you must specify only one resource"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    mappings<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">resourceMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>    <span class="token punctuation">}</span>    mapping <span class="token operator">:=</span> mappings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    client<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">ClientForMapping</span><span class="token punctuation">(</span>mapping<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>    <span class="token punctuation">}</span>    selectorNamespace <span class="token operator">:=</span> b<span class="token punctuation">.</span>namespace    <span class="token keyword">if</span> mapping<span class="token punctuation">.</span>Scope<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> meta<span class="token punctuation">.</span>RESTScopeNameNamespace <span class="token punctuation">{</span>        selectorNamespace <span class="token operator">=</span> <span class="token string">""</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>            errMsg <span class="token operator">:=</span> <span class="token string">"namespace may not be empty when retrieving a resource by name"</span>            <span class="token keyword">if</span> b<span class="token punctuation">.</span>allNamespace <span class="token punctuation">{</span>                errMsg <span class="token operator">=</span> <span class="token string">"a resource cannot be retrieved by name across all namespaces"</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    visitors <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Visitor<span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> name <span class="token operator">:=</span> <span class="token keyword">range</span> b<span class="token punctuation">.</span>names <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ç”Ÿæˆ Info</span>        info <span class="token operator">:=</span> <span class="token function">NewInfo</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> mapping<span class="token punctuation">,</span> selectorNamespace<span class="token punctuation">,</span> name<span class="token punctuation">,</span> b<span class="token punctuation">.</span>export<span class="token punctuation">)</span>        visitors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>visitors<span class="token punctuation">,</span> info<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> isSingular<span class="token punctuation">,</span> visitor<span class="token punctuation">:</span> <span class="token function">VisitorList</span><span class="token punctuation">(</span>visitors<span class="token punctuation">)</span><span class="token punctuation">,</span> sources<span class="token punctuation">:</span> visitors<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="visitByPaths"><a href="#visitByPaths" class="headerlink" title="visitByPaths()"></a>visitByPaths()</h4><p>visitByPaths() æ ¹æ® b.Paths ç”Ÿæˆ Resultsã€‚å› ä¸º b.Paths æœ¬èº«å°±æ˜¯ä¸ª Visitor æ•°ç»„ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">//Paths ä¸­çš„ Visitor ä¼šç”Ÿæˆ Info</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">visitByPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{</span>    singular <span class="token operator">:=</span> <span class="token operator">!</span>b<span class="token punctuation">.</span>dir <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>b<span class="token punctuation">.</span>stream <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> singular<span class="token punctuation">,</span> err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"when paths, URLs, or stdin is provided as input, you may not specify resource arguments as well"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>names<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"name cannot be provided when a path is specified"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>err<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"resource/name arguments cannot be provided when a path is specified"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> visitors Visitor    <span class="token keyword">if</span> b<span class="token punctuation">.</span>continueOnError <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//æ­¤å¤„ path ä¹Ÿæ˜¯ Visitor</span>        <span class="token comment" spellcheck="true">//FileVisitor, StreamVisitor ä¼šç”Ÿæˆ Info</span>        visitors <span class="token operator">=</span> <span class="token function">EagerVisitorList</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        visitors <span class="token operator">=</span> <span class="token function">VisitorList</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// only items from disk can be refetched</span>    <span class="token keyword">if</span> b<span class="token punctuation">.</span>latest <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// must flatten lists prior to fetching</span>        <span class="token keyword">if</span> b<span class="token punctuation">.</span>flatten <span class="token punctuation">{</span>            visitors <span class="token operator">=</span> <span class="token function">NewFlattenListVisitor</span><span class="token punctuation">(</span>visitors<span class="token punctuation">,</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// must set namespace prior to fetching</span>        <span class="token keyword">if</span> b<span class="token punctuation">.</span>defaultNamespace <span class="token punctuation">{</span>            visitors <span class="token operator">=</span> <span class="token function">NewDecoratedVisitor</span><span class="token punctuation">(</span>visitors<span class="token punctuation">,</span> <span class="token function">SetNamespace</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        visitors <span class="token operator">=</span> <span class="token function">NewDecoratedVisitor</span><span class="token punctuation">(</span>visitors<span class="token punctuation">,</span> RetrieveLatest<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> b<span class="token punctuation">.</span>selector <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        visitors <span class="token operator">=</span> <span class="token function">NewFilteredVisitor</span><span class="token punctuation">(</span>visitors<span class="token punctuation">,</span> <span class="token function">FilterBySelector</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Result<span class="token punctuation">{</span>singular<span class="token punctuation">:</span> singular<span class="token punctuation">,</span> visitor<span class="token punctuation">:</span> visitors<span class="token punctuation">,</span> sources<span class="token punctuation">:</span> b<span class="token punctuation">.</span>paths<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>æ¥ä¸‹æ¥æ˜¯Builder çš„å­—æ®µè®¾ç½®å‡½æ•°</strong></p><h4 id="Schema"><a href="#Schema" class="headerlink" title="Schema()"></a>Schema()</h4><p>Schema() è®¾ç½®Builderçš„ schema å­—æ®µã€‚schema å¯ä»¥å¯¹èµ„æºåç§°è¿›è¡Œè§„èŒƒæ£€æŸ¥ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Schema</span><span class="token punctuation">(</span>schema validation<span class="token punctuation">.</span>Schema<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    b<span class="token punctuation">.</span>schema <span class="token operator">=</span> schema    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="FilenameParam"><a href="#FilenameParam" class="headerlink" title="FilenameParam()"></a>FilenameParam()</h4><p>FilenameParam()å¯ä»¥å¤„ç†ä¸åŒçš„è¾“å…¥æ–¹å¼ï¼Œå¹¶è®¾ç½® Paths å­—æ®µã€‚å¦‚<code>kubectl create -f abc.yaml</code>ï¼Œåˆ™filenameOptionsä¸º&amp;{[/home/abc.yaml] false}ã€‚<br>FilenameParam()ç›®å‰æ”¯æŒæ ‡å‡†è¾“å…¥ï¼ŒURLæ–¹å¼ï¼Œæ–‡ä»¶æ–¹å¼ï¼Œå¯¹åº”çš„æ”¯æŒå‡½æ•°ä¸ºStdin(), URL(), Path()ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">FilenameParam</span><span class="token punctuation">(</span>enforceNamespace <span class="token builtin">bool</span><span class="token punctuation">,</span> filenameOptions <span class="token operator">*</span>FilenameOptions<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    recursive <span class="token operator">:=</span> filenameOptions<span class="token punctuation">.</span>Recursive    paths <span class="token operator">:=</span> filenameOptions<span class="token punctuation">.</span>Filenames    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> s <span class="token operator">:=</span> <span class="token keyword">range</span> paths <span class="token punctuation">{</span>        <span class="token keyword">switch</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ ‡å‡†è¾“å…¥</span>        <span class="token keyword">case</span> s <span class="token operator">==</span> <span class="token string">"-"</span><span class="token punctuation">:</span>            b<span class="token punctuation">.</span><span class="token function">Stdin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// URL</span>        <span class="token keyword">case</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"http://"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"https://"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            url<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"the URL passed to filename %q is not valid: %v"</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">continue</span>            <span class="token punctuation">}</span>            b<span class="token punctuation">.</span><span class="token function">URL</span><span class="token punctuation">(</span>defaultHttpGetAttempts<span class="token punctuation">,</span> url<span class="token punctuation">)</span>        <span class="token keyword">default</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token operator">!</span>recursive <span class="token punctuation">{</span>                b<span class="token punctuation">.</span>singular <span class="token operator">=</span> <span class="token boolean">true</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// æ–‡ä»¶æˆ–ç›®å½•è¾“å…¥</span>            b<span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span>recursive<span class="token punctuation">,</span> s<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å¦‚æœenforceNamespaceä¸ºtrueï¼Œåˆ™è°ƒç”¨RequireNamespace()</span>    <span class="token keyword">if</span> enforceNamespace <span class="token punctuation">{</span>        b<span class="token punctuation">.</span><span class="token function">RequireNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="Stdin"><a href="#Stdin" class="headerlink" title="Stdin()"></a>Stdin()</h4><p><code>Stdin()</code>ä¼šè°ƒç”¨ <code>FileVIsitorForSTDIN()</code> ç”Ÿæˆä¸€ä¸ª Visitorï¼Œç„¶åæŠŠè¯¥ Visitor åŠ å…¥åˆ° paths ä¸­ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// åœ¨ Builder çš„ paths ä¸­åŠ å…¥ stdin Visitor</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Stdin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    b<span class="token punctuation">.</span>stream <span class="token operator">=</span> <span class="token boolean">true</span>    b<span class="token punctuation">.</span>paths <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">,</span> <span class="token function">FileVisitorForSTDIN</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>mapper<span class="token punctuation">,</span> b<span class="token punctuation">.</span>schema<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="URL"><a href="#URL" class="headerlink" title="URL()"></a>URL()</h4><p>URL() å…ˆç”Ÿæˆä¸€ä¸ª url Visitorï¼Œç„¶åæŠŠè¯¥ visitor åŠ å…¥åˆ° paths ä¸­ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// åœ¨ Builder çš„ paths ä¸­åŠ å…¥ URL Visitor</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">URL</span><span class="token punctuation">(</span>httpAttemptCount <span class="token builtin">int</span><span class="token punctuation">,</span> urls <span class="token operator">...</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> u <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>        b<span class="token punctuation">.</span>paths <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">,</span> <span class="token operator">&amp;</span>URLVisitor<span class="token punctuation">{</span>            URL<span class="token punctuation">:</span>              u<span class="token punctuation">,</span>            StreamVisitor<span class="token punctuation">:</span>    <span class="token function">NewStreamVisitor</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">,</span> u<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>schema<span class="token punctuation">)</span><span class="token punctuation">,</span>            HttpAttemptCount<span class="token punctuation">:</span> httpAttemptCount<span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="Stream"><a href="#Stream" class="headerlink" title="Stream()"></a>Stream()</h4><p>Stream() å…ˆç”Ÿæˆä¸€ä¸ª stream Visitorï¼Œç„¶åæŠŠè¯¥ Visitor åŠ å…¥åˆ° paths ä¸­ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// åœ¨ Builder çš„ paths ä¸­åŠ å…¥ stream Visitor </span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Stream</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    b<span class="token punctuation">.</span>stream <span class="token operator">=</span> <span class="token boolean">true</span>    b<span class="token punctuation">.</span>paths <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">,</span> <span class="token function">NewStreamVisitor</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">,</span> name<span class="token punctuation">,</span> b<span class="token punctuation">.</span>schema<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="Path"><a href="#Path" class="headerlink" title="Path()"></a>Path()</h4><p>Path()æŠŠè·¯å¾„è½¬æ¢æˆ file visitor,ç„¶ååŠ å…¥åˆ° paths ä¸­ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// æŠŠpathè½¬æ¢æˆfile Visitorï¼Œç„¶ååŠ å…¥åˆ°pathsä¸­</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Path</span><span class="token punctuation">(</span>recursive <span class="token builtin">bool</span><span class="token punctuation">,</span> paths <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> paths <span class="token punctuation">{</span>        <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>        <span class="token keyword">if</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>            b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"the path %q does not exist"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"the path %q cannot be accessed: %v"</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æŠŠpathsè½¬æ¢æˆfile Visitors</span>        visitors<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">ExpandPathsToFileVisitors</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>mapper<span class="token punctuation">,</span> p<span class="token punctuation">,</span> recursive<span class="token punctuation">,</span> FileExtensions<span class="token punctuation">,</span> b<span class="token punctuation">.</span>schema<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"error reading %q: %v"</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>visitors<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token punctuation">{</span>            b<span class="token punctuation">.</span>dir <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åŠ å…¥åˆ°pathsä¸­</span>        b<span class="token punctuation">.</span>paths <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>paths<span class="token punctuation">,</span> visitors<span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="ResourceTypes"><a href="#ResourceTypes" class="headerlink" title="ResourceTypes()"></a>ResourceTypes()</h4><p>ResourceTypes()è®¾ç½®Builderçš„resourceså­—æ®µï¼Œå¦‚kubectl get pods abcï¼Œåˆ™resourcesä¸ºpods</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// è®¾ç½®resources/</span><span class="token comment" spellcheck="true">// builder resourcesä¸­å­˜å‚¨çš„æ˜¯éœ€è¦å¤„ç†çš„ç±»å‹</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ResourceTypes</span><span class="token punctuation">(</span>types <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    b<span class="token punctuation">.</span>resources <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">,</span> types<span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="ResourceNames"><a href="#ResourceNames" class="headerlink" title="ResourceNames()"></a>ResourceNames()</h4><p>ResourceNames()è®¾ç½®resourceTupleså­—æ®µï¼Œè¡¨ç¤ºéœ€è¦è®¿é—®çš„å¯¹è±¡ã€‚å¦‚æœkubectl logs nginxï¼Œé‚£ä¹ˆResourceNames()ä¼šæŠŠâ€nginxâ€å’ŒBuilderä¸­çš„resource(logså‘½ä»¤ä¸­è®¾ç½®ä¸ºpods)ï¼Œç»„æˆ(pods, nginx)åŠ å…¥åˆ°resourceTuplesä¸­ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ResourceNames</span><span class="token punctuation">(</span>resource <span class="token builtin">string</span><span class="token punctuation">,</span> names <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> name <span class="token operator">:=</span> <span class="token keyword">range</span> names <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// See if this input string is of type/name format</span>        tuple<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">splitResourceTypeName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token keyword">return</span> b        <span class="token punctuation">}</span>        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>            b<span class="token punctuation">.</span>resourceTuples <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">,</span> tuple<span class="token punctuation">)</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>            b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"the argument %q must be RESOURCE/NAME"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Use the given default type to create a resource tuple</span>        b<span class="token punctuation">.</span>resourceTuples <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">,</span> resourceTuple<span class="token punctuation">{</span>Resource<span class="token punctuation">:</span> resource<span class="token punctuation">,</span> Name<span class="token punctuation">:</span> name<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="SelectorParam"><a href="#SelectorParam" class="headerlink" title="SelectorParam()"></a>SelectorParam()</h4><p>SelectorParam()çš„å‚æ•°ä¸ºstring,è®¾ç½®Builderçš„selectorå­—æ®µã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// è®¾ç½®selector</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">SelectorParam</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    selector<span class="token punctuation">,</span> err <span class="token operator">:=</span> labels<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"the provided selector %q is not valid: %v"</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> b    <span class="token punctuation">}</span>    <span class="token keyword">if</span> selector<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> b    <span class="token punctuation">}</span>    <span class="token keyword">if</span> b<span class="token punctuation">.</span>selectAll <span class="token punctuation">{</span>        b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"found non empty selector %q with previously set 'all' parameter. "</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> b    <span class="token punctuation">}</span>    <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">Selector</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="Selector"><a href="#Selector" class="headerlink" title="Selector()"></a>Selector()</h4><p>Selector()çš„å‚æ•°ä¸ºselectorï¼Œç›´æ¥è®¾ç½®Builderçš„selectorå­—æ®µã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Selector</span><span class="token punctuation">(</span>selector labels<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    b<span class="token punctuation">.</span>selector <span class="token operator">=</span> selector    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="ExportParam"><a href="#ExportParam" class="headerlink" title="ExportParam()"></a>ExportParam()</h4><p>èµ„æºæ˜¯å¦å¯å¯¼å‡º</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ExportParam</span><span class="token punctuation">(</span>export <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    b<span class="token punctuation">.</span>export <span class="token operator">=</span> export    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="NamespaceParam"><a href="#NamespaceParam" class="headerlink" title="NamespaceParam()"></a>NamespaceParam()</h4><p>NamespaceParam()å¯ä»¥è®¾ç½®Builderçš„namespaceå­—æ®µã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">NamespaceParam</span><span class="token punctuation">(</span>namespace <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    b<span class="token punctuation">.</span>namespace <span class="token operator">=</span> namespace    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="DefaultNamespace"><a href="#DefaultNamespace" class="headerlink" title="DefaultNamespace()"></a>DefaultNamespace()</h4><p>DefaultNamespace()å¯ä»¥è®¾ç½®Builderçš„defaultNamespaceå­—æ®µï¼Œè¡¨ç¤ºå¦‚æœnamespaceæœªæŒ‡å®šï¼Œæ˜¯å¦ä½¿ç”¨default namespaceã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// è®¾ç½®DefaultNamespace</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">DefaultNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    b<span class="token punctuation">.</span>defaultNamespace <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="AllNamespaces"><a href="#AllNamespaces" class="headerlink" title="AllNamespaces()"></a>AllNamespaces()</h4><p>AllNamespaces()å¯ä»¥è®¾ç½®Builderçš„allNamespaceå’Œnamespaceå­—æ®µï¼Œè¡¨ç¤ºè®¿é—®NamespaceAllã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// æŠŠnamespaceè®¾ç½®ä¸ºNamespaceAll</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">AllNamespaces</span><span class="token punctuation">(</span>allNamespace <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    <span class="token keyword">if</span> allNamespace <span class="token punctuation">{</span>        b<span class="token punctuation">.</span>namespace <span class="token operator">=</span> api<span class="token punctuation">.</span>NamespaceAll    <span class="token punctuation">}</span>    b<span class="token punctuation">.</span>allNamespace <span class="token operator">=</span> allNamespace    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="RequireNamespace"><a href="#RequireNamespace" class="headerlink" title="RequireNamespace()"></a>RequireNamespace()</h4><p>RequireNamespace()å¯ä»¥è®¾ç½®Builderçš„requireNamespaceå­—æ®µã€‚</p><pre><code>func (b *Builder) RequireNamespace() *Builder {    b.requireNamespace = true    return b}</code></pre><h4 id="SelectAllParam"><a href="#SelectAllParam" class="headerlink" title="SelectAllParam()"></a>SelectAllParam()</h4><p>SelectAllParam()å¯ä»¥è®¾ç½®Builderçš„selectAllå­—æ®µã€‚ä¸selectorå­—æ®µäº’æ–¥ã€‚</p><pre><code>func (b *Builder) SelectAllParam(selectAll bool) *Builder {    if selectAll &amp;&amp; b.selector != nil {        b.errs = append(b.errs, fmt.Errorf("setting 'all' parameter but found a non empty selector. "))        return b    }    b.selectAll = selectAll    return b}</code></pre><h4 id="ResourceTypeOrNameArgs"><a href="#ResourceTypeOrNameArgs" class="headerlink" title="ResourceTypeOrNameArgs()"></a>ResourceTypeOrNameArgs()</h4><p>ResourceTypeOrNameArgs()å¯ä»¥è®¾ç½®Builderçš„nameså’Œresourceå­—æ®µã€‚å¦‚æ‰§è¡Œ<code>kubectl get pods/nginx-1487191267-b4w5j rc/abc</code>ï¼Œåˆ™argsä¸º<code>[pods/nginx-1487191267-b4w5j rc/abc]</code>ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ResourceTypeOrNameArgs</span><span class="token punctuation">(</span>allowEmptySelector <span class="token builtin">bool</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    args <span class="token operator">=</span> <span class="token function">normalizeMultipleResourcesArgs</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>    <span class="token keyword">if</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">hasCombinedTypeArgs</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token keyword">return</span> b        <span class="token punctuation">}</span>        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> s <span class="token operator">:=</span> <span class="token keyword">range</span> args <span class="token punctuation">{</span>            tuple<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">splitResourceTypeName</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>                <span class="token keyword">return</span> b            <span class="token punctuation">}</span>            <span class="token keyword">if</span> ok <span class="token punctuation">{</span>                b<span class="token punctuation">.</span>resourceTuples <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resourceTuples<span class="token punctuation">,</span> tuple<span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> b    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Try replacing aliases only in types</span>        args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">ReplaceAliases</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ­¤å¤„è°ƒç”¨ResourceTypes()</span>    <span class="token keyword">switch</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">:</span>        b<span class="token punctuation">.</span>names <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>names<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>        b<span class="token punctuation">.</span><span class="token function">ResourceTypes</span><span class="token punctuation">(</span><span class="token function">SplitResourceArgument</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token keyword">case</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>        b<span class="token punctuation">.</span>names <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>names<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        b<span class="token punctuation">.</span><span class="token function">ResourceTypes</span><span class="token punctuation">(</span><span class="token function">SplitResourceArgument</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token keyword">case</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>        b<span class="token punctuation">.</span><span class="token function">ResourceTypes</span><span class="token punctuation">(</span><span class="token function">SplitResourceArgument</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> b<span class="token punctuation">.</span>selector <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> allowEmptySelector <span class="token punctuation">{</span>            b<span class="token punctuation">.</span>selector <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token function">Everything</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token keyword">case</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>    <span class="token keyword">default</span><span class="token punctuation">:</span>        b<span class="token punctuation">.</span>errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>errs<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"arguments must consist of a resource or a resource and name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="Flatten"><a href="#Flatten" class="headerlink" title="Flatten()"></a>Flatten()</h4><p>Flatten()å¯ä»¥è®¾ç½®Builderçš„flattenå­—æ®µã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    b<span class="token punctuation">.</span>flatten <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="Latest"><a href="#Latest" class="headerlink" title="Latest()"></a>Latest()</h4><p>Latest()å¯ä»¥è®¾ç½®Builderçš„latestå­—æ®µï¼Œç”¨æ¥æ ‡è¯†è·å–URLæˆ–Pathä¸­æœ€æ–°çš„å†…å®¹ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Latest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    b<span class="token punctuation">.</span>latest <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="RequireObject"><a href="#RequireObject" class="headerlink" title="RequireObject()"></a>RequireObject()</h4><p>RequireObject()å¯ä»¥è®¾ç½®Builderçš„requireObjectå­—æ®µã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">RequireObject</span><span class="token punctuation">(</span>require <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    b<span class="token punctuation">.</span>requireObject <span class="token operator">=</span> require    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="ContinueOnError"><a href="#ContinueOnError" class="headerlink" title="ContinueOnError()"></a>ContinueOnError()</h4><p>ContinueOnError()å¯ä»¥è®¾ç½®Builderçš„continueOnErrorå­—æ®µä¸ºtrueï¼Œåœ¨å°è£…visitoræ—¶ä¼šç”¨åˆ°è¯¥å­—æ®µã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">ContinueOnError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    b<span class="token punctuation">.</span>continueOnError <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">return</span> b<span class="token punctuation">}</span></code></pre><h4 id="mappingFor"><a href="#mappingFor" class="headerlink" title="mappingFor()"></a>mappingFor()</h4><p>mappingFor()ä½¿ç”¨å‚æ•°resourceï¼Œç„¶åä¾æ®mapperå­—æ®µï¼Œæ„å»ºRESTMappingå¹¶è¿”å›ã€‚RESTMappingè¡¨ç¤ºresourceå’ŒGVKçš„å¯¹åº”å…³ç³»ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// è¿”å› RESTMapping</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">mappingFor</span><span class="token punctuation">(</span>resourceArg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æŠŠresourceæ„é€ æˆGVR</span>    fullySpecifiedGVR<span class="token punctuation">,</span> groupResource <span class="token operator">:=</span> unversioned<span class="token punctuation">.</span><span class="token function">ParseResourceArg</span><span class="token punctuation">(</span>resourceArg<span class="token punctuation">)</span>    gvk <span class="token operator">:=</span> unversioned<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">if</span> fullySpecifiedGVR <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        gvk<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">KindFor</span><span class="token punctuation">(</span><span class="token operator">*</span>fullySpecifiedGVR<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> gvk<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> err <span class="token builtin">error</span>        gvk<span class="token punctuation">,</span> err <span class="token operator">=</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">KindFor</span><span class="token punctuation">(</span>groupResource<span class="token punctuation">.</span><span class="token function">WithVersion</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// RESTMapping()å®šä¹‰åœ¨/pkg/api/meta/restmapper.goä¸­</span>    <span class="token keyword">return</span> b<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">RESTMapping</span><span class="token punctuation">(</span>gvk<span class="token punctuation">.</span><span class="token function">GroupKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gvk<span class="token punctuation">.</span>Version<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="resourceMappings"><a href="#resourceMappings" class="headerlink" title="resourceMappings()"></a>resourceMappings()</h4><p>resourceMappings()æŠŠBuilderä¸­çš„resourceä¼ é€’ç»™ä¸Šé¢çš„mappingFor()ç”ŸæˆRESTMappingã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// æŠŠbuilderä¸­resourcesè½¬æ¢æˆmapping</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">resourceMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>resources<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>singleResourceType <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"you may only specify a single resource type"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    mappings <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping<span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> b<span class="token punctuation">.</span>resources <span class="token punctuation">{</span>        mapping<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">mappingFor</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        mappings <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>mappings<span class="token punctuation">,</span> mapping<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> mappings<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><h4 id="resourceTupleMappings"><a href="#resourceTupleMappings" class="headerlink" title="resourceTupleMappings()"></a>resourceTupleMappings()</h4><p>resourceTupleMappings()æŠŠBuilderä¸­çš„resourceTupleè½¬æ¢æˆRESTMappingã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">resourceTupleMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    mappings <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping<span class="token punctuation">)</span>    canonical <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> b<span class="token punctuation">.</span>resourceTuples <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> mappings<span class="token punctuation">[</span>r<span class="token punctuation">.</span>Resource<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        mapping<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">mappingFor</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        mappings<span class="token punctuation">[</span>mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">]</span> <span class="token operator">=</span> mapping        mappings<span class="token punctuation">[</span>r<span class="token punctuation">.</span>Resource<span class="token punctuation">]</span> <span class="token operator">=</span> mapping        canonical<span class="token punctuation">[</span>mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>canonical<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>singleResourceType <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"you may only specify a single resource type"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> mappings<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><h3 id="Visitor"><a href="#Visitor" class="headerlink" title="Visitor"></a>Visitor</h3><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/cli-runtime/pkg/resource/interfaces.go#L94" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/interfaces.go</a></p><p>Builder æœ€åè°ƒç”¨ <code>DO()</code> å‡½æ•°çš„ä½œç”¨å°±æ˜¯æ„å»º Visitors ,æ ¹æ®ä¸åŒçš„èµ„æºæ„å»ºä¸åŒçš„ Visitorï¼Œç„¶åé€šè¿‡ <code>Visit</code> å‡½æ•°è®¿é—®ä¸åŒçš„èµ„æºã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// é€šè¿‡è®¿é—®è€…æ¨¡å¼ï¼Œè®¿é—®èµ„æºåˆ—è¡¨</span><span class="token keyword">type</span> Visitor <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token function">Visit</span><span class="token punctuation">(</span>VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// è®¿é—®è€…å›è°ƒå‡½æ•°</span><span class="token keyword">type</span> VisitorFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>Info<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span></code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œåªè¦å®ç°äº† <code>Visit(VisitorFunc) error</code> æ–¹æ³•çš„ç»“æ„ä½“éƒ½å¯ä»¥ç§°ä¸º Visitorã€‚</p><p>å…¶ä¸­ VisitorFunc çš„å‚æ•°ä¸º *Info åŠ errorï¼Œæ‰€ä»¥å¯ä»¥æ¨æ–­ï¼ŒVisitorFunc() å¯ä»¥å¯¹ Info åŠ Error è¿›è¡Œå¤„ç†ã€‚</p><p>Visitor æœ€å¤§çš„ç‰¹æ€§å°±æ˜¯æ¯ä¸ª Visitor å®ç°äº†ä¸€ä¸ªç‰¹æ€§ï¼Œç„¶åå¯ä»¥åµŒå¥—ä½¿ç”¨ã€‚Visitor å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œç¬¬ä¸€ç±»æ˜¯ç”ŸæˆInfoï¼Œç¬¬äºŒç±»æ˜¯å¤„ç† Infoã€‚æˆ‘ä»¬ç°åœ¨å…ˆè®°ç€ Info æ˜¯ç”¨æ¥å­˜å‚¨RESTè¯·æ±‚çš„è¿”å›ç»“æœçš„ã€‚</p><p>äº§ç”Ÿ Info çš„ Visitor æœ‰ï¼šFileVisitor, StreamVisitor, URLVisitor, Selectorã€‚</p><p>å¤„ç† Info çš„ Visitor æœ‰ï¼šVisitorList, EagerVisitorList, DecoratedVisitor, ContinueOnErrorVisitor, FlattenListVisitor, FlattenListVisitor ç­‰ã€‚æ­¤å¤„éœ€è¦è¯´æ˜ä¸‹ï¼Œæœ‰äº› Visitor åªå¤„ç†äº† Errorï¼Œä½†æˆ‘ä»¬ä»æŠŠå®ƒå½’ä¸ºå¤„ç† Info çš„ Visitorã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœ Info å·²ç»ç”Ÿæˆï¼Œé‚£ä¹ˆ Visitor åµŒå¥—ä¸­çš„ Visitor åªè¦ Info å¤„ç† Visitor å³å¯ï¼›å¦‚æœæ²¡æœ‰ Info ï¼Œåˆ™æœ€é‡Œé¢çš„ Visitor è¦åœ¨<code>fn()</code>è°ƒç”¨ä¹‹å‰ç”Ÿæˆ Info ï¼Œä»¥ä¾›å…¶ä»– Visitor å¤„ç†ã€‚</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥è¯¦ç»†çœ‹ä¸‹å¯¹åº”çš„Visitor ã€‚</p><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/cli-runtime/pkg/resource/visitor.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/visitor.go</a></p><h4 id="VisitorList"><a href="#VisitorList" class="headerlink" title="VisitorList"></a>VisitorList</h4><p>VisitorList ä¹Ÿå±äº Visitor ç±»å‹ã€‚</p><pre><code>type VisitorList []Visitor// éå† Visitorï¼Œæ‰§è¡Œ Visit å‡½æ•°func (l VisitorList) Visit(fn VisitorFunc) error {    for i := range l {        if err := l[i].Visit(fn); err != nil {            return err        }    }    return nil}</code></pre><h4 id="EagerVisitorList"><a href="#EagerVisitorList" class="headerlink" title="EagerVisitorList"></a>EagerVisitorList</h4><p>EagerVisitorList åœ¨è¿­ä»£åŒ…å«çš„ Visitor æ—¶ï¼Œé‡åˆ°é”™è¯¯ä¼šæ–­ç»­è¿­ä»£ï¼Œæœ€åä¸€èµ·è¿”å›æ‰€æœ‰é”™è¯¯ã€‚</p><p>æ‰€æœ‰åŒ¿åå‡½æ•°ä¸­çš„ err éƒ½ä¼šè¢«æ”¶é›†åˆ° EagerVisitorList çš„ Visit() æ–¹æ³•ä¸­çš„ errs ä¸­ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> EagerVisitorList <span class="token punctuation">[</span><span class="token punctuation">]</span>Visitor<span class="token keyword">func</span> <span class="token punctuation">(</span>l EagerVisitorList<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    errs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> l <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> l<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h4><p>å…¶ä»– Visitor æœ€ç»ˆä¼šè½¬æ¢ä¸º Info ï¼ŒInfo è´Ÿè´£å‘ API server å‘èµ· http è¯·æ±‚ï¼Œæˆ–è€…è¿”å› http è¯·æ±‚å“åº”çš„ç»“æœã€‚</p><pre class=" language-GO"><code class="language-GO">type Info struct {    Client RESTClient    Mapping *meta.RESTMapping    Namespace string    Name      string    Source string    Object runtime.Object    ResourceVersion string    Export bool}func (i *Info) Visit(fn VisitorFunc) error {    return fn(i, nil)}// Get()è°ƒç”¨ Helper ä¾æ®Infoä¸­çš„ä¿¡æ¯è·å– objï¼Œå¹¶æ›´æ–°åˆ° Info çš„Objectå­—æ®µã€‚func (i *Info) Get() (err error) {    obj, err := NewHelper(i.Client, i.Mapping).Get(i.Namespace, i.Name, i.Export)    if err != nil {        ...            err2 := i.Client.Get().AbsPath("api", "v1", "namespaces", i.Namespace).Do(context.TODO()).Error()        ...        return err    }    // æ›´æ–°i.Objectå’Œi.ResourceVersion    i.Object = obj    i.ResourceVersion, _ = metadataAccessor.ResourceVersion(obj)    return nil}// æŠŠä¸€ä¸ª object æ›´æ–°åˆ° Info ä¸­func (i *Info) Refresh(obj runtime.Object, ignoreError bool) error {    name, err := i.Mapping.MetadataAccessor.Name(obj)    if err != nil {        if !ignoreError {            return err        }    } else {        i.Name = name    }    namespace, err := i.Mapping.MetadataAccessor.Namespace(obj)    if err != nil {        if !ignoreError {            return err        }    } else {        i.Namespace = namespace    }    version, err := i.Mapping.MetadataAccessor.ResourceVersion(obj)    if err != nil {        if !ignoreError {            return err        }    } else {        i.ResourceVersion = version    }    i.Object = obj    return nil}</code></pre><h4 id="InfoListVisitor"><a href="#InfoListVisitor" class="headerlink" title="InfoListVisitor"></a>InfoListVisitor</h4><p>InfoListVisitor  ä¹Ÿå±äº Visitor ç±»å‹ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> InfoListVisitor <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Info<span class="token keyword">func</span> <span class="token punctuation">(</span>infos InfoListVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> err <span class="token builtin">error</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> infos <span class="token punctuation">{</span>        err <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> err<span class="token punctuation">}</span></code></pre><h4 id="URLVisitor"><a href="#URLVisitor" class="headerlink" title="URLVisitor"></a>URLVisitor</h4><p>URLVisitor é€šè¿‡ URL å‘èµ· http è¯·æ±‚ä¸‹è½½èµ„æºï¼Œç„¶åæ„å»ºä¸º Infoã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> URLVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>    URL <span class="token operator">*</span>url<span class="token punctuation">.</span>URL    <span class="token operator">*</span>StreamVisitor    HttpAttemptCount <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>URLVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    body<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">readHttpWithRetries</span><span class="token punctuation">(</span>httpgetImpl<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> v<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>HttpAttemptCount<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token keyword">defer</span> body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    v<span class="token punctuation">.</span>StreamVisitor<span class="token punctuation">.</span>Reader <span class="token operator">=</span> body    <span class="token keyword">return</span> v<span class="token punctuation">.</span>StreamVisitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="DecoratedVisitor"><a href="#DecoratedVisitor" class="headerlink" title="DecoratedVisitor"></a>DecoratedVisitor</h4><p>DecoratedVisitor åœ¨è°ƒç”¨ Visitor çš„ Visit å‡½æ•°ä¹‹å‰å…ˆè°ƒç”¨è£…é¥°å™¨ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> DecoratedVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>    visitor    Visitor    decorators <span class="token punctuation">[</span><span class="token punctuation">]</span>VisitorFunc<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>v DecoratedVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> v<span class="token punctuation">.</span>visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> v<span class="token punctuation">.</span>decorators <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// è°ƒç”¨è£…é¥°å™¨</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span>decorators<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> err            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="StreamVisitor"><a href="#StreamVisitor" class="headerlink" title="StreamVisitor"></a>StreamVisitor</h4><p>StreamVisitor ä» <code>io.Reader</code> æµä¸­è¯»å–æ•°æ®è½¬æ¢ä¸º JSON æ ¼å¼ï¼Œç„¶åé€šè¿‡ <code>runtime.Codec</code> è§£ç ï¼Œè¿›è¡Œschemaæ£€æŸ¥ï¼Œæ„å»ºä¸º Info å¯¹è±¡ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> StreamVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>    io<span class="token punctuation">.</span>Reader    <span class="token operator">*</span>mapper    Source <span class="token builtin">string</span>    Schema ContentValidator<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>StreamVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    d <span class="token operator">:=</span> yaml<span class="token punctuation">.</span><span class="token function">NewYAMLOrJSONDecoder</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">{</span>        ext <span class="token operator">:=</span> runtime<span class="token punctuation">.</span>RawExtension<span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è§£ç </span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ext<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token operator">...</span>        <span class="token punctuation">}</span>            <span class="token operator">...</span>        <span class="token comment" spellcheck="true">// æ„å»ºä¸º Info</span>        info<span class="token punctuation">,</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">infoForData</span><span class="token punctuation">(</span>ext<span class="token punctuation">.</span>Raw<span class="token punctuation">,</span> v<span class="token punctuation">.</span>Source<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> fnErr <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span> fnErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> fnErr            <span class="token punctuation">}</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="FileVisitor"><a href="#FileVisitor" class="headerlink" title="FileVisitor"></a>FileVisitor</h4><p>FileVisitor æ˜¯å¯¹ StreamVisitor çš„å°è£…ã€‚ </p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> FileVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Path <span class="token builtin">string</span>    <span class="token operator">*</span>StreamVisitor<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>FileVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> f <span class="token operator">*</span>os<span class="token punctuation">.</span>File    <span class="token keyword">if</span> v<span class="token punctuation">.</span>Path <span class="token operator">==</span> constSTDINstr <span class="token punctuation">{</span>        f <span class="token operator">=</span> os<span class="token punctuation">.</span>Stdin    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> err <span class="token builtin">error</span>        f<span class="token punctuation">,</span> err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        <span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    utf16bom <span class="token operator">:=</span> unicode<span class="token punctuation">.</span><span class="token function">BOMOverride</span><span class="token punctuation">(</span>unicode<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    v<span class="token punctuation">.</span>StreamVisitor<span class="token punctuation">.</span>Reader <span class="token operator">=</span> transform<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> utf16bom<span class="token punctuation">)</span>    <span class="token keyword">return</span> v<span class="token punctuation">.</span>StreamVisitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="FlattenListVisitor"><a href="#FlattenListVisitor" class="headerlink" title="FlattenListVisitor"></a>FlattenListVisitor</h4><p>FlattenListVisitor å¯ä»¥å¯¹åˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œå¤„ç†ã€‚å¦‚æœæœ‰é”™è¯¯å‘ç”Ÿï¼Œåˆ™è¿”å›ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> FlattenListVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>    visitor Visitor    typer   runtime<span class="token punctuation">.</span>ObjectTyper    mapper  <span class="token operator">*</span>mapper<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>v FlattenListVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> v<span class="token punctuation">.</span>visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        <span class="token keyword">if</span> info<span class="token punctuation">.</span>Object <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token operator">!</span>meta<span class="token punctuation">.</span><span class="token function">IsListType</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        items <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token punctuation">}</span>        itemsToProcess <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">{</span>info<span class="token punctuation">.</span>Object<span class="token punctuation">}</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>itemsToProcess<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>            currObj <span class="token operator">:=</span> itemsToProcess<span class="token punctuation">[</span>i<span class="token punctuation">]</span>            <span class="token keyword">if</span> <span class="token operator">!</span>meta<span class="token punctuation">.</span><span class="token function">IsListType</span><span class="token punctuation">(</span>currObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>                items <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> currObj<span class="token punctuation">)</span>                <span class="token keyword">continue</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// æå–åˆ—è¡¨</span>            currItems<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">ExtractList</span><span class="token punctuation">(</span>currObj<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> err            <span class="token punctuation">}</span>            <span class="token keyword">if</span> errs <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">DecodeList</span><span class="token punctuation">(</span>currItems<span class="token punctuation">,</span> v<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>decoder<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            itemsToProcess <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>itemsToProcess<span class="token punctuation">,</span> currItems<span class="token operator">...</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">var</span> preferredGVKs <span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>GroupVersionKind        <span class="token keyword">if</span> info<span class="token punctuation">.</span>Mapping <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>info<span class="token punctuation">.</span>Mapping<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            preferredGVKs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>preferredGVKs<span class="token punctuation">,</span> info<span class="token punctuation">.</span>Mapping<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        errs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¯¹åˆ—è¡¨ä¸­æ¯ä¸€ä¸ªå…ƒç´ è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> items <span class="token punctuation">{</span>            item<span class="token punctuation">,</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">infoForObject</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>typer<span class="token punctuation">,</span> preferredGVKs<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>                <span class="token keyword">continue</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>ResourceVersion<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>                item<span class="token punctuation">.</span>ResourceVersion <span class="token operator">=</span> info<span class="token punctuation">.</span>ResourceVersion            <span class="token punctuation">}</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="FilteredVisitor"><a href="#FilteredVisitor" class="headerlink" title="FilteredVisitor"></a>FilteredVisitor</h4><p>FilteredVisitor å¯ä»¥æ£€æŸ¥ Info æ˜¯å¦æ»¡è¶³æŸäº›æ¡ä»¶ã€‚å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œåˆ™å¾€ä¸‹æ‰§è¡Œï¼Œå¦åˆ™è¿”å› errã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> FilteredVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>    visitor Visitor    filters <span class="token punctuation">[</span><span class="token punctuation">]</span>FilterFunc<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">NewFilteredVisitor</span><span class="token punctuation">(</span>v Visitor<span class="token punctuation">,</span> fn <span class="token operator">...</span>FilterFunc<span class="token punctuation">)</span> Visitor <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> v    <span class="token punctuation">}</span>    <span class="token keyword">return</span> FilteredVisitor<span class="token punctuation">{</span>v<span class="token punctuation">,</span> fn<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>v FilteredVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> v<span class="token punctuation">.</span>visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> filter <span class="token operator">:=</span> <span class="token keyword">range</span> v<span class="token punctuation">.</span>filters <span class="token punctuation">{</span>            ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">filter</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> err            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">nil</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="ContinueOnErrorVisitor"><a href="#ContinueOnErrorVisitor" class="headerlink" title="ContinueOnErrorVisitor"></a>ContinueOnErrorVisitor</h4><p>ContinueOnErrorVisitorä¼šæ”¶é›†å­ Visitor äº§ç”Ÿçš„é”™è¯¯ï¼Œå¹¶è¿”å›ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> ContinueOnErrorVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Visitor<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>v ContinueOnErrorVisitor<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    errs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    err <span class="token operator">:=</span> v<span class="token punctuation">.</span>Visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ­¤å¤„ä¼ å…¥fnçš„é”™è¯¯æ˜¯nil</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> errs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="Selector-1"><a href="#Selector-1" class="headerlink" title="Selector"></a>Selector</h4><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/cli-runtime/pkg/resource/selector.go" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/selector.go</a></p><p>Selector ä¹Ÿå±äº Visitor ç±»å‹ï¼Œç”¨äº label é€‰æ‹©ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Selector is a Visitor for resources that match a label selector.</span><span class="token keyword">type</span> Selector <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Client        RESTClient    Mapping       <span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping    Namespace     <span class="token builtin">string</span>    LabelSelector <span class="token builtin">string</span>    FieldSelector <span class="token builtin">string</span>    Export        <span class="token builtin">bool</span>    LimitChunks   <span class="token builtin">int64</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Visit implements Visitor and uses request chunking by default.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Selector<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>fn VisitorFunc<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> continueToken <span class="token builtin">string</span>    <span class="token keyword">for</span> <span class="token punctuation">{</span>        list<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewHelper</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Client<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Mapping<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>            r<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span>            r<span class="token punctuation">.</span><span class="token function">ResourceMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">.</span><span class="token function">GroupVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            r<span class="token punctuation">.</span>Export<span class="token punctuation">,</span>            <span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>                LabelSelector<span class="token punctuation">:</span> r<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">,</span>                FieldSelector<span class="token punctuation">:</span> r<span class="token punctuation">.</span>FieldSelector<span class="token punctuation">,</span>                Limit<span class="token punctuation">:</span>         r<span class="token punctuation">.</span>LimitChunks<span class="token punctuation">,</span>                Continue<span class="token punctuation">:</span>      continueToken<span class="token punctuation">,</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">IsResourceExpired</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> err            <span class="token punctuation">}</span>            <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">IsBadRequest</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">||</span> errors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> se<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>errors<span class="token punctuation">.</span>StatusError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// modify the message without hiding this is an API error</span>                    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>FieldSelector<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>                        se<span class="token punctuation">.</span>ErrStatus<span class="token punctuation">.</span>Message <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Unable to list %q: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> se<span class="token punctuation">.</span>ErrStatus<span class="token punctuation">.</span>Message<span class="token punctuation">)</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        se<span class="token punctuation">.</span>ErrStatus<span class="token punctuation">.</span>Message <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Unable to find %q that match label selector %q, field selector %q: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> r<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">,</span> r<span class="token punctuation">.</span>FieldSelector<span class="token punctuation">,</span> se<span class="token punctuation">.</span>ErrStatus<span class="token punctuation">.</span>Message<span class="token punctuation">)</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">return</span> se                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>FieldSelector<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Unable to list %q: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> err<span class="token punctuation">)</span>                <span class="token punctuation">}</span>                <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Unable to find %q that match label selector %q, field selector %q: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Mapping<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> r<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">,</span> r<span class="token punctuation">.</span>FieldSelector<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        resourceVersion<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> metadataAccessor<span class="token punctuation">.</span><span class="token function">ResourceVersion</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>        nextContinueToken<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> metadataAccessor<span class="token punctuation">.</span><span class="token function">Continue</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>        info <span class="token operator">:=</span> <span class="token operator">&amp;</span>Info<span class="token punctuation">{</span>            Client<span class="token punctuation">:</span>  r<span class="token punctuation">.</span>Client<span class="token punctuation">,</span>            Mapping<span class="token punctuation">:</span> r<span class="token punctuation">.</span>Mapping<span class="token punctuation">,</span>            Namespace<span class="token punctuation">:</span>       r<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span>            ResourceVersion<span class="token punctuation">:</span> resourceVersion<span class="token punctuation">,</span>            Object<span class="token punctuation">:</span> list<span class="token punctuation">,</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>nextContinueToken<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span>        <span class="token punctuation">}</span>        continueToken <span class="token operator">=</span> nextContinueToken    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h3><p>Builder çš„ <code>Do()</code> å¯ä»¥è¿”å› Resultã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹Resultçš„å®šä¹‰ã€‚</p><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/cli-runtime/pkg/resource/result.go#L37" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/result.go </a></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Result contains helper methods for dealing with the outcome of a Builder.</span><span class="token keyword">type</span> Result <span class="token keyword">struct</span> <span class="token punctuation">{</span>    err     <span class="token builtin">error</span>    visitor Visitor    sources            <span class="token punctuation">[</span><span class="token punctuation">]</span>Visitor    singleItemImplied  <span class="token builtin">bool</span>    targetsSingleItems <span class="token builtin">bool</span>    mapper       <span class="token operator">*</span>mapper    ignoreErrors <span class="token punctuation">[</span><span class="token punctuation">]</span>utilerrors<span class="token punctuation">.</span>Matcher    <span class="token comment" spellcheck="true">// populated by a call to Infos</span>    info <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Info<span class="token punctuation">}</span></code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒResult ä¹ŸåŒ…å«ä¸€ä¸ª Visitorï¼ŒåŠä¸€ä¸ª info è¡¨ç¤º[]*Infoï¼Œæ‰€ä»¥ Result æä¾›äº† Infos() æ–¹æ³•æ¥è·å–Visitorçš„ç»“æœ Info æ•°ç»„åŠ Object() æ–¹æ³•æ¥è·å–Visitorçš„ç»“æœObj(å¯èƒ½ä¸ºList)ã€‚</p><h4 id="Infos"><a href="#Infos" class="headerlink" title="Infos()"></a>Infos()</h4><p>Info() è°ƒç”¨å±‚å±‚å°è£…çš„ Visitorï¼Œç„¶åæ”¶é›†æ‰€æœ‰ Info å¹¶è¿”å›ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Infos returns an array of all of the resource infos retrieved via traversal.</span><span class="token comment" spellcheck="true">// Will attempt to traverse the entire set of visitors only once, and will return</span><span class="token comment" spellcheck="true">// a cached list on subsequent calls.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Result<span class="token punctuation">)</span> <span class="token function">Infos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Info<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> r<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> r<span class="token punctuation">.</span>info <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> r<span class="token punctuation">.</span>info<span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    infos <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Info<span class="token punctuation">{</span><span class="token punctuation">}</span>    err <span class="token operator">:=</span> r<span class="token punctuation">.</span>visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        infos <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>infos<span class="token punctuation">,</span> info<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    err <span class="token operator">=</span> utilerrors<span class="token punctuation">.</span><span class="token function">FilterOut</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ignoreErrors<span class="token operator">...</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>info<span class="token punctuation">,</span> r<span class="token punctuation">.</span>err <span class="token operator">=</span> infos<span class="token punctuation">,</span> err    <span class="token keyword">return</span> infos<span class="token punctuation">,</span> err<span class="token punctuation">}</span></code></pre><h4 id="Object"><a href="#Object" class="headerlink" title="Object()"></a>Object()</h4><p>Object()å…ˆè°ƒç”¨ Infos() æ¥è·å– infosï¼Œç„¶åä»æ¯ä¸ªinfoä¸­æå–å‡ºObjectç»„æˆObjectListè¿”å›ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Result<span class="token punctuation">)</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    infos<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Infos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    versions <span class="token operator">:=</span> sets<span class="token punctuation">.</span>String<span class="token punctuation">{</span><span class="token punctuation">}</span>    objects <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> info <span class="token operator">:=</span> <span class="token keyword">range</span> infos <span class="token punctuation">{</span>        <span class="token keyword">if</span> info<span class="token punctuation">.</span>Object <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            objects <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>objects<span class="token punctuation">,</span> info<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>            versions<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>ResourceVersion<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>objects<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> r<span class="token punctuation">.</span>singular <span class="token punctuation">{</span>            <span class="token keyword">return</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// if the item is a list already, don't create another list</span>        <span class="token keyword">if</span> meta<span class="token punctuation">.</span><span class="token function">IsListType</span><span class="token punctuation">(</span>objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    version <span class="token operator">:=</span> <span class="token string">""</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>versions<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>        version <span class="token operator">=</span> versions<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>List<span class="token punctuation">{</span>        ListMeta<span class="token punctuation">:</span> unversioned<span class="token punctuation">.</span>ListMeta<span class="token punctuation">{</span>            ResourceVersion<span class="token punctuation">:</span> version<span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        Items<span class="token punctuation">:</span> objects<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span></code></pre><h3 id="Helper"><a href="#Helper" class="headerlink" title="Helper"></a>Helper</h3><p>åœ¨ Kubernetesä¸­ï¼ŒHelper ä¸€èˆ¬éƒ½æä¾›ç±»ä¼¼é©±åŠ¨çš„åŠŸèƒ½ã€‚Kubectl çš„ helper å°±æ˜¯ç”¨æ¥è®¿é—®Clientçš„é©±åŠ¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒæŸä¸ªvisitFunc å‡½æ•°ä¸­ä¼šè°ƒç”¨Helperçš„ç›¸å…³æˆå‘˜å‡½æ•°æ¥å®Œæˆå…·ä½“è¯·æ±‚ã€‚</p><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/cli-runtime/pkg/resource/helper.go#L35" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/helper.go </a></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Helper provides methods for retrieving or mutating a RESTful</span><span class="token comment" spellcheck="true">// resource.</span><span class="token keyword">type</span> Helper <span class="token keyword">struct</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// The name of this resource as the server would recognize it</span>    Resource <span class="token builtin">string</span>    <span class="token comment" spellcheck="true">// A RESTClient capable of mutating this resource.</span>    RESTClient RESTClient    <span class="token comment" spellcheck="true">// An interface for reading or writing the resource version of this</span>    <span class="token comment" spellcheck="true">// type.</span>    Versioner runtime<span class="token punctuation">.</span>ResourceVersioner    <span class="token comment" spellcheck="true">// True if the resource type is scoped to namespaces</span>    NamespaceScoped <span class="token builtin">bool</span><span class="token punctuation">}</span></code></pre><p>Helper å®ç°äº†Get(), List(), Watch(), WatchSingle(), Delete(), Create(), Patch(), Replace()ç­‰æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æ˜¯å¯¹RESTClientçš„å°è£…ã€‚</p><h3 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h3><p>è¿™é‡Œçš„Mapperæ˜¯æŒ‡kubectlä¸­çš„Mapperï¼Œæ˜¯å¯¹ObjectTyper, RESTMapper, ClientMapperå’ŒDecoderçš„å°è£…ã€‚</p><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/cli-runtime/pkg/resource/mapper.go#L29" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/resource/mapper.go </a></p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> Mapper <span class="token keyword">struct</span> <span class="token punctuation">{</span>    runtime<span class="token punctuation">.</span>ObjectTyper    meta<span class="token punctuation">.</span>RESTMapper    <span class="token comment" spellcheck="true">// å®šä¹‰åœ¨/pkg/kubectl/resource/interfaces.goä¸­</span>    <span class="token comment" spellcheck="true">// ClientMapperå¯ä»¥æ ¹æ®configå’Œmappingé€šè¿‡è°ƒç”¨ClientForMapping()ç”ŸæˆRESTClient</span>    ClientMapper    runtime<span class="token punctuation">.</span>Decoder<span class="token punctuation">}</span></code></pre><h4 id="Build-Mapper"><a href="#Build-Mapper" class="headerlink" title="Build Mapper"></a>Build Mapper</h4><p>ä»<code>/pkg/kubectl/cmd/util/factory.goçš„NewBuilder()</code>å‡½æ•°è¯´èµ·</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>factory<span class="token punctuation">)</span> <span class="token function">NewBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>resource<span class="token punctuation">.</span>Builder <span class="token punctuation">{</span>    mapper<span class="token punctuation">,</span> typer <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// æ­¤å¤„æœ‰kubectl mapperçš„å„é¡¹å‚æ•°çš„å®šä¹‰</span>    <span class="token operator">/</span>  å…¶ä¸­Decoderä¸ºf<span class="token punctuation">.</span><span class="token function">Decoder</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> resource<span class="token punctuation">.</span><span class="token function">NewBuilder</span><span class="token punctuation">(</span>mapper<span class="token punctuation">,</span> typer<span class="token punctuation">,</span> resource<span class="token punctuation">.</span><span class="token function">ClientMapperFunc</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>ClientForMapping<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">Decoder</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>å†æ¥çœ‹<code>/pkg/kubectl/ressourcce/builder.go</code>ä¸­çš„<code>NewBuilder()</code>:</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// NewBuilder creates a builder that operates on generic objects.</span><span class="token keyword">func</span> <span class="token function">NewBuilder</span><span class="token punctuation">(</span>mapper meta<span class="token punctuation">.</span>RESTMapper<span class="token punctuation">,</span> typer runtime<span class="token punctuation">.</span>ObjectTyper<span class="token punctuation">,</span> clientMapper ClientMapper<span class="token punctuation">,</span> decoder runtime<span class="token punctuation">.</span>Decoder<span class="token punctuation">)</span> <span class="token operator">*</span>Builder <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Builder<span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æŠŠRESTMapper, ObjectTyper, ClientMapper, Decoderå°è£…æˆkubectlçš„ Mapper</span>        mapper<span class="token punctuation">:</span>        <span class="token operator">&amp;</span>Mapper<span class="token punctuation">{</span>typer<span class="token punctuation">,</span> mapper<span class="token punctuation">,</span> clientMapper<span class="token punctuation">,</span> decoder<span class="token punctuation">}</span><span class="token punctuation">,</span>        requireObject<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>å¯ä»¥çœ‹å‡ºï¼ŒMapperçš„åˆ›å»ºåœ¨ builder.go ä¸­ï¼Œä½†çœŸæ­£å‡†å¤‡åˆ›å»ºMapperçš„å…¶ä»–ç»“æ„ä½“çš„åœ°æ–¹è¿˜æ˜¯åœ¨ factory.go ä¸­ã€‚</p><ul><li>runtime.ObjectTyper: ç”±f.Object()ç”Ÿæˆï¼›</li><li>meta.RESTMapper: ç”±f.Object()ç”Ÿæˆï¼›</li><li>ClientMapper: resource.ClientMapperFunc(f.ClientForMapping)</li><li>runtime.Decoder: f.Decoder(true)</li></ul><h4 id="f-Object"><a href="#f-Object" class="headerlink" title="f.Object()"></a>f.Object()</h4><p>Object() è¿”å›ä¸€ä¸ªRESTMapperåŠ api.Schemeã€‚è¿™é‡Œapi.Schemeå°†ä¼ é€’ç»™Typerã€‚å…³äºRESTMapperï¼Œç°åœ¨åªéœ€çŸ¥é“å­˜å‚¨äº†GVKå’ŒGVRçš„å…³ç³»ï¼Œå¯ä»¥é€šè¿‡RESTMapping()è¿”å›ä¸€ä¸ªmappingè¡¨ç¤ºGVKå’ŒResourceçš„å…³ç³»ã€‚å¯ä»¥ç”¨mappingç”Ÿæˆä¸€ä¸ªconfigï¼Œå†ç”ŸæˆClientã€‚</p><pre><code>func (f *factory) Object() (meta.RESTMapper, runtime.ObjectTyper) {    // registered.RESTMapper()å®šä¹‰åœ¨/pkg/apimachinery/registerd/registered.goä¸­    mapper := registered.RESTMapper()    // ç”ŸæˆdiscoveryClient    discoveryClient, err := f.DiscoveryClient()    if err == nil {        // discoveryClientç”ŸæˆæˆåŠŸçš„æƒ…å†µä¸‹ï¼Œmapperä¸ºä¸€ä¸ªFistHitRESTMapper        mapper = meta.FirstHitRESTMapper{            MultiRESTMapper: meta.MultiRESTMapper{                discovery.NewDeferredDiscoveryRESTMapper(discoveryClient, registered.InterfacesFor),                registered.RESTMapper(), // hardcoded fall back            },        }    }    // wrap with shortcuts    mapper = NewShortcutExpander(mapper, discoveryClient)    // wrap with output preferences    cfg, err := f.clients.ClientConfigForVersion(nil)    checkErrWithPrefix("failed to get client config: ", err)    cmdApiVersion := unversioned.GroupVersion{}    if cfg.GroupVersion != nil {        cmdApiVersion = *cfg.GroupVersion    }    mapper = kubectl.OutputVersionMapper{RESTMapper: mapper, OutputVersions: []unversioned.GroupVersion{cmdApiVersion}}    return mapper, api.Scheme}</code></pre><h4 id="f-ClientForMapping"><a href="#f-ClientForMapping" class="headerlink" title="f.ClientForMapping()"></a>f.ClientForMapping()</h4><p>CLientForMapping()å¯ä»¥ä¾æ®mappingä¸­çš„ä¿¡æ¯ç”Ÿæˆä¸€ä¸ªconfigï¼Œç„¶åå†ç”ŸæˆRESTClientã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ä¾æ®mappingç”ŸæˆRESTClient</span><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>factory<span class="token punctuation">)</span> <span class="token function">ClientForMapping</span><span class="token punctuation">(</span>mapping <span class="token operator">*</span>meta<span class="token punctuation">.</span>RESTMapping<span class="token punctuation">)</span> <span class="token punctuation">(</span>resource<span class="token punctuation">.</span>RESTClient<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    cfg<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span>clientConfig<span class="token punctuation">.</span><span class="token function">ClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">SetKubernetesDefaults</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    gvk <span class="token operator">:=</span> mapping<span class="token punctuation">.</span>GroupVersionKind    <span class="token keyword">switch</span> gvk<span class="token punctuation">.</span>Group <span class="token punctuation">{</span>    <span class="token keyword">case</span> federation<span class="token punctuation">.</span>GroupName<span class="token punctuation">:</span>        mappingVersion <span class="token operator">:=</span> mapping<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">.</span><span class="token function">GroupVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> f<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">FederationClientForVersion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mappingVersion<span class="token punctuation">)</span>    <span class="token keyword">case</span> api<span class="token punctuation">.</span>GroupName<span class="token punctuation">:</span>        cfg<span class="token punctuation">.</span>APIPath <span class="token operator">=</span> <span class="token string">"/api"</span>    <span class="token keyword">default</span><span class="token punctuation">:</span>        cfg<span class="token punctuation">.</span>APIPath <span class="token operator">=</span> <span class="token string">"/apis"</span>    <span class="token punctuation">}</span>    gv <span class="token operator">:=</span> gvk<span class="token punctuation">.</span><span class="token function">GroupVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    cfg<span class="token punctuation">.</span>GroupVersion <span class="token operator">=</span> <span class="token operator">&amp;</span>gv    <span class="token keyword">if</span> registered<span class="token punctuation">.</span><span class="token function">IsThirdPartyAPIGroupVersion</span><span class="token punctuation">(</span>gvk<span class="token punctuation">.</span><span class="token function">GroupVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        cfg<span class="token punctuation">.</span>NegotiatedSerializer <span class="token operator">=</span> thirdpartyresourcedata<span class="token punctuation">.</span><span class="token function">NewNegotiatedSerializer</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span>Codecs<span class="token punctuation">,</span> gvk<span class="token punctuation">.</span>Kind<span class="token punctuation">,</span> gv<span class="token punctuation">,</span> gv<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å®šä¹‰åœ¨/pkg/client/restclient/config.go</span>    <span class="token keyword">return</span> restclient<span class="token punctuation">.</span><span class="token function">RESTClientFor</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>è€Œ resource.ClientMapperFunc å®šä¹‰åœ¨<code>/pkg/kubectl/resource/interfaces.go</code>ä¸­ï¼š</p><pre><code>type ClientMapperFunc func(mapping *meta.RESTMapping) (RESTClient, error)// ClientForMapping implements ClientMapperfunc (f ClientMapperFunc) ClientForMapping(mapping *meta.RESTMapping) (RESTClient, error) {    return f(mapping)}</code></pre><p>æ‰€ä»¥ï¼Œè°ƒç”¨ClientMapperçš„ClientForMapping()æ–¹æ³•å°±ç›¸å…³äºè°ƒç”¨factoryçš„ClientForMapping()æ–¹æ³•ã€‚</p><h4 id="f-Decoder"><a href="#f-Decoder" class="headerlink" title="f.Decoder()"></a>f.Decoder()</h4><p>Decoder()å®šä¹‰åœ¨<code>/pkg/kubectl/cmd/util/factory.go</code>ä¸­ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>factory<span class="token punctuation">)</span> <span class="token function">Decoder</span><span class="token punctuation">(</span>toInternal <span class="token builtin">bool</span><span class="token punctuation">)</span> runtime<span class="token punctuation">.</span>Decoder <span class="token punctuation">{</span>    <span class="token keyword">var</span> decoder runtime<span class="token punctuation">.</span>Decoder    <span class="token keyword">if</span> toInternal <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// api.Codecså®šä¹‰åœ¨pkg/api/register.goä¸­/</span>        decoder <span class="token operator">=</span> api<span class="token punctuation">.</span>Codecs<span class="token punctuation">.</span><span class="token function">UniversalDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        decoder <span class="token operator">=</span> api<span class="token punctuation">.</span>Codecs<span class="token punctuation">.</span><span class="token function">UniversalDeserializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> thirdpartyresourcedata<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>decoder<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>å› ä¸ºä¼ å…¥çš„toInternalä¸ºtrueï¼Œæ‰€ä»¥Decoderä¸ºapi.Codecs.UniversalDecoder()ã€‚è¿™é‡Œä¸å†å‘ä¸‹åˆ†æï¼Œåªéœ€çŸ¥é“è¯¥Decoderå¯ä»¥æŠŠç›¸å…³ç‰ˆæœ¬çš„å¯¹è±¡è½¬æ¢æˆå†…éƒ¨ç‰ˆæœ¬çš„å¯¹è±¡ã€‚</p><h4 id="RESTMapping"><a href="#RESTMapping" class="headerlink" title="RESTMapping()"></a>RESTMapping()</h4><p>è°ƒç”¨çš„RESTMapperçš„RESTMapping()</p><h4 id="ClientForMapping"><a href="#ClientForMapping" class="headerlink" title="ClientForMapping()"></a>ClientForMapping()</h4><p>è°ƒç”¨çš„å°±æ˜¯f.ClientForMapping()</p><h3 id="Printer"><a href="#Printer" class="headerlink" title="Printer"></a>Printer</h3><p>Printerå¯ä»¥å¯¹Kubernetesä¸­çš„èµ„æºæŒ‰ä¸€å®šæ ¼å¼è¿›è¡Œæ‰“å°è¾“å‡ºï¼ŒPrinterä¸»è¦ä¾›Kubectl getå‘½ä»¤ä½¿ç”¨ã€‚ç›®å‰Kubectlä¸»è¦å®ç°äº†JsonPrinter, YAMLPrinter, NamePrinter, TemplatePrinter, JSONPathPrinter, CustomColumnsPrinter, VersionedPrinter, HumanReadablePrinterã€‚</p><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/cli-runtime/pkg/printers/interface.go#L35" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/cli-runtime/pkg/printers/interface.go </a></p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ResourcePrinterFunc is a function that can print objects</span><span class="token keyword">type</span> ResourcePrinterFunc <span class="token keyword">func</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token comment" spellcheck="true">// PrintObj implements ResourcePrinter</span><span class="token keyword">func</span> <span class="token punctuation">(</span>fn ResourcePrinterFunc<span class="token punctuation">)</span> <span class="token function">PrintObj</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ResourcePrinter is an interface that knows how to print runtime objects.</span><span class="token keyword">type</span> ResourcePrinter <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Print receives a runtime object, formats it and prints it to a writer.</span>    <span class="token function">PrintObj</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// PrintOptions struct defines a struct for various print options</span><span class="token keyword">type</span> PrintOptions <span class="token keyword">struct</span> <span class="token punctuation">{</span>    NoHeaders     <span class="token builtin">bool</span>    WithNamespace <span class="token builtin">bool</span>    WithKind      <span class="token builtin">bool</span>    Wide          <span class="token builtin">bool</span>    ShowLabels    <span class="token builtin">bool</span>    Kind          schema<span class="token punctuation">.</span>GroupKind    ColumnLabels  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>    SortBy <span class="token builtin">string</span>    <span class="token comment" spellcheck="true">// indicates if it is OK to ignore missing keys for rendering an output template.</span>    AllowMissingKeys <span class="token builtin">bool</span><span class="token punctuation">}</span></code></pre><h4 id="JSONPrinter"><a href="#JSONPrinter" class="headerlink" title="JSONPrinter"></a>JSONPrinter</h4><p>JSONPrinter å¯ä»¥ä»¥JSONçš„æ ¼å¼æ‰“å°Objectã€‚JSONPrinterè°ƒç”¨äº†json.MarshalIndent()æ¥å¯¹Objè¿›è¡ŒJSONæ ¼å¼åŒ–æ‰“å°ã€‚json.MarshalIndent()å‡½æ•°çš„åŠŸèƒ½å’ŒMarshalä¸€è‡´ï¼Œåªæ˜¯æŠŠObjectæ ¼å¼åŒ–æˆäººæ€§åŒ–é˜…è¯»çš„JSONï¼Œæœ‰ç‚¹ç±»ä¼¼â€| python -mjson.toolâ€çš„åŠŸèƒ½ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// JSONPrinter is an implementation of ResourcePrinter which outputs an object as JSON.</span><span class="token keyword">type</span> JSONPrinter <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>JSONPrinter<span class="token punctuation">)</span> <span class="token function">AfterPrint</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> res <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// PrintObj is an implementation of ResourcePrinter.PrintObj which simply writes the object to the Writer.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>JSONPrinter<span class="token punctuation">)</span> <span class="token function">PrintObj</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">switch</span> obj <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Unknown<span class="token punctuation">:</span>        <span class="token keyword">var</span> buf bytes<span class="token punctuation">.</span>Buffer        err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Indent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> obj<span class="token punctuation">.</span>Raw<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"    "</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        buf<span class="token punctuation">.</span><span class="token function">WriteRune</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>        <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">WriteTo</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">MarshalIndent</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"    "</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    data <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>    <span class="token keyword">return</span> err<span class="token punctuation">}</span><span class="token comment" spellcheck="true">// TODO: implement HandledResources()</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>JSONPrinter<span class="token punctuation">)</span> <span class="token function">HandledResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>è°ƒç”¨ä¾‹å­ï¼š</p><pre><code>kubectl get pods -o json</code></pre><h4 id="YAMLPrinter"><a href="#YAMLPrinter" class="headerlink" title="YAMLPrinter"></a>YAMLPrinter</h4><p>YAMLPrinterå¯ä»¥ä»¥YAMLçš„æ ¼å¼æ‰“å°Objectã€‚YAMLPrinteré€šè¿‡è°ƒç”¨yaml.Marshal()æŠŠObjectè½¬æ¢æˆYAMLæ ¼å¼å¹¶è¿›è¡Œæ‰“å°ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// YAMLPrinter is an implementation of ResourcePrinter which outputs an object as YAML.</span><span class="token comment" spellcheck="true">// The input object is assumed to be in the internal version of an API and is converted</span><span class="token comment" spellcheck="true">// to the given version first.</span><span class="token keyword">type</span> YAMLPrinter <span class="token keyword">struct</span> <span class="token punctuation">{</span>    version   <span class="token builtin">string</span>    converter runtime<span class="token punctuation">.</span>ObjectConvertor<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>YAMLPrinter<span class="token punctuation">)</span> <span class="token function">AfterPrint</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> res <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// PrintObj prints the data as YAML.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>YAMLPrinter<span class="token punctuation">)</span> <span class="token function">PrintObj</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">switch</span> obj <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Unknown<span class="token punctuation">:</span>        data<span class="token punctuation">,</span> err <span class="token operator">:=</span> yaml<span class="token punctuation">.</span><span class="token function">JSONToYAML</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>Raw<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æŠŠobjè½¬æˆyamlæ ¼å¼</span>    output<span class="token punctuation">,</span> err <span class="token operator">:=</span> yaml<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprint</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> err<span class="token punctuation">}</span></code></pre><p>è°ƒç”¨ä¾‹å­ï¼š</p><pre><code>kubectl get pods -o yaml</code></pre><h4 id="NamePrinter"><a href="#NamePrinter" class="headerlink" title="NamePrinter"></a>NamePrinter</h4><p>NamePrinterå¯ä»¥æ‰“å°èµ„æºç±»å‹å’Œåç§°ï¼šå¦‚pod/ubuntu-ssh-589933015-2lhgbã€‚NamePrinterå…ˆè·åˆ¤æ–­Objectæ˜¯å¦ä¸ºåˆ—è¡¨ï¼Œå¦‚æœæ˜¯åˆ—è¡¨ï¼Œåˆ™é€’å½’è°ƒç”¨PrintObjï¼›å¦åˆ™å…ˆè·å–Objectçš„nameï¼Œç„¶åè·å–Objectçš„Kindï¼Œå¹¶è½¬æ¢æˆå•æ•°å½¢å¼çš„GVRï¼Œç„¶åè¿”å›ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// NamePrinter is an implementation of ResourcePrinter which outputs "resource/name" pair of an object.</span><span class="token keyword">type</span> NamePrinter <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Decoder runtime<span class="token punctuation">.</span>Decoder    Typer   runtime<span class="token punctuation">.</span>ObjectTyper<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>NamePrinter<span class="token punctuation">)</span> <span class="token function">AfterPrint</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> res <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// PrintObj is an implementation of ResourcePrinter.PrintObj which decodes the object</span><span class="token comment" spellcheck="true">// and print "resource/name" pair. If the object is a List, print all items in it.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>NamePrinter<span class="token punctuation">)</span> <span class="token function">PrintObj</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> meta<span class="token punctuation">.</span><span class="token function">IsListType</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>        items<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">ExtractList</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        <span class="token keyword">if</span> errs <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">DecodeList</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> p<span class="token punctuation">.</span>Decoder<span class="token punctuation">,</span> runtime<span class="token punctuation">.</span>UnstructuredJSONScheme<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> obj <span class="token operator">:=</span> <span class="token keyword">range</span> items <span class="token punctuation">{</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">PrintObj</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> err            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    name <span class="token operator">:=</span> <span class="token string">"&lt;unknown>"</span>    <span class="token comment" spellcheck="true">// è·å–name</span>    <span class="token keyword">if</span> acc<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">Accessor</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> n <span class="token operator">:=</span> acc<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>            name <span class="token operator">=</span> n        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> kind <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token function">GetObjectKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupVersionKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>kind<span class="token punctuation">.</span>Kind<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// this is the old code.  It's unnecessary on decoded external objects, but on internal objects</span>        <span class="token comment" spellcheck="true">// you may have to do it.  Tests are definitely calling it with internals and I'm not sure who else</span>        <span class="token comment" spellcheck="true">// is</span>        <span class="token keyword">if</span> gvks<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span>Typer<span class="token punctuation">.</span><span class="token function">ObjectKinds</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// TODO: this is wrong, it assumes that meta knows about all Kinds - should take a RESTMapper</span>            <span class="token boolean">_</span><span class="token punctuation">,</span> resource <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">KindToResource</span><span class="token punctuation">(</span>gvks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"%s/%s\n"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> name<span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"&lt;unknown>/%s\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// TODO: this is wrong, it assumes that meta knows about all Kinds - should take a RESTMapper</span>        <span class="token comment" spellcheck="true">// ç›´æ¥è°ƒç”¨KindToResource()æŠŠGVKè½¬æ¢æˆGVRï¼Œå¹¶é€‰ç”¨å•æ•°å½¢å¼</span>        <span class="token boolean">_</span><span class="token punctuation">,</span> resource <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">KindToResource</span><span class="token punctuation">(</span>kind<span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"%s/%s\n"</span><span class="token punctuation">,</span> resource<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> name<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>è°ƒç”¨ä¾‹å­ï¼š</p><pre><code># kubectl get pods -o namepod/nginx-1487191267-0t8x3pod/ubuntu-ssh-589933015-2lhgb</code></pre><h4 id="TemplatePrinter"><a href="#TemplatePrinter" class="headerlink" title="TemplatePrinter"></a>TemplatePrinter</h4><p>TemplatePrinteråŸºäºtxt/templateåŒ…å®ç°ã€‚txt/templateä¸€èˆ¬çš„ç”¨æ³•ä¸ºï¼š<br>å®šä¹‰æ¨¡æ¿ï¼š</p><pre class=" language-go"><code class="language-go">tmpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"hello, {{.}}"</span><span class="token punctuation">)</span></code></pre><p>æ‰§è¡Œï¼š</p><pre><code>err = tmpl.Execute(os.Stdout, name)</code></pre><p>TemplatePrinterå®šä¹‰å¦‚ä¸‹ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// TemplatePrinter is an implementation of ResourcePrinter which formats data with a Go Template.</span><span class="token comment" spellcheck="true">// è°ƒç”¨text/templateåŒ…</span><span class="token keyword">type</span> TemplatePrinter <span class="token keyword">struct</span> <span class="token punctuation">{</span>    rawTemplate <span class="token builtin">string</span>    template    <span class="token operator">*</span>template<span class="token punctuation">.</span>Template<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">NewTemplatePrinter</span><span class="token punctuation">(</span>tmpl <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>TemplatePrinter<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    t<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"output"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">Funcs</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span>FuncMap<span class="token punctuation">{</span><span class="token string">"exists"</span><span class="token punctuation">:</span> exists<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>        <span class="token function">Parse</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>TemplatePrinter<span class="token punctuation">{</span>        rawTemplate<span class="token punctuation">:</span> <span class="token function">string</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">)</span><span class="token punctuation">,</span>        template<span class="token punctuation">:</span>    t<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TemplatePrinter<span class="token punctuation">)</span> <span class="token function">AfterPrint</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> res <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// PrintObj formats the obj with the Go Template.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TemplatePrinter<span class="token punctuation">)</span> <span class="token function">PrintObj</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>    <span class="token keyword">var</span> err <span class="token builtin">error</span>    <span class="token keyword">if</span> unstructured<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>runtime<span class="token punctuation">.</span>Unstructured<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>        data<span class="token punctuation">,</span> err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>unstructured<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        data<span class="token punctuation">,</span> err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    out <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">safeExecute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// It is way easier to debug this stuff when it shows up in</span>        <span class="token comment" spellcheck="true">// stdout instead of just stdin. So in addition to returning</span>        <span class="token comment" spellcheck="true">// a nice error, also print useful stuff with the writer.</span>        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Error executing template: %v. Printing more information for debugging the template:\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"\ttemplate was:\n\t\t%v\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>rawTemplate<span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"\traw data was:\n\t\t%v\n"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"\tobject given to template engine was:\n\t\t%+v\n\n"</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span>        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"error executing template %q: %v"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>rawTemplate<span class="token punctuation">,</span> err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// TODO: implement HandledResources()</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TemplatePrinter<span class="token punctuation">)</span> <span class="token function">HandledResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>è°ƒç”¨ä¾‹å­ï¼š</p><pre><code># kubectl get pods nginx-1487191267-0t8x3 -o go-template="The name is {{.metadata.name}}"The name is nginx-1487191267-0t8x3</code></pre><p>æˆ–è€…</p><pre><code># kubectl get pods nginx-1487191267-0t8x3 -o go-template-file=template The name is nginx-1487191267-0t8x3</code></pre><p>å…¶ä¸­<code>go-template-file=template</code>çš„templateä¸ºæ–‡ä»¶ï¼Œå†…å®¹ä¸º:</p><pre><code>The name is {{.metadata.name}}</code></pre><h4 id="JSONPathPrinter"><a href="#JSONPathPrinter" class="headerlink" title="JSONPathPrinter"></a>JSONPathPrinter</h4><p>JSONPathPrinterå®ç°äº†ä¸€å¥—åŒ¹é…è§„åˆ™ï¼Œè¯¦è§<a href="https://kubernetes.io/docs/user-guide/jsonpath/ã€‚" target="_blank" rel="noopener">https://kubernetes.io/docs/user-guide/jsonpath/ã€‚</a><br>jsonpathå…·ä½“åœ¨<code>/pkg/util/jsonpath/jsonpath.go</code>ä¸­å®ç°ï¼Œå…·ä½“åˆ†ææ­¤å¤„ç•¥ã€‚</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// JSONPathPrinter is an implementation of ResourcePrinter which formats data with jsonpath expression.</span><span class="token keyword">type</span> JSONPathPrinter <span class="token keyword">struct</span> <span class="token punctuation">{</span>    rawTemplate <span class="token builtin">string</span>    <span class="token operator">*</span>jsonpath<span class="token punctuation">.</span>JSONPath<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">NewJSONPathPrinter</span><span class="token punctuation">(</span>tmpl <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>JSONPathPrinter<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    j <span class="token operator">:=</span> jsonpath<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"out"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> j<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>JSONPathPrinter<span class="token punctuation">{</span>tmpl<span class="token punctuation">,</span> j<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>j <span class="token operator">*</span>JSONPathPrinter<span class="token punctuation">)</span> <span class="token function">AfterPrint</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> res <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// PrintObj formats the obj with the JSONPath Template.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>j <span class="token operator">*</span>JSONPathPrinter<span class="token punctuation">)</span> <span class="token function">PrintObj</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> queryObj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">=</span> obj    <span class="token keyword">if</span> meta<span class="token punctuation">.</span><span class="token function">IsListType</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>        data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        queryObj <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>queryObj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> unknown<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>runtime<span class="token punctuation">.</span>Unknown<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>        data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>unknown<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>        queryObj <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>queryObj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> unstructured<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>runtime<span class="token punctuation">.</span>Unstructured<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>        queryObj <span class="token operator">=</span> unstructured<span class="token punctuation">.</span>Object    <span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> j<span class="token punctuation">.</span>JSONPath<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> queryObj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Error executing template: %v. Printing more information for debugging the template:\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"\ttemplate was:\n\t\t%v\n"</span><span class="token punctuation">,</span> j<span class="token punctuation">.</span>rawTemplate<span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"\tobject given to jsonpath engine was:\n\t\t%#v\n\n"</span><span class="token punctuation">,</span> queryObj<span class="token punctuation">)</span>        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"error executing jsonpath %q: %v\n"</span><span class="token punctuation">,</span> j<span class="token punctuation">.</span>rawTemplate<span class="token punctuation">,</span> err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// TODO: implement HandledResources()</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>JSONPathPrinter<span class="token punctuation">)</span> <span class="token function">HandledResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>è°ƒç”¨ä¾‹å­ï¼š</p><pre><code># kubectl get pods -o jsonpath={.items[*].metadata.name}nginx-1487191267-0t8x3 ubuntu-ssh-589933015-2lhgb</code></pre><p>æˆ–è€…</p><pre><code># kubectl get pods -o jsonpath-file=templatenginx-1487191267-0t8x3 ubuntu-ssh-589933015-2lhgb</code></pre><p>å…¶ä¸­<code>jsonpath-file=template</code>çš„templateä¸ºæ–‡ä»¶ï¼Œå†…å®¹ä¸º:</p><pre><code>{.items[*].metadata.name}</code></pre><h4 id="CustomColumnsPrinter"><a href="#CustomColumnsPrinter" class="headerlink" title="CustomColumnsPrinter"></a>CustomColumnsPrinter</h4><p>CustomColumnsPrinterå…è®¸ç”¨æˆ·å®šä¹‰åˆ—åï¼Œæ˜¯JSONPathçš„åŠ å¼ºç‰ˆã€‚æ”¯æŒä»å‘½ä»¤è¡Œç›´æ¥è¾“å…¥æ¨¡æ¿å’Œä»æ–‡ä»¶è¯»å–æ¨¡æ¿ä¸¤ç§æ–¹å¼ã€‚</p><p>è¯»å–å‘½ä»¤è¡Œæ¨¡æ¿çš„CustomColumnsPrinterç”Ÿæˆå‡½æ•°å¦‚ä¸‹ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token operator">/</span><span class="token comment" spellcheck="true">/***kubectl get pods -o custom-columns=Type:{.kind},Name:{.metadata.name}***/</span><span class="token operator">/</span><span class="token keyword">func</span> <span class="token function">NewCustomColumnsPrinterFromSpec</span><span class="token punctuation">(</span>spec <span class="token builtin">string</span><span class="token punctuation">,</span> decoder runtime<span class="token punctuation">.</span>Decoder<span class="token punctuation">,</span> noHeaders <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>CustomColumnsPrinter<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"custom-columns format specified but no custom columns given"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// parts: [Type:{.kind} Name:{.metadata.name}]</span>    parts <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>spec<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span>    columns <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Column<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> ix <span class="token operator">:=</span> <span class="token keyword">range</span> parts <span class="token punctuation">{</span>        colSpec <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>colSpec<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unexpected custom-columns spec: %s, expected &lt;header>:&lt;json-path-expr>"</span><span class="token punctuation">,</span> parts<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        spec<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">massageJSONPath</span><span class="token punctuation">(</span>colSpec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        columns<span class="token punctuation">[</span>ix<span class="token punctuation">]</span> <span class="token operator">=</span> Column<span class="token punctuation">{</span>Header<span class="token punctuation">:</span> colSpec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> FieldSpec<span class="token punctuation">:</span> spec<span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>CustomColumnsPrinter<span class="token punctuation">{</span>Columns<span class="token punctuation">:</span> columns<span class="token punctuation">,</span> Decoder<span class="token punctuation">:</span> decoder<span class="token punctuation">,</span> NoHeaders<span class="token punctuation">:</span> noHeaders<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>è¯»å–æ–‡ä»¶æ¨¡æ¿çš„CustomColumnsPrinterç”Ÿæˆå‡½æ•°å¦‚ä¸‹ï¼š</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// kubectl get pods -o custom-columns-file=/home/fankang/template</span><span class="token keyword">func</span> <span class="token function">NewCustomColumnsPrinterFromTemplate</span><span class="token punctuation">(</span>templateReader io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> decoder runtime<span class="token punctuation">.</span>Decoder<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>CustomColumnsPrinter<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    scanner <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewScanner</span><span class="token punctuation">(</span>templateReader<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">!</span>scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid template, missing header line. Expected format is one line of space separated headers, one line of space separated column specs."</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// headers: [Type Name]</span>    headers <span class="token operator">:=</span> <span class="token function">splitOnWhitespace</span><span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">!</span>scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid template, missing spec line. Expected format is one line of space separated headers, one line of space separated column specs."</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// specs: [{.kind} {.metadata.name}]</span>    specs <span class="token operator">:=</span> <span class="token function">splitOnWhitespace</span><span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// å¦‚æœheaderså’Œspecsé•¿åº¦ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>specs<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"number of headers (%d) and field specifications (%d) don't match"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>specs<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    columns <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Column<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> ix <span class="token operator">:=</span> <span class="token keyword">range</span> headers <span class="token punctuation">{</span>        spec<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">massageJSONPath</span><span class="token punctuation">(</span>specs<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// ç»„è£…æˆColumn</span>        columns<span class="token punctuation">[</span>ix<span class="token punctuation">]</span> <span class="token operator">=</span> Column<span class="token punctuation">{</span>            Header<span class="token punctuation">:</span>    headers<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">,</span>            FieldSpec<span class="token punctuation">:</span> spec<span class="token punctuation">,</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è¿”å›CustomColumnsPrinter</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>CustomColumnsPrinter<span class="token punctuation">{</span>Columns<span class="token punctuation">:</span> columns<span class="token punctuation">,</span> Decoder<span class="token punctuation">:</span> decoder<span class="token punctuation">,</span> NoHeaders<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>CustomColumnsPrinterçš„PrintObj()æ–¹æ³•å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨äº†jsonpath.New()æ¥è§£ææ¨¡æ¿ã€‚</p><pre><code>func (s *CustomColumnsPrinter) PrintObj(obj runtime.Object, out io.Writer) error {    w := tabwriter.NewWriter(out, columnwidth, tabwidth, padding, padding_character, flags)    if !s.NoHeaders {        headers := make([]string, len(s.Columns))        for ix := range s.Columns {            headers[ix] = s.Columns[ix].Header        }        fmt.Fprintln(w, strings.Join(headers, "\t"))    }    parsers := make([]*jsonpath.JSONPath, len(s.Columns))    for ix := range s.Columns {        parsers[ix] = jsonpath.New(fmt.Sprintf("column%d", ix))        if err := parsers[ix].Parse(s.Columns[ix].FieldSpec); err != nil {            return err        }    }    if meta.IsListType(obj) {        objs, err := meta.ExtractList(obj)        if err != nil {            return err        }        for ix := range objs {            if err := s.printOneObject(objs[ix], parsers, w); err != nil {                return err            }        }    } else {        if err := s.printOneObject(obj, parsers, w); err != nil {            return err        }    }    return w.Flush()}</code></pre><p>è°ƒç”¨ä¾‹å­ï¼š</p><pre><code># kubectl get pods -o custom-columns=Type:{.kind},Name:{.metadata.name}Type      NamePod       nginx-1487191267-0t8x3Pod       ubuntu-ssh-589933015-2lhgb</code></pre><p>æˆ–è€…</p><pre><code># kubectl get pods -o custom-columns-file=templateType      NamePod       nginx-1487191267-0t8x3Pod       ubuntu-ssh-589933015-2lhgb</code></pre><p>å…¶ä¸­<code>custom-columns-file=template</code>çš„templateä¸ºæ–‡ä»¶ï¼Œå†…å®¹ä¸º:</p><pre><code>Type              Name{.kind}           {.metadata.name}</code></pre><h4 id="VersionedPrinter"><a href="#VersionedPrinter" class="headerlink" title="VersionedPrinter"></a>VersionedPrinter</h4><p>VersionedPrinteræ˜¯å¯¹å…¶ä»–Printerçš„å°è£…ï¼Œå…ˆæŠŠObjectè½¬æ¢æˆå¯¹åº”ç‰ˆæœ¬çš„Objectï¼Œç„¶åå†å°è£…çš„Printerè¿›è¡Œæ‰“å°ã€‚</p><pre><code>// VersionedPrinter takes runtime objects and ensures they are converted to a given API version// prior to being passed to a nested printer.type VersionedPrinter struct {    printer   ResourcePrinter    converter runtime.ObjectConvertor    versions  []unversioned.GroupVersion}// NewVersionedPrinter wraps a printer to convert objects to a known API version prior to printing.func NewVersionedPrinter(printer ResourcePrinter, converter runtime.ObjectConvertor, versions ...unversioned.GroupVersion) ResourcePrinter {    return &amp;VersionedPrinter{        printer:   printer,        converter: converter,        versions:  versions,    }}func (p *VersionedPrinter) AfterPrint(w io.Writer, res string) error {    return nil}// PrintObj implements ResourcePrinterfunc (p *VersionedPrinter) PrintObj(obj runtime.Object, w io.Writer) error {    if len(p.versions) == 0 {        return fmt.Errorf("no version specified, object cannot be converted")    }    converted, err := p.converter.ConvertToVersion(obj, unversioned.GroupVersions(p.versions))    if err != nil {        return err    }    return p.printer.PrintObj(converted, w)}</code></pre><p>versionç”±<code>kubectl get pods --output-version='v1' -o yaml -w</code>çš„â€“output-versionæŒ‡å®šï¼Œä½†æ²¡ä»€ä¹ˆä½œç”¨ï¼Œè€Œä¸”kubectl getä»£ç ä¸­åªæœ‰Watchä¼šä½¿ç”¨VersionedPrinterï¼Œæ‰€ä»¥è¿˜å¾…æ›´æ·±å…¥çš„ç ”ç©¶ã€‚</p><h4 id="HumanReadablePrinter"><a href="#HumanReadablePrinter" class="headerlink" title="HumanReadablePrinter"></a>HumanReadablePrinter</h4><p>HumanReadablePrinterå¯ä»¥â€äººæ€§åŒ–â€åœ°è¾“å‡ºå†…å®¹ã€‚HumanReadablePrinterä¸­æœ‰handlerMapï¼ŒhandlerMapè®°å½•äº†å¾…æ‰“å°çš„å¯¹è±¡åˆ°å¤„ç†å‡½æ•°çš„æ˜ å°„å…³ç³»ã€‚ç³»ç»Ÿä¸­æ¯ç§èµ„æºéƒ½æœ‰å¯¹åº”çš„æ‰“å°å‡½æ•°ã€‚</p><p>å…¶ä¸­<code>kubectl -o wide</code>è°ƒç”¨çš„ä¹Ÿæ˜¯HumanReadablePrinterã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> HumanReadablePrinter <span class="token keyword">struct</span> <span class="token punctuation">{</span>    handlerMap   <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span><span class="token operator">*</span>handlerEntry    options      PrintOptions    lastType     reflect<span class="token punctuation">.</span>Type    hiddenObjNum <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// NewHumanReadablePrinter creates a HumanReadablePrinter.</span><span class="token comment" spellcheck="true">// åˆ›å»ºHumanReadablePrinter</span><span class="token keyword">func</span> <span class="token function">NewHumanReadablePrinter</span><span class="token punctuation">(</span>options PrintOptions<span class="token punctuation">)</span> <span class="token operator">*</span>HumanReadablePrinter <span class="token punctuation">{</span>    printer <span class="token operator">:=</span> <span class="token operator">&amp;</span>HumanReadablePrinter<span class="token punctuation">{</span>        handlerMap<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span><span class="token operator">*</span>handlerEntry<span class="token punctuation">)</span><span class="token punctuation">,</span>        options<span class="token punctuation">:</span>    options<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    printer<span class="token punctuation">.</span><span class="token function">addDefaultHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> printer<span class="token punctuation">}</span><span class="token comment" spellcheck="true">// æ‰“å°ç¬¬ä¸€è¡Œæ ‡é¢˜</span><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HumanReadablePrinter<span class="token punctuation">)</span> <span class="token function">printHeader</span><span class="token punctuation">(</span>columnNames <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>columnNames<span class="token punctuation">,</span> <span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// æ‰“å°Pod</span><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HumanReadablePrinter<span class="token punctuation">)</span> <span class="token function">printPod</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>api<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> options PrintOptions<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">printPodBase</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> w<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">printPodBase</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>api<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> options PrintOptions<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    name <span class="token operator">:=</span> <span class="token function">formatResourceName</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>Kind<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> options<span class="token punctuation">.</span>WithKind<span class="token punctuation">)</span>    namespace <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Namespace    restarts <span class="token operator">:=</span> <span class="token number">0</span>    totalContainers <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Containers<span class="token punctuation">)</span>    readyContainers <span class="token operator">:=</span> <span class="token number">0</span>    reason <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Phase<span class="token punctuation">)</span>    <span class="token keyword">if</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Reason <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>        reason <span class="token operator">=</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Reason    <span class="token punctuation">}</span>    initializing <span class="token operator">:=</span> <span class="token boolean">false</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>InitContainerStatuses <span class="token punctuation">{</span>        container <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>InitContainerStatuses<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        restarts <span class="token operator">+=</span> <span class="token function">int</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>RestartCount<span class="token punctuation">)</span>        <span class="token keyword">switch</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>ExitCode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">case</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true">// initialization is failed</span>            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Reason<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Signal <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>                    reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Init:Signal:%d"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Init:ExitCode:%d"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>ExitCode<span class="token punctuation">)</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                reason <span class="token operator">=</span> <span class="token string">"Init:"</span> <span class="token operator">+</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Reason            <span class="token punctuation">}</span>            initializing <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token keyword">case</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting<span class="token punctuation">.</span>Reason<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting<span class="token punctuation">.</span>Reason <span class="token operator">!=</span> <span class="token string">"PodInitializing"</span><span class="token punctuation">:</span>            reason <span class="token operator">=</span> <span class="token string">"Init:"</span> <span class="token operator">+</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting<span class="token punctuation">.</span>Reason            initializing <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token keyword">default</span><span class="token punctuation">:</span>            reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Init:%d/%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>InitContainers<span class="token punctuation">)</span><span class="token punctuation">)</span>            initializing <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token punctuation">}</span>        <span class="token keyword">break</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token operator">!</span>initializing <span class="token punctuation">{</span>        restarts <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>ContainerStatuses<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>            container <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>ContainerStatuses<span class="token punctuation">[</span>i<span class="token punctuation">]</span>            restarts <span class="token operator">+=</span> <span class="token function">int</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>RestartCount<span class="token punctuation">)</span>            <span class="token keyword">if</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting<span class="token punctuation">.</span>Reason <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>                reason <span class="token operator">=</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Waiting<span class="token punctuation">.</span>Reason            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Reason <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>                reason <span class="token operator">=</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Reason            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Reason <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Signal <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>                    reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Signal:%d"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"ExitCode:%d"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Terminated<span class="token punctuation">.</span>ExitCode<span class="token punctuation">)</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> container<span class="token punctuation">.</span>Ready <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Running <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                readyContainers<span class="token operator">++</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> pod<span class="token punctuation">.</span>DeletionTimestamp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Reason <span class="token operator">==</span> node<span class="token punctuation">.</span>NodeUnreachablePodReason <span class="token punctuation">{</span>        reason <span class="token operator">=</span> <span class="token string">"Unknown"</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> pod<span class="token punctuation">.</span>DeletionTimestamp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        reason <span class="token operator">=</span> <span class="token string">"Terminating"</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> options<span class="token punctuation">.</span>WithNamespace <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"%s\t"</span><span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"%s\t%d/%d\t%s\t%d\t%s"</span><span class="token punctuation">,</span>        name<span class="token punctuation">,</span>        readyContainers<span class="token punctuation">,</span>        totalContainers<span class="token punctuation">,</span>        reason<span class="token punctuation">,</span>        restarts<span class="token punctuation">,</span>        <span class="token function">translateTimestamp</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>CreationTimestamp<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// -o wideåˆ™å†™å…¥IPå’ŒNODE</span>    <span class="token keyword">if</span> options<span class="token punctuation">.</span>Wide <span class="token punctuation">{</span>        nodeName <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeName        podIP <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>PodIP        <span class="token keyword">if</span> podIP <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>            podIP <span class="token operator">=</span> <span class="token string">"&lt;none>"</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"\t%s\t%s"</span><span class="token punctuation">,</span>            podIP<span class="token punctuation">,</span>            nodeName<span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprint</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token function">AppendLabels</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Labels<span class="token punctuation">,</span> options<span class="token punctuation">.</span>ColumnLabels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprint</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token function">AppendAllLabels</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>ShowLabels<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>è°ƒç”¨ä¾‹å­ï¼š</p><pre><code># kubectl get podsNAME                                READY   STATUS    RESTARTS   AGEnginx-deployment-7c96855774-c5xbp   1/1     Running   0          28snginx-deployment-7c96855774-lqzr4   1/1     Running   0          28snginx-deployment-7c96855774-txw7c   1/1     Running   0          28snginx-deployment-7c96855774-vjm6p   1/1     Running   0          28s</code></pre><p>æˆ–è€…</p><pre><code># kubectl get pods -o wideNAME                                READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATESnginx-deployment-7c96855774-c5xbp   1/1     Running   0          5s    10.100.166.154   node1   &lt;none&gt;           &lt;none&gt;nginx-deployment-7c96855774-lqzr4   1/1     Running   0          5s    10.100.166.153   node1   &lt;none&gt;           &lt;none&gt;nginx-deployment-7c96855774-txw7c   1/1     Running   0          5s    10.100.104.33    node2   &lt;none&gt;           &lt;none&gt;nginx-deployment-7c96855774-vjm6p   1/1     Running   0          5s    10.100.104.34    node2   &lt;none&gt;           &lt;none&gt;[root@master work]#</code></pre><h3 id="Describer"><a href="#Describer" class="headerlink" title="Describer"></a>Describer</h3><p>Describer æ˜¯ Kubectl ä¸Šç”¨æ¥æè¿°å¯¹è±¡å…·ä½“ä¿¡æ¯çš„ï¼Œå’Œ<code>kubectl describe</code>é…åˆä½¿ç”¨ã€‚</p><p>ä»£ç è·¯å¾„ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.18.0/staging/src/k8s.io/kubectl/pkg/describe/interface.go#L43" target="_blank" rel="noopener">kubernetes/staging/src/k8s.io/kubectl/pkg/describe/interface.go</a></p><p>Describer( )å‡½æ•°ï¼Œå¯ä»¥ä¾æ® mapping ç”Ÿæˆåˆé€‚çš„ Describerã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> ResourceDescriber <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token function">Describe</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> describerSettings DescriberSettings<span class="token punctuation">)</span> <span class="token punctuation">(</span>output <span class="token builtin">string</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåªè¦å®ç°äº†Describe()çš„ç»“æ„ä½“éƒ½å¯ä»¥ç§°ä¸ºDescriberã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨<code>/pkg/kubectl/describer.go</code>ä¸­ï¼Œå®ç°äº† PodDescriber, ReplicationControllerDescriber, SecretDescriber, ServiceDescriber, ServiceAccountDescriber, NodeDescriber, LimitRangeDescriber, ResourceQuotaDescriber, PersistentVolumeDescriber, PersistentVolumeClaimDescriber, NamespaceDescriber, EndpointsDescriber, ConfigMapDescriber, ReplicaSetDescriber, HorizontalPodAutoscalerDescriber, NetworkPolicyDescriber, HorizontalPodAutoscalerDescriber, DaemonSetDescriber, DeploymentDescriber, JobDescriber, IngressDescriber, JobDescriber, CronJobDescriber, StatefulSetDescriber, CertificateSigningRequestDescriber, StorageClassDescriber, PodDisruptionBudgetDescriberã€‚</p><p>åœ¨å®ç°Describerçš„ç»“æ„ä½“ä¸­ï¼Œé€šå¸¸ä¼šåµŒå…¥ä¸€ä¸ªclientsetï¼Œç”¨æ¥åœ¨Describe()ä¸­è·å–å…·ä½“çš„Objectã€‚æ¯”å¦‚è¯´ä¸‹é¢çš„ReplicationControllerDescriberã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>ReplicationControllerDescriber<span class="token punctuation">)</span> <span class="token function">Describe</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> describerSettings DescriberSettings<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    rc <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReplicationControllers</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span>    pc <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span>    controller<span class="token punctuation">,</span> err <span class="token operator">:=</span> rc<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>GetOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    running<span class="token punctuation">,</span> waiting<span class="token punctuation">,</span> succeeded<span class="token punctuation">,</span> failed<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getPodStatusForController</span><span class="token punctuation">(</span>pc<span class="token punctuation">,</span> labels<span class="token punctuation">.</span><span class="token function">SelectorFromSet</span><span class="token punctuation">(</span>controller<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>UID<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">var</span> events <span class="token operator">*</span>corev1<span class="token punctuation">.</span>EventList    <span class="token keyword">if</span> describerSettings<span class="token punctuation">.</span>ShowEvents <span class="token punctuation">{</span>        events<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Events</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span>scheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> controller<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token function">describeReplicationController</span><span class="token punctuation">(</span>controller<span class="token punctuation">,</span> events<span class="token punctuation">,</span> running<span class="token punctuation">,</span> waiting<span class="token punctuation">,</span> succeeded<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="DescriberMap"><a href="#DescriberMap" class="headerlink" title="DescriberMap"></a>DescriberMap</h4><p>DescriberMapä¸­è®°å½•äº†GKå’ŒDescriberçš„å…³ç³»ã€‚è¿™é‡Œä½¿ç”¨GKä½œä¸ºKeyï¼Œå› ä¸ºGKè¶³ä»¥æ ‡è®°ä¸€ä¸ªç±»å‹ã€‚ç›®å‰è¿˜ä¸æ”¯æŒåŒåKindå‡ºç°åœ¨ä¸åŒçš„Group(internalé™¤å¤–)ä¸­(å¦åˆ™resourceæ— æ³•æ‰¾åˆ°åˆé€‚çš„GVK)ï¼Œæ‰€ä»¥æ„Ÿè§‰å®Œå…¨å¯ä»¥ä»…ä½¿ç”¨Kindä½œä¸ºKeyã€‚</p><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">describerMap</span><span class="token punctuation">(</span>clientConfig <span class="token operator">*</span>rest<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupKind<span class="token punctuation">]</span>ResourceDescriber<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    c<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientset<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    m <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>schema<span class="token punctuation">.</span>GroupKind<span class="token punctuation">]</span>ResourceDescriber<span class="token punctuation">{</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Pod"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                                    <span class="token operator">&amp;</span>PodDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ReplicationController"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                  <span class="token operator">&amp;</span>ReplicationControllerDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Secret"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                                 <span class="token operator">&amp;</span>SecretDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Service"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                                <span class="token operator">&amp;</span>ServiceDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ServiceAccount"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                         <span class="token operator">&amp;</span>ServiceAccountDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Node"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                                   <span class="token operator">&amp;</span>NodeDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"LimitRange"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                             <span class="token operator">&amp;</span>LimitRangeDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ResourceQuota"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                          <span class="token operator">&amp;</span>ResourceQuotaDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"PersistentVolume"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                       <span class="token operator">&amp;</span>PersistentVolumeDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"PersistentVolumeClaim"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                  <span class="token operator">&amp;</span>PersistentVolumeClaimDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Namespace"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                              <span class="token operator">&amp;</span>NamespaceDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Endpoints"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                              <span class="token operator">&amp;</span>EndpointsDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ConfigMap"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                              <span class="token operator">&amp;</span>ConfigMapDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"PriorityClass"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                          <span class="token operator">&amp;</span>PriorityClassDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> discoveryv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"EndpointSlice"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                <span class="token operator">&amp;</span>EndpointSliceDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> extensionsv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ReplicaSet"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                  <span class="token operator">&amp;</span>ReplicaSetDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> extensionsv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"NetworkPolicy"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>               <span class="token operator">&amp;</span>NetworkPolicyDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> extensionsv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"PodSecurityPolicy"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>           <span class="token operator">&amp;</span>PodSecurityPolicyDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> autoscalingv2beta2<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"HorizontalPodAutoscaler"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>    <span class="token operator">&amp;</span>HorizontalPodAutoscalerDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> extensionsv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"DaemonSet"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                   <span class="token operator">&amp;</span>DaemonSetDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> extensionsv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Deployment"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                  <span class="token operator">&amp;</span>DeploymentDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> extensionsv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Ingress"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                     <span class="token operator">&amp;</span>IngressDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> networkingv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Ingress"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                     <span class="token operator">&amp;</span>IngressDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> networkingv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"IngressClass"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                <span class="token operator">&amp;</span>IngressClassDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> batchv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Job"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                                   <span class="token operator">&amp;</span>JobDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> batchv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"CronJob"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                               <span class="token operator">&amp;</span>CronJobDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> appsv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"StatefulSet"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                            <span class="token operator">&amp;</span>StatefulSetDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> appsv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Deployment"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                             <span class="token operator">&amp;</span>DeploymentDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> appsv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"DaemonSet"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                              <span class="token operator">&amp;</span>DaemonSetDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> appsv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ReplicaSet"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                             <span class="token operator">&amp;</span>ReplicaSetDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> certificatesv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"CertificateSigningRequest"</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>CertificateSigningRequestDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> storagev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"StorageClass"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                        <span class="token operator">&amp;</span>StorageClassDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> storagev1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"CSINode"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                             <span class="token operator">&amp;</span>CSINodeDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> policyv1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"PodDisruptionBudget"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>             <span class="token operator">&amp;</span>PodDisruptionBudgetDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> rbacv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"Role"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                                   <span class="token operator">&amp;</span>RoleDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> rbacv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ClusterRole"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                            <span class="token operator">&amp;</span>ClusterRoleDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> rbacv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"RoleBinding"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                            <span class="token operator">&amp;</span>RoleBindingDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> rbacv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"ClusterRoleBinding"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                     <span class="token operator">&amp;</span>ClusterRoleBindingDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> networkingv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"NetworkPolicy"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                    <span class="token operator">&amp;</span>NetworkPolicyDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>Group<span class="token punctuation">:</span> schedulingv1<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Kind<span class="token punctuation">:</span> <span class="token string">"PriorityClass"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>                    <span class="token operator">&amp;</span>PriorityClassDescriber<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> m<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>æ‰€ä»¥æ¥çœ‹æ¥<code>/pkg/kubectl/describe.go</code>ä¸­çš„DescriberFor()å‡½æ•°ï¼š</p><pre><code>// è¿”å›åˆé€‚çš„describerfunc DescriberFor(kind schema.GroupKind, clientConfig *rest.Config) (ResourceDescriber, bool) {    describers, err := describerMap(clientConfig)    if err != nil {        klog.V(1).Info(err)        return nil, false    }    f, ok := describers[kind]    return f, ok}</code></pre><p>å‡½æ•°çš„å®ç°å¾ˆç®€å•ï¼Œå…ˆè°ƒç”¨describerMap()ç”ŸæˆDescriberMapï¼Œç„¶åæ‰¾åˆ°å¯¹åº”kindçš„Describerã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£ Kubernetes æ¦‚è¿°</title>
      <link href="/2020/05/21/k8s01/"/>
      <url>/2020/05/21/k8s01/</url>
      
        <content type="html"><![CDATA[<h1 id="Kubernetes-æ¶æ„è®¾è®¡"><a href="#Kubernetes-æ¶æ„è®¾è®¡" class="headerlink" title="Kubernetes æ¶æ„è®¾è®¡"></a>Kubernetes æ¶æ„è®¾è®¡</h1><p><img src="/images/2020/Kubernetes-architecture.png" alt=""></p><h2 id="Kubernetes-æµç¨‹"><a href="#Kubernetes-æµç¨‹" class="headerlink" title="Kubernetes æµç¨‹"></a>Kubernetes æµç¨‹</h2><p><img src="/images/2020/what-happens-when-k8s.png" alt=""></p><h2 id="Kubernetes-æ ¸å¿ƒç»„ä»¶"><a href="#Kubernetes-æ ¸å¿ƒç»„ä»¶" class="headerlink" title="Kubernetes æ ¸å¿ƒç»„ä»¶"></a>Kubernetes æ ¸å¿ƒç»„ä»¶</h2><h3 id="Kubectl"><a href="#Kubectl" class="headerlink" title="Kubectl"></a>Kubectl</h3><p>kubectl æ˜¯ç”¨æˆ·ä¸ Kubernetes äº¤äº’çš„å‘½ä»¤è¡Œå·¥å…·ã€‚ç”¨æˆ·ä½¿ç”¨ kubectl å·¥å…·è°ƒç”¨ Apiserver çš„æ¥å£æ¥ä¸ KubernetesæœåŠ¡è¿›è¡Œäº¤äº’ã€‚</p><p>æ›´å¤š kubectl ä¿¡æ¯è¯·å‚è€ƒï¼š<a href="k8s2.md">æ·±å…¥ç†è§£ Kubernetes ä¹‹ Kubectl</a></p><h3 id="Kube-API-server"><a href="#Kube-API-server" class="headerlink" title="Kube API server"></a>Kube API server</h3><p>Kubernetes API server ä¸º api å¯¹è±¡éªŒè¯å¹¶é…ç½®æ•°æ®ï¼ŒåŒ…æ‹¬ podsã€ servicesã€ replicationcontrollers å’Œå…¶å®ƒ api å¯¹è±¡ã€‚API Server æä¾› REST æ“ä½œå’Œåˆ°é›†ç¾¤å…±äº«çŠ¶æ€çš„å‰ç«¯ï¼Œæ‰€æœ‰å…¶ä»–ç»„ä»¶é€šè¿‡å®ƒè¿›è¡Œäº¤äº’ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ•°æ®æ€»çº¿å’Œæ•°æ®ä¸­å¿ƒã€‚</p><p>Kubernetes ä¸­çš„å…¶å®ƒç»„ä»¶éƒ½ä¸ä¼šå’Œ etcd è¿›è¡Œäº¤äº’ï¼Œåªæœ‰ API Server å¯ä»¥å’Œ etcd è¿›è¡Œäº¤äº’,API Server  å…·æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li>æ•´ä¸ªé›†ç¾¤ç®¡ç†çš„ API æ¥å£ï¼šæ‰€æœ‰å¯¹é›†ç¾¤è¿›è¡Œçš„æŸ¥è¯¢å’Œç®¡ç†éƒ½æ˜¯é€šè¿‡ API è¿›è¡Œ</li><li>é›†ç¾¤å†…éƒ¨å„ä¸ªæ¨¡å—ä¹‹é—´é€šä¿¡çš„æ¢çº½ï¼šæ‰€æœ‰æ¨¡å—ä¹‹é—´å¹¶ä¸ä¼šäº’ç›¸è°ƒç”¨ï¼Œè€Œæ˜¯é€šè¿‡å’Œ API Serve ræ‰“äº¤é“å®Œæˆè¿™éƒ¨åˆ†çš„å·¥ä½œ</li><li>é›†ç¾¤çš„å®‰å…¨æ§åˆ¶: API Server æä¾›çš„éªŒè¯å’Œæˆæƒå’Œè®¿é—®æ§åˆ¶ä¿è¯äº†æ•´ä¸ªé›†ç¾¤çš„å®‰å…¨</li></ul><p>æ›´å¤š Kube API server ä¿¡æ¯è¯·å‚è€ƒï¼š<a href="k8s3.md">æ·±å…¥ç†è§£ Kubernetes ä¹‹ Kube API server</a></p><h3 id="Controller-manager"><a href="#Controller-manager" class="headerlink" title="Controller manager"></a>Controller manager</h3><p>Controller Manager å°±æ˜¯é›†ç¾¤å†…éƒ¨çš„ç®¡ç†æ§åˆ¶ä¸­å¿ƒï¼Œç”±è´Ÿè´£ä¸åŒèµ„æºçš„å¤šä¸ª Controller æ„æˆï¼Œå…±åŒè´Ÿè´£é›†ç¾¤å†…çš„ Nodeã€Pod ç­‰æ‰€æœ‰èµ„æºçš„ç®¡ç†ï¼Œæ¯”å¦‚å½“é€šè¿‡ Deployment åˆ›å»ºçš„æŸä¸ª Pod å‘ç”Ÿå¼‚å¸¸é€€å‡ºæ—¶ï¼ŒRS Controller ä¾¿ä¼šæ¥å—å¹¶å¤„ç†è¯¥é€€å‡ºäº‹ä»¶ï¼Œå¹¶åˆ›å»ºæ–°çš„ Pod æ¥ç»´æŒé¢„æœŸå‰¯æœ¬æ•°ã€‚</p><p>å‡ ä¹æ¯ç§ç‰¹å®šèµ„æºéƒ½æœ‰ç‰¹å®šçš„ Controller ç»´æŠ¤ç®¡ç†ä»¥ä¿æŒé¢„æœŸçŠ¶æ€ï¼Œè€Œ Controller Manager çš„èŒè´£ä¾¿æ˜¯æŠŠæ‰€æœ‰çš„ Controller èšåˆèµ·æ¥ï¼š</p><ol><li>æä¾›åŸºç¡€è®¾æ–½é™ä½ Controller çš„å®ç°å¤æ‚åº¦</li><li>å¯åŠ¨å’Œç»´æŒ Controller çš„æ­£å¸¸è¿è¡Œ</li></ol><p>å¯ä»¥è¿™ä¹ˆè¯´ï¼ŒController ä¿è¯é›†ç¾¤å†…çš„èµ„æºä¿æŒé¢„æœŸçŠ¶æ€ï¼Œè€Œ Controller Manager ä¿è¯äº† Controller ä¿æŒåœ¨é¢„æœŸçŠ¶æ€ã€‚</p><p>æ›´å¤š Controller manager ä¿¡æ¯è¯·å‚è€ƒï¼š<a href="k8s4.md">æ·±å…¥ç†è§£ Kubernetes ä¹‹ Controller manager</a></p><h3 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h3><p>è°ƒåº¦æ˜¯ Kubernetes é›†ç¾¤ä¸­è¿›è¡Œå®¹å™¨ç¼–æ’å·¥ä½œæœ€é‡è¦çš„ä¸€ç¯ï¼Œåœ¨ Kubernetesä¸­ï¼ŒController manager è´Ÿè´£åˆ›å»ºPodï¼ŒKubelet è´Ÿè´£æ‰§è¡Œ Podï¼Œè€Œ Scheduler å°±æ˜¯è´Ÿè´£å®‰æ’ Pod åˆ°å…·ä½“çš„ Nodeï¼Œå®ƒé€šè¿‡ API Server æä¾›çš„æ¥å£ç›‘å¬ Pod ä»»åŠ¡åˆ—è¡¨ï¼Œè·å–å¾…è°ƒåº¦ podï¼Œç„¶åæ ¹æ®ä¸€ç³»åˆ—çš„é¢„é€‰ç­–ç•¥å’Œä¼˜é€‰ç­–ç•¥ç»™å„ä¸ª Node èŠ‚ç‚¹æ‰“åˆ†ï¼Œç„¶åå°†Pod å‘é€åˆ°å¾—åˆ†æœ€é«˜çš„ Node èŠ‚ç‚¹ä¸Šï¼Œç”± kubelet è´Ÿè´£æ‰§è¡Œå…·ä½“çš„ä»»åŠ¡å†…å®¹ã€‚</p><p>æ›´å¤š Scheduler  ä¿¡æ¯è¯·å‚è€ƒï¼š<a href="k8s5.md">æ·±å…¥ç†è§£ Kubernetes ä¹‹ Scheduler </a></p><h3 id="Kubelet"><a href="#Kubelet" class="headerlink" title="Kubelet"></a>Kubelet</h3><p>æ¯ä¸ªNodeéƒ½ä¼šå¯åŠ¨ä¸€ä¸ªkubeletï¼Œä¸»è¦ä½œç”¨æœ‰ï¼š</p><ul><li><p>Nodeç®¡ç†</p><ul><li><p>æ³¨å†ŒèŠ‚ç‚¹ä¿¡æ¯ï¼›</p></li><li><p>é€šè¿‡ cAdvisor ç›‘æ§å®¹å™¨å’ŒèŠ‚ç‚¹çš„èµ„æºï¼›</p></li><li><p>å®šæœŸå‘ API server æ±‡æŠ¥æœ¬èŠ‚ç‚¹èµ„æºæ¶ˆè€—æƒ…å†µ</p></li></ul></li><li><p>Podç®¡ç†</p></li><li><p>æ‰€æœ‰éé€šè¿‡ API server æ–¹å¼åˆ›å»ºçš„ Pod å« Static Podï¼Œè¿™é‡Œæˆ‘ä»¬è®¨è®ºçš„éƒ½æ˜¯é€šè¿‡ API server åˆ›å»ºçš„æ™®é€šPodã€‚kubelet é€šè¿‡ API server ç›‘å¬ etcdï¼Œæ‰€æœ‰é’ˆå¯¹ Pod çš„æ“ä½œéƒ½ä¼šè¢«ç›‘å¬åˆ°ï¼Œå¦‚æœå…¶ä¸­æœ‰æ¶‰åŠåˆ°æœ¬èŠ‚ç‚¹çš„ Podï¼Œåˆ™æŒ‰ç…§è¦æ±‚è¿›è¡Œåˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ç­‰æ“ä½œã€‚</p></li><li><p>å®¹å™¨å¥åº·æ£€æŸ¥</p><p>kubeleté€šè¿‡ä¸¤ç±»æ¢é’ˆæ£€æŸ¥å®¹å™¨çš„çŠ¶æ€ï¼š</p><ul><li><p>LivenessProbeï¼šåˆ¤æ–­ä¸€ä¸ªå®¹å™¨æ˜¯å¦å¥åº·ï¼Œå¦‚æœä¸å¥åº·åˆ™ä¼šåˆ é™¤è¿™ä¸ªå®¹å™¨ï¼Œå¹¶æŒ‰ç…§ restartPolicy çœ‹æ˜¯å¦é‡å¯è¿™ä¸ªå®¹å™¨ã€‚å®ç°çš„æ–¹å¼æœ‰ ExecActionï¼ˆåœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼‰ã€TCPSocketActionï¼ˆå¦‚æœç«¯å£å¯ä»¥è¢«è®¿é—®ï¼Œåˆ™å¥åº·ï¼‰ã€HttpGetActionï¼ˆå¦‚æœè¿”å›200åˆ™å¥åº·ï¼‰ã€‚</p></li><li><p>ReadinessProbeï¼šç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å¯åŠ¨å®Œå…¨ã€‚å¦‚æœè¿”å›çš„æ˜¯å¤±è´¥ï¼Œåˆ™ Endpoint Controller ä¼šå°†è¿™ä¸ªPod çš„ Endpointä»Service çš„ Endpoint åˆ—è¡¨ä¸­åˆ é™¤ã€‚ä¹Ÿå°±æ˜¯ï¼Œä¸ä¼šæœ‰è¯·æ±‚è½¬å‘ç»™å®ƒã€‚</p></li></ul></li></ul><p>æ›´å¤š Kubeletä¿¡æ¯è¯·å‚è€ƒï¼š<a href="k8s6.md">æ·±å…¥ç†è§£ Kubernetes ä¹‹ Kubelet</a></p><h3 id="Kube-proxy"><a href="#Kube-proxy" class="headerlink" title="Kube proxy"></a>Kube proxy</h3><p>æ¯ä¸ª Node ä¸Šéƒ½è¿è¡Œç€ä¸€ä¸ª kube-proxy è¿›ç¨‹ï¼Œå®ƒåœ¨æœ¬åœ°å»ºç«‹ä¸€ä¸ª SocketServer æ¥æ”¶å’Œè½¬å‘è¯·æ±‚ï¼Œå¯ä»¥çœ‹ä½œæ˜¯Service çš„é€æ˜ä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨ï¼Œè´Ÿè½½å‡è¡¡ç­–ç•¥æ¨¡å¼æ˜¯ Round Robinã€‚ä¹Ÿå¯ä»¥è®¾ç½®ä¼šè¯ä¿æŒï¼Œç­–ç•¥ä½¿ç”¨çš„æ˜¯ ClientIPï¼Œå°†åŒä¸€ä¸ª ClientIP çš„è¯·æ±‚è½¬å‘åŒä¸€ä¸ª Endpoint ä¸Šã€‚</p><p>Service çš„ Cluster IP å’Œ NodePort ç­‰æ¦‚å¿µéƒ½æ˜¯ kube-proxy æœåŠ¡é€šè¿‡ iptables çš„ NAT è½¬æ¢å®ç°ï¼Œiptables æœºåˆ¶é’ˆå¯¹çš„æ˜¯ kube-proxy ç›‘å¬çš„ç«¯å£ï¼Œæ‰€ä»¥æ¯ä¸ª Node ä¸Šéƒ½è¦æœ‰ kube-proxyã€‚</p><p>æ›´å¤š Kube proxy ä¿¡æ¯è¯·å‚è€ƒï¼š<a href="k8s7.md">æ·±å…¥ç†è§£ Kubernetes ä¹‹ Kube proxy</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£ Libra</title>
      <link href="/2020/05/20/libra/"/>
      <url>/2020/05/20/libra/</url>
      
        <content type="html"><![CDATA[<h3 id="1-å…±è¯†"><a href="#1-å…±è¯†" class="headerlink" title="1. å…±è¯†"></a>1. å…±è¯†</h3><p>åŒºå—é“¾æŠ€æœ¯ä¸­ï¼Œå…±è¯†ç®—æ³•æ˜¯å…¶ä¸­æ ¸å¿ƒçš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ã€‚å®ƒåŒ…å«ä¸¤å±‚å«ä¹‰ï¼š</p><ol><li>å¤šä¸ªèŠ‚ç‚¹å¯¹æŸä¸ªæ•°æ®è¾¾æˆä¸€è‡´å…±è¯†ã€‚</li><li>å¤šä¸ªèŠ‚ç‚¹å¯¹å¤šä¸ªæ•°æ®çš„é¡ºåºè¾¾æˆä¸€è‡´å…±è¯†ã€‚</li></ol><p>å…±è¯†ç®—æ³•ä¸»è¦ç”¨åœ¨ä»¥ä¸‹ä¸‰ç§åœºæ™¯ï¼š</p><ul><li>ç§é“¾<ul><li>ç§é“¾çš„å…±è¯†ç®—æ³•å³ä¼ ç»Ÿåˆ†å¸ƒå¼ç³»ç»Ÿé‡Œçš„å…±è¯†ç®—æ³•ï¼Œæ¯”å¦‚ zookeeper çš„ zab åè®®ï¼Œå°±æ˜¯ç±» paxos ç®—æ³•çš„ä¸€ç§ã€‚ç§é“¾ä¸€èˆ¬ä¸è€ƒè™‘é›†ç¾¤ä¸­å­˜åœ¨ä½œæ¶èŠ‚ç‚¹ï¼Œåªè€ƒè™‘å› ä¸ºç³»ç»Ÿæˆ–è€…ç½‘ç»œåŸå› å¯¼è‡´çš„æ•…éšœèŠ‚ç‚¹ã€‚</li></ul></li><li>è”ç›Ÿé“¾<ul><li>è”ç›Ÿé“¾ä»£è¡¨é¡¹ç›®æ˜¯ Fabricï¼Œå®ƒä½¿ç”¨çš„å°±æ˜¯ PBFT(å®ç”¨æ‹œå åº­) ç®—æ³•ã€‚è”ç›Ÿé“¾é™¤äº†éœ€è¦è€ƒè™‘é›†ç¾¤ä¸­å­˜åœ¨æ•…éšœèŠ‚ç‚¹ï¼Œè¿˜éœ€è¦è€ƒè™‘é›†ç¾¤ä¸­å­˜åœ¨ä½œæ¶èŠ‚ç‚¹ã€‚å¯¹äºè”ç›Ÿé“¾ï¼Œæ¯ä¸ªæ–°åŠ å…¥çš„èŠ‚ç‚¹éƒ½æ˜¯éœ€è¦éªŒè¯å’Œå®¡æ ¸ã€‚</li></ul></li><li>å…¬é“¾<ul><li>å…¬é“¾ä¸ä»…éœ€è¦è€ƒè™‘ç½‘ç»œä¸­å­˜åœ¨æ•…éšœèŠ‚ç‚¹ï¼Œè¿˜éœ€è¦è€ƒè™‘ä½œæ¶èŠ‚ç‚¹ï¼Œè¿™ä¸€ç‚¹å’Œè”ç›Ÿé“¾æ˜¯ç±»ä¼¼çš„ã€‚å’Œè”ç›Ÿé“¾æœ€å¤§çš„åŒºåˆ«å°±æ˜¯ï¼Œå…¬é“¾ä¸­çš„èŠ‚ç‚¹å¯ä»¥å¾ˆè‡ªç”±çš„åŠ å…¥æˆ–è€…é€€å‡ºï¼Œä¸éœ€è¦ä¸¥æ ¼çš„éªŒè¯å’Œå®¡æ ¸ã€‚</li></ul></li></ul><h3 id="2-é€šè®¯æ¨¡å‹"><a href="#2-é€šè®¯æ¨¡å‹" class="headerlink" title="2. é€šè®¯æ¨¡å‹"></a>2. é€šè®¯æ¨¡å‹</h3><p>åˆ†å¸ƒå¼ç³»ç»Ÿé¦–å…ˆè¦æ˜ç¡®å…¶å‰ç½®çš„<code>é€šè®¯æ¨¡å‹</code>ï¼ˆä¹Ÿç§°ä¸º<code>æ—¶é—´æ¨¡å‹</code>ï¼‰çš„çº¦å®šã€‚æ¯”è¾ƒå¸¸è§çš„æœ‰<strong>åŒæ­¥ç½‘ç»œæ¨¡å‹</strong>ã€<strong>å¼‚æ­¥ç½‘ç»œæ¨¡å‹</strong>å’Œ<strong>éƒ¨åˆ†åŒæ­¥ç½‘ç»œæ¨¡å‹</strong>ã€‚</p><h4 id="2-1-åŒæ­¥ç½‘ç»œæ¨¡å‹"><a href="#2-1-åŒæ­¥ç½‘ç»œæ¨¡å‹" class="headerlink" title="2.1 åŒæ­¥ç½‘ç»œæ¨¡å‹"></a><strong>2.1 åŒæ­¥ç½‘ç»œæ¨¡å‹</strong></h4><p>èŠ‚ç‚¹æ‰€å‘å‡ºçš„æ¶ˆæ¯ï¼Œåœ¨ä¸€ä¸ªç¡®å®šçš„æ—¶é—´å†…ï¼Œè‚¯å®šä¼šåˆ°è¾¾ç›®æ ‡èŠ‚ç‚¹ã€‚</p><p>åœ¨åŒæ­¥ç½‘ç»œæ¨¡å‹ä¸­ï¼š</p><ol><li>è¿›ç¨‹é—´çš„æ¶ˆæ¯é€šè®¯ã€ä¼ è¾“å»¶æ—¶æœ‰ç•Œã€‚è®¤ä¸ºé€šè®¯è€—æ—¶æ˜¯æœ‰ç¡®å®šèŒƒå›´çš„ï¼›</li><li>æ¯ä¸ªè¿›ç¨‹çš„å¤„ç†é€Ÿåº¦æ˜¯ç¡®å®šçš„ã€‚æˆ‘ä»¬å¯ä»¥ç¡®åˆ‡çŸ¥é“è¿›ç¨‹ä¸­æ¯æ­¥ç®—æ³•çš„è€—æ—¶ã€‚</li></ol><p>æˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡ºï¼š</p><ul><li>æ¯ä¸ªè¿›ç¨‹é—´çš„æ—¶é’Ÿæ˜¯åŒæ­¥çš„ï¼Œå› ä¸ºå‰é¢çš„å®šä¹‰<strong>1</strong>ã€<strong>2</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€šè®¯æ¥åŒæ­¥å„ä¸ªæœºå™¨ä¸Šçš„æ—¶é’Ÿï¼Œä½¿å¾—å„ä¸ªæœºå™¨çš„æ—¶é’Ÿè¯¯å·®åœ¨ Î”T å†…ã€‚</li><li>å¦‚æœä¸€ä¸ªè¯·æ±‚çš„åº”ç­”è¶…è¿‡ RTT+ Î”T è¯·æ±‚å¤„ç†è€—æ—¶ï¼Œåˆ™å¯ä»¥åˆ¤å®šå¯¹ç«¯å¼‚å¸¸ã€‚</li></ul><p><code>åŒæ­¥ç½‘ç»œæ¨¡å‹</code>ä½¿ç”¨èµ·æ¥æœ€ç®€å•ï¼Œæ˜¯ç†æƒ³çš„ç½‘ç»œæ¨¡å‹ï¼Œåœ¨å®é™…ç¯å¢ƒä¸­å¹¶ä¸å­˜åœ¨ã€‚</p><h4 id="2-2-å¼‚æ­¥ç½‘ç»œæ¨¡å‹"><a href="#2-2-å¼‚æ­¥ç½‘ç»œæ¨¡å‹" class="headerlink" title="2.2 å¼‚æ­¥ç½‘ç»œæ¨¡å‹"></a><strong>2.2 å¼‚æ­¥ç½‘ç»œæ¨¡å‹</strong></h4><p>èŠ‚ç‚¹æ‰€å‘å‡ºçš„æ¶ˆæ¯ï¼Œä¸èƒ½ç¡®å®šä¸€å®šä¼šåˆ°è¾¾ç›®æ ‡èŠ‚ç‚¹ã€‚</p><p>åœ¨<code>å¼‚æ­¥ç½‘ç»œæ¨¡å‹</code>ä¸­ï¼Œæˆ‘ä»¬å¼•ç”¨ <strong>FLP ä¸å¯èƒ½æ€§</strong>[^6]ä¸­çš„å®šä¹‰ï¼š</p><ol><li>è¿›ç¨‹é—´çš„æ¶ˆæ¯é€šè®¯ã€ä¼ è¾“å»¶æ—¶æ²¡æœ‰ä¸Šç•Œï¼›</li><li>æ¯ä¸ªè¿›ç¨‹çš„å¤„ç†é€Ÿåº¦æ˜¯ä¸ç¡®å®šçš„ï¼›</li><li>æ¯ä¸ªæœºå™¨ä¸Šæ²¡æœ‰åŒæ­¥æ—¶é’Ÿï¼ˆå³ä¸å­˜åœ¨åŸå­é’Ÿè¿™ç§ä¸œè¥¿ï¼‰ï¼Œæ—¶é—´æµé€é€Ÿåº¦å¯èƒ½ä¹Ÿä¸åŒã€‚</li></ol><p>å› æ­¤æˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡ºï¼š</p><ul><li>å„ä¸ªæœºå™¨ä¸Šçš„æ—¶é’Ÿæ²¡æœ‰å¯å‚è€ƒæ€§ï¼Œå› ä¸ºæ ¹æ®ä¸Šé¢ 3 æ¯ä¸ªæœºå™¨ä¸èƒ½è‡ªå‘ä¿æŒæ—¶é—´çš„ä¸€è‡´æ€§ï¼Œå¹¶ä¸”å› ä¸º1ã€2ï¼Œæœºå™¨æ—¶é—´ä¹Ÿæ— æ³•åŒæ­¥æ—¶é’Ÿåœ¨ä¸€ä¸ªæœ‰ç•Œçš„è¯¯å·®ä¹‹å†…ã€‚æ‰€ä»¥ä¾èµ–è¶…æ—¶æœºåˆ¶çš„ç®—æ³•å¹¶ä¸å¯ç”¨ã€‚</li><li>å› ä¸º1ã€2ï¼Œå½“ä¸€ä¸ªè¯·æ±‚åœ¨æœ¬åœ°æ—¶é’Ÿä¸Šè¶…æ—¶åï¼Œæˆ‘ä»¬æ— æ³•åˆ¤æ–­è¿™ä¸ªè¯·æ±‚æ˜¯å¦æ˜¯å› ä¸ºå¯¹ç«¯å¼‚å¸¸é€ æˆçš„ã€‚è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„<strong>ä¸¤å†›é—®é¢˜</strong><a href="https://en.wikipedia.org/wiki/Two_Generals%27_Problem](https://en.wikipedia.org/wiki/Two_Generals' target=" _blank"="" rel="noopener" _problem"="">^1</a>åœºæ™¯ï¼Œæ•…ï¼Œæˆ‘ä»¬æ— æ³•å¯¹å…¶ä»–å®ä¾‹è¿›è¡Œæ•…éšœæ¢æµ‹ã€‚</li></ul><p>ä»å®šä¹‰ä¸­ 3ï¼Œæˆ‘ä»¬å¼•å‡ºä¸¤ä¸ªæ¦‚å¿µï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ¦‚å¿µåŸæœ¬æ˜¯é›†æˆç”µè·¯[^7][^8]ä¸­çš„æ¦‚å¿µï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é‡æ–°æ‰©å±•ä¸€ä¸‹ï¼š</p><ul><li><code>clock drift(æ—¶é’Ÿæ¼‚ç§»)</code>ï¼šç›¸å…³èŠ‚ç‚¹ä¸Šçš„æ—¶é’Ÿä»¥ä¸åŒçš„é€Ÿç‡è¿è¡Œã€‚åœ¨ P1 èŠ‚ç‚¹ä¸Šç»è¿‡ Î”T1 çš„åŒæ—¶ï¼ŒP2 èŠ‚ç‚¹ç»è¿‡äº†Î”T2ï¼Œä½†æ˜¯ Î”T1â‰ Î”T2ã€‚</li><li><code>clock skew(æ—¶é’Ÿåç§»)</code>ï¼šç›¸å…³èŠ‚ç‚¹éƒ½å¼•ç”¨äº†åŒä¸€ä¸ªæ—¶é—´æºï¼ˆæ¯”å¦‚é€šè¿‡ NTP æœåŠ¡ï¼‰ï¼Œä½†æ˜¯ç”±äºè¿™ä¸ªæ—¶é—´æºå°†æˆæ—¶ä¿¡å·åŒæ­¥ä¸åŒèŠ‚ç‚¹æ—¶çš„è€—æ—¶ä¸åŒï¼ˆæ¯”å¦‚ç½‘ç»œä¼ è¾“è€—æ—¶ï¼‰ï¼Œé€ æˆåŒä¸€æ—¶åˆ»ä¸åŒèŠ‚ç‚¹é—´äº§ç”Ÿäº†æ—¶é—´å·®ã€‚è¿™æ˜¯ä¸€ä¸ªæ¯”<code>clock drift(æ—¶é’Ÿæ¼‚ç§»)</code>æ›´åŠ ä¸¥æ ¼çš„è¦æ±‚ï¼Œå› ä¸ºå¦‚æœä¸€ä¸ªç³»ç»Ÿå†…éƒ¨çš„ TSkew å­˜åœ¨ä¸Šç•ŒTShewMax ï¼Œé‚£ä¸€å®šèƒ½é€šè¿‡ä¸æ–­çš„æ ¡æ—¶ã€ä¿æŒæ—¶é’ŸåŒæ­¥ï¼Œä½¿å¾— TDrift ä¿æŒåœ¨ TShewMax ä»¥å†…ã€‚</li></ul><p>å¼‚æ­¥ç½‘ç»œæ¨¡å‹æ˜¯ä¸€ä¸ªæœ€ç†æƒ³çš„<strong>æœ€å·®</strong>ç½‘ç»œæ¨¡å‹ï¼Œä½†æ˜¯å…¶å¤æ‚åº¦åˆè¿œè¶…æˆ‘ä»¬å®é™…æƒ…å½¢ã€‚</p><h4 id="2-3-éƒ¨åˆ†åŒæ­¥ç½‘ç»œæ¨¡å‹"><a href="#2-3-éƒ¨åˆ†åŒæ­¥ç½‘ç»œæ¨¡å‹" class="headerlink" title="2.3 éƒ¨åˆ†åŒæ­¥ç½‘ç»œæ¨¡å‹"></a><strong>2.3 éƒ¨åˆ†åŒæ­¥ç½‘ç»œæ¨¡å‹</strong></h4><p>èŠ‚ç‚¹å‘å‡ºçš„æ¶ˆæ¯ï¼Œè™½ç„¶ä¼šæœ‰å»¶è¿Ÿï¼Œä½†æ˜¯æœ€ç»ˆä¼šåˆ°è¾¾ç›®æ ‡èŠ‚ç‚¹ã€‚</p><p>æˆ‘ä»¬ç°å®ä¸­é‡è§çš„ç½‘ç»œæ¨¡å‹é€šå¸¸ä»‹äºåŒæ­¥ç½‘ç»œæ¨¡å‹å’Œå¼‚æ­¥ç½‘ç»œæ¨¡å‹ä¸¤è€…ä¹‹é—´ã€‚å› ä¸ºåœ¨æˆ‘ä»¬æ‰€çŸ¥çš„å¤§éƒ¨åˆ†ç³»ç»Ÿï¼Œåœ¨å¤§éƒ¨åˆ†æ—¶é—´å†…ï¼š</p><ul><li>è¿›ç¨‹é—´çš„æ¶ˆæ¯é€šè®¯ã€ä¼ è¾“å»¶æ—¶æ˜¯æœ‰ä¸Šç•Œçš„ï¼›åªæœ‰åœ¨ç½‘ç»œè¿‡è½½ã€ç½‘ç»œåˆ†åŒºæ•…éšœæ—¶ï¼Œæ‰æ²¡æœ‰ä¸Šç•Œï¼›</li><li>æ¯ä¸ªè¿›ç¨‹çš„å¤„ç†é€Ÿåº¦æ˜¯ç¡®å®šçš„ï¼›åªæœ‰åœ¨å‘ç”Ÿ GC ã€ç£ç›˜ IO é˜»å¡ç­‰å¼‚å¸¸æƒ…å†µæ—¶ï¼Œæ¯ä¸ªè¿›ç¨‹çš„å¤„ç†é€Ÿåº¦æ‰ä¸å¯ç¡®å®šã€‚</li><li>æ¯ä¸ªæœºå™¨ä¸Šçš„æ—¶é’Ÿæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ˜¯åŸºæœ¬åŒæ­¥çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ NTP[^9]æ¥åŒæ­¥æœºå™¨æ—¶é—´ï¼Œè€Œä¸”å¤šæ•°æœºå™¨ä¸Šæœ‰ç‹¬ç«‹çš„æ—¶é’ŸèŠ¯ç‰‡[^10]ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç²—ç•¥è®¤ä¸ºå„ä¸ªæœºå™¨ä¸Šæ—¶é—´æµé€çš„é€Ÿåº¦æ˜¯ç›¸åŒçš„ã€‚ä½†æ˜¯ä¸¥æ ¼è¦æ±‚æ—¶åºçš„ç³»ç»Ÿé™¤å¤–ã€‚</li></ul><h3 id="3-Raft-ç®—æ³•"><a href="#3-Raft-ç®—æ³•" class="headerlink" title="3. Raft ç®—æ³•"></a>3. Raft ç®—æ³•</h3><p>raft ä¸­èŠ‚ç‚¹æœ‰ä¸‰ç§çŠ¶æ€ï¼š</p><ul><li>Follower ï¼ˆè·Ÿéšè€…ï¼‰  è¢«åŠ¨çš„åªæ˜¯å“åº”æ¥è‡ªé¢†å¯¼è€…å’Œå€™é€‰äººçš„è¯·æ±‚ </li><li>Candidate ï¼ˆå€™é€‰äººï¼‰è¢«é€‰å‡ºä¸€ä¸ªæ–°çš„Leader </li><li>Leaderï¼ˆé¢†å¯¼è€…ï¼‰  å¤„ç†æ‰€æœ‰æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚</li></ul><p>é›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹åœ¨æŸä¸€æ—¶åˆ»åªèƒ½æ˜¯è¿™ä¸‰ç§çŠ¶æ€çš„å…¶ä¸­ä¸€ç§ï¼Œè¿™ä¸‰ç§çŠ¶æ€æ˜¯å¯ä»¥éšç€æ—¶é—´å’Œæ¡ä»¶çš„å˜åŒ–è€Œäº’ç›¸è½¬æ¢çš„ã€‚</p><p>raft ç®—æ³•ä¸»è¦æœ‰ä¸¤ä¸ªè¿‡ç¨‹ï¼š</p><ul><li>é¢†å¯¼è€…é€‰ä¸¾</li><li>æ—¥å¿—å¤åˆ¶<ul><li>è®°å½•æ—¥å¿—</li><li>æäº¤æ•°æ® </li></ul></li></ul><p>raft ç®—æ³•æ”¯æŒæœ€å¤§çš„å®¹é”™æ•…éšœèŠ‚ç‚¹ (n-1)/2ï¼Œå…¶ä¸­ n ä¸ºé›†ç¾¤ä¸­æ€»çš„èŠ‚ç‚¹æ•°é‡ã€‚</p><blockquote><p>raft ç®—æ³•åªæ”¯æŒå®¹é”™æ•…éšœèŠ‚ç‚¹ï¼Œå‡è®¾é›†ç¾¤æ€»èŠ‚ç‚¹æ•°ä¸º nï¼Œæ•…éšœèŠ‚ç‚¹ä¸º fï¼Œæ ¹æ®å°æ•°æœä»å¤šæ•°çš„åŸåˆ™ï¼Œé›†ç¾¤é‡Œæ­£å¸¸èŠ‚ç‚¹åªéœ€è¦æ¯” f ä¸ªèŠ‚ç‚¹å†å¤šä¸€ä¸ªèŠ‚ç‚¹ï¼Œå³ f+1ä¸ªèŠ‚ç‚¹ï¼Œæ­£ç¡®èŠ‚ç‚¹çš„æ•°é‡å°±ä¼šæ¯”æ•…éšœèŠ‚ç‚¹æ•°é‡å¤šï¼Œé‚£ä¹ˆé›†ç¾¤å°±èƒ½è¾¾æˆå…±è¯†ã€‚å› æ­¤ raft ç®—æ³•æ”¯æŒçš„æœ€å¤§å®¹é”™èŠ‚ç‚¹æ•°é‡æ˜¯ (n-1)/2ã€‚</p></blockquote><p>å¯å‚è€ƒ<a href="http://thesecretlivesofdata.com/raft/" target="_blank" rel="noopener">åŠ¨ç”»</a>ç†è§£</p><h4 id="3-1-ç®—æ³•å¤æ‚åº¦"><a href="#3-1-ç®—æ³•å¤æ‚åº¦" class="headerlink" title="3.1 ç®—æ³•å¤æ‚åº¦"></a>3.1 ç®—æ³•å¤æ‚åº¦</h4><p>Raft ç®—æ³•æ ¸å¿ƒæ˜¯æ—¥å¿—å¤åˆ¶è¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹åˆ†ä¸¤ä¸ªé˜¶æ®µï¼šä¸€ä¸ªæ˜¯æ—¥å¿—è®°å½•ï¼Œä¸€ä¸ªæ˜¯æäº¤æ•°æ®ã€‚ä¸¤ä¸ªè¿‡ç¨‹éƒ½åªéœ€è¦é¢†å¯¼è€…å‘é€æ¶ˆæ¯ç»™è·Ÿéšè€…èŠ‚ç‚¹ï¼Œè·Ÿéšè€…èŠ‚ç‚¹è¿”å›æ¶ˆæ¯ç»™é¢†å¯¼è€…èŠ‚ç‚¹å³å¯å®Œæˆï¼Œè·Ÿéšè€…èŠ‚ç‚¹ä¹‹é—´æ˜¯æ— éœ€æ²Ÿé€šçš„ã€‚æ‰€ä»¥å¦‚æœé›†ç¾¤æ€»èŠ‚ç‚¹æ•°ä¸º nï¼Œå¯¹äºæ—¥å¿—è®°å½•é˜¶æ®µï¼Œé€šä¿¡æ¬¡æ•°ä¸º n-1ï¼Œå¯¹äºæäº¤æ•°æ®é˜¶æ®µï¼Œé€šä¿¡æ¬¡æ•°ä¹Ÿä¸º n-1ï¼Œæ€»é€šä¿¡æ¬¡æ•°ä¸º 2n-2ï¼Œå› æ­¤ raft ç®—æ³•å¤æ‚åº¦ä¸ºO(n)ã€‚</p><h3 id="4-ä¸¤å†›é—®é¢˜"><a href="#4-ä¸¤å†›é—®é¢˜" class="headerlink" title="4. ä¸¤å†›é—®é¢˜"></a>4. ä¸¤å†›é—®é¢˜</h3><p>ä¸¤å†›é—®é¢˜<a href="https://en.wikipedia.org/wiki/Two_Generals%27_Problem](https://en.wikipedia.org/wiki/Two_Generals' target=" _blank"="" rel="noopener" _problem"="">^1</a>ï¼Œåˆç§°ä¸ºâ€œä¸¤å†›æ‚–è®ºâ€ï¼Œæ˜¯è®¡ç®—æœºé€šä¿¡é¢†åŸŸçš„ä¸€ä¸ªæ€æƒ³å®éªŒï¼Œä¸»è¦ç”¨æ¥æè¿°åœ¨ä¸€ä¸ªä¸å¯é çš„é€šä¿¡é“¾ä¸Šè¯•å›¾é€šè¿‡é€šä¿¡è¾¾æˆä¸€è‡´æ˜¯å­˜åœ¨ç¼ºé™·ä¸å›°éš¾çš„ï¼Œé€‚ç”¨äºä»»ä½•å¯èƒ½é€šä¿¡å¤±è´¥æƒ…å†µä¸‹çš„ä¸¤ç‚¹é€šä¿¡ï¼Œä¸¤å†›é—®é¢˜è¢«è¯æ˜æ— è§£ã€‚å¦‚æœé€šä¿¡ä¿¡é“æ˜¯å¯é çš„ï¼Œæˆ‘ä»¬åªéœ€ä¸‰æ¬¡æ¡æ‰‹å°±å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½ å°†æ¶ˆæ¯å‘ç»™æˆ˜å‹ï¼Œæˆ˜å‹ç¡®è®¤å›å¤ï¼Œä½ å†ç¡®è®¤æ”¶åˆ°å›å¤ï¼Œç»è¿‡è¿™ä¸‰æ¬¡æ¡æ‰‹ï¼ŒåŸºæœ¬å°±å¯ä»¥å‘èµ·è¿›æ”»ï¼Œä½†æ˜¯ä¸¤å†›é—®é¢˜é¢ä¸´çš„é€šä¿¡é€šé“æ˜¯ä¸å¯é çš„ï¼Œæ— è®ºå¤šå°‘æ¬¡æ¡æ‰‹ä¹Ÿæ— æ³•ä¿è¯æœ€åä¸€æ¬¡é€šä¿¡å‡†ç¡®é€è¾¾ï¼Œæœ€åä¸€æ¬¡é€šä¿¡çš„å‘é€æ–¹å°±ä¼šä¸€ç›´é¢ä¸´ç€å†’ç€å¤±è´¥é£é™©çš„è¡ŒåŠ¨ã€‚</p><h3 id="5-æ‹œå åº­å°†å†›é—®é¢˜"><a href="#5-æ‹œå åº­å°†å†›é—®é¢˜" class="headerlink" title="5. æ‹œå åº­å°†å†›é—®é¢˜"></a>5. æ‹œå åº­å°†å†›é—®é¢˜</h3><p>æ‹œå åº­å°†å†›é—®é¢˜æ˜¯ä¸€ä¸ªå…±è¯†é—®é¢˜: é¦–å…ˆç”± Leslie Lamport ä¸å¦å¤–ä¸¤äººåœ¨1982å¹´æå‡ºï¼Œè¢«ç§°ä¸º The Byzantine Generals Problem<a href="https://dl.acm.org/citation.cfm%3Fid%3D357176" target="_blank" rel="noopener">^2</a>æˆ–è€… Byzantine Failureã€‚æ ¸å¿ƒæè¿°æ˜¯å†›ä¸­å¯èƒ½æœ‰å›å¾’ï¼Œå´è¦ä¿è¯è¿›æ”»ä¸€è‡´ï¼Œç”±æ­¤å¼•ç”³åˆ°è®¡ç®—é¢†åŸŸï¼Œå‘å±•æˆäº†ä¸€ç§å®¹é”™ç†è®ºï¼Œå³æ‹œå åº­å®¹é”™ï¼ˆBFTï¼ŒByzantine Fault Toleranceï¼‰ã€‚ç®€å•æ¥è¯´ï¼Œæ‹œå åº­å®¹é”™ï¼ˆBFTï¼‰æ˜¯èƒ½å¤ŸæŠµæŠ—æ‹œå åº­å°†å†›é—®é¢˜å¯¼è‡´çš„ä¸€ç³»åˆ—å¤±è´¥çš„ç³»ç»Ÿå±æ€§ã€‚ è¿™æ„å‘³ç€å³ä½¿æŸäº›èŠ‚ç‚¹å‡ºç°æ•…éšœæˆ–æ¶æ„è¡Œä¸ºï¼Œæ‹œå åº­å®¹é”™ç³»ç»Ÿä¹Ÿèƒ½å¤Ÿç»§ç»­è¿è¡Œã€‚</p><p>æ‹œå åº­å°†å†›çš„é—®é¢˜æœ‰å¤šç§å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼Œå› æ­¤ï¼Œæœ‰å¤šç§æ–¹æ³•å¯ä»¥æ„å»ºæ‹œå åº­å®¹é”™ç³»ç»Ÿã€‚åŒæ ·åœ°ï¼ŒåŒºå—é“¾æœ‰å„ç§ä¸åŒçš„æ–¹æ³•æ¥å®ç°æ‹œå åº­å®¹é”™ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è¯´çš„å…±è¯†ç®—æ³•ã€‚</p><h4 id="5-1-é—®é¢˜æè¿°"><a href="#5-1-é—®é¢˜æè¿°" class="headerlink" title="5.1 é—®é¢˜æè¿°"></a>5.1 é—®é¢˜æè¿°</h4><p>æ‹œå åº­å¸å›½æƒ³è¦è¿›æ”»ä¸€ä¸ªå¼ºå¤§çš„æ•Œäººï¼Œä¸ºæ­¤æ´¾å‡ºäº†10æ”¯å†›é˜Ÿå»åŒ…å›´è¿™ä¸ªæ•Œäººã€‚è¿™ä¸ªæ•Œäººè™½ä¸æ¯”æ‹œå åº­å¸å›½ï¼Œä½†ä¹Ÿè¶³ä»¥æŠµå¾¡5æ”¯å¸¸è§„æ‹œå åº­å†›é˜Ÿçš„åŒæ—¶è¢­å‡»ã€‚åŸºäºä¸€äº›åŸå› ï¼Œè¿™10æ”¯å†›é˜Ÿä¸èƒ½é›†åˆåœ¨ä¸€èµ·å•ç‚¹çªç ´ï¼Œå¿…é¡»åœ¨åˆ†å¼€çš„åŒ…å›´çŠ¶æ€ä¸‹åŒæ—¶æ”»å‡»ã€‚ä»–ä»¬ä»»ä¸€æ”¯å†›é˜Ÿå•ç‹¬è¿›æ”»éƒ½æ¯«æ— èƒœç®—ï¼Œé™¤éæœ‰è‡³å°‘6æ”¯å†›é˜ŸåŒæ—¶è¢­å‡»æ‰èƒ½æ”»ä¸‹æ•Œå›½ã€‚ä»–ä»¬åˆ†æ•£åœ¨æ•Œå›½çš„å››å‘¨ï¼Œä¾é é€šä¿¡å…µç›¸äº’é€šä¿¡æ¥åå•†è¿›æ”»æ„å‘åŠè¿›æ”»æ—¶é—´ã€‚å›°æ‰°è¿™äº›å°†å†›çš„é—®é¢˜æ˜¯ï¼Œä»–ä»¬ä¸ç¡®å®šä»–ä»¬ä¸­æ˜¯å¦æœ‰å›å¾’ï¼Œå›å¾’å¯èƒ½æ“…è‡ªå˜æ›´è¿›æ”»æ„å‘æˆ–è€…è¿›æ”»æ—¶é—´ã€‚åœ¨è¿™ç§çŠ¶æ€ä¸‹ï¼Œæ‹œå åº­å°†å†›ä»¬èƒ½å¦æ‰¾åˆ°ä¸€ç§åˆ†å¸ƒå¼çš„åè®®æ¥è®©ä»–ä»¬èƒ½å¤Ÿè¿œç¨‹åå•†ï¼Œä»è€Œèµ¢å–æˆ˜æ–—ï¼Ÿè¿™å°±æ˜¯è‘—åçš„æ‹œå åº­å°†å†›é—®é¢˜ã€‚</p><p>éœ€è¦æ˜ç¡®ï¼Œæ‹œå åº­å°†å†›é—®é¢˜ä¸­å¹¶ä¸å»è€ƒè™‘é€šä¿¡å…µæ˜¯å¦ä¼šè¢«æˆªè·æˆ–æ— æ³•ä¼ è¾¾ä¿¡æ¯ç­‰é—®é¢˜ï¼Œå³æ¶ˆæ¯ä¼ é€’çš„ä¿¡é“ç»æ— é—®ã€‚</p><p>Lamportå·²ç»è¯æ˜äº†<strong>åœ¨æ¶ˆæ¯å¯èƒ½ä¸¢å¤±çš„ä¸å¯é ä¿¡é“ä¸Šè¯•å›¾é€šè¿‡æ¶ˆæ¯ä¼ é€’çš„æ–¹å¼è¾¾åˆ°ä¸€è‡´æ€§æ˜¯ä¸å¯èƒ½çš„</strong>ã€‚æ‰€ä»¥ï¼Œåœ¨ç ”ç©¶æ‹œå åº­å°†å†›é—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»å‡å®šäº†ä¿¡é“æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå¹¶åœ¨è¿™ä¸ªå‰æä¸‹ï¼Œå»åšä¸€è‡´æ€§å’Œå®¹é”™æ€§ç›¸å…³ç ”ç©¶ã€‚å¦‚æœéœ€è¦è€ƒè™‘ä¿¡é“æ˜¯æœ‰é—®é¢˜çš„ï¼Œè¿™æ¶‰åŠåˆ°äº†å¦ä¸€ä¸ªç›¸å…³é—®é¢˜ï¼š<strong>ä¸¤å†›é—®é¢˜</strong>ã€‚</p><p>æ‹œå åº­å¤±æ•ˆæŒ‡ä¸€æ–¹å‘å¦ä¸€æ–¹å‘é€æ¶ˆæ¯ï¼Œå¦ä¸€æ–¹æ²¡æœ‰æ”¶åˆ°ï¼Œæˆ–è€…æ”¶åˆ°äº†é”™è¯¯çš„ä¿¡æ¯çš„æƒ…å½¢ã€‚åœ¨å®¹é”™çš„åˆ†å¸ƒå¼è®¡ç®—ä¸­ï¼Œæ‹œå åº­å¤±æ•ˆå¯ä»¥æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç®—æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä»»æ„ä¸€ä¸ªé”™è¯¯ã€‚</p><p>Lamportæå‡ºå¹¶è®ºè¯äº†å£å¤´ç®—æ³•å’Œä¹¦é¢ç®—æ³•ä¸¤ç§è§£å†³æ–¹æ³•ã€‚</p><h4 id="5-2-å£å¤´åè®®"><a href="#5-2-å£å¤´åè®®" class="headerlink" title="5.2 å£å¤´åè®®"></a>5.2 å£å¤´åè®®</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ˜ç¡®ä»€ä¹ˆæ˜¯å£å¤´åè®®ã€‚æˆ‘ä»¬å°†æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶çš„æ–¹å¼ç§°ä¸ºå£å¤´åè®®ï¼š</p><pre><code> (1) æ¯ä¸ªè¢«å‘é€çš„æ¶ˆæ¯éƒ½èƒ½å¤Ÿè¢«æ­£ç¡®çš„æŠ•é€’ (2) ä¿¡æ¯æ¥æ”¶è€…çŸ¥é“æ˜¯è°å‘é€çš„æ¶ˆæ¯ (3) èƒ½å¤ŸçŸ¥é“ç¼ºå°‘çš„æ¶ˆæ¯</code></pre><p>ç®€è€Œè¨€ä¹‹ï¼Œä¿¡é“ç»å¯¹å¯ä¿¡ï¼Œä¸”æ¶ˆæ¯æ¥æºå¯çŸ¥ã€‚ä½†è¦æ³¨æ„çš„æ˜¯ï¼Œå£å¤´åè®®å¹¶ä¸ä¼šå‘ŠçŸ¥æ¶ˆæ¯çš„ä¸Šä¸€ä¸ªæ¥æºæ˜¯è°ã€‚</p><p>Lamport è®ºè¯å¾—å‡ºç»“è®ºï¼šé‡‡ç”¨å£å¤´åè®®ï¼Œè‹¥å›å¾’æ•°å°‘äº 1/3ï¼Œåˆ™æ‹œå åº­å°†å†›é—®é¢˜å¯è§£ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè‹¥å›å¾’æ•°ä¸ºmï¼Œå½“å°†å†›æ€»æ•°nè‡³å°‘ä¸º 3m+1 æ—¶ï¼Œé—®é¢˜å¯è§£ã€‚</p><h4 id="5-3-ä¹¦é¢åè®®"><a href="#5-3-ä¹¦é¢åè®®" class="headerlink" title="5.3 ä¹¦é¢åè®®"></a>5.3 ä¹¦é¢åè®®</h4><p>æ­ç¤ºäº†å£å¤´åè®®çš„ç¼ºç‚¹æ˜¯æ¶ˆæ¯ä¸èƒ½è¿½æœ¬æº¯æºï¼Œè¿™ä½¿å¾—å£å¤´åè®®å¿…é¡»åœ¨å››æ¨¡å†—ä½™çš„æƒ…å†µä¸‹æ‰èƒ½ä¿è¯æ­£ç¡®ã€‚ç”±æ­¤å¼•å…¥äº†ä¹¦é¢åè®®ã€‚</p><p>åœ¨å£å¤´åè®®çš„ä¸‰ä¸ªæ¡ä»¶ä¹‹ä¸Šï¼Œå†æ·»åŠ ä¸€ä¸ªæ¡ä»¶ï¼Œä½¿ä¹‹æˆä¸ºä¹¦é¢åè®®ã€‚</p><pre><code> ï¼ˆaï¼‰ç­¾åä¸å¯ä¼ªé€ ï¼Œä¸€æ—¦è¢«ç¯¡æ”¹å³å¯å‘ç°ï¼Œè€Œå›å¾’çš„ç­¾åå¯è¢«å…¶ä»–å›å¾’ä¼ªé€ ï¼› ï¼ˆbï¼‰ä»»ä½•äººéƒ½å¯ä»¥éªŒè¯ç­¾åçš„å¯é æ€§ã€‚  </code></pre><p>å¯ä»¥è®ºè¯ï¼šå¯¹äºä»»æ„mï¼Œæœ€å¤šåªæœ‰mä¸ªèƒŒå›è€…æƒ…å†µä¸‹ï¼Œç®—æ³•SM(m)èƒ½è§£å†³æ‹œå åº­å°†å†›é—®é¢˜ã€‚</p><p>ä¹¦é¢åè®®çš„æœ¬è´¨å°±æ˜¯å¼•å…¥äº†ç­¾åç³»ç»Ÿï¼Œè¿™ä½¿å¾—æ‰€æœ‰æ¶ˆæ¯éƒ½å¯è¿½æœ¬æº¯æºã€‚è¿™ä¸€ä¼˜åŠ¿ï¼Œå¤§å¤§èŠ‚çœäº†æˆæœ¬ï¼Œä»–åŒ–è§£äº†å£å¤´åè®®ä¸­1/3è¦æ±‚ï¼Œåªè¦é‡‡ç”¨äº†ä¹¦é¢åè®®ï¼Œå¿ è¯šçš„å°†å†›å°±å¯ä»¥è¾¾åˆ°ä¸€è‡´ã€‚</p><h3 id="6-å®ç”¨æ‹œå åº­å®¹é”™ï¼ˆPBFTï¼‰"><a href="#6-å®ç”¨æ‹œå åº­å®¹é”™ï¼ˆPBFTï¼‰" class="headerlink" title="6. å®ç”¨æ‹œå åº­å®¹é”™ï¼ˆPBFTï¼‰"></a>6. å®ç”¨æ‹œå åº­å®¹é”™ï¼ˆPBFTï¼‰</h3><p>å®ç”¨æ‹œå åº­å®¹é”™åè®®<a href="http://pmg.csail.mit.edu/papers/osdi99.pdf" target="_blank" rel="noopener">^3</a>ï¼ˆPBFTï¼ŒPractical Byzantine Fault Toleranceï¼‰æ˜¯Miguel Castro (å¡æ–¯ç‰¹ç½—)å’ŒBarbara Liskovï¼ˆåˆ©æ–¯ç§‘å¤«ï¼‰åœ¨1999å¹´æå‡ºæ¥çš„ï¼Œè§£å†³äº†åŸå§‹æ‹œå åº­å®¹é”™ç®—æ³•æ•ˆç‡ä¸é«˜çš„é—®é¢˜ï¼Œå°†ç®—æ³•å¤æ‚åº¦ç”±æŒ‡æ•°çº§é™ä½åˆ°å¤šé¡¹å¼çº§ï¼Œä½¿å¾—æ‹œå åº­å®¹é”™ç®—æ³•åœ¨å®é™…ç³»ç»Ÿåº”ç”¨ä¸­å˜å¾—å¯è¡Œã€‚</p><p>PBFT æ˜¯ä¸€ä¸ªå…·æœ‰äºŒè½®æŠ•ç¥¨çš„ä¸‰é˜¶æ®µåè®®ï¼Œæ¯ä¸ªè§†å›¾(View)éƒ½ä¼šæœ‰ä¸€ä¸ªç‰¹å®šçš„èŠ‚ç‚¹ä½œä¸ºé¢†å¯¼èŠ‚ç‚¹(Primary/Leader)ï¼Œè´Ÿè´£é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹è¿›å…¥æŠ•ç¥¨æµç¨‹ã€‚å„èŠ‚ç‚¹åˆ™ä¼šç»å† Pre-prepare/Prepare/Commit è¿™ä¸‰ä¸ªé˜¶æ®µï¼Œå¹¶ä¾æ®æ¥æ”¶çš„è®¯æ¯å†³å®šæ˜¯å¦æŠ•ç¥¨/è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼Œæ¯ä¸ªèŠ‚ç‚¹æŠ•å®Œç¥¨åå°†è®¯æ¯å‘ç»™æ‰€æœ‰å…¶ä»–çš„èŠ‚ç‚¹ã€‚</p><p>è‹¥ä¸ªèŠ‚ç‚¹åœ¨ä¸¤é˜¶æ®µæŠ•ç¥¨ä¹‹åå–å¾—å¤šæ•°å…±è¯†ï¼Œåˆ™å„èŠ‚ç‚¹å¯ä»¥æ›´æ–°æœ¬æœºçš„çŠ¶æ€ï¼Œç»“æŸè¿™ä¸€å›åˆã€‚è§†å›¾å˜æ¢(view change)ä»…å½“å¤šæ•°èŠ‚ç‚¹å‘èµ·æ—¶æ‰§è¡Œï¼Œå½“ç›®å‰çš„é¢†å¯¼èŠ‚ç‚¹å¹¶æœªæ­£å¸¸æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œè¿™å¯ä»¥æ›¿æ¢å½“å‰çš„é¢†å¯¼èŠ‚ç‚¹ï¼Œä¿è¯åè®®æ­£å¸¸è¿ä½œã€‚</p><p>PBFT æ˜¯ä¸€ç§çŠ¶æ€æœºå‰¯æœ¬å¤åˆ¶ç®—æ³•ï¼Œå³æœåŠ¡ä½œä¸ºçŠ¶æ€æœºè¿›è¡Œå»ºæ¨¡ï¼ŒçŠ¶æ€æœºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸åŒèŠ‚ç‚¹è¿›è¡Œå‰¯æœ¬å¤åˆ¶ã€‚æ¯ä¸ªçŠ¶æ€æœºçš„å‰¯æœ¬éƒ½ä¿å­˜äº†æœåŠ¡çš„çŠ¶æ€ï¼ŒåŒæ—¶ä¹Ÿå®ç°äº†æœåŠ¡çš„æ“ä½œã€‚å°†æ‰€æœ‰çš„å‰¯æœ¬ç»„æˆçš„é›†åˆä½¿ç”¨å¤§å†™å­—æ¯ R è¡¨ç¤ºï¼Œä½¿ç”¨ 0 åˆ° R å‡1çš„æ•´æ•°è¡¨ç¤ºæ¯ä¸€ä¸ªå‰¯æœ¬ã€‚ä¸ºäº†æè¿°æ–¹ä¾¿ï¼Œå‡è®¾ R=3f+1ï¼Œè¿™é‡Œ f æ˜¯æœ‰å¯èƒ½å¤±æ•ˆçš„å‰¯æœ¬çš„æœ€å¤§ä¸ªæ•°ã€‚å°½ç®¡å¯ä»¥å­˜åœ¨å¤šäº 3f+1 ä¸ªå‰¯æœ¬ï¼Œä½†æ˜¯é¢å¤–çš„å‰¯æœ¬é™¤äº†é™ä½æ€§èƒ½ä¹‹å¤–ä¸èƒ½æé«˜å¯é æ€§ã€‚</p><p>ä¸»èŠ‚ç‚¹ç”±å…¬å¼<code>p = v mod R</code>è®¡ç®—å¾—åˆ°ï¼Œè¿™é‡Œ v æ˜¯è§†å›¾ç¼–å·ï¼Œp æ˜¯å‰¯æœ¬ç¼–å·ï¼ŒR æ˜¯å‰¯æœ¬é›†åˆçš„ä¸ªæ•°ã€‚å½“ä¸»èŠ‚ç‚¹å¤±æ•ˆçš„æ—¶å€™å°±éœ€è¦å¯åŠ¨è§†å›¾æ›´æ¢ï¼ˆview changeï¼‰è¿‡ç¨‹ã€‚Viewstamped Replication ç®—æ³•å’Œ Paxos ç®—æ³•å°±æ˜¯ä½¿ç”¨ç±»ä¼¼æ–¹æ³•è§£å†³è‰¯æ€§å®¹é”™çš„ã€‚</p><p>æ¯ä¸ªå‰¯æœ¬èŠ‚ç‚¹çš„çŠ¶æ€éƒ½åŒ…å«äº†æœåŠ¡çš„æ•´ä½“çŠ¶æ€ï¼Œå‰¯æœ¬èŠ‚ç‚¹ä¸Šçš„<strong>æ¶ˆæ¯æ—¥å¿—(message log)</strong>åŒ…å«äº†è¯¥å‰¯æœ¬èŠ‚ç‚¹<strong>æ¥å—(accepted)</strong>çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”ä½¿ç”¨ä¸€ä¸ªæ•´æ•°è¡¨ç¤ºå‰¯æœ¬èŠ‚ç‚¹çš„å½“å‰è§†å›¾ç¼–å·ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆèŠ‚ç‚¹æ•°éœ€è¦å¤§äº 3f+1 </p><p>å› ä¸ºæœ€åçš„æƒ…å†µæ˜¯ï¼šf ä¸ªèŠ‚ç‚¹æ˜¯æœ‰é—®é¢˜çš„ï¼Œç”±äºåˆ°è¾¾é¡ºåºçš„é—®é¢˜ï¼Œæœ‰å¯èƒ½ f ä¸ªæœ‰é—®é¢˜çš„èŠ‚ç‚¹æ¯”æ­£å¸¸çš„ f ä¸ªèŠ‚ç‚¹å…ˆè¿”å›æ¶ˆæ¯ï¼Œåˆè¦ä¿è¯æ”¶åˆ°çš„æ­£å¸¸çš„èŠ‚ç‚¹æ¯”æœ‰é—®é¢˜çš„èŠ‚ç‚¹å¤šï¼Œæ‰€ä»¥éœ€è¦æ»¡è¶³n-f-f&gt;f =&gt; n&gt;3fï¼Œæ‰€ä»¥è‡³å°‘3f+1ä¸ªèŠ‚ç‚¹ã€‚</p><img src="/images/2019/pbft_1.png"></blockquote><h4 id="6-1-ç³»ç»Ÿæ¨¡å‹"><a href="#6-1-ç³»ç»Ÿæ¨¡å‹" class="headerlink" title="6.1 ç³»ç»Ÿæ¨¡å‹"></a>6.1 ç³»ç»Ÿæ¨¡å‹</h4><p>ä¸€ç»„èŠ‚ç‚¹æ„æˆçŠ¶æ€æœºå¤åˆ¶ç³»ç»Ÿï¼Œä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºä¸»èŠ‚ç‚¹ï¼ˆprivaryï¼‰ï¼Œå…¶ä»–èŠ‚ç‚¹ä½œä¸ºå¤‡ä»½èŠ‚ç‚¹(back-ups)ã€‚æŸä¸ªèŠ‚ç‚¹ä½œä¸ºä¸»èŠ‚ç‚¹æ—¶ï¼Œè¿™ç§°ä¸ºç³»ç»Ÿçš„ä¸€ä¸ª viewã€‚å½“èŠ‚ç‚¹å‡ºäº†é—®é¢˜ï¼Œå°±è¿›è¡Œ view æ›´æ–°ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ‹…ä»»ä¸»èŠ‚ç‚¹ã€‚ä¸»èŠ‚ç‚¹æ›´æ›¿ä¸éœ€è¦é€‰ä¸¾è¿‡ç¨‹ï¼Œè€Œæ˜¯é‡‡ç”¨ round-robin æ–¹å¼ã€‚</p><p>åœ¨ç³»ç»Ÿçš„ä¸»èŠ‚ç‚¹æ¥æ”¶ client å‘æ¥çš„è¯·æ±‚ï¼Œå¹¶äº§ç”Ÿ pre-prepare æ¶ˆæ¯ï¼Œè¿›å…¥å…±è¯†æµç¨‹ã€‚</p><p>æˆ‘ä»¬éœ€è¦ç³»ç»Ÿæ»¡è¶³å¦‚ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li>åœ¨ä¸€ä¸ªç»™å®šçŠ¶æ€ä¸Šçš„æ“ä½œï¼Œ äº§ç”Ÿä¸€æ ·çš„æ‰§è¡Œç»“æœ</li><li>æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€æ ·çš„èµ·å§‹çŠ¶æ€</li></ul><p>è¦ä¿è¯ non-fault èŠ‚ç‚¹å¯¹äºæ‰§è¡Œè¯·æ±‚çš„<strong>å…¨å±€é¡ºåº</strong>è¾¾æˆä¸€è‡´ã€‚</p><h4 id="6-2-å®‰å…¨æ€§-safety-æ´»æ€§-liveness"><a href="#6-2-å®‰å…¨æ€§-safety-æ´»æ€§-liveness" class="headerlink" title="6.2 å®‰å…¨æ€§(safety) / æ´»æ€§(liveness)"></a>6.2 å®‰å…¨æ€§(safety) / æ´»æ€§(liveness)</h4><ul><li><strong>safety</strong>: åçš„äº‹æƒ…ä¸ä¼šå‘ç”Ÿï¼Œå³å…±è¯†ç³»ç»Ÿä¸èƒ½äº§ç”Ÿé”™è¯¯çš„ç»“æœï¼Œæ¯”å¦‚ä¸€éƒ¨åˆ†èŠ‚ç‚¹è¯´yesï¼Œå¦ä¸€éƒ¨åˆ†è¯´noã€‚åœ¨åŒºå—é“¾çš„è¯­ä¹‰ä¸‹ï¼ŒæŒ‡çš„æ˜¯ä¸ä¼šåˆ†å‰ã€‚</li><li><strong>liveness</strong>: å¥½çš„äº‹æƒ…ä¸€å®šä¼šå‘ç”Ÿï¼Œå³ç³»ç»Ÿä¸€ç›´æœ‰å›åº”ï¼Œåœ¨åŒºå—é“¾çš„è¯­ä¹‰ä¸‹ï¼ŒæŒ‡çš„æ˜¯å…±è¯†ä¼šæŒç»­è¿›è¡Œï¼Œä¸ä¼šå¡ä½ã€‚å‡å¦‚ä¸€ä¸ªåŒºå—é“¾ç³»ç»Ÿçš„å…±è¯†å¡åœ¨äº†æŸä¸ªé«˜åº¦ï¼Œé‚£ä¹ˆæ–°çš„äº¤æ˜“æ˜¯æ²¡æœ‰å›åº”çš„ï¼Œä¹Ÿå°±æ˜¯ä¸æ»¡ livenessã€‚</li></ul><h4 id="6-3-PBFTç®—æ³•çš„æ­¥éª¤"><a href="#6-3-PBFTç®—æ³•çš„æ­¥éª¤" class="headerlink" title="6.3 PBFTç®—æ³•çš„æ­¥éª¤"></a>6.3 PBFTç®—æ³•çš„æ­¥éª¤</h4><ol><li>å–ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œå…¶ä»–çš„èŠ‚ç‚¹ä½œä¸ºå¤‡ä»½ï¼›</li><li>å®¢æˆ·ç«¯å‘ä¸»èŠ‚ç‚¹å‘é€ä½¿ç”¨æœåŠ¡æ“ä½œçš„è¯·æ±‚ï¼›</li><li>ä¸»èŠ‚ç‚¹é€šè¿‡å¹¿æ’­å°†è¯·æ±‚å‘é€ç»™å…¶ä»–èŠ‚ç‚¹ï¼›</li><li>æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œè¯·æ±‚å¹¶å°†ç»“æœå‘å›å®¢æˆ·ç«¯ï¼›</li><li>å®¢æˆ·ç«¯éœ€è¦ç­‰å¾… f+1 ä¸ªä¸åŒèŠ‚ç‚¹å‘å›ç›¸åŒçš„ç»“æœï¼Œä½œä¸ºæ•´ä¸ªæ“ä½œçš„æœ€ç»ˆç»“æœã€‚</li></ol><p>åŒæ‰€æœ‰çš„çŠ¶æ€æœºå‰¯æœ¬å¤åˆ¶æŠ€æœ¯ä¸€æ ·ï¼ŒPBFT å¯¹æ¯ä¸ªèŠ‚ç‚¹æå‡ºäº†ä¸¤ä¸ªé™å®šæ¡ä»¶ï¼š</p><ol><li>æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»æ˜¯ç¡®å®šæ€§çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç»™å®šçŠ¶æ€å’Œå‚æ•°ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œæ“ä½œæ‰§è¡Œçš„ç»“æœå¿…é¡»ç›¸åŒï¼›</li><li>æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»ä»ç›¸åŒçš„çŠ¶æ€å¼€å§‹æ‰§è¡Œã€‚</li></ol><p>è¿™ä¸¤ä¸ªé™å®šæ¡ä»¶ä¸‹ï¼Œå³ä½¿å¤±æ•ˆçš„èŠ‚ç‚¹å­˜åœ¨ï¼ŒPBFT ç®—æ³•å¯¹æ‰€æœ‰éå¤±æ•ˆèŠ‚ç‚¹çš„è¯·æ±‚æ‰§è¡Œæ€»é¡ºåºè¾¾æˆä¸€è‡´ï¼Œä»è€Œä¿è¯å®‰å…¨æ€§ã€‚</p><pre class=" language-å‡è®¾èŠ‚ç‚¹æ€»æ•°ä¸º3f+1ï¼Œfä¸ºæ‹œèµåº­é”™è¯¯èŠ‚ç‚¹ï¼š"><code class="language-å‡è®¾èŠ‚ç‚¹æ€»æ•°ä¸º3f+1ï¼Œfä¸ºæ‹œèµåº­é”™è¯¯èŠ‚ç‚¹ï¼š">1. å½“èŠ‚ç‚¹å‘ç° leader ä½œæ¶æ—¶ï¼Œé€šè¿‡ç®—æ³•é€‰ä¸¾å…¶ä»–çš„ replica ä¸º leaderã€‚2. leader é€šè¿‡ pre-prepare æ¶ˆæ¯æŠŠå®ƒé€‰æ‹©çš„ value å¹¿æ’­ç»™å…¶ä»– replica èŠ‚ç‚¹ï¼Œå…¶ä»–çš„ replica èŠ‚ç‚¹å¦‚æœæ¥å—åˆ™å‘é€ prepareï¼Œå¦‚æœå¤±è´¥åˆ™ä¸å‘é€ã€‚3. ä¸€æ—¦2fä¸ªèŠ‚ç‚¹æ¥å— prepare æ¶ˆæ¯ï¼Œåˆ™èŠ‚ç‚¹å‘é€ commit æ¶ˆæ¯ã€‚4. å½“2f+1ä¸ªèŠ‚ç‚¹æ¥å— commit æ¶ˆæ¯åï¼Œä»£è¡¨è¯¥ value å€¼è¢«ç¡®å®šã€‚</code></pre><p>å¦‚ä¸‹å›¾è¡¨ç¤ºäº†4ä¸ªèŠ‚ç‚¹ï¼Œ0ä¸ºleaderï¼ŒåŒæ—¶èŠ‚ç‚¹3ä¸ºfaultèŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹ä¸å“åº”å’Œå‘å‡ºä»»ä½•æ¶ˆæ¯ï¼ŒCä¸ºå®¢æˆ·ç«¯ã€‚æœ€ç»ˆèŠ‚ç‚¹çŠ¶æ€è¾¾åˆ°commitedæ—¶ï¼Œè¡¨ç¤ºè¯¥è½®å…±è¯†æˆåŠŸè¾¾æˆã€‚</p><img src="/images/2019/pbft.png"><h4 id="6-4-å®¢æˆ·ç«¯C"><a href="#6-4-å®¢æˆ·ç«¯C" class="headerlink" title="6.4 å®¢æˆ·ç«¯C"></a>6.4 å®¢æˆ·ç«¯C</h4><p>å®¢æˆ·ç«¯cå‘ä¸»èŠ‚ç‚¹å‘é€<code>&lt;REQUEST,o,t,c&gt;</code>è¯·æ±‚æ‰§è¡ŒçŠ¶æ€æœºæ“ä½œoï¼Œè¿™é‡Œæ—¶é—´æˆ³tç”¨æ¥ä¿è¯å®¢æˆ·ç«¯è¯·æ±‚åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚å®¢æˆ·ç«¯cå‘å‡ºè¯·æ±‚çš„æ—¶é—´æˆ³æ˜¯å…¨åºæ’åˆ—çš„ï¼Œåç»­å‘å‡ºçš„è¯·æ±‚æ¯”æ—©å…ˆå‘å‡ºçš„è¯·æ±‚æ‹¥æœ‰æ›´é«˜çš„æ—¶é—´æˆ³ã€‚ä¾‹å¦‚ï¼Œè¯·æ±‚å‘èµ·æ—¶çš„æœ¬åœ°æ—¶é’Ÿå€¼å¯ä»¥ä½œä¸ºæ—¶é—´æˆ³ã€‚</p><p>æ¯ä¸ªç”±å‰¯æœ¬èŠ‚ç‚¹å‘ç»™å®¢æˆ·ç«¯çš„æ¶ˆæ¯éƒ½åŒ…å«äº†å½“å‰çš„è§†å›¾ç¼–å·ï¼Œä½¿å¾—å®¢æˆ·ç«¯èƒ½å¤Ÿè·Ÿè¸ªè§†å›¾ç¼–å·ï¼Œä»è€Œè¿›ä¸€æ­¥æ¨ç®—å‡ºå½“å‰ä¸»èŠ‚ç‚¹çš„ç¼–å·ã€‚å®¢æˆ·ç«¯é€šè¿‡ç‚¹å¯¹ç‚¹æ¶ˆæ¯å‘å®ƒè‡ªå·±è®¤ä¸ºçš„ä¸»èŠ‚ç‚¹å‘é€è¯·æ±‚ï¼Œç„¶åä¸»èŠ‚ç‚¹è‡ªåŠ¨å°†è¯¥è¯·æ±‚å‘æ‰€æœ‰å¤‡ä»½èŠ‚ç‚¹è¿›è¡Œå¹¿æ’­ã€‚</p><p>å‰¯æœ¬å‘ç»™å®¢æˆ·ç«¯çš„å“åº”ä¸º<code>&lt;REPLY,v,t,c,i,r&gt;</code>ï¼Œvæ˜¯è§†å›¾ç¼–å·ï¼Œtæ˜¯æ—¶é—´æˆ³ï¼Œiæ˜¯å‰¯æœ¬çš„ç¼–å·ï¼Œræ˜¯è¯·æ±‚æ‰§è¡Œçš„ç»“æœã€‚</p><p>å®¢æˆ·ç«¯ç­‰å¾…f+1ä¸ªä»ä¸åŒå‰¯æœ¬å¾—åˆ°çš„åŒæ ·å“åº”ï¼ŒåŒæ ·å“åº”éœ€è¦ä¿è¯ç­¾åæ­£ç¡®ï¼Œå¹¶ä¸”å…·æœ‰åŒæ ·çš„æ—¶é—´æˆ³tå’Œæ‰§è¡Œç»“æœrã€‚è¿™æ ·å®¢æˆ·ç«¯æ‰èƒ½æŠŠrä½œä¸ºæ­£ç¡®çš„æ‰§è¡Œç»“æœï¼Œå› ä¸ºå¤±æ•ˆçš„å‰¯æœ¬èŠ‚ç‚¹ä¸è¶…è¿‡fä¸ªï¼Œæ‰€ä»¥f+1ä¸ªå‰¯æœ¬çš„ä¸€è‡´å“åº”å¿…å®šèƒ½å¤Ÿä¿è¯ç»“æœæ˜¯æ­£ç¡®æœ‰æ•ˆçš„ã€‚</p><p>å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰åœ¨æœ‰é™æ—¶é—´å†…æ”¶åˆ°å›å¤ï¼Œè¯·æ±‚å°†å‘æ‰€æœ‰å‰¯æœ¬èŠ‚ç‚¹è¿›è¡Œå¹¿æ’­ã€‚å¦‚æœè¯·æ±‚å·²ç»åœ¨å‰¯æœ¬èŠ‚ç‚¹å¤„ç†è¿‡äº†ï¼Œå‰¯æœ¬å°±å‘å®¢æˆ·ç«¯é‡å‘ä¸€éæ‰§è¡Œç»“æœã€‚å¦‚æœè¯·æ±‚æ²¡æœ‰åœ¨å‰¯æœ¬èŠ‚ç‚¹å¤„ç†è¿‡ï¼Œè¯¥å‰¯æœ¬èŠ‚ç‚¹å°†æŠŠè¯·æ±‚è½¬å‘ç»™ä¸»èŠ‚ç‚¹ã€‚å¦‚æœä¸»èŠ‚ç‚¹æ²¡æœ‰å°†è¯¥è¯·æ±‚è¿›è¡Œå¹¿æ’­ï¼Œé‚£ä¹ˆå°±æœ‰è®¤ä¸ºä¸»èŠ‚ç‚¹å¤±æ•ˆï¼Œå¦‚æœæœ‰è¶³å¤Ÿå¤šçš„å‰¯æœ¬èŠ‚ç‚¹è®¤ä¸ºä¸»èŠ‚ç‚¹å¤±æ•ˆï¼Œåˆ™ä¼šè§¦å‘ä¸€æ¬¡è§†å›¾å˜æ›´ã€‚</p><p>æœ¬æ–‡å‡è®¾å®¢æˆ·ç«¯ä¼šç­‰å¾…ä¸Šä¸€ä¸ªè¯·æ±‚å®Œæˆæ‰ä¼šå‘èµ·ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯åªè¦èƒ½å¤Ÿä¿è¯è¯·æ±‚é¡ºåºï¼Œå¯ä»¥å…è®¸è¯·æ±‚æ˜¯å¼‚æ­¥çš„ã€‚</p><h4 id="6-5-é¢„å‡†å¤‡-pre-prepare"><a href="#6-5-é¢„å‡†å¤‡-pre-prepare" class="headerlink" title="6.5 é¢„å‡†å¤‡(pre-prepare)"></a>6.5 é¢„å‡†å¤‡(pre-prepare)</h4><p>åœ¨é¢„å‡†å¤‡é˜¶æ®µï¼Œä¸»èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªåºåˆ—å· n ç»™æ”¶åˆ°çš„è¯·æ±‚ï¼Œç„¶åå‘æ‰€æœ‰èŠ‚ç‚¹ç¾¤å‘é¢„å‡†å¤‡æ¶ˆæ¯ï¼Œé¢„å‡†å¤‡æ¶ˆæ¯çš„æ ¼å¼ä¸º<code>&lt;&lt;PRE-PREPARE,v,n,d&gt;,m&gt;</code>ï¼Œè¿™é‡Œ v æ˜¯è§†å›¾ç¼–å·ï¼Œm æ˜¯å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚æ¶ˆæ¯ï¼Œd æ˜¯è¯·æ±‚æ¶ˆæ¯ m çš„æ‘˜è¦ã€‚</p><p>è¯·æ±‚æœ¬èº«æ˜¯ä¸åŒ…å«åœ¨é¢„å‡†å¤‡çš„æ¶ˆæ¯é‡Œé¢çš„ï¼Œè¿™æ ·å°±èƒ½ä½¿é¢„å‡†å¤‡æ¶ˆæ¯è¶³å¤Ÿå°ï¼Œå› ä¸º<strong>é¢„å‡†å¤‡æ¶ˆæ¯çš„ç›®çš„æ˜¯ä½œä¸ºä¸€ç§è¯æ˜ï¼Œç¡®å®šè¯¥è¯·æ±‚æ˜¯åœ¨è§†å›¾ v ä¸­è¢«èµ‹äºˆäº†åºå·nï¼Œä»è€Œåœ¨è§†å›¾å˜æ›´çš„è¿‡ç¨‹ä¸­å¯ä»¥è¿½ç´¢</strong>ã€‚å¦å¤–ä¸€ä¸ªå±‚é¢ï¼Œå°†â€œè¯·æ±‚æ’åºåè®®â€å’Œâ€œè¯·æ±‚ä¼ è¾“åè®®â€è¿›è¡Œè§£è€¦ï¼Œæœ‰åˆ©äºå¯¹æ¶ˆæ¯ä¼ è¾“çš„æ•ˆç‡è¿›è¡Œæ·±åº¦ä¼˜åŒ–ã€‚</p><p>åªæœ‰æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œå„ä¸ªå¤‡ä»½èŠ‚ç‚¹æ‰ä¼šæ¥å—ä¸€ä¸ªé¢„å‡†å¤‡æ¶ˆæ¯ï¼š</p><ol><li>è¯·æ±‚å’Œé¢„å‡†å¤‡æ¶ˆæ¯çš„ç­¾åæ­£ç¡®ï¼Œå¹¶ä¸” d ä¸ m çš„æ‘˜è¦ä¸€è‡´ã€‚</li><li>å½“å‰è§†å›¾ç¼–å·æ˜¯ vã€‚</li><li>è¯¥å¤‡ä»½èŠ‚ç‚¹ä»æœªåœ¨è§†å›¾ v ä¸­æ¥å—è¿‡åºå·ä¸º n ä½†æ˜¯æ‘˜è¦ d ä¸åŒçš„æ¶ˆæ¯ mã€‚</li><li>é¢„å‡†å¤‡æ¶ˆæ¯çš„åºå· n å¿…é¡»åœ¨æ°´çº¿ï¼ˆwatermarkï¼‰ä¸Šä¸‹é™ h å’Œ H ä¹‹é—´ã€‚</li></ol><p>æ°´çº¿å­˜åœ¨çš„æ„ä¹‰åœ¨äºé˜²æ­¢ä¸€ä¸ªå¤±æ•ˆèŠ‚ç‚¹ä½¿ç”¨ä¸€ä¸ªå¾ˆå¤§çš„åºå·æ¶ˆè€—åºå·ç©ºé—´ã€‚</p><h4 id="6-6-å‡†å¤‡-prepare"><a href="#6-6-å‡†å¤‡-prepare" class="headerlink" title="6.6 å‡†å¤‡(prepare)"></a>6.6 å‡†å¤‡(prepare)</h4><p>å¦‚æœå¤‡ä»½èŠ‚ç‚¹iæ¥å—äº†é¢„å‡†å¤‡æ¶ˆæ¯<code>&lt;&lt;PRE-PREPARE,v,n,d&gt;,m&gt;</code>ï¼Œåˆ™è¿›å…¥å‡†å¤‡é˜¶æ®µã€‚åœ¨å‡†å¤‡é˜¶æ®µçš„åŒæ—¶ï¼Œè¯¥èŠ‚ç‚¹å‘æ‰€æœ‰å‰¯æœ¬èŠ‚ç‚¹å‘é€å‡†å¤‡æ¶ˆæ¯<code>&lt;PREPARE,v,n,d,i&gt;</code>ï¼Œå¹¶ä¸”å°†é¢„å‡†å¤‡æ¶ˆæ¯å’Œå‡†å¤‡æ¶ˆæ¯å†™å…¥è‡ªå·±çš„æ¶ˆæ¯æ—¥å¿—ã€‚å¦‚æœçœ‹é¢„å‡†å¤‡æ¶ˆæ¯ä¸é¡ºçœ¼ï¼Œå°±ä»€ä¹ˆéƒ½ä¸åšã€‚</p><p>åŒ…æ‹¬ä¸»èŠ‚ç‚¹åœ¨å†…çš„æ‰€æœ‰å‰¯æœ¬èŠ‚ç‚¹åœ¨æ”¶åˆ°å‡†å¤‡æ¶ˆæ¯ä¹‹åï¼Œå¯¹æ¶ˆæ¯çš„ç­¾åæ˜¯å¦æ­£ç¡®ï¼Œè§†å›¾ç¼–å·æ˜¯å¦ä¸€è‡´ï¼Œä»¥åŠæ¶ˆæ¯åºå·æ˜¯å¦æ»¡è¶³æ°´çº¿é™åˆ¶è¿™ä¸‰ä¸ªæ¡ä»¶è¿›è¡ŒéªŒè¯ï¼Œå¦‚æœéªŒè¯é€šè¿‡åˆ™æŠŠè¿™ä¸ªå‡†å¤‡æ¶ˆæ¯å†™å…¥æ¶ˆæ¯æ—¥å¿—ä¸­ã€‚</p><p>æˆ‘ä»¬å®šä¹‰å‡†å¤‡é˜¶æ®µå®Œæˆçš„æ ‡å¿—ä¸ºå‰¯æœ¬èŠ‚ç‚¹iå°†<code>(m,v,n,i)</code>è®°å…¥å…¶æ¶ˆæ¯æ—¥å¿—ï¼Œå…¶ä¸­ m æ˜¯è¯·æ±‚å†…å®¹ï¼Œé¢„å‡†å¤‡æ¶ˆæ¯ måœ¨è§†å›¾ v ä¸­çš„ç¼–å· nï¼Œä»¥åŠ 2f ä¸ªä»ä¸åŒå‰¯æœ¬èŠ‚ç‚¹æ”¶åˆ°çš„ä¸é¢„å‡†å¤‡æ¶ˆæ¯ä¸€è‡´çš„å‡†å¤‡æ¶ˆæ¯ã€‚æ¯ä¸ªå‰¯æœ¬èŠ‚ç‚¹éªŒè¯é¢„å‡†å¤‡å’Œå‡†å¤‡æ¶ˆæ¯çš„ä¸€è‡´æ€§ä¸»è¦æ£€æŸ¥ï¼šè§†å›¾ç¼–å· v ã€æ¶ˆæ¯åºå· n å’Œæ‘˜è¦ dã€‚</p><p>é¢„å‡†å¤‡é˜¶æ®µå’Œå‡†å¤‡é˜¶æ®µç¡®ä¿æ‰€æœ‰æ­£å¸¸èŠ‚ç‚¹å¯¹åŒä¸€ä¸ªè§†å›¾ä¸­çš„è¯·æ±‚åºå·è¾¾æˆä¸€è‡´ã€‚æ¥ä¸‹å»æ˜¯å¯¹è¿™ä¸ªç»“è®ºçš„å½¢å¼åŒ–è¯æ˜ï¼šå¦‚æœ <code>prepared(m,v,n,i)</code> ä¸ºçœŸï¼Œåˆ™<code>prepared(m',v,n,j)</code>å¿…ä¸æˆç«‹ï¼Œè¿™å°±æ„å‘³ç€è‡³å°‘ f+1 ä¸ªæ­£å¸¸èŠ‚ç‚¹åœ¨è§†å›¾ v çš„é¢„å‡†å¤‡æˆ–è€…å‡†å¤‡é˜¶æ®µå‘é€äº†åºå·ä¸º n çš„æ¶ˆæ¯ mã€‚</p><h4 id="6-7-ç¡®è®¤-commit"><a href="#6-7-ç¡®è®¤-commit" class="headerlink" title="6.7 ç¡®è®¤(commit)"></a>6.7 ç¡®è®¤(commit)</h4><p>å½“ (m,v,n,i) æ¡ä»¶ä¸ºçœŸçš„æ—¶å€™ï¼Œå‰¯æœ¬ i å°†<code>&lt;COMMIT,v,n,D(m),i&gt;</code> å‘å…¶ä»–å‰¯æœ¬èŠ‚ç‚¹å¹¿æ’­ï¼Œäºæ˜¯å°±è¿›å…¥äº†ç¡®è®¤é˜¶æ®µã€‚</p><p>æ¯ä¸ªå‰¯æœ¬æ¥å—ç¡®è®¤æ¶ˆæ¯çš„æ¡ä»¶æ˜¯ï¼š</p><ol><li>ç­¾åæ­£ç¡®ï¼›</li><li>æ¶ˆæ¯çš„è§†å›¾ç¼–å·ä¸èŠ‚ç‚¹çš„å½“å‰è§†å›¾ç¼–å·ä¸€è‡´ï¼›</li><li>æ¶ˆæ¯çš„åºå· n æ»¡è¶³æ°´çº¿æ¡ä»¶ï¼Œåœ¨ h å’Œ H ä¹‹é—´ã€‚ä¸€æ—¦ç¡®è®¤æ¶ˆæ¯çš„æ¥å—æ¡ä»¶æ»¡è¶³äº†ï¼Œåˆ™è¯¥å‰¯æœ¬èŠ‚ç‚¹å°†ç¡®è®¤æ¶ˆæ¯å†™å…¥æ¶ˆæ¯æ—¥å¿—ä¸­ã€‚ï¼ˆè¡¥å……ï¼šéœ€è¦å°†é’ˆå¯¹æŸä¸ªè¯·æ±‚çš„æ‰€æœ‰æ¥å—çš„æ¶ˆæ¯å†™å…¥æ—¥å¿—ï¼Œè¿™ä¸ªæ—¥å¿—å¯ä»¥æ˜¯åœ¨å†…å­˜ä¸­çš„ï¼‰ã€‚</li></ol><p>ç¡®è®¤é˜¶æ®µä¿è¯äº†ä»¥ä¸‹è¿™ä¸ªä¸å˜å¼ï¼ˆinvariantï¼‰ï¼šå¯¹æŸä¸ªæ­£å¸¸èŠ‚ç‚¹ i æ¥è¯´ï¼Œå¦‚æœ committed-local(m,v,n,i) ä¸ºçœŸåˆ™ committed(m,v,n) ä¹Ÿä¸ºçœŸã€‚è¿™ä¸ªä¸å˜å¼å’Œè§†å›¾å˜æ›´åè®®ä¿è¯äº†æ‰€æœ‰æ­£å¸¸èŠ‚ç‚¹å¯¹æœ¬åœ°ç¡®è®¤çš„è¯·æ±‚çš„åºå·è¾¾æˆä¸€è‡´ï¼Œå³ä½¿è¿™äº›è¯·æ±‚åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„ç¡®è®¤å¤„äºä¸åŒçš„è§†å›¾ã€‚æ›´è¿›ä¸€æ­¥åœ°è®²ï¼Œè¿™ä¸ªä¸å˜å¼ä¿è¯äº†ä»»ä½•æ­£å¸¸èŠ‚ç‚¹çš„æœ¬åœ°ç¡®è®¤æœ€ç»ˆä¼šç¡®è®¤ f+1 ä¸ªæ›´å¤šçš„æ­£å¸¸å‰¯æœ¬ã€‚</p><p>æ¯ä¸ªå‰¯æœ¬èŠ‚ç‚¹ i åœ¨ committed-local(m,v,n,i) ä¸ºçœŸä¹‹åæ‰§è¡Œ m çš„è¯·æ±‚ï¼Œå¹¶ä¸”içš„çŠ¶æ€åæ˜ äº†æ‰€æœ‰ç¼–å·å°äº n çš„è¯·æ±‚ä¾æ¬¡é¡ºåºæ‰§è¡Œã€‚è¿™å°±ç¡®ä¿äº†æ‰€æœ‰æ­£å¸¸èŠ‚ç‚¹ä»¥åŒæ ·çš„é¡ºåºæ‰§è¡Œæ‰€æœ‰è¯·æ±‚ï¼Œè¿™æ ·å°±ä¿è¯äº†ç®—æ³•çš„æ­£ç¡®æ€§ï¼ˆsafetyï¼‰ã€‚åœ¨å®Œæˆè¯·æ±‚çš„æ“ä½œä¹‹åï¼Œæ¯ä¸ªå‰¯æœ¬èŠ‚ç‚¹éƒ½å‘å®¢æˆ·ç«¯å‘é€å›å¤ã€‚å‰¯æœ¬èŠ‚ç‚¹ä¼šæŠŠæ—¶é—´æˆ³æ¯”å·²å›å¤æ—¶é—´æˆ³æ›´å°çš„è¯·æ±‚ä¸¢å¼ƒï¼Œä»¥ä¿è¯è¯·æ±‚åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ã€‚</p><h4 id="6-8-æ£€æŸ¥ç‚¹-åƒåœ¾å›æ”¶"><a href="#6-8-æ£€æŸ¥ç‚¹-åƒåœ¾å›æ”¶" class="headerlink" title="6.8 æ£€æŸ¥ç‚¹/åƒåœ¾å›æ”¶"></a>6.8 æ£€æŸ¥ç‚¹/åƒåœ¾å›æ”¶</h4><p>ä¸ºäº†èŠ‚çœå†…å­˜ï¼Œç³»ç»Ÿéœ€è¦ä¸€ç§å°†æ—¥å¿—ä¸­çš„æ— å¼‚è®®æ¶ˆæ¯è®°å½•åˆ é™¤çš„æœºåˆ¶ã€‚ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼ŒèŠ‚ç‚¹åœ¨åˆ é™¤è‡ªå·±çš„æ¶ˆæ¯æ—¥å¿—å‰ï¼Œéœ€è¦ç¡®ä¿è‡³å°‘ f+1 ä¸ªæ­£å¸¸èŠ‚ç‚¹æ‰§è¡Œäº†æ¶ˆæ¯å¯¹åº”çš„è¯·æ±‚ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è§†å›¾å˜æ›´æ—¶å‘å…¶ä»–èŠ‚ç‚¹è¯æ˜ã€‚å¦å¤–ï¼Œå¦‚æœä¸€äº›èŠ‚ç‚¹é”™è¿‡éƒ¨åˆ†æ¶ˆæ¯ï¼Œä½†æ˜¯è¿™äº›æ¶ˆæ¯å·²ç»è¢«æ‰€æœ‰æ­£å¸¸èŠ‚ç‚¹åˆ é™¤äº†ï¼Œè¿™å°±éœ€è¦é€šè¿‡ä¼ è¾“éƒ¨åˆ†æˆ–è€…å…¨éƒ¨æœåŠ¡çŠ¶æ€å®ç°è¯¥èŠ‚ç‚¹çš„åŒæ­¥ã€‚å› æ­¤ï¼ŒèŠ‚ç‚¹åŒæ ·éœ€è¦è¯æ˜çŠ¶æ€çš„æ­£ç¡®æ€§ã€‚</p><p>åœ¨æ¯ä¸€ä¸ªæ“ä½œæ‰§è¡Œåéƒ½ç”Ÿæˆè¿™æ ·çš„è¯æ˜æ˜¯éå¸¸æ¶ˆè€—èµ„æºçš„ã€‚å› æ­¤ï¼Œè¯æ˜è¿‡ç¨‹åªæœ‰åœ¨è¯·æ±‚åºå·å¯ä»¥è¢«æŸä¸ªå¸¸æ•°ï¼ˆæ¯”å¦‚100ï¼‰æ•´é™¤çš„æ—¶å€™æ‰ä¼šå‘¨æœŸæ€§åœ°è¿›è¡Œã€‚æˆ‘ä»¬å°†è¿™äº›è¯·æ±‚æ‰§è¡Œåå¾—åˆ°çš„çŠ¶æ€ç§°ä½œæ£€æŸ¥ç‚¹ï¼ˆcheckpointï¼‰ï¼Œå¹¶ä¸”å°†å…·æœ‰è¯æ˜çš„æ£€æŸ¥ç‚¹ç§°ä½œç¨³å®šæ£€æŸ¥ç‚¹ï¼ˆstable checkpointï¼‰ã€‚</p><p>èŠ‚ç‚¹ä¿å­˜äº†æœåŠ¡çŠ¶æ€çš„å¤šä¸ªé€»è¾‘æ‹·è´ï¼ŒåŒ…æ‹¬æœ€æ–°çš„ç¨³å®šæ£€æŸ¥ç‚¹ï¼Œé›¶ä¸ªæˆ–è€…å¤šä¸ªéç¨³å®šçš„æ£€æŸ¥ç‚¹ï¼Œä»¥åŠä¸€ä¸ªå½“å‰çŠ¶æ€ã€‚å†™æ—¶å¤åˆ¶æŠ€æœ¯å¯ä»¥è¢«ç”¨æ¥å‡å°‘å­˜å‚¨é¢å¤–çŠ¶æ€æ‹·è´çš„ç©ºé—´å¼€é”€ã€‚</p><p>æ£€æŸ¥ç‚¹çš„æ­£ç¡®æ€§è¯æ˜çš„ç”Ÿæˆè¿‡ç¨‹å¦‚ä¸‹ï¼šå½“èŠ‚ç‚¹iç”Ÿæˆä¸€ä¸ªæ£€æŸ¥ç‚¹åï¼Œå‘å…¶ä»–èŠ‚ç‚¹å¹¿æ’­æ£€æŸ¥ç‚¹æ¶ˆæ¯<code>&lt;CHECKPOINT,n,d,i&gt;</code>ï¼Œè¿™é‡Œ n æ˜¯æœ€è¿‘ä¸€ä¸ªå½±å“çŠ¶æ€çš„è¯·æ±‚åºå·ï¼Œdæ˜¯çŠ¶æ€çš„æ‘˜è¦ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½é»˜é»˜åœ°åœ¨å„è‡ªçš„æ—¥å¿—ä¸­æ”¶é›†å¹¶è®°å½•å…¶ä»–èŠ‚ç‚¹å‘è¿‡æ¥çš„æ£€æŸ¥ç‚¹æ¶ˆæ¯ï¼Œç›´åˆ°æ”¶åˆ°æ¥è‡ª 2f+1 ä¸ªä¸åŒèŠ‚ç‚¹çš„å…·æœ‰ç›¸åŒåºå·nå’Œæ‘˜è¦dçš„æ£€æŸ¥ç‚¹æ¶ˆæ¯ã€‚è¿™2f+1 ä¸ªæ¶ˆæ¯å°±æ˜¯è¿™ä¸ªæ£€æŸ¥ç‚¹çš„æ­£ç¡®æ€§è¯æ˜ã€‚</p><p>å…·æœ‰è¯æ˜çš„æ£€æŸ¥ç‚¹æˆä¸ºç¨³å®šæ£€æŸ¥ç‚¹ï¼Œç„¶åä»èŠ‚ç‚¹å°±å¯ä»¥å°†æ‰€æœ‰åºå·å°äºç­‰äºnçš„é¢„å‡†å¤‡ã€å‡†å¤‡å’Œç¡®è®¤æ¶ˆæ¯ä»æ—¥å¿—ä¸­åˆ é™¤ã€‚åŒæ—¶ä¹Ÿå¯ä»¥å°†ä¹‹å‰çš„æ£€æŸ¥ç‚¹å’Œæ£€æŸ¥ç‚¹æ¶ˆæ¯ä¸€å¹¶åˆ é™¤ã€‚</p><p>æ£€æŸ¥ç‚¹åè®®å¯ä»¥ç”¨æ¥æ›´æ–°æ°´çº¿ï¼ˆwatermarkï¼‰çš„é«˜ä½å€¼ï¼ˆhå’ŒHï¼‰ï¼Œè¿™ä¸¤ä¸ªé«˜ä½å€¼é™å®šäº†å¯ä»¥è¢«æ¥å—çš„æ¶ˆæ¯ã€‚æ°´çº¿çš„ä½å€¼hä¸æœ€è¿‘ç¨³å®šæ£€æŸ¥ç‚¹çš„åºåˆ—å·ç›¸åŒï¼Œè€Œæ°´çº¿çš„é«˜å€¼H=h+kï¼Œk éœ€è¦è¶³å¤Ÿå¤§æ‰èƒ½ä½¿èŠ‚ç‚¹ä¸è‡³äºä¸ºäº†ç­‰å¾…ç¨³å®šæ£€æŸ¥ç‚¹è€Œåœé¡¿ã€‚åŠ å…¥æ£€æŸ¥ç‚¹æ¯100ä¸ªè¯·æ±‚äº§ç”Ÿä¸€æ¬¡ï¼Œkçš„å–å€¼å¯ä»¥æ˜¯200ã€‚</p><h4 id="6-9-è§†å›¾æ›´æ¢-view-change"><a href="#6-9-è§†å›¾æ›´æ¢-view-change" class="headerlink" title="6.9 è§†å›¾æ›´æ¢(view change)"></a>6.9 è§†å›¾æ›´æ¢(view change)</h4><p>å½“ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼ˆè¶…æ—¶æ— å“åº”ï¼‰æˆ–è€…ä»èŠ‚ç‚¹é›†ä½“è®¤ä¸ºä¸»èŠ‚ç‚¹æ˜¯é—®é¢˜èŠ‚ç‚¹æ—¶ï¼Œå°±ä¼šè§¦å‘ view change äº‹ä»¶ï¼Œview changeå®Œæˆåï¼Œè§†å›¾ç¼–å·å°†ä¼šåŠ 1ã€‚</p><p>ä¸‹å›¾å±•ç¤º view change çš„ä¸‰ä¸ªé˜¶æ®µæµç¨‹ï¼š</p><img src="/images/2019/pbft_2.png"><p>å¦‚å›¾æ‰€ç¤ºï¼Œview change ä¼šæœ‰ä¸‰ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯ view-changeï¼Œview-change-ack å’Œ new-view é˜¶æ®µã€‚ä»èŠ‚ç‚¹è®¤ä¸ºä¸»èŠ‚ç‚¹æœ‰é—®é¢˜æ—¶ï¼Œä¼šå‘å…¶å®ƒèŠ‚ç‚¹å‘é€ view-change æ¶ˆæ¯ï¼Œå½“å‰å­˜æ´»çš„èŠ‚ç‚¹ç¼–å·æœ€å°çš„èŠ‚ç‚¹å°†æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚å½“æ–°çš„ä¸»èŠ‚ç‚¹æ”¶åˆ°2fä¸ªå…¶å®ƒèŠ‚ç‚¹çš„ view-change æ¶ˆæ¯ï¼Œåˆ™è¯æ˜æœ‰è¶³å¤Ÿå¤šäººçš„èŠ‚ç‚¹è®¤ä¸ºä¸»èŠ‚ç‚¹æœ‰é—®é¢˜ï¼Œäºæ˜¯å°±ä¼šå‘å…¶å®ƒèŠ‚ç‚¹å¹¿æ’­ new-view æ¶ˆæ¯ã€‚æ³¨æ„ï¼šä»èŠ‚ç‚¹ä¸ä¼šå‘èµ· new-view äº‹ä»¶ã€‚å¯¹äºä¸»èŠ‚ç‚¹ï¼Œå‘é€new-view æ¶ˆæ¯åä¼šç»§ç»­æ‰§è¡Œä¸Šä¸ªè§†å›¾æœªå¤„ç†å®Œçš„è¯·æ±‚ï¼Œä» pre-prepare é˜¶æ®µå¼€å§‹ã€‚å…¶å®ƒèŠ‚ç‚¹éªŒè¯ new-view æ¶ˆæ¯é€šè¿‡åï¼Œå°±ä¼šå¤„ç†ä¸»èŠ‚ç‚¹å‘æ¥çš„ pre-prepare æ¶ˆæ¯ï¼Œè¿™æ—¶æ‰§è¡Œçš„è¿‡ç¨‹å°±æ˜¯å‰é¢æè¿°çš„ PBFT è¿‡ç¨‹ã€‚åˆ°è¿™æ—¶ï¼Œæ­£å¼è¿›å…¥ v+1ï¼ˆè§†å›¾ç¼–å·åŠ 1ï¼‰çš„è§†å›¾äº†ã€‚</p><h4 id="6-10-ç®—æ³•å¤æ‚åº¦"><a href="#6-10-ç®—æ³•å¤æ‚åº¦" class="headerlink" title="6.10 ç®—æ³•å¤æ‚åº¦"></a>6.10 ç®—æ³•å¤æ‚åº¦</h4><p>PBFT ç®—æ³•æ ¸å¿ƒæµç¨‹æœ‰ä¸‰ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯ pre-prepareï¼ˆé¢„å‡†å¤‡ï¼‰é˜¶æ®µï¼Œprepareï¼ˆå‡†å¤‡ï¼‰é˜¶æ®µå’Œ commitï¼ˆæäº¤ï¼‰é˜¶æ®µã€‚å¯¹äº pre-prepare é˜¶æ®µï¼Œä¸»èŠ‚ç‚¹å¹¿æ’­ pre-prepare æ¶ˆæ¯ç»™å…¶å®ƒèŠ‚ç‚¹å³å¯ï¼Œå› æ­¤é€šä¿¡æ¬¡æ•°ä¸º n-1ï¼›å¯¹äº prepare é˜¶æ®µï¼Œæ¯ä¸ªèŠ‚ç‚¹å¦‚æœåŒæ„è¯·æ±‚åï¼Œéƒ½éœ€è¦å‘å…¶å®ƒèŠ‚ç‚¹å† å¹¿æ’­ parepareæ¶ˆæ¯ï¼Œæ‰€ä»¥æ€»çš„é€šä¿¡æ¬¡æ•°ä¸º$n<em>(n-1)$ï¼Œå³$n^2-n$ï¼›å¯¹äº commit é˜¶æ®µï¼Œæ¯ä¸ªèŠ‚ç‚¹å¦‚æœè¾¾åˆ° prepared çŠ¶æ€åï¼Œéƒ½éœ€è¦å‘å…¶å®ƒèŠ‚ç‚¹å¹¿æ’­ commit æ¶ˆæ¯ï¼Œæ‰€ä»¥æ€»çš„é€šä¿¡æ¬¡æ•°ä¹Ÿä¸º$n</em>(n-1)$ï¼Œå³$n^2-n$ã€‚æ‰€ä»¥æ€»é€šä¿¡æ¬¡æ•°ä¸º$(n-1)+(n^2-n)+(n^2-n)$ï¼Œå³$2n^2-n-1$ï¼Œå› æ­¤ pbft ç®—æ³•å¤æ‚åº¦ä¸º$O(n^2)$ã€‚</p><h3 id="7-HotStuff"><a href="#7-HotStuff" class="headerlink" title="7. HotStuff"></a>7. HotStuff</h3><p>ä¸€å¥è¯æè¿° HotStuff ï¼š <strong>HotStuff æ˜¯ä¸€ä¸ªåœ¨éƒ¨åˆ†åŒæ­¥ç½‘ç»œæ¨¡å‹ä¸‹çš„åŸºäºä¸»èŠ‚ç‚¹çš„æ‹œå åº­å®¹é”™å…±è¯†åè®®ã€‚</strong> </p><blockquote><p>We present HotStuff, a leader-based Byzantine fault-tolerant replication protocol for the partially synchronous model.</p></blockquote><h4 id="7-1-PBFT-ç¼ºç‚¹"><a href="#7-1-PBFT-ç¼ºç‚¹" class="headerlink" title="7.1 PBFT ç¼ºç‚¹"></a>7.1 PBFT ç¼ºç‚¹</h4><p>åŸå§‹çš„ PBFT ç®—æ³•åœ¨è®¾è®¡æ—¶è€ƒè™‘çš„æ˜¯éƒ¨ç½²åœ¨æœ¬åœ°çš„åªæœ‰ n = 4 æˆ–è€… n = 7 ä¸ªèŠ‚ç‚¹çš„ç½‘ç»œï¼Œæ‰€ä»¥ PBFT ç®—æ³•åœ¨ç°æœ‰çš„ç½‘ç»œç¯å¢ƒä¸‹æœ‰å¾ˆå¤§çš„ç¼ºé™·ã€‚PBFT ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦ä¸å…¶ä»–çš„èŠ‚ç‚¹è¿›è¡Œ P2P çš„å…±è¯†åŒæ­¥ï¼Œå› æ­¤éšç€èŠ‚ç‚¹æ•°é‡çš„å¢å¤šï¼Œæ•´ä½“ç³»ç»Ÿçš„æ€§èƒ½ä¼šå‘ç”Ÿçº¿æ€§çš„é€Ÿåº¦ä¸‹é™ã€‚PBFT ç”±äºå…¶å°é—­æ€§ï¼ˆèŠ‚ç‚¹æ•°ç›®æå‰ç¡®å®šå¹¶äº’ç›¸è”é€šï¼‰å’Œé«˜æ€§èƒ½å¼€é”€($O(n^2)$çš„æ¶ˆæ¯å¤æ‚åº¦)ï¼Œå¤æ‚çš„ view change ç®—æ³•å’Œå¼€é”€ï¼Œå½“èŠ‚ç‚¹æ•°ç›® n = 2000 æ—¶ï¼Œæ¯æ¬¡å…±è¯†æ¶ˆæ¯é‡å°†ä¼šçˆ†ç‚¸åˆ° 4,000,000 ï¼Œå·²ç»ä¸å¤ªé€‚åˆç°æœ‰çš„éœ€æ±‚ã€‚</p><img src="/images/2019/hotstuff_0.png"><h4 id="7-2-HotStuff-æµç¨‹"><a href="#7-2-HotStuff-æµç¨‹" class="headerlink" title="7.2 HotStuff æµç¨‹"></a>7.2 HotStuff æµç¨‹</h4><p>HotStuff <strong>å°†è§†å›¾åˆ‡æ¢æµç¨‹å’Œæ­£å¸¸æµç¨‹è¿›è¡Œåˆå¹¶</strong>ï¼Œå³ä¸å†æœ‰å•ç‹¬çš„è§†å›¾åˆ‡æ¢æµç¨‹ï¼Œé™ä½äº†è§†å›¾åˆ‡æ¢çš„å¤æ‚åº¦ã€‚åœ¨ HotStuff ä¸­åˆ‡æ¢è§†å›¾æ—¶ï¼Œç³»ç»Ÿä¸­çš„æŸä¸ªèŠ‚ç‚¹ä¹Ÿæ— éœ€å†ç¡®è®¤â€œè¶³å¤Ÿå¤šçš„èŠ‚ç‚¹å¸Œæœ›è¿›è¡Œè§†å›¾åˆ‡æ¢â€è¿™ä¸€æ¶ˆæ¯åå†é€šçŸ¥æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå®ƒç›´æ¥åˆ‡æ¢åˆ°æ–°è§†å›¾å¹¶é€šçŸ¥æ–°çš„ä¸»èŠ‚ç‚¹ã€‚HotStuff æŠŠç¡®è®¤â€œè¶³å¤Ÿå¤šçš„èŠ‚ç‚¹å¸Œæœ›è¿›è¡Œè§†å›¾åˆ‡æ¢â€è¿™ä¸€æ¶ˆæ¯çš„è¡Œä¸ºæ”¾è¿›äº†æ­£å¸¸æµç¨‹ä¸­ã€‚è¿™ä¸€åšæ³•æ¯”è¾ƒæ–°é¢–ï¼Œä½†å¿…ç„¶ä¼šç»™æ­£å¸¸æµç¨‹å¼•å…¥æ–°çš„ç¡®è®¤é˜¶æ®µã€‚å› æ­¤ï¼ŒHotStuff æŠŠ PBFT çš„ä¸¤é˜¶æ®µç¡®è®¤æ‰©å±•æˆäº†ä¸‰é˜¶æ®µç¡®è®¤ã€‚</p><p>HotStuff ä»¥ prepare é˜¶æ®µä½œä¸ºåè®®çš„å¼€å§‹é˜¶æ®µã€‚åœ¨è¿™ä¸€é˜¶æ®µä¸­ï¼Œå½“ä¸»èŠ‚ç‚¹æ”¶é›†åˆ°è¶³å¤Ÿçš„èŠ‚ç‚¹å‘æ¥æ–°è§†å›¾è¯·æ±‚åï¼Œå®ƒå¼€å§‹æ–°è§†å›¾å¹¶æå‡ºè‡ªå·±çš„çŠ¶æ€è¿ç§»è¦æ±‚ï¼Œå‘é€ prepare æ¶ˆæ¯ç»™å…¶å®ƒèŠ‚ç‚¹ã€‚ç³»ç»Ÿä¸­çš„å…¶å®ƒèŠ‚ç‚¹åœ¨æ¥æ”¶åˆ° prepare æ¶ˆæ¯åï¼ŒéªŒè¯å…¶åˆæ³•æ€§å¹¶è¿›è¡Œå¦‚ä¸‹ä¸‰é˜¶æ®µç¡®è®¤ï¼š</p><ol><li><strong>pre-commit</strong> é˜¶æ®µï¼šå…¶å®ƒèŠ‚ç‚¹å¯¹ prepare æ¶ˆæ¯è¿›è¡ŒæŠ•ç¥¨ã€‚åœ¨æ”¶åˆ°è¶³å¤Ÿå¤šçš„æŠ•ç¥¨åï¼Œä¸»èŠ‚ç‚¹å‘æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­ pre-commit æ¶ˆæ¯ï¼Œå‘å®ƒèŠ‚ç‚¹è¡¨æ˜è¶³å¤Ÿå¤šçš„èŠ‚ç‚¹ç¡®è®¤äº†æ­¤æ¬¡çŠ¶æ€è¿ç§»çš„è¦æ±‚ã€‚ </li><li><strong>commit</strong> é˜¶æ®µï¼šå…¶å®ƒèŠ‚ç‚¹å¯¹ pre-commit æ¶ˆæ¯è¿›è¡ŒæŠ•ç¥¨ã€‚åœ¨æ”¶åˆ°è¶³å¤Ÿå¤šçš„æŠ•ç¥¨åï¼Œä¸»èŠ‚ç‚¹å‘æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­ commit æ¶ˆæ¯ã€‚æ­¤æ—¶ï¼Œæ”¶åˆ° commit æ¶ˆæ¯çš„èŠ‚ç‚¹å¯ä»¥é”å®šå½“å‰çŠ¶æ€è¿ç§»è¦æ±‚ä»¥ä¾¿å³ä½¿è§†å›¾åˆ‡æ¢ä¹Ÿå¯ä»¥é¡ºåˆ©è¾¾æˆå…±è¯†ã€‚</li><li><strong>decide</strong> é˜¶æ®µï¼šå…¶å®ƒèŠ‚ç‚¹å¯¹ commit æ¶ˆæ¯è¿›è¡ŒæŠ•ç¥¨ã€‚åœ¨æ”¶åˆ°è¶³å¤Ÿå¤šçš„æŠ•ç¥¨åï¼Œä¸»èŠ‚ç‚¹å‘æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­ decide æ¶ˆæ¯ã€‚å½“æŸä¸ªèŠ‚ç‚¹æ”¶åˆ° decide æ¶ˆæ¯åå°†æ‰§è¡ŒçŠ¶æ€è¿ç§»ï¼Œå¹¶å¼€å§‹æ–°çš„è§†å›¾ã€‚</li></ol><img src="/images/2019/hotstuff_2.png"><h4 id="7-3-HotStuff-ä¸»è¦ä¼˜åŒ–"><a href="#7-3-HotStuff-ä¸»è¦ä¼˜åŒ–" class="headerlink" title="7.3 HotStuff ä¸»è¦ä¼˜åŒ–"></a>7.3 HotStuff ä¸»è¦ä¼˜åŒ–</h4><h5 id="7-3-1-é€šä¿¡å¤æ‚åº¦ä¼˜åŒ–"><a href="#7-3-1-é€šä¿¡å¤æ‚åº¦ä¼˜åŒ–" class="headerlink" title="7.3.1 é€šä¿¡å¤æ‚åº¦ä¼˜åŒ–"></a>7.3.1 é€šä¿¡å¤æ‚åº¦ä¼˜åŒ–</h5><p>HotStuff æ¯æ¬¡é€šä¿¡éƒ½ä¾é ä¸»èŠ‚ç‚¹ã€‚èŠ‚ç‚¹ä¸å†é€šè¿‡ p2p ç½‘ç»œå°†æ¶ˆæ¯å¹¿æ’­ç»™å…¶å®ƒèŠ‚ç‚¹ï¼Œè€Œæ˜¯å°†æ¶ˆæ¯å‘é€ç»™ä¸»èŠ‚ç‚¹ï¼Œç”±ä¸»èŠ‚ç‚¹å¤„ç†åå‘é€ç»™å…¶å®ƒèŠ‚ç‚¹, ç³»ç»Ÿçš„é€šä¿¡å¤æ‚åº¦å¾—åˆ°äº†å¤§å¤§é™ä½ã€‚</p><p>ä¼ ç»Ÿ BFT è¾¾æˆå…±è¯†çš„æ–¹æ³•æ˜¯ä¸¤è½®å…±è¯†ï¼Œå…¶ä¸­ç¬¬ä¸€è½® prepare ï¼Œç¬¬äºŒè½® commitã€‚å¾ˆå¤šå°† BFT ç”¨äºåŒºå—é“¾çš„é¡¹ç›®ä»æ—§é‡‡å–<strong>å…ˆåšä¸¤è½®é€šä¿¡ï¼Œç„¶åè¾¾æˆå…±è¯†ï¼Œæœ€åä¸Šé“¾</strong>çš„æ¨¡å¼ï¼Œè€Œ Hotstuff é‡‡ç”¨çš„æ˜¯<strong>å…ˆä¸Šé“¾ï¼Œåœ¨åŒºå—ä¸­åŠ å…¥é—¨é™ç­¾å(threshold signature)</strong>ï¼Œäºæ˜¯åœ¨ n ä¸ªåŒºå—ä¹‹åå°±å¯ä»¥è§†ä¸ºé€šè¿‡äº† n è½®çš„é€šä¿¡è¾¾æˆå…±è¯†ã€‚æ‰€ä»¥æ ¹æœ¬å°±ä¸éœ€è¦å†å»åŒºåˆ†æ‰€è°“ prepareï¼Œcommit è¿™ä¸¤è½®é€šä¿¡çš„åŒºåˆ«äº†ï¼Œåªéœ€è¦ç®€å•åœ°æŠŠæ¯ä¸€è½®èŠ‚ç‚¹çš„è¡Œä¸ºå®šä¹‰æˆ<strong>leaderè´Ÿè´£å‡ºå—å’Œæ”¶é›†ç­¾å</strong>ï¼Œç„¶å<strong>å…¶ä»–èŠ‚ç‚¹è´Ÿè´£å¯¹leaderå‡ºçš„å—è¿›è¡Œç­¾å</strong>ï¼Œç„¶åï¼Œåªè¦æ”¶é›†åˆ°äº†2f+1 ä¸ªç­¾åï¼Œleader å°±å¯ä»¥å‡ºä¸€ä¸ªå—ï¼Œç„¶ååé¢æœ‰ n ä¸ªå—å°±ç›¸å½“äºè¾¾æˆäº†å…±è¯†ã€‚è¿™ç‚¹çš„å¥½å¤„åœ¨äºï¼ŒO(n) çš„é€šä¿¡å¤æ‚åº¦å¯ä»¥è®©è¯šå®èŠ‚ç‚¹çŸ¥é“ <strong>æˆ‘çŸ¥é“æ¶ˆæ¯ m å°†æˆä¸ºå…±è¯†</strong>ï¼Œä½†æ˜¯å¿…é¡»è¦ $O(n^2)$ çš„é€šä¿¡æ‰èƒ½è®©æ¯ä¸ªè¯šå®èŠ‚ç‚¹éƒ½ç¡®ä¿¡ <strong>æˆ‘è¿˜çŸ¥é“æ‰€æœ‰è¯šå®èŠ‚ç‚¹ä¹ŸçŸ¥é“æ¶ˆæ¯mæ˜¯å…±è¯†</strong> ï¼Œè€Œé€šè¿‡ leader æ”¶é›†ç­¾åå¹¶å‡ºå—è¿™ç§æ–¹æ³•ï¼Œå½“æ‰€æœ‰äººçœ‹åˆ°åŒºå— b çš„æ—¶å€™ï¼Œè¯šå®èŠ‚ç‚¹ä¼šçŸ¥é“ <strong>æˆ‘çŸ¥é“bæ˜¯å…±è¯†</strong>ï¼Œè€Œåœ¨çœ‹åˆ° b åä¸€å— bâ€™ çš„æ—¶å€™ï¼Œè¯šå®èŠ‚ç‚¹ç­‰äºçŸ¥é“äº†<strong>æ‰€æœ‰ç­¾åçš„äººä¹Ÿéƒ½çŸ¥é“äº† b æ˜¯å…±è¯†</strong>ã€‚äºæ˜¯ï¼Œæ¯æ¬¡å‡ºå—çš„æ—¶å€™éƒ½åªéœ€è¦ O(n) çš„æ¶ˆæ¯å¤æ‚åº¦ï¼Œä½†æ˜¯ï¼Œåœ¨ä¸€ä¸ªè¯šå® leader å’Œèšåˆç­¾åçš„å¸®åŠ©ä¸‹ï¼Œé€šè¿‡ä¸¤è½®çš„O(n)æ¶ˆæ¯å¤æ‚åº¦ï¼Œæˆ‘ä»¬è¾¾åˆ°äº†ä¹‹å‰ $O(n^2)$ çš„æ•ˆæœã€‚</p><h5 id="7-3-2-å¼•å…¥é—¨é™ç­¾åï¼ˆthreshold-signatureï¼‰"><a href="#7-3-2-å¼•å…¥é—¨é™ç­¾åï¼ˆthreshold-signatureï¼‰" class="headerlink" title="7.3.2 å¼•å…¥é—¨é™ç­¾åï¼ˆthreshold signatureï¼‰"></a>7.3.2 å¼•å…¥é—¨é™ç­¾åï¼ˆthreshold signatureï¼‰</h5><p>ä¸ºäº†æå‡æ•ˆç‡ï¼Œä¸€ä¸ªç›´è§‰çš„æ€è·¯æ˜¯ï¼š<strong>é¿å… $O(n^2)$ çš„é€šè®¯</strong>ã€‚æˆ‘ä»¬å¯ä»¥æŒ‡å®šç½‘ç»œä¸­çš„æŸèŠ‚ç‚¹ä½œä¸ºåè°ƒè€…æ¥å‘é€/æ¥æ”¶æ¯ä¸ªèŠ‚ç‚¹çš„æŠ•ç¥¨ï¼Œè¿™æ ·æ¯ä¸ªèŠ‚ç‚¹éƒ½åªéœ€è¦å‘åè°ƒè€…å‘é€è®¯æ¯å³å¯ï¼Œä»è€Œé¿å…äº† $O(n^2)$ çš„é€šè®¯ã€‚ç„¶è€Œï¼Œåœ¨è¿™æ ·çš„æƒ…å¢ƒä¸‹ï¼Œåè°ƒè€…æœ‰ä½œæ¶çš„å¯èƒ½ï¼Œå› ä¸ºåè°ƒè€…å¯ä»¥åœ¨æœªç¡®å®æ¥æ”¶åˆ°æŒ‡å®šæ•°é‡çš„è®¯æ¯å‰ä¾¿æ‰§è¡Œä¸‹ä¸€è½®æŠ•ç¥¨æˆ–è€…è¿›è¡ŒçŠ¶æ€æ›´æ–°ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é—¨é™ç­¾åæ¥ä¿è¯åè°ƒè€…çš„æ­£å½“è¡Œä¸ºï¼Œé—¨é™ç­¾åå¯ä»¥ä¿è¯ï¼šéœ€é›†åˆ<strong>è¶…è¿‡é—¨é™æ•°é‡(t-of-n)çš„ç­¾åæ‰æœ‰æ•ˆ</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šï¼šå”¯æœ‰å½“åè°ƒè€…é›†åˆ 2f+1 ä¸ªç­¾ååï¼Œåè°ƒè€…æ‰èƒ½å¸¦ç€åˆæ³•çš„ç­¾åç»§ç»­æ¨è¿›å…±è¯†ï¼Œè¿™åœ¨ä¹‹å‰å·²ç»æœ‰å¾ˆå¤šé¡¹ç›®é‡‡ç”¨è¿™ç§åšæ³•ï¼Œæ¯”å¦‚ï¼šDfinityã€‚</p><img src="/images/2019/hotstuff_4.jpg"><h5 id="7-3-3-æµæ°´çº¿ä½œä¸š"><a href="#7-3-3-æµæ°´çº¿ä½œä¸š" class="headerlink" title="7.3.3 æµæ°´çº¿ä½œä¸š"></a>7.3.3 æµæ°´çº¿ä½œä¸š</h5><p>å…¶å®ƒèŠ‚ç‚¹å¯¹æŸä¸€æ¶ˆæ¯è¿›è¡ŒæŠ•ç¥¨ï¼Œä¸»èŠ‚ç‚¹åˆæˆæŠ•ç¥¨æ„è§å¹¶é€šçŸ¥ç»™å…¶å®ƒèŠ‚ç‚¹ã€‚è¿™äº›è¿‡ç¨‹å¯ä»¥ç»Ÿä¸€è¡¨ç¤ºï¼Œå¹¶é‡‡ç”¨æµæ°´åŒ–æ¥å¤„ç†ã€‚</p><img src="/images/2019/hotstuff_3.png"><p>å¦‚æœæ¯ä¸ªå†…å®¹éƒ½å¿…é¡»ç»è¿‡äºŒè½®æŠ•ç¥¨/ä¸‰ä¸ªé˜¶æ®µæ‰èƒ½è¾¾æˆå…±è¯†ï¼Œå¦‚æœæœ‰ m ä¸ªå†…å®¹å°±éœ€è¦æ‰§è¡Œ 2m æ¬¡æŠ•ç¥¨ã€‚ç®¡çº¿è®¾è®¡(Pipelining)å¯ä»¥å‡å°‘æŠ•ç¥¨çš„æ¬¡æ•°ï¼ŒHotStuff çš„åŸºæœ¬æ€è·¯å¦‚ä¸‹ï¼šè®©æ¯ä¸ªèŠ‚ç‚¹åœ¨æŠ•ç¬¬ i è½®çš„ prepare é˜¶æ®µæ—¶ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¯¹å…¶å‰ä¸€ä¸ªå†…å®¹ i-1 çš„ commit é˜¶æ®µæŠ•ç¥¨ã€‚è¿™æ ·åšä¾¿å¯ä»¥èŠ‚çœå¯¹åŒä¸€ä¸ªå†…å®¹é‡å¤æŠ•ç¥¨çš„å†—ä½™ï¼Œå¤§å¹…æå‡æ•ˆç‡ã€‚</p><h5 id="7-3-4-view-change-ä¼˜åŒ–"><a href="#7-3-4-view-change-ä¼˜åŒ–" class="headerlink" title="7.3.4 view change ä¼˜åŒ–"></a>7.3.4 view change ä¼˜åŒ–</h5><p>PBFT ä¸­å½“å‘ç”Ÿ view change æ—¶ï¼Œéœ€è¦èŠ‚ç‚¹å¯¹ view change è¾¾æˆå…±è¯†ï¼Œç„¶åèŠ‚ç‚¹æŠŠè¿™ä¸ªå…±è¯†ï¼ˆä»¥åŠå·²ç»è¾¾æˆäº†å…±è¯†è¿™ä»¶äº‹ï¼‰å‘Šè¯‰æ–°çš„ leaderï¼Œæ–°çš„ leader è¿˜è¦æŠŠè¿™ä¸ªæ¶ˆæ¯å¹¿æ’­å‡ºå»å®£å¸ƒ view changeï¼Œäºæ˜¯ view changeçš„å¤æ‚åº¦æ˜¯ $O(n^3)$ , é‡‡ç”¨äº†èšåˆç­¾åä¹‹åæ˜¯ $O(n^2)$ã€‚è¿™å¸¦æ¥ä¸¤ä¸ªé—®é¢˜ï¼š</p><ul><li>view change çš„æ¶ˆæ¯å¤æ‚åº¦ï¼Œ</li><li>view change å¿…é¡»è¦ç­‰åˆ°èŠ‚ç‚¹å¯¹äº view change è¾¾æˆå…±è¯†ä¹‹åæ‰ä¼šå‘ç”Ÿã€‚</li></ul><p>Hotstuff  æŠŠ PBFT çš„ä¸¤è½®å…±è¯†å˜æˆäº†ä¸‰è½®ï¼Œç„¶åå€Ÿæ­¤æŠŠ view change çš„å¤æ‚åº¦å˜æˆäº† O(n)ã€‚è¿™ä¸ªå¯ä»¥è¿™ä¹ˆç†è§£ï¼šä¼ ç»Ÿçš„ view changeæ˜¯ $O(n^2)$ æ¶ˆæ¯å¤æ‚åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹åœ¨ view change ä¹‹å‰ä¼šç¡®è®¤æ‰€æœ‰çš„èŠ‚ç‚¹ç¡®å®éƒ½è¿›è¡Œåˆ°ä¸‹ä¸€ä¸ª viewï¼Œè€Œåœ¨ Hotstuff ä¸­ï¼Œview change ä¸éœ€è¦ç­‰<strong>æˆ‘çŸ¥é“å…¶ä»–äººä¹ŸçŸ¥é“ view change äº†</strong>è¿™ä»¶äº‹å°±å¯ä»¥è¿›è¡Œï¼Œäºæ˜¯ï¼Œæ¶ˆæ¯å¤æ‚åº¦å°±é™åˆ°äº† $O(n)$ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦è¯šå®èŠ‚ç‚¹çš„å†…ç½® time out åˆ°äº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥å‘ view change ç»™æ–°çš„ leader å¼€å§‹ view changeã€‚</p><p>HotStuff ä¸ºä»€ä¹ˆéœ€è¦æŠŠä¸¤è½®å˜æˆä¸‰è½®å‘¢ï¼Ÿä¸Šé¢æåˆ°çš„ BFT+Chain ç»“æ„çš„ç®€åŒ–ä¸­ï¼Œä¸¥æ ¼æ¥è¯´è¿™ä¸¤ä¸ªé€šä¿¡å¤æ‚åº¦ä¸º $O(n)$ çš„åŒºå—å’Œ PBFT $O(n^2)$æ¶ˆæ¯å¤æ‚åº¦çš„ prepare å’Œ commit è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼Œå½“æœ‰ä¸¤ä¸ªåŒºå—è¿èµ·æ¥çš„æ—¶å€™ä¸¤è¾¹æ˜¯ç›¸å½“çš„ï¼Œä½†æ˜¯å…¶å®æ¯ä¸€ä¸ªåŒºå—çš„æ¶ˆæ¯å¤æ‚åº¦éƒ½åªæœ‰ $O(n)$ï¼Œå¹¶ä¸è¯´æ˜æ‰€æœ‰è¯šå®èŠ‚ç‚¹éƒ½çŸ¥é“â€“<strong>æ‰€æœ‰è¯šå®èŠ‚ç‚¹éƒ½ä¼šè¾¾æˆå…±è¯†</strong>ã€‚è€ŒåŒæ ·ï¼Œview change çš„æ¶ˆæ¯å¤æ‚åº¦ä¹Ÿåªæœ‰ O(n)ï¼Œäºæ˜¯å¦‚æœä¸€æ¡æ¶ˆæ¯åˆšæœ‰ç¬¬ä¸€ä¸ªåŒºå—çš„æ—¶å€™view change äº†ï¼Œé‚£ä¹ˆè¯šå®èŠ‚ç‚¹ä¼šå¯¹äºç¬¬ä¸€ä¸ªåŒºå—æ˜¯å¦è¾¾æˆäº†å…±è¯†äº§ç”Ÿä¸ä¸€è‡´ï¼Œå› ä¸º prepare å’Œ view changeçœ‹èµ·æ¥éƒ½å¾ˆæœ‰é“ç†ã€‚</p><p>è€ŒæŠŠä¸¤è½®å˜æˆä¸‰è½®ä¹‹åæˆ‘ä»¬å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥è§„å®šä»»ä½•ä¸¤è½®ä¹‹åçš„ä¸œè¥¿æ‰æ˜¯å…±è¯†ï¼Œè€Œå¦‚æœæ²¡æœ‰åˆ°ä¸¤è½®å°±ä¸ç®—â€“<strong>å¯¹äº prepare å’Œ view change éƒ½æ˜¯å¦‚æ­¤</strong>ã€‚äºæ˜¯ï¼Œå¦‚æœ view change å‘ç”Ÿåœ¨ç¬¬ä¸€è½®ä¹‹åï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸è®¤ä¸ºä¹‹å‰ prepare çš„æ˜¯æ­£ç¡®çš„ï¼Œè€Œ view change ä¹ŸåŒç†ã€‚ç›¸åï¼Œå¦‚æœåœ¨ç¬¬äºŒè½®ä¹‹åå‘ç”Ÿ view changeï¼Œé‚£ä¹ˆç”±äºå·²ç»ç»è¿‡äº†ä¸¤è½®ï¼Œæ‰€ä»¥è¿™æ¡æ¶ˆæ¯å·²ç»ç»è¿‡äº† prepareï¼Œå³ä¾¿åœ¨ view change ä¹‹åä¹Ÿä¼šæœ€ç»ˆè¾¾æˆå…±è¯†ã€‚</p><h5 id="7-3-5-Pacemaker-æœºåˆ¶"><a href="#7-3-5-Pacemaker-æœºåˆ¶" class="headerlink" title="7.3.5 Pacemaker æœºåˆ¶"></a>7.3.5 Pacemaker æœºåˆ¶</h5><p>HotStuff é€šè¿‡ pacemaker æœºåˆ¶ä»ç®—æ³•å±‚é¢å¯¹å…±è¯†å®‰å…¨ï¼ˆsafetyï¼‰å’Œæ´»æ€§ï¼ˆliveness) è¿›è¡Œè§£è€¦åˆï¼Œå°†ä¿è¯ç³»ç»Ÿå®‰å…¨çš„éƒ¨åˆ†æŠ½ç¦»å‡ºæ¥ï¼Œç„¶åå°†ä¸å…·ä½“åº”ç”¨ç›¸å…³çš„ heuristics éƒ¨åˆ†åˆ†ç¦»ï¼Œæ¥å®ç° livenessã€‚</p><blockquote><p>HotStuff also implements a mechanism called <em>Pacemaker</em>, that guarantees liveness after GST. Pacemaker a) synchronizes all correct replicas and a unique leader into a common height for a sufficiently long period of time. It chooses the unique leader such that the correct replicas synchronized will make progress with the chosen leader. This mechanism decouples <strong>liveness</strong> from the protocol, which in turn decouples it from <strong>safety</strong>.</p></blockquote><h4 id="7-4-æ€»ç»“"><a href="#7-4-æ€»ç»“" class="headerlink" title="7.4 æ€»ç»“"></a>7.4 æ€»ç»“</h4><p>æ€»ä½“æ¥è¯´ï¼ŒHotstuff çš„æ ¸å¿ƒæ€è·¯å¦‚ä¸‹ï¼š</p><ol><li><p>é‡‡ç”¨é—¨é™ç­¾åæŠŠæ¯ä¸€è½®çš„æ¶ˆæ¯å¤æ‚åº¦å˜æˆ $O(n)$ã€‚</p></li><li><p>ç”¨ BFT+Chain ç»“æ„æŠŠ $O(n^2)$ çš„å…±è¯†å˜æˆäº†ä¸¤è½® $O(n)$ æ¶ˆæ¯å¤æ‚åº¦çš„åŒºå—æäº¤ã€‚</p></li><li><p>åœ¨è¿™ç§ç»“æ„ä¸‹ï¼ŒæŠŠ view change çš„æ¶ˆæ¯å¤æ‚åº¦é™åˆ° $O(n)$ï¼Œç„¶åä¸ºäº†é˜²æ­¢ view change é€ æˆçš„ä¸ä¸€è‡´ï¼ŒæŠŠä¸¤è½®åŒºå—æäº¤å˜æˆäº†ä¸‰è½®ã€‚</p></li><li><p>å…±è¯†è¿‡ç¨‹é‡‡ç”¨æµæ°´åŒ–å¤„ç†ã€‚</p></li></ol><h3 id="8-LibraBFT"><a href="#8-LibraBFT" class="headerlink" title="8. LibraBFT"></a>8. LibraBFT</h3><h4 id="8-1-LibraBFT-ç®€ä»‹"><a href="#8-1-LibraBFT-ç®€ä»‹" class="headerlink" title="8.1 LibraBFT ç®€ä»‹"></a>8.1 LibraBFT ç®€ä»‹</h4><p>LibraBFT[^5] åŸºäº HotStuff[^4] ï¼Œè¿›ä¸€æ­¥å®Œå–„äº† HotStuff åè®®ï¼ŒLibraBFT åœ¨ HotStuffçš„åŸºç¡€ä¸Šå¼•å…¥æ˜¾ç¤ºçš„æ´»è·ƒæœºåˆ¶å¹¶æä¾›äº†å…·ä½“çš„å»¶æ—¶åˆ†æã€‚LibraBFTåœ¨ä¸€ä¸ªæœ‰å…¨å±€ç»Ÿä¸€æ—¶é—´ï¼ˆGSTï¼‰ï¼Œå¹¶ä¸”ç½‘ç»œæœ€å¤§å»¶æ—¶ï¼ˆÎ”Tï¼‰å¯æ§çš„ Partial Synchrony çš„ç½‘ç»œä¸­æ˜¯æœ‰æ•ˆçš„ã€‚å¹¶ä¸”ï¼ŒLibraBFTåœ¨æ‰€æœ‰éªŒè¯èŠ‚ç‚¹éƒ½é‡å¯çš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½å¤Ÿä¿è¯ç½‘ç»œçš„ä¸€è‡´æ€§ã€‚</p><blockquote><p>LibraBFT is ==based on HotStuff==, a recent protocol that leverages several decades of scientific advances in Byzantine fault tolerance (BFT) and achieves the strong scalability and security properties required by internet settings. </p></blockquote><p>LibraBFT æ¯ä¸€è½®(round)å…±è¯†éƒ½ä¼šé€‰ä¸¾å‡ºä¸€ä¸ª leader èŠ‚ç‚¹ï¼Œç„¶åç”± leader èŠ‚ç‚¹å‘èµ·ææ¡ˆ(proposals)ï¼Œæ”¶é›†æŠ•ç¥¨(vote)ï¼Œæœ€åè¾¾æˆå…±è¯†ã€‚åœ¨ LibraBFT ä¸­ï¼Œæ‰€æœ‰å‚ä¸å…±è¯†çš„èŠ‚ç‚¹ç§°ä¹‹ä¸º validatorï¼Œå³éªŒè¯èŠ‚ç‚¹ã€‚</p><p>LibraBFT æ˜¯å˜ä½“çš„ HotStuff chain(è¿™ä¸ªé“¾ä¸æ˜¯ block chain ,è€Œæ˜¯ç”¨äºå…±è¯†çš„ hash é“¾),åœ¨ HotStuff çš„æ¯è½®(round)å…±è¯†æµç¨‹ä¸­ï¼Œæ‰€æœ‰çš„ä¿¡æ¯äº¤äº’éƒ½åªå’Œ leader èŠ‚ç‚¹è¿›è¡Œï¼Œç„¶å leader èŠ‚ç‚¹çš„ææ¡ˆä¼šä»¥ä¸€æ¡åŠ å¯†çš„ hashé“¾ç»„æˆ(HotStuff chain)ã€‚åœ¨æ¯è½®å…±è¯†ä¸­ï¼Œè¢«é€‰ä¸¾å‡ºçš„ leader èŠ‚ç‚¹ä¼šåŸºäºèŠ‚ç‚¹è‡ªèº«æœ€é•¿çš„ HotStuff chain æå‡º block ææ¡ˆï¼Œå¦‚æœææ¡ˆæ˜¯æœ‰æ•ˆå¹¶ä¸”åŠæ—¶ï¼Œå‰©ä½™çš„è¯šå®èŠ‚ç‚¹ä¼šä½¿ç”¨è‡ªèº«çš„ç§é’¥ç­¾åè¯¥ææ¡ˆï¼Œå¹¶å°†é€šè¿‡çš„ vote å‘é€å› leaderèŠ‚ç‚¹ã€‚å½“ leader èŠ‚ç‚¹æ”¶é›†åˆ°è¶³å¤Ÿçš„ (Quorum vote) æ—¶ï¼Œä¼šå°† vote èšåˆæˆ Quorumè¯ä¹¦(Quorum Certificateï¼ŒQC)ï¼Œå½“ç„¶ï¼Œleader ä¼šåŸºäºä¸Šè¿°å·²å»¶ä¼¸çš„æœ€é•¿ HotStuff chain ç»§ç»­è¿½åŠ  QCï¼Œæ¢è¨€ä¹‹ï¼Œä¸€è½®å…±è¯†æˆåŠŸåï¼Œleader èŠ‚ç‚¹ä¼šåŸºäºè‡ªèº«æœ€é•¿çš„ HotStuff chainï¼ŒæŒ‰åºè¿½åŠ ææ¡ˆ block(ç¼©å†™B) ä»¥åŠ QC(ç¼©å†™C)ï¼Œç„¶ååœ¨å°† QC å†æ¬¡å¹¿æ’­è‡³å‰©ä½™çš„èŠ‚ç‚¹ï¼Œå¹¶å¼€å¯ä¸‹ä¸€è½®çš„å…±è¯†ã€‚å½“ç„¶è¿™æ˜¯å…±è¯†æˆåŠŸçš„æƒ…å†µã€‚åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œæ— è®ºä»»ä½•åŸå› ï¼Œå¦‚æœå½“å‰ leader èŠ‚ç‚¹æ²¡æ³•åŠæ—¶å…±è¯†æˆåŠŸï¼Œå…±è¯†å‚ä¸è€…ä¼šä¸€ç›´ç­‰åˆ°å½“å‰ round çš„è¶…æ—¶æ—¶é—´ï¼Œç„¶ååœ¨å‘èµ·ä¸‹ä¸€è½®çš„å…±è¯†ã€‚</p><p> æœ€åï¼Œå¦‚æœè¶³å¤Ÿçš„ blocks ä»¥åŠ QCs éƒ½èƒ½è¿ç»­åŠæ—¶çš„é€šè¿‡å…±è¯†ï¼Œå¹¶ä¸”å…¶ä¸­ä¸€ä¸ª block è¾¾åˆ°äº† commit æ¡ä»¶ï¼Œé‚£ä¹ˆï¼Œè¯¥ block ä¼šè¢« commit ï¼Œæ¢è¨€ä¹‹ï¼Œè¯¥ block ä»¥åŠ block ä¸­ transaction é›†åˆéƒ½ä¼šè¢«è½ç›˜ï¼Œå¹¶è¢«ç¡®è®¤ã€‚</p><img src="/images/2019/librabft_0.png"><pre><code>                                                                                   HotStuff Chain</code></pre><p> ä¸Šå›¾æè¿°çš„ HotStuff Chainï¼Œå…¶å¯ä»¥è¡¨ç°ä¸ºï¼š ã€â„init â† ğµ1 â† ğ¶1 â† ğµ2 â† ğ¶2 â€¦ â† ğµğ‘›+1 â† ğ¶ğ‘›+1ã€‘</p><h4 id="8-2-LibraBFT-å…±è¯†æµç¨‹"><a href="#8-2-LibraBFT-å…±è¯†æµç¨‹" class="headerlink" title="8.2 LibraBFT å…±è¯†æµç¨‹"></a>8.2 LibraBFT å…±è¯†æµç¨‹</h4><p>æ ¹æ®è®ºæ–‡æè¿° LibraBFT æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><img src="/images/2019/librabft_1.png"><pre><code>             Overview of the LibraBFT protocol (simplified, excluding round synchronization)                                                                        </code></pre><p>*<em>ç®€å•åˆ†æï¼š *</em></p><ol><li>round 1 çš„ leader node3 å‡ºäº† block B1ï¼Œå¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰ nodesã€‚</li><li>å…¶å®ƒ node åŒæ„ï¼Œå›ä¼  vote V1ã€‚</li><li>node3 æ”¶é›†æŠ•ç¥¨ (åŒ…å«è‡ªå·±çš„ vote)ï¼Œå½¢æˆ C1ï¼Œä¼ ç»™æ‰€æœ‰ nodesã€‚</li><li>(3 å’Œ 1 ä¹‹é—´çš„é—´éš”æ—¶é—´) node0 æ˜¯ round 2 çš„ leaderï¼Œæ”¶é›†å…¶å®ƒ nodes çš„çŠ¶æ€ï¼Œç¡®å®šæœ‰ <code>N â€” f</code> ä¸ª nodes è¿›å…¥ round 2 åï¼Œäº§ç”Ÿ B2ï¼Œå›åˆ°æ­¥éª¤ 1 ~ 3ã€‚</li></ol><p><strong>è¯¦ç»†åˆ†æï¼š</strong></p><p>é€šè¿‡ round 3 æ¥è¯¦ç»†åˆ†æå…±è¯†æµç¨‹ï¼š</p><ol><li><p>node1 è¢«é€‰ä¸¾ä¸º leader èŠ‚ç‚¹ï¼Œç„¶å node1 ä¼šåŸºäºè‡ªèº«æœ€é•¿é“¾å°¾éƒ¨ C2 å‘èµ· B3 ææ¡ˆï¼Œç„¶åå°†ææ¡ˆå¹¿æ’­è‡³å‰©ä½™èŠ‚ç‚¹(node0ï¼Œ2ï¼Œ3)ï¼Œå¹¿æ’­å®Œæˆåï¼Œnode1 ä¼šæ‰§è¡Œ B3 ä¸­çš„ transaction åˆ—è¡¨ï¼Œå¾—åˆ° execute stateï¼›</p></li><li><p>å½“å‰©ä½™èŠ‚ç‚¹(node0ï¼Œ2ï¼Œ3)æ”¶åˆ° B3ææ¡ˆåï¼Œä¼šæ‰§è¡Œ B3 ä¸­çš„äº¤æ˜“ï¼Œç„¶åå°† execute state æ‰“åŒ…åˆ° vote ä¸­ï¼Œåœ¨å°†å…¶ç­¾åï¼Œå¹¶å‘é€ç»™ node1;</p></li><li><p>ä¸€èµ·éƒ½æ­£å¸¸æƒ…å†µä¸‹ï¼Œnode1 ä¼šæ”¶åˆ°è‡ªèº«ä»¥å¤–çš„ vote è¯·æ±‚ï¼Œå½“æ”¶é›†åˆ°è¶³å¤Ÿå¤šçš„ vote æ—¶ï¼Œå¹¶ä¸” vote éªŒè¯é€šè¿‡,åŒ…æ‹¬ execute state ã€ç­¾åã€round ç­‰ï¼Œleader èŠ‚ç‚¹ä¼šå°† vote é›†åˆæ‰“åŒ…æˆ quorum certificate(QC)ï¼Œå¹¶å°† QC å¹¿æ’­è‡³å‰©ä½™èŠ‚ç‚¹ï¼Œåˆ°è¿™é‡Œï¼Œä¸€è½®å…±è¯†å®Œæ¯•ã€‚     </p></li></ol><p><strong>block æäº¤</strong><br>å…±è¯†è½®æ¬¡(round)ç”¨ int è¡¨ç¤ºï¼Œå¹¶ä¸”åªä¼šé€’å¢ã€‚åœ¨æ¯ä¸€è½®å…±è¯†è½®æ¬¡ä¸­ï¼Œéƒ½ä»…ç”±ä¸€ä¸ª leader èŠ‚ç‚¹å‘èµ·ä¸€æ¬¡ææ¡ˆï¼Œè½®æ¬¡ä»…åœ¨å…±è¯†æˆåŠŸåæˆ–å½“å‰å…±è¯†è½®æ¬¡è¶…æ—¶æ‰ä¼šç»“æŸï¼Œç„¶åè½®æ¬¡è‡ªå¢1ï¼Œå¯åŠ¨ä¸‹è½®æ¬¡å…±è¯†ã€‚å› æ­¤ï¼Œå‡è®¾ round(Bi) ä¸ºææ¡ˆ Bi çš„å½“å‰è½®æ¬¡å€¼ï¼Œå¹¶ä¸”ï¼Œä¾æ®é€’å¢çš„è§„å®šå¯ä»¥å¾—åˆ° round(ğµğ‘–) &lt; round(ğµğ‘–+1)ï¼›å¦å¤–ï¼Œå¦‚æœ round(ğµğ‘–) + 1 = round(ğµğ‘–+1)ï¼Œæˆ‘ä»¬åˆ™ç§°ä¹‹ä¸ºè¿ç»­å…±è¯†æˆåŠŸä¸¤è½®ï¼Œä»£è¡¨åœ¨è¿™ä¸¤è½®å…±è¯†ä¸­ï¼Œéƒ½æ²¡æœ‰å‘ç”Ÿè¶…æ—¶ï¼Œå¹¶ä¸”å…±è¯†éƒ½æˆåŠŸã€‚å¦‚æœåŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li>ğµ1 â† ğ¶1 â† ğµ2 â† ğ¶2 â† ğµ3 â† ğ¶3</li><li>round(ğµ3) = round(ğµ2) + 1 = round(ğµ1) + 2</li></ul><p>é‚£ä¹ˆï¼ŒB1 åˆ™ä¼šè¢« commitï¼Œæ¢è¨€ä¹‹ï¼Œè¿ç»­ä¸‰ä¸ªå…±è¯†è½®æ¬¡æˆåŠŸçš„æƒ…å†µä¸‹ï¼Œç¬¬ä¸€ä¸ªå…±è¯†çš„ block å°±ä¼šè¢«æäº¤ã€‚æ€»çš„æ¥è¯´ï¼Œç›¸å¯¹äº PBFT çš„ä¸‰é˜¶æ®µæäº¤æ¥è¯´ï¼ŒLibraBFT çš„åªéœ€1.5é˜¶æ®µï¼Œæ—¢å¯å®Œæˆä¸€è½®å…±è¯†ï¼Œä¸Šè¿°çš„ round(B3) å®Œæˆåï¼Œround(B1) æ‰ä¼šè¢« commit ç›¸å½“äº PBFT çš„ commit é˜¶æ®µã€‚å…¶å®è¿™å°±æ˜¯ HotStuff ä¸­çš„åšæ³•ã€‚</p><h4 id="8-3-Data-Synchronization"><a href="#8-3-Data-Synchronization" class="headerlink" title="8.3 Data Synchronization"></a>8.3 Data Synchronization</h4><p>Leader åœ¨ææ¡ˆä»¥å‰ï¼Œä¼šå…ˆç¡®ä¿è¶³å¤Ÿäººæ•°è¿›å…¥åŒä¸€ round æ‰ä¼šå‡ºå—ã€‚nodes ä¹‹é—´ä¼šå®šæ—¶äº’ç›¸ä¼ æ’­è‡ªå·±çš„çŠ¶æ€ï¼Œç„¶åå‘åˆ¥äººå–å¾—ç¼ºå°‘çš„éƒ¨ä»½ã€‚åŒæ­¥çš„æµç¨‹ä¸º:</p><ol><li>å¹¿æ’­ DataSyncNotaificationã€‚</li><li>ä¾å…¶å®ƒäººçš„çŠ¶æ€ï¼Œå‘å¯¹æ–¹å‘é€ DataSyncRequestã€‚</li><li>æ”¶åˆ° DataSyncRequest åï¼Œå›å¤ DataSyncResponseã€‚</li></ol><p>ç›®å‰çš„å®ç°ï¼Œrequest ä¸€æ¬¡ä¼ è‡ªå·±å…¨éƒ¨çš„çŠ¶æ€ï¼Œresponse ä¸€æ¬¡å›å¤å…¨éƒ¨ç¼ºå°‘çš„éƒ¨ä»½ã€‚è¯¦ç»†å®ç°å¦‚ä¸‹:</p><img src="/images/2019/librabft_2.png"><p>ç›®å‰ä»£ç è·Ÿç™½çš®ä¹¦ä¸Šçš„ä¼ªä»£ç æœ‰å‡ºå…¥ã€‚</p><h4 id="8-4-Voting-Constraint"><a href="#8-4-Voting-Constraint" class="headerlink" title="8.4 Voting Constraint"></a>8.4 Voting Constraint</h4><p>ç¬¦å·è¯´æ˜ï¼š</p><ul><li>B è¡¨ç¤º åŒºå—(block)ã€‚</li><li>C è¡¨ç¤º (æ³•å®šè¯ä¹¦)quorum certificateã€‚</li><li>B â† C è¡¨ç¤º C çš„ä¸Šä¸€ä¸ª record æŒ‡å‘ Bï¼Œå³ C æœ‰è®°å½• B çš„ hashã€‚</li><li>round(B) è¡¨ç¤º B çš„ round æ˜¯å¤šå°‘ã€‚</li><li>å¯¹ Bâ€™ â† Câ€™ â† B æ¥è¯´ï¼Œprevious_round(B) è¡¨ç¤º round(Bâ€™)</li></ul><p>é™¤äº†åªèƒ½æŠ•ç›®å‰ round çš„ block ä»¥å¤–ï¼Œnodes æŠ•ç¥¨æ—¶è¿˜è¦éµå®ˆä¸¤ä¸ªè§„åˆ™:</p><ul><li>First voting constraint: æŠ•è¿‡ round x çš„ç¥¨ååªèƒ½æŠ• round y (y &gt; x) çš„ç¥¨ã€‚</li><li>Second voting constraint: çœ‹è¿‡ 2-chain B0 â† C0 â† B1 â† C1 åï¼Œæ”¶åˆ°æ–°çš„ block Bï¼Œprevious_round(B) â‰¥ round(B0)</li></ul><p>ç¬¬ä¸€ä¸ªè§„åˆ™ç¬¦åˆè‡ªè§‰ï¼Œåªèƒ½æŠ•æ›´æ–°çš„ blockã€‚è‹¥åŒä¸€ round é‡Œï¼Œleader ä¸å®ˆè§„åˆ™äº§ç”Ÿä¸¤ä¸ªä¸åŒçš„ blockï¼Œvoter åªä¼šæŠ•çœ‹åˆ°çš„ç¬¬ä¸€ä¸ªï¼Œä¸ä¼š double voteã€‚</p><p>ç¬¬äºŒä¸ªè§„åˆ™è¡¨ç¤ºæœ‰çœ‹åˆ°ä¸¤ä¸ªè¿ç»­é€šè¿‡çš„ block åï¼Œæ–°çš„ block B è‡³å°‘è¦æŒ‡å‘ B0 æˆ– round æ•°æ¯”å®ƒå¤§çš„ blockã€‚æ³¨æ„ï¼Œè¿™é‡Œæ²’æœ‰è¦æ±‚ B æ‰€åœ¨çš„ chain ä¸Šé¢ä¸€å®šæœ‰ B0ã€‚</p><h4 id="8-5-Commit-Rule"><a href="#8-5-Commit-Rule" class="headerlink" title="8.5 Commit Rule"></a>8.5 Commit Rule</h4><p>å¯¹ 3-chain B0 â† C0 â† B1 â† C1 â† B2 â† C2 ä¸” round(B2) = round(B1)+1 = round(B0)+2 æ¥è¯´ï¼ŒB0 ä»¥åŠå®ƒä¹‹å‰çš„ records çš„çŠ¶æ€ç§°ä¸º committedï¼Œä¸€ä½† committedï¼Œè¡¨ç¤ºè®°å½•å°±ä¸ä¼šæ‰äº†ã€‚</p><p>QC æœ‰ä¸ªé€‰æ‹©æ€§çš„æ ä½ commitmentï¼Œç”¨æ¥è®°å½•æœ€æ–°çš„ committed stateã€‚ä»¥è¿™é‡Œçš„ä¾‹å­æ¥è¯´ï¼ŒC2 çš„ commitment ä¼šè®°å½• state(C0)ã€‚</p><p>åªç®¡æ¥è¯´ï¼Œè‹¥ node A çœ‹åˆ°ä¸Šè¿°çš„ B0 â† â€¦ â† C2ï¼Œè¡¨ç¤º A çŸ¥é“æœ‰ <code>N â€” f</code> çš„ nodes çŸ¥é“ B0 â† C0 â† B1 â† C1ã€‚æ‰€ä»¥ä¹‹åé€šè¿‡çš„ block Bï¼Œä¼šæ»¡è¶³ previous_round(B) â‰¥ round(B0)ã€‚è¡¨ç¤º B æ‰€åœ¨çš„ chain ä¸Šå¿…å®šåŒ…å« B0ã€‚</p><h4 id="8-6-Punishment"><a href="#8-6-Punishment" class="headerlink" title="8.6 Punishment"></a>8.6 Punishment</h4><p>æœ‰äº† voting constraint å’Œ commit ruleï¼Œå¤§å®¶å¯ä»¥ä¸¾æŠ¥è°ä¸éµå®ˆè§„åˆ™ï¼ŒéªŒè¯åå¯æƒ©ç½š (ä¾‹å¦‚æ²’æ”¶ stake-in çš„ token)ã€‚</p><h4 id="8-7-Network"><a href="#8-7-Network" class="headerlink" title="8.7 Network"></a>8.7 Network</h4><p>æ–‡ä¸­æåˆ°åœ¨ P2P synchronization protocol ä¹‹ä¸Šæœ‰åŠ ä¸€å±‚ gossip overlayï¼Œåœ¨ broadcast çš„æ—¶å€™ä¼šéšæœºä¼ çµ¦ K (â‰¤N) ä¸ª nodesï¼Œç„¶åé€šè¿‡æ”¶åˆ°çš„ nodes ç»§ç»­ä¼ æ’­æ¶ˆæ¯ã€‚ä¸è¿‡ä¸ºç®€åŒ–è®¨è®ºï¼Œå‡è®¾ K = Nã€‚</p><p>è€ƒè™‘åˆ°ç½‘ç»œçŠ¶æ€ä¼šå˜åŒ–ï¼Œtimeout çš„å€¼ç”±ä»¥ä¸‹å…¬å¼ç¡®å®š:</p><pre class=" language-rust"><code class="language-rust"><span class="token function">duration</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> delta <span class="token operator">*</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> nc <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">^</span>r</code></pre><ul><li>n è¡¨ç¤ºç›®å‰çš„ roundã€‚</li><li>nc è¡¨ç¤ºæœ€åä¸€ä¸ª committed block çš„ roundã€‚</li><li>delta å’Œ r æ˜¯å¸¸æ•°ã€‚</li></ul><p>ç›´è§‚æ¥è¯´ï¼Œæ„ˆä¹…æ²¡æœ‰æ–°çš„ committed blockï¼Œtimeout æ—¶é—´æ„ˆä¹…ã€‚å‡è®¾æ— æ³•åŒæ„æ–°çš„ block æ˜¯å› ä¸ºç½‘ç»œçŠ¶æ€ä¸ä½³ï¼Œé€æ¸åŠ é•¿ timeout æ—¶é—´åˆç†ã€‚ä½†è‹¥æ˜¯å› ä¸º byzantine node (æ‹œå åº­èŠ‚ç‚¹) é€ æˆçš„ï¼Œåè€Œè®© byzantine node æ‹–æ›´ä¹…æ²¡æœ‰ livenessã€‚å®é™…æƒ…å†µä¾ã€Œæ‹œå åº­èŠ‚ç‚¹å’Œç½‘ç»œçŠ¶æ€ä¸ä½³ã€ä½•è€…æ›´å®¹æ˜“å‘ç”Ÿï¼Œæ¥å†³å®šå‚æ•°æ€ä¹ˆè®¾ç½®ã€‚</p><h4 id="8-8-æ€»ç»“"><a href="#8-8-æ€»ç»“" class="headerlink" title="8.8 æ€»ç»“"></a>8.8 æ€»ç»“</h4><p>We have presented LibraBFT, a state machine replication system based on the HotStuff protocol [5]<br>and designed for the Libra Blockchain [2]. LibraBFT provides safety and liveness in a Byzantine<br>setting when up to one-third of voting rights are held by malicious actors, assuming that the network is partially synchronous. In this report, we have presented detailed proofs of safety and liveness and covered many important practical considerations, such as networking and data structures. We have shown that LibraBFT is compatible with proof of stake and can generate incentives for a variety of behaviors, such as proposing blocks and voting. Thanks to the simplicity of the safety argument in LibraBFT, we also provided criteria to detect malicious attempts to break safety. These criteria will be instrumental for the progressive migration of the Libra infrastructure to a permissionless model.</p><h4 id="8-9-Future-work"><a href="#8-9-Future-work" class="headerlink" title="8.9 Future work"></a>8.9 Future work</h4><p>This report constitutes an initial proposal for LibraBFT and is meant to be updated in the future. In the next version, we intend to share the code for our reference implementation in a simulated environment and provide experimental results, both using this simulation and using the production implementation currently developed by Calibra engineers.</p><p>In the future, we would like to improve our theoretical analysis in several ways. We plan to make<br>our networking assumptions more precise, with additional studies on message sizes and probabilistic gossiping. Regarding the integration of LibraBFT with the Libra Blockchain, we would like to cover fairness and discuss how light clients can authenticate the set of validators for each epoch. Economic incentives should reward additional positive behaviors, such as creating timeouts, and specifications should provide an external protocol for auditors to report violations of safety rules.</p><p>On a practical level, we have not yet analyzed resource consumption (memory, CPU, etc.) in the<br>presence of malicious participants. Heuristics for leader selection, a precise description of the VRF<br>solution, and possibly adaptive policies will likely be required to increase the robustness of the system in case of malicious leaders or targeted attacks on leaders.</p><p>In the long term, we hope that our efforts on precise specifications and detailed proofs will pave the<br>way for mechanized proofs of safety and liveness of LibraBFT.</p><h3 id="9-å‚è€ƒèµ„æ–™"><a href="#9-å‚è€ƒèµ„æ–™" class="headerlink" title="9. å‚è€ƒèµ„æ–™"></a>9. å‚è€ƒèµ„æ–™</h3><ul><li><a href="https://arxiv.org/pdf/1803.05069.pdf" target="_blank" rel="noopener">HotStuff: BFT Consensus in the Lens of Blockchain</a></li><li><a href="https://developers.libra.org/docs/papers/libra-consensus-state-machine-replication-in-the-libra-blockchain.pdf" target="_blank" rel="noopener">State Machine Replication in the Libra Blockchain</a></li><li><a href="https://zhuanlan.zhihu.com/p/72776441" target="_blank" rel="noopener">Libra é‡‡ç”¨çš„ HotStuff ç®—æ³•ä½œè€…äº²è¿°ï¼šã€Œå°¤ç‰©ã€è¯ç”Ÿè®°</a></li><li><a href="https://www.chainnews.com/articles/215569914405.htm" target="_blank" rel="noopener">ä¸€æ–‡ç®€è¿° HotStuff çš„å·¥ä½œåŸç†</a></li><li><a href="https://bbs.vechainworld.io/topic/200/librabftç®—æ³•ç®€è¿°" target="_blank" rel="noopener">LibraBFTç®—æ³•ç®€è¿°</a></li></ul><p>[^4]: M. Yin, D. Malkhi, M. K. Reiterand, G. G. Gueta, and I. Abraham, â€œHotStuff: BFT consensus</p><p>in the lens of blockchain,â€ 2019. <a href="https://arxiv.org/pdf/1803.05069.pdf" target="_blank" rel="noopener">https://arxiv.org/pdf/1803.05069.pdf</a></p><p>[^5]: State Machine Replication in the Libra Blockchain <a href="https://developers.libra.org/docs/papers/libra-consensus-state-machine-replication-in-the-libra-blockchain.pdf" target="_blank" rel="noopener">https://developers.libra.org/docs/papers/libra-consensus-state-machine-replication-in-the-libra-blockchain.pdf</a><br>[^6]: Impossibility of Distributed Consensus with One Faulty Process  <a href="https://groups.csail.mit.edu/tds/papers/Lynch/jacm85.pdf" target="_blank" rel="noopener">https://groups.csail.mit.edu/tds/papers/Lynch/jacm85.pdf</a><br>[^7]: <a href="https://en.wikipedia.org/wiki/Clock_drift" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Clock_drift</a><br>[^8]: <a href="https://en.wikipedia.org/wiki/Clock_skew" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Clock_skew</a><br>[^9]: <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Network_Time_Protocol</a><br>[^10]: <a href="https://en.wikipedia.org/wiki/Real-time_clock" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Real-time_clock</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> Blockchain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Blockchain </tag>
            
            <tag> Libra </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£ IO</title>
      <link href="/2020/05/20/io/"/>
      <url>/2020/05/20/io/</url>
      
        <content type="html"><![CDATA[<p>æ–‡ä»¶ I/O çš„æ€§èƒ½å¯¹æ•°æ®åº“ç³»ç»Ÿçš„æ€§èƒ½æœ‰ç›´æ¥çš„å½±å“ï¼Œæˆ‘ä»¬éœ€è¦å…¨é¢äº†è§£å’ŒæŒæ¡æ–‡ä»¶I/Oã€‚</p><h2 id="æ•´ä½“æ¶æ„"><a href="#æ•´ä½“æ¶æ„" class="headerlink" title="æ•´ä½“æ¶æ„"></a>æ•´ä½“æ¶æ„</h2><p>Linux æ–‡ä»¶ç³»ç»Ÿé‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œå¯¹ä¸åŒå±‚è¿›è¡ŒæŠ½è±¡è¾¾åˆ°æ¶æ„æ¸…æ™°ã€è§£è€¦çš„ä½œç”¨ã€‚</p><h3 id="Linux-Storage-Stack"><a href="#Linux-Storage-Stack" class="headerlink" title="Linux Storage Stack"></a>Linux Storage Stack</h3><img src="/images/2015/Linux-storage-stack-diagram_v4.10.png"><h2 id="ç¡¬ç›˜"><a href="#ç¡¬ç›˜" class="headerlink" title="ç¡¬ç›˜"></a>ç¡¬ç›˜</h2><img src="/images/2015/disk_26.png"><p>HDD å’Œæ—©æœŸ SSD ç»å¤§å¤šæ•°éƒ½æ˜¯ä½¿ç”¨ SATA æ¥å£ï¼Œè·‘çš„æ˜¯ AHCIï¼ˆAdvanced Host Controller Interfaceï¼‰ï¼Œå®ƒæ˜¯ç”±Intelè”åˆå¤šå®¶å…¬å¸ç ”å‘çš„ç³»ç»Ÿæ¥å£æ ‡å‡†ã€‚AHCI æ”¯æŒ NCQï¼ˆNative Command Queuingï¼‰åŠŸèƒ½å’Œçƒ­æ’æ‹”æŠ€æœ¯ã€‚NCQ æœ€å¤§æ·±åº¦ä¸º32ï¼Œå³ä¸»æœºå¯ä»¥å‘æœ€å¤š32æ¡å‘½ä»¤ç»™ HDD æˆ–è€… SSD æ‰§è¡Œï¼Œè·Ÿä¹‹å‰ç¡¬ç›˜åªèƒ½ä¸€æ¡å‘½ä»¤ä¸€æ¡å‘½ä»¤æ‰§è¡Œç›¸æ¯”ï¼Œç¡¬ç›˜æ€§èƒ½å¤§å¹…æå‡ã€‚</p><p>è¿™åœ¨ HDD æ—¶ä»£ï¼Œæˆ–è€… SSD æ—©æœŸï¼ŒAHCI åè®®å’Œ SATA æ¥å£è¶³å¤Ÿæ»¡è¶³ç³»ç»Ÿæ€§èƒ½éœ€æ±‚ï¼Œå› ä¸ºæ•´ä¸ªç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆåœ¨ç¡¬ç›˜ç«¯ï¼ˆä½é€Ÿï¼Œé«˜å»¶æ—¶ï¼‰ï¼Œè€Œä¸æ˜¯åœ¨åè®®å’Œæ¥å£ç«¯ã€‚ç„¶è€Œï¼Œéšç€ SSD æŠ€æœ¯çš„é£é€Ÿå‘å±•ï¼ŒSSD ç›˜çš„æ€§èƒ½é£™å‡ï¼Œåº•å±‚é—ªå­˜å¸¦å®½è¶Šæ¥è¶Šå®½ï¼Œä»‹è´¨è®¿é—®å»¶æ—¶è¶Šæ¥è¶Šä½ï¼Œç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆå·²ç»ç”±ä¸‹è½¬ç§»åˆ°ä¸Šé¢çš„æ¥å£å’Œåè®®å¤„äº†ã€‚AHCI å’Œ SATAå·²ç»ä¸èƒ½æ»¡è¶³é«˜æ€§èƒ½å’Œä½å»¶æ—¶ SSD çš„éœ€æ±‚ï¼Œå› æ­¤ SSD è¿«åˆ‡éœ€è¦è‡ªå·±æ›´å¿«ã€æ›´é«˜æ•ˆçš„åè®®å’Œæ¥å£ã€‚</p><p>åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹ï¼ŒNVMe æ¨ªç©ºå‡ºä¸–ã€‚2009å¹´ä¸‹åŠå¹´ï¼Œåœ¨å¸¦å¤´å¤§å“¥ Intel é¢†å¯¼ä¸‹ï¼Œç¾å…‰ã€æˆ´å°”ã€ä¸‰æ˜Ÿã€Marvellç­‰å·¨å¤´ï¼Œä¸€èµ·åˆ¶å®šäº†ä¸“é—¨ä¸º SSD æœåŠ¡çš„ NVMe åè®®ï¼Œæ—¨åœ¨è®© SSD ä»è€æ—§çš„ SATA å’Œ AHCI ä¸­è§£æ”¾å‡ºæ¥ã€‚</p><p>ä½•ä¸ºNVMeï¼ŸNon-Volatile Memory Expressï¼Œéæ˜“å¤±æ€§å­˜å‚¨å™¨æ ‡å‡†ï¼Œæ˜¯è·‘åœ¨ PCIe æ¥å£ä¸Šçš„åè®®æ ‡å‡†ã€‚NVMe çš„è®¾è®¡ä¹‹åˆå°±æœ‰å……åˆ†åˆ©ç”¨åˆ° PCIe SSD çš„ä½å»¶æ—¶ä»¥åŠå¹¶è¡Œæ€§ï¼Œè¿˜æœ‰å½“ä»£å¤„ç†å™¨ã€å¹³å°ä¸åº”ç”¨çš„å¹¶è¡Œæ€§ã€‚SSDçš„å¹¶è¡Œæ€§å¯ä»¥å……åˆ†è¢«ä¸»æœºçš„ç¡¬ä»¶ä¸è½¯ä»¶å……åˆ†åˆ©ç”¨ï¼Œç›¸æ¯”äºç°åœ¨çš„ AHCI æ ‡å‡†ï¼ŒNVMe æ ‡å‡†å¯ä»¥å¸¦æ¥å¤šæ–¹é¢çš„æ€§èƒ½æå‡ã€‚NVMeä¸ºSSDè€Œç”Ÿï¼Œä½†ä¸å±€é™äºä»¥é—ªå­˜ä¸ºåª’ä»‹çš„SSDï¼Œå®ƒåŒæ ·å¯ä»¥åº”ç”¨åœ¨é«˜æ€§èƒ½å’Œä½å»¶æ—¶çš„3D XPointè¿™ç±»æ–°å‹çš„ä»‹è´¨ä¸Šã€‚</p><p>NVMeå’ŒAHCIç›¸æ¯”ï¼Œå®ƒçš„ä¼˜åŠ¿ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ç‚¹ï¼š</p><p><strong>ä½æ—¶å»¶ï¼ˆLatencyï¼‰</strong></p><p>é€ æˆç¡¬ç›˜å­˜å‚¨æ—¶å»¶çš„ä¸‰å¤§å› ç´ ï¼šå­˜å‚¨ä»‹è´¨æœ¬èº«ã€æ§åˆ¶å™¨ä»¥åŠè½¯ä»¶æ¥å£æ ‡å‡†ã€‚</p><p>å­˜å‚¨ä»‹è´¨å±‚é¢ï¼Œé—ªå­˜ï¼ˆFlashï¼‰æ¯”ä¼ ç»Ÿæœºæ¢°ç¡¬ç›˜é€Ÿåº¦å¿«çš„å¤ªå¤šï¼›</p><p>æ§åˆ¶å™¨æ–¹é¢ï¼Œä» SATA SSD å‘å±•æˆ PCIe SSDï¼ŒåŸç”Ÿ PCIe ä¸»æ§ä¸ CPU ç›´æ¥ç›¸è¿ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿæ–¹å¼ï¼Œé€šè¿‡å—æ¡¥æ§åˆ¶å™¨ä¸­è½¬ï¼Œå†è¿æ¥ CPUï¼Œå› æ­¤åŸºäº PCIe çš„ SSD æ—¶å»¶æ›´ä½ï¼›</p><p>è½¯ä»¶æ¥å£æ–¹é¢ï¼ŒNVMe ç¼©çŸ­äº† CPU åˆ° SSD çš„æŒ‡ä»¤è·¯å¾„ï¼Œæ¯”å¦‚ NVMe å‡å°‘äº†å¯¹å¯„å­˜å™¨çš„è®¿é—®æ¬¡æ•°ï¼›MSI-X å’Œä¸­æ–­ç®¡ç†çš„åº”ç”¨ï¼›å¹¶è¡Œ&amp;å¤šçº¿ç¨‹ä¼˜åŒ–ï¼ŒNVMe å‡å°‘äº†å„ä¸ª CPU æ ¸ä¹‹é—´çš„é”åŒæ­¥æ“ä½œã€‚</p><p>æ‰€ä»¥åŸºäº PCIe+NVMe çš„SSDï¼Œå…·æœ‰éå¸¸ä½çš„å»¶æ—¶ã€‚</p><img src="/images/2015/nvme1.png"><p><strong>é«˜æ€§èƒ½ï¼ˆThroughput &amp; IOPSï¼‰</strong></p><p>ç†è®ºä¸Šï¼ŒIOPS=é˜Ÿåˆ—æ·±åº¦/ IOå»¶è¿Ÿï¼Œæ•… IOPS çš„æ€§èƒ½ï¼Œä¸é˜Ÿåˆ—æ·±åº¦æœ‰è¾ƒå¤§çš„å…³ç³»ï¼ˆä½† IOPS å¹¶ä¸ä¸é˜Ÿåˆ—æ·±åº¦æˆæ­£æ¯”ï¼Œå› ä¸ºå®é™…åº”ç”¨ä¸­ï¼Œéšç€é˜Ÿåˆ—æ·±åº¦çš„å¢å¤§ï¼ŒIO å»¶è¿Ÿä¹Ÿä¼šæé«˜ï¼‰ã€‚å¸‚é¢ä¸Šæ€§èƒ½ä¸é”™çš„ SATA æ¥å£ SSDï¼Œåœ¨é˜Ÿåˆ—æ·±åº¦ä¸Šéƒ½å¯ä»¥è¾¾åˆ°32ï¼Œç„¶è€Œè¿™ä¹Ÿæ˜¯ AHCI æ‰€èƒ½åšåˆ°çš„æé™ã€‚ä½†ç›®å‰é«˜ç«¯çš„ä¼ä¸šçº§ PCIe SSDï¼Œå…¶é˜Ÿåˆ—æ·±åº¦å¯èƒ½è¦è¾¾åˆ°128ï¼Œç”šè‡³æ˜¯256æ‰èƒ½å¤Ÿå‘æŒ¥å‡ºæœ€é«˜çš„ IOPS æ€§èƒ½ã€‚è€Œ NVMe æ ‡å‡†ä¸‹ï¼Œæœ€å¤§çš„é˜Ÿåˆ—æ·±åº¦å¯è¾¾64Kã€‚æ­¤å¤–ï¼ŒNVMe çš„é˜Ÿåˆ—æ•°é‡ä¹Ÿä» AHCI çš„1ï¼Œæé«˜åˆ°äº†64Kã€‚</p><p>PCIe æ¥å£æœ¬èº«åœ¨æ€§èƒ½ä¸Šç¢¾å‹ SATAï¼Œå†åŠ ä¸Š NVMeå…·æœ‰æ¯”AHCI æ›´æ·±ã€æ›´å®½çš„å‘½ä»¤é˜Ÿåˆ—ï¼ŒNVMe SSD åœ¨æ€§èƒ½ä¸Šç§’æ€ SATA SSD æ˜¯æ°´åˆ°æ¸ æˆçš„äº‹æƒ…ã€‚å›¾æ˜¯ NVMe SSDï¼ŒSAS SSDå’ŒSATA SSD æ€§èƒ½å¯¹æ¯”å›¾ï¼š</p><img src="/images/2015/nvme2.png"><p><strong>ä½åŠŸè€—</strong></p><p>NVMeåŠ å…¥äº†è‡ªåŠ¨åŠŸè€—çŠ¶æ€åˆ‡æ¢å’ŒåŠ¨æ€èƒ½è€—ç®¡ç†åŠŸèƒ½</p><h3 id="ç¡¬ç›˜åˆ†ç±»"><a href="#ç¡¬ç›˜åˆ†ç±»" class="headerlink" title="ç¡¬ç›˜åˆ†ç±»"></a>ç¡¬ç›˜åˆ†ç±»</h3><p>ç¡¬ç›˜çš„ç§ç±»æ¯”è¾ƒå¤šï¼Œè‹¥æ˜¯æŒ‰ç…§ç¡¬ç›˜æ¥å£ç±»å‹çš„ä¸åŒæ¥åˆ†ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸º IDE ç¡¬ç›˜ã€SATA ç¡¬ç›˜ã€SCSI ç¡¬ç›˜ã€ç§»åŠ¨ç¡¬ç›˜ã€å›ºæ€ç¡¬ç›˜ã€‚<br> ç¡¬ç›˜æŒ‰ç…§å…¶å·¥ä½œå½¢å¼çš„ä¸åŒå¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯æœºæ¢°ç¡¬ç›˜ï¼Œå¦ä¸€ç§æ˜¯å›ºæ€ç¡¬ç›˜ã€‚æ¯”è¾ƒå¸¸è§çš„æœºæ¢°ç¡¬ç›˜æŒ‰ç…§å…¶æ¥å£å½¢å¼çš„ä¸åŒå¯ä»¥åˆ†ä¸º IDE ç¡¬ç›˜ã€SATA ç¡¬ç›˜ã€SCSI ç¡¬ç›˜ä¸‰ç§ã€‚</p><p><strong>IDE ç¡¬ç›˜</strong></p><img src="/images/2015/disk_10.png"><p>IDEï¼ˆIntegrated Drive Electronicsï¼‰ç¡¬ç›˜æ˜¯æŒ‡é‡‡ç”¨ IDE æ¥å£çš„ç¡¬ç›˜ã€‚å¦‚å›¾ï¼Œä¸º IDE ç¡¬ç›˜ã€‚IDE æ˜¯æ‰€æœ‰ç°å­˜å¹¶è¡Œ ATA æ¥å£è§„æ ¼çš„ç»Ÿç§°ã€‚è¿™ç§ç¡¬ç›˜ç›¸å¯¹æ¥è¯´ä»·æ ¼ä½å»‰ã€å…¼å®¹æ€§å¼ºã€å·¥ä½œç¨³å®šã€å®¹é‡å¤§ã€å™ªéŸ³ä½ï¼Œåº”ç”¨æ¯”è¾ƒå¤šã€‚ä½†æ˜¯ï¼Œè¿™ç§ç¡¬ç›˜é‡‡ç”¨å¹¶è¡Œæ•°æ®ä¼ è¾“æ–¹å¼ï¼Œä¼ è¾“é€Ÿåº¦çš„ä¸æ–­æå‡ä½¿å¾—ä¿¡å·å¹²æ‰°é€æ¸å˜å¼ºï¼Œä¸åˆ©äºæ•°æ®çš„ä¼ è¾“ã€‚</p><p><strong>SATA ç¡¬ç›˜</strong></p><img src="/images/2015/disk_11.png"><p>SATAï¼ˆSerial Advande Technology Attachmentï¼‰ç¡¬ç›˜æ˜¯æŒ‡é‡‡ç”¨ SATA æ¥å£çš„ç¡¬ç›˜ï¼Œå¦‚å›¾ï¼Œä¸º SATA ç¡¬ç›˜ã€‚SATA æ¥å£é‡‡ç”¨ä¸²è¡Œæ•°æ®ä¼ è¾“æ–¹å¼ï¼Œç†è®ºä¸Šä¼ è¾“é€Ÿåº¦æ¯” IDE æ¥å£è¦å¿«å¾ˆå¤šï¼Œè§£å†³äº†IDEç¡¬ç›˜æ•°æ®ä¼ è¾“ä¿¡å·å¹²æ‰°é™åˆ¶ä¼ è¾“é€Ÿç‡çš„é—®é¢˜ï¼Œå¹¶ä¸”é‡‡ç”¨è¯¥æ¥å£çš„ç¡¬ç›˜æ”¯æŒçƒ­æ’æ‹”ï¼Œæ‰§è¡Œç‡ä¹Ÿå¾ˆé«˜ã€‚</p><p><strong>SCSI ç¡¬ç›˜</strong></p><img src="/images/2015/disk_12.png"><p>SCSIï¼ˆSmall Computer System Interfaceï¼‰ç¡¬ç›˜å°±æ˜¯é‡‡ç”¨SCSIæ¥å£çš„ç¡¬ç›˜ï¼Œé‡‡ç”¨è¿™ç§æ¥å£çš„ç¡¬ç›˜ä¸»è¦ç”¨äºæœåŠ¡å™¨ï¼Œå¦‚å›¾ä¸ºSCISç¡¬ç›˜ã€‚è¿™ç§æ¥å£å…±æœ‰50é’ˆï¼Œå¤–è§‚å’Œæ™®é€šç¡¬ç›˜æ¥å£æœ‰äº›ç›¸ä¼¼ã€‚SCSIç¡¬ç›˜å’Œæ™®é€šIDEç¡¬ç›˜ç›¸æ¯”æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼šæ¥å£é€Ÿåº¦å¿«ï¼Œå¹¶ä¸”ç”±äºä¸»è¦ç”¨äºæœåŠ¡å™¨ï¼Œå› æ­¤ç¡¬ç›˜æœ¬èº«çš„æ€§èƒ½ä¹Ÿæ¯”è¾ƒé«˜ï¼Œç¡¬ç›˜è½¬é€Ÿå¿«ï¼Œç¼“å­˜å®¹é‡å¤§ï¼ŒCPUå ç”¨ç‡ä½ï¼Œæ‰©å±•æ€§è¿œä¼˜äºIDEç¡¬ç›˜ï¼Œå¹¶ä¸”åŒæ ·æ”¯æŒçƒ­æ’æ‹”ã€‚</p><p><strong>å›ºæ€ç¡¬ç›˜</strong></p><p>å›ºæ€ç¡¬ç›˜ï¼ˆSolid State Diskï¼‰ç”¨å›ºæ€ç”µå­å­˜å‚¨èŠ¯ç‰‡åˆ—é˜µè€Œåˆ¶æˆçš„ç¡¬ç›˜ï¼Œå¦‚å›¾ï¼Œæ‰€ç¤ºä¸ºå›ºæ€ç¡¬ç›˜ï¼Œå®ƒä¸»è¦ç”±æ§åˆ¶å•å…ƒå’Œå­˜å‚¨å•å…ƒï¼ˆFLASHèŠ¯ç‰‡ï¼‰ç»„æˆã€‚å›ºæ€ç¡¬ç›˜çš„æ¥å£è§„èŒƒå’Œå®šä¹‰ã€åŠŸèƒ½åŠä½¿ç”¨æ–¹æ³•ä¸Šä¸æ™®é€šç¡¬ç›˜çš„å®Œå…¨ç›¸åŒï¼Œåœ¨äº§å“å¤–å½¢å’Œå°ºå¯¸ä¸Šä¸æ™®é€šç¡¬ç›˜å‡ ä¹ä¸€è‡´ã€‚å›ºæ€ç¡¬ç›˜çš„å­˜å‚¨ä»‹è´¨åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯é‡‡ç”¨é—ªå­˜ï¼ˆFLASHèŠ¯ç‰‡ï¼‰ä½œä¸ºå­˜å‚¨ä»‹è´¨ï¼Œå¦å¤–ä¸€ç§æ˜¯é‡‡ç”¨DRAMä½œä¸ºå­˜å‚¨ä»‹è´¨ã€‚</p><h3 id="SSD-ä¸-HDD-æ¯”è¾ƒ"><a href="#SSD-ä¸-HDD-æ¯”è¾ƒ" class="headerlink" title="SSD ä¸ HDD æ¯”è¾ƒ"></a>SSD ä¸ HDD æ¯”è¾ƒ</h3><table><thead><tr><th></th><th align="center">SSD</th><th align="center">HDD</th></tr></thead><tbody><tr><td>å¯åŠ¨æ—¶é—´</td><td align="center">ç”±äºæ²¡æœ‰é©¬è¾¾å’Œè½¬è‡‚ï¼Œæ‰€ä»¥å‡ ä¹å¯ä»¥ç¬é—´å®Œæˆã€‚<br>åŒæ—¶ä»ä¼‘çœ æ¨¡å¼ä¸­å”¤é†’ä¹Ÿå¤§çº¦åªéœ€è¦å‡ æ¯«ç§’å³å¯ã€‚</td><td align="center">å¯èƒ½éœ€è¦æ•°ç§’ä»¥å¯åŠ¨é©¬è¾¾ã€‚è€Œä¸”å½“ç£ç›˜é‡éå¸¸å¤§çš„æ—¶å€™ï¼Œéœ€è¦ä¾æ¬¡å¯åŠ¨ä»¥é˜²æ­¢ç¬é—´ç”µæµè¿‡è½½ã€‚</td></tr><tr><td>éšæœºè®¿é—®æ—¶é—´</td><td align="center">å¤§çº¦ä»…éœ€0.1æ¯«ç§’ï¼Œå› ä¸ºæ— éœ€å¯»é“ã€‚</td><td align="center">å¤§çº¦éœ€è¦5â€“10æ¯«ç§’ã€‚</td></tr><tr><td>è¯»å–æ½œä¼æœŸ</td><td align="center">é€šå¸¸å¾ˆçŸ­ï¼Œå› ä¸ºç›´æ¥è¯»å–ã€‚</td><td align="center">é€šå¸¸æ¯”è¾ƒé«˜ï¼Œå› ä¸ºç£å¤´éœ€è¦é¢å¤–çš„æ—¶é—´ç­‰å¾…æ‰‡åŒºçš„åˆ°æ¥ã€‚</td></tr><tr><td>è¯»å–æ€§èƒ½ä¸€è‡´æ€§</td><td align="center">è¯»å–æ€§èƒ½ä¸å› æ•°æ®åœ¨SSDä¸Šçš„å­˜å‚¨ä½ç½®ä¸åŒè€Œä¸åŒã€‚</td><td align="center">è¯»å–æ€§èƒ½ä¸å­˜æ”¾åœ¨ç£ç›˜çš„å†…åœˆè¿˜æ˜¯å¤–åœˆæœ‰å…³ï¼Œä¹Ÿä¸æ–‡ä»¶çš„ç¢ç‰‡ç¨‹åº¦æœ‰å…³ã€‚</td></tr><tr><td>ç¢ç‰‡æ•´ç†</td><td align="center">SSDåŸºæœ¬ä¸éœ€è¦è¿›è¡Œç¢ç‰‡æ•´ç†ï¼Œå› ä¸ºè¯»å–è¿ç»­çš„æ•°æ®å¹¶ä¸æ˜æ˜¾æ¯”è¯»å–åˆ†æ•£çš„æ•°æ®å¿«ã€‚<br>å¹¶ä¸”ç¢ç‰‡æ•´ç†ä¼šé¢å¤–å¢åŠ NANDé—ªå­˜çš„å†™å…¥æ¬¡æ•°ï¼Œä»è€Œé™ä½å…¶å¯¿å‘½ã€‚</td><td align="center">HDDé€šå¸¸éœ€è¦åœ¨æ–‡ä»¶ç¢ç‰‡è¾¾åˆ°ä¸€å®šç¨‹åº¦åè¿›è¡Œæ•´ç†ï¼Œå¦åˆ™æ€§èƒ½ä¼šæœ‰æ˜æ˜¾ä¸‹é™ã€‚ç‰¹åˆ«æ˜¯åœ¨å«æœ‰å¤§é‡æ–‡ä»¶çš„æƒ…å†µä¸‹æ›´æ˜¯å¦‚æ­¤ã€‚</td></tr><tr><td>å™ªéŸ³</td><td align="center">SSDæ— ä»»ä½•å™ªéŸ³</td><td align="center">HDDæœ‰æ˜æ˜¾çš„å™ªéŸ³ï¼Œå¹¶ä¸”åœ¨è¯»å†™é¢‘ç¹çš„æ—¶å€™å™ªéŸ³æ›´å¤§ã€‚</td></tr><tr><td>æœºæ¢°å¯é æ€§</td><td align="center">æ— æœºæ¢°æ•…éšœ</td><td align="center">éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæœºæ¢°æ•…éšœæ¦‚ç‡ä¼šé€æ¸å¢åŠ ã€‚</td></tr><tr><td>ç¯å¢ƒæ•æ„Ÿæ€§</td><td align="center">å¯¹éœ‡åŠ¨ã€ç£åœºã€ç¢°æ’ä¸æ•æ„Ÿ</td><td align="center">å¯¹éœ‡åŠ¨ã€ç£åœºã€ç¢°æ’æ•æ„Ÿ</td></tr><tr><td>ä½“ç§¯å’Œé‡é‡</td><td align="center">ä½“ç§¯å°ã€é‡é‡è½»</td><td align="center">æ€§èƒ½è¶Šé«˜ï¼Œä½“ç§¯å’Œé‡é‡è¶Šå¤§</td></tr><tr><td>å¹¶è¡Œæ“ä½œ</td><td align="center">å¤šæ•°æ§åˆ¶å™¨å¯ä»¥ä½¿ç”¨å¤šä¸ªèŠ¯ç‰‡è¿›è¡Œå¹¶å‘è¯»å†™</td><td align="center">HDDè™½ç„¶æœ‰å¤šä¸ªç£å¤´ï¼Œä½†æ˜¯ç”±äºå…±äº«åŒä¸€ä¸ªä½ç½®æ§åˆ¶ç”µæœºï¼Œæ‰€ä»¥ä¸èƒ½å¹¶å‘è¯»å†™ã€‚</td></tr><tr><td>å†™å…¥å¯¿å‘½</td><td align="center">åŸºäºé—ªå­˜çš„SSDæœ‰å†™å…¥å¯¿å‘½é™åˆ¶ï¼Œä¸”ä¸€æ—¦æŸåï¼Œæ•´ä¸ªSSDçš„æ•°æ®éƒ½å°†ä¸¢å¤±ã€‚</td><td align="center">æ— å†™å…¥å¯¿å‘½é™åˆ¶</td></tr><tr><td>æ•°æ®å®‰å…¨é—®é¢˜</td><td align="center">NANDé—ªå­˜çš„å­˜å‚¨å—ä¸èƒ½è¢«ç›´æ¥è¦†ç›–é‡å†™ï¼Œåªèƒ½é‡æ–°å†™å…¥å…ˆå‰è¢«æ“¦é™¤çš„å—ä¸­ã€‚<br>å¦‚æœä¸€ä¸ªè½¯ä»¶åŠ å¯†ç¨‹åºå¯¹å·²ç»å­˜åœ¨äºSSDä¸Šçš„æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œé‚£äº›åŸå§‹çš„ã€çœ‹ä¸Šå»å·²ç»è¢«è¦†ç›–æ‰çš„åŸå§‹æ•°æ®å®é™…ä¸Šå¹¶æ²¡æœ‰è¢«è¦†ç›–ï¼Œå®ƒä»¬ä¾ç„¶å¯ä»¥è¢«è¯»å–ï¼Œä»è€Œé€ æˆä¿¡æ¯æ³„æ¼ã€‚<br>ä½†æ˜¯SSDè‡ªèº«åŸºäºç¡¬ä»¶çš„åŠ å¯†è£…ç½®æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚<br>æ­¤å¤–ï¼Œä¹Ÿä¸èƒ½ç®€å•çš„é€šè¿‡è¦†ç›–åŸæ–‡ä»¶çš„åŠæ³•æ¥æ¸…é™¤åŸæœ‰çš„æ•°æ®ï¼Œé™¤éè¯¥SSDæœ‰å†…å»ºçš„å®‰å…¨åˆ é™¤æœºåˆ¶ï¼Œå¹¶ä¸”ç¡®å®å·²ç»è¢«å¯ç”¨ã€‚</td><td align="center">HDDå¯ä»¥ç›´æ¥è¦†ç›–æ‰æŒ‡å®šçš„æ‰‡åŒºï¼Œå› è€Œä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚</td></tr><tr><td>å•ä½å®¹é‡æˆæœ¬</td><td align="center">è´µã€‚ä½†æ˜¯å¤§çº¦æ¯ä¸¤å¹´ä¸‹é™ä¸€åŠã€‚</td><td align="center">ä¾¿å®œ</td></tr><tr><td>æœ€å¤§å­˜å‚¨å®¹é‡</td><td align="center">å°ã€‚ä½†æ˜¯å¤§çº¦æ¯ä¸¤å¹´å¯ç¿»ä¸€å€ã€‚</td><td align="center">å¤§</td></tr><tr><td>è¯»/å†™æ€§èƒ½å¯¹ç§°</td><td align="center">ä½ç«¯SSDçš„è¯»å–é€Ÿåº¦è¿œé«˜äºå†™å…¥é€Ÿåº¦ï¼Œä½†æ˜¯é«˜ç«¯äº§å“çš„è¯»å†™é€Ÿåº¦å¯ä»¥åšåˆ°ä¸€è‡´ã€‚</td><td align="center">HDDçš„è¯»å–é€Ÿåº¦é€šå¸¸æ¯”å†™å…¥é€Ÿåº¦å¿«ä¸€äº›ï¼Œä½†æ˜¯å·®è·å¹¶ä¸å¾ˆå¤§ã€‚</td></tr><tr><td>TRIMä¸å¯ç”¨ç©ºç™½å—</td><td align="center">SSDçš„å†™å…¥æ€§èƒ½å—å¯ç”¨ç©ºç™½å—æ•°é‡å½±å“å¾ˆå¤§ã€‚<br>å…ˆå‰æ›¾ç»å†™å…¥è¿‡æ•°æ®ä¸”ç°åœ¨æœªè¢«ä½¿ç”¨çš„å—ï¼Œå¯ä»¥é€šè¿‡TRIMæ¥å›æ”¶ï¼Œä½¿å…¶æˆä¸ºå¯ç”¨çš„ç©ºç™½å—ã€‚<br>ä½†æ˜¯å³ä½¿ç»è¿‡TRIMå›æ”¶çš„å—ï¼Œå…¶æ€§èƒ½ä¾ç„¶ä¼šå‡ºç°ä¸‹é™ã€‚</td><td align="center">HDDå®Œå…¨æ²¡æœ‰è¿™äº›é—®é¢˜ï¼Œå…¶æ€§èƒ½ä¸ä¼šå› ä¸ºå¤šæ¬¡è¯»å†™è€Œå‡ºç°ä¸‹é™ï¼Œä¹Ÿä¸éœ€è¦è¿›è¡ŒTRIMæ“ä½œã€‚</td></tr><tr><td>èƒ½è€—</td><td align="center">å³ä½¿æ˜¯é«˜æ€§èƒ½çš„SSDé€šå¸¸å…¶èƒ½è€—ä¹Ÿåªæœ‰HDDçš„1/2åˆ°1/3ã€‚</td><td align="center">é«˜æ€§èƒ½HDDé€šå¸¸éœ€è¦å¤§çº¦12-18ç“¦ï¼Œè€Œä¸ºç¬”è®°æœ¬è®¾è®¡çš„èŠ‚èƒ½HDDçš„åŠŸè€—é€šå¸¸åœ¨2-3ç“¦ã€‚</td></tr></tbody></table><h3 id="HDDï¼ˆHard-Disk-Driveï¼‰"><a href="#HDDï¼ˆHard-Disk-Driveï¼‰" class="headerlink" title="HDDï¼ˆHard Disk Driveï¼‰"></a>HDDï¼ˆHard Disk Driveï¼‰</h3><p>ç¡¬ç›˜é©±åŠ¨å™¨æ˜¯ä¸€ç§è¾ƒæ—§çš„æŠ€æœ¯ï¼Œæœ€åˆç”±IBMåœ¨60å¤šå¹´å‰æ¨å‡ºã€‚å®ƒæ˜¯ç¡¬ç›˜é©±åŠ¨å™¨çš„ç®€ç§°å½¢å¼ï¼Œå¹¶ä½¿ç”¨ç£åŠ›è¿›è¡Œæ•°æ®å­˜å‚¨ã€‚HDDå…·æœ‰é«˜é€Ÿæ—‹è½¬çš„æ—‹è½¬ç£ç›˜ï¼ŒåŒæ—¶å…¶ä¸Šæ–¹å…·æœ‰è¯»/å†™å¤´ï¼Œå…¶åœ¨æ—‹è½¬ç£ç›˜ä¸Šè¯»å–å’Œå†™å…¥æ•°æ®ã€‚HDD çš„æ€§èƒ½å–å†³äºç£ç›˜çš„æ—‹è½¬é€Ÿåº¦ã€‚ç›®å‰ä½¿ç”¨çš„ HDD é©±åŠ¨å™¨çš„é€šå¸¸è½¬é€ŸèŒƒå›´åœ¨5,400 RPMï¼ˆRPMï¼‰åˆ°7,200 RPMï¼ˆRPMï¼‰ä¹‹é—´ã€‚åŸºäºæœåŠ¡å™¨çš„ç£ç›˜å¯ä»¥å®ç°é«˜è¾¾15,000 rpmï¼ˆRPMï¼‰çš„æ—‹è½¬é€Ÿåº¦ã€‚</p><p>æˆ‘ä»¬åˆ†åˆ«ä»ç¡¬ç›˜çš„ç‰©ç†ç»“æ„å’Œé€»è¾‘ç»“æ„åˆ†æã€‚</p><h4 id="ç‰©ç†ç»“æ„"><a href="#ç‰©ç†ç»“æ„" class="headerlink" title="ç‰©ç†ç»“æ„"></a>ç‰©ç†ç»“æ„</h4><p>ç¡¬ç›˜çš„ç‰©ç†ç»“æ„å¯åˆ†ä¸ºå¤–éƒ¨ç»“æ„å’Œå†…éƒ¨ç»“æ„ã€‚</p><h5 id="å¤–éƒ¨ç»“æ„"><a href="#å¤–éƒ¨ç»“æ„" class="headerlink" title="å¤–éƒ¨ç»“æ„"></a>å¤–éƒ¨ç»“æ„</h5><p>ç¡¬ç›˜çš„å¤–éƒ¨ç»“æ„ä¸»è¦åŒ…æ‹¬é‡‘å±å›ºå®šé¢æ¿ã€æ§åˆ¶ç”µè·¯æ¿å’Œæ¥å£ä¸‰éƒ¨åˆ†ã€‚</p><p><strong>é‡‘å±å›ºå®šé¢æ¿</strong><br>ç¡¬ç›˜å¤–éƒ¨ä¼šæœ‰ä¸€ä¸ªé‡‘å±çš„é¢æ¿ï¼Œç”¨äºä¿æŠ¤æ•´ä¸ªç¡¬ç›˜ã€‚<br>é‡‘å±é¢æ¿å’Œåœ°æ¿ç»“åˆæˆä¸€ä¸ªå¯†å°çš„æ•´ä½“ï¼Œä¿è¯ç¡¬ç›˜ç›˜ä½“å’Œæœºæ„çš„ç¨³å®šè¿è¡Œã€‚</p><img src="/images/2015/disk_1.png"><p><strong>æ§åˆ¶ç”µè·¯æ¿</strong></p><p>æ§åˆ¶ç”µè·¯æ¿ä¸Šçš„ç”µå­å…ƒå™¨ä»¶å¤§å¤šé‡‡ç”¨è´´ç‰‡å¼å…ƒä»¶ç„Šæ¥ï¼Œè¿™äº›ç”µå­å…ƒå™¨ä»¶ç»„æˆäº†åŠŸèƒ½ä¸åŒçš„ç”µå­ç”µè·¯ï¼Œè¿™äº›ç”µè·¯åŒ…æ‹¬ä¸»è½´è°ƒé€Ÿç”µè·¯ã€ç£å¤´é©±åŠ¨ä¸ä¼ºæœå®šä½ç”µè·¯ã€è¯»å†™ç”µè·¯ã€æ§åˆ¶ä¸æ¥å£ç”µè·¯ç­‰ã€‚åœ¨ç”µè·¯æ¿ä¸Šæœ‰å‡ ä¸ªä¸»è¦çš„èŠ¯ç‰‡ï¼šä¸»æ§èŠ¯ç‰‡ã€BIOSèŠ¯ç‰‡ã€ç¼“å­˜èŠ¯ç‰‡ã€ç”µæœºé©±åŠ¨èŠ¯ç‰‡ã€‚</p><img src="/images/2015/disk_2.png"><p><strong>æ¥å£</strong></p><p>åœ¨ç¡¬ç›˜çš„é¡¶ç«¯ä¼šæœ‰å‡ ä¸ªä¸åŒçš„ç¡¬ç›˜æ¥å£ï¼Œè¿™äº›æ¥å£ä¸»è¦åŒ…æ‹¬ç”µæºæ’åº§æ¥å£ã€æ•°æ®æ¥å£å’Œä¸»ã€ä»è·³çº¿æ¥å£ï¼Œå…¶ä¸­ç”µæºæ’å£ä¸ä¸»æœºç”µæºç›¸è”ï¼Œä¸ºç¡¬ç›˜å·¥ä½œæä¾›ç”µåŠ›ä¿è¯ã€‚ä¸­é—´çš„ä¸»ã€ä»ç›˜è·³çº¿æ¥å£ï¼Œç”¨ä»¥è®¾ç½®ä¸»ã€ä»ç¡¬ç›˜ï¼Œå³è®¾ç½®ç¡¬ç›˜é©±åŠ¨å™¨çš„è®¿é—®é¡ºåºã€‚</p><img src="/images/2015/disk_3.png"><h5 id="å†…éƒ¨ç»“æ„"><a href="#å†…éƒ¨ç»“æ„" class="headerlink" title="å†…éƒ¨ç»“æ„"></a>å†…éƒ¨ç»“æ„</h5><p>ç¡¬ç›˜å†…éƒ¨ä¸»è¦åŒ…æ‹¬ç£å¤´ç»„ä»¶ã€ç£å¤´é©±åŠ¨ç»„ä»¶ã€ç›˜ä½“ã€ä¸»è½´ç»„ä»¶ã€å‰ç½®æ§åˆ¶ç”µè·¯ç­‰ã€‚</p><img src="/images/2015/disk_4.png"><p><strong>ç£å¤´ç»„ä»¶</strong><br>ç£å¤´ç»„ä»¶åŒ…æ‹¬è¯»å†™ç£å¤´ã€ä¼ åŠ¨æ‰‹è‡‚ã€ä¼ åŠ¨è½´ä¸‰éƒ¨åˆ†ç»„æˆã€‚</p><img src="/images/2015/disk_5.png"><p>ç£å¤´ç»„ä»¶ä¸­æœ€ä¸»è¦çš„éƒ¨åˆ†æ˜¯ç£å¤´ï¼Œå¦å¤–çš„ä¸¤ä¸ªéƒ¨åˆ†å¯ä»¥çœ‹ä½œæ˜¯ç£å¤´çš„è¾…åŠ©è£…ç½®ã€‚ä¼ åŠ¨è½´å¸¦åŠ¨ä¼ åŠ¨è‡‚ï¼Œä½¿ç£å¤´åˆ°è¾¾æŒ‡å®šçš„ä½ç½®ã€‚<br>ç£å¤´æ˜¯ç¡¬ç›˜ä¸­å¯¹ç›˜ç‰‡è¿›è¡Œè¯»å†™å·¥ä½œçš„å·¥å…·ï¼Œæ˜¯ç¡¬ç›˜ä¸­æœ€ç²¾å¯†çš„éƒ¨ä½ä¹‹ä¸€ã€‚ç£å¤´æ˜¯ç”¨çº¿åœˆç¼ ç»•åœ¨ç£èŠ¯ä¸Šåˆ¶æˆçš„ï¼Œå·¥ä½œåŸç†åˆ™æ˜¯åˆ©ç”¨ç‰¹æ®Šææ–™çš„ç”µé˜»å€¼ä¼šéšç€ç£åœºå˜åŒ–çš„åŸç†æ¥è¯»å†™ç›˜ç‰‡ä¸Šçš„æ•°æ®ã€‚ç¡¬ç›˜åœ¨å·¥ä½œæ—¶ï¼Œç£å¤´é€šè¿‡æ„Ÿåº”æ—‹è½¬çš„ç›˜ç‰‡ä¸Šç£åœºçš„å˜åŒ–æ¥è¯»å–æ•°æ®ï¼›é€šè¿‡æ”¹å˜ç›˜ç‰‡ä¸Šçš„ç£åœºæ¥å†™å…¥æ•°æ®ã€‚ä¸ºé¿å…ç£å¤´å’Œç›˜ç‰‡çš„ç£¨æŸï¼Œåœ¨å·¥ä½œçŠ¶æ€æ—¶ï¼Œç£å¤´æ‚¬æµ®åœ¨é«˜é€Ÿè½¬åŠ¨çš„ç›˜ç‰‡ä¸Šæ–¹ï¼Œé—´éš™åªæœ‰0.1~0.3umï¼Œè€Œä¸æ˜¯ç›˜ç‰‡ç›´æ¥æ¥è§¦ï¼Œåœ¨ç”µæºå…³é—­ä¹‹åï¼Œç£å¤´ä¼šè‡ªåŠ¨å›åˆ°åœ¨ç›˜ç‰‡ä¸Šç€é™†åŒºï¼Œæ­¤å¤„ç›˜ç‰‡å¹¶ä¸å­˜å‚¨æ•°æ®ï¼Œæ˜¯ç›˜ç‰‡çš„èµ·å§‹ä½ç½®ã€‚</p><p><strong>ç£å¤´é©±åŠ¨ç»„ä»¶</strong></p><p>ç£å¤´çš„ç§»åŠ¨æ˜¯é ç£å¤´é©±åŠ¨ç»„ä»¶å®ç°çš„ï¼Œç¡¬ç›˜å¯»é“æ—¶é—´çš„é•¿çŸ­ä¸ç£å¤´é©±åŠ¨ç»„ä»¶å…³ç³»éå¸¸å¯†åˆ‡ã€‚ç£å¤´çš„é©±åŠ¨æœºæ„ç”±ç”µç£çº¿åœˆç”µæœºã€ç£å¤´é©±åŠ¨å°è½¦ã€é˜²éœ‡åŠ¨è£…ç½®æ„æˆï¼Œé«˜ç²¾åº¦çš„è½»å‹ç£å¤´é©±åŠ¨æœºæ„èƒ½å¤Ÿå¯¹ç£å¤´è¿›è¡Œæ­£ç¡®çš„é©±åŠ¨å’Œå®šä½ï¼Œå¹¶èƒ½åœ¨å¾ˆçŸ­æ—¶é—´å†…ç²¾ç¡®å®šä½ç³»ç»ŸæŒ‡ä»¤æŒ‡å®šçš„ç£é“ï¼Œä¿è¯æ•°æ®è¯»å†™çš„å¯é æ€§ã€‚ç”µç£çº¿åœˆç”µæœºåŒ…å«ç€ä¸€å—æ°¸ä¹…ç£é“ï¼Œè¯¥ç£é“çš„ç£åŠ›å¾ˆå¼ºï¼Œå¯¹äºä¼ åŠ¨æ‰‹è‡‚çš„è¿åŠ¨èµ·ç€å…³é”®æ€§çš„ä½œç”¨ã€‚é˜²éœ‡è£…ç½®æ˜¯ä¸ºäº†é¿å…ç£å¤´å°†ç›˜ç‰‡åˆ®ä¼¤ç­‰æƒ…å†µçš„å‘ç”Ÿè€Œè®¾è®¡çš„ã€‚</p><p><strong>ç›˜ç‰‡ä¸ä¸»è½´ç»„ä»¶</strong></p><p>ç›˜ç‰‡æ˜¯ç¡¬ç›˜å­˜å‚¨æ•°æ®çš„è½½ä½“ï¼Œç›˜ç‰‡æ˜¯åœ¨é“åˆé‡‘æˆ–ç»ç’ƒåŸºåº•ä¸Šæ¶‚è¦†å¾ˆè–„çš„ç£æ€§ææ–™ã€ä¿æŠ¤ææ–™å’Œæ¶¦æ»‘ææ–™ç­‰å¤šç§ä¸åŒä½œç”¨çš„ææ–™å±‚åŠ å·¥è€Œæˆï¼Œå…¶ä¸­ç£æ€§ææ–™çš„ç‰©ç†æ€§èƒ½å’Œç£å±‚æœºæ„ç›´æ¥å½±å“ç€æ•°æ®çš„å­˜å‚¨å¯†åº¦å’Œæ‰€å­˜å‚¨æ•°æ®çš„ç¨³å®šæ€§ã€‚é‡‘å±ç›˜ç‰‡å…·æœ‰å¾ˆé«˜çš„å­˜å‚¨å¯†åº¦ã€é«˜å‰©ç£åŠé«˜å¨‡é¡½åŠ›ï¼›ç»ç’ƒç›˜ç‰‡æ¯”æ™®é€šé‡‘å±ç›˜ç‰‡åœ¨è¿è¡Œæ—¶å…·æœ‰æ›´å¥½çš„ç¨³å®šæ€§ã€‚<br>ä¸»è½´ç»„ä»¶åŒ…æ‹¬ä¸»è½´éƒ¨ä»¶è½´ç“¦å’Œé©±åŠ¨ç”µæœºç­‰ã€‚éšç€ç¡¬ç›˜å®¹é‡çš„æ‰©å¤§å’Œé€Ÿåº¦çš„æé«˜ï¼Œä¸»è½´ç”µæœºçš„é€Ÿåº¦ä¹Ÿåœ¨ä¸æ–­æå‡ï¼Œæœ‰å‚å•†å¼€å§‹é‡‡ç”¨ç²¾å¯†æœºæ¢°å·¥ä¸šçš„æ¶²æ€è½´æ‰¿æœºç”µæŠ€æœ¯ï¼Œè¿™ç§æŠ€æœ¯çš„åº”ç”¨æœ‰æ•ˆåœ°é™ä½äº†ç¡¬ç›˜å·¥ä½œå™ªéŸ³ã€‚</p><p><strong>å‰ç½®æ§åˆ¶ç”µè·¯</strong></p><p>å‰ç½®æ”¾å¤§ç”µè·¯æ§åˆ¶ç£å¤´æ„Ÿåº”çš„ä¿¡å·ã€ä¸»è½´ç”µæœºè°ƒé€Ÿã€ç£å¤´é©±åŠ¨å’Œä¼ºæœå®šä½ç­‰ï¼Œç”±äºç£å¤´è¯»å–çš„ä¿¡å·å¾®å¼±ï¼Œå°†æ”¾å¤§ç”µè·¯å¯†å°åœ¨è…”ä½“å†…å¯å‡å°‘å¤–æ¥ä¿¡å·çš„å¹²æ‰°ï¼Œæé«˜æ“ä½œæŒ‡ä»¤çš„å‡†ç¡®æ€§ã€‚</p><h4 id="é€»è¾‘ç»“æ„"><a href="#é€»è¾‘ç»“æ„" class="headerlink" title="é€»è¾‘ç»“æ„"></a>é€»è¾‘ç»“æ„</h4><p>æ–°ç¡¬ç›˜æ˜¯ä¸èƒ½ç›´æ¥ä½¿ç”¨çš„ï¼Œå¿…é¡»å¯¹å®ƒè¿›è¡Œåˆ†åŒºè¿›è¡Œæ ¼å¼åŒ–æ‰èƒ½å­˜å‚¨æ•°æ®ã€‚ç»è¿‡æ ¼å¼åŒ–åˆ†åŒºåï¼Œé€»è¾‘ä¸Šæ¯ä¸ªç›˜ç‰‡çš„æ¯ä¸€é¢éƒ½ä¼šè¢«åˆ†ä¸ºç£é“ã€æ‰‡åŒºã€æŸ±é¢è¿™å‡ ä¸ªè™šæ‹Ÿçš„æ¦‚å¿µã€‚å¦‚å›¾æ‰€ç¤ºä¸ºç¡¬ç›˜åˆ’åˆ†çš„é€»è¾‘ç»“æ„å›¾ã€‚å¦å¤–ï¼Œä¸åŒçš„ç¡¬ç›˜ä¸­ç›˜ç‰‡æ•°ä¸åŒï¼Œä¸€ä¸ªç›˜ç‰‡æœ‰ä¸¤é¢ï¼Œè¿™ä¸¤é¢éƒ½èƒ½å­˜å‚¨æ•°æ®ï¼Œæ¯ä¸€é¢éƒ½ä¼šå¯¹åº”ä¸€ä¸ªç£å¤´ï¼Œä¹ æƒ¯ä¸Šå°†ç›˜é¢æ•°è®¡ä¸ºç£å¤´æ•°ï¼Œç”¨æ¥è®¡ç®—ç¡¬ç›˜å®¹é‡ã€‚</p><p>æ‰‡åŒºã€ç£é“ï¼ˆæˆ–æŸ±é¢ï¼‰å’Œç£å¤´æ•°æ„æˆäº†ç¡¬ç›˜ç»“æ„çš„åŸºæœ¬å‚æ•°ï¼Œç”¨è¿™äº›å‚æ•°è®¡ç®—ç¡¬ç›˜çš„å®¹é‡ï¼Œå…¶è®¡ç®—å…¬å¼ä¸ºï¼š</p><blockquote><p>å­˜å‚¨å®¹é‡ = ç£å¤´æ•° * ç£é“ï¼ˆæŸ±é¢ï¼‰æ•° * æ¯é“æ‰‡åŒºæ•° * æ¯æ‰‡åŒºå­—èŠ‚æ•°</p></blockquote><img src="/images/2015/disk_6.png"><p>æŸ¥çœ‹ ubuntu ç£ç›˜ä¿¡æ¯ </p><pre class=" language-shell"><code class="language-shell">sudo fdisk -l /dev/mapper/ubuntu--vg-root</code></pre><img src="/images/2015/disk_13.png"><h5 id="ç£é“"><a href="#ç£é“" class="headerlink" title="ç£é“"></a>ç£é“</h5><img src="/images/2015/disk_7.png"><p>å½“ç£ç›˜æ—‹è½¬æ—¶ï¼Œç£å¤´è‹¥ä¿æŒåœ¨ä¸€ä¸ªä½ç½®ä¸Šï¼Œåˆ™æ¯ä¸ªç£å¤´éƒ½ä¼šåœ¨ç£ç›˜è¡¨é¢åˆ’å‡ºä¸€ä¸ªåœ†å½¢è½¨è¿¹ï¼Œè¿™äº›åœ†å½¢è½¨è¿¹å°±å«ç£é“ã€‚ç£é“ä¸Šçš„ç£é“æ˜¯ä¸€ç»„è®°å½•å¯†åº¦ä¸åŒçš„åŒå¿ƒåœ†ï¼Œå¦‚å›¾ã€‚ç£è¡¨é¢å­˜å‚¨å™¨æ˜¯åœ¨ä¸åŒå½¢çŠ¶ï¼ˆå¦‚ç›˜çŠ¶ã€å¸¦çŠ¶ç­‰ï¼‰çš„è½½ä½“ä¸Šï¼Œæ¶‚æœ‰ç£æ€§ææ–™å±‚ï¼Œå·¥ä½œæ—¶ï¼Œé è½½ç£ä½“é«˜é€Ÿè¿åŠ¨ï¼Œç”±ç£å¤´åœ¨ç£å±‚ä¸Šè¿›è¡Œè¯»å†™æ“ä½œï¼Œä¿¡æ¯è¢«è®°å½•åœ¨ç£å±‚ä¸Šï¼Œè¿™äº›ä¿¡æ¯çš„è½¨è¿¹å°±æ˜¯ç£é“ã€‚è¿™äº›ç£é“ç”¨è‚‰çœ¼æ˜¯æ ¹æœ¬çœ‹ä¸åˆ°çš„ï¼Œå› ä¸ºä»–ä»¬ä»…æ˜¯ç›˜é¢ä¸Šä»¥ç‰¹æ®Šæ–¹å¼ç£åŒ–äº†çš„ä¸€äº›ç£åŒ–åŒºï¼Œç£ç›˜ä¸Šçš„ä¿¡æ¯ä¾¿æ˜¯æ²¿ç€è¿™æ ·çš„è½¨é“å­˜æ”¾çš„ã€‚ç›¸é‚»ç£é“ä¹‹é—´å¹¶ä¸æ˜¯ç´§æŒ¨ç€çš„ï¼Œè¿™æ˜¯å› ä¸ºç£åŒ–å•å…ƒç›¸éš”å¤ªè¿‘æ—¶ç£æ€§ä¼šäº§ç”Ÿç›¸äº’å½±å“ï¼ŒåŒæ—¶ä¹Ÿä¸ºç£å¤´çš„è¯»å†™å¸¦æ¥å›°éš¾ï¼Œé€šå¸¸ç›˜ç‰‡çš„ä¸€é¢æœ‰æˆåƒä¸Šä¸‡ä¸ªç£é“ã€‚</p><h5 id="æ‰‡åŒº"><a href="#æ‰‡åŒº" class="headerlink" title="æ‰‡åŒº"></a>æ‰‡åŒº</h5><img src="/images/2015/disk_8.png" width="400px"><p>åˆ†åŒºæ ¼å¼åŒ–ç£ç›˜æ—¶ï¼Œæ¯ä¸ªç›˜ç‰‡çš„æ¯ä¸€é¢éƒ½ä¼šåˆ’åˆ†å¾ˆå¤šåŒå¿ƒåœ†çš„ç£é“ï¼Œè€Œä¸”è¿˜ä¼šå°†æ¯ä¸ªåŒå¿ƒåœ†è¿›ä¸€æ­¥çš„åˆ†å‰²ä¸ºå¤šä¸ªç›¸ç­‰çš„åœ†å¼§ï¼Œè¿™äº›åœ†å¼§å°±æ˜¯æ‰‡åŒºã€‚ä¸ºä»€ä¹ˆè¦è¿›è¡Œæ‰‡åŒºçš„åˆ’åˆ†å‘¢ï¼Ÿå› ä¸ºï¼Œè¯»å–å’Œå†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œç£ç›˜ä¼šä»¥æ‰‡åŒºä¸ºå•ä½è¿›è¡Œè¯»å–å’Œå†™å…¥æ•°æ®ï¼Œå³ä½¿ç”µè„‘åªéœ€è¦æŸä¸ªæ‰‡åŒºå†…çš„å‡ ä¸ªå­—èŠ‚çš„æ–‡ä»¶ï¼Œä¹Ÿå¿…é¡»ä¸€æ¬¡æŠŠè¿™å‡ ä¸ªå­—èŠ‚çš„æ•°æ®æ‰€åœ¨çš„æ‰‡åŒºä¸­çš„å…¨éƒ¨512å­—èŠ‚çš„æ•°æ®å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†è¿›è¡Œç­›é€‰æ‰€éœ€æ•°æ®ï¼Œæ‰€ä»¥ä¸ºäº†æé«˜ç”µè„‘çš„è¿è¡Œé€Ÿåº¦ï¼Œå°±éœ€è¦å¯¹ç¡¬ç›˜è¿›è¡Œæ‰‡åŒºåˆ’åˆ†ã€‚å¦å¤–ï¼Œæ¯ä¸ªæ‰‡åŒºçš„å‰åä¸¤ç«¯éƒ½ä¼šæœ‰ä¸€äº›ç‰¹å®šçš„æ•°æ®ï¼Œè¿™äº›æ•°æ®ç”¨æ¥æ„æˆæ‰‡åŒºä¹‹é—´çš„ç•Œé™æ ‡å¿—ï¼Œç£å¤´é€šè¿‡è¿™äº›ç•Œé™æ ‡å¿—æ¥è¯†åˆ«ä¼—å¤šçš„æ‰‡åŒºã€‚</p><p>æ‰‡åŒºæ˜¯ç¡¬ç›˜çš„æœ€å°æ“ä½œå•ä½ï¼Œä½†æ‰‡åŒºå¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´è¿˜æ˜¯å¤ªå°äº†ï¼Œä¸€èˆ¬æ“ä½œç³»ç»Ÿæœ‰è‡ªå·±çš„ç¡¬ç›˜æ“ä½œæœ€å°å•ä½ï¼Œåœ¨ linux ä¸‹ä¸€èˆ¬ä¸º 4k</p><pre class=" language-shell"><code class="language-shell">xiehui@xiehui-desktop:~$ sudo tune2fs -l  /dev/mapper/ubuntu--vg-root | grep "Block size"Block size:               4096xiehui@xiehui-desktop:~$ </code></pre><h5 id="æŸ±é¢"><a href="#æŸ±é¢" class="headerlink" title="æŸ±é¢"></a>æŸ±é¢</h5><img src="/images/2015/disk_9.png" width="400px"><p>ç¡¬ç›˜é€šå¸¸ç”±ä¸€ä¸ªæˆ–å¤šä¸ªç›˜ç‰‡æ„æˆï¼Œè€Œä¸”æ¯ä¸ªé¢éƒ½è¢«åˆ’åˆ†ä¸ºæ•°ç›®ç›¸ç­‰çš„ç£é“ï¼Œå¹¶ä»å¤–ç¼˜å¼€å§‹ç¼–å·ï¼ˆå³æœ€è¾¹ç¼˜çš„ç£é“ä¸º0ç£é“ï¼Œå¾€é‡Œä¾æ¬¡ç´¯åŠ ï¼‰ã€‚å¦‚æ­¤ç£ç›˜ä¸­å…·æœ‰ç›¸åŒç¼–å·çš„ç£é“ä¼šå½¢æˆä¸€ä¸ªåœ†æŸ±ï¼Œæ­¤åœ†æŸ±ç§°ä¸ºç£ç›˜çš„æŸ±é¢ã€‚ç£ç›˜çš„æŸ±é¢æ•°ä¸ä¸€ä¸ªç›˜é¢ä¸Šçš„ç£é“æ•°æ˜¯ç›¸ç­‰çš„ã€‚ç”±äºæ¯ä¸ªç›˜é¢éƒ½æœ‰ä¸€ä¸ªç£å¤´ï¼Œå› æ­¤ï¼Œç›˜é¢æ•°ç­‰äºæ€»çš„ç£å¤´æ•°ã€‚</p><h4 id="è®¿ç›˜è¿‡ç¨‹"><a href="#è®¿ç›˜è¿‡ç¨‹" class="headerlink" title="è®¿ç›˜è¿‡ç¨‹"></a>è®¿ç›˜è¿‡ç¨‹</h4><p>å³ä¸€æ¬¡è®¿ç›˜è¯·æ±‚ï¼ˆè¯»/å†™ï¼‰å®Œæˆè¿‡ç¨‹ç”±ä¸‰ä¸ªåŠ¨ä½œç»„æˆï¼š</p><ol><li>å¯»é“ï¼ˆæ—¶é—´ï¼‰ï¼šç£å¤´ç§»åŠ¨å®šä½åˆ°æŒ‡å®šç£é“ </li><li>æ—‹è½¬å»¶è¿Ÿï¼ˆæ—¶é—´ï¼‰ï¼šç­‰å¾…æŒ‡å®šæ‰‡åŒºä»ç£å¤´ä¸‹æ—‹è½¬ç»è¿‡ </li><li>æ•°æ®ä¼ è¾“ï¼ˆæ—¶é—´ï¼‰ï¼šæ•°æ®åœ¨ç£ç›˜ä¸å†…å­˜ä¹‹é—´çš„å®é™…ä¼ è¾“</li></ol><p>æ­¤åœ¨ç£ç›˜ä¸Šè¯»å–æ‰‡åŒºæ•°æ®ï¼ˆä¸€å—æ•°æ®ï¼‰æ‰€éœ€æ—¶é—´ï¼š</p><p>$T_{io} = t_{seek}+t{la}+ n * t_{wm}$</p><p>å…¶ä¸­:</p><p>$t_{seek}$ ä¸ºå¯»é“æ—¶é—´</p><p>$t_{la}$ä¸ºæ—‹è½¬æ—¶é—´</p><p>$t_{wm}$ ä¸ºä¼ è¾“æ—¶é—´</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>HDD é¡ºåºè¯»å†™çš„æ€§èƒ½è¿œé«˜äºéšæœºè¯»å†™ï¼Œæˆ‘ä»¬éœ€è¦å……åˆ†åˆ©ç”¨è¿™ä¸€ç‰¹æ€§ã€‚</p><h3 id="SSDï¼ˆSolid-State-Drivesï¼‰"><a href="#SSDï¼ˆSolid-State-Drivesï¼‰" class="headerlink" title="SSDï¼ˆSolid State Drivesï¼‰"></a>SSDï¼ˆSolid State Drivesï¼‰</h3><p>SSD ç”¨å›ºæ€ç”µå­å­˜å‚¨èŠ¯ç‰‡åˆ—é˜µè€Œåˆ¶æˆçš„ç¡¬ç›˜ï¼Œå¦‚å›¾ï¼Œæ‰€ç¤ºä¸ºå›ºæ€ç¡¬ç›˜ï¼Œå®ƒä¸»è¦ç”±æ§åˆ¶å•å…ƒå’Œå­˜å‚¨å•å…ƒï¼ˆFLASHèŠ¯ç‰‡ï¼‰ç»„æˆã€‚å›ºæ€ç¡¬ç›˜çš„æ¥å£è§„èŒƒå’Œå®šä¹‰ã€åŠŸèƒ½åŠä½¿ç”¨æ–¹æ³•ä¸Šä¸æ™®é€šç¡¬ç›˜çš„å®Œå…¨ç›¸åŒï¼Œåœ¨äº§å“å¤–å½¢å’Œå°ºå¯¸ä¸Šä¸æ™®é€šç¡¬ç›˜å‡ ä¹ä¸€è‡´ã€‚å›ºæ€ç¡¬ç›˜çš„å­˜å‚¨ä»‹è´¨åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯é‡‡ç”¨é—ªå­˜ï¼ˆFLASHèŠ¯ç‰‡ï¼‰ä½œä¸ºå­˜å‚¨ä»‹è´¨ï¼Œå¦å¤–ä¸€ç§æ˜¯é‡‡ç”¨DRAMä½œä¸ºå­˜å‚¨ä»‹è´¨ã€‚</p><h4 id="ç»„æˆç»“æ„"><a href="#ç»„æˆç»“æ„" class="headerlink" title="ç»„æˆç»“æ„"></a>ç»„æˆç»“æ„</h4><p>SSD ä¸»è¦ç”±ä¸»æ§åˆ¶å™¨ï¼Œå­˜å‚¨å•å…ƒï¼Œç¼“å­˜ï¼ˆå¯é€‰ï¼‰ï¼Œä»¥åŠè·Ÿä¸»æœºæ¥å£ï¼ˆè¯¸å¦‚SATAï¼ŒSAS, PCIeç­‰ï¼‰ç»„æˆã€‚</p><img src="/images/2015/disk_14.png"><h5 id="ä¸»æ§åˆ¶å™¨"><a href="#ä¸»æ§åˆ¶å™¨" class="headerlink" title="ä¸»æ§åˆ¶å™¨"></a>ä¸»æ§åˆ¶å™¨</h5><p>æ¯ä¸ª SSD éƒ½æœ‰ä¸€ä¸ªæ§åˆ¶å™¨(controller)å°†å­˜å‚¨å•å…ƒè¿æ¥åˆ°ç”µè„‘ï¼Œä¸»æ§å™¨å¯ä»¥é€šè¿‡è‹¥å¹²ä¸ªé€šé“ï¼ˆchannelï¼‰å¹¶è¡Œæ“ä½œå¤šå—FLASHé¢—ç²’ï¼Œç±»ä¼¼ RAID0ï¼Œå¤§å¤§æé«˜åº•å±‚çš„å¸¦å®½ã€‚æ§åˆ¶å™¨æ˜¯ä¸€ä¸ªæ‰§è¡Œå›ºä»¶(firmware)ä»£ç çš„åµŒå…¥å¼å¤„ç†å™¨ã€‚ä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li>é”™è¯¯æ£€æŸ¥å’Œçº æ­£(ECC)</li><li>ç£¨æŸå¹³è¡¡(Wear leveling)</li><li>åå—æ˜ å°„(Bad block mapping)</li><li>Read disturb(è¯»å–æŸä¸ªå—çš„æ•°æ®çš„æ—¶å€™ä¼šå½±å“åˆ°ç›¸é‚»å—çš„æ•°æ®)ç®¡ç†</li><li>ç¼“å­˜æ§åˆ¶</li><li>åƒåœ¾å›æ”¶</li><li>åŠ å¯†</li></ul><h5 id="å­˜å‚¨å•å…ƒ"><a href="#å­˜å‚¨å•å…ƒ" class="headerlink" title="å­˜å‚¨å•å…ƒ"></a>å­˜å‚¨å•å…ƒ</h5><p>å°½ç®¡æœ‰æŸäº›å‚å•†æ¨å‡ºäº†åŸºäºæ›´é«˜é€Ÿçš„ DRAM å†…å­˜çš„äº§å“ï¼Œä½† NAND é—ªå­˜ä¾ç„¶æœ€å¸¸è§ï¼Œå æ®ç€ç»å¯¹ä¸»å¯¼åœ°ä½ã€‚ä½ç«¯äº§å“ä¸€èˆ¬é‡‡ç”¨ MLC(multi-level cell) ç”šè‡³ TLC(Triple Level Cell) é—ªå­˜ï¼Œå…¶ç‰¹ç‚¹æ˜¯å®¹é‡å¤§ã€é€Ÿåº¦æ…¢ã€å¯é æ€§ä½ã€å­˜å–æ¬¡æ•°ä½ã€ä»·æ ¼ä¹Ÿä½ã€‚é«˜ç«¯äº§å“ä¸€èˆ¬é‡‡ç”¨ SLC(single-level cell) é—ªå­˜ï¼Œå…¶ç‰¹ç‚¹æ˜¯æŠ€æœ¯æˆç†Ÿã€å®¹é‡å°ã€é€Ÿåº¦å¿«ã€å¯é æ€§é«˜ã€å­˜å–æ¬¡æ•°é«˜ã€ä»·æ ¼ä¹Ÿé«˜ã€‚ä½†æ˜¯äº‹å®ä¸Šï¼Œå–å†³äºä¸åŒäº§å“çš„å†…éƒ¨æ¶æ„è®¾è®¡ï¼Œé€Ÿåº¦å’Œå¯é æ€§çš„å·®åˆ«ä¹Ÿå¯ä»¥é€šè¿‡å„ç§æŠ€æœ¯åŠ ä»¥å¼¥è¡¥ç”šè‡³åè½¬ã€‚</p><h5 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h5><p>åŸºäº NAND é—ªå­˜çš„ SSD é€šå¸¸å¸¦æœ‰ä¸€ä¸ªåŸºäº DRAM çš„ç¼“å­˜ï¼Œå…¶ä½œç”¨ä¸æ™®é€šçš„æœºæ¢°å¼ç¡¬ç›˜ç±»ä¼¼ï¼Œä½†æ˜¯è¿˜ä¼šå­˜å‚¨ä¸€äº›è¯¸å¦‚ Wear leveling æ•°æ®ä¹‹ç±»çš„å…¶ä»–æ•°æ®ã€‚æŠŠæ•°æ®å…ˆç¼“å­˜åœ¨ DRAM ä¸­ï¼Œç„¶åé›†ä¸­å†™å…¥ï¼Œä»è€Œå‡å°‘å†™å…¥æ¬¡æ•°ã€‚ç‰¹ä¾‹ä¹‹ä¸€æ˜¯ SandForce ç”Ÿäº§çš„æ§åˆ¶å™¨ï¼Œå®ƒå¹¶ä¸å«æœ‰ç¼“å­˜ï¼Œä½†æ˜¯æ€§èƒ½ä¾æ—§å¾ˆå‡ºè‰²ï¼Œç”±äºå…¶ç»“æ„ç®€å•ï¼Œæ•…è€Œå¯ä»¥ç”Ÿäº§ä½“ç§¯æ›´å°çš„ SSDï¼Œå¹¶ä¸”æ‰ç”µæ—¶æ•°æ®æ›´å®‰å…¨ã€‚</p><h5 id="ä¸»æœºæ¥å£"><a href="#ä¸»æœºæ¥å£" class="headerlink" title="ä¸»æœºæ¥å£"></a>ä¸»æœºæ¥å£</h5><p>ä¸»æœºæ¥å£ä¸æ§åˆ¶å™¨ç´§å¯†ç›¸å…³ï¼Œä½†æ˜¯é€šå¸¸ä¸ä¼ ç»Ÿçš„æœºæ¢°å¼ç¡¬ç›˜ç›¸å·®ä¸å¤§ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><ul><li>SATA</li><li>SAS</li><li>PCI-E</li><li>Fibre Channel</li><li>USB</li></ul><h4 id="å­˜å‚¨åŸç†"><a href="#å­˜å‚¨åŸç†" class="headerlink" title="å­˜å‚¨åŸç†"></a>å­˜å‚¨åŸç†</h4><p>SSDå†…éƒ¨ä¸€èˆ¬ä½¿ç”¨ NAND Flash æ¥ä½œä¸ºå­˜å‚¨ä»‹è´¨ï¼Œå…¶é€»è¾‘ç»“æ„å¦‚ä¸‹ï¼š</p><img src="/images/2015/disk_15.png"><p>SSD ä¸­ä¸€èˆ¬æœ‰å¤šä¸ª NAND Flashï¼Œæ¯ä¸ª NAND Flash åŒ…å«å¤šä¸ª  Blockï¼Œæ¯ä¸ªBlock åŒ…å«å¤šä¸ª Pageã€‚ç”±äºNAND çš„ç‰¹æ€§ï¼Œå…¶å­˜å–éƒ½å¿…é¡»ä»¥ page ä¸ºå•ä½ï¼Œå³æ¯æ¬¡è¯»å†™è‡³å°‘æ˜¯ä¸€ä¸ª pageï¼Œé€šå¸¸åœ°ï¼Œæ¯ä¸ª page çš„å¤§å°ä¸º4kæˆ–è€…8kã€‚å¦å¤–ï¼ŒNANDè¿˜æœ‰ä¸€ä¸ªç‰¹æ€§æ˜¯ï¼Œå…¶åªèƒ½æ˜¯è¯»æˆ–å†™å•ä¸ª pageï¼Œä½†ä¸èƒ½è¦†ç›–å†™å¦‚æŸä¸ª pageï¼Œå¿…é¡»å…ˆè¦æ¸…ç©ºé‡Œé¢çš„å†…å®¹ï¼Œå†å†™å…¥ã€‚ç”±äºæ¸…ç©ºå†…å®¹çš„ç”µå‹è¾ƒé«˜ï¼Œå¿…é¡»æ˜¯ä»¥ block ä¸ºå•ä½ã€‚å› æ­¤ï¼Œæ²¡æœ‰ç©ºé—²çš„ page æ—¶ï¼Œå¿…é¡»è¦æ‰¾åˆ°æ²¡æœ‰æœ‰æ•ˆå†…å®¹çš„ blockï¼Œå…ˆæ“¦å†™ï¼Œç„¶åå†é€‰æ‹©ç©ºé—²çš„ page å†™å…¥ã€‚</p><p>æ“ä½œç³»ç»Ÿé€šå¸¸å°†ç¡¬ç›˜ç†è§£ä¸ºä¸€è¿ä¸² 512B å¤§å°çš„<strong>æ‰‡åŒº</strong>[æ³¨æ„ï¼šæ“ä½œç³»ç»Ÿå¯¹ç£ç›˜è¿›è¡Œä¸€æ¬¡è¯»æˆ–å†™çš„æœ€å°å•ä½å¹¶ä¸æ˜¯æ‰‡åŒºï¼Œè€Œæ˜¯æ–‡ä»¶ç³»ç»Ÿçš„<strong>å—</strong>ï¼Œä¸€èˆ¬ä¸º 512B/1KB/4KB ä¹‹ä¸€(ä¹Ÿå¯èƒ½æ›´å¤§)ï¼Œå…¶å…·ä½“å¤§å°åœ¨æ ¼å¼åŒ–æ—¶è®¾å®š]ï¼Œä½†æ˜¯é—ªå­˜çš„è¯»å†™å•ä½æ˜¯ 4/8/16KB å¤§å°çš„<strong>é¡µ</strong>ï¼Œè€Œä¸”é—ªå­˜çš„æ“¦é™¤(åˆå«ç¼–ç¨‹)æ“ä½œæ˜¯æŒ‰ç…§ 128 æˆ– 256 é¡µå¤§å°çš„<strong>å—</strong>æ¥æ“ä½œçš„ã€‚æ›´è¦å‘½çš„æ˜¯å†™å…¥æ•°æ®å‰å¿…é¡»è¦å…ˆæ“¦é™¤æ•´ä¸ªå—ï¼Œè€Œä¸èƒ½ç›´æ¥è¦†ç›–ã€‚è¿™å®Œå…¨ä¸ç¬¦åˆç°æœ‰çš„ã€é’ˆå¯¹ä¼ ç»Ÿç¡¬ç›˜è®¾è®¡çš„æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œæ–¹å¼ï¼Œå¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬éœ€è¦æ›´é«˜çº§ã€ä¸“é—¨é’ˆå¯¹ SSD è®¾è®¡çš„æ–‡ä»¶ç³»ç»Ÿæ¥é€‚åº”è¿™ç§æ“ä½œæ–¹å¼ã€‚ä½†é—æ†¾çš„æ˜¯ï¼Œç›®å‰è¿˜æ²¡æœ‰è¿™æ ·çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>ä¸ºäº†å…¼å®¹ç°æœ‰çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå°±å‡ºç°äº† FTL(é—ªå­˜è½¬æ¢å±‚)ï¼Œå®ƒä½äºæ–‡ä»¶ç³»ç»Ÿå’Œç‰©ç†ä»‹è´¨ä¹‹é—´ï¼ŒæŠŠé—ªå­˜çš„æ“ä½œä¹ æƒ¯è™šæ‹Ÿæˆä»¥ä¼ ç»Ÿç¡¬ç›˜çš„ 512B æ‰‡åŒºè¿›è¡Œæ“ä½œã€‚è¿™æ ·ï¼Œæ“ä½œç³»ç»Ÿå°±å¯ä»¥æŒ‰ç…§ä¼ ç»Ÿçš„æ‰‡åŒºæ–¹å¼æ“ä½œï¼Œè€Œä¸ç”¨æ‹…å¿ƒä¹‹å‰è¯´çš„æ“¦é™¤/è¯»/å†™é—®é¢˜ã€‚ä¸€åˆ‡é€»è¾‘åˆ°ç‰©ç†çš„è½¬æ¢ï¼Œå…¨éƒ¨ç”± FTL å±‚åŒ…äº†ã€‚</p><p>FTL ç®—æ³•ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ç§é€»è¾‘åˆ°ç‰©ç†çš„æ˜ å°„ï¼Œå› æ­¤ï¼Œå½“æ–‡ä»¶ç³»ç»Ÿå‘é€æŒ‡ä»¤è¯´è¦å†™å…¥æˆ–è€…æ›´æ–°ä¸€ä¸ªç‰¹å®šçš„é€»è¾‘æ‰‡åŒºæ—¶ï¼ŒFTL å®é™…ä¸Šå†™å…¥äº†å¦ä¸€ä¸ªç©ºé—²ç‰©ç†é¡µï¼Œå¹¶æ›´æ–°æ˜ å°„è¡¨ï¼Œå†æŠŠè¿™ä¸ªé¡µä¸ŠåŒ…å«çš„æ—§æ•°æ®æ ‡è®°ä¸ºæ— æ•ˆ(æ›´æ–°åçš„æ•°æ®å·²ç»å†™å…¥æ–°åœ°å€äº†ï¼Œæ—§åœ°å€çš„æ•°æ®è‡ªç„¶å°±æ— æ•ˆäº†)ã€‚</p><p>åœ¨ SSD ä¸­ï¼Œä¸€èˆ¬ä¼šç»´æŠ¤ä¸€ä¸ª mapping tableï¼Œç»´æŠ¤é€»è¾‘åœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ã€‚æ¯æ¬¡è¯»å†™æ—¶ï¼Œå¯ä»¥é€šè¿‡é€»è¾‘åœ°å€ç›´æ¥æŸ¥è¡¨è®¡ç®—å‡ºç‰©ç†åœ°å€ï¼Œä¸ä¼ ç»Ÿçš„æœºæ¢°ç£ç›˜ç›¸æ¯”ï¼Œçœå»äº†å¯»é“æ—¶é—´å’Œæ—‹è½¬æ—¶é—´ã€‚</p><h4 id="è¯»å†™ç‰¹æ€§"><a href="#è¯»å†™ç‰¹æ€§" class="headerlink" title="è¯»å†™ç‰¹æ€§"></a>è¯»å†™ç‰¹æ€§</h4><p>ä»NAND Flashçš„åŸç†å¯ä»¥çœ‹å‡ºï¼Œå…¶å’ŒHDDçš„ä¸»è¦åŒºåˆ«ä¸º</p><ul><li>å®šä½æ•°æ®å¿«ï¼šHDD éœ€è¦ç»è¿‡å¯»é“å’Œæ—‹è½¬ï¼Œæ‰èƒ½å®šä½åˆ°è¦è¯»å†™çš„æ•°æ®å—ï¼Œè€Œ SSD é€šè¿‡mapping tableç›´æ¥è®¡ç®—å³å¯</li><li>è¯»å–é€Ÿåº¦å—ï¼šHDD çš„é€Ÿåº¦å–å†³äºæ—‹è½¬é€Ÿåº¦ï¼Œè€Œ SSD åªéœ€è¦åŠ ç”µå‹è¯»å–æ•°æ®ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œè¦å¿«äº HDD</li></ul><p>å› æ­¤ï¼Œåœ¨é¡ºåºè¯»æµ‹è¯•ä¸­ï¼Œç”±äºå®šä½æ•°æ®åªéœ€è¦ä¸€æ¬¡ï¼Œå®šä½ä¹‹åï¼Œåˆ™æ˜¯å¤§æ‰¹é‡çš„è¯»å–æ•°æ®çš„è¿‡ç¨‹ï¼Œæ­¤æ—¶ï¼ŒHDD å’ŒSSD çš„æ€§èƒ½å·®è·ä¸»è¦ä½“ç°åœ¨è¯»å–é€Ÿåº¦ä¸Šï¼ŒHDD èƒ½åˆ°200Må·¦å³ï¼Œè€Œæ™®é€š SSD æ˜¯å…¶ä¸¤å€ã€‚</p><p>åœ¨éšæœºè¯»æµ‹è¯•ä¸­ï¼Œç”±äºæ¯æ¬¡è¯»éƒ½è¦å…ˆå®šä½æ•°æ®ï¼Œç„¶åå†è¯»å–ï¼ŒHDD çš„å®šä½æ•°æ®çš„è€—è´¹æ—¶é—´å¾ˆå¤šï¼Œä¸€èˆ¬æ˜¯å‡ æ¯«ç§’åˆ°åå‡ æ¯«ç§’ï¼Œè¿œè¿œé«˜äº SSD çš„å®šä½æ•°æ®æ—¶é—´(ä¸€èˆ¬0.1mså·¦å³)ï¼Œå› æ­¤ï¼Œéšæœºè¯»å†™æµ‹è¯•ä¸»è¦ä½“ç°åœ¨ä¸¤è€…å®šä½æ•°æ®çš„é€Ÿåº¦ä¸Šï¼Œæ­¤æ—¶ï¼ŒSSD çš„æ€§èƒ½æ˜¯è¦è¿œè¿œå¥½äº HDD çš„ã€‚</p><p>å¯¹äºSSDçš„å†™æ“ä½œï¼Œé’ˆå¯¹ä¸åŒçš„æƒ…å†µï¼Œæœ‰ä¸åŒçš„å¤„ç†æµç¨‹ï¼Œä¸»è¦æ˜¯å—åˆ° NAND Flash çš„å¦‚ä¸‹ç‰¹æ€§é™åˆ¶</p><ul><li>NAND Flash æ¯æ¬¡å†™å¿…é¡»ä»¥ page ä¸ºå•ä½ï¼Œä¸”åªèƒ½å†™å…¥ç©ºé—²çš„ pageï¼Œä¸èƒ½è¦†ç›–å†™åŸå…ˆæœ‰å†…å®¹çš„page</li><li>æ“¦é™¤æ•°æ®æ—¶ï¼Œç”±äºç”µå‹è¾ƒé«˜ï¼Œåªèƒ½ä»¥ block ä¸ºå•ä½æ“¦é™¤</li></ul><p>SSDçš„å†™åˆ†ä¸ºæ–°å†™å…¥å’Œæ›´æ–°ä¸¤ç§ï¼Œå¤„ç†æµç¨‹ä¸åŒã€‚</p><p><strong>æ–°å†™å…¥çš„æ•°æ®çš„æµç¨‹</strong></p><img src="/images/2015/disk_16.png"><p>å‡è®¾æ–°å†™å…¥äº†ä¸€ä¸ªpageï¼Œå…¶æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æ‰¾åˆ°ä¸€ä¸ªç©ºé—²page</li><li>æŠŠæ•°æ®å†™å…¥åˆ°ç©ºé—²pageä¸­</li><li>æ›´æ–°mapping table</li></ul><p><strong>æ›´æ–°æ“ä½œçš„æµç¨‹</strong></p><img src="/images/2015/disk_17.png"><p>å‡è®¾æ˜¯æ›´æ–°äº†page G ä¸­çš„æŸäº›å­—èŠ‚ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ç”±äº SSD ä¸èƒ½è¦†ç›–å†™ï¼Œå› æ­¤ï¼Œå…ˆæ‰¾åˆ°ä¸€ä¸ªç©ºé—²é¡µ H</li><li>è¯»å– page G ä¸­çš„æ•°æ®åˆ° SSD å†…éƒ¨çš„ buffer ä¸­ï¼ŒæŠŠæ›´æ–°çš„å­—èŠ‚æ›´æ–°åˆ° buffer</li><li>æŠŠ buffer ä¸­çš„æ•°æ®å†™å…¥åˆ° H</li><li>æ›´æ–° mapping table ä¸­ G é¡µï¼Œç½®ä¸ºæ— æ•ˆé¡µ</li><li>æ›´æ–° mapping table ä¸­ H é¡µï¼Œæ·»åŠ æ˜ å°„å…³ç³»</li></ul><p>å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœåœ¨æ›´æ–°æ“ä½œæ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œä¼šäº§ç”Ÿè¾ƒå¤šçš„æ— æ•ˆé¡µï¼Œç±»ä¼¼äºç£ç›˜ç¢ç‰‡ï¼Œæ­¤æ—¶ï¼Œéœ€è¦SSDçš„over-provisioningå’Œgarbage-collectionã€‚</p><h4 id="ç£¨æŸå¹³è¡¡"><a href="#ç£¨æŸå¹³è¡¡" class="headerlink" title="ç£¨æŸå¹³è¡¡"></a>ç£¨æŸå¹³è¡¡</h4><p>ç®€å•è¯´æ¥ï¼Œç£¨æŸå¹³è¡¡(Wear leveling)æ˜¯ç¡®ä¿é—ªå­˜çš„æ¯ä¸ªå—è¢«å†™å…¥çš„æ¬¡æ•°ç›¸ç­‰çš„ä¸€ç§æœºåˆ¶ã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨ NAND å—é‡Œçš„æ•°æ®æ›´æ–°é¢‘åº¦æ˜¯ä¸åŒçš„ï¼šæœ‰äº›ä¼šç»å¸¸æ›´æ–°ï¼Œæœ‰äº›åˆ™ä¸å¸¸æ›´æ–°ã€‚å¾ˆæ˜æ˜¾ï¼Œé‚£äº›ç»å¸¸æ›´æ–°çš„æ•°æ®æ‰€å ç”¨çš„å—ä¼šè¢«å¿«é€Ÿçš„ç£¨æŸæ‰ï¼Œè€Œä¸å¸¸æ›´æ–°çš„æ•°æ®å ç”¨çš„å—ç£¨æŸå°±å°å¾—å¤šã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦è®©æ¯ä¸ªå—çš„ç¼–ç¨‹(æ“¦å†™)æ¬¡æ•°å°½å¯èƒ½ä¿æŒä¸€è‡´ï¼šè¿™å°±æ˜¯éœ€è¦å¯¹æ¯ä¸ªé¡µçš„è¯»å–/ç¼–ç¨‹æ“ä½œè¿›è¡Œç›‘æµ‹ï¼Œåœ¨æœ€ä¹è§‚çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæŠ€æœ¯ä¼šè®©å…¨ç›˜çš„é¢—ç²’ç‰©ç†ç£¨æŸç¨‹åº¦ç›¸åŒå¹¶åŒæ—¶æŠ¥åºŸã€‚</p><p>ç£¨æŸå¹³è¡¡ç®—æ³•åˆ†é™æ€å’ŒåŠ¨æ€ã€‚åŠ¨æ€ç£¨æŸç®—æ³•æ˜¯åŸºæœ¬çš„ç£¨æŸç®—æ³•ï¼šåªæœ‰ç”¨æˆ·åœ¨ä½¿ç”¨ä¸­æ›´æ–°çš„æ–‡ä»¶å ç”¨çš„ç‰©ç†é¡µåœ°å€è¢«ç£¨æŸå¹³è¡¡äº†ã€‚è€Œé™æ€ç£¨æŸç®—æ³•æ˜¯æ›´é«˜çº§çš„ç£¨æŸç®—æ³•ï¼šåœ¨åŠ¨æ€ç£¨æŸç®—æ³•çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å¯¹äºé‚£äº›ä¸å¸¸æ›´æ–°çš„æ–‡ä»¶å ç”¨çš„ç‰©ç†åœ°å€è¿›è¡Œç£¨æŸå¹³è¡¡ï¼Œè¿™æ‰ç®—æ˜¯çœŸæ­£çš„å…¨ç›˜ç£¨æŸå¹³è¡¡ã€‚ç®€å•ç‚¹è¯´æ¥ï¼ŒåŠ¨æ€ç®—æ³•å°±æ˜¯æ¯æ¬¡éƒ½æŒ‘æœ€å¹´è½»çš„ NAND å—æ¥ç”¨ï¼Œè€çš„ NAND å—å°½é‡ä¸ç”¨ã€‚é™æ€ç®—æ³•å°±æ˜¯æŠŠé•¿æœŸæ²¡æœ‰ä¿®æ”¹çš„è€æ•°æ®ä»ä¸€ä¸ªå¹´è½» NAND å—é‡Œé¢æ¬å‡ºæ¥ï¼Œé‡æ–°æ‰¾ä¸ªæœ€è€çš„ NAND å—æ”¾ç€ï¼Œè¿™æ ·å¹´è½»çš„ NAND å—å°±èƒ½å†åº¦è¿›å…¥ç»å¸¸ä½¿ç”¨åŒºã€‚æ¦‚å¿µå¾ˆç®€å•ï¼Œä½†å®ç°å´éå¸¸çš„å¤æ‚ï¼Œç‰¹åˆ«æ˜¯é™æ€ã€‚</p><p>å°½ç®¡ç£¨æŸå‡è¡¡çš„ç›®çš„æ˜¯é¿å…æ•°æ®é‡å¤åœ¨æŸä¸ªç©ºé—´å†™å…¥ï¼Œä»¥ä¿è¯å„ä¸ªå­˜å‚¨åŒºåŸŸå†…ç£¨æŸç¨‹åº¦åŸºæœ¬ä¸€è‡´ï¼Œä»è€Œè¾¾åˆ°å»¶é•¿å›ºæ€ç¡¬ç›˜çš„ç›®çš„ã€‚ä½†æ˜¯ï¼Œå®ƒå¯¹å›ºæ€ç¡¬ç›˜çš„æ€§èƒ½æœ‰ä¸åˆ©å½±å“ã€‚</p><p>ä»¥ä¸€ä¸ªä¾‹å­ï¼Œè¯´æ˜æŸè€—å‡è¡¡æ§åˆ¶çš„é‡è¦æ€§ï¼š</p><p>å‡å¦‚ä¸€ä¸ª NAND Flash æ€»å…±æœ‰ 4096ä¸ªblockï¼Œæ¯ä¸ª block çš„æ“¦å†™æ¬¡æ•°æœ€å¤§ä¸º10000ã€‚å…¶ä¸­æœ‰3ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶å ç”¨50ä¸ªblockï¼Œå¹³å‡10åˆ†é’Ÿæ›´æ–°1ä¸ªæ–‡ä»¶ï¼Œå‡è®¾æ²¡æœ‰å‡è¡¡æ§åˆ¶ï¼Œé‚£ä¹ˆåªä¼š3 * 50 + 50å…±200ä¸ªblockï¼Œåˆ™è¿™ä¸ªSSDçš„å¯¿å‘½å¦‚ä¸‹ï¼š</p><img src="/images/2015/disk_18.png"><p>å¤§çº¦ä¸º278å¤©ã€‚è€Œå¦‚æœæ˜¯å®Œç¾çš„æŸè€—å‡è¡¡æ§åˆ¶ï¼Œå³4096ä¸ªblockéƒ½å‡è¡¡åœ°å‚ä¸æ›´æ–°ï¼Œåˆ™ä½¿ç”¨å¯¿å‘½å¦‚ä¸‹ï¼š</p><img src="/images/2015/disk_19.png"><p>å¤§çº¦5689å¤©ã€‚å› æ­¤ï¼Œè®¾è®¡ä¸€ä¸ªå¥½çš„æŸè€—å‡è¡¡æ§åˆ¶ç®—æ³•æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œä¸»æµçš„æ–¹æ³•ä¸»è¦æœ‰ä¸¤ç§ï¼š</p><ul><li>dynamic wear leveling</li><li>static wear leveling</li></ul><p>è¿™é‡Œçš„ dynamic å’Œ static æ˜¯æŒ‡çš„æ˜¯æ•°æ®çš„ç‰¹æ€§ï¼Œå¦‚æœæ•°æ®é¢‘ç¹çš„æ›´æ–°ï¼Œé‚£ä¹ˆæ•°æ®æ˜¯ dynamic çš„ï¼Œå¦‚æœæ•°æ®å†™å…¥åï¼Œä¸æ›´æ–°ï¼Œé‚£ä¹ˆæ˜¯ static çš„ã€‚</p><p>dynamic wear leveling çš„åŸç†æ˜¯è®°å½•æ¯ä¸ª block çš„æ“¦å†™æ¬¡æ•°ï¼Œæ¯æ¬¡å†™å…¥æ•°æ®æ—¶ï¼Œæ‰¾åˆ°è¢«æ“¦é™¤æ¬¡æ•°æœ€å°çš„ç©ºblockã€‚</p><p>static wear leveling çš„åŸç†åˆ†ä¸ºä¸¤å—ï¼š</p><ul><li>æ¯æ¬¡æ‰¾åˆ°æ¯æ“¦é™¤æ¬¡æ•°æœ€å°çš„å¯ç”¨ block</li><li>å½“æŸä¸ª block çš„æ“¦é™¤æ¬¡æ•°å°äºé˜ˆå€¼æ—¶ï¼Œä¼šå°†å®ƒä¸æ“¦å†™æ¬¡æ•°è¾ƒé«˜çš„ block çš„æ•°æ®è¿›è¡Œäº¤æ¢</li></ul><p>ä»¥ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ï¼Œä¸¤ç§æ“¦å†™ç®—æ³•çš„ä¸åŒç‚¹ï¼š</p><p>å‡å¦‚ SSD ä¸­æœ‰25%çš„æ•°æ®æ˜¯ dynamic çš„ï¼Œå¦å¤–75%çš„æ•°æ®æ˜¯ static çš„ã€‚å¯¹äº dynamic wear leveling æ–¹æ³•ï¼Œæ¯æ¬¡è¦æ‰¾çš„æ˜¯æ“¦é™¤äº†æ•°æ®çš„ blockï¼Œè€Œ static çš„ block é‡Œé¢æ˜¯æœ‰æ•°æ®çš„ï¼Œå› æ­¤ï¼Œæ¯æ¬¡éƒ½åªä¼šåœ¨ dynamic çš„ block ä¸­ï¼Œå³æœ€å¤šä¼šåœ¨25%çš„ block ä¸­åšå‡è¡¡ï¼›å¯¹äº static ç®—æ³•ï¼Œæ¯æ¬¡æ‰¾çš„ block æ—¢å¯èƒ½æ˜¯ dynamic çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯ static çš„ï¼Œå› æ­¤ï¼Œæœ€å¤šæœ‰å¯èƒ½åœ¨å…¨éƒ¨çš„ block ä¸­åšå‡è¡¡ã€‚</p><p>ç›¸å¯¹è€Œè¨€ï¼Œstatic ç®—æ³•èƒ½ä½¿å¾— SSD çš„å¯¿å‘½æ›´é•¿ï¼Œä½†ä¹Ÿæœ‰å…¶ç¼ºç‚¹ï¼š</p><ul><li>ç®—æ³•é€»è¾‘æ›´å¤æ‚</li><li>åœ¨å†™å…¥æ—¶ï¼Œå¯èƒ½ä¼šç§»åŠ¨æ•°æ®ï¼Œå¯¼è‡´å†™æ”¾å¤§ï¼Œé™ä½å†™å…¥æ€§èƒ½</li><li>æ›´é«˜çš„èƒ½è€—</li></ul><h4 id="åƒåœ¾å›æ”¶"><a href="#åƒåœ¾å›æ”¶" class="headerlink" title="åƒåœ¾å›æ”¶"></a>åƒåœ¾å›æ”¶</h4><p>ç”±å‰é¢çš„ç£¨æŸå¹³è¡¡æœºåˆ¶çŸ¥é“ï¼Œç£¨æŸå¹³è¡¡çš„æ‰§è¡Œéœ€è¦æœ‰â€œç©ºç™½å—â€æ¥å†™å…¥æ›´æ–°åçš„æ•°æ®ã€‚å½“å¯ä»¥ç›´æ¥å†™å…¥æ•°æ®çš„â€œå¤‡ç”¨ç©ºç™½å—â€æ•°é‡ä½äºä¸€ä¸ªé˜€å€¼åï¼ŒSSD ä¸»æ§åˆ¶å™¨å°±ä¼šæŠŠé‚£äº›åŒ…å«æ— æ•ˆæ•°æ®çš„å—é‡Œçš„æ‰€æœ‰æœ‰æ•ˆæ•°æ®åˆå¹¶èµ·æ¥å†™åˆ°æ–°çš„â€œç©ºç™½å—â€ä¸­ï¼Œç„¶åæ“¦é™¤è¿™ä¸ªå—ä»¥å¢åŠ â€œå¤‡ç”¨ç©ºç™½å—â€çš„æ•°é‡ã€‚è¿™ä¸ªæ“ä½œå°±æ˜¯ SSD çš„åƒåœ¾å›æ”¶ã€‚</p><img src="/images/2015/gc_1.jpg" width="400px"><img src="/images/2015/gc_2.jpg" width="400px"><p>æœ‰ä¸‰ç§åƒåœ¾å›æ”¶ç­–ç•¥ï¼š</p><ol><li><p>é—²ç½®åƒåœ¾å›æ”¶ï¼šå¾ˆæ˜æ˜¾åœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶å€™ä¼šæ¶ˆè€—å¤§é‡çš„ä¸»æ§å¤„ç†èƒ½åŠ›å’Œå¸¦å®½é€ æˆå¤„ç†ç”¨æˆ·è¯·æ±‚çš„æ€§èƒ½ä¸‹é™ï¼ŒSSD ä¸»æ§åˆ¶å™¨å¯ä»¥è®¾ç½®åœ¨ç³»ç»Ÿé—²ç½®æ—¶å€™åšâ€œé¢„å…ˆâ€åƒåœ¾å›æ”¶(æå‰åšåƒåœ¾å›æ”¶æ“ä½œ)ï¼Œä¿è¯ä¸€å®šæ•°é‡çš„â€å¤‡ç”¨ç©ºç™½å—â€ï¼Œè®© SSD åœ¨è¿è¡Œæ—¶å€™èƒ½å¤Ÿä¿æŒè¾ƒé«˜çš„æ€§èƒ½ã€‚é—²ç½®åƒåœ¾å›æ”¶çš„ç¼ºç‚¹æ˜¯ä¼šå¢åŠ é¢å¤–çš„â€å†™å…¥æ”¾å¤§â€ï¼Œå› ä¸ºä½ åˆšåˆšåƒåœ¾å›æ”¶çš„â€æœ‰æ•ˆæ•°æ®â€ï¼Œä¹Ÿè®¸é©¬ä¸Šå°±ä¼šè¢«æ›´æ–°åçš„æ•°æ®æ›¿ä»£è€Œå˜æˆâ€æ— æ•ˆæ•°æ®â€ï¼Œè¿™æ ·å°±é€ æˆä¹‹å‰çš„åƒåœ¾å›æ”¶åšæ— ç”¨åŠŸäº†ã€‚</p></li><li><p>è¢«åŠ¨åƒåœ¾å›æ”¶ï¼šæ¯ä¸ª SSD éƒ½æ”¯æŒçš„æŠ€æœ¯ï¼Œä½†æ˜¯å¯¹ä¸»æ§åˆ¶å™¨çš„æ€§èƒ½æå‡ºäº†å¾ˆé«˜çš„è¦æ±‚ï¼Œé€‚åˆåœ¨æœåŠ¡å™¨é‡Œç”¨åˆ°ï¼ŒSandForce çš„ä¸»æ§å°±å±è¿™ç±»ã€‚åœ¨åƒåœ¾å›æ”¶æ“ä½œæ¶ˆè€—å¸¦å®½å’Œå¤„ç†èƒ½åŠ›çš„åŒæ—¶å¤„ç†ç”¨æˆ·æ“ä½œæ•°æ®ï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿå¼ºåŠ²çš„ä¸»æ§åˆ¶å™¨æ€§èƒ½åˆ™ä¼šé€ æˆæ˜æ˜¾çš„é€Ÿåº¦ä¸‹é™ã€‚è¿™å°±æ˜¯ä¸ºå•¥å¾ˆå¤š SSD åœ¨å…¨ç›˜å†™æ»¡ä¸€æ¬¡åä¼šå‡ºç°æ€§èƒ½ä¸‹é™çš„é“ç†ï¼Œå› ä¸ºè¦æƒ³ç»§ç»­å†™å…¥æ•°æ®å°±å¿…é¡»è¦è¾¹åƒåœ¾å›æ”¶è¾¹åšå†™å…¥ã€‚</p></li><li><p>æ‰‹åŠ¨åƒåœ¾å›æ”¶ï¼šç”¨æˆ·è‡ªå·±æ‰‹åŠ¨é€‰æ‹©åˆé€‚çš„æ—¶æœºè¿è¡Œåƒåœ¾å›æ”¶è½¯ä»¶ï¼Œæ‰§è¡Œåƒåœ¾å›æ”¶æ“ä½œã€‚</p></li></ol><p>å¯ä»¥æƒ³è±¡ï¼Œå¦‚æœç³»ç»Ÿç»å¸¸è¿›è¡Œåƒåœ¾å›æ”¶å¤„ç†ï¼Œé¢‘ç¹çš„å°†ä¸€äº›åŒºå—è¿›è¡Œæ“¦é™¤æ“ä½œï¼Œé‚£ä¹ˆ SSD çš„å¯¿å‘½åè€Œä¹Ÿä¼šè¿›ä¸€æ­¥ä¸‹é™ã€‚ç”±æ­¤æŠŠæ¡è¿™ä¸ªåƒåœ¾å›æ”¶çš„é¢‘ç¹ç¨‹åº¦ï¼ŒåŒæ—¶ç¡®ä¿ SSD ä¸­çš„é—ªå­˜èŠ¯ç‰‡æ‹¥æœ‰æ›´é«˜çš„ä½¿ç”¨å¯¿å‘½ï¼Œè¿™ç¡®å®éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå®Œç¾çš„å¹³è¡¡ç‚¹ã€‚æ‰€ä»¥ï¼ŒSSD å¿…é¡»è¦æ”¯æŒ Trim æŠ€æœ¯ï¼Œä¸ç„¶ GC å°±æ˜¾ä¸å‡ºä»–çš„ä¼˜åŠ¿äº†ã€‚</p><h4 id="Trim"><a href="#Trim" class="headerlink" title="Trim"></a>Trim</h4><p>Trim æ˜¯ä¸€ä¸ª ATA æŒ‡ä»¤ï¼Œå½“æ“ä½œç³»ç»Ÿåˆ é™¤æ–‡ä»¶æˆ–æ ¼å¼åŒ–çš„æ—¶å€™ï¼Œç”±æ“ä½œç³»ç»ŸåŒæ—¶æŠŠè¿™ä¸ªæ–‡ä»¶åœ°å€å‘é€ç»™ SSD çš„ä¸»æ§åˆ¶å™¨ï¼Œè®©ä¸»æ§åˆ¶å™¨çŸ¥é“è¿™ä¸ªåœ°å€çš„æ•°æ®æ— æ•ˆäº†ã€‚</p><p>å½“ä½ åˆ é™¤ä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œæ–‡ä»¶ç³»ç»Ÿå…¶å®å¹¶ä¸ä¼šçœŸæ­£å»åˆ é™¤å®ƒï¼Œè€Œåªæ˜¯æŠŠè¿™ä¸ªæ–‡ä»¶åœ°å€æ ‡è®°ä¸ºâ€œå·²åˆ é™¤â€ï¼Œå¯ä»¥è¢«å†æ¬¡ä½¿ç”¨ï¼Œè¿™æ„å‘³ç€è¿™ä¸ªæ–‡ä»¶å çš„åœ°å€å·²ç»æ˜¯â€œæ— æ•ˆâ€çš„äº†ã€‚è¿™å°±ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œç¡¬ç›˜å¹¶ä¸çŸ¥é“æ“ä½œç³»ç»ŸæŠŠè¿™ä¸ªåœ°å€æ ‡è®°ä¸ºâ€œå·²åˆ é™¤â€äº†ï¼Œæœºæ¢°ç›˜çš„è¯æ— æ‰€è°“ï¼Œå› ä¸ºå¯ä»¥ç›´æ¥åœ¨è¿™ä¸ªåœ°å€ä¸Šé‡æ–°è¦†ç›–å†™å…¥ï¼Œä½†æ˜¯åˆ°äº† SSD ä¸Šé—®é¢˜å°±æ¥äº†ã€‚NAND éœ€è¦å…ˆæ“¦é™¤æ‰èƒ½å†æ¬¡å†™å…¥æ•°æ®ï¼Œè¦å¾—åˆ°ç©ºé—²çš„ NAND ç©ºé—´ï¼ŒSSD å¿…é¡»å¤åˆ¶æ‰€æœ‰çš„æœ‰æ•ˆé¡µåˆ°æ–°çš„ç©ºé—²å—é‡Œï¼Œå¹¶æ“¦é™¤æ—§å—(åƒåœ¾å›æ”¶)ã€‚å¦‚æœæ²¡æœ‰ Trim æŒ‡ä»¤ï¼Œæ„å‘³ç€ SSD ä¸»æ§åˆ¶å™¨ä¸çŸ¥é“è¿™ä¸ªé¡µæ˜¯â€œæ— æ•ˆâ€çš„ï¼Œé™¤éå†æ¬¡è¢«æ“ä½œç³»ç»Ÿè¦æ±‚è¦†ç›–ä¸Šå»ã€‚</p><p>Trim åªæ˜¯æ¡æŒ‡ä»¤ï¼Œè®©æ“ä½œç³»ç»Ÿå‘Šè¯‰ SSD ä¸»æ§åˆ¶å™¨è¿™ä¸ªé¡µå·²ç»â€œæ— æ•ˆâ€äº†ã€‚Trim ä¼šå‡å°‘å†™å…¥æ”¾å¤§ï¼Œå› ä¸ºä¸»æ§åˆ¶å™¨ä¸éœ€è¦å¤åˆ¶â€œæ— æ•ˆâ€çš„é¡µ(æ²¡ Trim å°±æ˜¯â€œæœ‰æ•ˆâ€çš„)åˆ°ç©ºç™½å—é‡Œï¼Œè¿™åŒæ—¶ä»£è¡¨å¤åˆ¶çš„â€œæœ‰æ•ˆâ€é¡µå˜å°‘äº†ï¼Œåƒåœ¾å›æ”¶çš„æ•ˆç‡å’Œ SSD æ€§èƒ½ä¹Ÿæå‡äº†ã€‚</p><p>Trim èƒ½å¤§é‡å‡å°‘ä¼ªæœ‰æ•ˆé¡µçš„æ•°é‡ï¼Œå®ƒèƒ½å¤§å¤§æå‡åƒåœ¾å›æ”¶çš„æ•ˆç‡ã€‚</p><p>ç›®å‰ï¼Œæ”¯æŒ Trim éœ€è¦ä¸‰ä¸ªè¦ç´ ï¼Œç¼ºä¸€ä¸å¯ï¼š</p><ul><li>ç³»ç»Ÿï¼š æ“ä½œç³»ç»Ÿå¿…é¡»ä¼šå‘é€ Trim æŒ‡ä»¤ï¼ŒWin7, Win2008R2 , Linux-2.6.33 ä»¥ä¸Šã€‚</li><li>å›ºä»¶ï¼š SSD çš„å‚å•†åœ¨å›ºä»¶é‡Œè¦æ”¾æœ‰ Trim ç®—æ³•ï¼Œä¹Ÿå°±æ˜¯ SSD çš„ä¸»æ§åˆ¶å™¨å¿…é¡»è®¤è¯† Trim æŒ‡ä»¤ã€‚</li><li>é©±åŠ¨ï¼š æ§åˆ¶å™¨é©±åŠ¨å¿…é¡»è¦æ”¯æŒ Trim æŒ‡ä»¤çš„ä¼ è¾“ï¼Œä¹Ÿå°±æ˜¯èƒ½å¤Ÿå°† Trim æŒ‡ä»¤ä¼ è¾“åˆ° SSD æ§åˆ¶å™¨ã€‚MS çš„é©±åŠ¨ï¼ŒIntel çš„ AHCI é©±åŠ¨ç›®å‰æ”¯æŒã€‚åˆ«çš„è¦çœ‹ä¹‹åçš„æ›´æ–°äº†ã€‚</li></ul><p>ç›®å‰ï¼ŒRAID é˜µåˆ—é‡Œçš„ç›˜æ˜ç¡®ä¸æ”¯æŒ TRIMï¼Œä¸è¿‡ RAID é˜µåˆ—æ”¯æŒ GCã€‚</p><h4 id="NCQ"><a href="#NCQ" class="headerlink" title="NCQ"></a>NCQ</h4><p>NCQ(Native Command Queuing) çš„æ„æ€æ˜¯åŸç”ŸæŒ‡ä»¤æ’åºã€‚ä½¿ç”¨ NCQ æŠ€æœ¯å¯ä»¥å¯¹å°†è¦è¯»å–çš„æ–‡ä»¶è¿›è¡Œå†…éƒ¨æ’åºï¼Œç„¶åå¯¹æ–‡ä»¶çš„æ’åºåšæœ€ä½³åŒ–çº¿è·¯è¯»å†™ï¼Œè¾¾åˆ°æå‡è¯»å†™æ•ˆç‡çš„ç›®åœ°ã€‚NCQ æœ€æ—©æ˜¯ SCSI çš„æ ‡å‡†ä¹‹ä¸€ï¼Œåªæ˜¯é‚£æ—¶å€™ä¸å« NCQï¼Œå¯¹è¿™ä¸ªæ ‡å‡†ç¨ä½œä¿®æ”¹åï¼Œåœ¨ SATA çš„åº”ç”¨ä¸Šå°±å«åš NCQ äº†ï¼ŒSAS æ¥å£ä¹Ÿæ”¯æŒ NCQã€‚SSD è™½ç„¶æ²¡æœ‰æœºæ¢°è‡‚ï¼Œä½†æ˜¯ SSD æœ‰å¤šé€šé“ã€‚å¼€å¯ NCQ åï¼ŒSSD ä¸»æ§åˆ¶å™¨ä¼šæ ¹æ®æ•°æ®çš„è¯·æ±‚å’Œ NAND å†…éƒ¨æ•°æ®çš„åˆ†å¸ƒï¼Œå……åˆ†åˆ©ç”¨ä¸»æ§åˆ¶å™¨é€šé“çš„å¸¦å®½è¾¾åˆ°æå‡æ€§èƒ½çš„ç›®åœ°ï¼Œæ‰€ä»¥ NCQ å¯¹ SSD ä¹Ÿæœ‰å¸®åŠ©ï¼Œç†æƒ³çŠ¶å†µä¸‹æ€§èƒ½æå‡å¯è¾¾5-10å€ã€‚ç›®å‰åŸç”Ÿæ”¯æŒ SATA çš„ SSD éƒ½èƒ½æ”¯æŒ NCQã€‚å½“ç„¶ï¼Œè¦å¼€å¯NCQï¼Œå¿…é¡»è¦ä½¿ç”¨ AHCI æ¨¡å¼ã€‚</p><h4 id="é¢„ç•™ç©ºé—´"><a href="#é¢„ç•™ç©ºé—´" class="headerlink" title="é¢„ç•™ç©ºé—´"></a>é¢„ç•™ç©ºé—´</h4><p>é¢„ç•™ç©ºé—´(Over-provisioning)æ˜¯æŒ‡ç”¨æˆ·ä¸å¯æ“ä½œçš„å®¹é‡ï¼Œä¸ºå®é™…ç‰©ç†é—ªå­˜å®¹é‡å‡å»ç”¨æˆ·å¯ç”¨å®¹é‡ã€‚è¿™å—åŒºåŸŸä¸€èˆ¬è¢«ç”¨æ¥åšä¼˜åŒ–ï¼ŒåŒ…æ‹¬ç£¨æŸå‡è¡¡ï¼ŒGCå’Œåå—æ˜ å°„ã€‚</p><p>ç¬¬ä¸€å±‚ä¸ºå›ºå®šçš„7.37%ï¼Œè¿™ä¸ªæ•°å­—æ˜¯å¦‚ä½•å¾—å‡ºçš„å“ªï¼Ÿæˆ‘ä»¬çŸ¥é“æœºæ¢°ç¡¬ç›˜å’Œ SSD çš„å‚å•†å®¹é‡æ˜¯è¿™æ ·ç®—çš„ï¼Œ1GB æ˜¯1,000,000,000å­—èŠ‚(10çš„9 æ¬¡æ–¹)ï¼Œä½†æ˜¯é—ªå­˜çš„å®é™…å®¹é‡æ˜¯æ¯ GB=1,073,741,824ï¼Œ(2çš„30æ¬¡æ–¹) ï¼Œä¸¤è€…ç›¸å·®7.37%ã€‚æ‰€ä»¥è¯´å‡è®¾1å— 128GB çš„ SSDï¼Œç”¨æˆ·å¾—åˆ°çš„å®¹é‡æ˜¯ 128,000,000,000 å­—èŠ‚ï¼Œå¤šå‡ºæ¥çš„é‚£ä¸ª 7.37% å°±è¢«ä¸»æ§å›ºä»¶ç”¨åšOPäº†ã€‚</p><p>ç¬¬äºŒå±‚æ¥è‡ªåˆ¶é€ å•†çš„è®¾ç½®ï¼Œé€šå¸¸ä¸º 0%ï¼Œ7%ï¼Œ28% ç­‰ï¼Œæ‰“ä¸ªæ¯”æ–¹ï¼Œå¯¹äº 128G é¢—ç²’çš„ SandForce ä¸»æ§ SSDï¼Œå¸‚åœºä¸Šä¼šæœ‰ 120G å’Œ 100G ä¸¤ç§å‹å·å–ï¼Œè¿™ä¸ªå–å†³äºå‚å•†çš„å›ºä»¶è®¾ç½®ï¼Œè¿™ä¸ªå®¹é‡ä¸åŒ…æ‹¬ä¹‹å‰çš„ç¬¬ä¸€å±‚ 7.37% ã€‚</p><p>ç¬¬ä¸‰å±‚æ˜¯ç”¨æˆ·åœ¨æ—¥å¸¸ä½¿ç”¨ä¸­å¯ä»¥åˆ†é…çš„é¢„ç•™ç©ºé—´ï¼Œç”¨æˆ·å¯ä»¥åœ¨åˆ†åŒºçš„æ—¶å€™ï¼Œä¸åˆ†åˆ°å®Œå…¨çš„ SSD å®¹é‡æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéœ€è¦å…ˆåšå®‰å…¨æ“¦é™¤(Secure Erase)ï¼Œä»¥ä¿è¯æ­¤ç©ºé—´ç¡®å®æ²¡æœ‰è¢«ä½¿ç”¨è¿‡ã€‚</p><img src="/images/2015/op_1.jpg" width="400px"><p>é¢„ç•™ç©ºé—´è™½ç„¶è®© SSD çš„å¯ç”¨å®¹é‡å°äº†ï¼Œä½†æ˜¯å¸¦æ¥äº†å‡å°‘å†™å…¥æ”¾å¤§ã€æé«˜è€ä¹…æ€§ã€æé«˜æ€§èƒ½çš„æ•ˆæœã€‚æ ¹æ®ç»éªŒï¼Œé¢„ç•™ç©ºé—´åœ¨ 20%-35% ä¹‹é—´æ˜¯æœ€ä½³å¹³è¡¡ç‚¹ã€‚</p><p>ä»¥ä¸€ä¸ªä¾‹å­ï¼Œè¯´æ˜ SSD çš„é¢„ç•™ç©ºé—´å’Œ GCï¼š</p><img src="/images/2015/disk_20.png"><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡è®¾ç³»ç»Ÿä¸­å°±ä¸¤ä¸ª blockï¼Œæœ€ç»ˆè¿˜å‰©ä¸‹ä¸¤ä¸ªæ— æ•ˆçš„ pageï¼Œæ­¤æ—¶ï¼Œè¦å†™å…¥ä¸€ä¸ªæ–° pageï¼Œæ ¹æ® NAND åŸç†ï¼Œå¿…é¡»è¦å…ˆå¯¹ä¸¤ä¸ªæ— æ•ˆçš„ page æ“¦é™¤æ‰èƒ½ç”¨äºå†™å…¥ã€‚æ­¤æ—¶ï¼Œå°±éœ€è¦ç”¨åˆ° SSD æä¾›çš„é¢å¤–ç©ºé—´ï¼Œæ‰èƒ½ç”¨ GC æ–¹æ³•æ•´ç†å‡ºå¯ç”¨ç©ºé—´ã€‚</p><img src="/images/2015/disk_21.png" width="400px"><p>GC çš„æ•´ç†æµç¨‹å¦‚ä¸Šå›¾æ‰€ç¤º</p><ul><li>é¦–å…ˆï¼Œä»é¢„ç•™ç©ºé—´ä¸­ï¼Œæ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„ block</li><li>æŠŠ Block0 çš„ ABCDEFH å’Œ Block1 çš„ A å¤åˆ¶åˆ°ç©ºé—² block</li><li>æ“¦é™¤ Block0</li><li>æŠŠ Block1 çš„ BCDEFH  å¤åˆ¶åˆ°Block0ï¼Œæ­¤æ—¶ Block0 å°±æœ‰ä¸¤ä¸ªç©ºé—² page äº†</li><li>æ“¦é™¤ BLock1</li></ul><p>æœ‰ç©ºé—² page ä¹‹åï¼Œå°±å¯ä»¥æŒ‰ç…§æ­£å¸¸çš„æµç¨‹æ¥å†™å…¥äº†ã€‚</p><p>SSD çš„ GC ä¼šå¸¦æ¥ä¸¤ä¸ªé—®é¢˜ï¼š</p><ul><li>SSD çš„å¯¿å‘½å‡å°‘ï¼ŒNAND Flash ä¸­æ¯ä¸ªåŸä»¶éƒ½æœ‰æ“¦å†™æ¬¡æ•°é™åˆ¶ï¼Œè¶…è¿‡ä¸€å®šæ“¦å†™æ¬¡æ•°åï¼Œå°±åªèƒ½è¯»å–ä¸èƒ½å†™å…¥äº†</li><li>å†™æ”¾å¤§é—®é¢˜ï¼Œå³å†…éƒ¨çœŸæ­£å†™å…¥çš„æ•°æ®é‡å¤§äºç”¨æˆ·è¯·æ±‚å†™å…¥çš„æ•°æ®é‡</li></ul><p>å¦‚æœé¢‘ç¹çš„åœ¨æŸäº› block ä¸Šåš GCï¼Œä¼šä½¿å¾—è¿™äº›å…ƒä»¶æ¯”å…¶ä»–éƒ¨åˆ†æ›´å¿«åˆ°è¾¾æ“¦å†™æ¬¡æ•°é™åˆ¶ï¼Œå› æ­¤ï¼Œéœ€è¦æŸä¸ªç®—æ³•ï¼Œèƒ½ä½¿å¾—åŸä»¶çš„æ“¦å†™æ¬¡æ•°æ¯”è¾ƒå¹³å‡ï¼Œè¿™æ ·æ‰èƒ½å»¶é•¿ SSD çš„å¯¿å‘½ï¼Œè¿™å°±éœ€è¦æŸè€—å‡è¡¡æ§åˆ¶äº†ã€‚</p><h4 id="å†™å…¥æ”¾å¤§"><a href="#å†™å…¥æ”¾å¤§" class="headerlink" title="å†™å…¥æ”¾å¤§"></a>å†™å…¥æ”¾å¤§</h4><p>å†™å…¥æ”¾å¤§(Write amplification)ï¼Œå› ä¸ºé—ªå­˜å¿…é¡»å…ˆæ“¦é™¤(ä¹Ÿå«ç¼–ç¨‹)æ‰èƒ½å†™å…¥ï¼Œåœ¨æ‰§è¡Œè¿™äº›æ“ä½œçš„æ—¶å€™ï¼Œç§»åŠ¨æˆ–è¦†ç›–ç”¨æˆ·æ•°æ®å’Œå…ƒæ•°æ®(metadata)ä¸æ­¢ä¸€æ¬¡ã€‚è¿™äº›é¢å¤–çš„æ“ä½œï¼Œä¸ä½†å¢åŠ äº†å†™å…¥æ•°æ®é‡ï¼Œå‡å°‘äº†SSDçš„ä½¿ç”¨å¯¿å‘½ï¼Œè€Œä¸”è¿˜åƒå…‰äº†é—ªå­˜çš„å¸¦å®½ï¼Œé—´æ¥åœ°å½±å“äº†éšæœºå†™å…¥æ€§èƒ½ã€‚è¿™ç§æ•ˆåº”å°±å«å†™å…¥æ”¾å¤§(Write amplification)ã€‚ä¸€ä¸ªä¸»æ§çš„å¥½åä¸»è¦ä½“ç°åœ¨å†™å…¥æ”¾å¤§ä¸Šã€‚</p><p>æ¯”å¦‚æˆ‘è¦å†™å…¥ä¸€ä¸ª 4KB çš„æ•°æ®ï¼Œæœ€åçš„æƒ…å†µæ˜¯ï¼Œä¸€ä¸ªå—é‡Œå·²ç»æ²¡æœ‰å¹²å‡€ç©ºé—´äº†ï¼Œä½†æ˜¯æœ‰æ— æ•ˆæ•°æ®å¯ä»¥æ“¦é™¤ï¼Œæ‰€ä»¥ä¸»æ§å°±æŠŠæ‰€æœ‰çš„æ•°æ®è¯»åˆ°ç¼“å­˜ï¼Œæ“¦é™¤å—ï¼Œä»ç¼“å­˜é‡Œæ›´æ–°æ•´ä¸ªå—çš„æ•°æ®ï¼Œå†æŠŠæ–°æ•°æ®å†™å›å»ã€‚è¿™ä¸ªæ“ä½œå¸¦æ¥çš„å†™å…¥æ”¾å¤§å°±æ˜¯ï¼šæˆ‘å®é™…å†™4Kçš„æ•°æ®ï¼Œé€ æˆäº†æ•´ä¸ªå—(1024KB)çš„å†™å…¥æ“ä½œï¼Œé‚£å°±æ˜¯256å€æ”¾å¤§ã€‚åŒæ—¶å¸¦æ¥äº†åŸæœ¬åªéœ€è¦ç®€å•çš„å†™4KBçš„æ“ä½œå˜æˆé—ªå­˜è¯»å–(1024KB)ï¼Œç¼“å­˜æ”¹(4KB)ï¼Œé—ªå­˜æ“¦(1024KB)ï¼Œé—ªå­˜å†™(1024KB)ï¼Œé€ æˆäº†å»¶è¿Ÿå¤§å¤§å¢åŠ ï¼Œé€Ÿåº¦æ€¥å‰§ä¸‹é™ä¹Ÿå°±æ˜¯è‡ªç„¶çš„äº‹äº†ã€‚æ‰€ä»¥ï¼Œå†™å…¥æ”¾å¤§æ˜¯å½±å“ SSD éšæœºå†™å…¥æ€§èƒ½å’Œå¯¿å‘½çš„å…³é”®å› ç´ ã€‚</p><p>ç”¨100%éšæœº4KBæ¥å†™å…¥ SSDï¼Œå¯¹äºç›®å‰çš„å¤§å¤šæ•° SSD ä¸»æ§è€Œè¨€ï¼Œåœ¨æœ€ç³Ÿç³•çš„æƒ…å†µä¸‹ï¼Œå†™å…¥æ”¾å¤§çš„å®é™…å€¼å¯èƒ½ä¼šè¾¾åˆ°æˆ–è¶…è¿‡20å€ã€‚å½“ç„¶ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥è®¾ç½®ä¸€å®šçš„é¢„ç•™ç©ºé—´æ¥å‡å°‘å†™å…¥æ”¾å¤§ï¼Œå‡è®¾ä½ æœ‰ä¸ª 128G çš„ SSDï¼Œä½ åªåˆ†äº† 64G çš„åŒºä½¿ç”¨ï¼Œé‚£ä¹ˆæœ€åæƒ…å†µä¸‹çš„å†™å…¥æ”¾å¤§å°±èƒ½å‡å°‘çº¦3å€ã€‚</p><p>è®¸å¤šå› ç´ å½±å“ SSD çš„å†™å…¥æ”¾å¤§ã€‚ä¸‹é¢åˆ—å‡ºäº†ä¸»è¦å› ç´ ï¼Œä»¥åŠå®ƒä»¬å¦‚ä½•å½±å“å†™å…¥æ”¾å¤§ã€‚</p><ol><li>åƒåœ¾å›æ”¶è™½ç„¶å¢åŠ äº†å†™å…¥æ”¾å¤§(è¢«åŠ¨åƒåœ¾å›æ”¶ä¸å½±å“ï¼Œé—²ç½®åƒåœ¾å›æ”¶å½±å“)ï¼Œä½†æ˜¯é€Ÿåº¦æœ‰æå‡ã€‚</li><li>é¢„ç•™ç©ºé—´å¯ä»¥å‡å°‘å†™å…¥æ”¾å¤§ï¼Œé¢„ç•™ç©ºé—´è¶Šå¤§ï¼Œå†™å…¥æ”¾å¤§è¶Šä½ã€‚</li><li>å¼€å¯ TRIM æŒ‡ä»¤åå¯ä»¥å‡å°‘å†™å…¥æ”¾å¤§</li><li>ç”¨æˆ·ä½¿ç”¨ä¸­æ²¡æœ‰ç”¨åˆ°çš„ç©ºé—´è¶Šå¤§ï¼Œå†™å…¥æ”¾å¤§è¶Šä½(éœ€è¦æœ‰ Trim æ”¯æŒ)ã€‚</li><li>æŒç»­å†™å…¥å¯ä»¥å‡å°‘å†™å…¥æ”¾å¤§ã€‚ç†è®ºä¸Šæ¥è¯´ï¼ŒæŒç»­å†™å…¥çš„å†™å…¥æ”¾å¤§ä¸º1ï¼Œä½†æ˜¯æŸäº›å› ç´ è¿˜æ˜¯ä¼šå½±å“è¿™ä¸ªæ•°å€¼ã€‚</li><li>éšæœºå†™å…¥å°†ä¼šå¤§å¤§æå‡å†™å…¥æ”¾å¤§ï¼Œå› ä¸ºä¼šå†™å…¥å¾ˆå¤šéè¿ç»­çš„ LBAã€‚</li><li>ç£¨æŸå¹³è¡¡æœºåˆ¶ç›´æ¥æé«˜äº†å†™å…¥æ”¾å¤§</li></ol><h4 id="SSD-è¯»å†™é€Ÿåº¦"><a href="#SSD-è¯»å†™é€Ÿåº¦" class="headerlink" title="SSD è¯»å†™é€Ÿåº¦"></a>SSD è¯»å†™é€Ÿåº¦</h4><p>ä»è½¯ä»¶å¼€å‘äººå‘˜ä½œä¸º SSD çš„ç”¨æˆ·è§’åº¦æ¥è®²ï¼Œé¦–å…ˆéœ€è¦äº†è§£çš„æ˜¯ SSD å’Œæ™®é€š HDD çš„æ€§èƒ½å¯¹æ¯”ï¼Œå¦‚ä¸‹ï¼š</p><img src="/images/2015/disk_27.png"><p><strong>é¡ºåºè¯»å’Œé¡ºåºå†™</strong></p><p>HDD çš„é¡ºåºè¯»é€Ÿåº¦å·®ä¸å¤šä¸ºæœ€æ…¢çš„  SSDçš„ä¸€åŠï¼Œé¡ºåºå†™ç¨å¾®å¥½ç‚¹ï¼Œä½†ä¹Ÿæ¯”å¤§éƒ¨åˆ†æ…¢ä¸€å€å·¦å³çš„é€Ÿåº¦ã€‚</p><p><strong>éšæœºè¯»å’Œéšæœºå†™</strong></p><p>å¯ä»¥çœ‹å‡ºï¼ŒHDDçš„éšæœºè¯»çš„æ€§èƒ½æ˜¯æ™®é€šSSDçš„å‡ ååˆ†ä¹‹ä¸€ï¼Œéšæœºå†™æ€§èƒ½æ›´å·®ã€‚</p><p>å› æ­¤ï¼ŒSSDçš„éšæœºè¯»å’Œå†™æ€§èƒ½è¦è¿œè¿œå¥½äºHDDã€‚</p><h4 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>ä½¿ç”¨ SSD æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å¦‚ä¸‹æƒ…å†µï¼š</p><ul><li>éœ€è¦å……åˆ†åˆ©ç”¨å…¶éšæœºè¯»å†™å¿«çš„ç‰¹æ€§</li><li>å°½å¯èƒ½åœ¨è½¯ä»¶å±‚é¢æ›´æ–°å°å—æ•°æ®ï¼Œå‡è½» SSD å†™æ”¾å¤§é—®é¢˜</li><li>é¿å…é¢‘ç¹çš„æ›´æ–°æ•°æ®ï¼Œå‡è½» SSD å†™æ”¾å¤§åŠå¯¿å‘½å‡å°‘çš„é—®é¢˜ï¼Œå°½å¯èƒ½ä½¿ç”¨è¿½åŠ çš„æ–¹å¼å†™æ•°æ®</li></ul><h3 id="Linuxæµ‹è¯•ç£ç›˜I-Oæ€§èƒ½"><a href="#Linuxæµ‹è¯•ç£ç›˜I-Oæ€§èƒ½" class="headerlink" title="Linuxæµ‹è¯•ç£ç›˜I/Oæ€§èƒ½"></a>Linuxæµ‹è¯•ç£ç›˜I/Oæ€§èƒ½</h3><p>æˆ‘ä»¬å¸¸ç”¨<code>dd</code>å‘½ä»¤æµ‹è¯• Linux ç£ç›˜ I/O æƒ…å†µï¼Œ<code>dd</code>åªæ˜¯æµ‹è¯•é¡ºåºè¯»å†™æ€§èƒ½ã€‚å¯¹äºéšæœºè¯»å†™æ€§èƒ½æµ‹è¯•ï¼Œå¯é‡‡ç”¨<code>FIO</code>å·¥å…·ã€‚</p><h4 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h4><p>ä¸‹è½½å¹¶å®‰è£…</p><pre class=" language-shell"><code class="language-shell">wget http://brick.kernel.dk/snaps/fio-2.2.5.tar.gzyum install libaio-devel gcc  -ytar -zxvf fio-2.2.5.tar.gzcd fio-2.2.5makemake install</code></pre><h4 id="FIOå‚æ•°"><a href="#FIOå‚æ•°" class="headerlink" title="FIOå‚æ•°"></a>FIOå‚æ•°</h4><p>éšæœºè¯»ï¼š</p><pre class=" language-shell"><code class="language-shell">fio -filename=/tmp/test_randread -direct=1 -iodepth 1 -thread -rw=randread -ioengine=psync -bs=16k -size=30G -numjobs=10 -runtime=60 -group_reporting -name=mytest####################è¯´æ˜ï¼šfilename=/dev/sdb1       æµ‹è¯•æ–‡ä»¶åç§°ï¼Œé€šå¸¸é€‰æ‹©éœ€è¦æµ‹è¯•çš„ç›˜çš„dataç›®å½•ã€‚direct=1                 æµ‹è¯•è¿‡ç¨‹ç»•è¿‡æœºå™¨è‡ªå¸¦çš„bufferã€‚ä½¿æµ‹è¯•ç»“æœæ›´çœŸå®ã€‚rw=randwrite             æµ‹è¯•éšæœºå†™çš„I/Orw=randrw                æµ‹è¯•éšæœºå†™å’Œè¯»çš„I/Obs=16k                   å•æ¬¡ioçš„å—æ–‡ä»¶å¤§å°ä¸º16kbsrange=512-2048         åŒä¸Šï¼Œæå®šæ•°æ®å—çš„å¤§å°èŒƒå›´size=5g    æœ¬æ¬¡çš„æµ‹è¯•æ–‡ä»¶å¤§å°ä¸º5gï¼Œä»¥æ¯æ¬¡4kçš„ioè¿›è¡Œæµ‹è¯•ã€‚numjobs=30               æœ¬æ¬¡çš„æµ‹è¯•çº¿ç¨‹ä¸º30.runtime=1000             æµ‹è¯•æ—¶é—´ä¸º1000ç§’ï¼Œå¦‚æœä¸å†™åˆ™ä¸€ç›´å°†5gæ–‡ä»¶åˆ†4kæ¯æ¬¡å†™å®Œä¸ºæ­¢ã€‚ioengine=psync           ioå¼•æ“ä½¿ç”¨pyncæ–¹å¼rwmixwrite=30            åœ¨æ··åˆè¯»å†™çš„æ¨¡å¼ä¸‹ï¼Œå†™å 30%group_reporting          å…³äºæ˜¾ç¤ºç»“æœçš„ï¼Œæ±‡æ€»æ¯ä¸ªè¿›ç¨‹çš„ä¿¡æ¯ã€‚æ­¤å¤–lockmem=1g               åªä½¿ç”¨1gå†…å­˜è¿›è¡Œæµ‹è¯•ã€‚zero_buffers             ç”¨0åˆå§‹åŒ–ç³»ç»Ÿbufferã€‚</code></pre><h4 id="å¸¸ç”¨æµ‹è¯•å‘½ä»¤"><a href="#å¸¸ç”¨æµ‹è¯•å‘½ä»¤" class="headerlink" title="å¸¸ç”¨æµ‹è¯•å‘½ä»¤"></a>å¸¸ç”¨æµ‹è¯•å‘½ä»¤</h4><p>éšæœºè¯»</p><pre class=" language-shell"><code class="language-shell">fio -filename=/tmp/test_randread -direct=1 -iodepth 1 -thread -rw=randread -ioengine=psync -bs=16k -size=30G -numjobs=10 -runtime=600 -group_reporting -name=mytest</code></pre><p>éšæœºå†™</p><pre class=" language-shell"><code class="language-shell">fio -filename=/tmp/test_randread -direct=1 -iodepth 1 -thread -rw=randread -ioengine=psync -bs=16k -size=30G -numjobs=10 -runtime=600 -group_reporting -name=mytest</code></pre><p>é¡ºåºå†™</p><pre class=" language-shell"><code class="language-shell">fio -filename=/data/test_randread -direct=1 -iodepth 1 -thread -rw=write -ioengine=psync -bs=16k -size=30G -numjobs=10 -runtime=600 -group_reporting -name=mytest</code></pre><p>é¡ºåºè¯»</p><pre class=" language-shell"><code class="language-shell">fio -filename=/tmp/test_randread -direct=1 -iodepth 1 -thread -rw=read -ioengine=psync -bs=16k -size=30G -numjobs=10 -runtime=60 -group_reporting -name=mytest</code></pre><p>æ··åˆéšæœºè¯»å†™</p><pre class=" language-shell"><code class="language-shell">fio -filename=/tmp/test_randread -direct=1 -iodepth 1 -thread -rw=randrw -rwmixread=70 -ioengine=psync -bs=16k -size=30G -numjobs=10 -runtime=600 -group_reporting -name=mytest -ioscheduler=noop</code></pre><h4 id="IOPS-å’Œ-ååé‡"><a href="#IOPS-å’Œ-ååé‡" class="headerlink" title="IOPS å’Œ ååé‡"></a><strong>IOPS å’Œ ååé‡</strong></h4><p>ä¸ºä½•éšæœºæ˜¯å…³æ³¨IOPSï¼Œé¡ºåºå…³æ³¨ååé‡ï¼Ÿ</p><p>å› ä¸ºéšæœºè¯»å†™çš„è¯ï¼Œæ¯æ¬¡IOæ“ä½œçš„å¯»å€æ—¶é—´å’Œæ—‹è½¬å»¶æ—¶éƒ½ä¸èƒ½å¿½ç•¥ä¸è®¡ï¼Œè€Œè¿™ä¸¤ä¸ªæ—¶é—´çš„å­˜åœ¨ä¹Ÿå°±é™åˆ¶äº†IOPSçš„å¤§å°ï¼›è€Œé¡ºåºè¯»å†™å¯ä»¥å¿½ç•¥ä¸è®¡å¯»å€æ—¶é—´å’Œæ—‹è½¬å»¶æ—¶ï¼Œä¸»è¦èŠ±è´¹åœ¨æ•°æ®ä¼ è¾“çš„æ—¶é—´ä¸Šã€‚</p><h2 id="åˆ†å±‚è¯¦è§£"><a href="#åˆ†å±‚è¯¦è§£" class="headerlink" title="åˆ†å±‚è¯¦è§£"></a>åˆ†å±‚è¯¦è§£</h2><img src="/images/2015/Linux.IO.stack_v1.0.png"><p>ç¨‹åºå¤„ç†æ–‡ä»¶çš„ç›®çš„å°±æ˜¯æŠŠæ•°æ®å†™åˆ°ç£ç›˜æˆ–è€…ä»ç£ç›˜æŠŠæ•°æ®è¯»å–åˆ°å†…å­˜ä¸­, æˆ‘ä»¬å…ˆç”¨ç¨‹åºå°†æ•°æ®å†™å…¥åˆ°ç£ç›˜ä¸­ï¼š</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span>  <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span>  <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    FILE <span class="token operator">*</span>fp1<span class="token punctuation">,</span> <span class="token operator">*</span>fp2<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">//æµæŒ‡é’ˆ</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//ç¼“å†²åŒº</span>    <span class="token keyword">int</span> n<span class="token punctuation">;</span>                 <span class="token comment" spellcheck="true">//å­˜æ”¾freadå’Œfwriteå‡½æ•°çš„è¿”å›å€¼</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span><span class="token number">2</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>       <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"è¯·è¾“å…¥æ­£ç¡®çš„å‚æ•°\n!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fp1 <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>argv<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"è¯»æºæ–‡ä»¶%så‘ç”Ÿé”™è¯¯\n"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span>argv<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fp2 <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>argv<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"æ‰“å¼€ç›®æ ‡æ–‡ä»¶%så¤±è´¥\n"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span>argv<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> fp1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fwrite</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> fp2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"å†™å…¥æ–‡ä»¶å‘ç”Ÿé”™è¯¯\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ä»æºæ–‡ä»¶%sè¯»æ•°æ®å†™å…¥ç›®æ ‡æ–‡ä»¶%sä¸­å®Œæˆ\n"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span>argv<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span>argv<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//è¾“å‡ºå¯¹åº”çš„æç¤º</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"è¯»æ–‡ä»¶å‘ç”Ÿé”™è¯¯\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">fclose</span><span class="token punctuation">(</span>fp1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fclose</span><span class="token punctuation">(</span>fp2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>æ–‡ä»¶å…ˆå†™å…¥åº”ç”¨ç¨‹åº bufferï¼›è°ƒç”¨<code>fwrite</code>åï¼ŒæŠŠæ•°æ®ä» buffer æ‹·è´åˆ°äº† CLib bufferï¼Œå³Cåº“æ ‡å‡† IO bufferã€‚<code>fwrite</code>è¿”å›åï¼Œæ•°æ®è¿˜åœ¨ CLib bufferï¼Œå¦‚æœè¿™æ—¶å€™è¿›ç¨‹ crash æ‰ï¼Œè¿™äº›æ•°æ®ä¼šä¸¢å¤±ã€‚æ²¡æœ‰å†™åˆ°ç£ç›˜ä»‹è´¨ä¸Šã€‚å½“è°ƒç”¨<code>fclose</code>çš„æ—¶å€™ï¼Œ<code>fclose</code>è°ƒç”¨ä¼šæŠŠè¿™äº›æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä»‹è´¨ä¸Šã€‚é™¤äº†<code>fclose</code>æ–¹æ³•å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªä¸»åŠ¨åˆ·æ–°æ“ä½œ<code>fflush</code>å‡½æ•°ï¼Œä¸è¿‡<code>fflush</code>å‡½æ•°åªæ˜¯æŠŠæ•°æ®ä» CLib buffer æ‹·è´åˆ° page  cache ä¸­ï¼Œå¹¶æ²¡æœ‰åˆ·æ–°åˆ°ç£ç›˜ä¸Šï¼Œä» page cache åˆ·æ–°åˆ°ç£ç›˜ä¸Šå¯ä»¥é€šè¿‡è°ƒç”¨<code>fsync</code>å‡½æ•°å®Œæˆã€‚</p><p>å½“è¿›ç¨‹ crash æ—¶å¦‚æœæ•°æ®è¿˜å¤„åœ¨åº”ç”¨ cache æˆ– CLib cache æ—¶å€™ï¼Œæ•°æ®ä¼šä¸¢å¤±ã€‚å¦‚æœæ•°æ®åœ¨ page cacheï¼Œè¿›ç¨‹crash æ‰ï¼Œå³ä½¿æ•°æ®è¿˜æ²¡æœ‰åˆ°ç¡¬ç›˜ã€‚æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚å½“å†…æ ¸ crash æ‰åï¼Œåªè¦æ•°æ®æ²¡æœ‰åˆ°è¾¾ disk cacheï¼Œæ•°æ®éƒ½ä¼šä¸¢å¤±ã€‚</p><h3 id="Linux-File-I-O"><a href="#Linux-File-I-O" class="headerlink" title="Linux File I/O"></a>Linux File I/O</h3><p>Linux ç»™æˆ‘ä»¬æä¾›å„ç§é£æ ¼çš„ IO æ¥å£æ¥ä½¿ç”¨ï¼š</p><ul><li>Syscalls: <a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="noopener">open</a>, <a href="http://man7.org/linux/man-pages/man2/write.2.html" target="_blank" rel="noopener">write</a>, <a href="http://man7.org/linux/man-pages/man2/read.2.html" target="_blank" rel="noopener">read</a>, <a href="http://man7.org/linux/man-pages/man2/fsync.2.html" target="_blank" rel="noopener">fsync</a>, <a href="http://man7.org/linux/man-pages/man2/sync.2.html" target="_blank" rel="noopener">sync</a>, <a href="http://man7.org/linux/man-pages/man2/close.2.html" target="_blank" rel="noopener">close</a></li><li>Standard I/O: <a href="https://linux.die.net/man/3/fopen" target="_blank" rel="noopener">fopen</a>, <a href="https://linux.die.net/man/3/fwrite" target="_blank" rel="noopener">fwrite</a>, <a href="https://linux.die.net/man/3/fread" target="_blank" rel="noopener">fread</a>, <a href="https://linux.die.net/man/3/fflush" target="_blank" rel="noopener">fflush</a>, <a href="https://linux.die.net/man/3/fclose" target="_blank" rel="noopener">fclose</a></li><li>Vectored I/O: <a href="https://linux.die.net/man/2/writev" target="_blank" rel="noopener">writev</a>, <a href="https://linux.die.net/man/2/readv" target="_blank" rel="noopener">readv</a></li><li>Memory mapped I/O: <a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="noopener">open</a>, <a href="http://man7.org/linux/man-pages/man2/mmap.2.html" target="_blank" rel="noopener">mmap</a>, <a href="http://man7.org/linux/man-pages/man2/msync.2.html" target="_blank" rel="noopener">msync</a>, <a href="http://man7.org/linux/man-pages/man2/munmap.2.html" target="_blank" rel="noopener">munmap</a></li></ul><h4 id="æ ‡å‡†-I-Oï¼ˆStandard-I-Oï¼‰"><a href="#æ ‡å‡†-I-Oï¼ˆStandard-I-Oï¼‰" class="headerlink" title="æ ‡å‡† I/Oï¼ˆStandard I/Oï¼‰"></a>æ ‡å‡† I/Oï¼ˆStandard I/Oï¼‰</h4><h5 id="ç¼“å­˜-I-O"><a href="#ç¼“å­˜-I-O" class="headerlink" title="ç¼“å­˜ I/O"></a>ç¼“å­˜ I/O</h5><img src="/images/2015/disk_28.png" width="400px"><p>å¤§å¤šæ•°æ–‡ä»¶ç³»ç»Ÿçš„é»˜è®¤ I/O æ“ä½œéƒ½æ˜¯ç¼“å­˜ I/Oã€‚åœ¨ Linux çš„ç¼“å­˜ I/O æœºåˆ¶ä¸­ï¼Œæ“ä½œç³»ç»Ÿä¼šå°† I/O çš„æ•°æ®ç¼“å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿçš„é¡µç¼“å­˜ï¼ˆ page cache ï¼‰ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ•°æ®ä¼šå…ˆè¢«æ‹·è´åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„ç¼“å†²åŒºä¸­ï¼Œç„¶åæ‰ä¼šä»æ“ä½œç³»ç»Ÿå†…æ ¸çš„ç¼“å†²åŒºæ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„åœ°å€ç©ºé—´ã€‚ç¼“å­˜ I/O æœ‰ä»¥ä¸‹è¿™äº›ä¼˜ç‚¹ï¼š</p><ul><li>ç¼“å­˜ I/O ä½¿ç”¨äº†æ“ä½œç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šåˆ†ç¦»äº†åº”ç”¨ç¨‹åºç©ºé—´å’Œå®é™…çš„ç‰©ç†è®¾å¤‡ã€‚</li><li>ç¼“å­˜ I/O å¯ä»¥å‡å°‘è¯»ç›˜çš„æ¬¡æ•°ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚</li></ul><p>æ ‡å‡†IOé€šè¿‡ç³»ç»Ÿè°ƒç”¨ <code>read()</code> å’Œ <code>write()</code> æ‰§è¡Œ IO æ“ä½œã€‚å½“åº”ç”¨ç¨‹åºå°è¯•è¯»å–æŸå—æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœè¿™å—æ•°æ®å·²ç»å­˜æ”¾åœ¨äº† Page Cache ä¸­ï¼Œé‚£ä¹ˆè¿™å—æ•°æ®å°±å¯ä»¥ç«‹å³è¿”å›ç»™åº”ç”¨ç¨‹åºï¼Œè€Œä¸éœ€è¦ç»è¿‡å®é™…çš„ç‰©ç†è¯»ç›˜æ“ä½œã€‚å½“ç„¶ï¼Œå¦‚æœæ•°æ®åœ¨åº”ç”¨ç¨‹åºè¯»å–ä¹‹å‰å¹¶æœªè¢«å­˜æ”¾åœ¨é¡µç¼“å­˜ä¸­ï¼Œåˆ™ä¼šè§¦å‘<em>*Page Fault</em> **ç„¶åå°†æ•°æ®ä»ç£ç›˜è¯»åˆ° Page Cache ä¸­å»ã€‚å¯¹äºå†™æ“ä½œæ¥è¯´ï¼Œåº”ç”¨ç¨‹åºä¹Ÿä¼šå°†æ•°æ®å…ˆå†™åˆ° Page Cache ä¸­å»ï¼Œæ•°æ®æ˜¯å¦è¢«ç«‹å³å†™åˆ°ç£ç›˜ä¸Šå»å–å†³äºåº”ç”¨ç¨‹åºæ‰€é‡‡ç”¨çš„å†™æ“ä½œæœºåˆ¶ï¼šå¦‚æœç”¨æˆ·é‡‡ç”¨çš„æ˜¯åŒæ­¥å†™æœºåˆ¶ï¼ˆ synchronous writes ï¼‰, é‚£ä¹ˆæ•°æ®ä¼šç«‹å³è¢«å†™å›åˆ°ç£ç›˜ä¸Šï¼Œåº”ç”¨ç¨‹åºä¼šä¸€ç›´ç­‰åˆ°æ•°æ®è¢«å†™å®Œä¸ºæ­¢ï¼›å¦‚æœç”¨æˆ·é‡‡ç”¨çš„æ˜¯å»¶è¿Ÿå†™æœºåˆ¶ï¼ˆ deferred writes ï¼‰ï¼Œé‚£ä¹ˆåº”ç”¨ç¨‹åºå°±å®Œå…¨ä¸éœ€è¦ç­‰åˆ°æ•°æ®å…¨éƒ¨è¢«å†™å›åˆ°ç£ç›˜ï¼Œæ•°æ®åªè¦è¢«å†™åˆ° Page Cache ä¸­å»å°±å¯ä»¥äº†ã€‚åœ¨å»¶è¿Ÿå†™æœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œæ“ä½œç³»ç»Ÿä¼šå®šæœŸåœ°å°†æ”¾åœ¨ Page Cache ä¸­çš„æ•°æ®åˆ·åˆ°ç£ç›˜ä¸Šã€‚ä¸å¼‚æ­¥å†™æœºåˆ¶ï¼ˆ asynchronous writes ï¼‰ä¸åŒçš„æ˜¯ï¼Œå»¶è¿Ÿå†™æœºåˆ¶åœ¨æ•°æ®å®Œå…¨å†™åˆ°ç£ç›˜ä¸Šçš„æ—¶å€™ä¸ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºï¼Œè€Œå¼‚æ­¥å†™æœºåˆ¶åœ¨æ•°æ®å®Œå…¨å†™åˆ°ç£ç›˜ä¸Šçš„æ—¶å€™æ˜¯ä¼šè¿”å›ç»™åº”ç”¨ç¨‹åºçš„ã€‚æ‰€ä»¥å»¶è¿Ÿå†™æœºåˆ¶æœ¬èº«æ˜¯å­˜åœ¨æ•°æ®ä¸¢å¤±çš„é£é™©çš„ï¼Œè€Œå¼‚æ­¥å†™æœºåˆ¶åˆ™ä¸ä¼šæœ‰è¿™æ–¹é¢çš„æ‹…å¿ƒã€‚</p><p><strong>ç¼“å­˜ I/O çš„ç¼ºç‚¹</strong></p><p>åœ¨ç¼“å­˜ I/O æœºåˆ¶ä¸­ï¼ŒDMA æ–¹å¼å¯ä»¥å°†æ•°æ®ç›´æ¥ä»ç£ç›˜è¯»åˆ°é¡µç¼“å­˜ä¸­ï¼Œæˆ–è€…å°†æ•°æ®ä»é¡µç¼“å­˜ç›´æ¥å†™å›åˆ°ç£ç›˜ä¸Šï¼Œè€Œä¸èƒ½ç›´æ¥åœ¨åº”ç”¨ç¨‹åºåœ°å€ç©ºé—´å’Œç£ç›˜ä¹‹é—´è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œè¿™æ ·çš„è¯ï¼Œæ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­éœ€è¦åœ¨åº”ç”¨ç¨‹åºåœ°å€ç©ºé—´å’Œé¡µç¼“å­˜ä¹‹é—´è¿›è¡Œå¤šæ¬¡æ•°æ®æ‹·è´æ“ä½œï¼Œè¿™äº›æ•°æ®æ‹·è´æ“ä½œæ‰€å¸¦æ¥çš„ CPU ä»¥åŠå†…å­˜å¼€é”€æ˜¯éå¸¸å¤§çš„ã€‚</p><p>å¯¹äºæŸäº›ç‰¹æ®Šçš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œé¿å¼€æ“ä½œç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºè€Œç›´æ¥åœ¨åº”ç”¨ç¨‹åºåœ°å€ç©ºé—´å’Œç£ç›˜ä¹‹é—´ä¼ è¾“æ•°æ®ä¼šæ¯”ä½¿ç”¨æ“ä½œç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºè·å–æ›´å¥½çš„æ€§èƒ½ã€‚</p><h5 id="ç›´æ¥-I-O"><a href="#ç›´æ¥-I-O" class="headerlink" title="ç›´æ¥ I/O"></a>ç›´æ¥ I/O</h5><img src="/images/2015/disk_29.png" width="400px"><p>å‡¡æ˜¯é€šè¿‡ç›´æ¥ I/O æ–¹å¼è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œæ•°æ®å‡ç›´æ¥åœ¨ç”¨æˆ·åœ°å€ç©ºé—´çš„ç¼“å†²åŒºå’Œç£ç›˜ä¹‹é—´ç›´æ¥è¿›è¡Œä¼ è¾“ï¼Œå®Œå…¨ä¸éœ€è¦é¡µç¼“å­˜çš„æ”¯æŒã€‚æ“ä½œç³»ç»Ÿå±‚æä¾›çš„ç¼“å­˜å¾€å¾€ä¼šä½¿åº”ç”¨ç¨‹åºåœ¨è¯»å†™æ•°æ®çš„æ—¶å€™è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œä½†æ˜¯å¯¹äºæŸäº›ç‰¹æ®Šçš„åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚è¯´æ•°æ®åº“ç³»ç»Ÿï¼Œå®ƒä»¬æ›´å€¾å‘äºé€‰æ‹©ä»–ä»¬è‡ªå·±çš„ç¼“å­˜æœºåˆ¶ï¼Œå› ä¸ºæ•°æ®åº“ç³»ç»Ÿå¾€å¾€æ¯”æ“ä½œç³»ç»Ÿæ›´äº†è§£æ•°æ®åº“ä¸­å­˜æ”¾çš„æ•°æ®ï¼Œæ•°æ®åº“ç³»ç»Ÿå¯ä»¥æä¾›ä¸€ç§æ›´åŠ æœ‰æ•ˆçš„ç¼“å­˜æœºåˆ¶æ¥æé«˜æ•°æ®åº“ä¸­æ•°æ®çš„å­˜å–æ€§èƒ½ã€‚</p><p>è¦åœ¨å—è®¾å¤‡ä¸­æ‰§è¡Œç›´æ¥ I/Oï¼Œè¿›ç¨‹å¿…é¡»åœ¨æ‰“å¼€æ–‡ä»¶çš„æ—¶å€™è®¾ç½®å¯¹æ–‡ä»¶çš„è®¿é—®æ¨¡å¼ä¸º <code>O_DIRECT</code>ï¼Œè¿™æ ·å°±ç­‰äºå‘Šè¯‰æ“ä½œç³»ç»Ÿè¿›ç¨‹åœ¨æ¥ä¸‹æ¥ä½¿ç”¨ <code>read()</code> æˆ–è€… <code>write()</code> ç³»ç»Ÿè°ƒç”¨å»è¯»å†™æ–‡ä»¶çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯ç›´æ¥ I/O æ–¹å¼ï¼Œæ‰€ä¼ è¾“çš„æ•°æ®å‡ä¸ç»è¿‡æ“ä½œç³»ç»Ÿå†…æ ¸ç¼“å­˜ç©ºé—´ã€‚ä½¿ç”¨ç›´æ¥ I/O è¯»å†™æ•°æ®å¿…é¡»è¦æ³¨æ„ç¼“å†²åŒºå¯¹é½ï¼ˆ buffer alignment ï¼‰ä»¥åŠç¼“å†²åŒºçš„å¤§å°çš„é—®é¢˜ï¼Œå³å¯¹åº” <code>read()</code> ä»¥åŠ <code>write()</code> ç³»ç»Ÿè°ƒç”¨çš„ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå‚æ•°ã€‚è¿™é‡Œè¾¹è¯´çš„å¯¹é½æŒ‡çš„æ˜¯æ–‡ä»¶ç³»ç»Ÿå—å¤§å°çš„å¯¹é½ï¼Œç¼“å†²åŒºçš„å¤§å°ä¹Ÿå¿…é¡»æ˜¯è¯¥å—å¤§å°çš„æ•´æ•°å€ã€‚</p><p><strong>ç›´æ¥ I/O çš„ä¼˜ç‚¹</strong></p><p>ç›´æ¥ I/O æœ€ä¸»è¦çš„ä¼˜ç‚¹å°±æ˜¯é€šè¿‡å‡å°‘æ“ä½œç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºå’Œåº”ç”¨ç¨‹åºåœ°å€ç©ºé—´çš„æ•°æ®æ‹·è´æ¬¡æ•°ï¼Œé™ä½äº†å¯¹æ–‡ä»¶è¯»å–å’Œå†™å…¥æ—¶æ‰€å¸¦æ¥çš„ CPU çš„ä½¿ç”¨ä»¥åŠå†…å­˜å¸¦å®½çš„å ç”¨ã€‚è¿™å¯¹äºæŸäº›ç‰¹æ®Šçš„åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚è‡ªç¼“å­˜åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œä¸å¤±ä¸ºä¸€ç§å¥½çš„é€‰æ‹©ã€‚å¦‚æœè¦ä¼ è¾“çš„æ•°æ®é‡å¾ˆå¤§ï¼Œä½¿ç”¨ç›´æ¥ I/O çš„æ–¹å¼è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œè€Œä¸éœ€è¦æ“ä½œç³»ç»Ÿå†…æ ¸åœ°å€ç©ºé—´æ‹·è´æ•°æ®æ“ä½œçš„å‚ä¸ï¼Œè¿™å°†ä¼šå¤§å¤§æé«˜æ€§èƒ½ã€‚<code>O_DIRECT</code> ç‰¹åˆ«é€‚ç”¨äºæ•°æ®åº“ç³»ç»Ÿè¿™ç±»åº”ç”¨ã€‚</p><p><strong>ç›´æ¥ I/O æ½œåœ¨å¯èƒ½å­˜åœ¨çš„é—®é¢˜</strong></p><p>ç›´æ¥ I/O å¹¶ä¸ä¸€å®šæ€»èƒ½æä¾›ä»¤äººæ»¡æ„çš„æ€§èƒ½ä¸Šçš„é£è·ƒã€‚è®¾ç½®ç›´æ¥ I/O çš„å¼€é”€éå¸¸å¤§ï¼Œè€Œç›´æ¥ I/O åˆä¸èƒ½æä¾›ç¼“å­˜ I/O çš„ä¼˜åŠ¿ã€‚ç¼“å­˜ I/O çš„è¯»æ“ä½œå¯ä»¥ä»é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨ä¸­è·å–æ•°æ®ï¼Œè€Œç›´æ¥ I/O çš„è¯»æ•°æ®æ“ä½œä¼šé€ æˆç£ç›˜çš„åŒæ­¥è¯»ï¼Œè¿™ä¼šå¸¦æ¥æ€§èƒ½ä¸Šçš„å·®å¼‚ , å¹¶ä¸”å¯¼è‡´è¿›ç¨‹éœ€è¦è¾ƒé•¿çš„æ—¶é—´æ‰èƒ½æ‰§è¡Œå®Œï¼›å¯¹äºå†™æ•°æ®æ“ä½œæ¥è¯´ï¼Œä½¿ç”¨ç›´æ¥ I/O éœ€è¦ <code>write()</code> ç³»ç»Ÿè°ƒç”¨åŒæ­¥æ‰§è¡Œï¼Œå¦åˆ™åº”ç”¨ç¨‹åºå°†ä¼šä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰èƒ½å¤Ÿå†æ¬¡ä½¿ç”¨å®ƒçš„ I/O ç¼“å†²åŒºã€‚ä¸ç›´æ¥ I/O è¯»æ“ä½œç±»ä¼¼çš„æ˜¯ï¼Œç›´æ¥ I/O å†™æ“ä½œä¹Ÿä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå…³é—­ç¼“æ…¢ã€‚æ‰€ä»¥ï¼Œåº”ç”¨ç¨‹åºä½¿ç”¨ç›´æ¥ I/O è¿›è¡Œæ•°æ®ä¼ è¾“çš„æ—¶å€™é€šå¸¸ä¼šå’Œä½¿ç”¨å¼‚æ­¥ I/O ç»“åˆä½¿ç”¨ã€‚</p><blockquote><p>å¼•ç”¨Linusçš„è¯ï¼šâ€ The thing that has always disturbed me about O_DIRECT is that the whole interface is just stupid, and was probably designed by a deranged monkey on some serious mind-controlling substances.â€â€”Linusï¼ˆO_DIRECT å°±æ˜¯å‚»é€¼è®¾è®¡ï¼‰</p></blockquote><p><strong>å®ä¾‹</strong></p><ol><li>æ‰“å¼€æ–‡ä»¶æ—¶ï¼Œæ·»åŠ <code>O_DIRECT</code>å‚æ•°ï¼Œéœ€è¦å®šä¹‰<code>_GNU_SOURCE</code>ï¼Œå¦åˆ™æ‰¾ä¸åˆ°<code>O_DIRECT</code>å®å®šä¹‰</li></ol><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> _GNU_SOURCE</span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test.out"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_DIRECT<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ol start="2"><li><p>è¯»å†™æ“ä½œçš„ä¼ è¾“æ•°æ®å¤§å°å’Œç¼“å†²åŒºåœ°å€éƒ½éœ€è¦æŒ‰ç…§ä¸€å®šçš„è§„åˆ™å¯¹é½,å¯¹äºä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå’Œå†…æ ¸ç‰ˆæœ¬ï¼Œéœ€è¦çš„å¯¹é½è¾¹ç•Œä¸åŒï¼Œä¹Ÿæ²¡æœ‰ç»Ÿä¸€çš„æ¥å£å¯ä»¥è·å–åˆ°è¯¥è¾¹ç•Œå€¼ã€‚</p><ul><li><p>å¯¹äº kernel 2.4 ç‰ˆæœ¬ï¼šä¼ è¾“å¤§å°å’Œç¼“å†²åŒºåœ°å€å‡éœ€è¦æŒ‰ç…§è®¿é—®æ–‡ä»¶ç³»ç»Ÿçš„é€»è¾‘å—å¤§å°å¯¹é½ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿçš„å—å¤§å°æ˜¯4Kï¼Œbuffer åœ°å€éœ€è¦æŒ‰ç…§4Kå¯¹é½ï¼Œéœ€è¦è¯»å†™4Kå€æ•°çš„æ•°æ®</p></li><li><p>å¯¹äº kernel 2.6 ç‰ˆæœ¬ï¼šä¼ è¾“å¤§å°å’Œç¼“å†²åŒºåœ°å€æŒ‰ç…§ç›®æ ‡å­˜å‚¨è®¾å¤‡çš„æ‰‡åŒºå¤§å°ï¼ˆä¸€èˆ¬512ï¼‰å¯¹é½</p></li></ul><p>å¯ä½¿ç”¨<code>memalign ï¼ˆmalloc.hï¼‰</code>æ¥åˆ†é…æŒ‡å®šåœ°å€å¯¹é½çš„èµ„æºæ¥å£ï¼š<code>void *memalign(size_t boundary, size_t size)</code>;</p></li></ol><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> _GNU_SOURCE</span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">char</span> hello_str<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hello World!"</span><span class="token punctuation">;</span>        <span class="token keyword">void</span> <span class="token operator">*</span>write_buffer<span class="token punctuation">;</span>        <span class="token keyword">void</span> <span class="token operator">*</span>read_buffer<span class="token punctuation">;</span>        <span class="token keyword">int</span> fd<span class="token punctuation">;</span>         <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test.out"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_DIRECT<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed to open file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> fd<span class="token punctuation">;</span>         <span class="token punctuation">}</span>           <span class="token comment" spellcheck="true">/* allocate a 1024 bytes buffer */</span>        write_buffer <span class="token operator">=</span> <span class="token function">memalign</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// align by 512</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>write_buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed to alloc write buffer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>                <span class="token keyword">goto</span> bad_write_buffer<span class="token punctuation">;</span>        <span class="token punctuation">}</span>           <span class="token function">memcpy</span><span class="token punctuation">(</span>write_buffer<span class="token punctuation">,</span> hello_str<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>hello_str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> write_buffer<span class="token punctuation">,</span> <span class="token number">512</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed to write file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token keyword">goto</span> bad_write<span class="token punctuation">;</span>        <span class="token punctuation">}</span>           <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> SEEK_SET<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// read  previous write data</span>        read_buffer <span class="token operator">=</span> <span class="token function">memalign</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>read_buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed to alloc read buffer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>                <span class="token keyword">goto</span> bad_read_buffer<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> read_buffer<span class="token punctuation">,</span> <span class="token number">512</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed to read file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> bad_read<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read from file : %s\n"</span><span class="token punctuation">,</span> read_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>bad_read<span class="token punctuation">:</span>        <span class="token function">free</span><span class="token punctuation">(</span>read_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>bad_read_buffer<span class="token punctuation">:</span>bad_write<span class="token punctuation">:</span>        <span class="token function">free</span><span class="token punctuation">(</span>write_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>bad_write_buffer<span class="token punctuation">:</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> ret<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>O_DIRECTçš„è¯¦ç»†æè¿°ï¼Œå¯ä»¥çœ‹linux openç³»ç»Ÿè°ƒç”¨çš„<a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="noopener">æ–‡æ¡£</a></p><h4 id="AIO"><a href="#AIO" class="headerlink" title="AIO"></a>AIO</h4><p>Asynchronous I/O å¸®åŠ©ç”¨æˆ·ç¨‹åºæé«˜ CPU å’Œ IO è®¾å¤‡çš„åˆ©ç”¨ç‡å’Œæé«˜ç¨‹åºæ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜è´Ÿè½½çš„IOæ“ä½œä¸‹ã€‚æ¯”å¦‚å„ç§ä»£ç†æœåŠ¡å™¨ï¼Œæ•°æ®åº“ï¼ŒæµæœåŠ¡å™¨ç­‰ç­‰ã€‚</p><p>å¾ˆå¤šäººä¼šå°† AIO ç†è§£æˆç£ç›˜ IO çš„å¼‚æ­¥æ–¹æ¡ˆï¼Œä¼šå°† AIO ç‹­éš˜åŒ–ä¸ºç±» epoll æ¥å£åœ¨ç£ç›˜ IO çš„ç‰¹æ®ŠåŒ–ï¼Œå…¶å® AIO åº”è¯¥æ˜¯æ¨ªæ¶äºæ•´ä¸ªå†…æ ¸çš„æ¥å£ï¼Œå®ƒæŠŠæ‰€æœ‰çš„ IO åŒ…æ‹¬(æœ¬åœ°è®¾å¤‡ï¼Œç½‘ç»œï¼Œç®¡é“ç­‰)ä»¥ç»Ÿä¸€çš„å¼‚æ­¥æ¥å£æä¾›ç»™ç”¨æˆ·ç¨‹åºï¼Œæ¯ä¸ªå­ç³»ç»Ÿéƒ½é’ˆå¯¹æ¥å£å®ç°è‡ªå·±çš„å¼‚æ­¥æ–¹æ¡ˆï¼Œè€ŒåŒæ­¥IO(Synchronous IO)åªæ˜¯åœ¨å†…æ ¸å†…éƒ¨çš„â€AIO+Blockingâ€.</p><img src="/images/2015/disk_31.png" width="400px"><h5 id="Linux-Native-Aio"><a href="#Linux-Native-Aio" class="headerlink" title="Linux Native Aio"></a>Linux Native Aio</h5><p>ç”±æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„AIOï¼Œå¤´æ–‡ä»¶ä¸º<code>&lt;linux/aio_abi.h&gt;</code>ã€‚Native Aio æ˜¯çœŸæ­£çš„ AIOï¼Œå®Œå…¨éé˜»å¡å¼‚æ­¥çš„ï¼Œè€Œä¸æ˜¯ç”¨é˜»å¡IOå’Œçº¿ç¨‹æ± æ¨¡æ‹Ÿã€‚ä¸»è¦çš„å‡ ä¸ªç³»ç»Ÿè°ƒç”¨ä¸º<code>io_submit/io_setup/io_getevents</code>ã€‚</p><ul><li><strong>ä¼˜ç‚¹</strong>ï¼šç”±æ“ä½œç³»ç»Ÿæä¾›ï¼Œè¯»å†™æ“ä½œå¯ä»¥ç›´æ¥æŠ•é€’åˆ°ç¡¬ä»¶ï¼Œä¸ä¼šæµªè´¹ CPUã€‚</li><li><strong>ç¼ºç‚¹</strong>ï¼šä»…æ”¯æŒ Linuxï¼Œå¿…é¡»ä½¿ç”¨ Direct_IOï¼Œæ‰€ä»¥æ— æ³•åˆ©ç”¨åˆ°æ“ä½œç³»ç»Ÿçš„ Page Cacheã€‚å¯¹äºå†™æ–‡ä»¶æ¥è¯´native aio çš„ä½œç”¨ä¸å¤§ï¼Œåº”ä¸ºæœ¬èº«å†™æ–‡ä»¶å°±æ˜¯å…ˆå†™åˆ° PageCache ä¸Šï¼Œç›´æ¥è¿”å›ï¼Œæ²¡æœ‰ IO ç­‰å¾…ã€‚</li></ul><h5 id="GCC-AIO"><a href="#GCC-AIO" class="headerlink" title="GCC AIO"></a>GCC AIO</h5><p>gcc éµå¾ª posix æ ‡å‡†å®ç°äº†AIOã€‚å¤´æ–‡ä»¶ä¸º <code>&lt;aio.h&gt;</code>ï¼Œæ”¯æŒ FreeBSD/Linuxã€‚æ˜¯é€šè¿‡é˜»å¡ IO+çº¿ç¨‹æ± æ¥å®ç°çš„ã€‚ä¸»è¦çš„å‡ ä¸ªå‡½æ•°æ˜¯<code>aio_read/aio_write/aio_return</code>ã€‚</p><ul><li><strong>ä¼˜ç‚¹</strong>ï¼šæ”¯æŒå¹³å°å¤šï¼Œå…¼å®¹æ€§å¥½ï¼Œæ— éœ€ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼Œé˜»å¡ IO å¯ä»¥åˆ©ç”¨åˆ°æ“ä½œç³»ç»Ÿçš„ Page Cacheã€‚</li><li><strong>ç¼ºç‚¹</strong>ï¼šæ®è¯´æœ‰ä¸€äº› bug å’Œé™·é˜±ï¼Œä¸€ç›´æœªè§£å†³ã€‚</li></ul><h5 id="Libeio"><a href="#Libeio" class="headerlink" title="Libeio"></a>Libeio</h5><p>libev çš„ä½œè€…å¼€å‘çš„ AIO å®ç°ï¼Œä¸ gcc aio ç±»ä¼¼ä¹Ÿæ˜¯ä½¿ç”¨é˜»å¡IO+çº¿ç¨‹æ± å®ç°çš„ã€‚ä¼˜ç‚¹ä¸ç¼ºç‚¹å‚è§ä¸Šé¢ã€‚å®ƒä¸gcc aio çš„ä¸åŒä¹‹å¤„ï¼Œä»£ç æ›´ç®€æ´ï¼Œæ‰€ä»¥ bug å°‘æ›´å®‰å…¨ç¨³å®šã€‚ä½†è¿™æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œä½ çš„ä»£ç éœ€è¦ä¾èµ– libeioã€‚</p><h4 id="Vectored-IO"><a href="#Vectored-IO" class="headerlink" title="Vectored IO"></a>Vectored IO</h4><img src="/images/2015/disk_32.png" width="400px"><p> Vectored IOï¼ˆä¹Ÿç§°ä¸ºScatter / Gatherï¼‰æ˜¯ä¸€ç§å¯ä»¥åœ¨å•æ¬¡ç³»ç»Ÿè°ƒç”¨ä¸­å¯¹å¤šä¸ªç¼“å†²åŒºè¾“å…¥è¾“å‡ºçš„æ–¹æ³•ï¼Œå¯ä»¥æŠŠå¤šä¸ªç¼“å†²åŒºçš„æ•°æ®å†™åˆ°å•ä¸ªæ•°æ®æµï¼Œä¹Ÿå¯ä»¥æŠŠå•ä¸ªæ•°æ®æµè¯»åˆ°å¤šä¸ªç¼“å†²åŒºä¸­ã€‚å…¶å‘½åçš„åŸå› åœ¨äºæ•°æ®ä¼šè¢«åˆ†æ•£åˆ°æŒ‡å®šç¼“å†²åŒºå‘é‡ï¼Œæˆ–è€…ä»æŒ‡å®šç¼“å†²åŒºå‘é‡ä¸­èšé›†æ•°æ®ã€‚è¿™ç§è¾“å…¥è¾“å‡ºæ–¹æ³•ä¹Ÿç§°ä¸ºå‘é‡ I/Oï¼ˆvector I/Oï¼‰ã€‚ä¸ä¹‹ä¸åŒï¼Œæ ‡å‡†è¯»å†™ç³»ç»Ÿè°ƒç”¨ï¼ˆreadï¼Œwriteï¼‰å¯ä»¥ç§°ä¸ºçº¿æ€§I/Oï¼ˆlinear I/Oï¼‰ã€‚</p><p>ä¸çº¿æ€§ I/O ç›¸æ¯”ï¼Œåˆ†æ•£/èšé›† I/O æœ‰å¦‚ä¸‹å‡ ä¸ªä¼˜åŠ¿ï¼š</p><ol><li><p>ç¼–ç æ¨¡å¼æ›´è‡ªç„¶</p><ul><li>å¦‚æœæ•°æ®æœ¬èº«æ˜¯åˆ†æ®µçš„ï¼ˆæ¯”å¦‚é¢„å®šä¹‰çš„ç»“æ„ä½“çš„å˜é‡ï¼‰ï¼Œå‘é‡ I/O æä¾›äº†ç›´è§‚çš„æ•°æ®å¤„ç†æ–¹å¼ã€‚</li></ul></li><li><p>æ•ˆç‡æ›´é«˜</p><ul><li>å•ä¸ªå‘é‡ I/O æ“ä½œå¯ä»¥å–ä»£å¤šä¸ªçº¿æ€§ I/O æ“ä½œã€‚</li></ul></li><li><p>æ€§èƒ½æ›´å¥½</p><ul><li>é™¤äº†å‡å°‘äº†å‘èµ·çš„ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°ï¼Œé€šè¿‡å†…éƒ¨ä¼˜åŒ–ï¼Œå‘é‡ I/O å¯ä»¥æ¯”çº¿æ€§ I/O æä¾›æ›´å¥½çš„æ€§èƒ½ã€‚</li></ul></li><li><p>æ”¯æŒåŸå­æ€§</p><ul><li>å’Œå¤šä¸ªçº¿æ€§ I/O æ“ä½œä¸åŒï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‰§è¡Œå•ä¸ªå‘é‡ I/O æ“ä½œï¼Œé¿å…äº†å’Œå…¶ä»–è¿›ç¨‹äº¤å‰æ“ä½œçš„é£é™©ã€‚</li></ul></li></ol><p>Linuxå®ç°äº† POSIX 1003.1-2001 ä¸­å®šä¹‰çš„ä¸€ç»„å®ç° Scatter / Gather I/O æœºåˆ¶çš„ç³»ç»Ÿè°ƒç”¨ã€‚è¯¥å®ç°æ»¡è¶³äº†ä¸Šé¢æ‰€è¿°çš„æ‰€æœ‰ç‰¹æ€§ã€‚</p><p><code>readv()</code> å‡½æ•°ä»æ–‡ä»¶æè¿°ç¬¦ fd ä¸­è¯»å– count ä¸ªæ®µ (segment) (ä¸€ä¸ªæ®µå³ä¸€ä¸ª iovec ç»“æ„ä½“ï¼‰åˆ°å‚æ•° iov æ‰€æŒ‡å®šçš„ç¼“å†²åŒºä¸­ï¼š</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/uio.h></span></span>ssize_t <span class="token function">readv</span> <span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">struct</span> iovec <span class="token operator">*</span>iov<span class="token punctuation">,</span><span class="token keyword">int</span> count<span class="token punctuation">)</span></code></pre><p>write() å‡½æ•°ä»å‚æ•° iov æŒ‡å®šçš„ç¼“å†²åŒºä¸­è¯»å– count ä¸ªæ®µçš„æ•°æ®ï¼Œå¹¶å†™å…¥ fd ä¸­ï¼š</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/uio.h></span></span>ssize_t <span class="token function">writev</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">struct</span> iovec <span class="token operator">*</span>iov<span class="token punctuation">,</span><span class="token keyword">int</span> count<span class="token punctuation">)</span></code></pre><p> é™¤äº†åŒæ—¶æ“ä½œå¤šä¸ªç¼“å†²åŒºå¤–ï¼Œreadv() å‡½æ•°å’Œ writev() å‡½æ•°çš„åŠŸèƒ½åˆ†åˆ«å’Œ read()ï¼Œwrite() çš„åŠŸèƒ½ä¸€è‡´ã€‚</p><p>æ¯ä¸ª iovec ç»“æ„ä½“æè¿°ä¸€ä¸ªç‹¬ç«‹çš„ï¼Œç‰©ç†ä¸è¿ç»­çš„ç¼“å†²åŒºï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºæ®µ(segment)ï¼š</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/uio.h></span></span><span class="token keyword">struct</span> iovec <span class="token punctuation">{</span>   <span class="token keyword">void</span>      <span class="token operator">*</span>iov_base<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* pointer to start of buffer */</span>   size_t   iov_len<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* size of buffer in bytes */</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>ä¸€ç»„æ®µçš„é›†åˆç§°ä¸ºå‘é‡(vector)ã€‚æ¯ä¸ªæ®µæè¿°äº†å†…å­˜ä¸­æ‰€è¦è¯»å†™çš„ç¼“å†²åŒºçš„åœ°å€å’Œé•¿åº¦ã€‚readv() å‡½æ•°åœ¨å¤„ç†ä¸‹ä¸ªç¼“å†²åŒºä¹‹å‰ï¼Œä¼šå¡«æ»¡å½“å‰ç¼“å†²åŒºçš„ iov_len ä¸ªå­—èŠ‚ã€‚write() å‡½æ•°åœ¨å¤„ç†ä¸‹ä¸ªç¼“å†²åŒºä¹‹å‰ï¼Œä¼šæŠŠå½“å‰ç¼“å†²åŒºæ‰€æœ‰ iov_len ä¸ªå­—èŠ‚æ•°æ®è¾“å‡ºï¼Œè¿™ä¸¤ä¸ªå‡½æ•°éƒ½ä¼šé¡ºåºå¤„ç†å‘é‡ä¸­çš„æ®µï¼Œä» iov[0] å¼€å§‹ï¼Œæ¥ç€æ˜¯ iov[1]ï¼Œä¸€ç›´åˆ° iov[count - 1] ã€‚</p><p>ç›®å‰åªæœ‰å¾ˆå°‘çš„æ•°æ®åº“ä½¿ç”¨ Vectored IOï¼Œæ¯•ç«Ÿå®ƒä»¬è¦å¤„ç†å¾ˆå¤šæ–‡ä»¶ï¼Œå…³æ³¨å»¶æ—¶ï¼ŒæŒ‰å—è®¿é—®å’Œç¼“å­˜ï¼Œè€Œåˆ†æå‹æˆ–åˆ—å¼æ•°æ®åº“æ¯”è¾ƒé€‚åˆä½¿ç”¨ Vectored IOï¼Œæ¯”å¦‚ï¼š <a href="https://github.com/apache/arrow/blob/master/java/memory/src/main/java/io/netty/buffer/ArrowBuf.java#L26-L27" target="_blank" rel="noopener">Apache Arrow</a>ã€‚</p><h4 id="Memory-Mapping"><a href="#Memory-Mapping" class="headerlink" title="Memory Mapping"></a>Memory Mapping</h4><img src="/images/2015/disk_30.png" width="400px"><p> Linux ä¸­å†…å­˜åŒºåŸŸï¼ˆ memory region ï¼‰æ˜¯å¯ä»¥è·Ÿä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶æˆ–è€…å—è®¾å¤‡æ–‡ä»¶çš„æŸä¸€ä¸ªéƒ¨åˆ†å…³è”èµ·æ¥çš„ï¼Œè‹¥è¿›ç¨‹è¦è®¿é—®å†…å­˜é¡µä¸­æŸä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šå°†è®¿é—®è¯¥å†…å­˜åŒºåŸŸçš„æ“ä½œè½¬æ¢ä¸ºç›¸åº”çš„è®¿é—®æ–‡ä»¶çš„æŸä¸ªå­—èŠ‚çš„æ“ä½œã€‚Linux ä¸­æä¾›äº†ç³»ç»Ÿè°ƒç”¨ <code>mmap()</code> æ¥å®ç°è¿™ç§æ–‡ä»¶è®¿é—®æ–¹å¼ã€‚ä¸æ ‡å‡†çš„è®¿é—®æ–‡ä»¶çš„æ–¹å¼ç›¸æ¯”ï¼Œå†…å­˜æ˜ å°„æ–¹å¼å¯ä»¥å‡å°‘æ ‡å‡†è®¿é—®æ–‡ä»¶æ–¹å¼ä¸­ <code>read()</code> ç³»ç»Ÿè°ƒç”¨æ‰€å¸¦æ¥çš„æ•°æ®æ‹·è´æ“ä½œï¼Œå³å‡å°‘æ•°æ®åœ¨ç”¨æˆ·åœ°å€ç©ºé—´å’Œæ“ä½œç³»ç»Ÿå†…æ ¸åœ°å€ç©ºé—´ä¹‹é—´çš„æ‹·è´æ“ä½œã€‚æ˜ å°„é€šå¸¸é€‚ç”¨äºè¾ƒå¤§èŒƒå›´ï¼Œå¯¹äºç›¸åŒé•¿åº¦çš„æ•°æ®æ¥è®²ï¼Œæ˜ å°„æ‰€å¸¦æ¥çš„å¼€é”€è¿œè¿œä½äº CPU æ‹·è´æ‰€å¸¦æ¥çš„å¼€é”€ã€‚å½“å¤§é‡æ•°æ®éœ€è¦ä¼ è¾“çš„æ—¶å€™ï¼Œé‡‡ç”¨å†…å­˜æ˜ å°„æ–¹å¼å»è®¿é—®æ–‡ä»¶ä¼šè·å¾—æ¯”è¾ƒå¥½çš„æ•ˆç‡ã€‚æ•°æ®åº“å¼•æ“ä¸­å¤§é‡é‡‡ç”¨ mmap çš„æ–¹å¼ã€‚</p><p>ç”¨æˆ·è°ƒç”¨<code>mmap</code>å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜æ—¶ï¼Œå†…æ ¸è¿›è¡Œä¸€ç³»åˆ—çš„å‚æ•°æ£€æŸ¥ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„<code>vma</code>ï¼Œç„¶åç»™è¯¥<code>vma</code>ç»‘å®š<code>vma_ops</code>ã€‚å½“ç”¨æˆ·è®¿é—®åˆ°<code>mmap</code>å¯¹åº”çš„å†…å­˜æ—¶ï¼ŒCPUä¼šè§¦å‘<code>page fault</code>ï¼Œåœ¨<code>page fault</code>å›è°ƒä¸­ï¼Œå°†ç”³è¯·<code>pagecache</code>ä¸­çš„åŒ¿åé¡µï¼Œè¯»å–æ–‡ä»¶åˆ°å…¶ç‰©ç†å†…å­˜ä¸­ï¼Œç„¶åå°†<code>pagecache</code>ä¸­æ‰€å±çš„ç‰©ç†é¡µä¸ç”¨æˆ·è¿›ç¨‹çš„<code>vma</code>è¿›è¡Œæ˜ å°„ã€‚</p><p>å…¶æ•´ä¸ªå†…æ ¸é€»è¾‘æµç¨‹å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤º:</p><img src="/images/2015/disk_33.png"><h3 id="Page-Cache"><a href="#Page-Cache" class="headerlink" title="Page Cache"></a>Page Cache</h3><p>å¼•å…¥<code>Cache</code> å±‚çš„ç›®çš„æ˜¯ä¸ºäº†æé«˜ Linux å¯¹ç£ç›˜è®¿é—®çš„æ€§èƒ½ã€‚Cache å±‚åœ¨å†…å­˜ä¸­ç¼“å­˜äº†ç£ç›˜ä¸Šçš„éƒ¨åˆ†æ•°æ®ã€‚å½“æ•°æ®çš„è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå¦‚æœåœ¨ Cache ä¸­å­˜åœ¨è¯¥æ•°æ®ä¸”æ˜¯æœ€æ–°çš„ï¼Œåˆ™ç›´æ¥å°†æ•°æ®ä¼ é€’ç»™ç”¨æˆ·ç¨‹åºï¼Œå…é™¤äº†å¯¹åº•å±‚ç£ç›˜çš„æ“ä½œï¼Œæé«˜äº†æ€§èƒ½ã€‚Cache å±‚ä¹Ÿæ­£æ˜¯ç£ç›˜ IOPS ä¸ºä»€ä¹ˆèƒ½çªç ´200çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚</p><p>åœ¨ Linux çš„å®ç°ä¸­ï¼Œæ–‡ä»¶ Cache åˆ†ä¸ºä¸¤ä¸ªå±‚é¢ï¼Œä¸€æ˜¯ Page Cacheï¼Œå¦ä¸€ä¸ª Buffer Cacheï¼Œæ¯ä¸€ä¸ª Page Cache åŒ…å«è‹¥å¹² Buffer Cacheã€‚Page Cache ä¸»è¦ç”¨æ¥ä½œä¸ºæ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶æ•°æ®çš„ç¼“å­˜æ¥ç”¨ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹å½“è¿›ç¨‹å¯¹æ–‡ä»¶æœ‰<code>read/write</code>æ“ä½œçš„æ—¶å€™ã€‚Buffer Cache åˆ™ä¸»è¦æ˜¯è®¾è®¡ç”¨æ¥åœ¨ç³»ç»Ÿå¯¹å—è®¾å¤‡è¿›è¡Œè¯»å†™çš„æ—¶å€™ï¼Œå¯¹å—è¿›è¡Œæ•°æ®ç¼“å­˜çš„ç³»ç»Ÿæ¥ä½¿ç”¨ã€‚</p><p>ç£ç›˜ Cache æœ‰ä¸¤å¤§åŠŸèƒ½ï¼šé¢„è¯»å’Œå›å†™ã€‚é¢„è¯»å…¶å®å°±æ˜¯åˆ©ç”¨äº†å±€éƒ¨æ€§åŸç†ï¼Œå…·ä½“è¿‡ç¨‹æ˜¯ï¼šå¯¹äºæ¯ä¸ªæ–‡ä»¶çš„ç¬¬ä¸€ä¸ªè¯»è¯·æ±‚ï¼Œç³»ç»Ÿè¯»å…¥æ‰€è¯·æ±‚çš„é¡µé¢å¹¶è¯»å…¥ç´§éšå…¶åçš„å°‘æ•°å‡ ä¸ªé¡µé¢ï¼ˆé€šå¸¸æ˜¯ä¸‰ä¸ªé¡µé¢ï¼‰ï¼Œè¿™æ—¶çš„é¢„è¯»ç§°ä¸ºåŒæ­¥é¢„è¯»ã€‚å¯¹äºç¬¬äºŒæ¬¡è¯»è¯·æ±‚ï¼Œå¦‚æœæ‰€è¯»é¡µé¢ä¸åœ¨ Cache ä¸­ï¼Œå³ä¸åœ¨å‰æ¬¡é¢„è¯»çš„é¡µä¸­ï¼Œåˆ™è¡¨æ˜æ–‡ä»¶è®¿é—®ä¸æ˜¯é¡ºåºè®¿é—®ï¼Œç³»ç»Ÿç»§ç»­é‡‡ç”¨åŒæ­¥é¢„è¯»ï¼›å¦‚æœæ‰€è¯»é¡µé¢åœ¨ Cache ä¸­ï¼Œåˆ™è¡¨æ˜å‰æ¬¡é¢„è¯»å‘½ä¸­ï¼Œæ“ä½œç³»ç»ŸæŠŠé¢„è¯»é¡µçš„å¤§å°æ‰©å¤§ä¸€å€ï¼Œæ­¤æ—¶é¢„è¯»è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä¸ç­‰é¢„è¯»å®Œæˆå³å¯è¿”å›ï¼Œåªè¦åå°æ…¢æ…¢è¯»é¡µé¢å³å¯ï¼Œè¿™æ—¶çš„é¢„è¯»ç§°ä¸ºå¼‚æ­¥é¢„è¯»ã€‚ä»»ä½•æ¥ä¸‹æ¥çš„è¯»è¯·æ±‚éƒ½ä¼šå¤„äºä¸¤ç§æƒ…å†µä¹‹ä¸€ï¼šç¬¬ä¸€ç§æƒ…å†µæ˜¯æ‰€è¯·æ±‚çš„é¡µé¢å¤„äºé¢„è¯»çš„é¡µé¢ä¸­ï¼Œè¿™æ—¶ç»§ç»­è¿›è¡Œå¼‚æ­¥é¢„è¯»ï¼›ç¬¬äºŒç§æƒ…å†µæ˜¯æ‰€è¯·æ±‚çš„é¡µé¢å¤„äºé¢„è¯»é¡µé¢ä¹‹å¤–ï¼Œè¿™æ—¶ç³»ç»Ÿå°±è¦è¿›è¡ŒåŒæ­¥é¢„è¯»ã€‚</p><p>å›å†™æ˜¯é€šè¿‡æš‚æ—¶å°†æ•°æ®å­˜åœ¨ Cache é‡Œï¼Œç„¶åç»Ÿä¸€å¼‚æ­¥å†™åˆ°ç£ç›˜ä¸­ã€‚é€šè¿‡è¿™ç§å¼‚æ­¥çš„æ•°æ®I/Oæ¨¡å¼è§£å†³äº†ç¨‹åºä¸­çš„è®¡ç®—é€Ÿåº¦å’Œæ•°æ®å­˜å‚¨é€Ÿåº¦ä¸åŒ¹é…çš„é¸¿æ²Ÿï¼Œå‡å°‘äº†è®¿é—®åº•å±‚å­˜å‚¨ä»‹è´¨çš„æ¬¡æ•°ï¼Œä½¿å­˜å‚¨ç³»ç»Ÿçš„æ€§èƒ½å¤§å¤§æé«˜ã€‚Linux 2.6.32å†…æ ¸ä¹‹å‰ï¼Œé‡‡ç”¨ pdflush æœºåˆ¶æ¥å°†è„é¡µçœŸæ­£å†™åˆ°ç£ç›˜ä¸­ï¼Œä»€ä¹ˆæ—¶å€™å¼€å§‹å›å†™å‘¢ï¼Ÿä¸‹é¢ä¸¤ç§æƒ…å†µä¸‹ï¼Œè„é¡µä¼šè¢«å†™å›åˆ°ç£ç›˜ï¼š</p><ol><li>åœ¨ç©ºé—²å†…å­˜ä½äºä¸€ä¸ªç‰¹å®šçš„é˜ˆå€¼æ—¶ï¼Œå†…æ ¸å¿…é¡»å°†è„é¡µå†™å›ç£ç›˜ï¼Œä»¥ä¾¿é‡Šæ”¾å†…å­˜ã€‚</li><li>å½“è„é¡µåœ¨å†…å­˜ä¸­é©»ç•™è¶…è¿‡ä¸€å®šçš„é˜ˆå€¼æ—¶ï¼Œå†…æ ¸å¿…é¡»å°†è¶…æ—¶çš„è„é¡µå†™ä¼šç£ç›˜ï¼Œä»¥ç¡®ä¿è„é¡µä¸ä¼šæ— é™æœŸåœ°é©»ç•™åœ¨å†…å­˜ä¸­ã€‚</li></ol><p>å›å†™å¼€å§‹åï¼Œpdflush ä¼šæŒç»­å†™æ•°æ®ï¼Œç›´åˆ°æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ol><li>å·²ç»æœ‰æŒ‡å®šçš„æœ€å°æ•°ç›®çš„é¡µè¢«å†™å›åˆ°ç£ç›˜ã€‚</li><li>ç©ºé—²å†…å­˜é¡µå·²ç»å›å‡ï¼Œè¶…è¿‡äº†é˜ˆå€¼ã€‚</li></ol><p>Linux 2.6.32 å†…æ ¸ä¹‹åï¼Œæ”¾å¼ƒäº†åŸæœ‰çš„ pdflush æœºåˆ¶ï¼Œæ”¹æˆäº† bdi_writeback  æœºåˆ¶ã€‚bdi_writeback æœºåˆ¶ä¸»è¦è§£å†³äº†åŸæœ‰ fdflush æœºåˆ¶å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜ï¼šåœ¨å¤šç£ç›˜çš„ç³»ç»Ÿä¸­ï¼Œpdflush ç®¡ç†äº†æ‰€æœ‰ç£ç›˜çš„ Cacheï¼Œä»è€Œå¯¼è‡´ä¸€å®šç¨‹åº¦çš„ I/O ç“¶é¢ˆã€‚bdi_writeback æœºåˆ¶ä¸ºæ¯ä¸ªç£ç›˜éƒ½åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸“é—¨è´Ÿè´£è¿™ä¸ªç£ç›˜çš„ Page Cache çš„åˆ·æ–°å·¥ä½œï¼Œä»è€Œå®ç°äº†æ¯ä¸ªç£ç›˜çš„æ•°æ®åˆ·æ–°åœ¨çº¿ç¨‹çº§çš„åˆ†ç¦»ï¼Œæé«˜äº† I/O æ€§èƒ½ã€‚</p><p>å›å†™æœºåˆ¶å­˜åœ¨çš„é—®é¢˜æ˜¯å›å†™ä¸åŠæ—¶å¼•å‘æ•°æ®ä¸¢å¤±ï¼ˆå¯ç”±<code>sync|fsync</code>è§£å†³ï¼‰ï¼Œå›å†™æœŸé—´è¯» I/O æ€§èƒ½å¾ˆå·®ã€‚</p><p>è¯¦ç»†çš„åˆ†æå¯ä»¥å‚è§ï¼š<a href="/assets/book/linux/Linux.Kernel.Cache.pdf">Linuxå†…æ ¸æ–‡ä»¶Cache æœºåˆ¶</a>ã€<a href="/assets/book/linux/Linux.Kernel.Delay.Write.pdf">Linuxå†…æ ¸å»¶è¿Ÿå†™æœºåˆ¶</a></p><h4 id="Page-Cache-ä¼˜åŒ–"><a href="#Page-Cache-ä¼˜åŒ–" class="headerlink" title="Page Cache ä¼˜åŒ–"></a>Page Cache ä¼˜åŒ–</h4><h5 id="fadvise"><a href="#fadvise" class="headerlink" title="fadvise"></a>fadvise</h5><p>åœ¨å…¸å‹çš„ I/O å¯†é›†å‹çš„æ•°æ®åº“æœåŠ¡å™¨å¦‚ MySQL ä¸­ï¼Œä¼šæ¶‰åŠåˆ°å¤§é‡çš„æ–‡ä»¶è¯»å†™ï¼Œé€šå¸¸è¿™äº›æ–‡ä»¶éƒ½æ˜¯é€šè¿‡ buffer io æ¥ä½¿ç”¨çš„ï¼Œä»¥ä¾¿å……åˆ†åˆ©ç”¨åˆ° Linuxçš„ Page Cacheã€‚</p><p>Buffer I/O çš„ç‰¹ç‚¹æ˜¯è¯»çš„æ—¶å€™ï¼Œå…ˆæ£€æŸ¥é¡µç¼“å­˜é‡Œé¢æ˜¯å¦æœ‰éœ€è¦çš„æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰å°±ä»è®¾å¤‡è¯»å–ï¼Œè¿”å›ç»™ç”¨æˆ·çš„åŒæ—¶ï¼ŒåŠ åˆ°ç¼“å­˜ä¸€ä»½;å†™çš„æ—¶å€™ï¼Œç›´æ¥å†™åˆ°ç¼“å­˜å»ï¼Œå†ç”±åå°çš„è¿›ç¨‹å®šæœŸåˆ·åˆ°ç£ç›˜å»ã€‚è¿™æ ·çš„æœºåˆ¶çœ‹èµ·æ¥éå¸¸çš„å¥½ï¼Œåœ¨å®è·µä¸­ä¹Ÿæ•ˆæœå¾ˆå¥½ã€‚</p><p>ä½†æ˜¯å¦‚æœä½ çš„ I/O éå¸¸å¯†é›†ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚é¦–å…ˆç”±äº pagesize æ˜¯4Kï¼Œå†…å­˜çš„åˆ©ç”¨æ•ˆç‡æ¯”è¾ƒä½ã€‚å…¶æ¬¡ç¼“å­˜çš„æ·˜æ±°ç®—æ³•å¾ˆç®€å•ï¼Œç”±æ“ä½œç³»ç»Ÿè‡ªä¸»è¿›è¡Œï¼Œç”¨æˆ·ä¸å¤§å¥½å‚ä¸ã€‚å½“ä½ çš„å†™å¾ˆå¤šï¼Œè¶…è¿‡ç³»ç»Ÿå†…å­˜çš„æŸä¸ªä¸Šé™çš„æ—¶å€™ï¼Œåå°çš„è¿›ç¨‹(swapd)è¦å‡ºæ¥å›æ”¶é¡µé¢ï¼Œè€Œä¸”ä¸€æ—¦å›æ”¶çš„é€Ÿåº¦å°äºå†™å…¥çš„é€Ÿåº¦ï¼Œå°±ä¼šå‡ºç°ä¸å¯é¢„æœŸçš„è¡Œä¸ºã€‚<br><strong>è¿™é‡Œé¢æœ€å¤§çš„é—®é¢˜æ˜¯ï¼šå½“ä½ ä½¿ç”¨çš„å†…å­˜åŒ…æ‹¬ç¼“å­˜ï¼Œæ²¡è¶…è¿‡æ“ä½œç³»ç»Ÿè§„å®šçš„ä¸Šé™çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿé€‰æ‹©ä¸ä½œä¸ºï¼Œè®©ç”¨æˆ·å……åˆ†ä½¿ç”¨ç¼“å­˜ï¼Œä»å®ƒçš„è§’åº¦æ¥çœ‹è¿™æ ·æ•ˆç‡æœ€é«˜ã€‚ä½†æ˜¯æ­£æ˜¯ç”±äºè¿™ç§ç­–ç•¥åœ¨å®è·µä¸­ä¼šå¯¼è‡´é—®é¢˜ã€‚</strong></p><p>æ¯”å¦‚è¯´MySQLæœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ•°æ®ç›´æ¥èµ° direct IO ,ä½†æ˜¯å®ƒçš„æ—¥å¿—æ˜¯èµ° bufferio çš„ã€‚å› ä¸ºèµ° directio éœ€è¦å¯¹å†™å…¥æ–‡ä»¶çš„åç§»å’Œå¤§å°éƒ½è¦æ‰‡åŒºå¯¹å…¨ï¼Œè¿™å¯¹æ—¥å¿—ç³»ç»Ÿæ¥è®²å¤ªéº»çƒ¦äº†ã€‚ç”±äº MySQL æ˜¯åŸºäºäº‹åŠ¡çš„ï¼Œä¼šæ¶‰åŠåˆ°å¤§é‡çš„æ—¥å¿—åŠ¨ä½œï¼Œé¢‘ç¹çš„å†™å…¥ï¼Œç„¶å <code>fsync</code> æ—¥å¿—ä¸€æ—¦å†™å…¥ç£ç›˜ï¼Œbuffer page å°±æ²¡ç”¨äº†ï¼Œä½†æ˜¯ä¸€ç›´ä¼šåœ¨å†…å­˜å‘†ç€ï¼Œç›´åˆ°è¾¾åˆ°å†…å­˜ä¸Šé™ï¼Œå¼•èµ·æ“ä½œç³»ç»Ÿçªç„¶å¤§é‡å›æ”¶é¡µé¢ï¼Œå‡ºç° IO æŸ±å¡æˆ–è€…å†…å­˜äº¤æ¢ç­‰è´Ÿé¢é—®é¢˜ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬çŸ¥é“äº†å›°å¢ƒåœ¨å“ªé‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä¸»åŠ¨é¿å…è¿™ä¸ªç°è±¡çš„å‘ç”Ÿã€‚æœ‰äºŒç§æ–¹æ³•ï¼š</p><ol><li>æ—¥å¿—ä¹Ÿèµ° direct io ,éœ€è¦è§„æ¨¡çš„ä¿®æ”¹ MySQL ä»£ç ï¼Œå¦‚ percona å°±è¿™ä¹ˆåšäº†ï¼Œæä¾›ç›¸åº”çš„ patchã€‚</li><li>æ—¥å¿—è¿˜æ˜¯èµ° buffer io, ä½†æ˜¯å®šæœŸæ¸…é™¤æ— ç”¨ Page Cache.</li></ol><p>ç¬¬ä¸€å¼ æ–¹æ³•ä¸æ˜¯æˆ‘ä»¬è¦è®¨è®ºçš„ï¼Œæˆ‘ä»¬é‡ç‚¹è®¨è®ºç¬¬äºŒç§å¦‚ä½•åšï¼š</p><p>æˆ‘ä»¬åœ¨ç¨‹åºé‡ŒçŸ¥é“æ–‡ä»¶çš„å¥æŸ„ï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥å¾ˆè½»æ¾çš„ç”¨ï¼š</p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">posix_fadvise</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> off_t offset<span class="token punctuation">,</span> off_t len<span class="token punctuation">,</span> <span class="token keyword">int</span> advice<span class="token punctuation">)</span><span class="token punctuation">;</span>POSIX_FADV_DONTNEEDThe specified data will not be accessed in the near future<span class="token punctuation">.</span></code></pre><p>æ¥è§£å†³é—®é¢˜å‘¢ï¼Ÿ<br>æ¯”å¦‚å†™ç±»ä¼¼ <code>posix_fadvise(fd, 0, len_of_file, POSIX_FADV_DONTNEED)</code>ï¼›è¿™æ ·çš„ä»£ç æ¥æ¸…æ‰æ–‡ä»¶æ‰€å±çš„ç¼“å­˜ã€‚ä½†æ˜¯ä½ ä¼šå‘ç°å†…å­˜æ ¹æœ¬å°±æ²¡ä¸‹æ¥, <strong>ä¸ºä»€ä¹ˆç›¸å…³çš„å†…å­˜æ²¡æœ‰è¢«é‡Šæ”¾å‡ºæ¥ï¼šé¡µé¢è¿˜è„æ˜¯æœ€å…³é”®çš„å› ç´ ã€‚</strong></p><p>ä½†æ˜¯æˆ‘ä»¬å¦‚ä½•ä¿è¯é¡µé¢å…¨éƒ¨ä¸è„å‘¢ï¼Ÿ<code>fdatasync</code>æˆ–è€…<code>fsync</code>éƒ½æ˜¯é€‰æ‹©, æˆ–è€… Linux ä¸‹æ–°ç³»ç»Ÿè°ƒç”¨<code>sync_file_range</code>éƒ½æ˜¯å¯ç”¨çš„ï¼Œè¿™å‡ ä¸ªéƒ½æ˜¯ä½¿ç”¨<code>WB_SYNC_ALL</code>æ¨¡å¼å¼ºåˆ¶è¦æ±‚å›å†™å®Œæ¯•æ‰è¿”å›çš„ã€‚<br>å¦‚è¿™æ ·åšï¼š</p><pre class=" language-C"><code class="language-C">`fdatasync(fd);`</code></pre><h5 id="mlock-æ–‡ä»¶é¢„çƒ­"><a href="#mlock-æ–‡ä»¶é¢„çƒ­" class="headerlink" title="mlock/æ–‡ä»¶é¢„çƒ­"></a>mlock/æ–‡ä»¶é¢„çƒ­</h5><p>ä½¿ç”¨ <code>mlock</code> å¯ä»¥å°†è¿›ç¨‹ä½¿ç”¨çš„éƒ¨åˆ†æˆ–è€…å…¨éƒ¨çš„åœ°å€ç©ºé—´é”å®šåœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œé˜²æ­¢å…¶è¢«äº¤æ¢åˆ° swap ç©ºé—´ã€‚å¯¹äºé«˜ååé‡çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—æ¥è¯´ï¼Œè¿½æ±‚çš„æ˜¯æ¶ˆæ¯è¯»å†™ä½å»¶è¿Ÿï¼Œé‚£ä¹ˆè‚¯å®šå¸Œæœ›å°½å¯èƒ½åœ°å¤šä½¿ç”¨ç‰©ç†å†…å­˜ï¼Œæé«˜æ•°æ®è¯»å†™è®¿é—®çš„æ“ä½œæ•ˆç‡ã€‚</p><p>æ–‡ä»¶é¢„çƒ­çš„ç›®çš„ä¸»è¦æœ‰ä¸¤ç‚¹ï¼š</p><ol><li>ç”±äºä»…åˆ†é…å†…å­˜å¹¶è¿›è¡Œ<code>mlock</code>ç³»ç»Ÿè°ƒç”¨åå¹¶ä¸ä¼šä¸ºç¨‹åºå®Œå…¨é”å®šè¿™äº›å†…å­˜ï¼Œå› ä¸ºå…¶ä¸­çš„åˆ†é¡µå¯èƒ½æ˜¯å†™æ—¶å¤åˆ¶çš„ã€‚å› æ­¤ï¼Œå°±æœ‰å¿…è¦å¯¹æ¯ä¸ªå†…å­˜é¡µé¢ä¸­å†™å…¥ä¸€ä¸ªå‡çš„å€¼ã€‚æ¯”å¦‚ï¼šRocketMQ æ˜¯åœ¨åˆ›å»ºå¹¶åˆ†é…MappedFile çš„è¿‡ç¨‹ä¸­ï¼Œé¢„å…ˆå†™å…¥ä¸€äº›éšæœºå€¼è‡³<code>mmap</code>æ˜ å°„å‡ºçš„å†…å­˜ç©ºé—´é‡Œã€‚</li><li>è°ƒç”¨<code>mmap</code>è¿›è¡Œå†…å­˜æ˜ å°„åï¼ŒOS åªæ˜¯å»ºç«‹è™šæ‹Ÿå†…å­˜åœ°å€è‡³ç‰©ç†åœ°å€çš„æ˜ å°„è¡¨ï¼Œè€Œå®é™…å¹¶æ²¡æœ‰åŠ è½½ä»»ä½•æ–‡ä»¶è‡³å†…å­˜ä¸­ã€‚ç¨‹åºè¦è®¿é—®æ•°æ®æ—¶OSä¼šæ£€æŸ¥è¯¥éƒ¨åˆ†çš„åˆ†é¡µæ˜¯å¦å·²ç»åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœä¸åœ¨ï¼Œåˆ™å‘å‡ºä¸€æ¬¡ç¼ºé¡µä¸­æ–­ã€‚è¿™é‡Œï¼Œå¯ä»¥æƒ³è±¡ä¸‹1Gçš„ CommitLog éœ€è¦å‘ç”Ÿå¤šå°‘æ¬¡ç¼ºé¡µä¸­æ–­ï¼Œæ‰èƒ½ä½¿å¾—å¯¹åº”çš„æ•°æ®æ‰èƒ½å®Œå…¨åŠ è½½è‡³ç‰©ç†å†…å­˜ä¸­ã€‚RocketMQ çš„åšæ³•æ˜¯ï¼Œåœ¨åš<code>mmap</code>å†…å­˜æ˜ å°„çš„åŒæ—¶è¿›è¡Œ<code>madvise</code>ç³»ç»Ÿè°ƒç”¨ï¼Œç›®çš„æ˜¯ä½¿ OS åšä¸€æ¬¡å†…å­˜æ˜ å°„åå¯¹åº”çš„æ–‡ä»¶æ•°æ®å°½å¯èƒ½å¤šçš„é¢„åŠ è½½è‡³å†…å­˜ä¸­ï¼Œä»è€Œè¾¾åˆ°å†…å­˜é¢„çƒ­çš„æ•ˆæœã€‚</li></ol><h3 id="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFS-ï¼‰"><a href="#è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFS-ï¼‰" class="headerlink" title="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFS ï¼‰"></a>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFS ï¼‰</h3><img src="/images/2015/disk_34.png" width="400px"><p>VFSï¼ˆVirtual File Systemï¼‰è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸€ç§è½¯ä»¶æœºåˆ¶ï¼Œæ›´ç¡®åˆ‡çš„è¯´æ‰®æ¼”ç€æ–‡ä»¶ç³»ç»Ÿç®¡ç†è€…çš„è§’è‰²ï¼Œä¸å®ƒç›¸å…³çš„æ•°æ®ç»“æ„åªå­˜åœ¨äºç‰©ç†å†…å­˜å½“ä¸­ã€‚å®ƒçš„ä½œç”¨æ˜¯ï¼šå±è”½ä¸‹å±‚å…·ä½“æ–‡ä»¶ç³»ç»Ÿæ“ä½œçš„å·®å¼‚ï¼Œä¸ºä¸Šå±‚çš„æ“ä½œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ã€‚æ­£æ˜¯å› ä¸ºæœ‰äº†è¿™ä¸ªå±‚æ¬¡ï¼ŒLinux ä¸­å…è®¸ä¼—å¤šä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå…±å­˜å¹¶ä¸”å¯¹æ–‡ä»¶çš„æ“ä½œå¯ä»¥è·¨æ–‡ä»¶ç³»ç»Ÿè€Œæ‰§è¡Œã€‚</p><p>VFS ä¸­åŒ…å«ç€å‘ç‰©ç†æ–‡ä»¶ç³»ç»Ÿè½¬æ¢çš„ä¸€ç³»åˆ—æ•°æ®ç»“æ„ï¼Œå¦‚ VFS è¶…çº§å—ã€VFS çš„ inodeã€å„ç§æ“ä½œå‡½æ•°çš„è½¬æ¢å…¥å£ç­‰ã€‚Linux ä¸­ VFS ä¾é å››ä¸ªä¸»è¦çš„æ•°æ®ç»“æ„æ¥æè¿°å…¶ç»“æ„ä¿¡æ¯ï¼Œåˆ†åˆ«ä¸ºè¶…çº§å—ã€ç´¢å¼•ç»“ç‚¹ã€ç›®å½•é¡¹å’Œæ–‡ä»¶å¯¹è±¡ã€‚</p><ol><li>è¶…çº§å—ï¼ˆSuper Blockï¼‰ï¼šè¶…çº§å—å¯¹è±¡è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚å®ƒå­˜å‚¨ä¸€ä¸ªå·²å®‰è£…çš„æ–‡ä»¶ç³»ç»Ÿçš„æ§åˆ¶ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿåç§°ï¼ˆæ¯”å¦‚Ext2ï¼‰ã€æ–‡ä»¶ç³»ç»Ÿçš„å¤§å°å’ŒçŠ¶æ€ã€å—è®¾å¤‡çš„å¼•ç”¨å’Œå…ƒæ•°æ®ä¿¡æ¯ï¼ˆæ¯”å¦‚ç©ºé—²åˆ—è¡¨ç­‰ç­‰ï¼‰ã€‚VFSè¶…çº§å—å­˜åœ¨äºå†…å­˜ä¸­ï¼Œå®ƒåœ¨æ–‡ä»¶ç³»ç»Ÿå®‰è£…æ—¶å»ºç«‹ï¼Œå¹¶ä¸”åœ¨æ–‡ä»¶ç³»ç»Ÿå¸è½½æ—¶è‡ªåŠ¨åˆ é™¤ã€‚åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºæ¯ä¸ªå…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿæ¥è¯´ï¼Œä¹Ÿæœ‰å„è‡ªçš„è¶…çº§å—ï¼Œå®ƒä»¬å­˜æ”¾äºç£ç›˜ã€‚</li><li>ç´¢å¼•ç»“ç‚¹ï¼ˆinodeï¼‰ï¼šç´¢å¼•ç»“ç‚¹å¯¹è±¡å­˜å‚¨äº†æ–‡ä»¶çš„ç›¸å…³å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šæ–‡ä»¶å¤§å°ã€è®¾å¤‡æ ‡è¯†ç¬¦ã€ç”¨æˆ·æ ‡è¯†ç¬¦ã€ç”¨æˆ·ç»„æ ‡è¯†ç¬¦ç­‰ç­‰ã€‚inode åˆ†ä¸ºä¸¤ç§ï¼šä¸€ç§æ˜¯ VFS çš„ inodeï¼Œä¸€ç§æ˜¯å…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„ inodeã€‚å‰è€…åœ¨å†…å­˜ä¸­ï¼Œåè€…åœ¨ç£ç›˜ä¸­ã€‚æ‰€ä»¥æ¯æ¬¡å…¶å®æ˜¯å°†ç£ç›˜ä¸­çš„ inodeè°ƒè¿›å¡«å……å†…å­˜ä¸­çš„ inodeï¼Œè¿™æ ·æ‰æ˜¯ç®—ä½¿ç”¨äº†ç£ç›˜æ–‡ä»¶ inodeã€‚å½“åˆ›å»ºä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œå°±ç»™æ–‡ä»¶åˆ†é…äº†ä¸€ä¸ª inodeã€‚ä¸€ä¸ª inode åªå¯¹åº”ä¸€ä¸ªå®é™…æ–‡ä»¶ï¼Œä¸€ä¸ªæ–‡ä»¶ä¹Ÿä¼šåªæœ‰ä¸€ä¸ª inodeã€‚</li><li>ç›®å½•é¡¹ï¼ˆDentryï¼‰ï¼šå¼•å…¥ç›®å½•é¡¹å¯¹è±¡çš„æ¦‚å¿µä¸»è¦æ˜¯å‡ºäºæ–¹ä¾¿æŸ¥æ‰¾æ–‡ä»¶çš„ç›®çš„ã€‚ä¸åŒäºå‰é¢çš„ä¸¤ä¸ªå¯¹è±¡ï¼Œç›®å½•é¡¹å¯¹è±¡æ²¡æœ‰å¯¹åº”çš„ç£ç›˜æ•°æ®ç»“æ„ï¼Œåªå­˜åœ¨äºå†…å­˜ä¸­ã€‚ä¸€ä¸ªè·¯å¾„çš„å„ä¸ªç»„æˆéƒ¨åˆ†ï¼Œä¸ç®¡æ˜¯ç›®å½•è¿˜æ˜¯æ™®é€šçš„æ–‡ä»¶ï¼Œéƒ½æ˜¯ä¸€ä¸ªç›®å½•é¡¹å¯¹è±¡ã€‚å¦‚ï¼Œåœ¨è·¯å¾„<code>/home/test.java</code>ä¸­ï¼Œç›®å½• /, home, sourceå’Œæ–‡ä»¶ test.java éƒ½å¯¹åº”ä¸€ä¸ªç›®å½•é¡¹å¯¹è±¡ã€‚VFS åœ¨æŸ¥æ‰¾çš„æ—¶å€™ï¼Œæ ¹æ®ä¸€å±‚ä¸€å±‚çš„ç›®å½•é¡¹æ‰¾åˆ°å¯¹åº”çš„æ¯ä¸ªç›®å½•é¡¹çš„Inodeï¼Œé‚£ä¹ˆæ²¿ç€ç›®å½•é¡¹è¿›è¡Œæ“ä½œå°±å¯ä»¥æ‰¾åˆ°æœ€ç»ˆçš„æ–‡ä»¶ã€‚</li><li>æ–‡ä»¶å¯¹è±¡ï¼ˆFileï¼‰ï¼šæ–‡ä»¶å¯¹è±¡æè¿°çš„æ˜¯è¿›ç¨‹å·²ç»æ‰“å¼€çš„æ–‡ä»¶ã€‚å› ä¸ºä¸€ä¸ªæ–‡ä»¶å¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹æ‰“å¼€ï¼Œæ‰€ä»¥ä¸€ä¸ªæ–‡ä»¶å¯ä»¥å­˜åœ¨å¤šä¸ªæ–‡ä»¶å¯¹è±¡ã€‚ä¸€ä¸ªæ–‡ä»¶å¯¹åº”çš„æ–‡ä»¶å¯¹è±¡å¯èƒ½ä¸æ˜¯æƒŸä¸€çš„ï¼Œä½†æ˜¯å…¶å¯¹åº”çš„ç´¢å¼•èŠ‚ç‚¹å’Œç›®å½•é¡¹å¯¹è±¡è‚¯å®šæ˜¯æƒŸä¸€çš„ã€‚</li></ol><p>è¯¦ç»†çš„åˆ†æå¯ä»¥å‚è§ï¼š<a href="/assets/book/linux/Linux.Virtual.Filesystem.pdf">inuxè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</a></p><h3 id="Ext-4-æ–‡ä»¶ç³»ç»Ÿ"><a href="#Ext-4-æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="Ext 4 æ–‡ä»¶ç³»ç»Ÿ"></a>Ext 4 æ–‡ä»¶ç³»ç»Ÿ</h3><p>å…¨ç§° Linux extended file system, extfsï¼Œå³ Linux æ‰©å±•æ–‡ä»¶ç³»ç»Ÿï¼ŒExt2 å°±ä»£è¡¨ç¬¬äºŒä»£æ–‡ä»¶æ‰©å±•ç³»ç»Ÿï¼ŒExt3/Ext4 ä»¥æ­¤ç±»æ¨ï¼Œå®ƒä»¬éƒ½æ˜¯ Ext2 çš„å‡çº§ç‰ˆï¼Œåªä¸è¿‡ä¸ºäº†å¿«é€Ÿæ¢å¤æ–‡ä»¶ç³»ç»Ÿï¼Œå‡å°‘ä¸€è‡´æ€§æ£€æŸ¥çš„æ—¶é—´ï¼Œå¢åŠ äº†æ—¥å¿—åŠŸèƒ½ï¼Œæ‰€ä»¥ Ext2 è¢«ç§°ä¸º<strong>ç´¢å¼•å¼æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼Œè€Œ Ext3/Ext4 è¢«ç§°ä¸º<strong>æ—¥å¿—å¼æ–‡ä»¶ç³»ç»Ÿ</strong>ã€‚</p><blockquote><p> Linuxæ”¯æŒå¾ˆå¤šæ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…æ‹¬ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ(NFS)ã€Windowsçš„Fatæ–‡ä»¶ç³»ç»Ÿã€‚  </p></blockquote><p>æŸ¥çœ‹Linuxæ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿï¼š<code>ls -l /lib/modules/$(uname -r)/kernel/fs</code></p><pre class=" language-shell"><code class="language-shell">xiehui@xiehui-desktop:~/apps$ ls -l /lib/modules/$(uname -r)/kernel/fsæ€»ç”¨é‡ 236drwxr-xr-x 2 root root  4096 4æœˆ  24 09:59 9pdrwxr-xr-x 2 root root  4096 4æœˆ  24 09:59 adfsdrwxr-xr-x 2 root root  4096 4æœˆ  24 09:59 affsdrwxr-xr-x 2 root root  4096 4æœˆ  24 09:59 afsdrwxr-xr-x 2 root root  4096 4æœˆ  24 09:59 aufsdrwxr-xr-x 2 root root  4096 4æœˆ  24 09:59 autofsdrwxr-xr-x 2 root root  4096 4æœˆ  24 09:59 befsdrwxr-xr-x 2 root root  4096 4æœˆ  24 09:59 bfs........</code></pre><p>æŸ¥çœ‹Linuxæ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿ(å·²è½½å…¥åˆ°å†…å­˜ä¸­)ï¼š<code>cat /proc/filesystems</code></p><pre class=" language-shell"><code class="language-shell">xiehui@xiehui-desktop:~/apps$ cat /proc/filesystemsnodev    sysfsnodev    rootfsnodev    ramfsnodev    pipefsnodev    hugetlbfsnodev    devpts    ext3    ext2    ext4...</code></pre><p>æŸ¥çœ‹å½“å‰æœºå™¨ä½¿ç”¨çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹<code>df -T</code></p><pre class=" language-shell"><code class="language-shell">xiehui@xiehui-desktop:~/apps$ df -Tæ–‡ä»¶ç³»ç»Ÿ                    ç±»å‹         1K-å—     å·²ç”¨      å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹udev                        devtmpfs   3939508        0   3939508    0% /devtmpfs                       tmpfs       792544     2112    790432    1% /run/dev/mapper/ubuntu--vg-root ext4     243559804 77716804 153401196   34% /</code></pre><h4 id="ä¸»è¦ç‰¹æ€§"><a href="#ä¸»è¦ç‰¹æ€§" class="headerlink" title="ä¸»è¦ç‰¹æ€§"></a>ä¸»è¦ç‰¹æ€§</h4><p><strong>å…¼å®¹æ€§(Compatibility)</strong></p><p>Ext4 å…¼å®¹ Ext3ï¼Œå‡çº§åªéœ€è¿è¡Œä¸€äº›å‘½ä»¤å³å¯ï¼Œä¸éœ€è¦å˜åŠ¨ç£ç›˜æ ¼å¼ï¼Œå‡çº§ä¸­ä¸ä¼šå½±å“å·²æœ‰çš„æ•°æ®ã€‚</p><p><strong>æ›´å¤§çš„æ–‡ä»¶ç³»ç»Ÿå’Œæ–‡ä»¶å¤§å°(Bigger File System and File Sizes )</strong></p><table><thead><tr><th align="left">File System</th><th align="left">Max FS Size</th><th align="left">Max File Size</th><th align="left">block addressing bits</th></tr></thead><tbody><tr><td align="left">Ext3</td><td align="left">16TB</td><td align="left">2TB</td><td align="left">32</td></tr><tr><td align="left">Ext4</td><td align="left">1EB</td><td align="left">16TB</td><td align="left">48</td></tr></tbody></table><p>â€‹    Tips:</p><ul><li><p>1 EB = 1024 * 1024 TB</p></li><li><p>block sizeï¼š 4 bytes</p></li></ul><p><strong>æ‹“å±•å­ç›®å½•æ•°é‡(Sub directory scalability )</strong></p><p>åœ¨ä¸€ä¸ªç›®å½•ä¸­ :</p><ul><li><p>Ext3 æ”¯æŒ 32000 ä¸ªå­ç›®å½•</p></li><li><p>Ext4 æ”¯æŒ 64000 ä¸ªå­ç›®å½•</p></li></ul><p><strong>æ‹“å±•å—å¤§å°(Extents)</strong></p><p>Ext3 ä¸ºæ¯ä¸ªæ–‡ä»¶ç»´æŠ¤ä¸€ä¸ª block è¡¨ï¼Œç”¨äºä¿å­˜è¿™ä¸ªæ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„å—å·ï¼Œå› ä¸ºä¸€ä¸ª block åªæœ‰ 4kb çš„å¤§å°ï¼Œæ‰€ä»¥å¯¹äºä¸€ä¸ªå¤§æ–‡ä»¶æ¥è¯´çš„è¯ï¼Œéœ€è¦ç»´æŠ¤çš„ block è¡¨å ç”¨çš„ç©ºé—´å°±æ¯”è¾ƒå¯è§‚äº†ï¼Œåˆ é™¤å’Œæˆªæ–­ç­‰æ“ä½œçš„æ•ˆç‡ä¹Ÿå°±æ¯”è¾ƒä½ã€‚</p><p>Ext4 ä½¿ç”¨ extents ä»£æ›¿ blockã€‚ extents ç”±å¤šä¸ªè¿ç»­çš„ block ç»„æˆã€‚èƒ½å¤Ÿæœ‰æ•ˆçš„å‡å°‘éœ€è¦ç»´æŠ¤çš„ block è¡¨çš„é•¿åº¦ï¼Œè¿›è€Œæé«˜åœ¨æ–‡ä»¶ä¸Šæ“ä½œçš„æ•ˆç‡</p><p><strong>å¤šå—åˆ†é…(Multiblock allocation)</strong></p><p>å½“éœ€è¦å°†æ–°æ•°æ®å†™å…¥ç£ç›˜ä¸Šæ—¶ï¼Œéœ€è¦å—åˆ†é…å™¨å†³å®šå°†æ•°æ®å†™å…¥å“ªä¸€ä¸ªç©ºé—²å—ä¸­ã€‚</p><p>ä½†æ˜¯ Ext3 å†™å…¥çš„æ—¶å€™ï¼Œæ¯æ¬¡åªåˆ†é…ä¸€ä¸ª block(4kb), ä¹Ÿå°±æ˜¯è¯´å¦‚æœè¦å†™å…¥ 100 Mb çš„æ•°æ®æ—¶ä¼šè°ƒç”¨å—åˆ†é…å™¨ 25600 è¯ï¼Œæ•ˆç‡å¾ˆä½ï¼Œåˆ†é…å™¨ä¹Ÿæ— æ³•ä½œä¼˜åŒ–ã€‚</p><p>Ext4 ä½¿ç”¨å¤šå—åˆ†é…å™¨ï¼Œæ ¹æ®éœ€è¦ï¼Œä¸€æ¬¡è°ƒç”¨åˆ†é…å¤šä¸ªå—(ä¸€ä¸ª extents)</p><p><strong>å»¶è¿Ÿåˆ†é…(Delayed allocation)</strong></p><p>ä¼ ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿå°½å¯èƒ½æ—©çš„åˆ†é…ç£ç›˜ blocksï¼Œå½“è¿›ç¨‹è°ƒç”¨ <code>write()</code> æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿç«‹å³ä¸ºå…¶åˆ†é… blockï¼Œå³ä½¿æ•°æ®å¹¶æ²¡æœ‰ç«‹å³å†™å…¥ç£ç›˜(åœ¨ç¼“å­˜ä¸­ä¸´æ—¶å­˜æ”¾)ã€‚è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯å½“è¿›ç¨‹æŒç»­å‘æ–‡ä»¶å†™å…¥æ•°æ®ï¼Œæ–‡ä»¶å¢é•¿æ—¶éœ€è¦åˆ†é…å¦å¤–çš„ block æ¥å­˜æ”¾æ–°å¢çš„æ•°æ®ï¼Œå—åˆ†é…å™¨æ— æ³•å¯¹åˆ†é…æ–¹å¼ä½œä¼˜åŒ–ã€‚</p><p>è€Œå»¶è¿Ÿåˆ†é…ç­–ç•¥è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå½“è¿›ç¨‹è°ƒç”¨ <code>write()</code> æ—¶å®ƒå¹¶ä¸ç«‹å³åˆ†é… blocksï¼Œç›´åˆ°æ•°æ®ä»ç¼“å­˜å†™å…¥ç£ç›˜æ—¶è¿›è¡Œåˆ†é…ã€‚å†™å…¥ç£ç›˜æ—¶ï¼Œæ•°æ®åŸºæœ¬å°±ä¸å†å¢é•¿äº†ï¼Œæ­¤æ—¶ä½¿ç”¨å¤šå—åˆ†é…å™¨ä¸ºè¯¥æ–‡ä»¶åˆ†é…å¤šä¸ª extents</p><p><strong>å¿«é€Ÿæ–‡ä»¶ç³»ç»Ÿæ£€æµ‹(Fast fsck)</strong></p><p>æ–‡ä»¶ç³»ç»Ÿæ£€æµ‹æ˜¯ä¸€é¡¹éå¸¸æ…¢çš„æ“ä½œï¼Œç‰¹åˆ«æ˜¯æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿä¸­æ‰€æœ‰çš„ inode èŠ‚ç‚¹ã€‚</p><p>Ext4 è·³è¿‡æœªä½¿ç”¨çš„ inode èŠ‚ç‚¹æ¥åŠ å¿«æ£€æµ‹é€Ÿåº¦ï¼Œæ ¹æ®å·²ä½¿ç”¨çš„ inode èŠ‚ç‚¹çš„æ•°é‡ä¸åŒï¼Œæ€§èƒ½ä¼šæå‡ 2 åˆ° 20 å€ã€‚</p><p><strong>æ—¥å¿—æ ¡éªŒ(Journal checksumming)</strong></p><p>ä½¿ç”¨æ ¡éªŒå’Œæ¥åˆ¤æ–­ä¸€ä¸ªæ—¥å¿—å—æ˜¯å¦å·²å¤±æ•ˆã€‚</p><p>Ext3 ä½¿ç”¨ä¸¤é˜¶æ®µ(æ‰§è¡Œ + commit/rollback)æäº¤æ¥ä¿è¯æ­£ç¡®æ€§ã€‚</p><p>Ext4 ä½¿ç”¨ä¸€é˜¶æ®µæäº¤ + æ—¥å¿—æ ¡éªŒæ¥ä¿è¯æ­£ç¡®æ€§ï¼Œæ€§èƒ½æå‡å¤§çº¦ 20%ã€‚</p><p><strong>ç¦ç”¨æ—¥å¿—æ¨¡å¼(â€œNo Journalingâ€ mode )</strong></p><p>æ—¥å¿—ç¡®ä¿äº†ç£ç›˜ä¸Šå†…å®¹å˜åŠ¨æ—¶æ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´æ€§ï¼Œä½†æ˜¯å´å¸¦æ¥äº†å°‘é‡çš„é¢å¤–å¼€é”€(æ—¥å¿—è®°å½•)ã€‚</p><p>é€šè¿‡ç¦ç”¨æ—¥å¿—ç‰¹æ€§å¯ä»¥è·å¾—å°‘é‡çš„æ€§èƒ½æå‡</p><p><strong>åœ¨çº¿ç£ç›˜æ•´ç†(Online defragmentation )</strong></p><p>è¿™ä¸ªç‰¹æ€§æ­£åœ¨å¼€å‘ä¸­ï¼Œä¼šåŒ…å«åˆ°ä¹‹åçš„ç‰ˆæœ¬ä¸­ã€‚</p><p>é€šè¿‡ä½¿ç”¨å»¶è¿Ÿåˆ†é…ã€extents å’Œ å¤šå—åˆ†é…èƒ½å¤Ÿæœ‰æ•ˆå‡å°‘ç£ç›˜ç¢ç‰‡ï¼Œä½†æ˜¯æ–‡ä»¶å†…å®¹å˜åŠ¨(å¯ä»¥éœ€è¦å¦å¤–çš„ block æ¥å­˜æ”¾æ•°æ®ï¼Œè¿™ä¸ª block å¯èƒ½ä¼šç¦»åŸæ¥çš„åœ°æ–¹æ¯”è¾ƒè¿œï¼Œä»è€Œå¼•å‘ä¸€æ¬¡é¢å¤–çš„å¯»é“)ä¹Ÿä¼šå¸¦æ¥å¾ˆå¤šç¢ç‰‡ï¼Œç£ç›˜ç¢ç‰‡æ•´ç†å¯ä»¥å°†æ–‡ä»¶å°½å¯èƒ½çš„é‡åˆ†é…åˆ°è¿ç»­çš„ block ä¸­ï¼Œä»è€Œå‡å°‘ç£ç›˜ç¢ç‰‡ï¼Œæé«˜è®¿é—®æ•ˆç‡ã€‚</p><p><strong>Inode ç›¸å…³ç‰¹æ€§(Inode-related features)</strong></p><ol><li>æ›´å¤§çš„ inodesï¼šExt3 æ”¯æŒé…ç½® inode å¤§å°ï¼Œé»˜è®¤ä¸º 128 bytesï¼ŒExt4 é»˜è®¤ä¸º 256 bytesã€‚å¢åŠ äº†ä¸€äº›é¢å¤–çš„åŸŸ(æ¯”å¦‚çº³ç§’çº§çš„ timestamps æˆ– inode ç‰ˆæœ¬)ï¼Œå‰©ä½™çš„ç©ºé—´ç”¨æ¥ä¿å­˜æ‹“å±•å±æ€§ã€‚è¿™ç§æ–¹å¼å¯ä»¥ä½¿è®¿é—®è¿™äº›å±æ€§çš„é€Ÿåº¦æ›´å¿«ï¼Œä»è€Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚</li><li>å½“åˆ›å»ºç›®å½•æ—¶ï¼Œç›´æ¥ä¸ºå…¶åˆ›å»ºå‡ ä¸ªä¿ç•™çš„ inode èŠ‚ç‚¹ï¼Œå½“åœ¨è¿™ä¸ªç›®å½•ä¸­åˆ›å»ºæ–°æ–‡ä»¶æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›ä¿ç•™çš„ inode èŠ‚ç‚¹ï¼Œä»è€Œæé«˜æ–‡ä»¶åˆ›å»ºå’Œåˆ é™¤çš„æ•ˆç‡ã€‚</li><li>Ext3 çš„æ—¶é—´å±æ€§æ˜¯ç§’çº§çš„ï¼ŒExt4 çš„æ—¶é—´å±æ€§æ˜¯çº³ç§’çº§çš„ã€‚</li></ol><p><strong>ç£ç›˜é¢„åˆ†é…(Persistent preallocation )</strong></p><p>è¿™ä¸ªç‰¹æ€§å…è®¸åº”ç”¨ç¨‹åºé¢„å…ˆåˆ†é…ç£ç›˜ç©ºé—´ï¼Œåº”ç”¨é€šçŸ¥æ–‡ä»¶ç³»ç»Ÿé¢„å…ˆåˆ†é…ç©ºé—´ï¼Œæ–‡ä»¶ç³»ç»Ÿé¢„å…ˆåˆ†é…éœ€è¦çš„å—å’Œæ•°æ®ç»“æ„ï¼Œç›´åˆ°åº”ç”¨ç¨‹åºå‘è¯¥ç©ºé—´å†™æ•°æ®å‰ï¼Œè¯¥ç©ºé—´ä¸­æ˜¯æ²¡æœ‰æ•°æ®çš„ã€‚</p><p><strong>å±éšœé»˜è®¤å¼€å¯(Barriers on by default)</strong></p><p>è¿™ä¸ªé€‰é¡¹æ”¹å–„äº†æ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´æ€§ï¼Œä½†æŸå¤±äº†ä¸€äº›æ€§èƒ½ã€‚</p><p>æ–‡ä»¶ç³»ç»Ÿåœ¨å†™å…¥æ•°æ®ä¹‹å‰å¿…é¡»å…ˆå°†äº‹åŠ¡ä¿¡æ¯è®°å½•åˆ°æ—¥å¿—ï¼Œç„¶åæ ¹æ®é¡ºåºå†™å…¥ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼æ•ˆç‡æ¯”è¾ƒä½ã€‚ç°ä»£çš„é©±åŠ¨æœ‰å¾ˆå¤§çš„å†…éƒ¨ç¼“å­˜å¹¶ä¸”ä¸ºäº†å¾—åˆ°æ›´å¥½çš„æ€§èƒ½ä¼šè¿›è¡Œæ“ä½œé‡æ’åºï¼Œæ‰€ä»¥åœ¨å†™å…¥æ•°æ®ä¹‹å‰ï¼Œæ–‡ä»¶ç³»ç»Ÿå¿…é¡»å…ˆæ˜¾å¼çš„æŒ‡ç¤ºç£ç›˜åŠ è½½æ‰€æœ‰çš„æ—¥å¿—ã€‚</p><p>å†…æ ¸çš„ é˜»å¡ I/O å­ç³»ç»Ÿä½¿ç”¨å±éšœæ¥å®ç°ï¼Œå³åœ¨åŠ è½½æ—¥å¿—æ—¶è¿›è¡Œé˜»å¡ï¼Œå…¶ä»–æ•°æ® I/O æ“ä½œå°±æ— æ³•å†è¿›è¡Œäº†ã€‚</p><h3 id="é€šç”¨å—å±‚"><a href="#é€šç”¨å—å±‚" class="headerlink" title="é€šç”¨å—å±‚"></a>é€šç”¨å—å±‚</h3><img src="/images/2015/disk_35.png"><p>é€šç”¨å—å±‚çš„ä¸»è¦å·¥ä½œæ˜¯ï¼šæ¥æ”¶ä¸Šå±‚å‘å‡ºçš„ç£ç›˜è¯·æ±‚ï¼Œå¹¶æœ€ç»ˆå‘å‡º I/O è¯·æ±‚ã€‚è¯¥å±‚éšè—äº†åº•å±‚ç¡¬ä»¶å—è®¾å¤‡çš„ç‰¹æ€§ï¼Œä¸ºå—è®¾å¤‡æä¾›äº†ä¸€ä¸ªé€šç”¨çš„æŠ½è±¡è§†å›¾ã€‚</p><p>å¯¹äº VFS å’Œå…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿæ¥è¯´ï¼Œå—ï¼ˆBlockï¼‰æ˜¯åŸºæœ¬çš„æ•°æ®ä¼ è¾“å•å…ƒï¼Œå½“å†…æ ¸è®¿é—®æ–‡ä»¶çš„æ•°æ®æ—¶ï¼Œå®ƒé¦–å…ˆä»ç£ç›˜ä¸Šè¯»å–ä¸€ä¸ªå—ã€‚ä½†æ˜¯å¯¹äºç£ç›˜æ¥è¯´ï¼Œæ‰‡åŒºæ˜¯æœ€å°çš„å¯å¯»å€å•å…ƒï¼Œå—è®¾å¤‡æ— æ³•å¯¹æ¯”å®ƒè¿˜å°çš„å•å…ƒè¿›è¡Œå¯»å€å’Œæ“ä½œã€‚ç”±äºæ‰‡åŒºæ˜¯ç£ç›˜çš„æœ€å°å¯å¯»å€å•å…ƒï¼Œæ‰€ä»¥å—ä¸èƒ½æ¯”æ‰‡åŒºè¿˜å°ï¼Œåªèƒ½æ•´æ•°å€äºæ‰‡åŒºå¤§å°ï¼Œå³ä¸€ä¸ªå—å¯¹åº”ç£ç›˜ä¸Šçš„ä¸€ä¸ªæˆ–å¤šä¸ªæ‰‡åŒºã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå—å¤§å°æ˜¯2çš„æ•´æ•°å€ï¼Œè€Œä¸”ç”±äº Page Cache å±‚çš„æœ€å°å•å…ƒæ˜¯é¡µï¼ˆPageï¼‰ï¼Œæ‰€ä»¥å—å¤§å°ä¸èƒ½è¶…è¿‡ä¸€é¡µçš„é•¿åº¦ã€‚</p><p>å¤§å¤šæƒ…å†µä¸‹ï¼Œæ•°æ®çš„ä¼ è¾“é€šè¿‡ DMA æ–¹å¼ã€‚æ—§çš„ç£ç›˜æ§åˆ¶å™¨ï¼Œä»…ä»…æ”¯æŒç®€å•çš„ DMA æ“ä½œï¼šæ¯æ¬¡æ•°æ®ä¼ è¾“ï¼Œåªèƒ½ä¼ è¾“ç£ç›˜ä¸Šç›¸é‚»çš„æ‰‡åŒºï¼Œå³æ•°æ®åœ¨å†…å­˜ä¸­ä¹Ÿæ˜¯è¿ç»­çš„ã€‚è¿™æ˜¯å› ä¸ºå¦‚æœä¼ è¾“éè¿ç»­çš„æ‰‡åŒºï¼Œä¼šå¯¼è‡´ç£ç›˜èŠ±è´¹æ›´å¤šçš„æ—¶é—´åœ¨å¯»å€æ“ä½œä¸Šã€‚è€Œç°åœ¨çš„ç£ç›˜æ§åˆ¶å™¨æ”¯æŒâ€œåˆ†æ•£/èšåˆâ€DMAæ“ä½œï¼Œè¿™ç§æ¨¡å¼ä¸‹ï¼Œæ•°æ®ä¼ è¾“å¯ä»¥åœ¨å¤šä¸ªéè¿ç»­çš„å†…å­˜åŒºåŸŸä¸­è¿›è¡Œã€‚ä¸ºäº†åˆ©ç”¨â€œåˆ†æ•£/èšåˆâ€DMAæ“ä½œï¼Œå—è®¾å¤‡é©±åŠ¨å¿…é¡»èƒ½å¤„ç†è¢«ç§°ä¸ºæ®µï¼ˆsegmentsï¼‰çš„æ•°æ®å•å…ƒã€‚ä¸€ä¸ªæ®µå°±æ˜¯ä¸€ä¸ªå†…å­˜é¡µé¢æˆ–ä¸€ä¸ªé¡µé¢çš„éƒ¨åˆ†ï¼Œå®ƒåŒ…å«ç£ç›˜ä¸Šç›¸é‚»æ‰‡åŒºçš„æ•°æ®ã€‚</p><p>é€šç”¨å—å±‚æ˜¯ç²˜åˆæ‰€æœ‰ä¸Šå±‚å’Œåº•å±‚çš„éƒ¨åˆ†ï¼Œä¸€ä¸ªé¡µçš„ç£ç›˜æ•°æ®å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/images/2015/1.jpeg"><p>è¯¦ç»†çš„åˆ†æå¯ä»¥å‚è§ï¼š<a href="/assets/book/linux/Linux.Generic.Block.Layer.pdf">Linuxé€šç”¨å—è®¾å¤‡å±‚</a></p><h3 id="I-Oè°ƒåº¦å±‚"><a href="#I-Oè°ƒåº¦å±‚" class="headerlink" title="I/Oè°ƒåº¦å±‚"></a>I/Oè°ƒåº¦å±‚</h3><p>I/Oè°ƒåº¦å±‚çš„åŠŸèƒ½æ˜¯ç®¡ç†å—è®¾å¤‡çš„è¯·æ±‚é˜Ÿåˆ—ã€‚å³æ¥æ”¶é€šç”¨å—å±‚å‘å‡ºçš„I/Oè¯·æ±‚ï¼Œç¼“å­˜è¯·æ±‚å¹¶è¯•å›¾åˆå¹¶ç›¸é‚»çš„è¯·æ±‚ã€‚å¹¶æ ¹æ®è®¾ç½®å¥½çš„è°ƒåº¦ç®—æ³•ï¼Œå›è°ƒé©±åŠ¨å±‚æä¾›çš„è¯·æ±‚å¤„ç†å‡½æ•°ï¼Œä»¥å¤„ç†å…·ä½“çš„ I/O è¯·æ±‚ã€‚</p><p>å¦‚æœç®€å•åœ°ä»¥å†…æ ¸äº§ç”Ÿè¯·æ±‚çš„æ¬¡åºç›´æ¥å°†è¯·æ±‚å‘ç»™å—è®¾å¤‡çš„è¯ï¼Œé‚£ä¹ˆå—è®¾å¤‡æ€§èƒ½è‚¯å®šè®©äººéš¾ä»¥æ¥å—ï¼Œå› ä¸ºç£ç›˜å¯»å€æ˜¯æ•´ä¸ªè®¡ç®—æœºä¸­æœ€æ…¢çš„æ“ä½œä¹‹ä¸€ã€‚ä¸ºäº†ä¼˜åŒ–å¯»å€æ“ä½œï¼Œå†…æ ¸ä¸ä¼šä¸€æ—¦æ¥æ”¶åˆ° I/O è¯·æ±‚åï¼Œå°±æŒ‰ç…§è¯·æ±‚çš„æ¬¡åºå‘èµ·å— I/O è¯·æ±‚ã€‚ä¸ºæ­¤ Linux å®ç°äº†å‡ ç§ I/O è°ƒåº¦ç®—æ³•ï¼Œç®—æ³•åŸºæœ¬æ€æƒ³å°±æ˜¯é€šè¿‡åˆå¹¶å’Œæ’åº I/O è¯·æ±‚é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼Œä»¥æ­¤å¤§å¤§é™ä½æ‰€éœ€çš„ç£ç›˜å¯»é“æ—¶é—´ï¼Œä»è€Œæé«˜æ•´ä½“I/Oæ€§èƒ½ã€‚</p><p>å¸¸è§çš„ I/O è°ƒåº¦ç®—æ³•åŒ…æ‹¬ Noop è°ƒåº¦ç®—æ³•ï¼ˆNo Operationï¼‰ã€CFQï¼ˆå®Œå…¨å…¬æ­£æ’é˜ŸI/Oè°ƒåº¦ç®—æ³•ï¼‰ã€DeadLineï¼ˆæˆªæ­¢æ—¶é—´è°ƒåº¦ç®—æ³•ï¼‰ã€AS é¢„æµ‹è°ƒåº¦ç®—æ³•ç­‰ã€‚</p><ul><li>Noop ç®—æ³•ï¼šæœ€ç®€å•çš„ I/O è°ƒåº¦ç®—æ³•ã€‚è¯¥ç®—æ³•ä»…é€‚å½“åˆå¹¶ç”¨æˆ·è¯·æ±‚ï¼Œå¹¶ä¸æ’åºè¯·æ±‚ã€‚æ–°çš„è¯·æ±‚é€šå¸¸è¢«æ’åœ¨è°ƒåº¦é˜Ÿåˆ—çš„å¼€å¤´æˆ–æœ«å°¾ï¼Œä¸‹ä¸€ä¸ªè¦å¤„ç†çš„è¯·æ±‚æ€»æ˜¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªè¯·æ±‚ã€‚è¿™ç§ç®—æ³•æ˜¯ä¸ºä¸éœ€è¦å¯»é“çš„å—è®¾å¤‡è®¾è®¡çš„ï¼Œå¦‚ SSDã€‚å› ä¸ºå…¶ä»–ä¸‰ä¸ªç®—æ³•çš„ä¼˜åŒ–æ˜¯åŸºäºç¼©çŸ­å¯»é“æ—¶é—´çš„ï¼Œè€Œ SSD ç¡¬ç›˜æ²¡æœ‰æ‰€è°“çš„å¯»é“æ—¶é—´ä¸”I/Oå“åº”æ—¶é—´éå¸¸çŸ­ã€‚</li><li>CFQ ç®—æ³•ï¼šç®—æ³•çš„ä¸»è¦ç›®æ ‡æ˜¯åœ¨è§¦å‘ I/O è¯·æ±‚çš„æ‰€æœ‰è¿›ç¨‹ä¸­ç¡®ä¿ç£ç›˜ I/O å¸¦å®½çš„å…¬å¹³åˆ†é…ã€‚ç®—æ³•ä½¿ç”¨è®¸å¤šä¸ªæ’åºé˜Ÿåˆ—ï¼Œå­˜æ”¾äº†ä¸åŒè¿›ç¨‹å‘å‡ºçš„è¯·æ±‚ã€‚é€šè¿‡æ•£åˆ—å°†åŒä¸€ä¸ªè¿›ç¨‹å‘å‡ºçš„è¯·æ±‚æ’å…¥åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚é‡‡ç”¨è½®è¯¢æ–¹å¼æ‰«æé˜Ÿåˆ—ï¼Œä»ç¬¬ä¸€ä¸ªéç©ºé˜Ÿåˆ—å¼€å§‹ï¼Œä¾æ¬¡è°ƒåº¦ä¸åŒé˜Ÿåˆ—ä¸­ç‰¹å®šä¸ªæ•°ï¼ˆå…¬å¹³ï¼‰çš„è¯·æ±‚ï¼Œç„¶åå°†è¿™äº›è¯·æ±‚ç§»åŠ¨åˆ°è°ƒåº¦é˜Ÿåˆ—çš„æœ«å°¾ã€‚</li><li>Deadline ç®—æ³•ï¼šç®—æ³•å¼•å…¥äº†ä¸¤ä¸ªæ’é˜Ÿé˜Ÿåˆ—åˆ†åˆ«åŒ…å«è¯»è¯·æ±‚å’Œå†™è¯·æ±‚ï¼Œä¸¤ä¸ªæœ€åæœŸé™é˜Ÿåˆ—åŒ…å«ç›¸åŒçš„è¯»å’Œå†™è¯·æ±‚ã€‚æœ¬è´¨å°±æ˜¯ä¸€ä¸ªè¶…æ—¶å®šæ—¶å™¨ï¼Œå½“è¯·æ±‚è¢«ä¼ ç»™ç”µæ¢¯ç®—æ³•æ—¶å¼€å§‹è®¡æ—¶ã€‚ä¸€æ—¦æœ€åæœŸé™é˜Ÿåˆ—ä¸­çš„è¶…æ—¶æ—¶é—´å·²åˆ°ï¼Œå°±æƒ³è¯·æ±‚ç§»è‡³è°ƒåº¦é˜Ÿåˆ—æœ«å°¾ã€‚Deadlineç®—æ³•é¿å…äº†ç”µæ¢¯è°ƒåº¦ç­–ç•¥ï¼ˆä¸ºäº†å‡å°‘å¯»é“æ—¶é—´ï¼Œä¼šä¼˜å…ˆå¤„ç†ä¸ä¸Šä¸€ä¸ªè¯·æ±‚ç›¸è¿‘çš„è¯·æ±‚ï¼‰å¸¦æ¥çš„å¯¹æŸä¸ªè¯·æ±‚å¿½ç•¥å¾ˆé•¿ä¸€æ®µæ—¶é—´çš„å¯èƒ½ã€‚</li><li>AS ç®—æ³•ï¼šAS ç®—æ³•æœ¬è´¨ä¸Šä¾æ®å±€éƒ¨æ€§åŸç†ï¼Œé¢„æµ‹è¿›ç¨‹å‘å‡ºçš„è¯»è¯·æ±‚ä¸åˆšè¢«è°ƒåº¦çš„è¯·æ±‚åœ¨ç£ç›˜ä¸Šå¯èƒ½æ˜¯â€œè¿‘é‚»â€ã€‚ç®—æ³•ç»Ÿè®¡æ¯ä¸ªè¿›ç¨‹ I/O æ“ä½œä¿¡æ¯ï¼Œå½“åˆšåˆšè°ƒåº¦äº†ç”±æŸä¸ªè¿›ç¨‹çš„ä¸€ä¸ªè¯»è¯·æ±‚ä¹‹åï¼Œç®—æ³•é©¬ä¸Šæ£€æŸ¥æ’åºé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªè¯·æ±‚æ˜¯å¦æ¥è‡ªåŒä¸€ä¸ªè¿›ç¨‹ã€‚å¦‚æœæ˜¯ï¼Œç«‹å³è°ƒåº¦ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚å¦åˆ™ï¼ŒæŸ¥çœ‹å…³äºè¯¥è¿›ç¨‹çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚æœç¡®å®šè¿›ç¨‹på¯èƒ½å¾ˆå¿«å‘å‡ºå¦ä¸€ä¸ªè¯»è¯·æ±‚ï¼Œé‚£ä¹ˆå°±å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ã€‚</li></ul><p>å‰æ–‡ä¸­è®¡ç®—å‡ºçš„ IOPS æ˜¯ç†è®ºä¸Šçš„éšæœºè¯»å†™çš„æœ€å¤§ IOPSï¼Œåœ¨éšæœºè¯»å†™ä¸­ï¼Œæ¯æ¬¡ I/O æ“ä½œçš„å¯»å€å’Œæ—‹è½¬å»¶æ—¶éƒ½ä¸èƒ½å¿½ç•¥ä¸è®¡ï¼Œæœ‰äº†è¿™ä¸¤ä¸ªæ—¶é—´çš„å­˜åœ¨ä¹Ÿå°±é™åˆ¶äº† IOPS çš„å¤§å°ã€‚ç°åœ¨å¦‚æœæˆ‘ä»¬è€ƒè™‘åœ¨è¯»å–ä¸€ä¸ªå¾ˆå¤§çš„å­˜å‚¨è¿ç»­åˆ†å¸ƒåœ¨ç£ç›˜çš„æ–‡ä»¶ï¼Œå› ä¸ºæ–‡ä»¶çš„å­˜å‚¨çš„åˆ†å¸ƒæ˜¯è¿ç»­çš„ï¼Œç£å¤´åœ¨å®Œæˆä¸€ä¸ªè¯» I/O æ“ä½œä¹‹åï¼Œä¸éœ€è¦é‡æ–°å¯»å€ï¼Œä¹Ÿä¸éœ€è¦æ—‹è½¬å»¶æ—¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬èƒ½åˆ°ä¸€ä¸ªå¾ˆå¤§çš„ IOPS å€¼ã€‚è¿™æ—¶ç”±äºä¸å†è€ƒè™‘å¯»å€å’Œæ—‹è½¬å»¶æ—¶ï¼Œåˆ™æ€§èƒ½ç“¶é¢ˆä»…æ˜¯æ•°æ®ä¼ è¾“æ—¶å»¶ï¼Œå‡è®¾æ•°æ®ä¼ è¾“æ—¶å»¶ä¸º0.4msï¼Œé‚£ä¹ˆIOPS=1000 / 0.4 = 2500 IOPSã€‚</p><p>åœ¨è®¸å¤šçš„å¼€æºæ¡†æ¶å¦‚ Kafkaã€HBaseä¸­ï¼Œéƒ½é€šè¿‡è¿½åŠ å†™çš„æ–¹å¼æ¥å°½å¯èƒ½çš„å°†éšæœº I/O è½¬æ¢ä¸ºé¡ºåº I/Oï¼Œä»¥æ­¤æ¥é™ä½å¯»å€æ—¶é—´å’Œæ—‹è½¬å»¶æ—¶ï¼Œä»è€Œæœ€å¤§é™åº¦çš„æé«˜ IOPSã€‚</p><p>è¯¦ç»†çš„åˆ†æå¯ä»¥å‚è§ï¼š<a href="/assets/book/linux/Linux.Kernel.IO.Scheduler.pdf">Linuxå†…æ ¸IOè°ƒåº¦å±‚</a></p><h3 id="å—è®¾å¤‡é©±åŠ¨å±‚"><a href="#å—è®¾å¤‡é©±åŠ¨å±‚" class="headerlink" title="å—è®¾å¤‡é©±åŠ¨å±‚"></a>å—è®¾å¤‡é©±åŠ¨å±‚</h3><p>é©±åŠ¨å±‚ä¸­çš„é©±åŠ¨ç¨‹åºå¯¹åº”å…·ä½“çš„ç‰©ç†å—è®¾å¤‡ã€‚å®ƒä»ä¸Šå±‚ä¸­å–å‡ºI/Oè¯·æ±‚ï¼Œå¹¶æ ¹æ®è¯¥I/Oè¯·æ±‚ä¸­æŒ‡å®šçš„ä¿¡æ¯ï¼Œé€šè¿‡å‘å…·ä½“å—è®¾å¤‡çš„è®¾å¤‡æ§åˆ¶å™¨å‘é€å‘½ä»¤çš„æ–¹å¼ï¼Œæ¥æ“çºµè®¾å¤‡ä¼ è¾“æ•°æ®ã€‚</p><h2 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h2><h3 id="open"><a href="#open" class="headerlink" title="open"></a>open</h3><p><code>open</code> è´Ÿè´£åœ¨å†…æ ¸ç”Ÿæˆä¸æ–‡ä»¶ç›¸å¯¹åº”çš„<code>struct file</code>å…ƒæ•°æ®ç»“æ„ï¼Œå¹¶ä¸”ä¸æ–‡ä»¶ç³»ç»Ÿä¸­è¯¥æ–‡ä»¶çš„<code>struct inode</code>è¿›è¡Œå…³è”ï¼Œè£…è½½å¯¹åº”æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œå›è°ƒå‡½æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ª<code>int fd</code>ç»™ç”¨æˆ·è¿›ç¨‹ã€‚åç»­ç”¨æˆ·å¯¹è¯¥æ–‡ä»¶çš„ç›¸å…³æ“ä½œï¼Œä¼šæ¶‰åŠåˆ°å…¶ç›¸å…³çš„<code>struct file</code>ã€<code>struct inode</code>ã€<code>inode-&gt;i_op</code>ã€<code>inode-&gt;i_fop</code>å’Œ<code>inode-&gt;i_mapping-&gt;a_ops</code>ç­‰ã€‚</p><blockquote><p>æ–‡ä»¶æ“ä½œå¯¹åº”çš„åç§»å­˜å‚¨äºstruct fileä¸­ï¼Œæ¯ä¸ªopençš„æ–‡ä»¶å•ç‹¬ç»´æŠ¤ä¸€ä»½ï¼ŒåŒä¸€ä¸ªæ–‡ä»¶çš„è¯»å†™æ“ä½œå…±äº«åŒä¸€ä¸ªåç§»ã€‚</p></blockquote><p>å…¶æ•´ä¸ªå†…æ ¸é€»è¾‘æµç¨‹å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š</p><img src="/images/2015/disk_36.png"><h3 id="write"><a href="#write" class="headerlink" title="write"></a>write</h3><p><code>write</code>çš„å†™é€»è¾‘è·¯å¾„æœ‰å¥½å‡ æ¡ï¼Œæœ€å¸¸ä½¿ç”¨çš„å°±æ˜¯åˆ©ç”¨<code>pagecache</code>å»¶è¿Ÿå†™çš„è¿™æ¡è·¯å¾„ï¼Œæ‰€ä»¥ä¸»è¦åˆ†æè¿™ä¸ªã€‚åœ¨<code>write</code>è°ƒç”¨çš„è°ƒç”¨ã€è¿”å›ä¹‹é—´ï¼Œå…¶è´Ÿè´£åˆ†é…æ–°çš„<code>pagecache</code>ï¼Œå°†æ•°æ®å†™å…¥<code>pagecache</code>ï¼ŒåŒæ—¶æ ¹æ®ç³»ç»Ÿå‚æ•°ï¼Œåˆ¤æ–­<code>pagecache</code>ä¸­çš„è„æ•°æ®å æ¯”æ¥ç¡®å®šæ˜¯å¦è¦è§¦å‘å›å†™é€»è¾‘ã€‚å…¶è¯¦ç»†çš„ä»£ç åˆ†æå¯ä»¥å‚è€ƒï¼š<a href="/assets/book/linux/Linux.Kernel.Write.Procedure.pdf">ã€ŠLinuxå†…æ ¸å†™æ–‡ä»¶è¿‡ç¨‹ã€‹</a>å’Œ<a href="/assets/book/linux/Linux.Kernel.Delay.Write.pdf">ã€ŠLinuxå†…æ ¸å»¶è¿Ÿå†™æœºåˆ¶ã€‹</a>ã€‚</p><p>å…¶æ•´ä¸ªå†…æ ¸é€»è¾‘æµç¨‹å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š</p><img src="/images/2015/disk_37.png"><h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><p><code>read</code>çš„è¯»é€»è¾‘ä¸­åŒ…å«é¢„æœŸ<code>readahead</code>çš„é€»è¾‘ï¼Œå…¶å¯ä»¥é€šè¿‡ä¸<code>fadvise</code>çš„é…åˆè¾¾åˆ°æ–‡ä»¶é¢„å–çš„æ•ˆæœã€‚è¿™éƒ¨åˆ†çš„ä»£ç åˆ†æå¯ä»¥å‚è€ƒï¼š<a href="/assets/book/linux/Linux.Kernel.Read.Procedure.pdf">ã€ŠLinuxå†…æ ¸è¯»æ–‡ä»¶è¿‡ç¨‹ã€‹</a></p><p>å…¶æ•´ä¸ªå†…æ ¸é€»è¾‘æµç¨‹å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š</p><img src="/images/2015/disk_38.png"><h3 id="fsync-fdatasync"><a href="#fsync-fdatasync" class="headerlink" title="fsync/fdatasync"></a>fsync/fdatasync</h3><p><code>fsync</code>å’Œ<code>fdatasync</code>ä¸»è¦é€»è¾‘æµç¨‹åŸºæœ¬ç›¸åŒã€‚å…¶é€šè¿‡è§¦å‘å¯¹åº”æ–‡ä»¶çš„<code>pagecache</code>è„é¡µå›å†™ï¼Œå¹¶ä¸”é˜»å¡ç­‰å¾…åˆ°å›å†™é€»è¾‘å®Œæˆï¼Œä»¥è¾¾åˆ°åŒæ­¥æ•°æ®çš„ç›®çš„ã€‚</p><p>å…¶æ•´ä¸ªå†…æ ¸é€»è¾‘æµç¨‹å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š</p><img src="/images/2015/disk_39.png"><h3 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h3><p>ç”¨æˆ·è°ƒç”¨<code>mmap</code>å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜æ—¶ï¼Œå†…æ ¸è¿›è¡Œä¸€ç³»åˆ—çš„å‚æ•°æ£€æŸ¥ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„<code>vma</code>ï¼Œç„¶åç»™è¯¥<code>vma</code>ç»‘å®š<code>vma_ops</code>ã€‚å½“ç”¨æˆ·è®¿é—®åˆ°<code>mmap</code>å¯¹åº”çš„å†…å­˜æ—¶ï¼ŒCPUä¼šè§¦å‘<code>page fault</code>ï¼Œåœ¨<code>page fault</code>å›è°ƒä¸­ï¼Œå°†ç”³è¯·<code>pagecache</code>ä¸­çš„åŒ¿åé¡µï¼Œè¯»å–æ–‡ä»¶åˆ°å…¶ç‰©ç†å†…å­˜ä¸­ï¼Œç„¶åå°†<code>pagecache</code>ä¸­æ‰€å±çš„ç‰©ç†é¡µä¸ç”¨æˆ·è¿›ç¨‹çš„<code>vma</code>è¿›è¡Œæ˜ å°„ã€‚</p><p>å…¶æ•´ä¸ªå†…æ ¸é€»è¾‘æµç¨‹å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼Œå…¶ä¸­<code>page fault</code>éƒ¨åˆ†æ¯”è¾ƒç®€ç•¥ï¼Œå¯ä»¥å‚è€ƒ<a href="/assets/book/linux/linux-page-fault/">Linux Page Fault(ç¼ºé¡µå¼‚å¸¸)</a>ï¼š </p><img src="/images/2015/disk_40.png"><h3 id="munmap"><a href="#munmap" class="headerlink" title="munmap"></a>munmap</h3><img src="/images/2015/disk_41.png"><h3 id="msync"><a href="#msync" class="headerlink" title="msync"></a>msync</h3><p><code>msync</code>çš„å®é™…å®ç°ä¸å…¶æ‰‹å†Œä¸­çš„æè¿°æœ‰å¾ˆå¤§ä¸åŒï¼Œå…¶è°ƒç”¨æ—¶ï¼Œ<code>flag=MS_SYNC</code>ç­‰åŒäºå¯¹<code>mmap</code>å¯¹åº”çš„æ–‡ä»¶è°ƒç”¨<code>fsync</code>ï¼›<code>flag=MS_ASYNC/MS_INVALIDATE</code>å…¶å®ä»€ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚</p><img src="/images/2015/disk_42.png"><h3 id="madvise"><a href="#madvise" class="headerlink" title="madvise"></a>madvise</h3><img src="/images/2015/disk_43.png"><h3 id="fadvise-1"><a href="#fadvise-1" class="headerlink" title="fadvise"></a>fadvise</h3><img src="/images/2015/disk_44.png"><h2 id="ç¼–ç¨‹å®è·µ"><a href="#ç¼–ç¨‹å®è·µ" class="headerlink" title="ç¼–ç¨‹å®è·µ"></a>ç¼–ç¨‹å®è·µ</h2><h3 id="File-IO"><a href="#File-IO" class="headerlink" title="File IO"></a>File IO</h3><p><code>java.io</code> åŒ…ä¸‹çš„ <code>FileReader</code>ã€ <code>FileWriter</code> ä¹‹ç±» API ï¼Œæ€§èƒ½å¤ªå·®åŸºæœ¬ä¸è€ƒè™‘ä½¿ç”¨ã€‚</p><h3 id="FileChannel"><a href="#FileChannel" class="headerlink" title="FileChannel"></a>FileChannel</h3><p>FileChannel é‡‡ç”¨äº† ByteBuffer å†…å­˜ç¼“å†²åŒºï¼Œè®©æˆ‘ä»¬å¯ä»¥éå¸¸ç²¾å‡†çš„æ§åˆ¶å†™ç›˜çš„å¤§å°ï¼Œè¿™æ˜¯æ™®é€š IO æ— æ³•å®ç°çš„ã€‚æˆ‘ä»¬åœ¨å†™å…¥æ—¶æ³¨æ„æ§åˆ¶ ByteBuffer çš„å¤§å°ï¼ŒFileChannel åªæœ‰åœ¨ä¸€æ¬¡å†™å…¥ 4kb çš„æ•´æ•°å€æ—¶ï¼Œæ‰èƒ½å‘æŒ¥å‡ºå®é™…çš„æ€§èƒ½ï¼Œä¸»è¦å–å†³ä½ æœºå™¨çš„ç£ç›˜ç»“æ„ï¼Œå¹¶ä¸”å—åˆ°æ“ä½œç³»ç»Ÿï¼Œæ–‡ä»¶ç³»ç»Ÿï¼ŒCPU çš„å½±å“ï¼Œéœ€è¦å¯¹ä½¿ç”¨çš„æœºå™¨è¿›è¡Œæµ‹è¯•è·å–åˆ°æœ€ä½³å†™å…¥å¤§å°ã€‚</p><img src="/images/2015/disk_45.png"><p>FIleChannel <code>write</code> å’Œ <code>read</code> æ–¹æ³•å‡æ˜¯<strong>çº¿ç¨‹å®‰å…¨</strong>çš„ï¼ŒFileChannel å†…éƒ¨é€šè¿‡ä¸€æŠŠ <code>private final Object positionLock = new Object();</code> é”æ¥æ§åˆ¶å¹¶å‘ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileInputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileOutputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>ByteBuffer<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>FileChannel<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFileChannel</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        FileInputStream inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"/home/xiehui/test.in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileChannel in <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileOutputStream outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"/home/xiehui/test.out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileChannel out <span class="token operator">=</span> outputStream<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * long position = 1024L;         * æŒ‡å®š position è¯»å– 4kb çš„æ•°æ®         * fileChannel.read(buffer,position)ï¼›         * ä»å½“å‰æ–‡ä»¶æŒ‡é’ˆçš„ä½ç½®è¯»å– 4kb çš„æ•°æ®         * fileChannel.read(buffer);         */</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/**             * byte[] data = new byte[4096];             * long position = 1024L;             * æŒ‡å®š position å†™å…¥ 4kb çš„æ•°æ®             * fileChannel.write(ByteBuffer.wrap(data), position);             * ä»å½“å‰æ–‡ä»¶æŒ‡é’ˆçš„ä½ç½®å†™å…¥ 4kb çš„æ•°æ®             * fileChannel.write(ByteBuffer.wrap(data));             */</span>            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>            buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        out<span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//å°†æ–‡ä»¶æ•°æ®å’Œå…ƒæ•°æ®å¼ºåˆ¶å†™åˆ°ç£ç›˜ä¸Š</span>        inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="MMAP"><a href="#MMAP" class="headerlink" title="MMAP"></a>MMAP</h3><p>ä»ä»£ç å±‚é¢ä¸Šçœ‹ï¼Œä»ç¡¬ç›˜ä¸Šå°†æ–‡ä»¶è¯»å…¥å†…å­˜ï¼Œéƒ½è¦ç»è¿‡æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ•°æ®æ‹·è´ï¼Œå¹¶ä¸”æ•°æ®æ‹·è´æ“ä½œæ˜¯ç”±æ–‡ä»¶ç³»ç»Ÿå’Œç¡¬ä»¶é©±åŠ¨å®ç°çš„ï¼Œç†è®ºä¸Šæ¥è¯´ï¼Œæ‹·è´æ•°æ®çš„æ•ˆç‡æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯é€šè¿‡å†…å­˜æ˜ å°„çš„æ–¹æ³•è®¿é—®ç¡¬ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œæ•ˆç‡è¦æ¯”readå’Œwriteç³»ç»Ÿè°ƒç”¨é«˜ï¼ŒåŸå› æ˜¯ï¼š</p><p><code>read()</code>æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œé¦–å…ˆå°†æ–‡ä»¶ä»ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„ä¸€ä¸ªç¼“å†²åŒºï¼Œå†å°†è¿™äº›æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå®é™…ä¸Šè¿›è¡Œäº†ä¸¤æ¬¡æ•°æ®æ‹·è´ï¼›</p><p><code>map()</code>ä¹Ÿæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œ<strong>ä½†æ²¡æœ‰è¿›è¡Œæ•°æ®æ‹·è´ï¼Œå½“ç¼ºé¡µä¸­æ–­å‘ç”Ÿæ—¶ï¼Œç›´æ¥å°†æ–‡ä»¶ä»ç¡¬ç›˜æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œåªè¿›è¡Œäº†ä¸€æ¬¡æ•°æ®æ‹·è´</strong>ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>ç†è®º</strong>ä¸Šé‡‡ç”¨å†…å­˜æ˜ å°„çš„è¯»å†™æ•ˆç‡è¦æ¯”ä¼ ç»Ÿçš„<code>read/write</code>æ€§èƒ½é«˜ã€‚</p><p><strong>ä¼˜ç¼ºç‚¹</strong>ï¼š</p><ol><li><p>MMAP ä½¿ç”¨è™šæ‹Ÿå†…å­˜ï¼Œå› æ­¤åˆ†é…(map)çš„å†…å­˜å¤§å°ä¸å—JVMçš„-Xmxå‚æ•°é™åˆ¶ï¼Œä½†æ˜¯ä¹Ÿæ˜¯æœ‰å¤§å°é™åˆ¶çš„ã€‚MMAP ä½¿ç”¨æ—¶å¿…é¡»å®ç°æŒ‡å®šå¥½å†…å­˜æ˜ å°„çš„å¤§å°ï¼Œå¹¶ä¸”ä¸€æ¬¡ map çš„å¤§å°é™åˆ¶åœ¨ 1.5G å·¦å³ï¼Œé‡å¤ map åˆä¼šå¸¦æ¥è™šæ‹Ÿå†…å­˜çš„å›æ”¶ã€é‡æ–°åˆ†é…çš„é—®é¢˜ï¼Œå¯¹äºæ–‡ä»¶ä¸ç¡®å®šå¤§å°çš„æƒ…å½¢ä¸å¤ªå‹å¥½ã€‚</p></li><li><p>å¦‚æœå½“æ–‡ä»¶è¶…å‡º1.5Gé™åˆ¶æ—¶ï¼Œå¯ä»¥é€šè¿‡ position å‚æ•°é‡æ–° map æ–‡ä»¶åé¢çš„å†…å®¹ï¼›</p></li><li><p>MMAP ä½¿ç”¨çš„æ˜¯è™šæ‹Ÿå†…å­˜ï¼Œå’Œ PageCache ä¸€æ ·æ˜¯ç”±æ“ä½œç³»ç»Ÿæ¥æ§åˆ¶åˆ·ç›˜çš„ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡ <code>force()</code> æ¥æ‰‹åŠ¨æ§åˆ¶ï¼Œä½†è¿™ä¸ªæ—¶é—´æŠŠæ¡ä¸å¥½ï¼Œåœ¨å°å†…å­˜åœºæ™¯ä¸‹ä¼šå¾ˆä»¤äººå¤´ç–¼ã€‚</p></li><li><p>MMAP çš„å›æ”¶é—®é¢˜ï¼Œå½“ MappedByteBuffer ä¸å†éœ€è¦æ—¶ï¼Œå¯ä»¥æ‰‹åŠ¨é‡Šæ”¾å ç”¨çš„è™šæ‹Ÿå†…å­˜ï¼Œæ³¨æ„ JDK ä¸åŒç‰ˆæœ¬çš„åŒºåˆ«ã€‚</p></li></ol><p>MMAP åœ¨å®é™…ä½¿ç”¨ä¸­å¹¶æ²¡æœ‰è¡¨ç°å‡ºæ¯” FileChannel ä¼˜å¼‚çš„æ€§èƒ½ã€‚å»ºè®®<strong>ä¼˜å…ˆä½¿ç”¨ FileChannel</strong>ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileOutputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>RandomAccessFile<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>ByteBuffer<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>MappedByteBuffer<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>FileChannel<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>AccessController<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>PrivilegedAction<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Field<span class="token punctuation">;</span><span class="token keyword">import</span> sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>Unsafe<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestMMAP</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1G</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Unsafe UNSAFE<span class="token punctuation">;</span>        <span class="token keyword">static</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Field field <span class="token operator">=</span> Unsafe<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"theUnsafe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            UNSAFE <span class="token operator">=</span> <span class="token punctuation">(</span>Unsafe<span class="token punctuation">)</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        File f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"/home/xiehui/largeFile.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        RandomAccessFile rf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Mapping a file into memory</span>        MappedByteBuffer out <span class="token operator">=</span> rf<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>FileChannel<span class="token punctuation">.</span>MapMode<span class="token punctuation">.</span>READ_WRITE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Writing into Memory Mapped File</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            out<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Writing to Memory Mapped File is completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// reading from memory file in Java</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> out<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Reading from Memory Mapped File is completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        rf<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        UNSAFE<span class="token punctuation">.</span><span class="token function">invokeCleaner</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// >= jdk 9 é‡‡ç”¨è¿™ä¸ªæ–¹æ³• unmap</span>        <span class="token comment" spellcheck="true">//clean(out); // &lt; jdk 9 é‡‡ç”¨è¿™ä¸ªæ–¹æ³•</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clean</span><span class="token punctuation">(</span>MappedByteBuffer mappedByteBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ByteBuffer buffer <span class="token operator">=</span> mappedByteBuffer<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>buffer<span class="token punctuation">.</span><span class="token function">isDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> buffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token function">viewed</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"cleaner"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"clean"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * åœ¨MappedByteBufferé‡Šæ”¾åå†å¯¹å®ƒè¿›è¡Œè¯»æ“ä½œçš„è¯å°±ä¼šå¼•å‘ jvm crashï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹å¾ˆå®¹æ˜“å‘ç”Ÿ     * æ­£åœ¨é‡Šæ”¾æ—¶å¦ä¸€ä¸ªçº¿ç¨‹æ­£å¼€å§‹è¯»å–ï¼Œäºæ˜¯ crash å°±å‘ç”Ÿäº†ã€‚æ‰€ä»¥ä¸ºäº†ç³»ç»Ÿç¨³å®šæ€§é‡Šæ”¾å‰ä¸€èˆ¬éœ€è¦æ£€æŸ¥æ˜¯å¦è¿˜æœ‰çº¿ç¨‹åœ¨è¯»æˆ–å†™     * @param target     * @param methodName     * @param args     * @return     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">final</span> Object target<span class="token punctuation">,</span> <span class="token keyword">final</span> String methodName<span class="token punctuation">,</span> <span class="token keyword">final</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> AccessController<span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">public</span> Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    Method method <span class="token operator">=</span> <span class="token function">method</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>                    method<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Method <span class="token function">method</span><span class="token punctuation">(</span>Object target<span class="token punctuation">,</span> String methodName<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> NoSuchMethodException <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> ByteBuffer <span class="token function">viewed</span><span class="token punctuation">(</span>ByteBuffer buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>        String methodName <span class="token operator">=</span> <span class="token string">"viewedBuffer"</span><span class="token punctuation">;</span>        Method<span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> methods<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>methods<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"attachment"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                methodName <span class="token operator">=</span> <span class="token string">"attachment"</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        ByteBuffer viewedBuffer <span class="token operator">=</span> <span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">)</span> <span class="token function">invoke</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>viewedBuffer <span class="token operator">==</span> null<span class="token punctuation">)</span>            <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>        <span class="token keyword">else</span>            <span class="token keyword">return</span> <span class="token function">viewed</span><span class="token punctuation">(</span>viewedBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>å¯ä»¥å‚è€ƒ kafka çš„å·¥å…·ç±»<a href="https://github.com/apache/kafka/blob/e554dc518eaaa0747899e708160275f95c4e525f/clients/src/main/java/org/apache/kafka/common/utils/MappedByteBuffers.java" target="_blank" rel="noopener">MappedByteBuffers</a>çš„å®ç°æ–¹å¼ã€‚</p><h3 id="Direct-IO"><a href="#Direct-IO" class="headerlink" title="Direct IO"></a>Direct IO</h3><p>Java ä¸­å¸¸ç”¨çš„æ–‡ä»¶æ“ä½œæ¥å£ä¸ºï¼šFileChannelï¼Œå¹¶ä¸”æ²¡æœ‰ç›´æ¥æ“ä½œ Direct IO çš„æ¥å£ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ Java æ— æ³•ç»•å¼€ PageCache ç›´æ¥å¯¹å­˜å‚¨è®¾å¤‡è¿›è¡Œè¯»å†™ï¼Œä½†å¯¹äºä½¿ç”¨ Java è¯­è¨€æ¥ç¼–å†™çš„æ•°æ®åº“ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç­‰äº§å“è€Œè¨€ï¼Œçš„ç¡®å­˜åœ¨ç»•å¼€ PageCache çš„éœ€æ±‚ï¼š</p><ul><li>PageCache å±äºæ“ä½œç³»ç»Ÿå±‚é¢çš„æ¦‚å¿µï¼Œç”¨æˆ·å±‚é¢å¾ˆéš¾å¹²é¢„ï¼ŒUser BufferCache æ˜¾ç„¶æ¯” Kernel PageCache è¦å¯æ§</li><li>ç°ä»£æ“ä½œç³»ç»Ÿä¼šä½¿ç”¨å°½å¯èƒ½å¤šçš„ç©ºé—²å†…å­˜æ¥å……å½“ PageCacheï¼Œå½“æ“ä½œç³»ç»Ÿå›æ”¶ PageCache å†…å­˜çš„é€Ÿåº¦ä½äºåº”ç”¨å†™ç¼“å­˜çš„é€Ÿåº¦æ—¶ï¼Œä¼šå½±å“ç£ç›˜å†™å…¥çš„é€Ÿç‡ï¼Œç›´æ¥è¡¨ç°ä¸ºå†™å…¥ RT å¢å¤§ï¼Œè¿™è¢«ç§°ä¹‹ä¸ºâ€œæ¯›åˆºç°è±¡â€</li></ul><p>PageCache å¯èƒ½ä¼šå¥½å¿ƒåŠåäº‹ï¼Œé‡‡ç”¨ Direct IO + è‡ªå®šä¹‰å†…å­˜ç®¡ç†æœºåˆ¶ä¼šä½¿å¾—äº§å“æ›´åŠ çš„å¯æ§ï¼Œé«˜æ€§èƒ½ã€‚</p><p><strong>Direct IO çš„é™åˆ¶</strong></p><p>åœ¨ Java ä¸­ä½¿ç”¨ Direct IO æœ€ç»ˆéœ€è¦è°ƒç”¨åˆ° c è¯­è¨€çš„ pwrite æ¥å£ï¼Œå¹¶è®¾ç½® O_DIRECT flagï¼Œä½¿ç”¨ O_DIRECT å­˜åœ¨ä¸å°‘é™åˆ¶:</p><ul><li>æ“ä½œç³»ç»Ÿé™åˆ¶ï¼šLinux æ“ä½œç³»ç»Ÿåœ¨ 2.4.10 åŠä»¥åçš„ç‰ˆæœ¬ä¸­æ”¯æŒ O_DIRECT flagï¼Œè€ç‰ˆæœ¬ä¼šå¿½ç•¥è¯¥ Flagï¼›Mac OS ä¹Ÿæœ‰ç±»ä¼¼äº O_DIRECT çš„æœºåˆ¶</li><li>ç”¨äºä¼ é€’æ•°æ®çš„ç¼“å†²åŒºï¼Œå…¶å†…å­˜è¾¹ç•Œå¿…é¡»å¯¹é½ä¸º blockSize çš„æ•´æ•°å€</li><li>ç”¨äºä¼ é€’æ•°æ®çš„ç¼“å†²åŒºï¼Œå…¶ä¼ é€’æ•°æ®çš„å¤§å°å¿…é¡»æ˜¯ blockSize çš„æ•´æ•°å€ã€‚</li><li>æ•°æ®ä¼ è¾“çš„å¼€å§‹ç‚¹ï¼Œå³æ–‡ä»¶å’Œè®¾å¤‡çš„åç§»é‡ï¼Œå¿…é¡»æ˜¯ blockSize çš„æ•´æ•°å€</li></ul><p>å¦‚æœæƒ³åœ¨ Java ä¸­ä½¿ç”¨ Direct IO  å¯ä»¥å‚è€ƒé¡¹ç›® <a href="https://github.com/lexburner/kdio" target="_blank" rel="noopener">https://github.com/lexburner/kdio</a> </p><h2 id="æ€»ç»“-2"><a href="#æ€»ç»“-2" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡å¯¹æ–‡ä»¶ IO çš„çŸ¥è¯†è¿›è¡Œäº†å…¨é¢çš„æ¢³ç†å’Œæ•´ç†ï¼Œä¸ºåç»­åœ¨å®ç°å­˜å‚¨ç±»é¡¹ç›®æ—¶æä¾›å‚è€ƒã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="http://www.ssdfans.com/blog/2018/05/17/ä»sataã€sasåˆ°nvme-ssd/" target="_blank" rel="noopener">ä»SATAã€SASåˆ°NVMe SSD</a></p><p><a href="http://www.ssdfans.com/?p=131" target="_blank" rel="noopener">SSDèƒŒåçš„ç§˜å¯†ï¼šSSDåŸºæœ¬å·¥ä½œåŸç†</a></p><p><a href="http://www.jinbuguo.com/storage/ssd_intro.html" target="_blank" rel="noopener">SSD(å›ºæ€ç¡¬ç›˜)ç®€ä»‹</a></p><p><a href="https://www.infoq.cn/article/pWEW6yTk_9QrAUp4EH85" target="_blank" rel="noopener">NVMe SSD æ€§èƒ½å½±å“å› ç´ </a></p><p><a href="https://www.cnblogs.com/zengkefu/p/6372148.html" target="_blank" rel="noopener">å¦‚ä½•æé«˜Linuxä¸‹å—è®¾å¤‡IOçš„æ•´ä½“æ€§èƒ½ï¼Ÿ</a></p><p> <a href="https://tech.meituan.com/2017/05/19/about-desk-io.html" target="_blank" rel="noopener">ç£ç›˜I/Oé‚£äº›äº‹</a></p><p><a href="http://blog.yufeng.info/archives/1917" target="_blank" rel="noopener">posix_fadviseæ¸…é™¤ç¼“å­˜çš„è¯¯è§£å’Œæ”¹è¿›æªæ–½</a></p><p><a href="https://www.ibm.com/developerworks/cn/linux/l-vfs/index.html" target="_blank" rel="noopener">è§£æ Linux ä¸­çš„ VFS æ–‡ä»¶ç³»ç»Ÿæœºåˆ¶</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> IO </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2020/05/19/hello-world/"/>
      <url>/2020/05/19/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class=" language-bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class=" language-bash"><code class="language-bash">$ hexo server</code></pre><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class=" language-bash"><code class="language-bash">$ hexo generate</code></pre><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class=" language-bash"><code class="language-bash">$ hexo deploy</code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
